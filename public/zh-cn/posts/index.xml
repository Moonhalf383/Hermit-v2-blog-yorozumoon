<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/">
	<channel>
		<title>Posts on Yorozumoon</title>
		<link>http://localhost:1313/zh-cn/posts/</link>
		<description>Recent content in Posts on Yorozumoon</description>
		<generator>Hugo -- 0.155.3</generator>
		<language>zh-cn</language>
		<copyright>copyright by Moonhalf.</copyright>
		<lastBuildDate>Thu, 12 Feb 2026 00:00:00 +0000</lastBuildDate>
		<atom:link href="http://localhost:1313/zh-cn/posts/index.xml" rel="self" type="application/rss+xml" />
		
		
		<item>
			<title>D2L自学日志04：多层感知机</title>
			<link>http://localhost:1313/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9704%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA/</link>
			<pubDate>Thu, 12 Feb 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9704%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h1 id="本篇要素">本篇要素：<a href="#%e6%9c%ac%e7%af%87%e8%a6%81%e7%b4%a0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>因为之前的学习方法效率一言难尽，本篇尝试探索新的学习方法。</p>
<ul>
<li>多层感知机
<ul>
<li>从零实现</li>
<li>简洁实现</li>
</ul>
</li>
<li>模型选择、欠拟合、过拟合</li>
<li>权重衰减</li>
<li>暂退法（Dropout)</li>
<li>向前传播、反向传播和计算图</li>
<li>数值稳定性与模型初始化</li>
<li>环境与分布偏移</li>
<li>实战：Kaggle房价预测比赛</li>
</ul>
<h1 id="多层感知机">多层感知机<a href="#%e5%a4%9a%e5%b1%82%e6%84%9f%e7%9f%a5%e6%9c%ba" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>在我们之前的模型中，我们使用了仿射变换来表示从特征到目标的映射，然而仿射变换的<em>线性</em>是很强的假设。虽然我们总是能通过回归运算找到最贴合实际的线性表示，但是当事实数据本来就并非线性时，线性回归就不免会出现系统性的误差。举个最简单的例子，假如你想用机器学习来探究自由落体运动中位移随时间的变化关系，假如你仍然在使用单层的线性回归模型，那么你永远都预测不到正确的结果。</p>
<p>一个克服模型限制的尝试是在神经网络中塞若干“隐藏层”，使模型能处理更加普遍的函数关系。（其实意思就是除了输入和输出层之外的层都叫做隐藏层&hellip;）如图：</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9704%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9704%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA-20260205-1.png" alt=""></p>
<p>但是仅仅添加几个隐藏层几乎没有什么意义。首先，全连接层的参数开销非常大，其次是添加了隐藏层没有给我们带来任何好处，因为输入层到隐藏层是一个仿射变换，隐藏层到输出层还是仿射变换，那么整体依然是一个仿射变换，线性性一点没变，隐藏层再多也只是复杂的加减法。</p>
<p>解决方法是，我们可以在仿射变换之后对每个隐藏层应用一个非线性的<em>激活函数</em>$\sigma$，其输出称为<em>活性值</em>。激活函数实际上是一个非常顾名思义的东西，它的功能就是“视情况地选择性激活一些神经元”，没有激活的神经元无法传出信号，对应的输出值为0。</p>
<h2 id="一些常见的激活函数">一些常见的激活函数<a href="#%e4%b8%80%e4%ba%9b%e5%b8%b8%e8%a7%81%e7%9a%84%e6%bf%80%e6%b4%bb%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="relu函数">ReLU函数<a href="#relu%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>假如这个神经元计算得到的值为负数，则关闭这个神经元。即保留所有的非负数而丢弃所有的负数。
</p>
$$
ReLU(x) = max(x, 0)
$$<h3 id="sigmoid函数">sigmoid函数<a href="#sigmoid%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>也称“挤压函数”，它可以将实数域中的任何一个数字压缩到$(0, 1)$之间。
</p>
$$
sigmoid(x) = \frac{1}{1 + \exp(-x)}
$$<p>
易证其上界为1，下界为0，关于$x=0, y=0.5$对称。</p>
<h3 id="tanh函数">tanh函数<a href="#tanh%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>双曲正切函数，和sigmoid类似，但是是把所有数字压缩到$(-1,1)$的区间内。
</p>
$$
\tanh(x) = \frac{1 - \exp(-2x)}{1 + \exp(-2x)}
$$<p>
关于$(0,0)$对称。</p>
<h2 id="课后练习">课后练习<a href="#%e8%af%be%e5%90%8e%e7%bb%83%e4%b9%a0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="q1计算prelu激活函数的导数">Q1：计算pReLU激活函数的导数。<a href="#q1%e8%ae%a1%e7%ae%97prelu%e6%bf%80%e6%b4%bb%e5%87%bd%e6%95%b0%e7%9a%84%e5%af%bc%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>pReLU为ReLU的变体，添加了一个线性项：
</p>
$$
pReLu(x) = max(0, x) + \alpha min(0,x)
$$<p>
导数：
</p>
$$
\frac{d}{dx}pReLU(x) = 
\begin{cases}
1, & x \ge 0 \\
\alpha,  & x < 0
\end{cases}
$$<h3 id="q2证明一个仅使用relu或prelu的多层感知机构造了一个连续的分段线性函数">Q2：证明一个仅使用ReLU（或pReLU）的多层感知机构造了一个连续的分段线性函数。<a href="#q2%e8%af%81%e6%98%8e%e4%b8%80%e4%b8%aa%e4%bb%85%e4%bd%bf%e7%94%a8relu%e6%88%96prelu%e7%9a%84%e5%a4%9a%e5%b1%82%e6%84%9f%e7%9f%a5%e6%9c%ba%e6%9e%84%e9%80%a0%e4%ba%86%e4%b8%80%e4%b8%aa%e8%bf%9e%e7%bb%ad%e7%9a%84%e5%88%86%e6%ae%b5%e7%ba%bf%e6%80%a7%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>以下简记$ReLU$为$\sigma$。</p>
<p>为了理解这个问题，我们不妨先想想一个仿射变换做了什么事情。假如我们只考察特征$X$的其中一个分量$x_{1}$，我们输入了若干个样本，随后经过仿射变换我们可以得到分量$x_{1}$对应的数值$y_{1}$，而$y_{1}$和$x_{1}$之间符合严格的一次函数关系，不管$x_{1}$取何值。</p>
<p>现在我们对这个结果进行了一次$\sigma$变换，所有负数全部磨平为0，我们将结果记为$z_{1}$，则$z_{1}$关于$x_{1}$的关系便是分段线性函数。此后我们再将$z_{1}$经过一次线性变换得到$w_{1}$，这就是含有一个隐藏层的多层感知机的输出结果。因为$z_{1}$又经过了一次线性变换，$w_{1}$的具体表现形式不再是一个一侧只能和x轴重合的分段线性函数，而是一个自由的分段函数。</p>
<p>虽然论证的非常不严谨，但是总之随着ReLU层的增加，分段函数的转折点个数会指数级增长，而每个输出分量和每个输入分量之间的关系都有独立的分段函数可以表示，这就使得我们可以用相对少的神经元描述复杂的模型形状。理论上我们可以通过无限套ReLU来近似表示任何数字关系，只不过那样做成本太高了。</p>
<h3 id="q3证明">Q3：证明$\operatorname{tanh}(x) + 1 = 2 \operatorname{sigmoid}(2x)$。<a href="#q3%e8%af%81%e6%98%8e" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>略。</p>
<h3 id="q4假设我们有一个非线性单元将它一次应用于一个小批量的数据这会导致什么样的问题">Q4：假设我们有一个非线性单元，将它一次应用于一个小批量的数据。这会导致什么样的问题？<a href="#q4%e5%81%87%e8%ae%be%e6%88%91%e4%bb%ac%e6%9c%89%e4%b8%80%e4%b8%aa%e9%9d%9e%e7%ba%bf%e6%80%a7%e5%8d%95%e5%85%83%e5%b0%86%e5%ae%83%e4%b8%80%e6%ac%a1%e5%ba%94%e7%94%a8%e4%ba%8e%e4%b8%80%e4%b8%aa%e5%b0%8f%e6%89%b9%e9%87%8f%e7%9a%84%e6%95%b0%e6%8d%ae%e8%bf%99%e4%bc%9a%e5%af%bc%e8%87%b4%e4%bb%80%e4%b9%88%e6%a0%b7%e7%9a%84%e9%97%ae%e9%a2%98" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>看不懂题目，遂不答。</p>
<h1 id="多层感知机的从零实现">多层感知机的从零实现<a href="#%e5%a4%9a%e5%b1%82%e6%84%9f%e7%9f%a5%e6%9c%ba%e7%9a%84%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>仍然使用Fashion_mnist数据集，我们在此例中尝试构建一个单隐藏层、256隐藏单元的Fashion_MNIST图像分类模型。</p>
<p>以下为具体实现，又手搓了一遍训练过程。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>train_iter, test_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_data_fashion_mnist(BATCH_SIZE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num_inputs, num_hiddens, num_outputs <span style="color:#f92672">=</span> <span style="color:#ae81ff">784</span>, <span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>W1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Parameter(torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, (num_inputs, num_hiddens), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>b1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Parameter(torch<span style="color:#f92672">.</span>zeros(num_hiddens, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>W2 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Parameter(torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, (num_hiddens, num_outputs), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>b2 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Parameter(torch<span style="color:#f92672">.</span>zeros(num_outputs, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">relu</span>(X: torch<span style="color:#f92672">.</span>Tensor):
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros_like(X)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>max(X, a)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">net</span>(X: torch<span style="color:#f92672">.</span>Tensor):
</span></span><span style="display:flex;"><span>    X <span style="color:#f92672">=</span> X<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, num_inputs))
</span></span><span style="display:flex;"><span>    H <span style="color:#f92672">=</span> relu(X <span style="color:#f92672">@</span> W1 <span style="color:#f92672">+</span> b1)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> H <span style="color:#f92672">@</span> W2 <span style="color:#f92672">+</span> b2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loss <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>CrossEntropyLoss(reduction<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;none&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num_epochs, lr <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>updater <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD(params<span style="color:#f92672">=</span>(W1, b1, W2, b2), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Accumulator</span>:  <span style="color:#75715e"># @save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;在n个变量上累加&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, n):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0.0</span>] <span style="color:#f92672">*</span> n
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(self, <span style="color:#f92672">*</span>args):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> [a <span style="color:#f92672">+</span> float(b) <span style="color:#66d9ef">for</span> a, b <span style="color:#f92672">in</span> zip(self<span style="color:#f92672">.</span>data, args)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reset</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0.0</span>] <span style="color:#f92672">*</span> len(self<span style="color:#f92672">.</span>data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__getitem__</span>(self, idx):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>data[idx]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>(
</span></span><span style="display:flex;"><span>    net,
</span></span><span style="display:flex;"><span>    train_iter,
</span></span><span style="display:flex;"><span>    loss: nn<span style="color:#f92672">.</span>CrossEntropyLoss,
</span></span><span style="display:flex;"><span>    updater: torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD,
</span></span><span style="display:flex;"><span>    num_epochs,
</span></span><span style="display:flex;"><span>    test_iter,
</span></span><span style="display:flex;"><span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> train_iter:
</span></span><span style="display:flex;"><span>            y_hat <span style="color:#f92672">=</span> net(X)
</span></span><span style="display:flex;"><span>            l: torch<span style="color:#f92672">.</span>Tensor <span style="color:#f92672">=</span> loss(y_hat, y)
</span></span><span style="display:flex;"><span>            updater<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>            l<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>            updater<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>            metric <span style="color:#f92672">=</span> Accumulator(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> test_iter:
</span></span><span style="display:flex;"><span>                y_hat: torch<span style="color:#f92672">.</span>Tensor <span style="color:#f92672">=</span> net(X)
</span></span><span style="display:flex;"><span>                l <span style="color:#f92672">=</span> loss(y_hat, y)
</span></span><span style="display:flex;"><span>                accuracy <span style="color:#f92672">=</span> (y <span style="color:#f92672">==</span> (y_hat<span style="color:#f92672">.</span>argmax(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>type(y<span style="color:#f92672">.</span>dtype)))<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span>                metric<span style="color:#f92672">.</span>add(float(l<span style="color:#f92672">.</span>sum()), float(accuracy), y<span style="color:#f92672">.</span>numel())
</span></span><span style="display:flex;"><span>            print(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;epoch </span><span style="color:#e6db74">{</span>epoch<span style="color:#e6db74">}</span><span style="color:#e6db74">: loss: </span><span style="color:#e6db74">{</span>(metric[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">/</span> metric[<span style="color:#ae81ff">2</span>])<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, accuracy: </span><span style="color:#e6db74">{</span>(metric[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">/</span> metric[<span style="color:#ae81ff">2</span>])<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train(net, train_iter, loss, updater, num_epochs, test_iter)
</span></span></code></pre></div><p>因为没有用animator类所以代码格外精简。输出结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>epoch <span style="color:#ae81ff">0</span>: loss: <span style="color:#ae81ff">0.76</span>, accuracy: <span style="color:#ae81ff">0.73</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">1</span>: loss: <span style="color:#ae81ff">0.57</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">2</span>: loss: <span style="color:#ae81ff">0.55</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">3</span>: loss: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">4</span>: loss: <span style="color:#ae81ff">0.56</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">5</span>: loss: <span style="color:#ae81ff">0.51</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">6</span>: loss: <span style="color:#ae81ff">0.46</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">7</span>: loss: <span style="color:#ae81ff">0.49</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">8</span>: loss: <span style="color:#ae81ff">0.42</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">9</span>: loss: <span style="color:#ae81ff">0.43</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span></code></pre></div><p>感觉好像也没有比之前的单层模型有明显的优化&hellip;</p>
<h2 id="课后训练">课后训练<a href="#%e8%af%be%e5%90%8e%e8%ae%ad%e7%bb%83" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="q1在所有其他参数保持不变的情况下更改超参数num_hiddens的值并查看此超参数的变化对结果有何影响确定此超参数的最佳值">Q1：在所有其他参数保持不变的情况下，更改超参数<code>num_hiddens</code>的值，并查看此超参数的变化对结果有何影响。确定此超参数的最佳值。<a href="#q1%e5%9c%a8%e6%89%80%e6%9c%89%e5%85%b6%e4%bb%96%e5%8f%82%e6%95%b0%e4%bf%9d%e6%8c%81%e4%b8%8d%e5%8f%98%e7%9a%84%e6%83%85%e5%86%b5%e4%b8%8b%e6%9b%b4%e6%94%b9%e8%b6%85%e5%8f%82%e6%95%b0num_hiddens%e7%9a%84%e5%80%bc%e5%b9%b6%e6%9f%a5%e7%9c%8b%e6%ad%a4%e8%b6%85%e5%8f%82%e6%95%b0%e7%9a%84%e5%8f%98%e5%8c%96%e5%af%b9%e7%bb%93%e6%9e%9c%e6%9c%89%e4%bd%95%e5%bd%b1%e5%93%8d%e7%a1%ae%e5%ae%9a%e6%ad%a4%e8%b6%85%e5%8f%82%e6%95%b0%e7%9a%84%e6%9c%80%e4%bd%b3%e5%80%bc" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>num_hiddens = 1024：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>epoch <span style="color:#ae81ff">0</span>: loss: <span style="color:#ae81ff">0.63</span>, accuracy: <span style="color:#ae81ff">0.77</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">1</span>: loss: <span style="color:#ae81ff">0.58</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">2</span>: loss: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">3</span>: loss: <span style="color:#ae81ff">0.56</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">4</span>: loss: <span style="color:#ae81ff">0.53</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">5</span>: loss: <span style="color:#ae81ff">0.48</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">6</span>: loss: <span style="color:#ae81ff">0.45</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">7</span>: loss: <span style="color:#ae81ff">0.42</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">8</span>: loss: <span style="color:#ae81ff">0.44</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">9</span>: loss: <span style="color:#ae81ff">0.42</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span></code></pre></div><p>学习速度好像快了一点点，但是命中率似乎没有改善。</p>
<p>num_hiddens = 128：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>epoch <span style="color:#ae81ff">0</span>: loss: <span style="color:#ae81ff">0.77</span>, accuracy: <span style="color:#ae81ff">0.71</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">1</span>: loss: <span style="color:#ae81ff">0.62</span>, accuracy: <span style="color:#ae81ff">0.78</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">2</span>: loss: <span style="color:#ae81ff">0.54</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">3</span>: loss: <span style="color:#ae81ff">0.73</span>, accuracy: <span style="color:#ae81ff">0.75</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">4</span>: loss: <span style="color:#ae81ff">0.48</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">5</span>: loss: <span style="color:#ae81ff">0.52</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">6</span>: loss: <span style="color:#ae81ff">0.47</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">7</span>: loss: <span style="color:#ae81ff">0.44</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">8</span>: loss: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">9</span>: loss: <span style="color:#ae81ff">0.42</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span></code></pre></div><p>似乎也没什么区别。原因在于隐藏层神经元个数对于记忆fashion_mnist的特征来说过剩了，而我们的优化算法本身具有局限，导致我们必然会遇到这个瓶颈。</p>
<p>num_hiddens = 8：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>epoch <span style="color:#ae81ff">0</span>: loss: <span style="color:#ae81ff">0.89</span>, accuracy: <span style="color:#ae81ff">0.66</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">1</span>: loss: <span style="color:#ae81ff">0.67</span>, accuracy: <span style="color:#ae81ff">0.76</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">2</span>: loss: <span style="color:#ae81ff">0.59</span>, accuracy: <span style="color:#ae81ff">0.79</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">3</span>: loss: <span style="color:#ae81ff">0.61</span>, accuracy: <span style="color:#ae81ff">0.78</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">4</span>: loss: <span style="color:#ae81ff">0.56</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">5</span>: loss: <span style="color:#ae81ff">0.52</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">6</span>: loss: <span style="color:#ae81ff">0.57</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">7</span>: loss: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">8</span>: loss: <span style="color:#ae81ff">0.52</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">9</span>: loss: <span style="color:#ae81ff">0.51</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span></code></pre></div><p>此时准确值就有点下降了。</p>
<p>一般来说，一个非正规的经验做法是将隐藏层神经元数量设置为输入和输出层之间的某个2的整数次幂。隐藏层的不同神经元虽然对于输入层和输出层而言是等价的，但是因为随机初始化的缘故，不同神经元的数学地位并不完全一致，它们的工作定位会随着训练的进行而出现分化。比如在我们的图像分类数据集中，有的神经元可能会聚焦在左上角的特征，有的会聚焦右下角的特征，总之所有神经元聚焦的范围拼起来，就得到了模型对于整个图像的印象。</p>
<p>当神经元个数过少时，每个神经元负责的信息过多，导致模型对于整个图像的印象是一个模糊的轮廓，准确率较低；当神经元过多时，虽然对图像的判断会相对精准，但是相较于神经元更低的情况更容易出现欠拟合现象。</p>
<h3 id="q2尝试添加更多的隐藏层并查看它对结果有何影响">Q2：尝试添加更多的隐藏层，并查看它对结果有何影响。<a href="#q2%e5%b0%9d%e8%af%95%e6%b7%bb%e5%8a%a0%e6%9b%b4%e5%a4%9a%e7%9a%84%e9%9a%90%e8%97%8f%e5%b1%82%e5%b9%b6%e6%9f%a5%e7%9c%8b%e5%ae%83%e5%af%b9%e7%bb%93%e6%9e%9c%e6%9c%89%e4%bd%95%e5%bd%b1%e5%93%8d" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>现在中间隐藏层变成了3层。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>train_iter, test_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_data_fashion_mnist(BATCH_SIZE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num_hiddens <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num_inputs, num_outputs <span style="color:#f92672">=</span> <span style="color:#ae81ff">784</span>, <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Wh1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Parameter(
</span></span><span style="display:flex;"><span>    torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, (num_hiddens, num_hiddens), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>bh1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Parameter(torch<span style="color:#f92672">.</span>zeros(num_hiddens, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>Wh2 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Parameter(
</span></span><span style="display:flex;"><span>    torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, (num_hiddens, num_hiddens), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>bh2 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Parameter(torch<span style="color:#f92672">.</span>zeros(num_hiddens, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>W1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Parameter(torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, (num_inputs, num_hiddens), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>b1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Parameter(torch<span style="color:#f92672">.</span>zeros(num_hiddens, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>W2 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Parameter(torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, (num_hiddens, num_outputs), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>b2 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Parameter(torch<span style="color:#f92672">.</span>zeros(num_outputs, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">relu</span>(X: torch<span style="color:#f92672">.</span>Tensor):
</span></span><span style="display:flex;"><span>    a <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros_like(X)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>max(X, a)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">net</span>(X: torch<span style="color:#f92672">.</span>Tensor):
</span></span><span style="display:flex;"><span>    X <span style="color:#f92672">=</span> X<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, num_inputs))
</span></span><span style="display:flex;"><span>    H <span style="color:#f92672">=</span> relu(relu(relu(X <span style="color:#f92672">@</span> W1 <span style="color:#f92672">+</span> b1) <span style="color:#f92672">@</span> Wh1 <span style="color:#f92672">+</span> bh1) <span style="color:#f92672">@</span> Wh2 <span style="color:#f92672">+</span> bh2)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> H <span style="color:#f92672">@</span> W2 <span style="color:#f92672">+</span> b2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loss <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>CrossEntropyLoss(reduction<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;none&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num_epochs, lr <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>updater <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD(params<span style="color:#f92672">=</span>(W1, b1, W2, b2, Wh1, bh1, Wh2, bh2), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Accumulator</span>:  <span style="color:#75715e"># @save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;在n个变量上累加&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, n):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0.0</span>] <span style="color:#f92672">*</span> n
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(self, <span style="color:#f92672">*</span>args):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> [a <span style="color:#f92672">+</span> float(b) <span style="color:#66d9ef">for</span> a, b <span style="color:#f92672">in</span> zip(self<span style="color:#f92672">.</span>data, args)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reset</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0.0</span>] <span style="color:#f92672">*</span> len(self<span style="color:#f92672">.</span>data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__getitem__</span>(self, idx):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>data[idx]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>(
</span></span><span style="display:flex;"><span>    net,
</span></span><span style="display:flex;"><span>    train_iter,
</span></span><span style="display:flex;"><span>    loss: nn<span style="color:#f92672">.</span>CrossEntropyLoss,
</span></span><span style="display:flex;"><span>    updater: torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD,
</span></span><span style="display:flex;"><span>    num_epochs,
</span></span><span style="display:flex;"><span>    test_iter,
</span></span><span style="display:flex;"><span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> train_iter:
</span></span><span style="display:flex;"><span>            y_hat <span style="color:#f92672">=</span> net(X)
</span></span><span style="display:flex;"><span>            l: torch<span style="color:#f92672">.</span>Tensor <span style="color:#f92672">=</span> loss(y_hat, y)
</span></span><span style="display:flex;"><span>            updater<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>            l<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>            updater<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>            metric <span style="color:#f92672">=</span> Accumulator(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> test_iter:
</span></span><span style="display:flex;"><span>                y_hat: torch<span style="color:#f92672">.</span>Tensor <span style="color:#f92672">=</span> net(X)
</span></span><span style="display:flex;"><span>                l <span style="color:#f92672">=</span> loss(y_hat, y)
</span></span><span style="display:flex;"><span>                accuracy <span style="color:#f92672">=</span> (y <span style="color:#f92672">==</span> (y_hat<span style="color:#f92672">.</span>argmax(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>type(y<span style="color:#f92672">.</span>dtype)))<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span>                metric<span style="color:#f92672">.</span>add(float(l<span style="color:#f92672">.</span>sum()), float(accuracy), y<span style="color:#f92672">.</span>numel())
</span></span><span style="display:flex;"><span>            print(
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;epoch </span><span style="color:#e6db74">{</span>epoch<span style="color:#e6db74">}</span><span style="color:#e6db74">: loss: </span><span style="color:#e6db74">{</span>(metric[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">/</span> metric[<span style="color:#ae81ff">2</span>])<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, accuracy: </span><span style="color:#e6db74">{</span>(metric[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">/</span> metric[<span style="color:#ae81ff">2</span>])<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train(net, train_iter, loss, updater, num_epochs, test_iter)
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>epoch <span style="color:#ae81ff">0</span>: loss: <span style="color:#ae81ff">2.30</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">1</span>: loss: <span style="color:#ae81ff">2.52</span>, accuracy: <span style="color:#ae81ff">0.13</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">2</span>: loss: <span style="color:#ae81ff">1.24</span>, accuracy: <span style="color:#ae81ff">0.49</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">3</span>: loss: <span style="color:#ae81ff">1.00</span>, accuracy: <span style="color:#ae81ff">0.62</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">4</span>: loss: <span style="color:#ae81ff">0.71</span>, accuracy: <span style="color:#ae81ff">0.74</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">5</span>: loss: <span style="color:#ae81ff">0.78</span>, accuracy: <span style="color:#ae81ff">0.71</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">6</span>: loss: <span style="color:#ae81ff">0.59</span>, accuracy: <span style="color:#ae81ff">0.78</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">7</span>: loss: <span style="color:#ae81ff">0.66</span>, accuracy: <span style="color:#ae81ff">0.76</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">8</span>: loss: <span style="color:#ae81ff">0.51</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">9</span>: loss: <span style="color:#ae81ff">0.54</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">10</span>: loss: <span style="color:#ae81ff">0.48</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">11</span>: loss: <span style="color:#ae81ff">0.44</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">12</span>: loss: <span style="color:#ae81ff">0.44</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">13</span>: loss: <span style="color:#ae81ff">0.45</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">14</span>: loss: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">15</span>: loss: <span style="color:#ae81ff">0.41</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">16</span>: loss: <span style="color:#ae81ff">0.46</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">17</span>: loss: <span style="color:#ae81ff">0.52</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">18</span>: loss: <span style="color:#ae81ff">0.45</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">19</span>: loss: <span style="color:#ae81ff">0.42</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">20</span>: loss: <span style="color:#ae81ff">0.54</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">21</span>: loss: <span style="color:#ae81ff">0.37</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">22</span>: loss: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">23</span>: loss: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">24</span>: loss: <span style="color:#ae81ff">0.36</span>, accuracy: <span style="color:#ae81ff">0.87</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">25</span>: loss: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">26</span>: loss: <span style="color:#ae81ff">0.36</span>, accuracy: <span style="color:#ae81ff">0.87</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">27</span>: loss: <span style="color:#ae81ff">0.38</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">28</span>: loss: <span style="color:#ae81ff">0.37</span>, accuracy: <span style="color:#ae81ff">0.87</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">29</span>: loss: <span style="color:#ae81ff">0.34</span>, accuracy: <span style="color:#ae81ff">0.88</span>
</span></span></code></pre></div><p>经过了30次迭代后命中率达到了88%，这里没有控制变量所以我也不太确定新的模型是不是比之前更优，但是遇到了深度学习网络起步阶段命中率较低的现象。</p>
<h3 id="q3改变学习速率会如何影响结果保持模型架构和其他超参数包括轮数不变学习率设置为多少会带来最好的结果">Q3：改变学习速率会如何影响结果？保持模型架构和其他超参数（包括轮数）不变，学习率设置为多少会带来最好的结果？<a href="#q3%e6%94%b9%e5%8f%98%e5%ad%a6%e4%b9%a0%e9%80%9f%e7%8e%87%e4%bc%9a%e5%a6%82%e4%bd%95%e5%bd%b1%e5%93%8d%e7%bb%93%e6%9e%9c%e4%bf%9d%e6%8c%81%e6%a8%a1%e5%9e%8b%e6%9e%b6%e6%9e%84%e5%92%8c%e5%85%b6%e4%bb%96%e8%b6%85%e5%8f%82%e6%95%b0%e5%8c%85%e6%8b%ac%e8%bd%ae%e6%95%b0%e4%b8%8d%e5%8f%98%e5%ad%a6%e4%b9%a0%e7%8e%87%e8%ae%be%e7%bd%ae%e4%b8%ba%e5%a4%9a%e5%b0%91%e4%bc%9a%e5%b8%a6%e6%9d%a5%e6%9c%80%e5%a5%bd%e7%9a%84%e7%bb%93%e6%9e%9c" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>切换回原本的一层隐藏层模型。试了下差不多0.03效果最好，不过本来这个模型就很简单，也看不大出来有什么区别。</p>
<p>后面的课后训练鸽了。</p>
<h1 id="多层感知机的精简实现">多层感知机的精简实现<a href="#%e5%a4%9a%e5%b1%82%e6%84%9f%e7%9f%a5%e6%9c%ba%e7%9a%84%e7%b2%be%e7%ae%80%e5%ae%9e%e7%8e%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> softmax_scratch <span style="color:#f92672">import</span> train_ch3
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_iter, test_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_data_fashion_mnist(batch_size<span style="color:#f92672">=</span>BATCH_SIZE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>net <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(nn<span style="color:#f92672">.</span>Flatten(), nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">784</span>, <span style="color:#ae81ff">256</span>), nn<span style="color:#f92672">.</span>ReLU(), nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init_weight</span>(m: nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> type(m) <span style="color:#f92672">is</span> nn<span style="color:#f92672">.</span>Linear:
</span></span><span style="display:flex;"><span>        nn<span style="color:#f92672">.</span>init<span style="color:#f92672">.</span>normal_(m<span style="color:#f92672">.</span>weight, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>net<span style="color:#f92672">.</span>apply(init_weight)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lr, num_epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loss <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>CrossEntropyLoss(reduction<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;none&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>trainer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD(net<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span>lr)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_ch3(net, train_iter, test_iter, loss, num_epochs, trainer)
</span></span></code></pre></div><p>使用了softmax_scratch中写好的训练流程。</p>
<p>输出结果如下：</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9704%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9704%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA-20260205-2.png" alt=""></p>
<p>感觉模型太简单，也看不太出来什么参数最适合，课后练习先鸽了。</p>
<h1 id="模型选择欠拟合过拟合">模型选择、欠拟合、过拟合<a href="#%e6%a8%a1%e5%9e%8b%e9%80%89%e6%8b%a9%e6%ac%a0%e6%8b%9f%e5%90%88%e8%bf%87%e6%8b%9f%e5%90%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<blockquote>
<p>将模型在训练数据上拟合的比在潜在分布中更接近的现象称为_过拟合_（overfitting）， 用于对抗过拟合的技术称为_正则化_（regularization）。 在前面的章节中，有些读者可能在用Fashion-MNIST数据集做实验时已经观察到了这种过拟合现象。 在实验中调整模型架构或超参数时会发现： 如果有足够多的神经元、层数和训练迭代周期， 模型最终可以在训练集上达到完美的精度，此时测试集的准确性却下降了。</p>
</blockquote>
<p>本节内容文字量有点大，随机抽一些讲。</p>
<p>“测试集”和“验证集”是不同的。在工程实践中，验证集被用来调整超参数和选择模型，而测试集用来测试模型的泛化能力。事实上我们前文中的代码尝试里所使用的测试数据都属于验证集。测试集有点像是为了“防止研究人员过拟合”而设置的，我们不能对着测试数据准备模型而声称自己的模型具有很高的泛化能力。因此测试集理论上在开发的全过程中都是不公开的，甚至在参数调整完毕之前都不应该被使用。它的作用是用来衡量一个基本定型的模型的能力。</p>
<blockquote>
<p>但现实是验证数据和测试数据之间的边界模糊得令人担忧。 除非另有明确说明，否则在这本书的实验中， 我们实际上是在使用应该被正确地称为训练数据和验证数据的数据集， 并没有真正的测试数据集。 因此，书中每次实验报告的准确度都是验证集准确度，而不是测试集准确度。</p>
</blockquote>
<p>关于欠拟合和过拟合的判别，假如模型不能有效的降低训练误差（即在训练集上的误差），通常可能意味着模型过于简单即表达能力不足，而此时验证误差和训练误差虽然都很大，但是验证误差似乎并没有因为更广泛的数据集而使得误差显著增大，此时我们认为当前模型的泛化能力是基本合格的，我们有理由相信一个更复杂的模型可以有效降低训练误差，这种现象叫做<em>欠拟合</em>。而当训练误差显著低于验证误差时，意味着出现了严重的过拟合。这意味着模型虽然掌握了训练集的规律，但是同时也学习了很多并不普遍的只在训练集中出现的规律，导致模型面对真实的分布时无法正确描述。</p>
<h2 id="多项式回归代码实现">多项式回归代码实现<a href="#%e5%a4%9a%e9%a1%b9%e5%bc%8f%e5%9b%9e%e5%bd%92%e4%bb%a3%e7%a0%81%e5%ae%9e%e7%8e%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> math
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>max_degree <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>n_train, n_test <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>true_w <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>zeros(max_degree)
</span></span><span style="display:flex;"><span>true_w[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array([<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">1.2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3.4</span>, <span style="color:#ae81ff">5.6</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>features <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>normal(size<span style="color:#f92672">=</span>(n_train <span style="color:#f92672">+</span> n_test, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>shuffle(features)
</span></span><span style="display:flex;"><span>poly_features <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>power(features, np<span style="color:#f92672">.</span>arange(max_degree)<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>print(poly_features<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(max_degree):
</span></span><span style="display:flex;"><span>    poly_features[:, i] <span style="color:#f92672">/=</span> math<span style="color:#f92672">.</span>gamma(i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>labels <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>dot(poly_features, true_w)
</span></span><span style="display:flex;"><span>labels <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>normal(scale<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>, size<span style="color:#f92672">=</span>labels<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>print(labels<span style="color:#f92672">.</span>shape)
</span></span></code></pre></div><p>直接从d2l中cv下来的代码，其中<code>np.power</code>用到了广播机制，得到的<code>poly_features</code>是一个形状为<code>(200, 20)</code>的多维数组，每一行代表一个样本。<code>labels</code>的形状则为<code>(200, )</code>每个元素表示经过多项式计算得到的标准答案加上了一个符合正态分布的噪音。</p>
<p>总之接下来d2l举了这样的例子，假如我们的数据集中标签由特征的三次多项式加上噪声得到，此时如果我们直接使用线性回归模型，结果会呈现欠拟合，因为模型对于数据特征的描述能力不足；如果我们使用了比三次更高的多项式回归模型，迭代次数过多时结果可能呈现过拟合，因为模型过多地捕捉到了数据集中的噪声。</p>
<p>此处我主要关心d2l多项式回归是如何实现的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>(train_features, test_features, train_labels, test_labels,
</span></span><span style="display:flex;"><span>          num_epochs<span style="color:#f92672">=</span><span style="color:#ae81ff">400</span>):
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>MSELoss(reduction<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;none&#39;</span>)
</span></span><span style="display:flex;"><span>    input_shape <span style="color:#f92672">=</span> train_features<span style="color:#f92672">.</span>shape[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 不设置偏置，因为我们已经在多项式中实现了它</span>
</span></span><span style="display:flex;"><span>    net <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(nn<span style="color:#f92672">.</span>Linear(input_shape, <span style="color:#ae81ff">1</span>, bias<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>))
</span></span><span style="display:flex;"><span>    batch_size <span style="color:#f92672">=</span> min(<span style="color:#ae81ff">10</span>, train_labels<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>    train_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_array((train_features, train_labels<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)),
</span></span><span style="display:flex;"><span>                                batch_size)
</span></span><span style="display:flex;"><span>    test_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_array((test_features, test_labels<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)),
</span></span><span style="display:flex;"><span>                               batch_size, is_train<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    trainer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD(net<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>    animator <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>Animator(xlabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;epoch&#39;</span>, ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;loss&#39;</span>, yscale<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;log&#39;</span>,
</span></span><span style="display:flex;"><span>                            xlim<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1</span>, num_epochs], ylim<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1e-3</span>, <span style="color:#ae81ff">1e2</span>],
</span></span><span style="display:flex;"><span>                            legend<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;train&#39;</span>, <span style="color:#e6db74">&#39;test&#39;</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>        d2l<span style="color:#f92672">.</span>train_epoch_ch3(net, train_iter, loss, trainer)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> epoch <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">or</span> (epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">20</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            animator<span style="color:#f92672">.</span>add(epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, (evaluate_loss(net, train_iter, loss),
</span></span><span style="display:flex;"><span>                                     evaluate_loss(net, test_iter, loss)))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;weight:&#39;</span>, net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>weight<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>numpy())
</span></span></code></pre></div><p>我们可以看到d2l书中<code>net</code>只是一个单层的线性模型。我们之前所实现的线性模型中我们往往设定了多个特征比如$x_{1},x_{2},x_{3},...$，但是我们从来没有规定这些特征之间一定要无关。此处之所以可以用一个线性回归模型来表示多项式回归，实际上就是把$x^1,x^2,x^3,..$分别当做特征，将$x^0$的系数当做偏置。这样我们就可以用非常简单的方式控制训练时模型的多项式最高次数：将所有权重初始化为0，之后我们传参时只传前n项，我们就实现了n-1次多项式回归。</p>
<h2 id="课后联系">课后联系<a href="#%e8%af%be%e5%90%8e%e8%81%94%e7%b3%bb" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="q1这个多项式回归问题可以准确解出来吗">Q1：这个多项式回归问题可以准确解出来吗？<a href="#q1%e8%bf%99%e4%b8%aa%e5%a4%9a%e9%a1%b9%e5%bc%8f%e5%9b%9e%e5%bd%92%e9%97%ae%e9%a2%98%e5%8f%af%e4%bb%a5%e5%87%86%e7%a1%ae%e8%a7%a3%e5%87%ba%e6%9d%a5%e5%90%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>将多项式回归看做关于$x^0,x^1,x^2,...$的线性回归，直接套公式。</p>
<h3 id="q2懒得写了">Q2：懒得写了<a href="#q2%e6%87%92%e5%be%97%e5%86%99%e4%ba%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<h3 id="q3如果不对多项式特征进行标准化会发生什么">Q3：如果不对多项式特征进行标准化会发生什么？<a href="#q3%e5%a6%82%e6%9e%9c%e4%b8%8d%e5%af%b9%e5%a4%9a%e9%a1%b9%e5%bc%8f%e7%89%b9%e5%be%81%e8%bf%9b%e8%a1%8c%e6%a0%87%e5%87%86%e5%8c%96%e4%bc%9a%e5%8f%91%e7%94%9f%e4%bb%80%e4%b9%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在d2l的多项式回归模型中，我们预先对特征$x^i$除以了$i!$，这种标准化的目的是使得不同阶的特征产生的误差对于参数优化的作用效果接近。如果不进行标准化，阶数越高的特征对于模型的影响也会更大，模型权重参数容易出现震荡乃至发散。</p>
<h3 id="q4泛化误差可能为0吗">Q4：泛化误差可能为0吗？<a href="#q4%e6%b3%9b%e5%8c%96%e8%af%af%e5%b7%ae%e5%8f%af%e8%83%bd%e4%b8%ba0%e5%90%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>虽然理论上如果你的模型完美契合数据的实际分布，泛化误差可能为0，但是现实基本不可能，因为现实数据中总存在噪声，噪声没有规律，并且即使没有噪声，真实数据集的数学模型也很可能非常复杂甚至没有解析形式。我们只能做到泛化误差尽可能低。</p>
<h1 id="权重衰减">权重衰减<a href="#%e6%9d%83%e9%87%8d%e8%a1%b0%e5%87%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>在上文中，我们将每个阶数单独看做一个特征。当我们需要描述复杂的非线性模型时我们很可呢会用到这种技巧。但是，假如我们不止考虑一个变量的各个阶数而是多个变量，假如我们有k个变量，那么d阶项就有$C_{k+d-1}^{k-1}$个，（高中数学，等价于每种变量至少取一个时k+d阶项数，此时可以想象在k+d个小球的间隙之间插k-1个插板）。总之，随着阶数增长，模型复杂度也就快速增长，我们不能仅靠控制阶数来使模型复杂度处在一个不偏不倚的位置。</p>
<p>解决问题需要从另一个角度入手，如果我们没办法直接抛弃这些特征，我们可以通过限制权重取值的方式控制模型复杂度。特征数值的大小通过归一化后数量级基本稳定，假如我们同时限制了权重的范围，我们也就同时约束了模型的表达能力。可以这样理解：当我们限制了权重的大小的时候，我们本质上限制了函数图像的扭曲程度。假如我们不限制权重，模型拟合的函数图像就可以以非常夸张的曲线精准的穿过所有样本点，虽然对于有限的训练集来说可以达到很高的准确度，但是对于真实的分布来说这样的曲线对于整体误差是帮倒忙的。限制了图像扭曲程度后，图像就像一个铁棒很难被随意扭曲，只能表现数据分布的大致趋势，这样反而提高了泛化能力。</p>
<p>具体的实施方法是在基本的MSE损失函数基础上加上权重的L2范数。
</p>
$$L(\mathbf{w}, b) = \frac{1}{n}\sum_{i=1}^n \frac{1}{2}\left(\mathbf{w}^\top \mathbf{x}^{(i)} + b - y^{(i)}\right)^2 + \frac{\lambda}{2} \|\mathbf{w}\|^2$$<p>之所以使用L2范数是因为L2正则化模型构成了经典的<em>岭回归</em>算法，对权重向量的大分量进行了巨大惩罚，更加适用于对大量特征均匀分布权重的模型。</p>
<h2 id="从零实现">从零实现<a href="#%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>n_train, n_test, num_inputs, batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>true_w, true_b <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>ones((num_inputs, <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.01</span>, <span style="color:#ae81ff">0.05</span>
</span></span><span style="display:flex;"><span>train_data <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>synthetic_data(true_w, true_b, n_train)
</span></span><span style="display:flex;"><span>train_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_array(train_data, batch_size)
</span></span><span style="display:flex;"><span>test_data <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>synthetic_data(true_w, true_b, n_test)
</span></span><span style="display:flex;"><span>test_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_array(test_data, batch_size, is_train<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span></code></pre></div><p>此处附上d2l中对应的函数的实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">synthetic_data</span>(w, b, num_examples):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Generate y = Xw + b + noise.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Defined in :numref:`sec_utils`&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    X <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, (num_examples, len(w)))
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>matmul(X, w) <span style="color:#f92672">+</span> b
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">+=</span> d2l<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, y<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> X, d2l<span style="color:#f92672">.</span>reshape(y, (<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_array</span>(data_arrays, batch_size, is_train<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Construct a PyTorch data iterator.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Defined in :numref:`sec_utils`&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    dataset <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>TensorDataset(<span style="color:#f92672">*</span>data_arrays)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>utils<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>DataLoader(dataset, batch_size, shuffle<span style="color:#f92672">=</span>is_train)
</span></span></code></pre></div><p>人造数据集生成是基于权重张量和偏置的形状进行的，所以不用关心形状是否匹配的问题。</p>
<p>完整代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn, t
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> softmax_scratch <span style="color:#f92672">import</span> Animator
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>n_train, n_test, num_inputs, batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>true_w, true_b <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>ones((num_inputs, <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.01</span>, <span style="color:#ae81ff">0.05</span>
</span></span><span style="display:flex;"><span>train_data <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>synthetic_data(true_w, true_b, n_train)
</span></span><span style="display:flex;"><span>train_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_array(train_data, batch_size)
</span></span><span style="display:flex;"><span>test_data <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>synthetic_data(true_w, true_b, n_test)
</span></span><span style="display:flex;"><span>test_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_array(test_data, batch_size, is_train<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init_weight</span>():
</span></span><span style="display:flex;"><span>    w <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, size<span style="color:#f92672">=</span>(num_inputs, <span style="color:#ae81ff">1</span>), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    b <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(<span style="color:#ae81ff">1</span>, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> w, b
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">l2_penalty</span>(w: torch<span style="color:#f92672">.</span>Tensor):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>sum(w<span style="color:#f92672">.</span>pow(<span style="color:#ae81ff">2</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>(lambd):
</span></span><span style="display:flex;"><span>    w, b <span style="color:#f92672">=</span> init_weight()
</span></span><span style="display:flex;"><span>    net <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> X: (torch<span style="color:#f92672">.</span>matmul(X, w) <span style="color:#f92672">+</span> b)
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> y_hat, y: ((y_hat <span style="color:#f92672">-</span> y<span style="color:#f92672">.</span>reshape(y_hat<span style="color:#f92672">.</span>shape)) <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    num_epochs, lr <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0.003</span>
</span></span><span style="display:flex;"><span>    animator <span style="color:#f92672">=</span> Animator(
</span></span><span style="display:flex;"><span>        xlabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;epochs&#34;</span>,
</span></span><span style="display:flex;"><span>        ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;loss&#34;</span>,
</span></span><span style="display:flex;"><span>        yscale<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;log&#34;</span>,
</span></span><span style="display:flex;"><span>        xlim<span style="color:#f92672">=</span>[<span style="color:#ae81ff">5</span>, num_epochs],
</span></span><span style="display:flex;"><span>        legend<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;train&#34;</span>, <span style="color:#e6db74">&#34;test&#34;</span>],
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> train_iter:
</span></span><span style="display:flex;"><span>            l: torch<span style="color:#f92672">.</span>Tensor <span style="color:#f92672">=</span> loss(net(X), y) <span style="color:#f92672">+</span> lambd <span style="color:#f92672">*</span> l2_penalty(w)
</span></span><span style="display:flex;"><span>            l<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>            d2l<span style="color:#f92672">.</span>sgd([w, b], lr, batch_size)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            animator<span style="color:#f92672">.</span>add(
</span></span><span style="display:flex;"><span>                epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                (
</span></span><span style="display:flex;"><span>                    d2l<span style="color:#f92672">.</span>evaluate_loss(net, train_iter, loss),
</span></span><span style="display:flex;"><span>                    d2l<span style="color:#f92672">.</span>evaluate_loss(net, test_iter, loss),
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;w的L2范数是：&#34;</span>, torch<span style="color:#f92672">.</span>norm(w)<span style="color:#f92672">.</span>item())
</span></span></code></pre></div><p>我们本次的实现中对于数据集的设置是别有用心的。我们为整个线性回归模型定义了200个特征，按理我们会需要大量的训练数据才能捕捉这些特征，但是我们只提供了20个训练样本，同时测试样本却有100个。假如模型的泛化能力不足，只局限于20个训练样本，之后的测试样本误差会非常大。</p>
<p>但是我们此处在训练函数中引入了一个参数<code>lambd</code>来表示权重衰减的系数。通过约束权重的大小，我们希望能提高模型的泛化能力。</p>
<p><code>train(lambd=0)</code>输出结果：</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9704%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9704%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA-20260209-1.png" alt=""></p>
<p>这里之所以左侧刻度看起来很奇怪是因为使用了对数刻度。</p>
<p>可以看到此时w的L2范数约11.459，而测试误差随着迭代次数增加基本不变。这意味着模型出现了严重的过拟合现象。</p>
<p><code>train(lambd=3)</code>输出结果：</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9704%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9704%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA-20260209-2.png" alt=""></p>
<p>训练误差增大但是测试误差减小，符合预期。</p>
<h2 id="简洁实现">简洁实现：<a href="#%e7%ae%80%e6%b4%81%e5%ae%9e%e7%8e%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> softmax_scratch <span style="color:#f92672">import</span> Animator
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>n_train, n_test, num_inputs, batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>true_w, true_b <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>ones((num_inputs, <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.01</span>, <span style="color:#ae81ff">0.05</span>
</span></span><span style="display:flex;"><span>train_data <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>synthetic_data(true_w, true_b, n_train)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_array(train_data, batch_size)
</span></span><span style="display:flex;"><span>test_data <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>synthetic_data(true_w, true_b, n_test)
</span></span><span style="display:flex;"><span>test_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_array(test_data, batch_size, is_train<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train_concise</span>(wd):
</span></span><span style="display:flex;"><span>    net <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(nn<span style="color:#f92672">.</span>Linear(num_inputs, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> param <span style="color:#f92672">in</span> net<span style="color:#f92672">.</span>parameters():
</span></span><span style="display:flex;"><span>        param<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>normal_()
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> type(param)
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>MSELoss(reduction<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;none&#34;</span>)
</span></span><span style="display:flex;"><span>    num_epochs, lr <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">0.003</span>
</span></span><span style="display:flex;"><span>    trainer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD(
</span></span><span style="display:flex;"><span>        [{<span style="color:#e6db74">&#34;params&#34;</span>: net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>weight, <span style="color:#e6db74">&#34;weight_decay&#34;</span>: wd}, {<span style="color:#e6db74">&#34;params&#34;</span>: net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>bias}], lr<span style="color:#f92672">=</span>lr
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    animator <span style="color:#f92672">=</span> Animator(
</span></span><span style="display:flex;"><span>        xlabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;epochs&#34;</span>,
</span></span><span style="display:flex;"><span>        ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;loss&#34;</span>,
</span></span><span style="display:flex;"><span>        yscale<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;log&#34;</span>,
</span></span><span style="display:flex;"><span>        xlim<span style="color:#f92672">=</span>[<span style="color:#ae81ff">5</span>, num_epochs],
</span></span><span style="display:flex;"><span>        legend<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;train&#34;</span>, <span style="color:#e6db74">&#34;test&#34;</span>],
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> train_iter:
</span></span><span style="display:flex;"><span>            trainer<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>            l <span style="color:#f92672">=</span> loss(net(X), y)
</span></span><span style="display:flex;"><span>            l<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>            trainer<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            animator<span style="color:#f92672">.</span>add(
</span></span><span style="display:flex;"><span>                epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                (
</span></span><span style="display:flex;"><span>                    d2l<span style="color:#f92672">.</span>evaluate_loss(net, train_iter, loss),
</span></span><span style="display:flex;"><span>                    d2l<span style="color:#f92672">.</span>evaluate_loss(net, test_iter, loss),
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;w的L2范数是：&#34;</span>, torch<span style="color:#f92672">.</span>norm(net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>weight)<span style="color:#f92672">.</span>item())
</span></span><span style="display:flex;"><span>    print(t)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nn<span style="color:#f92672">.</span>parameter<span style="color:#f92672">.</span>Parameter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_concise(<span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><p>效果和之前的实现一致，只不过速度更快，更容易实现。</p>
<h2 id="课后练习选做">课后练习选做：<a href="#%e8%af%be%e5%90%8e%e7%bb%83%e4%b9%a0%e9%80%89%e5%81%9a" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="q3使用l1正则化后更新方程是什么样的">Q3：使用L1正则化后更新方程是什么样的?<a href="#q3%e4%bd%bf%e7%94%a8l1%e6%ad%a3%e5%88%99%e5%8c%96%e5%90%8e%e6%9b%b4%e6%96%b0%e6%96%b9%e7%a8%8b%e6%98%af%e4%bb%80%e4%b9%88%e6%a0%b7%e7%9a%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>L2正则化：
</p>
$$
\begin{aligned}
\mathbf{w} & \leftarrow \left(1- \eta\lambda \right) \mathbf{w} - \frac{\eta}{|\mathcal{B}|} \sum_{i \in \mathcal{B}} \mathbf{x}^{(i)} \left(\mathbf{w}^\top \mathbf{x}^{(i)} + b - y^{(i)}\right).
\end{aligned}
$$<p>
L1正则化：
</p>
$$
\begin{aligned}
\mathbf{w} & \leftarrow  \mathbf{w}- \eta\lambda  - \frac{\eta}{|\mathcal{B}|} \sum_{i \in \mathcal{B}} \mathbf{x}^{(i)} \left(\mathbf{w}^\top \mathbf{x}^{(i)} + b - y^{(i)}\right).
\end{aligned}
$$<h1 id="暂退法">暂退法<a href="#%e6%9a%82%e9%80%80%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>理论的东西不大看的懂，简单来说就是在训练时随机扔掉一些神经元，不让它们参加训练，这样模型的计算就不能过度依赖于任何一个神经元。当然这只是暂退法的一种标准实现，本质上暂退法是希望通过在每一层计算前加入噪声来提高模型对于随机噪声的适应性。</p>
<p>神经元在torch机器学习框架下的具体表现也就是权重参数。我们可以通过随机将一些权重参数调为0来实现。</p>
<h2 id="从零实现-1">从零实现<a href="#%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dropout_layer</span>(X:torch<span style="color:#f92672">.</span>Tensor, dropout):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&lt;=</span> dropout <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> dropout <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> X
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> dropout <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>zeros_like(X)
</span></span><span style="display:flex;"><span>    mask <span style="color:#f92672">=</span> (torch<span style="color:#f92672">.</span>rand(X<span style="color:#f92672">.</span>shape)<span style="color:#f92672">&gt;</span> dropout)<span style="color:#f92672">.</span>float()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> mask <span style="color:#f92672">*</span> X <span style="color:#f92672">/</span> (<span style="color:#ae81ff">1.0</span> <span style="color:#f92672">-</span> dropout)
</span></span></code></pre></div><p><code>mask</code>是一个掩码张量，符合条件的位置为1，否则为0。在X按元素与<code>mask</code>相乘之后再除以<code>(1.0 - dropout)</code>使得该层的权重均值保持稳定。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>num_inputs, num_outputs, num_hiddens1, num_hiddens2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">784</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">256</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dropout1, dropout2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.2</span>, <span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Net</span>(nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, num_inputs, num_outputs, num_hiddens1, num_hiddens2,
</span></span><span style="display:flex;"><span>                 is_training <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>        super(Net, self)<span style="color:#f92672">.</span><span style="color:#a6e22e">__init__</span>()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>num_inputs <span style="color:#f92672">=</span> num_inputs
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>training <span style="color:#f92672">=</span> is_training
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>lin1 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Linear(num_inputs, num_hiddens1)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>lin2 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Linear(num_hiddens1, num_hiddens2)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>lin3 <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Linear(num_hiddens2, num_outputs)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>relu <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>ReLU()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self, X):
</span></span><span style="display:flex;"><span>        H1 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>relu(self<span style="color:#f92672">.</span>lin1(X<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, self<span style="color:#f92672">.</span>num_inputs))))
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 只有在训练模型时才使用dropout</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>training <span style="color:#f92672">==</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 在第一个全连接层之后添加一个dropout层</span>
</span></span><span style="display:flex;"><span>            H1 <span style="color:#f92672">=</span> dropout_layer(H1, dropout1)
</span></span><span style="display:flex;"><span>        H2 <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>relu(self<span style="color:#f92672">.</span>lin2(H1))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>training <span style="color:#f92672">==</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 在第二个全连接层之后添加一个dropout层</span>
</span></span><span style="display:flex;"><span>            H2 <span style="color:#f92672">=</span> dropout_layer(H2, dropout2)
</span></span><span style="display:flex;"><span>        out <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>lin3(H2)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>net <span style="color:#f92672">=</span> Net(num_inputs, num_outputs, num_hiddens1, num_hiddens2)
</span></span></code></pre></div><p>具体的实现上直接手动继承<code>nn.Module</code>类并修改forward方法。两个隐藏层均使用了ReLU激活函数，此处向前传播的逻辑是每层计算前先计算ReLU激活函数，如果正在训练则再计算dropout。</p>
<p>懒得写了，总之我们直接看简洁实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> softmax_scratch <span style="color:#f92672">import</span> train_ch3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num_inputs, num_outputs, num_hiddens1, num_hiddens2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">784</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dropout1, dropout2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.2</span>, <span style="color:#ae81ff">0.5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>net <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(
</span></span><span style="display:flex;"><span>    nn<span style="color:#f92672">.</span>Flatten(),
</span></span><span style="display:flex;"><span>    nn<span style="color:#f92672">.</span>Linear(num_inputs, num_hiddens1),
</span></span><span style="display:flex;"><span>    nn<span style="color:#f92672">.</span>ReLU(),
</span></span><span style="display:flex;"><span>    nn<span style="color:#f92672">.</span>Dropout(dropout1),
</span></span><span style="display:flex;"><span>    nn<span style="color:#f92672">.</span>Linear(num_hiddens1, num_hiddens2),
</span></span><span style="display:flex;"><span>    nn<span style="color:#f92672">.</span>ReLU(),
</span></span><span style="display:flex;"><span>    nn<span style="color:#f92672">.</span>Dropout(dropout2),
</span></span><span style="display:flex;"><span>    nn<span style="color:#f92672">.</span>Linear(num_hiddens2, num_outputs),
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init_weight</span>(m: nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> type(m) <span style="color:#f92672">is</span> nn<span style="color:#f92672">.</span>Linear:
</span></span><span style="display:flex;"><span>        nn<span style="color:#f92672">.</span>init<span style="color:#f92672">.</span>normal_(m<span style="color:#f92672">.</span>weight, std<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loss <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>CrossEntropyLoss(reduction<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;none&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>net<span style="color:#f92672">.</span>apply(init_weight)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num_epochs, lr, batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_iter, test_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_data_fashion_mnist(batch_size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>trainer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD(net<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span>lr)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_ch3(net, train_iter, test_iter, loss, num_epochs, trainer)
</span></span></code></pre></div><p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9704%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9704%E5%A4%9A%E5%B1%82%E6%84%9F%E7%9F%A5%E6%9C%BA-20260209-3.png" alt=""></p>
<p>其中绿色是训练命中率，红色是测试命中率。</p>
<h2 id="课后练习选做-1">课后练习选做<a href="#%e8%af%be%e5%90%8e%e7%bb%83%e4%b9%a0%e9%80%89%e5%81%9a-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="q1如果更改第一层和第二层的暂退法概率会发生什么情况具体地说如果交换这两个层会发生什么情况设计一个实验来回答这些问题定量描述该结果并总结定性的结论">Q1：如果更改第一层和第二层的暂退法概率，会发生什么情况？具体地说，如果交换这两个层，会发生什么情况？设计一个实验来回答这些问题，定量描述该结果，并总结定性的结论。<a href="#q1%e5%a6%82%e6%9e%9c%e6%9b%b4%e6%94%b9%e7%ac%ac%e4%b8%80%e5%b1%82%e5%92%8c%e7%ac%ac%e4%ba%8c%e5%b1%82%e7%9a%84%e6%9a%82%e9%80%80%e6%b3%95%e6%a6%82%e7%8e%87%e4%bc%9a%e5%8f%91%e7%94%9f%e4%bb%80%e4%b9%88%e6%83%85%e5%86%b5%e5%85%b7%e4%bd%93%e5%9c%b0%e8%af%b4%e5%a6%82%e6%9e%9c%e4%ba%a4%e6%8d%a2%e8%bf%99%e4%b8%a4%e4%b8%aa%e5%b1%82%e4%bc%9a%e5%8f%91%e7%94%9f%e4%bb%80%e4%b9%88%e6%83%85%e5%86%b5%e8%ae%be%e8%ae%a1%e4%b8%80%e4%b8%aa%e5%ae%9e%e9%aa%8c%e6%9d%a5%e5%9b%9e%e7%ad%94%e8%bf%99%e4%ba%9b%e9%97%ae%e9%a2%98%e5%ae%9a%e9%87%8f%e6%8f%8f%e8%bf%b0%e8%af%a5%e7%bb%93%e6%9e%9c%e5%b9%b6%e6%80%bb%e7%bb%93%e5%ae%9a%e6%80%a7%e7%9a%84%e7%bb%93%e8%ae%ba" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> softmax_scratch <span style="color:#f92672">import</span> train_ch3, Accumulator
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dropout_test</span>(dropout1, dropout2):
</span></span><span style="display:flex;"><span>    num_inputs, num_outputs, num_hiddens1, num_hiddens2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">784</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">256</span>, <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    net <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(
</span></span><span style="display:flex;"><span>        nn<span style="color:#f92672">.</span>Flatten(),
</span></span><span style="display:flex;"><span>        nn<span style="color:#f92672">.</span>Linear(num_inputs, num_hiddens1),
</span></span><span style="display:flex;"><span>        nn<span style="color:#f92672">.</span>ReLU(),
</span></span><span style="display:flex;"><span>        nn<span style="color:#f92672">.</span>Dropout(dropout1),
</span></span><span style="display:flex;"><span>        nn<span style="color:#f92672">.</span>Linear(num_hiddens1, num_hiddens2),
</span></span><span style="display:flex;"><span>        nn<span style="color:#f92672">.</span>ReLU(),
</span></span><span style="display:flex;"><span>        nn<span style="color:#f92672">.</span>Dropout(dropout2),
</span></span><span style="display:flex;"><span>        nn<span style="color:#f92672">.</span>Linear(num_hiddens2, num_outputs),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init_weight</span>(m: nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> type(m) <span style="color:#f92672">is</span> nn<span style="color:#f92672">.</span>Linear:
</span></span><span style="display:flex;"><span>            nn<span style="color:#f92672">.</span>init<span style="color:#f92672">.</span>normal_(m<span style="color:#f92672">.</span>weight, std<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    loss <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>CrossEntropyLoss(reduction<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;none&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    net<span style="color:#f92672">.</span>apply(init_weight)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    num_epochs, lr, batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    train_iter, test_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_data_fashion_mnist(batch_size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    trainer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD(net<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span>lr)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    train_ch3(net, train_iter, test_iter, loss, num_epochs, trainer)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    metric <span style="color:#f92672">=</span> Accumulator(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    net<span style="color:#f92672">.</span>eval()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> test_iter:
</span></span><span style="display:flex;"><span>            y_hat: torch<span style="color:#f92672">.</span>Tensor <span style="color:#f92672">=</span> net(X)
</span></span><span style="display:flex;"><span>            accurate <span style="color:#f92672">=</span> ((y_hat<span style="color:#f92672">.</span>argmax(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))<span style="color:#f92672">.</span>type(y<span style="color:#f92672">.</span>dtype) <span style="color:#f92672">==</span> y)<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>item()
</span></span><span style="display:flex;"><span>            metric<span style="color:#f92672">.</span>add(accurate, y<span style="color:#f92672">.</span>numel())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> metric[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">/</span> metric[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> dropout1 <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> dropout2 <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>        print(
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;dropout1: </span><span style="color:#e6db74">{</span>(dropout1 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span>)<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, dropout2: </span><span style="color:#e6db74">{</span>(dropout2 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span>)<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, accuracy: </span><span style="color:#e6db74">{</span>(dropout_test(dropout1 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span>, dropout2 <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.1</span>))<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        )
</span></span></code></pre></div><p>绿皮科技，震撼人心。俺寻思这能跑啊。</p>
<p>输出结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.87</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.87</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.87</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.79</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.87</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.87</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.79</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.72</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.50</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.52</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.55</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.57</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.46</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.50</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.58</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.55</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.60</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.45</span>
</span></span></code></pre></div><p>从数据中简单看下来似乎浅层对于dropout更加脆弱，当浅层dropout量较大时准确率才会显著下降，而深层dropout似乎对于结果的调节更加细微。可能的原因是深层的神经元实际上已经出现了冗余，多个神经元聚焦于相似的高级特征，此时即使只剩下10%照样可以工作。</p>
<h3 id="q4以本节中的模型为例比较使用暂退法和权重衰减的效果如果同时使用暂退法和权重衰减会发生什么情况结果是累加的吗收益是否减少或者说更糟它们互相抵消了吗">Q4：以本节中的模型为例，比较使用暂退法和权重衰减的效果。如果同时使用暂退法和权重衰减，会发生什么情况？结果是累加的吗？收益是否减少（或者说更糟）？它们互相抵消了吗？<a href="#q4%e4%bb%a5%e6%9c%ac%e8%8a%82%e4%b8%ad%e7%9a%84%e6%a8%a1%e5%9e%8b%e4%b8%ba%e4%be%8b%e6%af%94%e8%be%83%e4%bd%bf%e7%94%a8%e6%9a%82%e9%80%80%e6%b3%95%e5%92%8c%e6%9d%83%e9%87%8d%e8%a1%b0%e5%87%8f%e7%9a%84%e6%95%88%e6%9e%9c%e5%a6%82%e6%9e%9c%e5%90%8c%e6%97%b6%e4%bd%bf%e7%94%a8%e6%9a%82%e9%80%80%e6%b3%95%e5%92%8c%e6%9d%83%e9%87%8d%e8%a1%b0%e5%87%8f%e4%bc%9a%e5%8f%91%e7%94%9f%e4%bb%80%e4%b9%88%e6%83%85%e5%86%b5%e7%bb%93%e6%9e%9c%e6%98%af%e7%b4%af%e5%8a%a0%e7%9a%84%e5%90%97%e6%94%b6%e7%9b%8a%e6%98%af%e5%90%a6%e5%87%8f%e5%b0%91%e6%88%96%e8%80%85%e8%af%b4%e6%9b%b4%e7%b3%9f%e5%ae%83%e4%bb%ac%e4%ba%92%e7%9b%b8%e6%8a%b5%e6%b6%88%e4%ba%86%e5%90%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在Q1代码基础上添加了3的权重衰减。</p>
<p>结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.10</span>
</span></span></code></pre></div><p>之所以会出现这种结果，原因在于我是蠢比。权重衰减数值的选取需要参考更新方程，其中正则化项最终的影响效果由权重的L2范数乘以正则化系数再乘以学习率得到。由于我这里设置学习率为0.5，正则化系数为3，导致每次计算权重都会倒转。并且因为正则化系数过大，模型表达能力很弱，导致只能乱猜。</p>
<p>作为对比，我们修改正则化系数为0.001即1e-03，结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.79</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.79</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.75</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.00</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.79</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.78</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.10</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.20</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.77</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.30</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.40</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.86</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.50</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.85</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.60</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.79</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.79</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.84</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.70</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.79</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.79</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.80</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.83</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.81</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.78</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.82</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.80</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.68</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.00</span>, accuracy: <span style="color:#ae81ff">0.69</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.10</span>, accuracy: <span style="color:#ae81ff">0.65</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.20</span>, accuracy: <span style="color:#ae81ff">0.62</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.30</span>, accuracy: <span style="color:#ae81ff">0.54</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.40</span>, accuracy: <span style="color:#ae81ff">0.61</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.50</span>, accuracy: <span style="color:#ae81ff">0.58</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.60</span>, accuracy: <span style="color:#ae81ff">0.56</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.70</span>, accuracy: <span style="color:#ae81ff">0.64</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.80</span>, accuracy: <span style="color:#ae81ff">0.53</span>
</span></span><span style="display:flex;"><span>dropout1: <span style="color:#ae81ff">0.90</span>, dropout2: <span style="color:#ae81ff">0.90</span>, accuracy: <span style="color:#ae81ff">0.39</span>
</span></span></code></pre></div><p>通常来说我们认为权重衰减和暂退法的收益是可以叠加的，因为它们是从不同维度对模型进行限制，前者限制参数大小，后者在网络结构中引入噪声。然而，收益无法无限叠加，原因在于正则化会导致模型出现偏差，过高的权重衰减或者dropout会导致模型连训练集都学不会而发生欠拟合。</p>
<h1 id="向前传播反向传播和计算图">向前传播、反向传播和计算图<a href="#%e5%90%91%e5%89%8d%e4%bc%a0%e6%92%ad%e5%8f%8d%e5%90%91%e4%bc%a0%e6%92%ad%e5%92%8c%e8%ae%a1%e7%ae%97%e5%9b%be" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<blockquote>
<p>前向传播在神经网络定义的计算图中按顺序计算和存储中间变量，它的顺序是从输入层到输出层。反向传播按相反的顺序（从输出层到输入层）计算和存储神经网络的中间变量和参数的梯度。在训练深度学习模型时，前向传播和反向传播是相互依赖的。训练比预测需要更多的内存。</p>
</blockquote>
<h2 id="课后练习选做-2">课后练习选做：<a href="#%e8%af%be%e5%90%8e%e7%bb%83%e4%b9%a0%e9%80%89%e5%81%9a-2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="q1假设一些标量函数的输入是矩阵相对于的梯度维数是多少">Q1：假设一些标量函数$\mathbf{X}$的输入$\mathbf{X}$是$n \times m$矩阵。$f$相对于$\mathbf{X}$的梯度维数是多少？<a href="#q1%e5%81%87%e8%ae%be%e4%b8%80%e4%ba%9b%e6%a0%87%e9%87%8f%e5%87%bd%e6%95%b0%e7%9a%84%e8%be%93%e5%85%a5%e6%98%af%e7%9f%a9%e9%98%b5%e7%9b%b8%e5%af%b9%e4%ba%8e%e7%9a%84%e6%a2%af%e5%ba%a6%e7%bb%b4%e6%95%b0%e6%98%af%e5%a4%9a%e5%b0%91" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>2维。</p>
<p>后面的题目有点不明所以，遂不做。</p>
<h1 id="数值稳定性和模型初始化">数值稳定性和模型初始化<a href="#%e6%95%b0%e5%80%bc%e7%a8%b3%e5%ae%9a%e6%80%a7%e5%92%8c%e6%a8%a1%e5%9e%8b%e5%88%9d%e5%a7%8b%e5%8c%96" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<h2 id="梯度消失和梯度爆炸">梯度消失和梯度爆炸<a href="#%e6%a2%af%e5%ba%a6%e6%b6%88%e5%a4%b1%e5%92%8c%e6%a2%af%e5%ba%a6%e7%88%86%e7%82%b8" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>梯度消失指参数更新过小导致模型几乎无法学习。在激活函数部分我们有谈到sigmoid函数，在正无穷上收敛于1，负无穷上收敛于0。这就意味着当输入值很大或者很小的时候，sigmoid梯度都会消失。当我们使用多层神经网络时，sigmoid函数可能会导致梯度在某一层被切断。</p>
<p>与之相对的是梯度爆炸，即梯度过高破坏了模型的稳定收敛。比如假如将参数初始化过大，参数增长速度过快导致梯度下降优化器没有机会使其收敛。</p>
<h2 id="对称性">对称性<a href="#%e5%af%b9%e7%a7%b0%e6%80%a7" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>多层感知机中的隐藏层中不同神经元的地位纯数学的视角看待是相等的。假如我们一开始初始化的时候让所有神经元的权重一致，那么无论是正向传播还是反向传播，所有神经元的行为都会完全一致，隐藏层即使有再多的神经元，最后表现出来的结果都和只有一个神经元没有区别。</p>
<h2 id="xavier初始化">Xavier初始化<a href="#xavier%e5%88%9d%e5%a7%8b%e5%8c%96" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>我们假如某个模型的某个隐藏层有$n_{in}$个输入，输入数据的方差为$\gamma^2$，均值为0，而该层的权重方差为$\sigma^2$。假如该层只是进行了简单的线性变换，我们可以得知输出数据的方差为$n_{in}\gamma^2\sigma^2$。假如我们希望输入输出方差不变，我们就需要确保$n_{in}\sigma^2=1$。</p>
<p>同样的，对于反向传播，假如我们希望经过该层之后梯度的方差也不发生变化，我们需要确保$n_{out}\sigma^2=1$。</p>
<p>但是这样就会出现一个问题：$\sigma$是唯一的，而$n_{in}$和$n_{out}$很可能不同。所以我们采取这样的策略：让$\sigma = \sqrt{\frac{2}{n_{in} + n_{out}}  }$，即让$n_{in}\sigma^2 + n_{out}\sigma^2 = 2$，保持均值为1。这就是Xavier初始化方法。（其实就是给出了一个正态分布初始化权重时参数设置的规范）</p>
<h1 id="环境与分布偏移">环境与分布偏移<a href="#%e7%8e%af%e5%a2%83%e4%b8%8e%e5%88%86%e5%b8%83%e5%81%8f%e7%a7%bb" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>我们可以使用模型拟合各种数据分布，但是现实的数据分布并不是一个静态的模型，它会随时间推移或者情景改变而改变。现实的数据分布甚至会因为模型的学习而改变。经典的例子是你发现申请贷款的人中穿皮鞋的人违约概率小于穿足球鞋的人，所以你只给前者发贷。但是之后你发现所有人都开始穿皮鞋，违约率却没有变化。这就是数据分布本身学习到了你学习它的事实。</p>
<h2 id="协变量偏移">协变量偏移<a href="#%e5%8d%8f%e5%8f%98%e9%87%8f%e5%81%8f%e7%a7%bb" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>设由特征X到标签Y之间存在某种数据分布。显然，我们如果想训练模型来描述这种分布，我们不可能喂给模型无穷的数据，模型训练注定只能考虑一部分输入特征。我们称这种输入特征为所谓的<em>协变量</em>。</p>
<p>假如我们要设计一个由图片判断其是否是猫的模型。就现实层面，同样是猫的图片，特征可能会有相当大的差异，比如可能是一张实拍的猫，可能是一张卡通猫，也可能是另外某种画风的猫，但是它们都同属于“由图片映射到猫分类”的数据分布。假如我们训练模型时只喂给模型实拍的猫而测试时让模型判断一个卡通猫，本质上“由图片映射到猫分类”这样的数据分布并没有变化，变化的是输入的特征分布。我们称这样的分布偏移为<strong>协变量偏移</strong>。</p>
<h2 id="标签偏移">标签偏移<a href="#%e6%a0%87%e7%ad%be%e5%81%8f%e7%a7%bb" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>“由图片映射到分类”的分布仍然不变，而标签由猫变成了狗，这就是标签偏移。标签偏移描述的是标签出现的边缘概率发生改变，比如原本有20%的猫和80%的狗，现在则是80%的猫和20%的狗。我们仍然可以使用特征进行判断。</p>
<p>标签偏移在我们认为标签导致了特征时往往是合理的假设。</p>
<h2 id="概念偏移">概念偏移<a href="#%e6%a6%82%e5%bf%b5%e5%81%8f%e7%a7%bb" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>标签本身的定义发生了变化，导致由特征映射到标签的数据分布发生了改变。最经典的现象是语言的流变，很多词汇随着时间推移含义和原本发生了很大变化。但是词还是原来的词。</p>
<h2 id="分布偏移的纠正">分布偏移的纠正<a href="#%e5%88%86%e5%b8%83%e5%81%8f%e7%a7%bb%e7%9a%84%e7%ba%a0%e6%ad%a3" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>在训练模型的时候，我们并不能直接把测试数据喂给模型，但是我们可以用一个很无赖的方式来变相让模型预习测试数据：虽然我们手上只有训练数据，但是我们可以声称在实际的分布中某些其他的特征也很可能出现，只是我们并不知道他们的标签长什么样。</p>
<p>说白了，我们手上的数据集虽然是有限的，但是我们假定手上的数据集一定程度也反应了某些“虽然出现在本数据集但是并不出众”的特征，这样如果我们可以区分一个训练数据的特征是否更能反应真实的数据分布，我们就可以让机器对这些训练数据更加重视。</p>
<p>具体的实施上，我们额外训练一个二元分类器，它的用途就是猜一个训练集样本是否很像来自特征集的数据，假如很像，那么模型就要对这个样本更加关注，具体表现为对这个样本参考的权重增加。</p>
<blockquote>
<p>现在，我们来看一下完整的协变量偏移纠正算法。假设我们有一个训练集$\{(\mathbf{x}_1, y_1), \ldots, (\mathbf{x}_n, y_n)\}$和一个未标记的测试集$\{\mathbf{u}_1, \ldots, \mathbf{u}_m\}$。对于协变量偏移，我们假设$1 \leq i \leq n$的$\mathbf{x}_i$来自某个源分布，$\mathbf{u}_i$来自目标分布。以下是纠正协变量偏移的典型算法：</p>
<ol>
<li>生成一个二元分类训练集：$\{(\mathbf{x}_1, -1), \ldots, (\mathbf{x}_n, -1), (\mathbf{u}_1, 1), \ldots, (\mathbf{u}_m, 1)\}$。</li>
<li>用对数几率回归训练二元分类器得到函数$h$。</li>
<li>使用$\beta_i = \exp(h(\mathbf{x}_i))$或更好的$\beta_i = \min(\exp(h(\mathbf{x}_i)), c)$（$c$为常量）对训练数据进行加权。</li>
<li>使用权重$\beta_i$进行 :eqref:<code>eq_weighted-empirical-risk-min</code> 中$\{(\mathbf{x}_1, y_1), \ldots, (\mathbf{x}_n, y_n)\}$的训练。</li>
</ol>
</blockquote>
<h2 id="标签偏移的纠正">标签偏移的纠正<a href="#%e6%a0%87%e7%ad%be%e5%81%8f%e7%a7%bb%e7%9a%84%e7%ba%a0%e6%ad%a3" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>标签偏移既没有改变条件分布，也没有改变协变量，理想情况是假如我们的机器真的通过训练集的学习完全习得了真实的条件分布，按理来说即使出现了标签偏移也没有什么问题。但是真实情况是，当数据集中的某种标签含量与真实情况有所不同时，模型对其的判断也会出现偏差，比如假如一个模型90%的标签都是猫，即使现实中只有10%是猫，模型判断为猫的概率也可能很大；反之，假如一个模型训练集中只有5%为狗，即使现实中有50%为狗，模型判断为狗的概率也会显著小于50%。</p>
<p>解决方法是，我们再用一个看起来很作弊的方法：我们先用训练集训练好模型，之后我们用训练好的模型去预测验证集，之后统计结果，计算出一个条件概率矩阵$C$，其中的每个元素$c_{ij}$表示当真实类别为$i$时有多大的概率预测为$j$。假如验证集的标签分布是符合真实情况的，我们就可以用这个条件概率矩阵套在模型下游来纠正标签分布。</p>
<p>乍一看会寻思这样做和直接把验证集拿来训练有什么区别，其实还是有本质上的区别的，假如只是把验证集简单的纳入训练集，我们依然无法模拟真实的标签分布，但是使用混淆矩阵我们就可以让模型的输出严格依照验证集的分布进行修正。</p>
<h2 id="概念偏移的纠正">概念偏移的纠正<a href="#%e6%a6%82%e5%bf%b5%e5%81%8f%e7%a7%bb%e7%9a%84%e7%ba%a0%e6%ad%a3" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>用新的数据更新网络权重，或者从头训练。</p>
<h1 id="kaggle房价预测实战">Kaggle房价预测实战<a href="#kaggle%e6%88%bf%e4%bb%b7%e9%a2%84%e6%b5%8b%e5%ae%9e%e6%88%98" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>这节我决定先自己折腾个模型再看d2l讲义，届时再发博客。</p>
]]></content>
		</item>
		
		<item>
			<title>Python文件结构&amp;一些库</title>
			<link>http://localhost:1313/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/</link>
			<pubDate>Wed, 11 Feb 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>虽然学了很久python，但是我从来没有系统学习过python的项目结构是怎么组织的。主要一般也很少有机会写多文件乃至多目录的python项目。最近突然对ai agent应用有点感兴趣，碰巧自己对这方面的工具确实有需求，顾不上老坑了，速速把新坑端上来罢（喜）</p>
<p>写本文的另一个原因是我觉得自己真的得好好学学cli工具该怎么写。虽然自己很难做到随手搓出一个很精致的图形化应用，但是手搓个cli应用还是应该能做到的。</p>
<h1 id="参考链接本篇要素">参考链接（本篇要素）：<a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5%e6%9c%ac%e7%af%87%e8%a6%81%e7%b4%a0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p><a href="https://github.com/Arindam200/awesome-ai-apps">awesome-ai-apps</a>，最近找到的一个ai工具开发的开源学习库。本篇可能暂时用不到，但是之后<em>如果填坑</em>的话应该会参考。</p>
<p><a href="https://realpython.com/python-modules-packages/">Python Modules and Packages – An Introduction</a>虽然说是一个&quot;Introduction&quot;，但是内容还挺详细的，所以很多例子干脆照搬了。</p>
<p><a href="https://docs.python.org/3/library/os.html">os lib</a>Python os库用来读写文件和执行系统指令。</p>
<p><a href="https://www.w3schools.com/PYTHON/python_json.asp">json</a>W3school的Python json库教程。w3school的网上教程其实做的相当不错。</p>
<p><a href="https://typer.tiangolo.com/">typer</a>一个用来开发python cli应用的库。平板上写应用基本只能在cli和web之间选一个。</p>
<blockquote>
<p>写这篇文章的时候我发现typer的tutorial事无巨细地讲了一大堆计算机常识，作为一个python库文档从环境变量和PATH变量开始讲起，写文档的哥们未免有点太敬业了。</p>
</blockquote>
<p><a href="https://rich.readthedocs.io/en/latest/introduction.html">rich</a>炫酷的终端文本ui库。</p>
<p><a href="https://tenacity.readthedocs.io/en/latest/">tenacity</a>添加了一个装饰器，可以方便的定义函数重复执行规则。比如调用api出现网络波动时可以让函数自动重复执行3次。</p>
<p><a href="https://requests.readthedocs.io/en/latest/">requests</a>发送HTTP请求。</p>
<h1 id="python的文件结构">Python的文件结构<a href="#python%e7%9a%84%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>python中有两个专门服务于模块化编程的术语，模块（python modules）和包（python packages）。简单来说，模块化编程就是把一个大项目分解成若干子任务和模块。把所有东西都塞在一个文件中会导致代码难以维护。</p>
<blockquote>
<p><strong>Functions</strong>, <strong>modules</strong> and <strong>packages</strong> are all constructs in Python that promote code modularization.</p>
</blockquote>
<h2 id="python-modules">Python modules<a href="#python-modules" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>python模块实际上有以下三种定义：</p>
<ol>
<li>用python写的模块；</li>
<li>用C语言写的模块（头一回知道）；</li>
<li>解释器中的内置模块。</li>
</ol>
<p>这三个模块的共同点是，他们的内容都可以通过<code>import</code>语句访问。</p>
<p>大多数时候我们主要关注python写的模块，它们<em>are exceedingly straightforward to build</em>。你不需要有任何特殊的语法标记，只要是没有语法错误的.py文件都是合法的python模块。</p>
<p>举个例子，假如你随便在某个文件目录下创建了一个<code>mod.py</code>，内容如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;If Comrade Napoleon says it, it must be right.&#34;</span>
</span></span><span style="display:flex;"><span>a <span style="color:#f92672">=</span> [<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">300</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">foo</span>(arg):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;arg = </span><span style="color:#e6db74">{</span>arg<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Foo</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pass</span>
</span></span></code></pre></div><p>这个py文件中定义了这些东西（object也指对象，但是类显然不是对象，所以干脆译为东西）：</p>
<ul>
<li><code>s</code> (字符串)</li>
<li><code>a</code> (列表)</li>
<li><code>foo()</code> (函数)</li>
<li><code>Foo</code> (类)</li>
</ul>
<p>假如这个py文件<em>处在正确的位置</em>（后面会谈到），那么你就可以通过import来访问这些东西。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> mod
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> print(mod<span style="color:#f92672">.</span>s)
</span></span><span style="display:flex;"><span>If Comrade Napoleon says it, it must be right<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> mod<span style="color:#f92672">.</span>a
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">300</span>]
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> mod<span style="color:#f92672">.</span>foo([<span style="color:#e6db74">&#39;quux&#39;</span>, <span style="color:#e6db74">&#39;corge&#39;</span>, <span style="color:#e6db74">&#39;grault&#39;</span>])
</span></span><span style="display:flex;"><span>arg <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;quux&#39;</span>, <span style="color:#e6db74">&#39;corge&#39;</span>, <span style="color:#e6db74">&#39;grault&#39;</span>]
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> x <span style="color:#f92672">=</span> mod<span style="color:#f92672">.</span>Foo()
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> x
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>mod<span style="color:#f92672">.</span>Foo object at <span style="color:#ae81ff">0x03C181F0</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><h3 id="模块搜索路径">模块搜索路径<a href="#%e6%a8%a1%e5%9d%97%e6%90%9c%e7%b4%a2%e8%b7%af%e5%be%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>书接上回，我们来看看python执行语句时发生了什么。</p>
<p>当解释器执行了<code>import mod</code>语句时，它会在一系列目录中寻找这个<code>mod.py</code>这个文件，这一系列目录来源如下：</p>
<ul>
<li>该脚本运行时所处的位置；</li>
<li>输入语句时的当前目录，如果以交互模式运行python解释器；</li>
<li>环境变量<code>PYTHONPATH</code>中的目录；</li>
<li>python安装时就配置好的安装依赖目录列表。</li>
</ul>
<p>所有合法的路径都会存储在python的sys内置模块的path变量中。你可以通过如下方式查看搜索路径：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; import sys
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; sys.path
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;&#39;</span>, <span style="color:#e6db74">&#39;C:\\Users\\john\\Documents\\Python\\doc&#39;</span>, <span style="color:#e6db74">&#39;C:\\Python36\\Lib\\idlelib&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;C:\\Python36\\python36.zip&#39;</span>, <span style="color:#e6db74">&#39;C:\\Python36\\DLLs&#39;</span>, <span style="color:#e6db74">&#39;C:\\Python36\\lib&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;C:\\Python36&#39;</span>, <span style="color:#e6db74">&#39;C:\\Python36\\lib\\site-packages&#39;</span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>所以，如果你想要你的模块被找到，你可以做以下事情：</p>
<ul>
<li>把模块文件放在你所运动的脚本所在的目录，或者如果你以交互模式运行python解释器，那么就放在你当前的目录。</li>
<li>或者确保你的模块处在<code>PYTHONPATH</code>中的某个目录。</li>
<li>或者把文件放在安装依赖目录中，但是你很可能做不到。</li>
</ul>
<p>一些奇奇怪怪的方法这里就不展开了。值得一提的是你可以通过访问一个模块的<code>__file__</code>属性来获取这个模块的绝对位置，得到的是一个文件夹。</p>
<p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260206-1.png" alt=""></p>
<h3 id="import语句使用方法">import语句使用方法<a href="#import%e8%af%ad%e5%8f%a5%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> mod
</span></span></code></pre></div><p>最常用的方法，只是把整个模块塞进了当前符号表，但是mod内的东西还都在mod自己的符号表中，你只能通过<code>mod.xx</code>来访问某个mod中的元素。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> mod <span style="color:#f92672">import</span> xx
</span></span></code></pre></div><p>从mod中直接把一个元素引用到当前符号表，之后不用下标访问也可以直接使用<code>xx</code>。你可以将<code>xx</code>换成<code>*</code>来直接调用mod里的所有东西，但是一般不推荐这么做，容易导致命名冲突。（类似<code>using namespace std;</code>)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> mod <span style="color:#f92672">import</span> xx <span style="color:#66d9ef">as</span> yy
</span></span></code></pre></div><p>引用xx的同时起个别名yy。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>     <span style="color:#75715e"># Non-existent module</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>     <span style="color:#f92672">import</span> baz
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span> <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ImportError</span>:
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>     print(<span style="color:#e6db74">&#39;Module not found&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Module <span style="color:#f92672">not</span> found
</span></span></code></pre></div><p>你可以使用try来尝试调用某个模块，即使不成功程序也可以继续运行。</p>
<h3 id="dir函数">dir函数<a href="#dir%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>dir()</code>会返回一个由当前命名空间中名称所组成的列表，默认按照字典序排列。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> dir()
</span></span><span style="display:flex;"><span>[<span style="color:#e6db74">&#39;__annotations__&#39;</span>, <span style="color:#e6db74">&#39;__builtins__&#39;</span>, <span style="color:#e6db74">&#39;__doc__&#39;</span>, <span style="color:#e6db74">&#39;__loader__&#39;</span>, <span style="color:#e6db74">&#39;__name__&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;__package__&#39;</span>, <span style="color:#e6db74">&#39;__spec__&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> qux <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>]
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> dir()
</span></span><span style="display:flex;"><span>[<span style="color:#e6db74">&#39;__annotations__&#39;</span>, <span style="color:#e6db74">&#39;__builtins__&#39;</span>, <span style="color:#e6db74">&#39;__doc__&#39;</span>, <span style="color:#e6db74">&#39;__loader__&#39;</span>, <span style="color:#e6db74">&#39;__name__&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;__package__&#39;</span>, <span style="color:#e6db74">&#39;__spec__&#39;</span>, <span style="color:#e6db74">&#39;qux&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Bar</span>():
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>     <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> x <span style="color:#f92672">=</span> Bar()
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> dir()
</span></span><span style="display:flex;"><span>[<span style="color:#e6db74">&#39;Bar&#39;</span>, <span style="color:#e6db74">&#39;__annotations__&#39;</span>, <span style="color:#e6db74">&#39;__builtins__&#39;</span>, <span style="color:#e6db74">&#39;__doc__&#39;</span>, <span style="color:#e6db74">&#39;__loader__&#39;</span>, <span style="color:#e6db74">&#39;__name__&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;__package__&#39;</span>, <span style="color:#e6db74">&#39;__spec__&#39;</span>, <span style="color:#e6db74">&#39;qux&#39;</span>, <span style="color:#e6db74">&#39;x&#39;</span>]
</span></span></code></pre></div><p>你也可以传入一个Module参数，这样dir会返回该module自身的命名空间下的名字。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> mod
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> dir(mod)
</span></span><span style="display:flex;"><span>[<span style="color:#e6db74">&#39;Foo&#39;</span>, <span style="color:#e6db74">&#39;__builtins__&#39;</span>, <span style="color:#e6db74">&#39;__cached__&#39;</span>, <span style="color:#e6db74">&#39;__doc__&#39;</span>, <span style="color:#e6db74">&#39;__file__&#39;</span>, <span style="color:#e6db74">&#39;__loader__&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;__name__&#39;</span>, <span style="color:#e6db74">&#39;__package__&#39;</span>, <span style="color:#e6db74">&#39;__spec__&#39;</span>, <span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;foo&#39;</span>, <span style="color:#e6db74">&#39;s&#39;</span>]
</span></span></code></pre></div><h3 id="将模块当脚本执行">将模块当脚本执行<a href="#%e5%b0%86%e6%a8%a1%e5%9d%97%e5%bd%93%e8%84%9a%e6%9c%ac%e6%89%a7%e8%a1%8c" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>一个module本质上还是.py文件，所以你完全可以使用python解释器直接执行该文件。</p>
<p>依然mod.py：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;If Comrade Napoleon says it, it must be right.&#34;</span>
</span></span><span style="display:flex;"><span>a <span style="color:#f92672">=</span> [<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">300</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">foo</span>(arg):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;arg = </span><span style="color:#e6db74">{</span>arg<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Foo</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(s)
</span></span><span style="display:flex;"><span>print(a)
</span></span><span style="display:flex;"><span>foo(<span style="color:#e6db74">&#39;quux&#39;</span>)
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> Foo()
</span></span><span style="display:flex;"><span>print(x)
</span></span></code></pre></div><p>运行结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>C:\Users\john\Documents<span style="color:#f92672">&gt;</span>python mod<span style="color:#f92672">.</span>py
</span></span><span style="display:flex;"><span>If Comrade Napoleon says it, it must be right<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">300</span>]
</span></span><span style="display:flex;"><span>arg <span style="color:#f92672">=</span> quux
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>__main__<span style="color:#f92672">.</span>Foo object at <span style="color:#ae81ff">0x02F101D0</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>然而，这样做又会导致另一个问题：当你import导入这个模块时，这些输出也会被生成：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> mod
</span></span><span style="display:flex;"><span>If Comrade Napoleon says it, it must be right<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">300</span>]
</span></span><span style="display:flex;"><span>arg <span style="color:#f92672">=</span> quux
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span>mod<span style="color:#f92672">.</span>Foo object at <span style="color:#ae81ff">0x0169AD50</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>这些输出之所以会产生，原因在于<code>import</code>语句执行时解释器会先完整执行一遍指定的模块，假如你在模块里塞了定义，解释器就会帮你完成定义，但是假如你塞了print，解释器也会同样帮你print出来对应的内容。然而，我们有时会认为这些输出在该模块import导入时并不应该产生。</p>
<p>解决方法如下：在python中有这样一个特殊的双下划线变量<code>__name__</code>专门用来存储一个module的名称。当一个module被导入时，它的<code>__name__</code>就会被设置为这个module的名称，但是当module被python直接执行时，<code>__name__</code>就会被设置为<code>'__main__'</code>，据此你可以判断一些函数应该在什么时候运行。</p>
<p>修改后的mod.py：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;If Comrade Napoleon says it, it must be right.&#34;</span>
</span></span><span style="display:flex;"><span>a <span style="color:#f92672">=</span> [<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">200</span>, <span style="color:#ae81ff">300</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">foo</span>(arg):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;arg = </span><span style="color:#e6db74">{</span>arg<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Foo</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (__name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#39;Executing as standalone script&#39;</span>)
</span></span><span style="display:flex;"><span>    print(s)
</span></span><span style="display:flex;"><span>    print(a)
</span></span><span style="display:flex;"><span>    foo(<span style="color:#e6db74">&#39;quux&#39;</span>)
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> Foo()
</span></span><span style="display:flex;"><span>    print(x)
</span></span></code></pre></div><p>此时直接用python解释器运行该模块仍然可以得到输出，但是import语句不再会输出了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> mod
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> mod<span style="color:#f92672">.</span>foo(<span style="color:#e6db74">&#39;grault&#39;</span>)
</span></span><span style="display:flex;"><span>arg <span style="color:#f92672">=</span> grault
</span></span></code></pre></div><p>一般来说，就算你的模块独立运行没有什么实际意义，程序员也会设计其独立运行时会执行的脚本来检测它的功能是否符合预期，这种思想被称作单元测试。</p>
<p>比如，假如你有这样的一个用来计算阶乘的模块<code>fact.py</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fact</span>(n):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> n <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> n <span style="color:#f92672">*</span> fact(n<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (__name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(sys<span style="color:#f92672">.</span>argv) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        print(fact(int(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>])))
</span></span></code></pre></div><p>你当然可以通过直接<code>import fact</code>来访问<code>fact.fact()</code>函数，但是你同样可以使用python解释器直接运行<code>fact.py</code>，你可以传入一个参数，此时它会返回该数字对应的阶乘。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>C:\Users\john\Documents<span style="color:#f92672">&gt;</span>python fact<span style="color:#f92672">.</span>py <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">720</span>
</span></span></code></pre></div><h3 id="多次导入一个模块">多次导入一个模块<a href="#%e5%a4%9a%e6%ac%a1%e5%af%bc%e5%85%a5%e4%b8%80%e4%b8%aa%e6%a8%a1%e5%9d%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>你可以在一个脚本中写多次<code>import mod</code>，但是只有第一个会被执行。假如你在这个模块中塞了<code>print()</code>语句，那么你也只会看到一条输出。</p>
<h2 id="python-packages">Python Packages<a href="#python-packages" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>如我们前文所言，module仅支持从同一目录中相互导入，这就导致你没办法只使用module来构建复杂的工程。你可能会希望有办法分组组织这些模块。</p>
<p>Packages的作用就是为module命名空间提供一个分层结构。你可以使用点标来访问对应的模块进而访问对应的内容。简单来说，Packages的作用就是把一堆命名空间统一在同一个命名空间之下。</p>
<p>创建package的方法非常直接，你只需要在一个解释器能找到的地方创建一个文件夹然后在里面塞点module或者package就行。</p>
<p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260207-2.png" alt=""></p>
<p>此时<code>pkg</code>就成了这两个模块的统一命名空间。对于一个和pkg同级的模块，你可以通过<code>import pkg.test01</code>来导入test01模块，或者<code>from pkg.test01 import foo</code>来导入其中的类，或者<code>from .. import .. as ..</code>，总之module此时的身份就像是pkg的一个成员。</p>
<p>不过，虽然理论上你可以直接<code>import pkg</code>，但是这样做并没有把任何pkg下的模块导入本地命名空间。所以会出现以下问题：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> pkg<span style="color:#f92672">.</span>mod1
</span></span><span style="display:flex;"><span>Traceback (most recent call last):
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;&lt;pyshell#34&gt;&#34;</span>, line <span style="color:#ae81ff">1</span>, <span style="color:#f92672">in</span> <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    pkg<span style="color:#f92672">.</span>mod1
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AttributeError</span>: module <span style="color:#e6db74">&#39;pkg&#39;</span> has no attribute <span style="color:#e6db74">&#39;mod1&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> pkg<span style="color:#f92672">.</span>mod1<span style="color:#f92672">.</span>foo()
</span></span><span style="display:flex;"><span>Traceback (most recent call last):
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;&lt;pyshell#35&gt;&#34;</span>, line <span style="color:#ae81ff">1</span>, <span style="color:#f92672">in</span> <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    pkg<span style="color:#f92672">.</span>mod1<span style="color:#f92672">.</span>foo()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AttributeError</span>: module <span style="color:#e6db74">&#39;pkg&#39;</span> has no attribute <span style="color:#e6db74">&#39;mod1&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> pkg<span style="color:#f92672">.</span>mod2<span style="color:#f92672">.</span>Bar()
</span></span><span style="display:flex;"><span>Traceback (most recent call last):
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;&lt;pyshell#36&gt;&#34;</span>, line <span style="color:#ae81ff">1</span>, <span style="color:#f92672">in</span> <span style="color:#f92672">&lt;</span>module<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    pkg<span style="color:#f92672">.</span>mod2<span style="color:#f92672">.</span>Bar()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AttributeError</span>: module <span style="color:#e6db74">&#39;pkg&#39;</span> has no attribute <span style="color:#e6db74">&#39;mod2&#39;</span>
</span></span></code></pre></div><h3 id="package初始化">Package初始化<a href="#package%e5%88%9d%e5%a7%8b%e5%8c%96" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>包目录下放一个<code>__init__.py</code>，其中的代码会在包或者包内模块被导入时先被执行。也就是说它可以用作包的初始化代码。</p>
<p>比如说，我们在pkg文件夹下再放入这样的<code>__init__.py</code>文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Invoking __init__.py for </span><span style="color:#e6db74">{</span>__name__<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>A <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;quux&#39;</span>, <span style="color:#e6db74">&#39;corge&#39;</span>, <span style="color:#e6db74">&#39;grault&#39;</span>]
</span></span></code></pre></div><p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260207-3.png" alt=""></p>
<p>此时我们就可以直接<code>import pkg</code>并调用<code>pkg.A</code>：</p>
<p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260207-5.png" alt=""></p>
<p><code>pkg.A</code>对于包内的模块来说此时就相当于一个全局变量。每一个包内的module都可以通过<code>from pkg import A</code>来访问这个变量。</p>
<p>除此之外，<code>__init__.py</code>还可以用来自动从包内导入模块。比如，我们前文中未设置<code>__init__.py</code>时直接<code>import pkg</code>仅仅代表将pkg这个名字纳入了当前字符表，其下的模块都没有成功导入。但是现在我们就可以在<code>__init__.py</code>中手动配置导包。</p>
<p>在<code>__init__.py</code>中写入以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Invoking __init__.py for </span><span style="color:#e6db74">{</span>__name__<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pkg.mod1<span style="color:#f92672">,</span> pkg.mod2
</span></span></code></pre></div><p>之后再<code>import pkg</code>，<code>pkg.mod1</code>和<code>pkg.mod2</code>就自动被导入了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> pkg
</span></span><span style="display:flex;"><span>Invoking <span style="color:#a6e22e">__init__</span><span style="color:#f92672">.</span>py <span style="color:#66d9ef">for</span> pkg
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> pkg<span style="color:#f92672">.</span>mod1<span style="color:#f92672">.</span>foo()
</span></span><span style="display:flex;"><span>[mod1] foo()
</span></span><span style="display:flex;"><span><span style="color:#f92672">&gt;&gt;&gt;</span> pkg<span style="color:#f92672">.</span>mod2<span style="color:#f92672">.</span>bar()
</span></span><span style="display:flex;"><span>[mod2] bar()
</span></span></code></pre></div><h3 id="import--from-a-package">import * from a package<a href="#import--from-a-package" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>你可以使用通配符一次性导入一个包中的“所有”模块，但是在默认情况下直接输入<code>from pkg import *</code>并不会发生任何事情。Python遵循以下规则：如果一个package中的<code>__init__.py</code>文件中定义了一个<code>__all__</code>列表，它就会被用作指定通配符导入模块时需要导入的模块名。</p>
<p>比如如果你在<code>__init__.py</code>中写入这些内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>__all__ <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;mod1&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;mod2&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;mod3&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;mod4&#39;</span>
</span></span><span style="display:flex;"><span>        ]
</span></span></code></pre></div><p>此时<code>from pkg import *</code>就会自动导入这四个module，假如事实上你的package中还有一个mod5.py，通配符导入时就会忽略这个模块。</p>
<p>事实上你同样可以在一个module中定义<code>__all__</code>，你可以在里面塞入本模块中的元素，当<code>from mod import *</code>时，实际导入的就只有<code>__all__</code>列表内的元素。</p>
<p>这样设计的考虑不难理解，程序构建时并不是所有函数都是直接可用的，很多函数的作用都是工具函数，使用<code>__all__</code>和<code>__init__.py</code>来控制导入内容可以让程序更易于维护且便于使用。</p>
<p>除此之外，包还可以嵌套，你可以在一个包里塞多个子包。在子包内，你可以使用“相对导入”，子包内<code>..</code>表示子包的父包，比如pkg中塞了一个<code>sub_pkg1</code>和<code>sub_pkg2</code>，<code>sub_pkg1</code>中的某个模块中<code>from .. import xx</code>就等效于<code>from pkg import xx</code>，<code>from ..sub_pkg2 import xx</code>就等效于从父包中导入另一个子包。</p>
<h1 id="os">OS<a href="#os" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>Python os库实际上是一个相当复杂的库，它提供了大量的方法用来管理文件、目录、输入输出、环境变量。</p>
<p>以下尝试罗列一些主要用法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cwd <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getcwd()
</span></span><span style="display:flex;"><span>print(cwd)
</span></span></code></pre></div><p><code>os.getcwd()</code>方法可以得到你运行脚本时你（而非这个python文件）所处的路径。精确到目录。</p>
<p>某次输出：</p>
<p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260211-1.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cwd <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getcwd()
</span></span><span style="display:flex;"><span>print(cwd)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HOME <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;HOME&#34;</span>]
</span></span><span style="display:flex;"><span>print(HOME)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;THIS_IS_A_VAR_SET_BY_PYTHON&#34;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;114514&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#34;echo $THIS_IS_A_VAR_SET_BY_PYTHON&#34;</span>)
</span></span></code></pre></div><p><code>os.environ</code>在官方说法中是一个“mapping”，即一个映射。但是它的行为似乎完全符合一个普通的python dict。你可以通过中括号查表获取对应的环境变量值，也可以用同样的方式添加新的环境变量，只不过这个环境变量只能作用于当前进程。</p>
<p>输出结果：</p>
<p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260211-2.png" alt=""></p>
<p>之后再尝试echo就不会有输出结果了。</p>
<p>出人意料的是，python os库中并没有将路径封装为类，而是直接使用原生的字符串。这意味着你实际上可以直接使用字符串拼接来表示路径，但是因为不同系统路径拼接符并不相同，一般来说出于可移植性的考虑，我们使用<code>python.path.join()</code>来自动获取适配当前环境的路径字符串。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cwd <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getcwd()
</span></span><span style="display:flex;"><span>print(cwd)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>HOME <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>environ[<span style="color:#e6db74">&#34;HOME&#34;</span>]
</span></span><span style="display:flex;"><span>print(HOME)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(HOME, <span style="color:#e6db74">&#34;python_projects&#34;</span>, <span style="color:#e6db74">&#34;AI-apps-dev&#34;</span>, <span style="color:#e6db74">&#34;lib_test&#34;</span>)
</span></span><span style="display:flex;"><span>print(type(path))
</span></span><span style="display:flex;"><span>print(path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(path <span style="color:#f92672">==</span> cwd)
</span></span></code></pre></div><p>输出结果：</p>
<p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260211-3.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cwd <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getcwd()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>basename(cwd))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(cwd))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>location <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(cwd, __file__)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>name <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>basename(location)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(location)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;I am &#34;</span> <span style="color:#f92672">+</span> name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;I am in &#34;</span><span style="color:#f92672">+</span>dir)
</span></span></code></pre></div><p><code>os.path.basename()</code>方法可以获取一个路径按分隔符划分得到的最后一个组成，<code>os.path.dirname()</code>方法则返回除了最后一个组成的所处路径。假如最后一个成分是目录，则返回其父目录。</p>
<p>结果如下：</p>
<p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260211-4.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>name, ext <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>splitext(<span style="color:#e6db74">&#34;a.b.c.d.e&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(name)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(ext)
</span></span></code></pre></div><p><code>os.path.splitext</code>可以用来获取文件名与拓展名。拓展名的定义方式是由<code>.</code>分隔得到的最后一部分。</p>
<p>输出结果：</p>
<p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260211-5.png" alt=""></p>
<p>由于os库的内容实在太多，接下来只简单罗列一些写法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(path)
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isdir(path)
</span></span></code></pre></div><p>判断路径表示的是一个文件还是一个目录。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>os<span style="color:#f92672">.</span>mkdir(<span style="color:#e6db74">&#34;data&#34;</span>)
</span></span></code></pre></div><p>在<code>os.getcwd()</code>得到的路径下创建一个data目录。</p>
<p>os库中直接写文件或目录名，默认表示在当前工作目录操作，实际上仍然表示的是路径。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>os<span style="color:#f92672">.</span>makedirs(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;a&#39;</span>,<span style="color:#e6db74">&#39;b&#39;</span>,<span style="color:#e6db74">&#39;c&#39;</span>), exist_ok<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p>创建一系列目录，行为类似<code>mkdir -p</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(path)
</span></span></code></pre></div><p>判断一个路径是否存在。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>os<span style="color:#f92672">.</span>remove(<span style="color:#e6db74">&#34;file.txt&#34;</span>)   
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>rmdir(<span style="color:#e6db74">&#34;folder&#34;</span>)      
</span></span></code></pre></div><p>删除文件和空目录。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> shutil
</span></span><span style="display:flex;"><span>shutil<span style="color:#f92672">.</span>rmtree(<span style="color:#e6db74">&#34;folder&#34;</span>)
</span></span></code></pre></div><p>删除非空目录。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>os<span style="color:#f92672">.</span>rename(<span style="color:#e6db74">&#34;old.txt&#34;</span>, <span style="color:#e6db74">&#34;new.txt&#34;</span>)
</span></span></code></pre></div><p>重命名，实际上行为和<code>mv</code>一致，你也可以用它来移动文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>files <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>listdir(<span style="color:#e6db74">&#34;data&#34;</span>)
</span></span></code></pre></div><p>罗列目录下的文件，得到一个python列表。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>os<span style="color:#f92672">.</span>system(<span style="color:#e6db74">&#34;ls&#34;</span>)
</span></span></code></pre></div><p>执行系统指令。（自用程序狂喜）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>base_dir <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>dirname(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>abspath(__file__))
</span></span></code></pre></div><p>获取脚本所在目录，用来定位资源位置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>os<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><p>结束程序。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>os<span style="color:#f92672">.</span>stat(<span style="color:#e6db74">&#34;file.txt&#34;</span>)
</span></span></code></pre></div><p>获取一个文件的信息，得到一个<code>os.stat_result</code>实例。你可以直接通过访问该实例的属性获取对应的信息。</p>
<p>值得注意的是，os库并没有提供一个方便的复制方法。此处罗列两个shutil库中的文件复制方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> shutil
</span></span><span style="display:flex;"><span>shutil<span style="color:#f92672">.</span>copy2(src, dst)
</span></span></code></pre></div><p>行为类似<code>cp</code>，可以复制时间戳。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>shutil<span style="color:#f92672">.</span>copytree(<span style="color:#e6db74">&#34;src_dir&#34;</span>, <span style="color:#e6db74">&#34;dst_dir&#34;</span>)
</span></span></code></pre></div><p>复制整个目录。</p>
<h1 id="json">Json<a href="#json" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>json库实际只负责在脚本内部将json string和python dict之间相互转换，并不负责读取的写入数据。所以此处我们补充一些文件读写的基本知识。</p>
<p>在python中读写文件使用的是python内置函数<code>open</code>。一般我们为将读写文件的代码写在<code>with</code>内，一旦程序异常崩溃，<code>with</code>会帮我们自动关闭文件。一般我们写open函数会传入三个参数：文件目录，读写模式，编码方式。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;os_test.py&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>, encoding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf-8&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    print(type(f))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> f:
</span></span><span style="display:flex;"><span>        print(type(line))
</span></span><span style="display:flex;"><span>        print(line<span style="color:#f92672">.</span>strip())
</span></span></code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">_io</span><span style="color:#f92672">.</span>TextIOWrapper<span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">str</span><span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;os_test.py&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>, encoding <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;utf-8&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">str</span><span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span>print(type(f))
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">str</span><span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> line <span style="color:#f92672">in</span> f:
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">str</span><span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span>print(type(line))
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">str</span><span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span>print(line<span style="color:#f92672">.</span>strip())
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">str</span><span style="color:#e6db74">&#39;&gt;</span>
</span></span></code></pre></div><p>open函数返回的是一个文件对象，这个文件对象的行为和迭代器非常类似，实际上你可以使用next来获取下一行元素，但是一般我们调用它的<code>readline()</code>方法来获取下一行的内容，<code>read()</code>方法来读取全部内容，以及<code>readlines</code>方法来获取所有行的内容并打包进一个list。</p>
<p>写入文件有两种选择，一种是使用<code>'w'</code>模式打开文件，但是会导致文件原有内容被清空。另一种是使用<code>'a'</code>模式追加写入。两种模式下都使用<code>write</code>函数写入内容，但是需要注意的是实际上所有文本文件的换行都是通过转义字符<code>'\n'</code>实现的，write函数并不负责另起一行，所以如果想写入多行内容，你需要手动添加<code>'\n'</code>。你也可以使用<code>writelines</code>方法从一个列表中自动读取并写入内容，但是同样需要补充<code>'\n'</code>。</p>
<p>回到json库，前文中我们提到json库并不负责读取数据。json库有四个最常用的方法：<code>json.loads()</code>，负责将json string转换为dict；<code>json.dumps()</code>，负责将python对象转换为json。除此之外<code>load()</code>和<code>dump()</code>分别负责处理读写文件。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span>  <span style="color:#e6db74">&#39;{ &#34;name&#34;:&#34;John&#34;, &#34;age&#34;:30, &#34;city&#34;:&#34;New York&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(x)
</span></span><span style="display:flex;"><span>print(type(y))
</span></span><span style="display:flex;"><span>print(y[<span style="color:#e6db74">&#34;age&#34;</span>])
</span></span></code></pre></div><p>输出结果：</p>
<p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260211-6.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;John&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;age&#34;</span>: <span style="color:#ae81ff">30</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;city&#34;</span>: <span style="color:#e6db74">&#34;New York&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>dumps(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(type(y))
</span></span><span style="display:flex;"><span>print(y)
</span></span></code></pre></div><p>输出结果：</p>
<p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260211-7.png" alt=""></p>
<p>但是实际上你不止可以把dict转化为json string，python中除了class外的对象基本都可以转换为json string。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json  
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>print(json<span style="color:#f92672">.</span>dumps({<span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;John&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span>: <span style="color:#ae81ff">30</span>}))  
</span></span><span style="display:flex;"><span>print(json<span style="color:#f92672">.</span>dumps([<span style="color:#e6db74">&#34;apple&#34;</span>, <span style="color:#e6db74">&#34;bananas&#34;</span>]))  
</span></span><span style="display:flex;"><span>print(json<span style="color:#f92672">.</span>dumps((<span style="color:#e6db74">&#34;apple&#34;</span>, <span style="color:#e6db74">&#34;bananas&#34;</span>)))  
</span></span><span style="display:flex;"><span>print(json<span style="color:#f92672">.</span>dumps(<span style="color:#e6db74">&#34;hello&#34;</span>))  
</span></span><span style="display:flex;"><span>print(json<span style="color:#f92672">.</span>dumps(<span style="color:#ae81ff">42</span>))  
</span></span><span style="display:flex;"><span>print(json<span style="color:#f92672">.</span>dumps(<span style="color:#ae81ff">31.76</span>))  
</span></span><span style="display:flex;"><span>print(json<span style="color:#f92672">.</span>dumps(<span style="color:#66d9ef">True</span>))  
</span></span><span style="display:flex;"><span>print(json<span style="color:#f92672">.</span>dumps(<span style="color:#66d9ef">False</span>))  
</span></span><span style="display:flex;"><span>print(json<span style="color:#f92672">.</span>dumps(<span style="color:#66d9ef">None</span>))
</span></span></code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;John&#34;</span>, <span style="color:#f92672">&#34;age&#34;</span>: <span style="color:#ae81ff">30</span>}
</span></span><span style="display:flex;"><span>[<span style="color:#e6db74">&#34;apple&#34;</span>, <span style="color:#e6db74">&#34;bananas&#34;</span>]
</span></span><span style="display:flex;"><span>[<span style="color:#e6db74">&#34;apple&#34;</span>, <span style="color:#e6db74">&#34;bananas&#34;</span>]
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hello&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">31.76</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">null</span>
</span></span></code></pre></div><p>一些读写json文件的示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;Tom&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span>: <span style="color:#ae81ff">20</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;data.json&#34;</span>, <span style="color:#e6db74">&#34;w&#34;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    json<span style="color:#f92672">.</span>dump(data, f, indent<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>)
</span></span></code></pre></div><p>写入json文件同时添加4格缩进。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;data.json&#34;</span>, <span style="color:#e6db74">&#34;r&#34;</span>, encoding<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;utf-8&#34;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>load(f)
</span></span></code></pre></div><p>读取json。</p>
<h1 id="typer">Typer<a href="#typer" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>终于可以讲python的实用库了。然而不得不说很多库的注释写的一言难尽，要是所有python库的注释都写的和torch一样详细就好了。</p>
<p>typer可以看做是click库的现代版封装，后者是一个经典的python cli工具开发库，但是其语法相对繁琐，使用了大量的装饰器语法。相较而言，typer的语法更贴近python原生体验一些，上手难度更低。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> typer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(name: str):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Hello </span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>typer<span style="color:#f92672">.</span>run(main)
</span></span></code></pre></div><p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260207-6.png" alt=""></p>
<p>你可以用<code>typer.run()</code>来运行一个函数，函数的参数会自动从命令行中接收。</p>
<p><code>typer.run()</code>的工作原理实质是临时创建了一个只包含一个指令的Typer实例，后续会讲到。</p>
<p>一个相对复杂的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> typer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>app <span style="color:#f92672">=</span> typer<span style="color:#f92672">.</span>Typer()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.command</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hello</span>(name: str):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Hello </span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@app.command</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">goodbye</span>(name: str, formal: bool <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> formal:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Goodbye Ms. </span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">. Have a good day.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Bye </span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">!&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    app()
</span></span></code></pre></div><p>此处使用了装饰器语法。<code>command()</code>是<code>Typer</code>类的一个方法，作用是将一个函数注册进本Typer。当一个Typer实例被调用时，它会先执行一个<code>get_command</code>方法，该方法会根据Typer实例子命令的情况返回一个<code>click.Command</code>示例，之后Typer示例调用的参数会被传入<code>click.Command</code>的<code>__call__</code>方法，指令得到执行。</p>
<p>运行效果：</p>
<p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260207-8.png" alt=""></p>
<p>写到这里快速上手部分就结束了，这里我真的不得不再次表扬一下<a href="https://typer.tiangolo.com/tutorial/">Typer tutorial</a>，这辈子没见过这么面向新手的文档。感觉自己在这里写typer的博客都多余（如果你不知道什么是装饰器，你甚至可以在这个文档里找到装饰器含义的解释）。此外，typer的语法基本就是顺着python原生语法设计的，比如&ndash;help显示的内容可以直接读取函数的docstring。可以说typer的实现方式非常的优雅。</p>
<h1 id="rich">Rich<a href="#rich" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>这是我最想掌握的库，没有人能拒绝亲自设计一套自己的终端ui。Rich库可以定制输出的风格、颜色，并用于显示一些高级内容如表格、markdown，以及语法高亮。</p>
<p>你可以输入以下指令来确认你的rich环境是否工作正常：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m rich
</span></span></code></pre></div><p>效果：</p>
<p><img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260211-8.png" alt="">
<img src="/zh-cn/posts/python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%80%E4%BA%9B%E5%BA%93/Python%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84&amp;%E4%B8%80%E4%BA%9B%E5%BA%93-20260211-10.png" alt=""></p>
<p>事实上，rich的很多模块支持你直接使用-m方式启动来运行它的demo。</p>
<p>rich能做的事情非常多，同时文档非常详细，复述一遍没有什么意义，此处我来罗列一下rich各个模块的大致用途。</p>
<ul>
<li><code>rich.console</code>
<ul>
<li>提供了一个<code>Console</code>类，本质上是在多变的终端环境上套了一个通用的终端渲染系统。</li>
<li>rich的终端渲染控制中心。</li>
<li>你可能会需要在程序中用一个专门的模块负责实例化一个<code>Console</code>。</li>
</ul>
</li>
<li>sytle
<ul>
<li>rich的很多输出方式允许你传入style参数来表示颜色以及一些加粗或者斜体这样的特殊属性。</li>
<li><a href="https://rich.readthedocs.io/en/latest/appendix/colors.html#appendix-colors">你可以在这里找到支持的颜色</a></li>
<li><code>rich.style</code>提供了一个<code>Style</code>类，你可以传参时直接传入一个定制好的<code>Style</code>实例来表示风格。</li>
<li><code>rich.theme</code>提供了一个<code>Theme</code>类，一个Theme实例包含了各种情况下style的别名映射。比如你可以给某个style起个别名&quot;info&quot;，这样在这个theme下你就可以直接传入info来表示该风格。</li>
</ul>
</li>
<li><code>rich.markup</code>
<ul>
<li><code>python -m rich.markup</code>来测试markup功能。</li>
<li>你可以在输出中简单的添加一些标记来为文本添加颜色和风格，而不需要传入style参数或者Style实例。</li>
</ul>
</li>
<li><code>rich.text</code>
<ul>
<li><code>python -m rich.text</code>来测试其功能。</li>
<li>提供了一个<code>Text</code>类，可以用来直接取代任何原本接收字符串的参数，同时提供了一些属性用来设定文本显示的行为，比如居中还是靠左靠右。</li>
</ul>
</li>
<li>Highlighting
<ul>
<li>rich会自动高亮一些特殊部分。</li>
<li><code>rich.highlighter</code>提供了一些类来自定义高亮规则和颜色。（你可以用这种方式打印彩虹文本）</li>
</ul>
</li>
<li><code>rich.pretty</code>
<ul>
<li>提供了一些工具来更美观的打印一些python对象。</li>
</ul>
</li>
<li><code>rich.logging</code>
<ul>
<li>提供了高度可定制的日志系统。</li>
</ul>
</li>
<li><code>rich.traceback</code>
<ul>
<li><code>python -m rich.traceback</code>测试功能。</li>
<li>对代码报错提供了语法高亮和格式支持。（太全面了）</li>
</ul>
</li>
<li><code>rich.prompt</code>
<ul>
<li><code>python -m rich.prompt</code>测试功能。</li>
<li>可以用更优雅的方式实现和用户的交互。</li>
</ul>
</li>
<li><code>rich.columns</code>
<ul>
<li><code>python -m rich.columns</code>测试功能</li>
<li>按照整齐的列来显示文本或者其他可渲染对象。</li>
</ul>
</li>
<li>Render Groups
<ul>
<li><code>rich.console</code>中提供了Group类，可以把多个可渲染对象打包起来塞进只接受一个可渲染对象的参数中。</li>
</ul>
</li>
<li><code>rich.markdown</code>
<ul>
<li>提供了一个<code>Markdown</code>类，可以将markdown格式的字符串转换为可渲染对象。</li>
</ul>
</li>
<li><code>rich.padding</code>
<ul>
<li>提供了一个<code>Padding</code>类，可以用来给其他的可渲染对象添加空白的周围填充。</li>
</ul>
</li>
<li><code>rich.panel</code>
<ul>
<li>提供了一个<code>Panel</code>类用来绘制仪表盘。</li>
</ul>
</li>
<li><code>rich.progress</code>
<ul>
<li>提供了一些方法绘制进度条。</li>
</ul>
</li>
<li><code>rich.syntax</code>
<ul>
<li>提供了代码高亮。</li>
</ul>
</li>
<li><code>rich.table</code>
<ul>
<li>提供了一些方法绘制表格。</li>
</ul>
</li>
<li><code>rich.tree</code>
<ul>
<li><code>python -m rich.tree</code>测试功能。</li>
<li>用来绘制树形图。</li>
</ul>
</li>
<li><code>rich.live</code>
<ul>
<li><code>python -m rich.live</code>测试功能。</li>
<li>用来实时绘制一些动画。（比如进度条）</li>
</ul>
</li>
<li><code>rich.layout</code>
<ul>
<li><code>python -m rich.layout</code>测试功能。</li>
<li>用来对屏幕进行分区，定制界面布局。</li>
</ul>
</li>
<li>Console Protocol
<ul>
<li>用来定制自定义类的print()输出样式。</li>
</ul>
</li>
</ul>
<p><a href="https://rich.readthedocs.io/en/latest/index.html">rich doc</a></p>
<h1 id="tenacity">Tenacity<a href="#tenacity" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>提供了各种各样的方法应对原本会raise error的地方，比如多次尝试，或者等待响应。只需要添加一些装饰器就可以工作。</p>
<p>懒得写了，具体的食用方法看官方文档。</p>
<h1 id="requests">Requests<a href="#requests" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>这才是本篇的重头戏。前面的第三方库大多处理cli的前端，而requests则是用来处理网络请求。几乎所有的线上api服务都必须要通过网络请求实现。就我们的主要目的来说，调用ai api除了发送网络请求外别无他法。</p>
<p>需要声明的是，本人没有系统学习过计算机网络，很可能出现专业术语的使用或者解读错误，请注意甄别。</p>
<h2 id="前置知识">前置知识<a href="#%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>在开始使用requests之前，我们有必要了解HTTP的概念。HTTP，<strong>HyperText Transfer Protocol</strong>，即所谓超文本传输协议，它的功能其实很简单：在服务器与客户端之间建立了一个沟通的规范。协议就像一种语言，只有当服务器和客户端都说同一种语言时两者才能相互理解。</p>
<p>HTTP的交互本质上很简单，本质上一次完整的HTTP沟通只分为两步：客户端发送请求，服务器给出响应。客户端发出的请求称为<em>http request</em>，服务器发出的响应称为<em>http response</em>。而request和response分别遵守一定的格式。</p>
<p>首先，对于request来说，一个完整的http request由四部分组成：</p>
<ul>
<li>URL，即<strong>统一资源定位符</strong>，是每个网络资源自身特有的人类可理解的网络地址。具体表现其实就是网址。</li>
<li>Method，请求方式。常见的请求方式如下：
<ul>
<li>GET：给我看看。（直接获取信息）</li>
<li>POST：给你看看。（提交一些信息）</li>
<li>还有很多其他的请求，但是不那么常用。（主要怕说错）</li>
</ul>
</li>
<li>Header，请求头，声明自己的身份和索要的文件类型。</li>
<li>Body，请求体，用来上传一些具体的内容。</li>
</ul>
<p>对于一个http response来说，通常会有以下组成：</p>
<ul>
<li>状态码。比如404 not found。200则表示成功了。</li>
<li>Headers，响应头，一些备注信息。</li>
<li>Body，响应体，你真正想要的服务器返回信息。</li>
</ul>
<p>通常当我们使用浏览器的时候，浏览器就在不断地发送http（或者https）请求。当我们浏览网页的时候，对应的服务器会返回HTML，浏览器进一步将HTML渲染成人类可以观看的网页。而对于api调用，服务器返回的则是纯文本文件json。我们可以轻易地在python中读取json文件的信息。</p>
<h2 id="一些尝试">一些尝试<a href="#%e4%b8%80%e4%ba%9b%e5%b0%9d%e8%af%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>requests库的用法实际上相当符合直觉。比如，请求方法看起来很像一个动词，所以requests库中请求方法的存在形式为函数，而url、header、body均作为参数传入函数。</p>
<p>简单的get方法尝试：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> rich.pretty <span style="color:#f92672">import</span> pprint
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://api.github.com/users/python&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(type(response))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;status: </span><span style="color:#e6db74">{</span>response<span style="color:#f92672">.</span>status_code<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>:
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>    pprint(data)
</span></span></code></pre></div><p>(rich现学现卖..)</p>
<p>输出结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">requests</span><span style="color:#f92672">.</span>models<span style="color:#f92672">.</span>Response<span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span>status: <span style="color:#ae81ff">200</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;login&#39;</span>: <span style="color:#e6db74">&#39;python&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;id&#39;</span>: <span style="color:#ae81ff">1525981</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;node_id&#39;</span>: <span style="color:#e6db74">&#39;MDEyOk9yZ2FuaXphdGlvbjE1MjU5ODE=&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;avatar_url&#39;</span>: <span style="color:#e6db74">&#39;https://avatars.githubusercontent.com/u/1525981?v=4&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;gravatar_id&#39;</span>: <span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;url&#39;</span>: <span style="color:#e6db74">&#39;https://api.github.com/users/python&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;html_url&#39;</span>: <span style="color:#e6db74">&#39;https://github.com/python&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;followers_url&#39;</span>: <span style="color:#e6db74">&#39;https://api.github.com/users/python/followers&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;following_url&#39;</span>: <span style="color:#e6db74">&#39;https://api.github.com/users/python/following{/other_user}&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;gists_url&#39;</span>: <span style="color:#e6db74">&#39;https://api.github.com/users/python/gists{/gist_id}&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;starred_url&#39;</span>: <span style="color:#e6db74">&#39;https://api.github.com/users/python/starred{/owner}{/repo}&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;subscriptions_url&#39;</span>: <span style="color:#e6db74">&#39;https://api.github.com/users/python/subscriptions&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;organizations_url&#39;</span>: <span style="color:#e6db74">&#39;https://api.github.com/users/python/orgs&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;repos_url&#39;</span>: <span style="color:#e6db74">&#39;https://api.github.com/users/python/repos&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;events_url&#39;</span>: <span style="color:#e6db74">&#39;https://api.github.com/users/python/events{/privacy}&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;received_events_url&#39;</span>: <span style="color:#e6db74">&#39;https://api.github.com/users/python/received_events&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;type&#39;</span>: <span style="color:#e6db74">&#39;Organization&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;user_view_type&#39;</span>: <span style="color:#e6db74">&#39;public&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;site_admin&#39;</span>: <span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Python&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;company&#39;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;blog&#39;</span>: <span style="color:#e6db74">&#39;https://www.python.org/&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;location&#39;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;email&#39;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;hireable&#39;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;bio&#39;</span>: <span style="color:#e6db74">&#39;Repositories related to the Python Programming language&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;twitter_username&#39;</span>: <span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;public_repos&#39;</span>: <span style="color:#ae81ff">90</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;public_gists&#39;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;followers&#39;</span>: <span style="color:#ae81ff">29714</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;following&#39;</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;created_at&#39;</span>: <span style="color:#e6db74">&#39;2012-03-11T15:56:37Z&#39;</span>,
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#e6db74">&#39;updated_at&#39;</span>: <span style="color:#e6db74">&#39;2026-02-09T14:43:33Z&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>requests库内置了json解码方法，<code>.json()</code>会将一个<code>requests.models.Response</code>实例的响应体部分由json转换为python dict并返回。所以我们在上述data中看不到状态码和响应头。</p>
<p>Github api可以用来查看仓库信息、用户信息，获取热门仓库，和方便进行自动化开发。</p>
<p>使用post方法的尝试：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> rich.pretty <span style="color:#f92672">import</span> pprint
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://httpbin.org/post&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>my_data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;Moonhalf&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;age&#34;</span>:<span style="color:#ae81ff">114514</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;message&#34;</span>:<span style="color:#e6db74">&#34;Hello world!&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url, data<span style="color:#f92672">=</span>my_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(type(response))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;status: </span><span style="color:#e6db74">{</span>response<span style="color:#f92672">.</span>status_code<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>:
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>json()
</span></span><span style="display:flex;"><span>    pprint(data)
</span></span></code></pre></div><p><code>httpbin.org</code>是一个专门用来测试http请求的网站。</p>
<p>对于llm api的调用本质上也就是发送http请求，文档中一般会给出调用api所需要的header、url以及body的具体格式。</p>
]]></content>
		</item>
		
		<item>
			<title>19岁生日随想</title>
			<link>http://localhost:1313/zh-cn/posts/19%E5%B2%81%E7%94%9F%E6%97%A5%E9%9A%8F%E6%83%B3/</link>
			<pubDate>Sun, 08 Feb 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/19%E5%B2%81%E7%94%9F%E6%97%A5%E9%9A%8F%E6%83%B3/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p><img src="/zh-cn/posts/19%E5%B2%81%E7%94%9F%E6%97%A5%E9%9A%8F%E6%83%B3/19%E5%B2%81%E7%94%9F%E6%97%A5%E9%9A%8F%E6%83%B3-20260208-1.png" alt=""></p>
<p>新的一岁了，祝看到本文的各位新的一年心想事成。</p>
<p>（春节序曲温馨的小曲：噔噔噔噔噔噔噔噔噔噔，噔噔噔噔噔噔噔噔噔噔噔，..）</p>
<blockquote>
<p>亲里的听众朋友们，大家好！这里是 [电台名称]，我是你们的老朋友 [播音员名字]。</p>
</blockquote>
<blockquote>
<p>听，那是远方传来的蹄声，清脆而有力，踏着春天的节拍，正向我们奔袭而来。在这万象更新的美好时刻，我们挥别了难忘的旧岁，正式跨入了朝气蓬勃的——甲午（或对应年份）马年。</p>
</blockquote>
<blockquote>
<p>马，在我们的文化里，从来都象征着奔腾不息、勇往直前。它不仅是速度的化身，更是奋斗精神的图腾。</p>
</blockquote>
<blockquote>
<p>此时此刻，无论您是正穿梭在繁华都市的街道，还是正守在温暖的灯火旁与家人团聚，我都希望通过这电波，将这份如骏马般炽热的祝福送到您的耳畔：</p>
</blockquote>
<blockquote>
<p>愿您在新的一年里，拥有“龙马精神”。像奔驰的骏马一样，永远满怀热忱，永远不知疲倦，在人生的赛道上，跑出属于自己的精彩姿态。</p>
</blockquote>
<blockquote>
<p>愿您在事业与学业中，“马到成功”。每一个目标都能如愿以偿，每一次出发都能凯旋而归。那些曾经挥洒过的汗水，终将化作脚下驰骋的坦途。</p>
</blockquote>
<blockquote>
<p>愿您的生活“一马当先”。在寻找幸福的道路上，总能领略到最美的风景，在平凡的日子里，活出不平凡的气象。</p>
</blockquote>
<p>（稍微停顿，语速放缓，更显温情）</p>
<blockquote>
<p>山遥水远，挡不住奔跑的脚步；岁月更迭，磨不灭心中的梦想。马年到了，愿我们都能像矫健的骏马，不畏艰险，纵情驰骋，去追逐那一抹最灿烂的晨曦。</p>
</blockquote>
<blockquote>
<p>感谢您在这一刻的守候。我是 [播音员名字]，在 [电台名称] 衷心祝愿大家：马年大吉，万事胜意，前程似锦！</p>
</blockquote>
<p>（背景音乐起，音量推大，持续几秒后淡出）</p>
<hr>
<h1 id="新的一年">新的一年！<a href="#%e6%96%b0%e7%9a%84%e4%b8%80%e5%b9%b4" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>愿望单：</p>
<ul>
<li>希望MC模组开发填坑
<ul>
<li>坑挖了很久但是一直没填，原因是我一直不想打开电脑（电脑太重了不方便随身携带），但是mc模组开发只能在电脑上完成。（neovim光是准备java开发环境就已经很痛苦了）</li>
</ul>
</li>
<li>希望学点Godot
<ul>
<li>挖坑没填理由同上。</li>
</ul>
</li>
<li>希望有人帮我清空steam愿望单
<ul>
<li>虽然实际上自己很少有时间玩steam。</li>
</ul>
</li>
<li>希望有人帮我清空购物车
<ul>
<li>我有一堆想要的电子产品和杂七杂八的东西。</li>
</ul>
</li>
<li>希望有人送我一个100年之内可以稳定工作的16核64G1KM带宽最好再有个强劲GPU的海外某个政局稳定国家的1000米地下室中24小时全天候专人维护的服务器
<ul>
<li>经典做梦环节</li>
</ul>
</li>
<li>希望有喝不完的咖啡
<ul>
<li>如果能把咖啡预算的1/10拿出来租云服务器可能就没有那么多网络配置问题了，然而不可能。</li>
</ul>
</li>
<li>希望能研究明白摩卡壶到底怎么用
<ul>
<li>第一次用就烧糊了。</li>
</ul>
</li>
<li>希望学点画画
<ul>
<li>选了素描基础的通识课，说起来对画画也挺感兴趣的，但是一直都没正经学过。</li>
</ul>
</li>
<li>希望再种点东西
<ul>
<li>水仙提回家路上快死了个屁了。</li>
</ul>
</li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>D2L自学日志03：线性神经网络完结</title>
			<link>http://localhost:1313/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/</link>
			<pubDate>Wed, 04 Feb 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>忙了大半个月考试，今天终于要回归主线了。考完试的这几天大概做了一些准备工作，试了下vivopencil，感觉效果不尽如人意，又退货了。前天尝试配了zerotier虚拟组网，效果还行，本来也想发篇博客（因为配置的过程中也在记录），但是感觉写的太水了，可能之后考虑搭建moon节点的时候会完善一下发出来。</p>
<p>因为本科导师下了kpi一个寒假推完d2l，动用了简单的小学数学知识，我惊讶地发现如果我要一个寒假学完D2L，我可能每2～3天就必须推完一章。这下不得不开工了。</p>
<h2 id="线性神经网络回顾">线性神经网络回顾<a href="#%e7%ba%bf%e6%80%a7%e7%a5%9e%e7%bb%8f%e7%bd%91%e7%bb%9c%e5%9b%9e%e9%a1%be" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>从零开始的线性神经网络实现：</p>
<ol>
<li>生成数据集；
<ol>
<li>两个特征，三个参数</li>
<li>生成若干个随机的符合正态分布的特征，算出严格符合指定参数的预测值，再加上一个随机数得到标签。</li>
</ol>
</li>
<li>读取数据集
<ol>
<li>打乱索引列表，实现不重不漏的随机读取。</li>
<li>使用生成器语法。</li>
</ol>
</li>
<li>初始化模型参数</li>
<li>定义模型</li>
<li>定义损失函数</li>
<li>定义优化算法</li>
<li>训练</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">synthetic_data</span>(w, b, num_examples):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 生成一个长为num_examples，宽为w长度的随机张量，其中的数值分布符合正态分布。</span>
</span></span><span style="display:flex;"><span>    X <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, (num_examples, len(w)))
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>matmul(X, w) <span style="color:#f92672">+</span> b
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">+=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, y<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> X, y<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>true_w <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3.4</span>])
</span></span><span style="display:flex;"><span>true_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4.2</span>
</span></span><span style="display:flex;"><span>features, labels <span style="color:#f92672">=</span> synthetic_data(true_w, true_b, <span style="color:#ae81ff">1000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">data_iter</span>(batch_size, features, labels):
</span></span><span style="display:flex;"><span>    num_examples <span style="color:#f92672">=</span> len(labels)
</span></span><span style="display:flex;"><span>    indices <span style="color:#f92672">=</span> list(range(num_examples))
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>shuffle(indices)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, num_examples, batch_size):
</span></span><span style="display:flex;"><span>        batch_indices <span style="color:#f92672">=</span> indices[i : min(i <span style="color:#f92672">+</span> batch_size, num_examples)]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">yield</span> features[batch_indices], labels[batch_indices]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>w <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>b <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(<span style="color:#ae81ff">1</span>, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">linreg</span>(X, w, b):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>matmul(X, w) <span style="color:#f92672">+</span> b
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">squared_loss</span>(y_hat, y):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (y_hat <span style="color:#f92672">-</span> y) <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sgd</span>(params, lr, batch_size):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> param <span style="color:#f92672">in</span> params:
</span></span><span style="display:flex;"><span>            param <span style="color:#f92672">-=</span> lr <span style="color:#f92672">*</span> param<span style="color:#f92672">.</span>grad <span style="color:#f92672">/</span> batch_size
</span></span><span style="display:flex;"><span>            param<span style="color:#f92672">.</span>grad<span style="color:#f92672">.</span>zero_()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.03</span>
</span></span><span style="display:flex;"><span>num_epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>net <span style="color:#f92672">=</span> linreg
</span></span><span style="display:flex;"><span>loss <span style="color:#f92672">=</span> squared_loss
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> data_iter(BATCH_SIZE, features, labels):
</span></span><span style="display:flex;"><span>        l <span style="color:#f92672">=</span> loss(net(X, w, b), y)
</span></span><span style="display:flex;"><span>        l<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>        sgd([w, b], lr, BATCH_SIZE)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        train_l <span style="color:#f92672">=</span> loss(net(features, w, b), labels)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;epoch:</span><span style="color:#e6db74">{</span>epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, loss:</span><span style="color:#e6db74">{</span>float(train_l<span style="color:#f92672">.</span>mean())<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;w误差：</span><span style="color:#e6db74">{</span>true_w <span style="color:#f92672">-</span> w<span style="color:#f92672">.</span>reshape(true_w<span style="color:#f92672">.</span>shape)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;b误差：</span><span style="color:#e6db74">{</span>true_b <span style="color:#f92672">-</span> b<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p><em>重新照着答案敲了一遍，毕竟一个月没写了。</em></p>
<p>对于一个简单的线性神经网络，首先我们可以先来明确它的模型：$X \cdot w + b$。明确了模型，其实具体的实现方法是大同小异的。我们需要定义什么样的预测结果是好的，什么样的是不好的，此处我们的选择是以预测值和真实值的差的平方作为误差，误差越大模型预测的效果越不好。每个参数在当前的数值下对于这个预测的误差有着不同的贡献值（即误差对参数的梯度），贡献值越大，我们就朝着相反的方向对这个参数调整越多。最后，我们可以得到一个误差相当小的参数组合。</p>
<p>其中，学习速率lr以及迭代周期数都属于所谓的<strong>超参数</strong>，和$w,b$不同，它们决定的是训练的效果，无法通过训练得到最优数值。</p>
<p>但是，假如我们要做的不再是这样的简单的线性模型，而是更加复杂的模型，我们会发现其实很多部分的实现实际上是重复性工作，比如我们将误差描述为差的绝对值的平方，这样的描述实际上相当普遍，对于很多模型我们都可以用这个方法去描述误差；再比如我们所写的<code>for epoch in range(num_epoches):</code>循环，其实即使我们去替换其中的优化函数、误差函数，这个训练过程照样可以完成。所以，为什么不把这些重复性较高的框架封装起来呢？</p>
<h2 id="读取数据">读取数据<a href="#%e8%af%bb%e5%8f%96%e6%95%b0%e6%8d%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.utils <span style="color:#f92672">import</span> data
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random 
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>true_w <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3.4</span>])
</span></span><span style="display:flex;"><span>true_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4.2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>features, labels <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>synthetic_data(true_w, true_b, <span style="color:#ae81ff">1000</span>)
</span></span></code></pre></div><p>依然先生成数据集。（这里直接使用了d2l保存的上一次定义的synthetic_data函数）</p>
<p>对于读取数据，我们可以直接使用<code>torch.utils</code>中提供的接口。</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703-20260126-1.png" alt=""></p>
<p><code>torch.utils.data</code>中提供了一个<code>TensorDataset</code>类，作用是将若干个张量绑定为一个数据集，前提是这几个张量的第一维大小一致。</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703-20260126-2.png" alt=""></p>
<p><code>DataLoader</code>类，顾名思义是一个“数据加载器”，是数据集和采样器的结合。一个DataLoader和迭代器的行为类似，每次调用都会吐出一批数据。</p>
<p>我们最终可以得到这样的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_array</span>(data_array, batch_size, is_train<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>    dataset <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>TensorDataset(<span style="color:#f92672">*</span>data_array)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> data<span style="color:#f92672">.</span>DataLoader(dataset, batch_size, is_train)
</span></span><span style="display:flex;"><span>batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>data_iter <span style="color:#f92672">=</span> load_array((features, labels), batch_size)
</span></span></code></pre></div><p>这段代码的功能和我们开始的<code>data_iter</code>函数的功能完全一致，只不过没有使用python原本的生成器语法。当然，尽管DataLoader的行为和python原生iter类似，如果我们想要直接使用的话还是需要<code>iter(load_array(...))</code>来转换一下。</p>
<p>我们随便打印一个看看：</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703-20260126-3.png" alt=""></p>
<p>符合预期，第一个tensor是特征，有两个特征；第二个tensor是标签。</p>
<h2 id="定义模型">定义模型<a href="#%e5%ae%9a%e4%b9%89%e6%a8%a1%e5%9e%8b" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># nn是神经网络的缩写</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>net <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>))
</span></span></code></pre></div><p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703-20260126-4.png" alt=""></p>
<p><code>Sequential</code>类，顺序的类。可以想见，每个模型的计算都免不了挨个进行一个个的计算步骤，Sequential描述的就是这样的过程。一个<code>Sequential</code>的实例就是一个神经网络net。Sequential会自动为我们把这些net串联起来，当我们把数据喂给第一层后，Sequential会自动把第一层的输出喂给第二层，以此类推。对于我们已经做成的“线性神经网络”，本质上是一个单层神经网络，没有所谓的顺序计算。但是在可以预见的未来，大多数模型都会使用多层的结构。这就像我们终于学会了1+1，现在我们要学1+1+1。这里的所谓的“层”，我个人觉得本质就是某种映射，将输出映射到结果的过程。</p>
<p>在我们的线性层中，每一个输出经过了这个层的计算后都会有一个输出与之对应（如果不知道为什么建议重修线性代数），因此我们称这样的一个层为<em>全连接层</em>。</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703-20260126-5.png" alt=""></p>
<p><code>nn.Linear</code>类定义了一个线性变换。在<code>net = nn.Sequential(nn.Linear(2, 1))</code>中，第一个参数<code>2</code>表示的是输入特征的形状，我们此处定义了两个特征，所以为2；第二个参数<code>1</code>表示输出特征形状，输出特征形状为单个标量，所以填1。</p>
<p>定义了net之后，net本身就成为了一个映射。我们可以用<code>net(X)</code>由特征X得到一个预测的结果。</p>
<h2 id="初始化模型参数">初始化模型参数<a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e6%a8%a1%e5%9e%8b%e5%8f%82%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>weight<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>normal_(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>bias<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>fill_(<span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><p><code>net</code>是一个<code>nn.Sequential</code>实例，对<code>net</code>做下标索引得到的是<code>nn.Module</code>，也就是所有的“层”的基类。而weight和bias是<code>nn.Linear</code>的特有的attribute。因为我们现在确定了<code>net[0]</code>就是一个nn.Linear层，所以我们这样写程序是可以正常工作的。然而pyright（你可能在使用的静态语法检测器）看不出来这里实际上没有问题，它会给你的程序标上语法错误。</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703-20260127-1.png" alt=""></p>
<p>解决方法是无视即可。程序仍然可以正常运行。</p>
<h2 id="定义损失函数">定义损失函数<a href="#%e5%ae%9a%e4%b9%89%e6%8d%9f%e5%a4%b1%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>loss <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>MSELoss()
</span></span></code></pre></div><p>计算均方误差使用<code>MSEloss</code>类，也称平方L2范数，默认情况下返回所有样本损失的均值。后续使用中可以通过<code>loss(net(X), y)</code>来计算误差。</p>
<h2 id="定义优化算法">定义优化算法<a href="#%e5%ae%9a%e4%b9%89%e4%bc%98%e5%8c%96%e7%ae%97%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>trainer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD(net<span style="color:#f92672">.</span>parameters(),lr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.03</span>)
</span></span></code></pre></div><p>训练器是参数和超参数以及训练算法的整合。在计算得到的损失backward之后，我们无需自己手写小批量随机梯度下降，直接调用trainer的<code>step()</code>方法即可实现。</p>
<h2 id="训练">训练<a href="#%e8%ae%ad%e7%bb%83" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>num_epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> data_iter:
</span></span><span style="display:flex;"><span>        l <span style="color:#f92672">=</span> loss(net(X), y)
</span></span><span style="display:flex;"><span>        trainer<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>        l<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>        trainer<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>    l <span style="color:#f92672">=</span> loss(net(features), labels)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;epoch: </span><span style="color:#e6db74">{</span>epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, loss: </span><span style="color:#e6db74">{</span>l<span style="color:#e6db74">:</span><span style="color:#e6db74">f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>我们原本更加繁琐的实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> data_iter(BATCH_SIZE, features, labels):
</span></span><span style="display:flex;"><span>        l <span style="color:#f92672">=</span> loss(net(X, w, b), y)
</span></span><span style="display:flex;"><span>        l<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>        sgd([w, b], lr, BATCH_SIZE)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        train_l <span style="color:#f92672">=</span> loss(net(features, w, b), labels)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;epoch:</span><span style="color:#e6db74">{</span>epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, loss:</span><span style="color:#e6db74">{</span>float(train_l<span style="color:#f92672">.</span>mean())<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><h2 id="完整代码">完整代码：<a href="#%e5%ae%8c%e6%95%b4%e4%bb%a3%e7%a0%81" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.utils <span style="color:#f92672">import</span> data
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>true_w <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3.4</span>])
</span></span><span style="display:flex;"><span>true_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4.2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>features, labels <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>synthetic_data(true_w, true_b, <span style="color:#ae81ff">1000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_array</span>(data_array, batch_size, is_train<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>):
</span></span><span style="display:flex;"><span>    dataset <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>TensorDataset(<span style="color:#f92672">*</span>data_array)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> data<span style="color:#f92672">.</span>DataLoader(dataset, batch_size, is_train)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>data_iter <span style="color:#f92672">=</span> load_array((features, labels), batch_size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(next(iter(data_iter)))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>net <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>weight<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>normal_(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>bias<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>fill_(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loss <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>MSELoss()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>trainer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD(net<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.03</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num_epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> data_iter:
</span></span><span style="display:flex;"><span>        l <span style="color:#f92672">=</span> loss(net(X), y)
</span></span><span style="display:flex;"><span>        trainer<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>        l<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>        trainer<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>    l <span style="color:#f92672">=</span> loss(net(features), labels)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;epoch: </span><span style="color:#e6db74">{</span>epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, loss: </span><span style="color:#e6db74">{</span>l<span style="color:#e6db74">:</span><span style="color:#e6db74">f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>w <span style="color:#f92672">=</span> net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>weight<span style="color:#f92672">.</span>data
</span></span><span style="display:flex;"><span>b <span style="color:#f92672">=</span> net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>bias<span style="color:#f92672">.</span>data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;w loss:&#34;</span>, true_w <span style="color:#f92672">-</span> w<span style="color:#f92672">.</span>reshape(true_w<span style="color:#f92672">.</span>shape))
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;b loss:&#34;</span>, true_b <span style="color:#f92672">-</span> b)
</span></span></code></pre></div><p>输出结果:</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703-20260127-2.png" alt=""></p>
<h2 id="课后练习">课后练习<a href="#%e8%af%be%e5%90%8e%e7%bb%83%e4%b9%a0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="q1如果用小批量的总损失替代平均值应该如何修改学习率">Q1：如果用小批量的总损失替代平均值，应该如何修改学习率？<a href="#q1%e5%a6%82%e6%9e%9c%e7%94%a8%e5%b0%8f%e6%89%b9%e9%87%8f%e7%9a%84%e6%80%bb%e6%8d%9f%e5%a4%b1%e6%9b%bf%e4%bb%a3%e5%b9%b3%e5%9d%87%e5%80%bc%e5%ba%94%e8%af%a5%e5%a6%82%e4%bd%95%e4%bf%ae%e6%94%b9%e5%ad%a6%e4%b9%a0%e7%8e%87" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703-20260127-3.png" alt=""></p>
<p>reduce在这个语境下的意思是<strong>收敛</strong>。在这里，<code>nn.MSEloss</code>提供了一个可选的参数<code>reduction</code>表示的是这个损失函数最终收敛到一个值的方法。默认方法<code>mean</code>表示的是求损失的平均值。如果我们想用总损失代替这个平均值，我们就应该手动设置reduction = &lsquo;sum&rsquo;。</p>
<p>然而改成<code>reduction = sum</code>之后似乎结果的误差的数量级没有什么变化。可能题目的意思是怎样调整学习率可以使修改前后数学上等价。由于我们前面在<code>DataLoader</code>中设置了一个batch大小为10，所以此处若取误差总和，得到的误差大小会变为原来的10倍。如果我们希望得到和原本一致的训练效果，我们应该将学习率设置为原来的0.1倍，即0.003。</p>
<h3 id="q2查看深度学习框架它们提供了哪些损失函数和初始化方法">Q2：查看深度学习框架，它们提供了哪些损失函数和初始化方法？<a href="#q2%e6%9f%a5%e7%9c%8b%e6%b7%b1%e5%ba%a6%e5%ad%a6%e4%b9%a0%e6%a1%86%e6%9e%b6%e5%ae%83%e4%bb%ac%e6%8f%90%e4%be%9b%e4%ba%86%e5%93%aa%e4%ba%9b%e6%8d%9f%e5%a4%b1%e5%87%bd%e6%95%b0%e5%92%8c%e5%88%9d%e5%a7%8b%e5%8c%96%e6%96%b9%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><a href="https://docs.pytorch.org/docs/stable/index.html">Pytorch doc</a></p>
<p><a href="https://docs.pytorch.org/docs/stable/search.html?q=loss">LOSS</a></p>
<p>初始化方法不知道是什么意思，遂不找。</p>
<h4 id="huber-loss">Huber loss<a href="#huber-loss" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>huber loss定义为：
</p>
$$l(y,y') = \begin{cases}|y-y'| -\frac{\sigma}{2} & \text{ if } |y-y'| > \sigma \\ \frac{1}{2 \sigma} (y-y')^2 & \text{ 其它情况}\end{cases}$$<p>
简单来说，就是在误差较大的时候使用线性惩罚，误差较小的时候使用平方惩罚。事实上，误差的大小可以通过多种方式描述，而如何选取只取决于我们希望模型对于误差持什么样的态度。</p>
<p>在机器学习中，有这样的两种经典的误差定义方式，一种是MSE，计算的是误差的L2范数，另一种则是MAE，计算的是误差的L1范数。其中前者的优点是0点处可导，意味着优化过程相对稳定，但是缺点是对于异常值很敏感，容易被少数极端大小的数字打破平衡；后者的优点是对异常值不那么敏感，但缺点是0点处不可导，很容易在0点左右震荡。</p>
<p>总之，huber loss是二者的折衷方案。我们可以稍微修改一下我们原有的代码来实验一下huber和mse的训练效果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train_loss</span>(loss, num_epochs):
</span></span><span style="display:flex;"><span>    data_iter <span style="color:#f92672">=</span> load_array((features, labels), batch_size)
</span></span><span style="display:flex;"><span>    net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>weight<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>normal_(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>    net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>bias<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>fill_(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    trainer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD(net<span style="color:#f92672">.</span>parameters(), lr<span style="color:#f92672">=</span><span style="color:#ae81ff">0.03</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> data_iter:
</span></span><span style="display:flex;"><span>            l <span style="color:#f92672">=</span> loss(net(X), y)
</span></span><span style="display:flex;"><span>            trainer<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>            l<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>            trainer<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>        l <span style="color:#f92672">=</span> loss(net(features), labels)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># print(f&#34;epoch: {epoch + 1}, loss: {l:f}&#34;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    w <span style="color:#f92672">=</span> net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>weight<span style="color:#f92672">.</span>data
</span></span><span style="display:flex;"><span>    b <span style="color:#f92672">=</span> net[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>bias<span style="color:#f92672">.</span>data
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;w loss:&#34;</span>, true_w <span style="color:#f92672">-</span> w<span style="color:#f92672">.</span>reshape(true_w<span style="color:#f92672">.</span>shape))
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;b loss:&#34;</span>, true_b <span style="color:#f92672">-</span> b)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> true_w <span style="color:#f92672">-</span> w<span style="color:#f92672">.</span>reshape(true_w<span style="color:#f92672">.</span>shape), true_b <span style="color:#f92672">-</span> b
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num_epochs_list <span style="color:#f92672">=</span> [<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">100</span>]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> num_epochs <span style="color:#f92672">in</span> num_epochs_list:
</span></span><span style="display:flex;"><span>    MSE_loss_w, MSE_loss_b <span style="color:#f92672">=</span> train_loss(nn<span style="color:#f92672">.</span>MSELoss(), num_epochs)
</span></span><span style="display:flex;"><span>    Huber_loss_w, Huber_loss_b <span style="color:#f92672">=</span> train_loss(nn<span style="color:#f92672">.</span>HuberLoss(), num_epochs)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;    w loss diff: &#34;</span>, MSE_loss_w <span style="color:#f92672">-</span> Huber_loss_w)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;    b loss diff: &#34;</span>, MSE_loss_b <span style="color:#f92672">-</span> Huber_loss_b)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>使用了传统的print大法，对于随便看几组数据足够了。我们测试了各种训练周期次数下两种损失函数的表现，某次结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w loss: tensor([ <span style="color:#ae81ff">0.0006</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.0005</span>])
</span></span><span style="display:flex;"><span>b loss: tensor([<span style="color:#ae81ff">0.0001</span>])
</span></span><span style="display:flex;"><span>w loss: tensor([ <span style="color:#ae81ff">0.0248</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.0281</span>])
</span></span><span style="display:flex;"><span>b loss: tensor([<span style="color:#ae81ff">0.0288</span>])
</span></span><span style="display:flex;"><span>    w loss diff:  tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0242</span>,  <span style="color:#ae81ff">0.0276</span>])
</span></span><span style="display:flex;"><span>    b loss diff:  tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0287</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>w loss: tensor([<span style="color:#ae81ff">0.0003</span>, <span style="color:#ae81ff">0.0004</span>])
</span></span><span style="display:flex;"><span>b loss: tensor([<span style="color:#ae81ff">0.0002</span>])
</span></span><span style="display:flex;"><span>w loss: tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0001</span>,  <span style="color:#ae81ff">0.0002</span>])
</span></span><span style="display:flex;"><span>b loss: tensor([<span style="color:#ae81ff">0.0004</span>])
</span></span><span style="display:flex;"><span>    w loss diff:  tensor([<span style="color:#ae81ff">0.0004</span>, <span style="color:#ae81ff">0.0002</span>])
</span></span><span style="display:flex;"><span>    b loss diff:  tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0002</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>w loss: tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">3.4857e-04</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.9312e-05</span>])
</span></span><span style="display:flex;"><span>b loss: tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0002</span>])
</span></span><span style="display:flex;"><span>w loss: tensor([<span style="color:#ae81ff">3.9601e-04</span>, <span style="color:#ae81ff">3.5524e-05</span>])
</span></span><span style="display:flex;"><span>b loss: tensor([<span style="color:#ae81ff">0.0003</span>])
</span></span><span style="display:flex;"><span>    w loss diff:  tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">7.4458e-04</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">5.4836e-05</span>])
</span></span><span style="display:flex;"><span>    b loss diff:  tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0006</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>w loss: tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">3.4618e-04</span>,  <span style="color:#ae81ff">1.0967e-05</span>])
</span></span><span style="display:flex;"><span>b loss: tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">8.9645e-05</span>])
</span></span><span style="display:flex;"><span>w loss: tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0003</span>,  <span style="color:#ae81ff">0.0002</span>])
</span></span><span style="display:flex;"><span>b loss: tensor([<span style="color:#ae81ff">0.0001</span>])
</span></span><span style="display:flex;"><span>    w loss diff:  tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">3.0756e-05</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.4496e-04</span>])
</span></span><span style="display:flex;"><span>    b loss diff:  tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0002</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>w loss: tensor([<span style="color:#ae81ff">1.7715e-04</span>, <span style="color:#ae81ff">3.4809e-05</span>])
</span></span><span style="display:flex;"><span>b loss: tensor([<span style="color:#ae81ff">0.0003</span>])
</span></span><span style="display:flex;"><span>w loss: tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">9.1076e-05</span>,  <span style="color:#ae81ff">2.3127e-04</span>])
</span></span><span style="display:flex;"><span>b loss: tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0002</span>])
</span></span><span style="display:flex;"><span>    w loss diff:  tensor([ <span style="color:#ae81ff">0.0003</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.0002</span>])
</span></span><span style="display:flex;"><span>    b loss diff:  tensor([<span style="color:#ae81ff">0.0005</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>w loss: tensor([<span style="color:#ae81ff">0.0001</span>, <span style="color:#ae81ff">0.0004</span>])
</span></span><span style="display:flex;"><span>b loss: tensor([<span style="color:#ae81ff">0.0009</span>])
</span></span><span style="display:flex;"><span>w loss: tensor([ <span style="color:#ae81ff">9.8348e-05</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">5.8103e-04</span>])
</span></span><span style="display:flex;"><span>b loss: tensor([<span style="color:#ae81ff">0.0005</span>])
</span></span><span style="display:flex;"><span>    w loss diff:  tensor([<span style="color:#ae81ff">7.7486e-06</span>, <span style="color:#ae81ff">1.0133e-03</span>])
</span></span><span style="display:flex;"><span>    b loss diff:  tensor([<span style="color:#ae81ff">0.0004</span>])
</span></span></code></pre></div><p>粗略看下来虽然huber训练速度相对慢一些，但是优化过程较mse更加稳定。</p>
<h2 id="q3如何访问线性回归的梯度">Q3：如何访问线性回归的梯度?<a href="#q3%e5%a6%82%e4%bd%95%e8%ae%bf%e9%97%ae%e7%ba%bf%e6%80%a7%e5%9b%9e%e5%bd%92%e7%9a%84%e6%a2%af%e5%ba%a6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>在旧有的实现方式中，我们可以直接使用<code>param.grad</code>来访问一个参数的梯度，但是在新的实现方式中，trainer直接替我们完成了这一步骤。</p>
<hr>
<h1 id="softmax回归">Softmax回归<a href="#softmax%e5%9b%9e%e5%bd%92" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>很多时候，我们需要的不只是一个预测值的大小，而是对于一个事物的归类。比如，某个电子邮件是不是垃圾邮件？某个图像中描绘的是什么动物？或者对于一个大语言模型的后处理采样器(专业对口)，下一个字选哪什么最合适？</p>
<p>在这种问题中，我们需要得到的往往不是一个模糊的概率，我们只对最终的“硬性分类”感兴趣。然而即便如此，具体的实现过程中，我们仍然要通过计算概率的方式来实现这种分类。</p>
<p>举个例子，假如我们要判断一个图像中显示的是狗、猫还是鸡，我们从中提取了4个特征，那么我们就可以用这样的式子来表示从特征到分类的映射关系：
</p>
$$
\begin{aligned}
o_1 &= x_1 w_{11} + x_2 w_{12} + x_3 w_{13} + x_4 w_{14} + b_1,\\
o_2 &= x_1 w_{21} + x_2 w_{22} + x_3 w_{23} + x_4 w_{24} + b_2,\\
o_3 &= x_1 w_{31} + x_2 w_{32} + x_3 w_{33} + x_4 w_{34} + b_3.
\end{aligned}
$$<p>
其中$o_{1},o_{2},o_{3}$为所谓的<strong>logit</strong>，即<strong>未规范化的预测</strong>，反映的是目标匹配的程度。比如假如狗、猫、鸡分别对应$o_{1}=0.1,o_{2}=0.8,o_{3}=0.1$，那么我们就可以这样来决定最后的分类：按照logit来投骰子，80%的概率投到猫，10%的概率投到狗或者鸡。</p>
<p>但是，假如我们要投骰子，我们就必须先知道不同事物对应的概率，但是logits的计算过程并不能确保它的总和总是1。此时我们需要某种方法来由logits得到我们所需要的总和为1的概率。不仅如此，我们还希望最后得到的概率分布有助于激励模型选中最正确的那个选项，比如虽然我们的logits比例为1:8:1，但是我们希望最后得分占8份的那个选项被抽中的概率比80%更大。</p>
<p>softmax函数做的正是这样的事情。softmax函数能够将未规范化的预测变换为非负数并且总和为1，同时让模型保持可导的性质。 为了完成这一目标，我们首先对每个未规范化的预测求幂，这样可以确保输出非负。 为了确保最终输出的概率值总和为1，我们再让每个求幂后的结果除以它们的总和。如下式：
</p>
$$
\hat{\mathbf{y}} = \mathrm{softmax}(\mathbf{o})\quad \text{其中}\quad \hat{y}_j = \frac{\exp(o_j)}{\sum_k \exp(o_k)}
$$<p>
尽管softmax函数本身并不是线性的，但是softmax回归的输出仍然由特征的仿射变换决定，所以softmax回归是一个线性模型。</p>
<p>说白了，softmax做的事情就是把打分映射成概率。</p>
<h2 id="对数似然">对数似然<a href="#%e5%af%b9%e6%95%b0%e4%bc%bc%e7%84%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>我们仍然尝试去分类狗、猫和鸡。设想我们造出了这样一个机器，我们喂给它一张图片，它就会吐出这张图片是狗、猫和鸡的概率。现在，我们喂给机器一张猫的图片，调节旋钮，机器吐出猫的概率为0.1；再调节旋钮，机器吐出猫的概率是0.8。那么对于我们已经知道结果的实验者来说，后者对于事实的判断是更加准确的。</p>
<p>旋钮的比喻实际上指的就是机器学习中的参数。所谓的<strong>最大似然</strong>，说的就是找到这样的一个旋钮位置，使得所有正确答案发生的概率之和（或之积）最大。</p>
<p>比如，仍然举我们的图片机器比喻，我们喂给机器一张猫的图片，机器认为图片上是猫的概率是80%，但是这不代表每张猫的图片机器都认为它是猫的概率是80%，机器完全可以认为某张图是猫的概率是99.9%，也可以认为是0.01%。此外在这个例子中，我们也完全没有谈到对于狗和鸡的辨别。我们希望的最理想的状态是，我们手头有很多图片，上面是狗、猫还是鸡我们自己清楚，我们希望喂给机器后“机器可以正确判断所有样本”的这个总概率最大。也就是说某张猫图机器正确概率80%，另一张猫图机器正确概率70%，再一张狗图机器正确概率90%，那么机器判断全部正确的概率就是$80\% \cdot70 \% \cdot 90\%$。这个总概率会随着参数变化而变化，所以我们希望通过调整参数来让这个总概率最大。总概率越大，机器的准确度也就越大。</p>
<p>所谓的<strong>对数似然</strong>，说的就是：我们不直接计算$P(\mathbf{Y} \mid \mathbf{X}) = \prod_{i=1}^n P(\mathbf{y}^{(i)} \mid \mathbf{x}^{(i)})$这个连乘计算，而是计算$\log P(\mathbf{Y} \mid \mathbf{X}) = \sum_{i=1}^n \log P(\mathbf{y}^{(i)} \mid \mathbf{x}^{(i)})$。一方面在样本很多的时候，直接对概率求积很可能最后非常趋近于0而导致向下溢出，另一方面对于机器来说虽然将这些概率乘起来很容易，但是求导的时候会很痛苦。</p>
<p>然而因为概率总是0～1之间的数字，加上对数之后就总是一个负数。所以为了凑出一个正的损失值，我们实际计算的是$-\log P(\mathbf{Y} \mid \mathbf{X}) = -\sum_{i=1}^n \log P(\mathbf{y}^{(i)} \mid \mathbf{x}^{(i)})$，将最大化似然转化为最小化负似然，将总概率对数的负数视作这个模型的损失，这样我们就可以继续套用我们线性回归模型的训练流程。</p>
<p>规范的损失函数表述：
</p>
$$ l(\mathbf{y}, \hat{\mathbf{y}}) = - \sum_{j=1}^q y_j \log \hat{y}_j. $$<p>
其中$y_j$是第$j$个分类对应的<strong>独热编码</strong>，即标准答案中的概率：假如一个图片中是猫，猫对应的$y_2$，则$y_2 = 1$，而图中的东西不是狗也不是鸡，所以$y_{1}=0,y_{3}=0$，所以最后得到的损失值就是$-y_{2}\log \hat{y_{2}}$实际的意义也就是找到机器判断正确的概率的负对数。在使用小批量随机下降法时，我们就可以直接对一个小批量的损失求和或平均得到这个batch的总损失。</p>
<h2 id="softmax及其导数">softmax及其导数<a href="#softmax%e5%8f%8a%e5%85%b6%e5%af%bc%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703-20260128-4.png" alt=""></p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703-20260128-5.png" alt=""></p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703-20260128-6.png" alt=""></p>
<p>为了最终计算每个参数对于损失的贡献值，我们先计算每个logit对于损失的贡献，因为参数对于logits的损失贡献我们可以直接套用线性回归模型中的损失函数。</p>
<p>通过如上的推导，我们惊讶地发现每个logit对于损失的贡献竟然也可以用softmax来计算，这样就极大地方便了对数似然的梯度计算。</p>
<h2 id="信息论基础">信息论基础<a href="#%e4%bf%a1%e6%81%af%e8%ae%ba%e5%9f%ba%e7%a1%80" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>信息论的核心思想是量化数据中的信息内容。D2L讲义里给的东西实在有点太难懂了，这里用相对浅显的语言叙述一遍。</p>
<p>信息论认为信息量的大小取决于这段信息的“惊异程度”。比如我说“程序员一定要会写代码”，你会说这不是废话吗。这句话的信息量就很低，因为它发生的概率约等于100%。但是假如我说“从明天开始所有程序员的代码水平下降100倍而我不受影响”，这句话的信息量就很大了，因为这句话发生的概率非常低，发生时会带来极大的惊异。</p>
<p>我们设事件$A$为“程序员一定要会写代码”，事件$B$为“从明天开始所有程序员的代码水平下降100倍而我不受影响”。在信息论中有这样的公式：
</p>
$$H[P] = \sum_j - P(j) \log P(j).$$<p>
其中，$-\log P(j)$描述的是<strong>信息量</strong>，$P(j)$越大信息量越小，反之越大。信息量再乘以发生概率，描述的就是这个信息整体的<strong>混乱程度</strong>，即<strong>信息熵</strong>。</p>
<p>比如，假如事件$A$的概率为99%，概率非常大，但是相应的$-\log P(A)$的数值会非常小，动用卡西欧之力我们可以算出$A$的信息熵约$9.95 \cdot 10^{-3}$。概率非常大，导致我们预测这个事件的把握非常大，这个事件一点都不混乱。</p>
<p>但是对于事件$B$，假如$B$的概率为0.01%，概率非常的小，但是相应的$-\log P(B)$的数值会非常大，我们可以算出B的信息熵约为$9.21 \cdot 10^{-4}$。因为概率很小，所以我们也同样很容易预测，所以虽然惊异，但是混乱程度也很低。</p>
<p>通过这两个例子，你会发现信息熵描述的实际上是一个系统内所以可能发生的事件平均下来能带给你多少惊异。什么样的系统信息熵很大呢？比如投个硬币，正面反面概率都是50%，你几乎无法预测下一次投出来是什么，每次投硬币都会给你一点新的信息，局势很混乱，熵也比较高。</p>
<h3 id="交叉熵">交叉熵<a href="#%e4%ba%a4%e5%8f%89%e7%86%b5" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>回到我们的机器学习话题，假如我们希望用机器判断一个图片是狗、猫还是鸡，有一点是可以确认的：“图片描绘的是狗、猫还是鸡”这个问题是有一个客观的答案的。假如图片就是我们在现实中拍的，那么它一定对应一个动物；假如图片是一个画家画的，画的东西做到了同时像狗像猫还像鸡，那么至少宇宙万法那个源头会知道这个图描绘的是狗猫鸡的概率分别是多少。</p>
<p>对于随便的某张图，假如真实的情况是这张图片描绘的是猫的概率是99%，但是我的机器认为是猫的概率为1%，所以当结果真的是猫的时候，机器就会非常惊讶；假如回回是猫，机器就会回回惊讶，这样一来平均惊异度就会很高，也就意味着系统的信息熵很高。我们为这种熵取一个专有的名词，叫做<strong>交叉熵</strong>。设真实的概率为$P$，预测的概率为$Q$，那么交叉熵可以表示为：
</p>
$$
H(P,Q) = \sum-P \cdot \log(Q)
$$<p>
我们的目标是让模型尽最大可能的准确预测这个事件，翻译过来就是：在模型进行了预测后面对真实答案时尽可能的不意外，也就是我们希望<strong>交叉熵越小越好</strong>。</p>
<p>这时候你会有这样的疑问：看起来好像假如我们希望模型看到真实结果时不意外，我们只需要让模型预测的结果尽可能大就可以了？这就好像考完试估分的时候考虑最差的情况而不是最可能的情况，这样即使出现意外自己也不会很惊讶。</p>
<p>但是实际情况是模型做不到把概率预测的尽可能高，原因在于logits经过softamax加工之后总和被锁定为1，模型没办法既给狗判定为90%，同时又给猫和鸡也判90%。我们假设一个图片描绘的是狗、猫和鸡的真实概率为$P_{1},P_{2},P_{3}$，模型预测的概率为$Q_1,Q_2,Q_3$，那么我们有如下方程：
</p>
$$
\begin{cases}
Q_1 + Q_2 + Q_3 = 1 \\
P_1 + P_2 + P_3 = 1 \\
H(P, Q) = \sum_{i = 1}^{3}-P_i \log(Q_i)
\end{cases}
$$<p>
我们希望$H(P,Q)$的数值最低。经过计算，我们得到当$Q_{1},Q_{2},Q_{3}$分别和$P_{1},P_{2},P_{3}$相等的时候，$H(P,Q)$取到最小值。</p>
<p>绕了这么一大圈，我们其实最终得到的结论就是：我们希望模型预测的结果能尽可能的符合实际，本质上就是希望模型能尽可能准确的找到那个潜在的客观概率，而过程中的交叉熵就可以用来作为衡量误差的误差函数。交叉熵越大，我们便可以认为误差越大，进而优化模型。</p>
<h2 id="课后练习-1">课后练习<a href="#%e8%af%be%e5%90%8e%e7%bb%83%e4%b9%a0-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>鸽了。</p>
<h1 id="图像分类数据集">图像分类数据集<a href="#%e5%9b%be%e5%83%8f%e5%88%86%e7%b1%bb%e6%95%b0%e6%8d%ae%e9%9b%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>在经过了漫长的理论分析之后，我们终于要自己动手写一下图像分类了。（泪目）</p>
<p>总之，我们使用的图像分类数据集为fashion-mnist。Fashion-MNIST数据集由10个类别组成，每个类别由训练数据集的6000个图像和测试数据集的1000个图像组成。每个图像的长度和宽度均为28。（tui狂喜）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torchvision
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.utils <span style="color:#f92672">import</span> data
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torchvision <span style="color:#f92672">import</span> transforms
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 通过ToTensor实例将图像数据从PIL类型变换成32位浮点数格式，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 并除以255使得所有像素的数值均在0～1之间</span>
</span></span><span style="display:flex;"><span>trans <span style="color:#f92672">=</span> transforms<span style="color:#f92672">.</span>ToTensor()
</span></span><span style="display:flex;"><span>mnist_train <span style="color:#f92672">=</span> torchvision<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>FashionMNIST(
</span></span><span style="display:flex;"><span>    root<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../data&#34;</span>, train<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, transform<span style="color:#f92672">=</span>trans, download<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>mnist_test <span style="color:#f92672">=</span> torchvision<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>FashionMNIST(
</span></span><span style="display:flex;"><span>    root<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../data&#34;</span>, train<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, transform<span style="color:#f92672">=</span>trans, download<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>运行这段代码会自动下载测试数据集。有的时候因为网络问题可能会下载失败，你可以选择手动去github上下载，但是必须自己组织和FashionMNIST方法一致的文件结构。</p>
<p>推荐的手动安装链接：<a href="http://fashion-mnist.s3-website.eu-central-1.amazonaws.com/train-images-idx3-ubyte.gz">fashion-mnist官网</a></p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93-20260128-1.png" alt=""></p>
<p>打印一下训练数据集和测试数据集的大小，分别为60000和10000。符合预期。</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93-20260128-2.png" alt=""></p>
<p><code>mnist_train</code>和<code>mnist_test</code>的数据类型为<code>torchvision.datasets.mnist.FashionMNIST'</code>，为数据集对象，均继承自PyTorch的Dataset类。它们的行为像一个列表，可以使用下标索引来访问某一个样本，也可以使用<code>len()</code>来获取总长度。比如，你可以通过<code>mnist_train[0]</code>来获取第一个样本的内容，对应的文件类型为一个元组。</p>
<p>在任意一个<code>mnist_train</code>的样本元组中，第一个元素存储的是图像张量，第二个元素存储的是图像的类别标签。比如对于某个T恤样本元组，第一个元素就是用来描述这个图像的一个形状为$[1,28,28]$的PyTorch张量，第二个元素则是T恤对应的索引值。</p>
<p>我们来看看这段代码会输出什么：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(type(mnist_train))
</span></span><span style="display:flex;"><span>print(type(mnist_train[<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>print(len(mnist_train[<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>print(type(mnist_train[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>print(mnist_train[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>print(mnist_train[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>print(type(mnist_train[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>print(type(mnist_train[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>print(type(mnist_train[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>]))
</span></span></code></pre></div><p>结果为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">torchvision</span><span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>mnist<span style="color:#f92672">.</span>FashionMNIST<span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">tuple</span><span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">torch</span><span style="color:#f92672">.</span>Tensor<span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>Size([<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">28</span>, <span style="color:#ae81ff">28</span>])
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">9</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">torch</span><span style="color:#f92672">.</span>Tensor<span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">torch</span><span style="color:#f92672">.</span>Tensor<span style="color:#e6db74">&#39;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">class</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#a6e22e">torch</span><span style="color:#f92672">.</span>Tensor<span style="color:#e6db74">&#39;&gt;</span>
</span></span></code></pre></div><p>图像的形状之所以形状为$[1,28,28]$是因为FashionMNIST数据集选取的图像并不是彩色图像，而是黑白灰度图，描述图像的元素只需要一个数字即可，所以通道数为1。而对于一般的图片，我们可能需要三个颜色通道才能描述，所以假如FashionMNIST选取的图片是彩色的，可能描述图片的张量形状就是$[3,28,28]$。</p>
<p>Fashion-MNIST中包含的10个类别，分别为t-shirt（T恤）、trouser（裤子）、pullover（套衫）、dress（连衣裙）、coat（外套）、sandal（凉鞋）、shirt（衬衫）、sneaker（运动鞋）、bag（包）和ankle boot（短靴）。 以下函数用于在数字标签索引及其文本名称之间进行转换。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_fashion_mnist_labels</span>(labels):  <span style="color:#75715e">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;返回Fashion-MNIST数据集的文本标签&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    text_labels <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;t-shirt&#39;</span>, <span style="color:#e6db74">&#39;trouser&#39;</span>, <span style="color:#e6db74">&#39;pullover&#39;</span>, <span style="color:#e6db74">&#39;dress&#39;</span>, <span style="color:#e6db74">&#39;coat&#39;</span>,
</span></span><span style="display:flex;"><span>                   <span style="color:#e6db74">&#39;sandal&#39;</span>, <span style="color:#e6db74">&#39;shirt&#39;</span>, <span style="color:#e6db74">&#39;sneaker&#39;</span>, <span style="color:#e6db74">&#39;bag&#39;</span>, <span style="color:#e6db74">&#39;ankle boot&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> [text_labels[int(i)] <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> labels]
</span></span></code></pre></div><p>D2L中提供了这样的脚本来可视化样本。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show_images</span>(imgs, num_rows, num_cols, titles<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, scale<span style="color:#f92672">=</span><span style="color:#ae81ff">1.5</span>):  <span style="color:#75715e">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;绘制图像列表&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    figsize <span style="color:#f92672">=</span> (num_cols <span style="color:#f92672">*</span> scale, num_rows <span style="color:#f92672">*</span> scale)
</span></span><span style="display:flex;"><span>    _, axes <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>plt<span style="color:#f92672">.</span>subplots(num_rows, num_cols, figsize<span style="color:#f92672">=</span>figsize)
</span></span><span style="display:flex;"><span>    axes <span style="color:#f92672">=</span> axes<span style="color:#f92672">.</span>flatten()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i, (ax, img) <span style="color:#f92672">in</span> enumerate(zip(axes, imgs)):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> torch<span style="color:#f92672">.</span>is_tensor(img):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 图片张量</span>
</span></span><span style="display:flex;"><span>            ax<span style="color:#f92672">.</span>imshow(img<span style="color:#f92672">.</span>numpy())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># PIL图片</span>
</span></span><span style="display:flex;"><span>            ax<span style="color:#f92672">.</span>imshow(img)
</span></span><span style="display:flex;"><span>        ax<span style="color:#f92672">.</span>axes<span style="color:#f92672">.</span>get_xaxis()<span style="color:#f92672">.</span>set_visible(<span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>        ax<span style="color:#f92672">.</span>axes<span style="color:#f92672">.</span>get_yaxis()<span style="color:#f92672">.</span>set_visible(<span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> titles:
</span></span><span style="display:flex;"><span>            ax<span style="color:#f92672">.</span>set_title(titles[i])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> axes
</span></span></code></pre></div><p>这段脚本的工作原理搞不明白的话也无所谓，总之之后想在jupyter notebook中显示tensor格式的图像用它就可以了。</p>
<p>在jupyter lab中呈现的效果：</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93-20260202-1.png" alt=""></p>
<p>尝试了一段时间想在plotext上复刻这种效果，感觉有点吃力不讨好。看来还是不得不用jupyter notebook做机器学习。</p>
<h2 id="读取小批量">读取小批量<a href="#%e8%af%bb%e5%8f%96%e5%b0%8f%e6%89%b9%e9%87%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_dataloader_workers</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_iter <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>DataLoader(
</span></span><span style="display:flex;"><span>    mnist_train, batch_size<span style="color:#f92672">=</span>BATCH_SIZE, shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, num_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>timer <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>Timer()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> train_iter:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>timer<span style="color:#f92672">.</span>stop()<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> sec&#34;</span>)
</span></span></code></pre></div><p>GPU处理数据的一个基本单元是batch，由于打包batch需要涉及GPU并不擅长的相对复杂的逻辑运算以及磁盘读写，这部分工作基本由CPU来完成，而CPU的计算速度乏善可陈。很多时候当GPU已经处理完了一个batch，CPU还在忙着打包，这样GPU就会处在空闲状态，导致计算速度下降。此处我们手动设置了<code>num_workers</code>参数，即设定了启动的CPU进程数，让四个进程一块打包batch，提高总体效率。</p>
<p>通常，对于一个8核CPU，<code>num_workers</code>设置为4或者8是相对合理的。</p>
<p>输出结果：</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/D2L%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93-20260202-3.png" alt=""></p>
<p>整合以上的代码得到一个集成了数据集下载、图形预处理以及随机采样的数据集加载器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_data_fashion_mnist</span>(batch_size, resize<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    trans <span style="color:#f92672">=</span> [transforms<span style="color:#f92672">.</span>ToTensor()]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> resize:
</span></span><span style="display:flex;"><span>        trans<span style="color:#f92672">.</span>insert(<span style="color:#ae81ff">0</span>, transforms<span style="color:#f92672">.</span>Resize(resize))
</span></span><span style="display:flex;"><span>    trans <span style="color:#f92672">=</span> transforms<span style="color:#f92672">.</span>Compose(trans)
</span></span><span style="display:flex;"><span>    mnist_train <span style="color:#f92672">=</span> torchvision<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>FashionMNIST(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../data/&#34;</span>, train<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, download<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, transform<span style="color:#f92672">=</span>trans)
</span></span><span style="display:flex;"><span>    mnist_test <span style="color:#f92672">=</span> torchvision<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>FashionMNIST(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../data&#34;</span>, train<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, download<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, transform<span style="color:#f92672">=</span>trans)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>        data<span style="color:#f92672">.</span>DataLoader(dataset<span style="color:#f92672">=</span>mnist_train, batch_size<span style="color:#f92672">=</span>batch_size, shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, num_workers<span style="color:#f92672">=</span>get_dataloader_workers()),
</span></span><span style="display:flex;"><span>        data<span style="color:#f92672">.</span>DataLoader(dataset<span style="color:#f92672">=</span>mnist_test, batch_size<span style="color:#f92672">=</span>batch_size, shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, num_workers<span style="color:#f92672">=</span>get_dataloader_workers())
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><p>其中返回值为一个元组，第二个元素为对测试集的批量采样。看起来有点复杂，但是实际自己动手写一遍感觉思路就通了。这里之所以需要塞一个resize的变换，是因为有一些深度学习模型是为特定尺寸的图片设计的，经过池化层或者一些步长大于1的卷积层会导致图像尺寸缩小，可能传着传着图就没了，所以传入模型之前对图像尺寸做手动适配可以提高加载器的灵活性。</p>
<p>使用例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>train_iter, test_iter <span style="color:#f92672">=</span> load_data_fashion_mnist(batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>, resize<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> train_iter:
</span></span><span style="display:flex;"><span>    print(X<span style="color:#f92672">.</span>shape, X<span style="color:#f92672">.</span>dtype, y<span style="color:#f92672">.</span>shape, y<span style="color:#f92672">.</span>dtype)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>
</span></span></code></pre></div><p>加载数据集并从中按32个样本为一个批次采样，并把图像长宽拉伸为64。输出结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>Size([<span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">64</span>]) torch<span style="color:#f92672">.</span>float32 torch<span style="color:#f92672">.</span>Size([<span style="color:#ae81ff">32</span>]) torch<span style="color:#f92672">.</span>int64
</span></span></code></pre></div><h2 id="课后习题">课后习题：<a href="#%e8%af%be%e5%90%8e%e4%b9%a0%e9%a2%98" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="q1减少batch_size是否会影响读取性能">Q1：减少batch_size是否会影响读取性能?<a href="#q1%e5%87%8f%e5%b0%91batch_size%e6%98%af%e5%90%a6%e4%bc%9a%e5%bd%b1%e5%93%8d%e8%af%bb%e5%8f%96%e6%80%a7%e8%83%bd" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>测试代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">batch_size_test</span>(batch_size):
</span></span><span style="display:flex;"><span>    timer<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    train_iter, test_iter <span style="color:#f92672">=</span> load_data_fashion_mnist(batch_size<span style="color:#f92672">=</span>batch_size, resize<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i, (X, y) <span style="color:#f92672">in</span> enumerate(train_iter):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>timer<span style="color:#f92672">.</span>stop()<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> sec&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> batch_size <span style="color:#f92672">in</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">64</span>]:
</span></span><span style="display:flex;"><span>    batch_size_test(batch_size)
</span></span></code></pre></div><p>运行结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ae81ff">45.01</span> sec
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">11.19</span> sec
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5.76</span> sec
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3.07</span> sec
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1.75</span> sec
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1.25</span> sec
</span></span></code></pre></div><p>可以看到随着batch_size增大，读取数据的用时显著减少。原因在于batch_size越大，打包batch的次数越少，CPU访存次数越少。读取数据的主要用时就在于此。</p>
<p>我们还可以基于此添加num_workers对性能的影响，脚本如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_data_fashion_mnist</span>(batch_size, resize<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, num_workers<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    trans <span style="color:#f92672">=</span> [transforms<span style="color:#f92672">.</span>ToTensor()]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> resize:
</span></span><span style="display:flex;"><span>        trans<span style="color:#f92672">.</span>insert(<span style="color:#ae81ff">0</span>, transforms<span style="color:#f92672">.</span>Resize(resize))
</span></span><span style="display:flex;"><span>    trans <span style="color:#f92672">=</span> transforms<span style="color:#f92672">.</span>Compose(trans)
</span></span><span style="display:flex;"><span>    mnist_train <span style="color:#f92672">=</span> torchvision<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>FashionMNIST(
</span></span><span style="display:flex;"><span>        root<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../data/&#34;</span>, train<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, download<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, transform<span style="color:#f92672">=</span>trans
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    mnist_test <span style="color:#f92672">=</span> torchvision<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>FashionMNIST(
</span></span><span style="display:flex;"><span>        root<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../data&#34;</span>, train<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, download<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, transform<span style="color:#f92672">=</span>trans
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> num_workers:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>            data<span style="color:#f92672">.</span>DataLoader(
</span></span><span style="display:flex;"><span>                dataset<span style="color:#f92672">=</span>mnist_train,
</span></span><span style="display:flex;"><span>                batch_size<span style="color:#f92672">=</span>batch_size,
</span></span><span style="display:flex;"><span>                shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                num_workers<span style="color:#f92672">=</span>num_workers,
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>            data<span style="color:#f92672">.</span>DataLoader(
</span></span><span style="display:flex;"><span>                dataset<span style="color:#f92672">=</span>mnist_test,
</span></span><span style="display:flex;"><span>                batch_size<span style="color:#f92672">=</span>batch_size,
</span></span><span style="display:flex;"><span>                shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>                num_workers<span style="color:#f92672">=</span>num_workers,
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>        data<span style="color:#f92672">.</span>DataLoader(
</span></span><span style="display:flex;"><span>            dataset<span style="color:#f92672">=</span>mnist_train,
</span></span><span style="display:flex;"><span>            batch_size<span style="color:#f92672">=</span>batch_size,
</span></span><span style="display:flex;"><span>            shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            num_workers<span style="color:#f92672">=</span>get_dataloader_workers(),
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        data<span style="color:#f92672">.</span>DataLoader(
</span></span><span style="display:flex;"><span>            dataset<span style="color:#f92672">=</span>mnist_test,
</span></span><span style="display:flex;"><span>            batch_size<span style="color:#f92672">=</span>batch_size,
</span></span><span style="display:flex;"><span>            shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>            num_workers<span style="color:#f92672">=</span>get_dataloader_workers(),
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">batch_size_test</span>(batch_size, num_workers):
</span></span><span style="display:flex;"><span>    timer<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    train_iter, test_iter <span style="color:#f92672">=</span> load_data_fashion_mnist(
</span></span><span style="display:flex;"><span>        batch_size<span style="color:#f92672">=</span>batch_size, resize<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>, num_workers<span style="color:#f92672">=</span>num_workers
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i, (X, y) <span style="color:#f92672">in</span> enumerate(train_iter):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    print(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;batch size: </span><span style="color:#e6db74">{</span>batch_size<span style="color:#e6db74">}</span><span style="color:#e6db74">, num of workers: </span><span style="color:#e6db74">{</span>num_workers<span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>timer<span style="color:#f92672">.</span>stop()<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> sec&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> batch_size <span style="color:#f92672">in</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">64</span>]:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> num_workers <span style="color:#f92672">in</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">8</span>]:
</span></span><span style="display:flex;"><span>        batch_size_test(batch_size, num_workers)
</span></span></code></pre></div><p>（略微修改了数据加载器的代码来适配对num_workers的调整。）</p>
<p>输出结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">1</span>, num of workers: <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">66.35</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">1</span>, num of workers: <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">45.15</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">1</span>, num of workers: <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">50.05</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">1</span>, num of workers: <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">50.57</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">4</span>, num of workers: <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">22.39</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">4</span>, num of workers: <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">12.79</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">4</span>, num of workers: <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">12.86</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">4</span>, num of workers: <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">13.59</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">8</span>, num of workers: <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">13.08</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">8</span>, num of workers: <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">8.41</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">8</span>, num of workers: <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">6.79</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">8</span>, num of workers: <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">6.93</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">16</span>, num of workers: <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">8.33</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">16</span>, num of workers: <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">5.09</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">16</span>, num of workers: <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">3.85</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">16</span>, num of workers: <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">3.92</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">32</span>, num of workers: <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5.91</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">32</span>, num of workers: <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3.65</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">32</span>, num of workers: <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">2.40</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">32</span>, num of workers: <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">2.40</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">64</span>, num of workers: <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4.62</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">64</span>, num of workers: <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2.73</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">64</span>, num of workers: <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1.75</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">64</span>, num of workers: <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">1.44</span> sec
</span></span></code></pre></div><p>随着num_workers增加，数据读取效率通常也会增加，但是这会取决于batch_size的大小。比如，当num_workers从1增加到2的时候，数据读取用时显著减少，从2到4也有进步，但是4到8则性能提升较少，甚至一些bs下8workers用时反而会变长。</p>
<p>原因在于CPU的核心数是有限的。随着线程数量增大，CPU调度本身也在增加性能成本。当性能成本的增长高过多线程带来的速度收益，数据读取用时就会负增长。</p>
<p>总之，实际训练的时候应该尽量的使用更大的batch_size，除非过大导致爆显存（此事在triton sampler中亦有记载）；此外，num_workers的数值往往存在一个甜品点，比如在我的机器上num_workers设置为4就是多数情况下最稳健且速度较优的配置。</p>
<h3 id="q2数据迭代器的性能非常重要当前的实现足够快吗探索各种选择来改进它">Q2：数据迭代器的性能非常重要。当前的实现足够快吗？探索各种选择来改进它。<a href="#q2%e6%95%b0%e6%8d%ae%e8%bf%ad%e4%bb%a3%e5%99%a8%e7%9a%84%e6%80%a7%e8%83%bd%e9%9d%9e%e5%b8%b8%e9%87%8d%e8%a6%81%e5%bd%93%e5%89%8d%e7%9a%84%e5%ae%9e%e7%8e%b0%e8%b6%b3%e5%a4%9f%e5%bf%ab%e5%90%97%e6%8e%a2%e7%b4%a2%e5%90%84%e7%a7%8d%e9%80%89%e6%8b%a9%e6%9d%a5%e6%94%b9%e8%bf%9b%e5%ae%83" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<ul>
<li><code>pin_memory = True</code>开启显存锁定内存。如果想要GPU直接读取内存数据，内存中数据对应的地址必须固定。假如不开启pin_memory，每次GPU想要读取数据的时候，系统都必须把普通内存中的数据先移动到GPU能读取的锁页内存，然后GPU才能读取。开启之后，CPU打包好的数据会直接放在锁页内存中，这样GPU读取的时候就可以省略一步复制操作。</li>
<li><code>persistent_workers = True</code>，在每个epoch结束之后保留workers进程，避免反复创建内存的开销。</li>
<li>预处理训练集，如果需要resize则提前写一个脚本生成一个已经resize过的数据集，这样训练过程中就不用CPU反复resize，减少CPU负载。</li>
<li>直接读取整个数据集，将所有样本都用张量的形式直接放在内存中，消除磁盘读写时间。</li>
</ul>
<p>总之我们先来尝试一下添加显存锁定内存以及保留线程。修改后的数据加载器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_data_fashion_mnist</span>(batch_size, resize<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, num_workers<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    trans <span style="color:#f92672">=</span> [transforms<span style="color:#f92672">.</span>ToTensor()]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> resize:
</span></span><span style="display:flex;"><span>        trans<span style="color:#f92672">.</span>insert(<span style="color:#ae81ff">0</span>, transforms<span style="color:#f92672">.</span>Resize(resize))
</span></span><span style="display:flex;"><span>    trans <span style="color:#f92672">=</span> transforms<span style="color:#f92672">.</span>Compose(trans)
</span></span><span style="display:flex;"><span>    mnist_train <span style="color:#f92672">=</span> torchvision<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>FashionMNIST(
</span></span><span style="display:flex;"><span>        root<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../data/&#34;</span>, train<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, download<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, transform<span style="color:#f92672">=</span>trans
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    mnist_test <span style="color:#f92672">=</span> torchvision<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>FashionMNIST(
</span></span><span style="display:flex;"><span>        root<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../data&#34;</span>, train<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, download<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, transform<span style="color:#f92672">=</span>trans
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> num_workers:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>            data<span style="color:#f92672">.</span>DataLoader(
</span></span><span style="display:flex;"><span>                dataset<span style="color:#f92672">=</span>mnist_train,
</span></span><span style="display:flex;"><span>                batch_size<span style="color:#f92672">=</span>batch_size,
</span></span><span style="display:flex;"><span>                shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                pin_memory <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                persistent_workers <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                num_workers<span style="color:#f92672">=</span>num_workers,
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>            data<span style="color:#f92672">.</span>DataLoader(
</span></span><span style="display:flex;"><span>                dataset<span style="color:#f92672">=</span>mnist_test,
</span></span><span style="display:flex;"><span>                batch_size<span style="color:#f92672">=</span>batch_size,
</span></span><span style="display:flex;"><span>                shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>                pin_memory <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                persistent_workers <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                num_workers<span style="color:#f92672">=</span>num_workers,
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>        data<span style="color:#f92672">.</span>DataLoader(
</span></span><span style="display:flex;"><span>            dataset<span style="color:#f92672">=</span>mnist_train,
</span></span><span style="display:flex;"><span>            batch_size<span style="color:#f92672">=</span>batch_size,
</span></span><span style="display:flex;"><span>            shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            pin_memory <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            persistent_workers <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            num_workers<span style="color:#f92672">=</span>get_dataloader_workers(),
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        data<span style="color:#f92672">.</span>DataLoader(
</span></span><span style="display:flex;"><span>            dataset<span style="color:#f92672">=</span>mnist_test,
</span></span><span style="display:flex;"><span>            batch_size<span style="color:#f92672">=</span>batch_size,
</span></span><span style="display:flex;"><span>            shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>            pin_memory <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            persistent_workers <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            num_workers<span style="color:#f92672">=</span>get_dataloader_workers(),
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><p>（做到这里的时候发现torch版本太旧，加了<code>pin_memory</code>出现了不支持当前硬件的情况，索性重新配了一个新的环境，jupyter lab感觉配置有点反人类，回头写篇博客专门研究一下。）</p>
<p>运行结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">1</span>, num of workers: <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">67.36</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">1</span>, num of workers: <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">45.86</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">1</span>, num of workers: <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">48.19</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">1</span>, num of workers: <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">50.56</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">4</span>, num of workers: <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">21.34</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">4</span>, num of workers: <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">13.26</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">4</span>, num of workers: <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">13.15</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">4</span>, num of workers: <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">13.04</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">8</span>, num of workers: <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">13.00</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">8</span>, num of workers: <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">8.06</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">8</span>, num of workers: <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">6.77</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">8</span>, num of workers: <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">7.26</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">16</span>, num of workers: <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">8.42</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">16</span>, num of workers: <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4.96</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">16</span>, num of workers: <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">3.88</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">16</span>, num of workers: <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">3.93</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">32</span>, num of workers: <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5.87</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">32</span>, num of workers: <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3.58</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">32</span>, num of workers: <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">2.42</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">32</span>, num of workers: <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">2.37</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">64</span>, num of workers: <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4.79</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">64</span>, num of workers: <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2.61</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">64</span>, num of workers: <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1.77</span> sec
</span></span><span style="display:flex;"><span>batch size: <span style="color:#ae81ff">64</span>, num of workers: <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">1.51</span> sec
</span></span></code></pre></div><p>（好像没什么优化，我怀疑可能是自己硬件太超前了导致torch支持还没跟上&hellip;）</p>
<p>尝试使用离线处理，原理是<code>transforms.Resize(64)</code>非常吃CPU，每个epoch都要计算一次的话会很浪费性能。幸运的是PyTorch支持你把一个张量存储为一个<code>.pt</code>文件存在硬盘上，我们可以写一个脚本预处理图像，把尺寸伸缩后的图像全部塞在这个张量文件中，这样数据加载的时候就可以省略这一步骤。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">preprocess_and_save</span>(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../data/&#34;</span>, resize<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>):
</span></span><span style="display:flex;"><span>    trans <span style="color:#f92672">=</span> transforms<span style="color:#f92672">.</span>Compose([transforms<span style="color:#f92672">.</span>ToTensor(), transforms<span style="color:#f92672">.</span>Resize(size<span style="color:#f92672">=</span>resize)])
</span></span><span style="display:flex;"><span>    mnist_train <span style="color:#f92672">=</span> torchvision<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>FashionMNIST(
</span></span><span style="display:flex;"><span>        root<span style="color:#f92672">=</span>root, train<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, transform<span style="color:#f92672">=</span>trans, download<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    mnist_test <span style="color:#f92672">=</span> torchvision<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>FashionMNIST(
</span></span><span style="display:flex;"><span>        root<span style="color:#f92672">=</span>root, train<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, transform<span style="color:#f92672">=</span>trans, download<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    train_loader <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>DataLoader(dataset<span style="color:#f92672">=</span>mnist_train, batch_size<span style="color:#f92672">=</span>len(mnist_train))
</span></span><span style="display:flex;"><span>    test_loader <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>DataLoader(dataset<span style="color:#f92672">=</span>mnist_test, batch_size<span style="color:#f92672">=</span>len(mnist_test))
</span></span><span style="display:flex;"><span>    train_data, train_target <span style="color:#f92672">=</span> next(iter(train_loader))
</span></span><span style="display:flex;"><span>    test_data, test_target <span style="color:#f92672">=</span> next(iter(test_loader))
</span></span><span style="display:flex;"><span>    torch<span style="color:#f92672">.</span>save((train_data, train_target), <span style="color:#e6db74">&#34;mnist_train_resize.pt&#34;</span>)
</span></span><span style="display:flex;"><span>    torch<span style="color:#f92672">.</span>save((test_data, test_target), <span style="color:#e6db74">&#34;mnist_test_resize.pt&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Saved successfully.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>preprocess_and_save()
</span></span></code></pre></div><p>工作原理是一次读取一个和数据集一样大的batch，然后把读取的data和target张量打包成一个元组塞进<code>.pt</code>文件中。</p>
<p>对于读取操作，我们可以通过自己写一个dataset类来实现，完整代码实现如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">preprocess_and_save</span>(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../data/&#34;</span>, resize<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>):
</span></span><span style="display:flex;"><span>    trans <span style="color:#f92672">=</span> transforms<span style="color:#f92672">.</span>Compose([transforms<span style="color:#f92672">.</span>ToTensor(), transforms<span style="color:#f92672">.</span>Resize(size<span style="color:#f92672">=</span>resize)])
</span></span><span style="display:flex;"><span>    mnist_train <span style="color:#f92672">=</span> torchvision<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>FashionMNIST(
</span></span><span style="display:flex;"><span>        root<span style="color:#f92672">=</span>root, train<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, transform<span style="color:#f92672">=</span>trans, download<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    mnist_test <span style="color:#f92672">=</span> torchvision<span style="color:#f92672">.</span>datasets<span style="color:#f92672">.</span>FashionMNIST(
</span></span><span style="display:flex;"><span>        root<span style="color:#f92672">=</span>root, train<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, transform<span style="color:#f92672">=</span>trans, download<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    train_loader <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>DataLoader(dataset<span style="color:#f92672">=</span>mnist_train, batch_size<span style="color:#f92672">=</span>len(mnist_train))
</span></span><span style="display:flex;"><span>    test_loader <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>DataLoader(dataset<span style="color:#f92672">=</span>mnist_test, batch_size<span style="color:#f92672">=</span>len(mnist_test))
</span></span><span style="display:flex;"><span>    train_data, train_target <span style="color:#f92672">=</span> next(iter(train_loader))
</span></span><span style="display:flex;"><span>    test_data, test_target <span style="color:#f92672">=</span> next(iter(test_loader))
</span></span><span style="display:flex;"><span>    torch<span style="color:#f92672">.</span>save((train_data, train_target), <span style="color:#e6db74">&#34;mnist_train_resize.pt&#34;</span>)
</span></span><span style="display:flex;"><span>    torch<span style="color:#f92672">.</span>save((test_data, test_target), <span style="color:#e6db74">&#34;mnist_test_resize.pt&#34;</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Saved successfully.&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OfflineDataset</span>(data<span style="color:#f92672">.</span>Dataset):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, pt_file) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data, self<span style="color:#f92672">.</span>targets <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>load(pt_file)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__len__</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> len(self<span style="color:#f92672">.</span>targets)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__getitem__</span>(self, index):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>data[index], self<span style="color:#f92672">.</span>targets[index]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>preprocess_and_save()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_iter <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>DataLoader(
</span></span><span style="display:flex;"><span>    OfflineDataset(<span style="color:#e6db74">&#34;mnist_train_resize.pt&#34;</span>),
</span></span><span style="display:flex;"><span>    batch_size<span style="color:#f92672">=</span>BATCH_SIZE,
</span></span><span style="display:flex;"><span>    shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    num_workers<span style="color:#f92672">=</span>get_dataloader_workers(),
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>test_iter <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>DataLoader(
</span></span><span style="display:flex;"><span>    OfflineDataset(<span style="color:#e6db74">&#34;mnist_test_resize.pt&#34;</span>),
</span></span><span style="display:flex;"><span>    batch_size<span style="color:#f92672">=</span>BATCH_SIZE,
</span></span><span style="display:flex;"><span>    shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>    num_workers<span style="color:#f92672">=</span>get_dataloader_workers(),
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>我们还可以把它打包成和原本的<code>load_data_fashion_mnist</code>行为一致的加载器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">load_data_offline</span>(batch_size, num_workers<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> num_workers:
</span></span><span style="display:flex;"><span>        num_workers <span style="color:#f92672">=</span> get_dataloader_workers()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>        data<span style="color:#f92672">.</span>DataLoader(
</span></span><span style="display:flex;"><span>            OfflineDataset(<span style="color:#e6db74">&#34;mnist_train_resize.pt&#34;</span>),
</span></span><span style="display:flex;"><span>            batch_size<span style="color:#f92672">=</span>batch_size,
</span></span><span style="display:flex;"><span>            shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>            num_workers<span style="color:#f92672">=</span>num_workers,
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        data<span style="color:#f92672">.</span>DataLoader(
</span></span><span style="display:flex;"><span>            OfflineDataset(<span style="color:#e6db74">&#34;mnist_test_resize.pt&#34;</span>),
</span></span><span style="display:flex;"><span>            batch_size<span style="color:#f92672">=</span>batch_size,
</span></span><span style="display:flex;"><span>            shuffle<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>,
</span></span><span style="display:flex;"><span>            num_workers<span style="color:#f92672">=</span>num_workers,
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>    )
</span></span></code></pre></div><p>测试脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">batch_size_test_offline</span>(batch_size, num_workers):
</span></span><span style="display:flex;"><span>    timer<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    train_iter, test_iter <span style="color:#f92672">=</span> load_data_offline(batch_size, num_workers)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i, (X, y) <span style="color:#f92672">in</span> enumerate(train_iter):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> timer<span style="color:#f92672">.</span>stop()
</span></span><span style="display:flex;"><span>    print(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;offline: batch size: </span><span style="color:#e6db74">{</span>batch_size<span style="color:#e6db74">}</span><span style="color:#e6db74">, num of workers: </span><span style="color:#e6db74">{</span>num_workers<span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>t<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> sec&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> t
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">batch_size_test</span>(batch_size, num_workers):
</span></span><span style="display:flex;"><span>    timer<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>    train_iter, test_iter <span style="color:#f92672">=</span> load_data_fashion_mnist(
</span></span><span style="display:flex;"><span>        batch_size<span style="color:#f92672">=</span>batch_size, resize<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span>, num_workers<span style="color:#f92672">=</span>num_workers
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i, (X, y) <span style="color:#f92672">in</span> enumerate(train_iter):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">pass</span>
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> timer<span style="color:#f92672">.</span>stop()
</span></span><span style="display:flex;"><span>    print(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;online: batch size: </span><span style="color:#e6db74">{</span>batch_size<span style="color:#e6db74">}</span><span style="color:#e6db74">, num of workers: </span><span style="color:#e6db74">{</span>num_workers<span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>t<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> sec&#34;</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> t
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>batch_size_list <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">64</span>]
</span></span><span style="display:flex;"><span>num_workers_list <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> batch_size <span style="color:#f92672">in</span> batch_size_list:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> num_workers <span style="color:#f92672">in</span> num_workers_list:
</span></span><span style="display:flex;"><span>        t_offline <span style="color:#f92672">=</span> batch_size_test_offline(batch_size, num_workers)
</span></span><span style="display:flex;"><span>        t_online <span style="color:#f92672">=</span> batch_size_test(batch_size, num_workers)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;    Speedup ratio:</span><span style="color:#e6db74">{</span>(t_online <span style="color:#f92672">/</span> t_offline)<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>输出结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Saved successfully.
</span></span><span style="display:flex;"><span>offline: batch size: 1, num of workers: 1, 50.77 sec
</span></span><span style="display:flex;"><span>online: batch size: 1, num of workers: 1, 61.14 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.20
</span></span><span style="display:flex;"><span>offline: batch size: 1, num of workers: 2, 38.74 sec
</span></span><span style="display:flex;"><span>online: batch size: 1, num of workers: 2, 43.12 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.11
</span></span><span style="display:flex;"><span>offline: batch size: 1, num of workers: 4, 41.70 sec
</span></span><span style="display:flex;"><span>online: batch size: 1, num of workers: 4, 42.30 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.01
</span></span><span style="display:flex;"><span>offline: batch size: 1, num of workers: 8, 42.96 sec
</span></span><span style="display:flex;"><span>online: batch size: 1, num of workers: 8, 43.82 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.02
</span></span><span style="display:flex;"><span>offline: batch size: 2, num of workers: 1, 26.88 sec
</span></span><span style="display:flex;"><span>online: batch size: 2, num of workers: 1, 35.11 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.31
</span></span><span style="display:flex;"><span>offline: batch size: 2, num of workers: 2, 20.78 sec
</span></span><span style="display:flex;"><span>online: batch size: 2, num of workers: 2, 21.45 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.03
</span></span><span style="display:flex;"><span>offline: batch size: 2, num of workers: 4, 22.06 sec
</span></span><span style="display:flex;"><span>online: batch size: 2, num of workers: 4, 21.86 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:0.99
</span></span><span style="display:flex;"><span>offline: batch size: 2, num of workers: 8, 21.27 sec
</span></span><span style="display:flex;"><span>online: batch size: 2, num of workers: 8, 22.73 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.07
</span></span><span style="display:flex;"><span>offline: batch size: 4, num of workers: 1, 14.37 sec
</span></span><span style="display:flex;"><span>online: batch size: 4, num of workers: 1, 20.35 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.42
</span></span><span style="display:flex;"><span>offline: batch size: 4, num of workers: 2, 11.23 sec
</span></span><span style="display:flex;"><span>online: batch size: 4, num of workers: 2, 10.90 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:0.97
</span></span><span style="display:flex;"><span>offline: batch size: 4, num of workers: 4, 11.27 sec
</span></span><span style="display:flex;"><span>online: batch size: 4, num of workers: 4, 11.97 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.06
</span></span><span style="display:flex;"><span>offline: batch size: 4, num of workers: 8, 10.54 sec
</span></span><span style="display:flex;"><span>online: batch size: 4, num of workers: 8, 11.94 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.13
</span></span><span style="display:flex;"><span>offline: batch size: 8, num of workers: 1, 7.77 sec
</span></span><span style="display:flex;"><span>online: batch size: 8, num of workers: 1, 12.62 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.62
</span></span><span style="display:flex;"><span>offline: batch size: 8, num of workers: 2, 5.91 sec
</span></span><span style="display:flex;"><span>online: batch size: 8, num of workers: 2, 8.09 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.37
</span></span><span style="display:flex;"><span>offline: batch size: 8, num of workers: 4, 6.13 sec
</span></span><span style="display:flex;"><span>online: batch size: 8, num of workers: 4, 5.19 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:0.85
</span></span><span style="display:flex;"><span>offline: batch size: 8, num of workers: 8, 6.25 sec
</span></span><span style="display:flex;"><span>online: batch size: 8, num of workers: 8, 6.36 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.02
</span></span><span style="display:flex;"><span>offline: batch size: 16, num of workers: 1, 4.12 sec
</span></span><span style="display:flex;"><span>online: batch size: 16, num of workers: 1, 7.64 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.85
</span></span><span style="display:flex;"><span>offline: batch size: 16, num of workers: 2, 3.50 sec
</span></span><span style="display:flex;"><span>online: batch size: 16, num of workers: 2, 4.89 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.40
</span></span><span style="display:flex;"><span>offline: batch size: 16, num of workers: 4, 3.28 sec
</span></span><span style="display:flex;"><span>online: batch size: 16, num of workers: 4, 3.38 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.03
</span></span><span style="display:flex;"><span>offline: batch size: 16, num of workers: 8, 3.39 sec
</span></span><span style="display:flex;"><span>online: batch size: 16, num of workers: 8, 3.44 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.02
</span></span><span style="display:flex;"><span>offline: batch size: 32, num of workers: 1, 2.37 sec
</span></span><span style="display:flex;"><span>online: batch size: 32, num of workers: 1, 5.19 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:2.19
</span></span><span style="display:flex;"><span>offline: batch size: 32, num of workers: 2, 1.91 sec
</span></span><span style="display:flex;"><span>online: batch size: 32, num of workers: 2, 3.67 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.92
</span></span><span style="display:flex;"><span>offline: batch size: 32, num of workers: 4, 1.93 sec
</span></span><span style="display:flex;"><span>online: batch size: 32, num of workers: 4, 2.48 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.29
</span></span><span style="display:flex;"><span>offline: batch size: 32, num of workers: 8, 1.98 sec
</span></span><span style="display:flex;"><span>online: batch size: 32, num of workers: 8, 2.05 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.03
</span></span><span style="display:flex;"><span>offline: batch size: 64, num of workers: 1, 1.59 sec
</span></span><span style="display:flex;"><span>online: batch size: 64, num of workers: 1, 4.84 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:3.04
</span></span><span style="display:flex;"><span>offline: batch size: 64, num of workers: 2, 1.32 sec
</span></span><span style="display:flex;"><span>online: batch size: 64, num of workers: 2, 2.91 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:2.21
</span></span><span style="display:flex;"><span>offline: batch size: 64, num of workers: 4, 1.28 sec
</span></span><span style="display:flex;"><span>online: batch size: 64, num of workers: 4, 1.78 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:1.39
</span></span><span style="display:flex;"><span>offline: batch size: 64, num of workers: 8, 0.36 sec
</span></span><span style="display:flex;"><span>online: batch size: 64, num of workers: 8, 1.27 sec
</span></span><span style="display:flex;"><span>    Speedup ratio:3.54
</span></span></code></pre></div><p>在batch_size较小的时候，使用离线加载的策略优化效果并不明显，但是当batch_size达到64时，1线程下离线加载可以达到3.04的加速比，可知计算量越大，离线加载的收益越大。此外，当batch_size为32时随着workers数变大，离线加载用时基本不变甚至有所增长，意味着num_workers的边界收益在离线加载下会更早体现。最神迹的是，当batch_size为64，num_workers为8时，离线加载整个数据集只需要用0.36秒。相较于开始时的接近1分钟，速度提升了两个数量级。</p>
<h3 id="q3查阅框架的在线api文档还有哪些其他数据集可用">Q3：查阅框架的在线API文档。还有哪些其他数据集可用？<a href="#q3%e6%9f%a5%e9%98%85%e6%a1%86%e6%9e%b6%e7%9a%84%e5%9c%a8%e7%ba%bfapi%e6%96%87%e6%a1%a3%e8%bf%98%e6%9c%89%e5%93%aa%e4%ba%9b%e5%85%b6%e4%bb%96%e6%95%b0%e6%8d%ae%e9%9b%86%e5%8f%af%e7%94%a8" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><a href="https://docs.pytorch.org/vision/stable/datasets.html#built-in-datasets">torchvision</a></p>
<h1 id="softmax回归的从零开始实现">softmax回归的从零开始实现<a href="#softmax%e5%9b%9e%e5%bd%92%e7%9a%84%e4%bb%8e%e9%9b%b6%e5%bc%80%e5%a7%8b%e5%ae%9e%e7%8e%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> IPython <span style="color:#f92672">import</span> display
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>train_iter, test_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_data_fashion_mnist(BATCH_SIZE)
</span></span></code></pre></div><p>d2l库直接帮我们省略了加载fashion_mnist的具体实现步骤。</p>
<p>在我们本节的softmax回归模型中，我们并没有去讨论像素点空间位置对于结果判断的影响，这意味着对我们而言，所有的像素点都是等价的。一个$28 \cdot 28$的张量对我们而言和一个长784的向量没有什么区别。所以，我们直接展平每个图像，并把每个像素点看成一个特征。
</p>
$$
\hat{y} = X \cdot W + b
$$<p>
因为我们最后会将这个图像进行分类，有10个目标类别，所以回顾我们前面的线性模型知识，我们可以知道在本模型中权重将会构成一个$784 \cdot 10$的矩阵，而偏置则会构成一个$1 \cdot 10$的行向量。（注意如上公式中的$X$为一个batch，每一行为一个图片向量。b会进行广播计算，$\hat{y}$的形状会是$batch size \cdot 10$。）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>num_input <span style="color:#f92672">=</span> <span style="color:#ae81ff">784</span>
</span></span><span style="display:flex;"><span>num_output <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>W <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, size<span style="color:#f92672">=</span>(num_input, num_output), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>b <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(num_output, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p>经过上面的计算，$\hat{y}$的每一行代表一个样本对于每种分类的原始打分，即logits。现在我们需要对$\hat{y}$的每一行进行softmax计算。即：先对$\hat{y}$的所有元素求exp，随后对于每一行求和得到规范化常数，随后对每一行的所有元素除以该行的规范化常数，得到概率。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">softmax</span>(X):
</span></span><span style="display:flex;"><span>    X_exp <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>exp(X)
</span></span><span style="display:flex;"><span>    partiton <span style="color:#f92672">=</span> X_exp<span style="color:#f92672">.</span>sum(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, keepdim<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> X_exp<span style="color:#f92672">/</span>partiton
</span></span></code></pre></div><p>虽然这样做也可以运行，但是当矩阵中出现了非常大或者非常小的数字很可能会导致数据溢出。此时我们可以使用一种叫做<strong>Log-Sum-Exp</strong>的技巧（此事在triton自学笔记中亦有记载），先寻找每个样本中最大的logit，然后让所有样本的所有元素减去该样本中最大元素的值，再进行softmax计算，得到的结果是一致的，同时防止了数据过大导致的潜在溢出。</p>
<p>改进版：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">softmax</span>(X: torch<span style="color:#f92672">.</span>Tensor):
</span></span><span style="display:flex;"><span>    X <span style="color:#f92672">=</span> X <span style="color:#f92672">-</span> X<span style="color:#f92672">.</span>max(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, keepdim<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)<span style="color:#f92672">.</span>values
</span></span><span style="display:flex;"><span>    X_exp <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>exp(X)
</span></span><span style="display:flex;"><span>    partition <span style="color:#f92672">=</span> X_exp<span style="color:#f92672">.</span>sum(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, keepdim<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> X_exp <span style="color:#f92672">/</span> partition
</span></span></code></pre></div><p>随便一个测试代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>X <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, (<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">5</span>))
</span></span><span style="display:flex;"><span>X_prob <span style="color:#f92672">=</span> softmax(X)
</span></span><span style="display:flex;"><span>print(X, <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>,X_prob)
</span></span></code></pre></div><p>输出结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tensor([[ <span style="color:#ae81ff">1.2374</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.4810</span>,  <span style="color:#ae81ff">0.2318</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.8470</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.6407</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.1617</span>,  <span style="color:#ae81ff">0.6448</span>,  <span style="color:#ae81ff">1.3492</span>,  <span style="color:#ae81ff">0.0251</span>,  <span style="color:#ae81ff">0.7857</span>]]) 
</span></span><span style="display:flex;"><span> tensor([[<span style="color:#ae81ff">0.5851</span>, <span style="color:#ae81ff">0.0386</span>, <span style="color:#ae81ff">0.2140</span>, <span style="color:#ae81ff">0.0728</span>, <span style="color:#ae81ff">0.0895</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">0.0865</span>, <span style="color:#ae81ff">0.1939</span>, <span style="color:#ae81ff">0.3921</span>, <span style="color:#ae81ff">0.1043</span>, <span style="color:#ae81ff">0.2232</span>]])
</span></span></code></pre></div><p>符合预期。</p>
<p>定义模型。我们使用数据集加载器加载的图像并没有进行展开，此处我们需要手动reshape一下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">net</span>(X:torch<span style="color:#f92672">.</span>Tensor):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> softmax(torch<span style="color:#f92672">.</span>matmul(X<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, W<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])), W) <span style="color:#f92672">+</span> b)
</span></span></code></pre></div><p>定义损失函数。正如我们前面花大篇幅铺垫的，我们会尝试实现交叉熵损失函数。交叉熵越大，表示模型预测的混乱程度越大，而只有当模型对分类计算得到的概率与真实概率一致时，交叉熵才会达到最低值。具体实现即所谓的负对数似然。</p>
<p>在我们的训练集中，真实概率就是独热标签，记作$y$，而预测概率记作$\hat{y}$。而独热标签有一个特点：只有答案是1，其他都是0。在真实的数据集中，$y$的存在形式为一个一维张量，每个元素表示该样本中真实分类对应的索引。以防你忘记，交叉熵表示为$H=-y\log \hat{y}$，其中$y$对应的概率永远为1，所以我们只需要对对应的$\hat{y}$值进行负对数计算即可。</p>
<p>具体实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cross_entropy</span>(y_hat:torch<span style="color:#f92672">.</span>Tensor, y:torch<span style="color:#f92672">.</span>Tensor):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>torch<span style="color:#f92672">.</span>log(y_hat[range(len(y_hat)), y])
</span></span></code></pre></div><p>如上的代码用到了一些高级索引技巧，总之最终的效果就是从每一行都选取了那个真实分类处的预测概率。因为分类问题远多于回归问题，交叉熵损失可以说是机器学习中最常用的损失函数表示法。</p>
<p>除此之外，我们还需要衡量模型的分类精度。我们直接将每个样本中概率最大的分类视作预测值（虽然实际应用中我们可能会投骰子，但是topk截断也是一个经典策略。此处可以视作top1截断。）。假如预测值和真实值一致，我们就认为预测正确。这样，我们就可以得到总的预测正确率。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">accuracy</span>(y_hat:torch<span style="color:#f92672">.</span>Tensor, y:torch<span style="color:#f92672">.</span>Tensor):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(y_hat<span style="color:#f92672">.</span>shape) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">and</span> y_hat<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        y_hat <span style="color:#f92672">=</span> y_hat<span style="color:#f92672">.</span>argmax(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    cmp <span style="color:#f92672">=</span> y_hat<span style="color:#f92672">.</span>type(y<span style="color:#f92672">.</span>dtype) <span style="color:#f92672">==</span> y
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> float(cmp<span style="color:#f92672">.</span>type(y<span style="color:#f92672">.</span>dtype)<span style="color:#f92672">.</span>sum())
</span></span></code></pre></div><p><code>torch.argmax</code>的功能是得到一个由最大值的索引构成的张量。通过对$\hat{y}$做argmax计算，我们实际得到了我们的top1预测结果。因为双等号类型敏感，所以我们先将<code>y_hat</code>强制转换为和y一样的数据类型再进行比较，随后求和即得到预测正确的个数。</p>
<p>同样，对于任意数据迭代器<code>data_iter</code>可访问的数据集， 我们可以评估在任意模型<code>net</code>的精度。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Accumulator</span>:  <span style="color:#75715e">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;在n个变量上累加&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(self, n):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0.0</span>] <span style="color:#f92672">*</span> n
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(self, <span style="color:#f92672">*</span>args):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> [a <span style="color:#f92672">+</span> float(b) <span style="color:#66d9ef">for</span> a, b <span style="color:#f92672">in</span> zip(self<span style="color:#f92672">.</span>data, args)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reset</span>(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>data <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0.0</span>] <span style="color:#f92672">*</span> len(self<span style="color:#f92672">.</span>data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__getitem__</span>(self, idx):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>data[idx]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">evaluate_accuracy</span>(net, data_iter):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isinstance(net, torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>        net<span style="color:#f92672">.</span>eval()
</span></span><span style="display:flex;"><span>    metric <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>Accumulator(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> data_iter:
</span></span><span style="display:flex;"><span>            metric<span style="color:#f92672">.</span>add(accuracy(net(X), y), y<span style="color:#f92672">.</span>numel())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> metric[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">/</span>metric[<span style="color:#ae81ff">1</span>]
</span></span></code></pre></div><p>此处定义了一个辅助类累加器，专门用来处理多变量的累加问题。</p>
<p>由于我们使用随机权重初始化<code>net</code>模型，尚未进行任何训练，此时模型的准确度应该近似于随机猜测。因为我们有10个类别，所以此时的准确率应该大概在0.1左右。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        W <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, size<span style="color:#f92672">=</span>(num_input, num_output), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        b <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(num_output, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    print(evaluate_accuracy(net, test_iter))
</span></span></code></pre></div><p>某次输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ae81ff">0.0996</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0.1085</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0.0554</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0.0962</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0.0662</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0.0427</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0.1133</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0.111</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0.1262</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0.1091</span>
</span></span></code></pre></div><p>符合预期。</p>
<h2 id="训练-1">训练<a href="#%e8%ae%ad%e7%bb%83-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>训练部分代码很大程度上和线性回归模型类似，训练函数会接受四个参数：<code>net</code>，表示神经网络，期待的数据类型为<code>torch.nn.Module</code>或者一个普通的函数，如果是<code>torch.nn.Module</code>则将其设置为训练模式；<code>train_iter</code>，表示数据加载器调用得到的迭代器，每次调用返回一个batch的训练数据；<code>loss</code>，表示损失函数，接受一个$\hat{y}$张量和$y$张量，计算总的标量损失值；<code>updater</code>，表示优化器，用来优化参数。</p>
<p>具体的实现如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train_epoch_ch3</span>(net, train_iter, loss, updater):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isinstance(net, torch<span style="color:#f92672">.</span>nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>        net<span style="color:#f92672">.</span>train()
</span></span><span style="display:flex;"><span>    metric <span style="color:#f92672">=</span> Accumulator(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> train_iter:
</span></span><span style="display:flex;"><span>        y_hat <span style="color:#f92672">=</span> net(X)
</span></span><span style="display:flex;"><span>        l: torch<span style="color:#f92672">.</span>Tensor <span style="color:#f92672">=</span> loss(y_hat, y)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> isinstance(updater, torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>Optimizer):
</span></span><span style="display:flex;"><span>            updater<span style="color:#f92672">.</span>zero_grad()
</span></span><span style="display:flex;"><span>            l<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>            updater<span style="color:#f92672">.</span>step()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            l<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>            updater(X<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>        metric<span style="color:#f92672">.</span>add(float(l<span style="color:#f92672">.</span>sum()), accuracy(y_hat, y), y<span style="color:#f92672">.</span>numel())
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> metric[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">/</span> metric[<span style="color:#ae81ff">2</span>], metric[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">/</span> metric[<span style="color:#ae81ff">2</span>]
</span></span></code></pre></div><p>这里使用了一个<code>Accumulator</code>来存储训练过程中的总损失、总命中个数，以及总的样本数（<code>torch.numel()</code>得到的是一个张量的总元素数）。最终<code>metric[0]/metric[2]</code>得到的是每个样本的平均损失，<code>metric[1]/metric[2]</code>得到的则是命中率。</p>
<p>d2l中给出了一个<code>Animator</code>类，这个类的作用是绘制图像，但是过程是动态的，向其中添加新数据并不会生成新的静态图片而是会实现动画的效果，同时支持多曲线、自动配置范围和缩放比例。但是这个类的设计完全面向jupyter notebook环境，普通的py文件运行不会有任何效果。</p>
<p>以下是使用plotext重写过的<code>Animator</code>类，并且行为和原型一致。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Animator</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;在终端中使用 plotext 动态绘制数据&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">__init__</span>(
</span></span><span style="display:flex;"><span>        self,
</span></span><span style="display:flex;"><span>        xlabel<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        ylabel<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        legend<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        xlim<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        ylim<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        xscale<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;linear&#34;</span>,
</span></span><span style="display:flex;"><span>        yscale<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;linear&#34;</span>,
</span></span><span style="display:flex;"><span>        fmts<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        nrows<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        ncols<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        figsize<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>        theme<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;pro&#34;</span>,
</span></span><span style="display:flex;"><span>    ):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 初始化存储</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>xlabel <span style="color:#f92672">=</span> xlabel
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ylabel <span style="color:#f92672">=</span> ylabel
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>legend <span style="color:#f92672">=</span> legend <span style="color:#66d9ef">if</span> legend <span style="color:#66d9ef">else</span> []
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>xlim <span style="color:#f92672">=</span> xlim
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>ylim <span style="color:#f92672">=</span> ylim
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>xscale <span style="color:#f92672">=</span> xscale
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>yscale <span style="color:#f92672">=</span> yscale
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>theme <span style="color:#f92672">=</span> theme
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 存储所有历史点，以便重绘</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>X, self<span style="color:#f92672">.</span>Y <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>, <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 终端不需要 figsize，但可以设置 plotsize (宽, 高)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> figsize:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># 将 matplotlib 的 figsize(英寸) 粗略转换为终端字符行列数</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>plotsize(int(figsize[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">20</span>), int(figsize[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(self, x, y):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 1. 数据格式标准化 (与原代码逻辑一致)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> hasattr(y, <span style="color:#e6db74">&#34;__len__&#34;</span>):
</span></span><span style="display:flex;"><span>            y <span style="color:#f92672">=</span> [y]
</span></span><span style="display:flex;"><span>        n <span style="color:#f92672">=</span> len(y)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> hasattr(x, <span style="color:#e6db74">&#34;__len__&#34;</span>):
</span></span><span style="display:flex;"><span>            x <span style="color:#f92672">=</span> [x] <span style="color:#f92672">*</span> n
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>X:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>X <span style="color:#f92672">=</span> [[] <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(n)]
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>Y:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>Y <span style="color:#f92672">=</span> [[] <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(n)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 2. 存入新数据</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i, (a, b) <span style="color:#f92672">in</span> enumerate(zip(x, y)):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> a <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">and</span> b <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>X[i]<span style="color:#f92672">.</span>append(a)
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>Y[i]<span style="color:#f92672">.</span>append(b)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 3. 核心绘制逻辑</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>clf()  <span style="color:#75715e"># 清除当前的数据</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>clear_terminal()  <span style="color:#75715e"># 清除终端屏幕，实现“原地更新”动画效果</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 4. 绘制所有曲线</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(self<span style="color:#f92672">.</span>X)):
</span></span><span style="display:flex;"><span>            lbl <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>legend[i] <span style="color:#66d9ef">if</span> i <span style="color:#f92672">&lt;</span> len(self<span style="color:#f92672">.</span>legend) <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>plot(self<span style="color:#f92672">.</span>X[i], self<span style="color:#f92672">.</span>Y[i], label<span style="color:#f92672">=</span>lbl)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 5. 配置坐标轴 (复刻 config_axes)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>xlabel:
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>xlabel(self<span style="color:#f92672">.</span>xlabel)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>ylabel:
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>ylabel(self<span style="color:#f92672">.</span>ylabel)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>xlim:
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>xlim(self<span style="color:#f92672">.</span>xlim[<span style="color:#ae81ff">0</span>], self<span style="color:#f92672">.</span>xlim[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>ylim:
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>ylim(self<span style="color:#f92672">.</span>ylim[<span style="color:#ae81ff">0</span>], self<span style="color:#f92672">.</span>ylim[<span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>xscale:
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>xscale(self<span style="color:#f92672">.</span>xscale)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>yscale:
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>yscale(self<span style="color:#f92672">.</span>yscale)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>theme:
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>theme(self<span style="color:#f92672">.</span>theme)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 6. 显示</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>show()
</span></span></code></pre></div><p>接下来我们还需要实现一个整体的训练函数，用来自动完成多个迭代周期并评估模型和进行animator可视化。（懒得解释了，总是就是这么写然后就能工作了）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train_ch3</span>(net, train_iter, test_iter, loss, num_epoches, updater):
</span></span><span style="display:flex;"><span>    animator <span style="color:#f92672">=</span> Animator(
</span></span><span style="display:flex;"><span>        xlabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;epoch&#34;</span>,
</span></span><span style="display:flex;"><span>        xlim<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1</span>, num_epoches],
</span></span><span style="display:flex;"><span>        ylim<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0.3</span>, <span style="color:#ae81ff">0.9</span>],
</span></span><span style="display:flex;"><span>        legend<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;train_loss&#34;</span>, <span style="color:#e6db74">&#34;train_acc&#34;</span>, <span style="color:#e6db74">&#34;test_acc&#34;</span>],
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epoches):
</span></span><span style="display:flex;"><span>        train_metrics <span style="color:#f92672">=</span> train_epoch_ch3(net, train_iter, loss, updater)
</span></span><span style="display:flex;"><span>        test_acc <span style="color:#f92672">=</span> evaluate_accuracy(net, test_iter)
</span></span><span style="display:flex;"><span>        animator<span style="color:#f92672">.</span>add(epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, train_metrics <span style="color:#f92672">+</span> (test_acc,))
</span></span><span style="display:flex;"><span>    train_loss, train_acc <span style="color:#f92672">=</span> train_metrics
</span></span></code></pre></div><p>进行训练：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>lr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">updater</span>(batch_size):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> d2l<span style="color:#f92672">.</span>sgd([W, b], lr, batch_size)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NUM_EPOCHES <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_ch3(net, train_iter, test_iter, cross_entropy, NUM_EPOCHES, updater)
</span></span></code></pre></div><p>效果：</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/index-20260204-1.png" alt=""></p>
<p>经过10次迭代，模型对训练数据预测的命中率达到了约85%，并且对于测试集的命中率也基本保持在相同水平。</p>
<h1 id="softmax回归的简洁实现">Softmax回归的简洁实现<a href="#softmax%e5%9b%9e%e5%bd%92%e7%9a%84%e7%ae%80%e6%b4%81%e5%ae%9e%e7%8e%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>使用torch高级api的实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>train_iter, test_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_data_fashion_mnist(batch_size<span style="color:#f92672">=</span>BATCH_SIZE)
</span></span></code></pre></div><p>我们的模型实际由两层组成：展平层，负责把图像降维打击；全连接层，实现softmax回归。因此，通过如下方式初始化模型参数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>net <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(nn<span style="color:#f92672">.</span>Flatten(), nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">784</span>, <span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init_weight</span>(m:nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> type(m) <span style="color:#f92672">is</span> nn<span style="color:#f92672">.</span>Linear:
</span></span><span style="display:flex;"><span>        nn<span style="color:#f92672">.</span>init<span style="color:#f92672">.</span>normal_(m<span style="color:#f92672">.</span>weight, mean<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, std<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>net<span style="color:#f92672">.</span>apply(init_weight)
</span></span></code></pre></div><p>此处使用了<code>Sequential</code>的<code>apply</code>方法，可以递归地让所有子模型执行这个函数来初始化参数。</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/index-20260204-2.png" alt=""></p>
<p>d2l这里终于提到safe softmax的思想了，但是话说的疑似有点过于详细了。此处偷一下d2l里的数学表达式。</p>
$$
\begin{aligned}
\hat y_j & =  \frac{\exp(o_j - \max(o_k))\exp(\max(o_k))}{\sum_k \exp(o_k - \max(o_k))\exp(\max(o_k))} \\
& = \frac{\exp(o_j - \max(o_k))}{\sum_k \exp(o_k - \max(o_k))}.
\end{aligned}
$$<p>
简单来说，$softmax(x)=softmax(x-c)$，我们可以对所有数据添加一个共同的位移，得到的softmax结果并不会发生改变。当计算exp数值时，一些极端大的数据可能会超出数据类型允许的范围（虽然python原生的数字几乎没有位数限制，但是torch出于性能考量，其数据大多都有位数限制）。所以，在计算exp之前减去所有数据中最大的那一项，我们就可以避免exp数值上溢的问题。这就是所谓的safe softmax。</p>
<p>然而，尽管说是safe，当所有数据减去最大值之后又会出现另一问题：有的数据疑似负的有点多了，导致exp算出来的结果和0太接近，数据类型精度不够，导致向下溢出。</p>
<p>对此我们的解决方法是，虽然我们期望模型的概率输出要按照softmax计算的结果来，得到的数字是$e$指数的分式，但是训练的过程中损失计算并不直接使用这个值，而是使用其对数。对数+exp不就消掉了吗。所以我们实际上可以完全逃掉exp计算可能导致的上下溢出问题。
</p>
$$
\begin{aligned}
\log{(\hat y_j)} & = \log\left( \frac{\exp(o_j - \max(o_k))}{\sum_k \exp(o_k - \max(o_k))}\right) \\
& = \log{(\exp(o_j - \max(o_k)))}-\log{\left( \sum_k \exp(o_k - \max(o_k)) \right)} \\
& = o_j - \max(o_k) -\log{\left( \sum_k \exp(o_k - \max(o_k)) \right)}.
\end{aligned}
$$<p>此处放送一段<code>nn.CrossEntropyLoss</code>的文档描述。</p>
<blockquote>
<p>This criterion computes the cross entropy loss between input logits
and target.</p>
<p>It is useful when training a classification problem with <code>C</code> classes.
If provided, the optional argument <code>weight</code> should be a 1D <code>Tensor</code>
assigning weight to each of the classes.
This is particularly useful when you have an unbalanced training set.</p>
<p>The <code>input</code> is expected to contain the unnormalized logits for each class (which do <code>not</code> need
to be positive or sum to 1, in general).
<code>input</code> has to be a Tensor of size $(C)$ for unbatched input,
$(minibatch, C)$ or $(minibatch, C, d_1, d_2, ..., d_K)$ with $K \geq 1$ for the
<code>K</code>-dimensional case. The last being useful for higher dimension inputs, such
as computing cross entropy loss per-pixel for 2D images.</p>
<p>The <code>target</code> that this criterion expects should contain either:</p>
<ul>
<li>
<p>Class indices in the range $[0, C)$ where $C$ is the number of classes; if
<code>ignore_index</code> is specified, this loss also accepts this class index (this index
may not necessarily be in the class range). The unreduced (i.e. with <code>reduction</code>
set to <code>'none'</code>) loss for this case can be described as:</p>
$$
   \ell(x, y) = L = \{l_1,\dots,l_N\}^\top, \quad
   l_n = - w_{y_n} \log \frac{\exp(x_{n,y_n})}{\sum_{c=1}^C \exp(x_{n,c})}
   \cdot \mathbb{1}\{y_n \not= \text{ignore\_index}\}
   $$<p>where $x$ is the input, $y$ is the target, $w$ is the weight,
$C$ is the number of classes, and $N$ spans the minibatch dimension as well as
$d_1, ..., d_k$ for the <code>K</code>-dimensional case. If
<code>reduction</code> is not <code>'none'</code> (default <code>'mean'</code>), then</p>
$$
   \ell(x, y) = \begin{cases}
       \sum_{n=1}^N \frac{1}{\sum_{n=1}^N w_{y_n} \cdot \mathbb{1}\{y_n \not= \text{ignore\_index}\}} l_n, &
        \text{if reduction} = \text{`mean';}\\
         \sum_{n=1}^N l_n,  &
         \text{if reduction} = \text{`sum'.}
     \end{cases}
   $$<p>Note that this case is equivalent to applying <code>LogSoftmax</code>
on an input, followed by <code>NLLLoss</code>.</p>
</li>
<li>
<p>Probabilities for each class; useful when labels beyond a single class per minibatch item
are required, such as for blended labels, label smoothing, etc. The unreduced (i.e. with
<code>reduction</code> set to <code>'none'</code>) loss for this case can be described as:</p>
$$
   \ell(x, y) = L = \{l_1,\dots,l_N\}^\top, \quad
   l_n = - \sum_{c=1}^C w_c \log \frac{\exp(x_{n,c})}{\sum_{i=1}^C \exp(x_{n,i})} y_{n,c}
   $$<p>where $x$ is the input, $y$ is the target, $w$ is the weight,
$C$ is the number of classes, and $N$ spans the minibatch dimension as well as
$d_1, ..., d_k$ for the <code>K</code>-dimensional case. If
<code>reduction</code> is not <code>'none'</code> (default <code>'mean'</code>), then</p>
$$
   \ell(x, y) = \begin{cases}
       \frac{\sum_{n=1}^N l_n}{N}, &
        \text{if reduction} = \text{`mean';}\\
         \sum_{n=1}^N l_n,  &
         \text{if reduction} = \text{`sum'.}
     \end{cases}
   $$</li>
</ul>
<p>Note:
The performance of this criterion is generally better when <code>target</code> contains class
indices, as this allows for optimized computation. Consider providing <code>target</code> as
class probabilities only when a single class label per minibatch item is too restrictive.</p>
</blockquote>
<p>简单来说，这是一个专门用来进行交叉熵计算的模型（<code>nn.Module</code>的曾孙子类），轮到它计算的时候，它会接受一个<code>input</code>张量和一个<code>target</code>张量，其中<code>input</code>张量包含的内容是未标准化的原始打分。其内部的具体实现就应用了我们刚提到的数学原理。</p>
<p>总之，精简实现的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> softmax_scratch <span style="color:#f92672">import</span> train_ch3
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">256</span>
</span></span><span style="display:flex;"><span>train_iter, test_iter <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>load_data_fashion_mnist(batch_size<span style="color:#f92672">=</span>BATCH_SIZE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>net <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>Sequential(nn<span style="color:#f92672">.</span>Flatten(), nn<span style="color:#f92672">.</span>Linear(<span style="color:#ae81ff">784</span>, <span style="color:#ae81ff">10</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init_weight</span>(m:nn<span style="color:#f92672">.</span>Module):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> type(m) <span style="color:#f92672">is</span> nn<span style="color:#f92672">.</span>Linear:
</span></span><span style="display:flex;"><span>        nn<span style="color:#f92672">.</span>init<span style="color:#f92672">.</span>normal_(m<span style="color:#f92672">.</span>weight, mean<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, std<span style="color:#f92672">=</span><span style="color:#ae81ff">0.01</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>net<span style="color:#f92672">.</span>apply(init_weight)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loss <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>CrossEntropyLoss(reduction<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;none&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>trainer <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD(net<span style="color:#f92672">.</span>parameters(), lr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num_epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train_ch3(net, train_iter, test_iter, loss, num_epochs, trainer)
</span></span></code></pre></div><p>（看起来很精简，实际上调用了前面写好的训练流程。）</p>
<p>结果和前面基本一致，不再演示。</p>
<h2 id="课后练习-2">课后练习<a href="#%e8%af%be%e5%90%8e%e7%bb%83%e4%b9%a0-2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="q2q1跳了增加迭代周期的数量为什么测试精度会在一段时间后降低我们怎么解决这个问题">Q2（Q1跳了）：增加迭代周期的数量。为什么测试精度会在一段时间后降低？我们怎么解决这个问题？<a href="#q2q1%e8%b7%b3%e4%ba%86%e5%a2%9e%e5%8a%a0%e8%bf%ad%e4%bb%a3%e5%91%a8%e6%9c%9f%e7%9a%84%e6%95%b0%e9%87%8f%e4%b8%ba%e4%bb%80%e4%b9%88%e6%b5%8b%e8%af%95%e7%b2%be%e5%ba%a6%e4%bc%9a%e5%9c%a8%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%e9%99%8d%e4%bd%8e%e6%88%91%e4%bb%ac%e6%80%8e%e4%b9%88%e8%a7%a3%e5%86%b3%e8%bf%99%e4%b8%aa%e9%97%ae%e9%a2%98" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>我们训练个1000次看看。</p>
<p><img src="/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9703%E7%BA%BF%E6%80%A7%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%AE%8C%E7%BB%93/index-20260204-3.png" alt=""></p>
<p>可以看到虽然一开始的一段时间（其实看不太到）<code>test_acc</code>和<code>train_acc</code>基本重合，但是之后两者趋于稳定后<code>test_acc</code>就稳定的低于<code>train_acc</code>了。直观的理解是，当迭代次数过多后，模型会出现<strong>过拟合</strong>现象，模型记住了过多的训练集中的偶然细节，导致虽然对训练集命中概率高，但是泛化能力下降。这就好像把数学书上的例题都背下来，虽然例题会做了，到了考试的时候还是什么都不会。</p>
<p>过拟合最简单的解决方法就是提前终止训练，不训练就不会过拟合。此外常见的方法有正则化，在损失函数里加上权重的L1或L2范数，这样权重的数值就会被约束在一定范围内，限制了模型的复杂度；训练过程中随机丢弃神经元，防止神经元之间相互依赖；在训练模型中加随机噪声；降低模型复杂度。</p>
<hr>
<h1 id="后记">后记：<a href="#%e5%90%8e%e8%ae%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>这一篇超级长文在便秘了一周左右终于写完了。感觉这样边写博客边学习的策略虽然印象是挺深刻，但是效率未免太低了。为了这个月能学完d2l（现在看来不太可能），后面的日志只好水一点了（悲）。</p>
]]></content>
		</item>
		
		<item>
			<title>工具不图鉴04：环境变量&amp;shell脚本</title>
			<link>http://localhost:1313/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/</link>
			<pubDate>Wed, 28 Jan 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>D2L自学日志工程量太大了，学一天给我CPU干烧了，索性学点其他的东西调整一下。因为很长一段时间自己从来没有正经的研究过什么是环境变量以及怎么写shell脚本，遇到这种事情都让ai来完成，最近时常感觉自己的环境有点乱糟糟的。归根结底，这种事情还是要自己知道怎么做的好。</p>
<h1 id="参考链接">参考链接：<a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p><a href="https://chihokyo.com/post/6/">某篇google上随机刷到的博客</a></p>
<p><a href="https://zh.wikipedia.org/zh-cn/%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">环境变量wiki</a></p>
<p><a href="https://github.com/alebcay/awesome-shell">某个实用工具清单仓库</a></p>
<h1 id="什么是环境变量">什么是环境变量？<a href="#%e4%bb%80%e4%b9%88%e6%98%af%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>在回答这个问题之前，我们不妨思考一下：</p>
<h2 id="什么是变量">什么是“变量”？<a href="#%e4%bb%80%e4%b9%88%e6%98%af%e5%8f%98%e9%87%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>即使折腾了有段时间linux，实话说我很少遇到普通变量。但是它们确实存在。我觉得一个比较正确的看待变量的角度是把shell看做一个和python类似的东西，shell可以输一行指令运行一次，python开启交互模式也可以输一行代码运行一次；shell允许你写复杂的shell脚本，python也允许你组织复杂的工程。只不过前者本质是一个实用工具，后者至少打的旗号是一个编程语言。</p>
<p>我们先用Python举一个简单的例子：</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260128-1.png" alt=""></p>
<p>只要你的电脑安装了python，你就可以随时在命令行中输入<code>python</code>来进入交互模式。我们可以开始时定义一个变量<code>a</code>，然后在接下来的交互中调用它或者修改它。</p>
<p>shell自身的普通变量也有类似的功能，同样一个简单的例子：</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260128-2.png" alt=""></p>
<p>你完全可以把shell看做是一个基本只运行交互模式的python。只不过shell的变量有以下特殊的语法规则：</p>
<ul>
<li>定义变量时等号左右不能有空格，比如你必须写<code>a=3</code>而不是<code>a = 3</code>，虽然后者看起来更加顺眼。</li>
<li>调用变量的时候必须在变量名之前加<code>$</code>。</li>
<li>对变量进行数学计算的时候需要使用两个圆括号括起来。</li>
</ul>
<p>如果你好奇你的当前环境下有哪些变量，你可以输入<code>set</code>指令来查看所有的变量。这里甚至会包含我们刚刚随手写的一个变量a：</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260128-3.png" alt=""></p>
<h2 id="环境变量">环境变量<a href="#%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>虽然普通变量看起来已经可以做很多事情了，但是它有一个显著的局限：它<strong>只能作用于当前的shell进程</strong>，甚至没办法作用到任何子进程。假如你运行了一个程序，那么这个程序是读取不到你的普通变量的，或者假如你新开了一个窗口，那么新的shell进程中也是不会有原窗口的普通变量。</p>
<p>环境变量虽然也不能直接存活在所有窗口，但是相较于普通变量，环境变量的一个重要特点是允许子进程读取。很多的应用会读取一些通用的环境变量来获取目录结构信息以及用户信息，用户也可以通过修改环境变量来配置一些应用的行为。</p>
<p>在进一步了解环境变量之前，我们最好先来了解一些常用的和变量相关的指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>echo $VAR
</span></span></code></pre></div><p><code>echo</code>指令的作用是在你的终端上打印指定的东西。你可以让它打印一个变量的内容，也可以打印字符串。如果你想让你的脚本比较人性化的话你可以考虑多打印一点提示内容。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>export VAR<span style="color:#f92672">=</span>var
</span></span></code></pre></div><p>声明一个变量为环境变量。如果没有export关键字的话默认为普通变量。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>env
</span></span></code></pre></div><p>查看所有的环境变量。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>unset VAR
</span></span></code></pre></div><p>删除一个变量。</p>
<p>大致就这样。</p>
<h3 id="一些常见的环境变量">一些常见的环境变量：<a href="#%e4%b8%80%e4%ba%9b%e5%b8%b8%e8%a7%81%e7%9a%84%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260128-4.png" alt=""></p>
<ul>
<li>USER：你的名字。如果程序想显示你的名字的时候就会查它。</li>
<li>HOME：家目录。通常就是你的<code>~</code>目录。这是一个路径，存储的形式是字符串。</li>
<li>PWD：当前路径，即运行脚本时你所处的实际路径。写脚本的时候可能会很有用。</li>
</ul>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260128-5.png" alt=""></p>
<ul>
<li>PATH：这是一个“工具箱搜索清单”，存储的是若干个路径，对应目录下里面装的是可执行文件。当你在命令行里输入一个指令时，系统就会去PATH存储的路径中挨个找你要的名字匹配的可执行文件，找到了就执行，找不到就报错，除非设置了别名。</li>
</ul>
<p>PATH变量中，不同的目录之间通过冒号隔开。一般的添加PATH路径的方式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$HOME<span style="color:#e6db74">/.local/bin:</span>$PATH<span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>PATH本质是一个字符串，所以用双引号包裹。在想要添加的路径之后补上<code>:$PATH</code>来保留原有的PATH路径，如果不加这个的话原有的路径就都没了。</p>
<h3 id="如何让一个环境变量可以在所有shell进程中存在">如何让一个环境变量可以在所有shell进程中存在？<a href="#%e5%a6%82%e4%bd%95%e8%ae%a9%e4%b8%80%e4%b8%aa%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e5%8f%af%e4%bb%a5%e5%9c%a8%e6%89%80%e6%9c%89shell%e8%bf%9b%e7%a8%8b%e4%b8%ad%e5%ad%98%e5%9c%a8" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>修改你的shell的<strong>运行时配置文件</strong>，也就是<code>.xxrc</code>文件。比如如果你用的shell是bash，那么通常在你的家目录下会有一个<code>.bashrc</code>文件。你只需要把你原本在终端中直接输入的<code>export VAR=var</code>原封不动地搬到配置文件中就可以了。如果你用的是zsh，那就应该搬到<code>~/.zshrc</code>中。</p>
<p>在我前两天配置proot游戏运行环境过程中配置了大量的环境变量，其中一些基本不用修改的环境变量便存放在了<code>~/.zshrc</code>中，内容大致如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># ==========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 基础路径与环境</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==========================================</span>
</span></span><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</span></span><span style="display:flex;"><span>export DISPLAY<span style="color:#f92672">=</span>:1
</span></span><span style="display:flex;"><span>export XDG_RUNTIME_DIR<span style="color:#f92672">=</span>/tmp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. Wine WOW64 路径配置</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==========================================</span>
</span></span><span style="display:flex;"><span>export WINE_ROOT<span style="color:#f92672">=</span>$HOME/wine-wow64/wine-11.0-staging-amd64-wow64
</span></span><span style="display:flex;"><span>export WINEPREFIX<span style="color:#f92672">=</span>$HOME/.wine
</span></span><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span>$WINE_ROOT/bin:$PATH
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 确保 Wine 能找到它自己的库文件</span>
</span></span><span style="display:flex;"><span>export LD_LIBRARY_PATH<span style="color:#f92672">=</span>$WINE_ROOT/lib:$WINE_ROOT/lib/wine/x86_64-unix:$LD_LIBRARY_PATH
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. Audio 修复 (基于之前的测试教训)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 解决音频卡顿和死锁的关键：强制通过 TCP 连接宿主 PulseAudio</span>
</span></span><span style="display:flex;"><span>export PULSE_SERVER<span style="color:#f92672">=</span>127.0.0.1
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 增加延迟缓冲，解决爆音和因音频同步导致的画面卡顿 (Steam 环境建议 60-100)</span>
</span></span><span style="display:flex;"><span>export PULSE_LATENCY_MSEC<span style="color:#f92672">=</span><span style="color:#ae81ff">60</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. Box64 性能与转译优化 (针对 8 Gen 3)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 日志级别：0=仅报错, 1=基本信息。平时建议设为 0 或 1，设太高会拖慢 I/O</span>
</span></span><span style="display:flex;"><span>export BOX64_LOG<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启大块编译：显著提升 CPU 密集型任务性能 (如游戏逻辑)</span>
</span></span><span style="display:flex;"><span>export BOX64_DYNAREC_BIGBLOCK<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 强内存模型：解决 Unity 引擎和多线程游戏死锁/崩溃问题 (骁龙必须开)</span>
</span></span><span style="display:flex;"><span>export BOX64_DYNAREC_STRONGMEM<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安全标志位：防止非法指令崩溃</span>
</span></span><span style="display:flex;"><span>export BOX64_DYNAREC_SAFEFLAGS<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Box64 辅助路径</span>
</span></span><span style="display:flex;"><span>export BOX64_PATH<span style="color:#f92672">=</span>$WINE_ROOT/bin/
</span></span><span style="display:flex;"><span>export BOX64_LD_LIBRARY_PATH<span style="color:#f92672">=</span>$WINE_ROOT/lib/wine/x86_64-unix/:$WINE_ROOT/lib/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. 图形驱动 (Turnip + Zink)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># [重要] 请确认此文件路径真实存在，否则无法加载驱动</span>
</span></span><span style="display:flex;"><span>export VK_ICD_FILENAMES<span style="color:#f92672">=</span>/root/test/freedreno_icd.aarch64.json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 强制 Wine/Linux 程序使用 Zink (OpenGL over Vulkan)</span>
</span></span><span style="display:flex;"><span>export MESA_LOADER_DRIVER_OVERRIDE<span style="color:#f92672">=</span>zink
</span></span><span style="display:flex;"><span>export GALLIUM_DRIVER<span style="color:#f92672">=</span>zink
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Turnip 驱动内存分配修复 (防止显存分配崩溃)</span>
</span></span><span style="display:flex;"><span>export TU_DEBUG<span style="color:#f92672">=</span>sysmem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Zink 优化：延迟描述符更新，可提升部分 DX9/DX11 游戏帧数</span>
</span></span><span style="display:flex;"><span>export ZINK_DESCRIPTORS<span style="color:#f92672">=</span>lazy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>export WINEDEBUG<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-file,-mountmgr,-event&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6. 调试辅助 (可选，平时可注释掉)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ==========================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 显示 DXVK 帧数和显卡信息 (如果你装了 DXVK)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># export DXVK_HUD=fps,devinfo,version</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 显示 Mesa/Zink 帧数 (如果你没用 DXVK)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># export GALLIUM_HUD=fps</span>
</span></span></code></pre></div><p>（看到这么激情洋溢的注释就知道是ai写的了&hellip;）</p>
<p>每次进入proot环境，系统会花一点时间打开zsh，这一过程中系统就会首先运行<code>~/.zshrc</code>中的shell指令，所以将环境变量写在这里，每次启动shell就会自动添加这些环境变量。</p>
<h1 id="shell脚本">shell脚本<a href="#shell%e8%84%9a%e6%9c%ac" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>一个helloworld地位的脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Hello world!&#34;</span>
</span></span></code></pre></div><p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260128-6.png" alt=""></p>
<p>shell script虽然定位上被认为是“脚本语言”而非通用型语言，但是脚本语言也是编程语言的一种。python很多时候也不过就是一个高级一点的通用脚本。所以此处你完全可以把<code>.sh</code>和<code>.py</code>看做是一类东西。</p>
<p>现在我们来拆解一下这个helloworld代码的组成。</p>
<h2 id="usrbinenv-bash">#!/usr/bin/env bash<a href="#usrbinenv-bash" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>这个东西的专业术语是<strong>Shebang</strong>，它的作用是告诉系统内核这个文件不是一个可以直接执行的二进制文件，而是一个需要解释器才能运行的脚本文件，<code>#!</code>后放的就是解释器的文件路径。</p>
<p>然而，你可能会注意到<code>#!/usr/bin/env bash</code>似乎并不是直接代表了一个解释器路径，这里其实是一种常见的变体。<code>env</code>是一个存在于<code>/usr/bin</code>的二进制文件，它的位置一般来说是稳定不变的，但是在不同人的电脑上，解释器的位置是很有可能变化的。<code>env</code>后加一个程序名表示的就是在PATH环境变量中寻找对应的解释器。这样不管解释器在哪，脚本都可以正常运行。</p>
<p>常见的shell script解释器有sh或者dash，属于标准的POSIX shell，功能较少但是速度较快，bash会比较中规中矩，而且一般机器上都会有。zsh会有一些高级特性。</p>
<p>此外，既然Shebang只是规定必须写一个解释器路径，其实我们不止可以写shell script，还可以写python。你只需要把Shebang中的bash换成python，后面的脚本用python语法写，完全可以正常运行。</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260129-1.png" alt=""></p>
<h2 id="chmod-x-">chmod +x &hellip;<a href="#chmod-x-" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>chmod，即<strong>Ch</strong>ange <strong>Mod</strong>e。脚本写完之后无法直接运行，需要使用chmod为它添加执行权限。三种基本权限即rwx，对应读取权限、写入权限，以及执行权限。对于个人电脑来说我们很少会接触到用户组的概念，所以一般最常见的用法就是<code>chmod +x &lt;file_name&gt;</code>来为脚本添加执行权限，或者<code>chmod -x &lt;file_name&gt;</code>来取消脚本的执行权限。</p>
<h1 id="一些常见的脚本写法">一些常见的脚本写法<a href="#%e4%b8%80%e4%ba%9b%e5%b8%b8%e8%a7%81%e7%9a%84%e8%84%9a%e6%9c%ac%e5%86%99%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Enter a numble:&#34;</span>
</span></span><span style="display:flex;"><span>read NUMBLE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $NUMBLE -gt <span style="color:#ae81ff">10</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;The numble is greater than 10.&#34;</span>
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> $NUMBLE -eq <span style="color:#ae81ff">10</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;The numble is equal to 10.&#34;</span>
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;The numble is less than 10.&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span> 
</span></span></code></pre></div><p>这个简单的例子里涉及了shell script的条件判断写法。在shell script中<code>-gt</code>代表大于，<code>-eq</code>代表等于，<code>-lt</code>表示小于。此外需要注意变量取值必须在变量名前加<code>$</code>（比C语言还繁琐是我没想到的）。shell script是一个弱类型语言，无需显示声明类型，所有的变量会默认存储为字符串。</p>
<p>注意中括号和中间的关键字和标识符之间需要留有空格，中括号之后要加分号。shell script对于空格、分号和中括号非常敏感。分支结构最后需要加上<code>fi</code>表示结束。</p>
<p>运行效果：</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260129-2.png" alt=""></p>
<p>for循环写法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Generating three test files...&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i in <span style="color:#f92672">{</span>1..3<span style="color:#f92672">}</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  touch <span style="color:#e6db74">&#34;test_file_</span>$i<span style="color:#e6db74">.txt&#34;</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;File NO.</span>$i<span style="color:#e6db74"> created successfully.&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Mission completed.&#34;</span>
</span></span></code></pre></div><p>创建三个测试用文件（竟然是左闭右闭，简直是异端）。运行结果如下：</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260129-3.png" alt=""></p>
<p>在shell script中有一些特殊的变量由系统自动维护，用来获取脚本参数、运行状态和系统id。</p>
<ul>
<li><code>$0</code>返回运行的脚本文件名（实际是相对于当前位置的相对路径）</li>
<li><code>$1、$2、...</code>表示传给脚本的第1～9个参数。</li>
<li><code>${10}</code>，10及以上需要加花括号。</li>
<li><code>$#</code>传入的参数个数</li>
<li><code>$@</code>传入的所有参数，可以使用for循环遍历（即把参数打包成一个类似python元组的东西）</li>
<li><code>$*</code>把传入的参数看做一个整体的字符串。</li>
<li><code>$?</code>上一个命令退出情况，0为成功，非0为失败。</li>
<li><code>$$</code>当前脚本的进程数。</li>
</ul>
<p>一个求和脚本示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DATE<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>date <span style="color:#e6db74">&#34;+%Y-%m-%d&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;PID: </span>$$<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Date: </span>$DATE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Script name: </span>$0<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;You&#39;ve entered </span>$#<span style="color:#e6db74"> params.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ANS<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> PARAM in <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  ANS<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$ANS <span style="color:#f92672">+</span> PARAM<span style="color:#66d9ef">))</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;The sum is </span>$ANS<span style="color:#e6db74">.&#34;</span>
</span></span></code></pre></div><p>结果：</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260130-1.png" alt=""></p>
<p>shell的for循环语法和python看起来似乎很相似。比如，你可以这么写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> name in Alice Bob Charlie; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Hello </span>$name<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>结果输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Hello Alice
</span></span><span style="display:flex;"><span>Hello Bob
</span></span><span style="display:flex;"><span>Hello Charlie
</span></span></code></pre></div><p>shell script中一个更强大的功能是通配符遍历。比如，如果你想罗列一个目录下的所有pdf文件，你可以这么写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>count<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> file in *.pdf; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;pdf </span>$count<span style="color:#e6db74">: </span>$file<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  count<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>$count <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">))</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>效果：</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260130-2.png" alt=""></p>
<p>如果你想使用C风格的数值循环，此处记录一下写法，不再实验。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#f92672">((</span>i<span style="color:#f92672">=</span>1; i&lt;<span style="color:#f92672">=</span>5; i++<span style="color:#f92672">))</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;次数: </span>$i<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>while循环的一般写法也就是if和for的杂交，也只是记录一下，不再实验。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>count<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> <span style="color:#f92672">[</span> $count -le <span style="color:#ae81ff">5</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Count: </span>$count<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">((</span>count++<span style="color:#f92672">))</span> <span style="color:#75715e"># Bash 中的自增写法</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><h3 id="插叙重定向与管道">插叙：重定向与管道<a href="#%e6%8f%92%e5%8f%99%e9%87%8d%e5%ae%9a%e5%90%91%e4%b8%8e%e7%ae%a1%e9%81%93" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在linux命令中，<code>|</code>、<code>&gt;</code>、<code>&lt;</code>可以影响数据的流向，为我们编写脚本和日常使用指令提供了极大的方便。理解这些工具的秘诀在于想象数据像水一样流动。</p>
<p><code>&gt;</code>和<code>&gt;&gt;</code>表示<strong>输出重定向</strong>。它们可以把<strong>原本应该打印在屏幕上的内容</strong>存到指定的文件中。其中<code>&gt;</code>表示覆写，会清空原有内容；<code>&gt;&gt;</code>表示追加写，会在文件末尾接着写。</p>
<p>你应该这样理解：每一个指令都像一个有着通用的输入、输出管道的机器。默认情况下，输出的管道会直接连到你的终端上。现在，我们不希望它把数据直接流到屏幕上，而是流到文件里，所以我们接一个管道把指令输出的东西转移到文件中。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Hello&#34;</span> &gt; hello.txt
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Helloworld&#34;</span> &gt;&gt; hello.txt
</span></span></code></pre></div><p>结果：</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260130-3.png" alt=""></p>
<p>内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>Hello
</span></span><span style="display:flex;"><span>Helloworld
</span></span></code></pre></div><p><code>echo</code>指令就像是一个只会接受东西输出东西的发射器，但是它也使用了通用的管道。</p>
<p>一个常见的应用是conda导出环境配置。此处就用到了输出重定向。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda env export &gt; environment.yml <span style="color:#75715e"># 导出环境</span>
</span></span></code></pre></div><p>此外，正常的输出<code>&gt;</code>实际是<code>1&gt;</code>的缩写。错误输出<code>2&gt;</code>和正常输出并不走同一个管道。这意味着有时即使你进行了<code>&gt;</code>的重定向，当出现错误时，报错信息还是会流到屏幕上。你需要对报错做额外的处理。</p>
<p>与之相对的，<code>&lt;</code>表示输入重定向。比如某些指令默认从屏幕读取输入，你就可以用<code>&lt;</code>来将默认的输入方式改为从指定的文件中输入。每次会自动读取一行。</p>
<p>举个例子，我们随便写一个若干行的随机人名文件。</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260130-4.png" alt=""></p>
<p>然后编写这样的测试脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$PWD<span style="color:#e6db74">/names.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> read name; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  echo $name
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span> &lt;$FILE
</span></span></code></pre></div><p>FILE定义了指定的文件，此处我们默认在names.txt目录下执行该脚本。假如你在一个没有names.txt的目录下执行该脚本，脚本就会报错。</p>
<p>运行效果：</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260130-5.png" alt=""></p>
<p>符合预期。</p>
<p>然而，仅有输入输出重定向是不够的。它们只能代表数据加工开始和结束时数据的去向。但是假如数据加工的过程中也有多个步骤，仅仅使用输入输出重定向虽然也可以完成任务，但是免不了要用额外的存储空间缓存数据，并徒增写入和读取的用时。所以，我们为什么不能直接把一个指令的输出喂给另一个指令作为输入呢？</p>
<p>于是便有了管道符号<code>|</code>。它的作用就是把左边指令的输出喂给右边的指令作为输入。一些经典的用法如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 1. 列出当前目录所有文件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 把结果传给 grep，搜索包含 &#34;txt&#34; 的行</span>
</span></span><span style="display:flex;"><span>ls | grep <span style="color:#e6db74">&#34;txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 读取一个很长的文件内容</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 把内容传给 head，只看前 10 行</span>
</span></span><span style="display:flex;"><span>cat large_file.log | head -n <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 查找所有正在运行的进程</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 搜索关于 &#34;python&#34; 的进程</span>
</span></span><span style="display:flex;"><span>ps aux | grep <span style="color:#e6db74">&#34;python&#34;</span>
</span></span></code></pre></div><h2 id="函数与递归">函数与递归<a href="#%e5%87%bd%e6%95%b0%e4%b8%8e%e9%80%92%e5%bd%92" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>虽然shell脚本看起来像是一堆指令堆在一起，但是实际上完全支持函数和递归调用。</p>
<p>一个简单的函数示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>add<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#66d9ef">$((</span>$1 <span style="color:#f92672">+</span> $2<span style="color:#66d9ef">))</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#66d9ef">$(</span>add $1 $2<span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p>输出结果：</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260130-6.png" alt=""></p>
<p>shell函数相较于其他语言的函数有很大的行为差异。首先，shell script中的函数传参只能使用<code>$i</code>的形式读取第i个参数。此外，在shell中<code>return</code>关键字的用法是返回状态，只能返回0~255之间的整数，通常用0表示成功。而数据输出则使用echo，并在函数调用的时候使用<code>$(...)</code>符号捕获输出。这种设计的原因在于shell script本身是非常简陋的，想要返回数值唯一的方法就是把东西打印出来。</p>
<p><code>$(...)</code>符号在shell script中的行为和输出重定向很相似。它的功能就是把一个原本会输出到屏幕的输出重定向给变量。<code>$VAR</code>的写法则表示从变量的对应内存中提取数据。两者的功能是不同的。</p>
<p>shell script中定义的变量默认是全局变量，这和一般的程序语言的动态作用域有很大区别。如果我们希望一个变量只作用于函数体内部，我们必须要变量前添加<code>local</code>关键字。</p>
<p>shell script完全支持递归，以下是基于shell script的阶乘写法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fact<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $1 -le <span style="color:#ae81ff">1</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    local prev<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>fact <span style="color:#66d9ef">$((</span>$1 <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">)))</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#66d9ef">$((</span>$prev <span style="color:#f92672">*</span> $1<span style="color:#66d9ef">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#66d9ef">$(</span>fact $1<span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p>输出结果：</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260130-7.png" alt=""></p>
<p>一个基于shell script递归的文件树打印脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo_indent<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  local indent<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  local ans<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> <span style="color:#f92672">((</span>i <span style="color:#f92672">=</span> 1; i &lt;<span style="color:#f92672">=</span> indent; i++<span style="color:#f92672">))</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    ans<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;    </span>$ans<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;</span>$ans<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>list_file_recursive<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  local dir<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  local indent<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$2<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> item in $dir/*; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -d <span style="color:#e6db74">&#34;</span>$item<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>      echo <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>echo_indent $indent <span style="color:#e6db74">&#34;Directory: </span>$item<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>      list_file_recursive <span style="color:#e6db74">&#34;</span>$item<span style="color:#e6db74">&#34;</span> <span style="color:#66d9ef">$((</span>$indent <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      echo <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>echo_indent $indent <span style="color:#e6db74">&#34;File: </span>$item<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>list_file_recursive $PWD <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>某次输出：</p>
<p><img src="/zh-cn/posts/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8Fshell%E8%84%9A%E6%9C%AC/%E5%B7%A5%E5%85%B7%E4%B8%8D%E5%9B%BE%E9%89%B404%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F&amp;shell%E8%84%9A%E6%9C%AC-20260130-8.png" alt=""></p>
<p>（下方lt为eza输出的文件树，可以当做标准答案。）</p>
<h1 id="总结">总结<a href="#%e6%80%bb%e7%bb%93" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>虽然shell script的功能很多，但是写起来和正经的程序语言比还是有点折磨了。这边推荐把shell script当做python程序的包装器。</p>
<p>以下是我的博客发射器的包装器脚本：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>set -e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PROJECT_ROOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$HOME<span style="color:#e6db74">/python_projects/ControlCenter&#34;</span>
</span></span><span style="display:flex;"><span>VENV_ACTIVATE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$PROJECT_ROOT<span style="color:#e6db74">/venv/bin/activate&#34;</span>
</span></span><span style="display:flex;"><span>ENTRY_POINT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$PROJECT_ROOT<span style="color:#e6db74">/Entry.py&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -d <span style="color:#e6db74">&#34;</span>$PROJECT_ROOT<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;Error: Project directory not found at </span>$PROJECT_ROOT<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -f <span style="color:#e6db74">&#34;</span>$VENV_ACTIVATE<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  source <span style="color:#e6db74">&#34;</span>$VENV_ACTIVATE<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  echo <span style="color:#e6db74">&#34;Error: Virtual environment not found. Did you run &#39;python -m venv venv&#39;?&#34;</span>
</span></span><span style="display:flex;"><span>  exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>python <span style="color:#e6db74">&#34;</span>$ENTRY_POINT<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span>$@<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>deactivate
</span></span></code></pre></div><p>功能是自动启动虚拟环境并运行python程序，同时自动传参执行指令。随后结束时自动关闭虚拟环境。至于具体的功能实现则交给代码更便于维护的python程序。</p>
]]></content>
		</item>
		
		<item>
			<title>TUI图像显示方案</title>
			<link>http://localhost:1313/zh-cn/posts/tui%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88/</link>
			<pubDate>Tue, 27 Jan 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/tui%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h1 id="参考链接">参考链接<a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p><a href="https://github.com/piccolomo/plotext">plotext</a></p>
<p>最近迫于生计不得不开始学习机器学习，然而因为自己一贯喜欢用neovim写代码，用jupyter lab感觉非常的难受。但是由于termux是一个纯文本终端，我又没办法把图像直接显示在终端中。总之，最后找到了一个神奇的python库可以让我这种懒人直接在终端中查看图片，具体的实现方法就是用unicode字符拼成一个糊的一比的轮廓。不过，如果只是看一个图像的趋势的话也基本够用了。</p>
<p><img src="/zh-cn/posts/tui%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88/TUI%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88-20260127-1.png" alt=""></p>
<h1 id="简单的使用方法">简单的使用方法：<a href="#%e7%ae%80%e5%8d%95%e7%9a%84%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>安装指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>pip install plotext
</span></span></code></pre></div><p>随便的一个测试代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> plotext <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>sin(np<span style="color:#f92672">.</span>linspace(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">100</span>))
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(y)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#34;Sine Wave via Plotext&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show()
</span></span></code></pre></div><p>运行效果：</p>
<p><img src="/zh-cn/posts/tui%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88/TUI%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88-20260127-2.png" alt=""></p>
<p>以下是纯人工无添加的基于本人能工智人之力的introduction翻译：</p>
<p><strong>用之前要知道的头几件事：</strong>:</p>
<ul>
<li>默认情况下，<strong>图像尺寸</strong>会随着终端大小自动调整， 不过你也可以用<code>plotsize()</code>方法手动修改。<a href="https://github.com/piccolomo/plotext/blob/master/readme/settings.md#plot-size">plotsize使用指南</a>.</li>
<li>使用<code>subplots()</code>和<code>subplot()</code>方法可以创建<strong>子图像</strong>。<a href="https://github.com/piccolomo/plotext/blob/master/readme/subplots.md#subplots">subplots使用指南</a>.</li>
<li>多数的绘图函数中的<code>marker</code>参数可以用来指定绘图的“marker”（废话）（总之就是这个图像的线条格式）。<a href="https://github.com/piccolomo/plotext/blob/master/readme/aspect.md#markers">marker使用指南</a>。 你可以使用一些比较高精度的线条格式，如<code>hd</code>，<code>fhd</code>，更极端一点的有<code>brailla</code>。</li>
<li><code>color</code>参数可以设定绘图<strong>颜色</strong>。<a href="https://github.com/piccolomo/plotext/blob/master/readme/aspect.md#colors">color使用指南</a>.</li>
<li>你可以分别使用<code>sin()</code>方法和<code>square()</code>方法来快速生成<strong>正弦和方波图像</strong>。<a href="https://github.com/piccolomo/plotext/blob/master/readme/utilities.md#useful-functions">实用函数</a>.</li>
<li>你可以使用<code>title()</code>，<code>xlabel()</code>，<code>ylabel()</code>方法来为图像添加<strong>标签</strong>。<a href="https://github.com/piccolomo/plotext/blob/master/readme/aspect.md#plot-labels">label使用指南</a>，同时你也可以通过设定绘图函数<code>label</code>参数的方式添加<strong>图像说明</strong><a href="https://github.com/piccolomo/plotext/blob/master/readme/basic.md#multiple-data-sets">plot legend使用指南</a>.</li>
<li>你可以使用<code>axes_color()</code>, <code>canvas_color()</code>, <code>ticks_color()</code>, <code>ticks_style()</code>方法来调整<strong>图像颜色</strong>和<strong>坐标轴以及其刻度的颜色</strong>，<a href="https://github.com/piccolomo/plotext/blob/master/readme/aspect.md#colors">color使用指南</a>，或者直接使用<code>theme()</code>方法，<a href="https://github.com/piccolomo/plotext/blob/master/readme/aspect.md#themes">theme使用指南</a>。</li>
<li>使用<code>grid()</code>, <code>horizontal_line()</code> or <code>vertical_line()</code>方法来添加<strong>线条</strong>。<a href="https://github.com/piccolomo/plotext/blob/master/readme/aspect.md#plot-lines">plot-line使用指南</a></li>
<li>使用<code>xaxes()</code>, <code>yaxes()</code>方法来添加和移除<strong>坐标轴</strong>，或者直接使用<code>frame()</code>，<a href="https://github.com/piccolomo/plotext/blob/master/readme/aspect.md#plot-lines">plot-line使用指南</a></li>
<li>使用<code>xfrequency()</code>, <code>xticks()</code>, <code>yfrequency()</code>和<code>yticks()</code>来改变<strong>刻度</strong><a href="https://github.com/piccolomo/plotext/blob/master/readme/settings.md#axes-ticks">axe-ticks使用指南</a></li>
<li>和<code>matplotlib</code>类似，图像只有在<code>show()</code>被调用的时候才会<strong>显示</strong>。</li>
<li>如果你想要图像<strong>交互式显示</strong>，不要使用<code>show()</code>，而是使用<code>interactive(True)</code>方法。<a href="https://github.com/piccolomo/plotext/blob/master/readme/utilities.md#canvas-utilities">canvas-utilities</a>（这个东西的用途是在python shell中一边改一边输出图像，不是让你的图像本身可以交互）</li>
<li>使用<code>savefig(path)</code>来<strong>保存图像</strong>。<a href="https://github.com/piccolomo/plotext/blob/master/readme/utilities.md#canvas-utilities">canvas-utilities</a></li>
<li>分别使用<code>clear_figure()</code>, <code>clear_data()</code>和<code>clear_color()</code>来<strong>清除</strong>图像、数据和颜色。<a href="https://github.com/piccolomo/plotext/blob/master/readme/utilities.md#clearing-functions">clearing-functions</a></li>
<li>使用<code>clear_terminal()</code>方法在绘图前后<strong>清空屏幕</strong>。<a href="https://github.com/piccolomo/plotext/blob/master/readme/utilities.md#clearing-functions">clearing-funtions</a>.</li>
<li>doc容器中存放了所有的pytext方法和绘图函数的文档。<a href="https://github.com/piccolomo/plotext/blob/master/readme/utilities.md#docstrings">utilities.md</a></li>
</ul>
<h1 id="一些使用例">一些使用例<a href="#%e4%b8%80%e4%ba%9b%e4%bd%bf%e7%94%a8%e4%be%8b" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> plotext <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>X <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>Y <span style="color:#f92672">=</span> X <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.8</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>clear_figure()
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(X, Y, style<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;bold&#34;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Y and X.&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>theme(<span style="color:#e6db74">&#34;pro&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show()
</span></span></code></pre></div><p><img src="/zh-cn/posts/tui%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88/TUI%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88-20260127-3.png" alt=""></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> plotext <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>X <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2000</span>)<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1000</span>, <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>w <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array([<span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3.4</span>])
</span></span><span style="display:flex;"><span>Y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>matmul(X, w) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4.2</span>
</span></span><span style="display:flex;"><span>print(Y)
</span></span><span style="display:flex;"><span>Y <span style="color:#f92672">+=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, <span style="color:#ae81ff">1000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>theme(<span style="color:#e6db74">&#34;pro&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plotsize(<span style="color:#ae81ff">100</span>, <span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>scatter(X[:, <span style="color:#ae81ff">1</span>], Y, marker<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;dot&#34;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;synthetic data&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#34;Linear model synthetic data&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#34;label&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#34;features&#34;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show()
</span></span></code></pre></div><p><img src="/zh-cn/posts/tui%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88/TUI%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88-20260127-4.png" alt=""></p>
<p>动态图像（强行clc()+show()实现动态效果）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> plotext <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 准备初始数据</span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>linspace(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>shift <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Press Ctrl+C to stop the animation.&#34;</span>)
</span></span><span style="display:flex;"><span>time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># --- 1. 计算移动后的 Y 值 ---</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 让正弦波随 shift 变量移动</span>
</span></span><span style="display:flex;"><span>        y <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>sin(x <span style="color:#f92672">+</span> shift)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># --- 2. 绘图流程 ---</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>clc()  <span style="color:#75715e"># 清屏</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>clear_figure()  <span style="color:#75715e"># 清数据</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>theme(<span style="color:#e6db74">&#34;dark&#34;</span>)  <span style="color:#75715e"># 适合 Termux</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 绘制填充图，视觉效果更好</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>plot(x, y, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Live Signal&#34;</span>, marker<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;fhd&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Real-time Sine Wave | Phase: </span><span style="color:#e6db74">{</span>shift<span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>ylim(<span style="color:#f92672">-</span><span style="color:#ae81ff">1.5</span>, <span style="color:#ae81ff">1.5</span>)  <span style="color:#75715e"># 务必固定坐标轴范围，否则画面会随数据跳变</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># --- 3. 更新状态 ---</span>
</span></span><span style="display:flex;"><span>        shift <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">0.05</span>)  <span style="color:#75715e"># 20fps 左右</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> <span style="color:#a6e22e">KeyboardInterrupt</span>:
</span></span><span style="display:flex;"><span>    plt<span style="color:#f92672">.</span>clc()
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Animation stopped.&#34;</span>)
</span></span></code></pre></div><p><img src="/zh-cn/posts/tui%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88/TUI%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88-20260127-5.png" alt=""></p>
<p>显示本地图片（都用终端显示了，效果这块就只能委屈一下了）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> plotext <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>image_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;./5pebbles.png&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>image_plot(image_path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>frame(<span style="color:#66d9ef">False</span>)  <span style="color:#75715e"># 去掉边框</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xticks(<span style="color:#66d9ef">None</span>)  <span style="color:#75715e"># 去掉刻度</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>yticks(<span style="color:#66d9ef">None</span>)  <span style="color:#75715e"># 去掉刻度</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>canvas_color(<span style="color:#e6db74">&#34;none&#34;</span>)  <span style="color:#75715e"># 背景透明</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show()
</span></span></code></pre></div><p><img src="/zh-cn/posts/tui%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88/TUI%E5%9B%BE%E5%83%8F%E6%98%BE%E7%A4%BA%E6%96%B9%E6%A1%88-20260127-6.png" alt=""></p>
<p>图取自<a href="https://www.bilibili.com/video/BV1t8411z7Rn/?spm_id_from=333.1387.favlist.content.click&amp;vd_source=31ba3d75fa2995f7e1b776de7a637bd4">bilibili</a>，侵删。</p>
]]></content>
		</item>
		
		<item>
			<title>平板游戏环境配置计划：4阶段</title>
			<link>http://localhost:1313/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/</link>
			<pubDate>Thu, 22 Jan 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h1 id="参考链接">参考链接：<a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p><a href="https://github.com/Kron4ek/Wine-Builds">我所使用的wine预编译包</a></p>
<p><a href="https://www.techpowerup.com/325637/techpowerup-releases-gpu-z-v2-60-0">GPU-Z</a></p>
<p><a href="https://www.techpowerup.com/download/futuremark-3dmark06/">3Dmark6</a></p>
<h2 id="目前进度">目前进度：<a href="#%e7%9b%ae%e5%89%8d%e8%bf%9b%e5%ba%a6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<ul>
<li>termux x11 + proot distro ubuntu桌面环境工作正常；</li>
<li>box64运行x86_64程序成功；</li>
<li>vulkan驱动正常工作；
<ul>
<li>运行<code>glxgears | grep &quot;renderer&quot;</code>渲染齿轮动画并显示渲染器为<code>zink</code>；</li>
<li>运行<code>vkcube --wsi xcb</code>可以渲染旋转立方</li>
</ul>
</li>
</ul>
<h1 id="第四阶段wine">第四阶段：Wine<a href="#%e7%ac%ac%e5%9b%9b%e9%98%b6%e6%ae%b5wine" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>回顾我们之前的博客，想要在proot环境下运行steam，光有对x86_64和GPU图像渲染的支持是不够的，我们要运行的是一个纯种的win版steam，不仅系统对不上，连cpu位数都对不上。（steam是一个完全的32位应用，而不幸的是我的vivopad3完全不支持32位指令。）</p>
<p>为了能实现我们需要的效果，这里我们先对环境配置工作做一个大致的规划：</p>
<ul>
<li>首先，对于wine的选取，我们不能直接使用<code>apt install wine</code>来安装一个通用版的wine，因为官方仓库的wine会安装<code>lib32</code>相关的armhf包，这些包在我的机器上无法运行。我们需要的是一个<strong>Wine的·WOW64版的·预编译包</strong>，原因在于一方面我们需要wow64来将32位指令翻译为64位指令，另一方面proot环境极其孱弱，我们需要直接寻找社区维护的arm64预编译包。</li>
<li>其次，此阶段应该专注于创造一个纯净的wow64环境。对于第五阶段steam部署，由于proton本身是为x86_64架构的机器设计的，里面包含了很多32位的x86二进制文件（沾了哪个都运行不了），我们到时候会需要使用一些proton的核心组件。</li>
<li>对于最终效果的预期，我们希望以以下三个测试点作为阶段性成功的标志：
<ol>
<li>基础启动，运行<code>wine winecfg</code>可以弹出图形化配置界面；</li>
<li>32位测试，使用<code>box64 wine &lt;name&gt;</code>可以运行某个32位程序；</li>
<li>图形测试，确认wine可以使用第三阶段的图形链路。</li>
</ol>
</li>
</ul>
<p>现在，让我们开始寻找wine并部署。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260121-1.png" alt=""></p>
<p>由Kron4ek维护的wine仓库中，我们需要使用的是<code>wine-11.0-staging-amd64-wow64.tar.xz</code>，它提供了wow64特性，并且staging分支拥有更多的游戏补丁。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260121-2.png" alt=""></p>
<p>创建了一个专门的<code>wine-wow64</code>仓库用来存放wine源文件，使用wget下载release。之后，使用tar解压：</p>
<p><img src="assets/blog/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92%EF%BC%9A4%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260121-3.png" alt=""></p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260121-5.png" alt=""></p>
<p>以上是wine的文件结构。</p>
<p>为了让系统识别到wine并让box64能正常翻译，我们需要添加如下环境变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># Wine 的路径 (假设你解压到了 ~/wine-wow64)</span>
</span></span><span style="display:flex;"><span>export WINEPREFIX<span style="color:#f92672">=</span>$HOME/.wine
</span></span><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span>$HOME/wine-wow64/wine-11.0-staging-amd64-wow64/bin:$PATH
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 让 Wine 寻找刚才解压出来的库（Wine 自身的依赖库）</span>
</span></span><span style="display:flex;"><span>export LD_LIBRARY_PATH<span style="color:#f92672">=</span>$HOME/wine-wow64/wine-11.0-staging-amd64-wow64/lib:$LD_LIBRARY_PATH
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启 Box64 的某些特性以提高 Wine 性能</span>
</span></span><span style="display:flex;"><span>export BOX64_LOG<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>             <span style="color:#75715e"># 初始化阶段看日志很有帮助</span>
</span></span><span style="display:flex;"><span>export BOX64_DYNAREC_SAFEFLAGS<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> <span style="color:#75715e"># 提高稳定性</span>
</span></span></code></pre></div><p>以防万一，以下列出完整的<code>~/.zshrc</code>开头部分环境变量配置（我用的是zsh）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</span></span><span style="display:flex;"><span>export WINE_ROOT<span style="color:#f92672">=</span>$HOME/wine-wow64/wine-11.0-staging-amd64-wow64
</span></span><span style="display:flex;"><span>export WINEPREFIX<span style="color:#f92672">=</span>$HOME/.wine
</span></span><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span>$WINE_ROOT/bin:$PATH
</span></span><span style="display:flex;"><span>export LD_LIBRARY_PATH<span style="color:#f92672">=</span>$WINE_ROOT/lib:$WINE_ROOT/lib/wine/x86_64-unix:$LD_LIBRARY_PATH
</span></span><span style="display:flex;"><span>export BOX64_LOG<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>export BOX64_DYNAREC_SAFEFLAGS<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>export BOX64_DYNAREC_STRONGMEM<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> 
</span></span><span style="display:flex;"><span>export DISPLAY<span style="color:#f92672">=</span>:1
</span></span><span style="display:flex;"><span>export VK_ICD_FILENAMES<span style="color:#f92672">=</span>/root/test/freedreno_icd.aarch64.json
</span></span><span style="display:flex;"><span>export MESA_LOADER_DRIVER_OVERRIDE<span style="color:#f92672">=</span>zink
</span></span><span style="display:flex;"><span>export GALLIUM_DRIVER<span style="color:#f92672">=</span>zink
</span></span><span style="display:flex;"><span>export XDG_RUNTIME_DIR<span style="color:#f92672">=</span>/tmp
</span></span><span style="display:flex;"><span>export TU_DEBUG<span style="color:#f92672">=</span>sysmem
</span></span></code></pre></div><p>接下来，我们进行首次启动与初始化。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260121-6.png" alt=""></p>
<p>一开始尝试直接输入<code>wine winecfg</code>提示command not found，后来发现运行的是一个x86_64的二进制文件wine。没关系，我们有box64来引导wine运行。在终端输入<code>box64 wine winecfg</code>后得到了如图的结果。</p>
<p>为了一步到位，这里我们选择手动下载<code>.msi</code>文件。（使用自动下载大概率会失败，通常会因为下载时间过长而被挂起）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>https://dl.winehq.org/wine/wine-mono/9.4.0/wine-mono-9.4.0-x86.msi
</span></span></code></pre></div><p>这个网址不要直接用wget下载。使用自己的系统浏览器下载速度会快的多。下载完将这个文件传进proot。使用以下指令进行安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>box64 wine msiexec /i wine-mono-9.4.0-x86.msi
</span></span></code></pre></div><p>安装完之后进入以下界面，确保图示的两个选项开启。标志测试点A顺利通过。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260121-7.png" alt=""></p>
<p>在进行下一步之前，我们先做一些优化调整。</p>
<p>先为<code>~/.zshrc</code>添加以下内容，省得每次都要写box64。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>alias wine<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;box64 wine&#39;</span>
</span></span><span style="display:flex;"><span>alias wine64<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;box64 wine&#39;</span>
</span></span></code></pre></div><p>添加以下内容来精细化box64的寻找目录：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 确保 Box64 知道去哪里找 wine 的 x86_64 库</span>
</span></span><span style="display:flex;"><span>export BOX64_PATH<span style="color:#f92672">=</span>$HOME/wine-wow64/wine-11.0-staging-amd64-wow64/bin/
</span></span><span style="display:flex;"><span>export BOX64_LD_LIBRARY_PATH<span style="color:#f92672">=</span>$HOME/wine-wow64/wine-11.0-staging-amd64-wow64/lib/wine/x86_64-unix/:$HOME/wine-wow64/wine-11.0-staging-amd64-wow64/lib/
</span></span></code></pre></div><p>理论上，我们现在已经完成了wine部分的配置。如果一切顺利，我们此时的环境应当可以在这个只支持64位的机器上运行32位程序。接下来，让我们完成测试点B和C来检验我们的环境配置成果，也只有完成了这两个测试点，我们才能进一步解决最终挑战：部署steam。</p>
<p>对于测试点B，我们来尝试在这个环境下运行<strong>7-zip</strong>，一个既32位又有图形界面的软件，甚至还是一个纯x86程序，简直和我的机器原生环境八字不合。但是，我们可以让它在我们的环境下正常运行。</p>
<p>运行以下指令安装7-zip。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget https://www.7-zip.org/a/7z2301.exe
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wine 7z2301.exe <span style="color:#75715e"># 这里假定你已经写入了alias wine=&#34;box64 wine&#34;</span>
</span></span></code></pre></div><p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260121-8.png" alt=""></p>
<p>就这样，我们成功在一个既不x86也不32的环境下成功运行了一个和它水火不容的程序。一切都在box64和wine的掌控之下。</p>
<p>由于7-zip本身使用时似乎确实没有图形界面，我们运行<code>wine 7-zip.exe</code>后可以得到这样的输出结果，代表它确实可以工作。（7-zip的正常使用需要输入参数，对于一个实质linux的环境我们有更好的工具）。为了演示，我们可以用它来打个包试试。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260121-9.png" alt=""></p>
<p>随便往桌面上扔两个文件和一个文件夹：</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260121-10.png" alt=""></p>
<p>然后运行<code>wine 7z.exe a test.7z ~/Desktop/thisIsAFile.txt ~/Desktop/thisIsAlsoAFile.txt ~/Desktop/thisIsADir/</code> 。返回了如下结果：</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260121-11.png" alt=""></p>
<p>可以看到在7-zip的目录下我们得到了打包好的<code>test.7z</code>。证明7z.exe已经可以正常工作了。7-zip之所以可以直接访问像<code>~/Desktop/thisIsAFile.txt ~/Desktop/thisIsAlsoAFile.txt ~/Desktop/thisIsADir/</code>这样的路径，原因在于wine的实现方法并不是像虚拟机那样建立完全隔离的硬盘镜像，而是逻辑映射：将linux的根目录/映射为windows的<code>Z:</code>盘。在运行指令时，wine会自动将linux风格地址重定向为windows风格的对应地址并让7z运行。由于C盘与Z盘只是一个文件系统的不同挂载点，他们当然可以相互访问。</p>
<p>对于测试点C，我们使用GPU-Z来测试wine内的OpenGL请求是否被正确路由到zink。GPU-Z不能通过wget下载，所以访问GPU-Z下载网站进行下载。（链接在开头）</p>
<p>同样将下载得到的<code>.exe</code>文件传入proot环境，运行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 以防万一手动配置一下环境变量，确保zink被强制调用。</span>
</span></span><span style="display:flex;"><span>export MESA_LOADER_DRIVER_OVERRIDE<span style="color:#f92672">=</span>zink 
</span></span><span style="display:flex;"><span>export GALLIUM_DRIVER<span style="color:#f92672">=</span>zink
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wine GPU-Z.2.68.0.exe
</span></span></code></pre></div><p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260122-1.png" alt=""></p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260122-2.png" alt=""></p>
<p>然而，最终程序运行失败了。报错信息大致如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>BOX64<span style="color:#f92672">]</span> Using emulated /usr/x86_64-linux-gnu/lib/libgcc_s.so.1
</span></span><span style="display:flex;"><span>0154:err:seh:install_bpf Native libs are being loaded in low addresses, sc_seccomp 0x3f0023fe00, syscall 0x60030320, not installing seccomp.
</span></span><span style="display:flex;"><span>0154:err:seh:install_bpf The known reasons are /proc/sys/vm/legacy_va_layout set to <span style="color:#ae81ff">1</span> or <span style="color:#e6db74">&#39;ulimit -s&#39;</span> being <span style="color:#e6db74">&#39;unlimited&#39;</span>.
</span></span><span style="display:flex;"><span>0160:fixme:ntoskrnl:IoCreateDeviceSecure <span style="color:#f92672">(</span>0000000000C54030, 16, L<span style="color:#e6db74">&#34;\\Device\\GPU-Z-v3&#34;</span>, 34, 100, 0, L<span style="color:#e6db74">&#34;D:P(A;;GA;;;SY)(A;;GA;;;BA)&#34;</span>, <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>, 0000000000A4FC60<span style="color:#f92672">)</span>: semi-stub
</span></span><span style="display:flex;"><span>0160:fixme:ntoskrnl:IoRegisterShutdownNotification stub: 0000000000C54BF0
</span></span><span style="display:flex;"><span>0164:fixme:ntoskrnl:MmMapIoSpace stub: 0x00000000000e0000, 131072, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0164:fixme:ntoskrnl:MmMapIoSpace stub: 0x000000000000040e, 2, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0164:fixme:int:emulate_instruction reg 0x2a, returning 0.
</span></span><span style="display:flex;"><span>0140:fixme:setupapi:CM_Get_Parent 0030CE0C 0x00000001 0x00000000 stub
</span></span><span style="display:flex;"><span>0140:fixme:shell:InitNetworkAddressControl stub
</span></span><span style="display:flex;"><span>0060:fixme:file:errno_to_status Converting errno <span style="color:#ae81ff">17</span> to STATUS_UNSUCCESSFUL
</span></span><span style="display:flex;"><span>0060:err:mountmgr:registry_flush_thread Failed flushing registry.
</span></span><span style="display:flex;"><span>0060:fixme:file:errno_to_status Converting errno <span style="color:#ae81ff">17</span> to STATUS_UNSUCCESSFUL
</span></span><span style="display:flex;"><span>0060:err:mountmgr:registry_flush_thread Failed flushing registry.
</span></span><span style="display:flex;"><span>0060:fixme:file:errno_to_status Converting errno <span style="color:#ae81ff">17</span> to STATUS_UNSUCCESSFUL
</span></span><span style="display:flex;"><span>0060:err:mountmgr:registry_flush_thread Failed flushing registry.
</span></span></code></pre></div><p>根据分析，GPU-Z为了读取显卡的频率、温度和底层参数，会装一些windows底层驱动程序，box64无法将这种“试图直接读写硬件寄存器”的内核代码翻译给安卓底层。总之，GPU-Z似乎在本机器上是无解的。</p>
<p>但是这并不代表我们的图形链路是失败的，我们可以用一些其他的benchmark。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260122-3.png" alt=""></p>
<p>总之经过了一些暗箱操作（其实和前面没区别），在虚拟环境中安装了3Dmark6。可以看到wine环境下成功识别到了Turnip Adreno 735，说明 Wine 环境成功地通过 Zink 将 DirectX 调用转换为 Vulkan，并完美识别到了骁龙 8s Gen 3 的核心显卡。</p>
<p>此外，3Dmark6将我的系统识别为了<code>Microsoft Windows 10</code>，已经符合了steam及大部分游戏的基础需求。</p>
<p>但是此时又一个新的问题出现：运行3Dmark后黑屏，但是可以esc退出。此时vkcube和glxgears都仍然可以正常工作。</p>
<p>给出的box64日志如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#f92672">[</span>BOX64<span style="color:#f92672">]</span> Using native<span style="color:#f92672">(</span>wrapped<span style="color:#f92672">)</span> libcups.so.2
</span></span><span style="display:flex;"><span>0480:fixme:wbemprox:client_security_SetBlanket 799C3954, 001160B0, 10, 0, <span style="color:#f92672">(</span>null<span style="color:#f92672">)</span>, 3, 3, 00000000, <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>0480:fixme:wbemprox:client_security_Release 799C3954
</span></span><span style="display:flex;"><span>0480:fixme:wbemprox:enum_class_object_Next timeout not supported
</span></span><span style="display:flex;"><span>00e0:fixme:d3d:wined3d_guess_card No card selector available <span style="color:#66d9ef">for</span> card vendor <span style="color:#ae81ff">0000</span> <span style="color:#f92672">(</span>using GL_RENDERER <span style="color:#e6db74">&#34;zink Vulkan 1.4(Turnip Adreno (TM) 735 (MESA_TURNIP))&#34;</span><span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>vkd3d:00e0:fixme:D3DCompile2VKD3D Ignoring flags 0x1000.
</span></span><span style="display:flex;"><span>vkd3d:00e0:fixme:D3DCompile2VKD3D Ignoring flags 0x1000.
</span></span><span style="display:flex;"><span>048c:fixme:d3d:state_linepattern_w Setting line patterns is not supported in OpenGL core contexts.
</span></span><span style="display:flex;"><span>0060:fixme:file:errno_to_status Converting errno <span style="color:#ae81ff">17</span> to STATUS_UNSUCCESSFUL
</span></span><span style="display:flex;"><span>0060:err:mountmgr:registry_flush_thread Failed flushing registry.
</span></span></code></pre></div><p>原因在于目前的工作链路是使用wine自带的wineD3D来将directX指令转换为OpenGL指令，而WineD3D的工作效果并不尽如人意。我们现在需要按照最开始的规划，为虚拟环境部署<strong>DXVK</strong>，直接将directX转换为vulkan。这样效率更高，兼容性理论上也更好。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget https://github.com/doitsujin/dxvk/releases/download/v2.7.1/dxvk-2.7.1.tar.gz
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tar -xzf dxvk-2.7.1.tar.gz
</span></span></code></pre></div><p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260122-4.png" alt=""></p>
<p>里面大致是这样的结构。我们需要将<code>x32</code>中的<code>d3d9.dll, dxgi.dll</code>复制到<code>$WINEPREFIX/drive_c/windows/syswow64/</code>，将<code>x64</code>中的<code>d3d9.dll, dxgi.dll</code>复制到<code>$WINEPREFIX/drive_c/windows/system32/</code>。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260122-5.png" alt=""></p>
<p>之后我们需要配置函数库覆盖。输入<code>wine winecfg</code>打开配置界面，在libraries标签页中添加d3d9和dxgi，确保均为原生优先。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260122-6.png" alt=""></p>
<p>微调环境变量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 强制开启高性能性能，防止 Proot 功耗缩减</span>
</span></span><span style="display:flex;"><span>export TU_DEBUG<span style="color:#f92672">=</span>sysmem
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果仍然黑屏，可以尝试跳过一些冗余转换</span>
</span></span><span style="display:flex;"><span>export MESA_VK_WSI_DEBUG<span style="color:#f92672">=</span>sw
</span></span></code></pre></div><p>再次尝试运行3DMark，测试一二顺利通过（尽管帧数感人），测试三测试CPU时因为使用了很多非常古老的指令，在目前这套激进的方案下非常难以通过，遂放弃。总之，这并不意味着环境有问题，对于大多数现代游戏来说当前的环境配置已经可以让它基本能运行了。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260122-7.png" alt=""></p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260122-8.png" alt=""></p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%924%E9%98%B6%E6%AE%B5/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%92-20260122-9.png" alt=""></p>
]]></content>
		</item>
		
		<item>
			<title>平板游戏环境部署计划</title>
			<link>http://localhost:1313/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E8%AE%A1%E5%88%92/</link>
			<pubDate>Tue, 20 Jan 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E8%AE%A1%E5%88%92/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h2 id="今日计划">今日计划<a href="#%e4%bb%8a%e6%97%a5%e8%ae%a1%e5%88%92" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<ul>
<li>实现平板上配置游戏环境。</li>
</ul>
<p>由于游戏大多面向windows这样开箱即用的系统开发，Linux并不是游戏运行的一等公民。所以如果想要在一台<strong>arm64架构的·android系统，甚至不是一个纯种linux系统的·纯64位，对32位指令完全不支持的</strong>环境下配置windows游戏运行环境，我们需要摄入适量的前置知识。</p>
<h1 id="本篇要素">本篇要素<a href="#%e6%9c%ac%e7%af%87%e8%a6%81%e7%b4%a0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<ul>
<li>wine：一个让windows程序可以跑在linux系统的工具；</li>
<li>box64：一个将x86_64指令翻译为arm64指令的工具；</li>
<li>mesa：一套开源图像驱动集合；</li>
<li>dxvk：图像api翻译器</li>
<li>turnip &amp; zink：mesa组件，负责驱动vulkan和翻译图像api指令；</li>
</ul>
<h1 id="wine">Wine<a href="#wine" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p><strong>W</strong>ine <strong>I</strong>s <strong>N</strong>ot <strong>E</strong>mulator，一个递归式的缩写。wine是一个<strong>兼容层</strong>，旨在让POSIX兼容的操作系统（如Linux）上可以运行原本为Windows开发的应用程序。它的实现方法与虚拟机有巨大差异，并不模拟硬件，而是在运行时实时地将windows api调用翻译为POSIX调用。所以wine的理论性能显著优于虚拟机。</p>
<p>几个核心概念：</p>
<h3 id="wineprefixwine前缀">WINEPREFIX（Wine前缀）<a href="#wineprefixwine%e5%89%8d%e7%bc%80" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>类似python的虚拟环境，一个wine前缀代表了一个独立的windows虚拟环境。不过在实现层面，wine的行为可能更加类似于conda，都采用了集中式文件管理架构。</p>
<p>wineprefix存在的意义在于避免前置地狱的痛苦。通过环境隔离，你可以在同一台机器上运行前置相互冲突的程序，只要你把它们放在不同的前缀中。</p>
<h3 id="winearchwine架构">WINEARCH（Wine架构）<a href="#winearchwine%e6%9e%b6%e6%9e%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>初始化前缀时指定模拟的是32位windows还是64位windows。</p>
<h3 id="dll覆盖">DLL覆盖<a href="#dll%e8%a6%86%e7%9b%96" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>windows程序的运行依赖于大量的动态链接库（即dll）。wine内置了这些dll的开源实现，但是有时出于兼容性考虑需要用windows提取原装版本来替换内建版本。</p>
<h3 id="winetricks">Winetricks<a href="#winetricks" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>一个shell脚本，用来下载和安装各种windows运行时库，辅助wine环境配置。</p>
<h3 id="wow64-mode">WoW64 Mode<a href="#wow64-mode" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>wine的新能力，可以将32位windows api调用转换为64位windows api调用。</p>
<h3 id="局限">局限<a href="#%e5%b1%80%e9%99%90" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<ul>
<li>内核级反作弊的网络游戏无法运行。</li>
<li>配置复杂。</li>
<li>不是所有软件都能完美运行。</li>
</ul>
<h2 id="box64">Box64<a href="#box64" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>一个二进制指令翻译器，用来在非x86_64架构的Linux系统（尤其是树莓派和Android平板或手机）上运行原本为x86_64处理器编译的Linux程序。与wine类似的，它的实现也不是使用虚拟机。核心功能是在Linux程序运行时将x86_64架构CPU指令实时地转换为arm64能理解的指令。</p>
<p>Box64性能优异的原因有二，一方面它采用了<strong>动态重编译</strong>技术，并不100%的解释运行所有指令，而是运行时动态的将指令重写为arm64机器码。此外，box64采用了<strong>原生库包装</strong>技术，在一些图形处理上直接调用arm64原生库，使得图像处理上几乎可以以原生速度进行。</p>
<p>Box64最夯的应用即和Wine一起打出combo。Box64提供硬件适配，Wine提供系统适配，一同使用就可以在一个树莓派或者高性能arm机器上几乎不损失性能地运行windows程序以及游戏。</p>
<h2 id="mesa">Mesa<a href="#mesa" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>Mesa是一个<strong>开源图形驱动集合</strong>，实现了跨平台图形api规范。当我们在Linux上运行游戏时，Mesa会接收游戏发出的绘图指令，并将它们翻译为特定的GPU硬件指令。</p>
<p>由于本人从未涉足过图形学编程的领域，此处额外补充一些必备的图形学知识。所谓的图形api，常见的图像api有OpenGL和Vulkan，它们的作用是将CPU给出的图形绘制指令翻译为GPU指令。其中，OpenGL是一个老资历图形api，特点是相对容易上手，缺点是性能一般；而Vulkan是一个相对更新的图形api，特点是上手难度地狱，但是性能可以比OpenGL强的多。如果类比的话，OpenGL就类似于Python，它帮你做了很多事，代价是性能不够理想；Vulkan则是C语言，所有事情都要你自己控制，所以没有中间商赚差价，性能也自然很高，代价是配置和学习痛苦。</p>
<p>此外，在微软windows系统中还存在Direct3D图形api。同样是一个相较于OpenGL更加现代的图形api。很多windows应用和游戏以Direct3D为图像api。</p>
<h2 id="dxvk">DXVK<a href="#dxvk" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p><strong>D</strong>irect<strong>X</strong> over <strong>V</strong>ul<strong>K</strong>an，即将微软Direct3D图像api调用翻译为Vulkan api调用。</p>
<p>在dxvk出现前，wine默认将direct3d指令翻译为openGL指令，由于Direct3D和OpenGL架构差异巨大，这种翻译效率低下，导致CPU瓶颈严重。DXVK的理念是在Direct3D和与它架构更接近、性能更优的Vulkan api之间建立映射。</p>
<p>在Wine容器中运行windows游戏时，Wine会调用DXVK提供的动态链接库，将指令转换为Vulkan并发送给Mesa，Mesa接受到指令后指挥GPU绘制图像。</p>
<p>在winetricks中可以通过<code>winetricks dxvk</code>来一键安装dxvk并覆盖动态链接库。</p>
<h2 id="turnipzink">Turnip&amp;Zink<a href="#turnipzink" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>Turnip和zink是arm64架构设备上运行桌面级应用的热门mesa组件。</p>
<p>其中turnip是linux上运行vulkan应用的首选驱动。不同于Vulkan官方的驱动，Turnip由社区维护，更新速度快，并且针对DXVK做了大量的优化。主要的应用场景是Android运行PC游戏。</p>
<p>Zink的功能则是将OpenGL翻译为Vulkan。对于一个老旧的OpenGL游戏，只使用Turnip无法运行，这时就需要Zink将OpenGL指令翻译为Vulkan指令。因为OpenGL过于老旧臃肿，即使加上了Zink这一翻译层，Vulkan的运行速度也会比原生的OpenGL更快。</p>
<h1 id="全要素再放送">全要素再放送<a href="#%e5%85%a8%e8%a6%81%e7%b4%a0%e5%86%8d%e6%94%be%e9%80%81" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<ol>
<li><strong>宿主层 (Host)</strong>: Android Kernel + Termux (基础终端环境)。</li>
<li><strong>容器层 (Container)</strong>: PRoot Distro (Ubuntu)。<strong>必须是纯 64 位环境</strong>。</li>
<li><strong>显示层 (Display)</strong>: Termux:X11 (X Server) + Ubuntu 桌面环境 (XFCE4/MATE) 或 窗口管理器。</li>
<li><strong>指令翻译层 (Translator)</strong>: <strong>Box64</strong> (将 x86_64 翻译为 ARM64)。</li>
<li><strong>图形驱动层 (Driver)</strong>: <strong>Mesa (Turnip + Zink)</strong>。这是 Adreno 显卡的生命线。</li>
<li><strong>兼容层 (Compatibility)</strong>: <strong>Wine (WoW64 Build)</strong>，负责在纯 64 位环境下运行 32 位 Windows 程序。</li>
<li><strong>图形转译层 (Graphics Wrapper)</strong>: <strong>DXVK</strong> (DX11 -&gt; Vulkan)。</li>
<li><strong>应用层 (App)</strong>: Windows Steam 客户端 + 游戏。</li>
</ol>
<h2 id="环境配置阶段性任务">环境配置阶段性任务<a href="#%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae%e9%98%b6%e6%ae%b5%e6%80%a7%e4%bb%bb%e5%8a%a1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<ol>
<li>完成基本环境配置，纯净64位ubuntu distro环境+termux x11桌面环境基本配置；</li>
<li>构建指令翻译器，安装box64并注册Binfmt；</li>
<li>部署图形驱动，获取Mesa并验证Vulkan支持；</li>
<li>部署wine兼容层；</li>
<li>部署steam；</li>
<li>测试游戏运行；</li>
</ol>
<h1 id="目前进度">目前进度<a href="#%e7%9b%ae%e5%89%8d%e8%bf%9b%e5%ba%a6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>基本环境配置完成，可以打开桌面环境并在桌面环境中运行终端。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E8%AE%A1%E5%88%92/%E4%BB%8A%E6%97%A5%E9%9A%8F%E7%AC%94-20260120-1.png" alt=""></p>
]]></content>
		</item>
		
		<item>
			<title>平板游戏环境配置计划：2&amp;3阶段</title>
			<link>http://localhost:1313/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%9223%E9%98%B6%E6%AE%B5/</link>
			<pubDate>Tue, 20 Jan 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%9223%E9%98%B6%E6%AE%B5/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h1 id="参考链接">参考链接<a href="#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p><a href="https://github.com/ptitSeb/box64/blob/main/README_CN.md">box64中文主页</a></p>
<p><a href="https://github.com/K11MCH1/WinlatorTurnipDrivers/releases/tag/winlator_v25.1_r2">turnip driver</a></p>
<p><a href="https://docs.mesa3d.org/install.html">mesa3D主页</a></p>
<h1 id="第二阶段box64部署">第二阶段：box64部署<a href="#%e7%ac%ac%e4%ba%8c%e9%98%b6%e6%ae%b5box64%e9%83%a8%e7%bd%b2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>基础编译工具链：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install -y git cmake build-essential python3 python3-setuptoolsapt-get update
</span></span><span style="display:flex;"><span>apt-get install -y git cmake build-essential python3 python3-setuptools
</span></span></code></pre></div><p>编译指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 1. 克隆官方仓库</span>
</span></span><span style="display:flex;"><span>git clone https://github.com/ptitSeb/box64
</span></span><span style="display:flex;"><span>cd box64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 创建构建目录</span>
</span></span><span style="display:flex;"><span>mkdir build; cd build
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 配置 CMake (关键步骤)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -DSD8G2=1 : 针对骁龙8Gen2/3架构优化</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -DCMAKE_BUILD_TYPE=RelWithDebInfo : 保持高性能的同时保留调试信息(对崩溃排查很重要)</span>
</span></span><span style="display:flex;"><span>cmake .. -DSD8G2<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> -DCMAKE_BUILD_TYPE<span style="color:#f92672">=</span>RelWithDebInfo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. 开始编译 (利用 8s Gen 3 的多核性能，-j8)</span>
</span></span><span style="display:flex;"><span>make -j8
</span></span></code></pre></div><p>安装二进制文件到系统目录：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 1. 安装二进制文件到系统路径 </span>
</span></span><span style="display:flex;"><span>make install
</span></span></code></pre></div><p>在<code>~/box64/system</code>目录下找到了<code>box64.box64rc</code>，显然是box64的配置文件。将其复制到<code>/etc</code>目录下。</p>
<p>我本来想复制一下这个配置文件的内容，奈何有1000多行，遂放弃。</p>
<p>合影留念：</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%9223%E9%98%B6%E6%AE%B5/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95-20260120-1.png" alt=""></p>
<p>在推进到第三阶段前，我们先用一个简单的x86_64的Helloworld文件测试一下box64有没有在正常工作。</p>
<p>让我们随便创建一个<code>hello.c</code>文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;#include &lt;stdio.h&gt; int main() { printf(&#34;Hello, Box64! Integration test successful.\\n&#34;); return 0; }&#39;</span> &gt; hello.c
</span></span></code></pre></div><p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%9223%E9%98%B6%E6%AE%B5/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95-20260120-2.png" alt=""></p>
<p>安装交叉编译器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>apt-get update
</span></span><span style="display:flex;"><span>apt-get install -y gcc-x86-64-linux-gnu file
</span></span></code></pre></div><p>使用x86_64编译链来编译c文件，并使用<code>file</code>指令验证它确实是x86_64文件。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%9223%E9%98%B6%E6%AE%B5/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95-20260120-3.png" alt=""></p>
<p>测试成功。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%9223%E9%98%B6%E6%AE%B5/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95-20260120-4.png" alt=""></p>
<h1 id="第三阶段图形驱动与vulkan支持验证">第三阶段：图形驱动与vulkan支持验证<a href="#%e7%ac%ac%e4%b8%89%e9%98%b6%e6%ae%b5%e5%9b%be%e5%bd%a2%e9%a9%b1%e5%8a%a8%e4%b8%8evulkan%e6%94%af%e6%8c%81%e9%aa%8c%e8%af%81" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>对于本阶段，我们需要实现的是让proot distro ubuntu知道显卡的存在并去调用显卡进行图像计算。目前ubuntu认为自己处在一个没有显卡的服务器上，所以使用CPU来逐个像素的计算图像。对于一般性的桌面环境来说可能足够了，但是对于游戏来说，这样的性能是远远不够的。</p>
<p>所以我们本步需要做的是：寻找这样一个文件，它不是一个普通的软件，而是一个特定的驱动程序，即动态链接库<code>.so</code>文件，并且由于我们环境的特殊性，这个驱动文件必须满足以下条件：</p>
<ol>
<li>必须使用Android的KGSL接口来管理显卡；</li>
<li>必须使用Glibc编译的版本，这样ubuntu才能正常运行；</li>
<li>必须是二进制文件成品，因为在proot环境下直接编译极其困难（我已经试过了）；</li>
</ol>
<p>总结关键词：mesa，glibc，turnip，kgsl。这个文件将会是我们的proot环境中mesa+vulkan的全链条实现者。</p>
<p>经过一番探索，我发现自己之前遗漏了两个重要的术语，以下进行补充：mesa是是一个巨大的开源项目，其中包含了多种显卡的驱动，而其中<strong>Freedreno</strong>是专门负责高通Adreno GPU项目的总称。所以，我们需要寻找的并非是一个原生态的mesa驱动，而是找freedreno。</p>
<p>此外，winlator是一个专门用来在android系统上运行win程序的封装好的应用。但是适用于winlator的驱动理论上也可以适用于proot distro。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%9223%E9%98%B6%E6%AE%B5/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95-20260121-1.png" alt=""></p>
<p>如图是阶段成功的标志，实际效果是一个旋转的立方体。出现了这个，意味着vulkan驱动的路被完全打通，proot环境可以直接调用你的GPU进行计算并呈现在你的termux x11窗口中。</p>
<p>在正式开始配置之前，我们需要知道proot环境下我们期待图形渲染的工作流是什么。以我们阶段成果vkcube为例，我们来逐步分析它的工作流。</p>
<p>vkcube并不是某个vulkan工具，而是一个调用了vulkan api的程序。当我们运行<code>vkcube --wsi xcb</code>时，vkcube作为一个vulkan程序，它会首先读取一个<code>.json</code>文件（学名ICD，Installable Client Driver）来确定系统中有哪些驱动程序。这意味着，如果我们希望这个程序能成功运行，它必须知道哪里能找到这个<code>.json</code>文件，而想让一个程序可以无视位置地锁定另一个文件意味着我们需要设置环境变量。在vulkan的语境下，这个环境变量即<code>VK_ICD_FILENAMES</code>。</p>
<p>确认了驱动程序后，vulkan程序就会直接通过驱动程序来调用显卡进行计算。如果你的驱动程序版本和硬件不匹配，或者根本没有权限访问显卡，那么vulkan程序就无法调用显卡进行计算。</p>
<p>假如一切顺利，图像渲染成功，我们还需要让它呈现在屏幕上。而一个vulkan程序呈现图像的方式是调用vulkan api，通过vulkan wsi(window system integration)来显示窗口。在我们的proot环境下，我们采用了termux x11来显示桌面环境，所以我们希望wsi协商时调用x11(xcb)接口来实现图像显示。</p>
<p>具体的实施方案上，经过了一番寻找，我终于找到了理论上可用的<code>turnip driver</code>，链接已经放在文章开头了。K11MCH1维护了一个为winlator做驱动支持的turnip driver仓库，理论上这个驱动程序对于proot环境也同样适用。</p>
<p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%9223%E9%98%B6%E6%AE%B5/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95-20260121-2.png" alt=""></p>
<p>我们将其中的<code>.so</code>文件随意的下载并放置在某个自己知道的位置。随后，由于作者并没有提供一个直接可用的ICD文件，我们需要自己来写这个文件。 随便在某个你自己知道的目录下创建一个<code>.json</code>文件，我对它的命名为<code>freedreno_icd.aarch64.json</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;file_format_version&#34;</span>: <span style="color:#e6db74">&#34;1.0.0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;ICD&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;library_path&#34;</span>: <span style="color:#e6db74">&#34;/root/test/libvulkan_freedreno.so&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;api_version&#34;</span>: <span style="color:#e6db74">&#34;1.3.255&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>以上代码块中<code>&quot;/root/test/libvulkan_freedreno.so&quot;</code>应该被替换为你的实际的<code>.so</code>存放目录。可以看到我真的就是随便开了个test目录就放了，这个还是看个人的文件管理习惯吧。</p>
<p>此外我们需要设置环境变量来让这个icd可以被识别，顺便的，我们需要设定一下显示端口来对接wsi。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 在proot环境内运行。</span>
</span></span><span style="display:flex;"><span>export VK_ICD_FILENAMES<span style="color:#f92672">=</span>/root/test/freedreno_icd.aarch64.json
</span></span><span style="display:flex;"><span>export DISPLAY<span style="color:#f92672">=</span>:1
</span></span></code></pre></div><p>此外，这是我使用的proot distro ubuntu桌面环境启动脚本，放在termux宿主机中。原理看注释。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- 1. 环境清理 ---</span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Cleaning up...&#34;</span>
</span></span><span style="display:flex;"><span>pkill -9 termux-x11
</span></span><span style="display:flex;"><span>pkill -9 virgl_test
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 尝试删除端口1相关的锁</span>
</span></span><span style="display:flex;"><span>rm -f $TMPDIR/.X1-lock 2&gt;/dev/null
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- 2. 启动服务端 ---</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 注意这里改成了 :1</span>
</span></span><span style="display:flex;"><span>am start -n com.termux.x11/com.termux.x11.MainActivity
</span></span><span style="display:flex;"><span>termux-x11 :1 -ac &amp;
</span></span><span style="display:flex;"><span>virgl_test_server_android &amp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sleep <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># --- 3. 进入 PRoot 并启动 ---</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 确保所有 DISPLAY 都指向 :1</span>
</span></span><span style="display:flex;"><span>proot-distro login ubuntu --shared-tmp --bind /dev --bind /sys --bind ~/share:/share -- /bin/bash -c <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    export DISPLAY=:1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    export XDG_RUNTIME_DIR=/tmp
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 强制重新设置 dbus
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    rm -rf /var/run/dbus/pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    dbus-daemon --system --fork 2&gt;/dev/null
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    export \$(dbus-launch)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    # 3D 加速相关
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    export GALLIUM_DRIVER=virpipe
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    export MESA_GL_VERSION_OVERRIDE=4.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    echo &#39;Starting XFCE4 on DISPLAY :1...&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    startxfce4
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>以上是我能回忆的起来的主要配置过程（因为中间实际上经历了很多的错误尝试，以上是我最后能确定的正确尝试，实际配置可能还需要依据情况做额外的调整）。为了检测我们的配置成果，首先我们需要安装<code>vulkan-tools</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>apt install vulkan-tools
</span></span></code></pre></div><p>以下罗列一些可能使用到的检查状态的指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>vulkaninfo | grep <span style="color:#e6db74">&#34;deviceName&#34;</span>
</span></span></code></pre></div><p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%9223%E9%98%B6%E6%AE%B5/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95-20260121-3.png" alt=""></p>
<p>以上是我未启动桌面环境时输出的信息。其中<code>XDG_RUNTIME_DIR</code>是一个proot环境下没有预设的目录。虽然弹出了很多警告，但是都是无害噪音，并不会影响最终运行。</p>
<p>输出信息中最重要的是<code>deviceName = Turnip Adreno (TM) 735</code>，表示turnip驱动已经处在了待命状态，并且成功穿透容器访问到了显卡。安卓设备的厂商通常会默认将显卡的详细版本信息隐藏起来，此处<code>735</code>版本号出现证明了确实访问到了真正的显卡。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 需安装 mesa-utils</span>
</span></span><span style="display:flex;"><span>MESA_LOADER_DRIVER_OVERRIDE<span style="color:#f92672">=</span>zink glxinfo | grep <span style="color:#e6db74">&#34;renderer&#34;</span>
</span></span></code></pre></div><p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%9223%E9%98%B6%E6%AE%B5/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95-20260121-4.png" alt=""></p>
<p>同样出现了大量无害噪音。其中最关键的信息是<code>zink Vulkan 1.4(Turnip Adreno (TM) 735 (MESA_TURNIP))</code>，表示zink成功启动并挂载在turnip上。zink将OpenGL调用翻译为Vulkan调用，此处如果能成功显示意味着你的系统可以高效的渲染OpenGL图像。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>glxinfo | grep <span style="color:#e6db74">&#34;Mesa&#34;</span>
</span></span></code></pre></div><p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%9223%E9%98%B6%E6%AE%B5/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95-20260121-5.png" alt=""></p>
<p>显示mesa版本。出现mesa版本号意味着mesa驱动包已经部署。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>glxgears
</span></span></code></pre></div><p>这是一个mesa/glx体系下常用的用来演示和诊断OpenGL支持的小程序，主要功能有：</p>
<ul>
<li>测试X11是否正常工作；</li>
<li>GLX是否可用；</li>
<li>OpenGL上下文是否创建；</li>
</ul>
<p>在此处，由于我们部署了mesa，理论上我们可以用zink来将OpenGL翻译为Vulkan再进一步渲染。具体的实施方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># 强制使用 Zink 渲染 OpenGL</span>
</span></span><span style="display:flex;"><span>export MESA_LOADER_DRIVER_OVERRIDE<span style="color:#f92672">=</span>zink
</span></span><span style="display:flex;"><span>export GALLIUM_DRIVER<span style="color:#f92672">=</span>zink
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 运行 glxinfo 看看 renderer 是否变成了 Turnip</span>
</span></span><span style="display:flex;"><span>glxinfo | grep <span style="color:#e6db74">&#34;renderer&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 运行 glmark2 或简单的 glxgears 测试性能</span>
</span></span><span style="display:flex;"><span>glxgears
</span></span></code></pre></div><p><img src="/zh-cn/posts/%E5%B9%B3%E6%9D%BF%E6%B8%B8%E6%88%8F%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E8%AE%A1%E5%88%9223%E9%98%B6%E6%AE%B5/%E9%85%8D%E7%BD%AE%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95-20260121-6.png" alt=""></p>
<p>理想的输出结果如上。可以看到OpenGL的渲染器显示为zink。不理想的情况是显示为<code>llvmpipe</code>，表示此时正在使用CPU来跑图形，图像显示性能远远不比GPU。</p>
<p>glxgears运行成功vkcube也仍然可能运行失败，因为glxgears全链路运行在mesa这个超级聚合物中，而vkcube有很多东西需要自己手动配置，对于显示环境要求也更加严格。但是glxgears可以成功运行意味着mesa已经可以直接访问显卡，证明了访问显卡是可能的。</p>
<p>总之，一切顺利的话，运行<code>vkcube --wsi xcb</code>后，你应该可以得到旋转立方。这标志了三阶段的工作顺利结束。</p>
]]></content>
		</item>
		
		<item>
			<title>SEU程序设计复习02：远古老登</title>
			<link>http://localhost:1313/zh-cn/posts/seu%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A002%E8%BF%9C%E5%8F%A4%E8%80%81%E7%99%BB/</link>
			<pubDate>Mon, 19 Jan 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/seu%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A002%E8%BF%9C%E5%8F%A4%E8%80%81%E7%99%BB/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h1 id="本篇要素">本篇要素：<a href="#%e6%9c%ac%e7%af%87%e8%a6%81%e7%b4%a0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<ul>
<li>指针</li>
<li>C风格字符串</li>
<li>C风格数组</li>
<li>基本算法</li>
</ul>
<h1 id="指针">指针<a href="#%e6%8c%87%e9%92%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p><img src="/zh-cn/posts/seu%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A002%E8%BF%9C%E5%8F%A4%E8%80%81%E7%99%BB/SEU%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A002%E8%BF%9C%E5%8F%A4%E8%80%81%E7%99%BB-20260119-1.png" alt=""></p>
<p>众所周知，无论是什么程序语言，程序运行时的数据都缓存在内存上。内存就像一张超级大的草稿纸。对于机器来说，除了对内存写入的数据本身外，数据写入的位置同样重要。知道了数据写入的位置，我们才能随时利用我们写入的数据进行计算。</p>
<p>于是指针诞生了。如果说一般的变量是用来存储有价值的数据本身，指针的作用则是存储这些变量的内存地址，方便我们随时随地的调用这些变量。指针的本质仍然是变量，只不过它存储的内容是一个长十六进制的内存地址。</p>
<p>我们来举一个简单的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">114514</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>y <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>x;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> y <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#f92672">*</span>y <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>输出结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>0x7fc7cf03ac
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">114514</span>
</span></span></code></pre></div><p>其中第一个输出结果就是这个指针指向的变量的地址，而第二个输出结果则是这个变量的值。事实上，<code>*y</code>可以看做是x的一个别名，两者的行为完全一致，因为他们都是同一个地址上相同数据类型的变量。你可以给<code>*y</code>赋值，<code>x</code>的值就会被同步改变，因为在内存上它们的意义是相同的。</p>
<p>由于内存可以表示为一个长十六进制整数，所以自然我们对一个已知的内存进行加减就可以访问到它周围的数据。访问一个内存附近的元素有两种办法：直接对指针做加法，或者给指针追加下标：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">114514</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>y <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>x;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(y <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">191981</span>;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> y <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#f92672">*</span>y <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> y[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其中，<code>*(y+1)</code>访问y的内存的后一位并将其赋值为<code>191981</code>。在整个程序中，我们没有任何一个变量直接代表这个内存地址，我们是通过解引用的方式间接地访问到了这个地址。之后在输出阶段，我们调用<code>y[1]</code>同样表示的是y的内存的下一位的内容，所以理论上输出结果也应该是<code>191981</code>。</p>
<p>输出结果如下，符合预期：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>0x7fd11438cc
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">114514</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">191981</span>
</span></span></code></pre></div><p>这时候你会发现下标运算符似乎和数组中指定访问某个元素使用的操作符都是中括号。事实上，在C语言以及C++中，数组和指针在行为上确实非常类似，但是从根本上看两者是完全不同的东西。后面会提到。</p>
<p>接下来是比较八股的部分，在实际的C++编程中没有人类会这么写，但是出题人会。</p>
<ul>
<li><code>int *a, b</code>，这个语句中a是指针，b则是一个普通的变量。没有为什么，硬要理解的话<code>*a</code>和<code>b</code>都是int类型的变量。</li>
<li><code>int *p[4]</code>表示的是一个数组，每个元素为一个<code>*int</code>指针。</li>
<li><code>int (*p)[4]</code>表示的是一个数组，但是每个元素都是int数据。</li>
</ul>
<p>直接看这个是没用的，真正要尝试理解这种设计，我们必须要站在老登语言C语言的角度看待问题。</p>
<h2 id="如何站在c语言老登的视角看待指针">如何站在C语言老登的视角看待指针<a href="#%e5%a6%82%e4%bd%95%e7%ab%99%e5%9c%a8c%e8%af%ad%e8%a8%80%e8%80%81%e7%99%bb%e7%9a%84%e8%a7%86%e8%a7%92%e7%9c%8b%e5%be%85%e6%8c%87%e9%92%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>在C语言中几乎没有高级的数据结构，最高级的数据结构就是结构体和原始数组了。这时候处理问题就不得不直面手动内存管理的问题。</p>
<p>C语言一个最恶心的点在于，C语言有意识的在鼓励指针和数组之间的混淆。比如，很多时候指针和数组名的表现完全一致，甚至在将数组传参进入一个函数的时候完全就是指针。但是问题在于，数组和指针的底层实现完全不一致。</p>
<p>比如在下面这个例子中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> a[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>};
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> a;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, p[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>a是一个数组，p是一个指针，<code>int *p = a</code>之后p和a看起来指向的都是一个值，但是在底层上：</p>
<ul>
<li>p是一个变量，它自身有一个地址，而地址上存储的是数组第一个元素的地址。</li>
<li>a是一个<strong>别名</strong>。a没有地址，a就是这个数组第一个元素地址的别名。</li>
</ul>
<p>而对于一个常量指针，比如某个<code>int * const q = a</code>，它又有另一重底层意义：</p>
<ul>
<li>q是一个常量，但是它有自己的地址，它的地址上存储的数据是数组的第一个元素的地址。</li>
</ul>
<p>这就意味着数组和指针是完全不同的数据类型。a虽然可以隐式退化为指针，原因完全是因为他们的意义基本一致，但是这不代表它们是同一个东西。</p>
<p>同样，二维数组和二级指针根本上也不是一个东西。当我们写<code>int a[3][4]</code>时，a的类型是一个二维数组，当我们通过<code>a[1][1]</code>来访问元素的时候，C语言的底层实现方法不是通过指针进行间接访问，而是直接由下标计算偏移量。但是对于一个二级指针，我们可以让这个二级指针指向一个一级指针数组，再让一级指针指向一维数组，但是当我们想要访问元素时，底层的汇编指令是：先访问二级指针的地址，读取二级指针的存储的地址，再由这个地址加上偏移量访问一级指针，再由一级存储的地址加上偏移量访问元素。</p>
<p>所以，虽然你可以造出一个和二维数组行为完全一致的二级指针，但是归根结底它们是完全不同的两个东西。回到我们原本的问题，我们来重新的明确阐述一下我们原本想讨论的问题：</p>
<p>已知：</p>
<ul>
<li><code>int a[3]</code>是一个数组</li>
<li><code>int* p</code>是一个指针
问：</li>
<li><code>int* p[3]</code>是什么？</li>
<li><code>int (*p)[3]</code>是什么？</li>
</ul>
<p>其实这个问题的根本就在于：凭什么<code>int (*p)[3]</code>的写法是<strong>合法的</strong>？</p>
<p>比如，我们绝对不会写<code>int (x+1) = 2</code>然后希望x = 1。如果你在代码中这么写，那么你会喜提报错。但是<code>int (*p)[3]</code>却是合法的，它成功定义了一个变量，并且它的名字就是p。真正的诡异之处就在这里。</p>
<p>假如我们把<code>int*</code>看做一个整体，表示后面的东西是一个指针，那么<code>int* p[3]</code>是容易理解的，它代表的就是一个存放了一级指针的指针数组。但是在<code>int (*p)[3]</code>里，我们会觉得中间的<code>*p</code>放在这里是不讲道理的，因为我们理应认为这个地方不应该进行任何的计算操作，而*p表示的是对p解引用。</p>
<p>问题的答案是，C语言不是现代语言，而是远古老登。现代语言中我们会希望类型和标识符做到完全区分，而C语言的设计者遵循的原则是：声明的样子和使用时的样子应该完全一致。虽然我觉得这样也是不太讲道理的，但是对于理解这个问题意外的好用。</p>
<p>比如，在<code>int (*p)[3]</code>定义后，本质上说明了一件事情：假如我想使用p寻找某个元素，我就应该写<code>(*p)[i]</code>来做到这件事，即：对p进行一个<code>(*p)[i]</code>的操作后，得到的应该是一个整数。</p>
<p>那么，<code>(*p)</code>进行一个下标索引的操作后，得到的是一个整数，这就意味着<code>(*p)</code>本质上是一个数组，<code>p</code>的本质就是一个指针。对p解引用得到数组，就意味着p指针的基本类型就是数组。而p++就是下一个位置的数组，因此p和一个二维数组的行为是一致的，它们都可以表示连续内存中的一系列一维数组。此处的p叫做<strong>数组指针</strong>。</p>
<p>而同样的，假如我们要去理解<code>int *p[3]</code>，我们就会知道如果我们要使用p来找到某个元素，我们就会写<code>*p[3]</code>，而我们知道下标索引的优先级高于解引用，这就意味着<code>p[3]</code>得到的是一个指针，所以<code>p</code>的本质是一个数组，内部的元素是指针。此处的p叫做<strong>指针数组</strong>。</p>
<h3 id="常量指针指针常量">常量指针&amp;指针常量<a href="#%e5%b8%b8%e9%87%8f%e6%8c%87%e9%92%88%e6%8c%87%e9%92%88%e5%b8%b8%e9%87%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>常量指针：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> a <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span><span style="color:#f92672">*</span> p <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>a;
</span></span></code></pre></div><p>之后你可以使用<code>p = &amp;b</code>来修改p的指向，但是不能使用<code>*p = 30</code>来修改对应的值。</p>
<p>指针常量：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> a <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span><span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> p <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>a;
</span></span></code></pre></div><p>可以通过<code>*p = 30</code>来修改值，但是不能改变指向的地址。</p>
<h2 id="c风格数组">C风格数组<a href="#c%e9%a3%8e%e6%a0%bc%e6%95%b0%e7%bb%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>当我们将C风格数组作为参数传入函数时，数组名会<strong>退化为指针</strong>。这里就是完全意义上变为指针。</p>
<p>比如，当我们写：<code>void func(int arr[10]){...}</code>的时候，我们就等同于写<code>void func(int* arr)</code>。虽然我们前文中提到数组和指针是完全不同的两种东西，但是这里，数组退化为指针的事情就是真实地发生了。</p>
<p>这样的退化带来的第一个问题就是，我们没办法使用sizeof来获取一个数组的长度。最传统的做法就是添加一个参数来手动传入数组大小。</p>
<p>C风格数组传参时，以下写法是完全等价的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">f</span>(<span style="color:#66d9ef">int</span> arr[]);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">f</span>(<span style="color:#66d9ef">int</span> arr[<span style="color:#ae81ff">10</span>]);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">f</span>(<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span> arr);
</span></span></code></pre></div><p>等价的原因就在于无论原本是什么东西，在这里全部都会退化为指针。</p>
<p>但是假如我们需要传入一个多维数组，比如某个<code>int a[3][4]</code>，此时我们就不能写<code>f(a)</code>，原因在我们前面分析指针原则的时候其实涉及到了，程序员有各种各样的方式实现多维数组，所以多维数组没办法直接退化为某个指针。</p>
<p>以二维数组为例，原教旨主义的二维数组就是数组，内存连续。和它的行为最接近的是<strong>数组指针</strong>，所以传参时可以这么写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">foo</span>(<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>a)[<span style="color:#ae81ff">4</span>]);
</span></span></code></pre></div><p>此外，如果确定了列数，你也可以这么写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">foo</span>(<span style="color:#66d9ef">int</span> a[][<span style="color:#ae81ff">4</span>]);
</span></span></code></pre></div><p>但是<strong>不能</strong>这么写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">foo</span>(<span style="color:#66d9ef">int</span> a[][]);
</span></span></code></pre></div><h2 id="c风格字符串">C风格字符串<a href="#c%e9%a3%8e%e6%a0%bc%e5%ad%97%e7%ac%a6%e4%b8%b2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">char</span> s1[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello&#34;</span>;
</span></span></code></pre></div><p>等价于：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">char</span> s1[] <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;h&#39;</span>,<span style="color:#e6db74">&#39;e&#39;</span>,<span style="color:#e6db74">&#39;l&#39;</span>,<span style="color:#e6db74">&#39;l&#39;</span>,<span style="color:#e6db74">&#39;o&#39;</span>,<span style="color:#e6db74">&#39;\0&#39;</span>};
</span></span></code></pre></div><p>注意，<code>\0</code>标志一个字符串结束。</p>
<p>例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> str[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Helloworld!&#34;</span>;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> str <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> str1[] <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;H&#39;</span>, <span style="color:#e6db74">&#39;e&#39;</span>, <span style="color:#e6db74">&#39;l&#39;</span>, <span style="color:#e6db74">&#39;l&#39;</span>, <span style="color:#e6db74">&#39;o&#39;</span>, <span style="color:#e6db74">&#39;\0&#39;</span>};
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> str1 <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> str2[] <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;H&#39;</span>, <span style="color:#e6db74">&#39;e&#39;</span>, <span style="color:#e6db74">&#39;\0&#39;</span>, <span style="color:#e6db74">&#39;l&#39;</span>, <span style="color:#e6db74">&#39;l&#39;</span>, <span style="color:#e6db74">&#39;o&#39;</span>};
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> str2 <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>输出结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Helloworld<span style="color:#f92672">!</span>
</span></span><span style="display:flex;"><span>Hello
</span></span><span style="display:flex;"><span>He
</span></span></code></pre></div><h1 id="基本算法">基本算法<a href="#%e5%9f%ba%e6%9c%ac%e7%ae%97%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>在工程实践中，手写排序是被严格禁止的，因为你几乎不可能写的比标准库更好。但是对于考试只能说是不得不品的一环。</p>
<h2 id="冒泡排序">冒泡排序<a href="#%e5%86%92%e6%b3%a1%e6%8e%92%e5%ba%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>最佳实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;algorithm&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> bubbleSort(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&amp;</span> arr) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> arr.size();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> swapped;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>        swapped <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> n <span style="color:#f92672">-</span> i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#f92672">++</span>j) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (arr[j] <span style="color:#f92672">&gt;</span> arr[j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]) {
</span></span><span style="display:flex;"><span>                std<span style="color:#f92672">::</span>swap(arr[j], arr[j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>                swapped <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 如果没有发生交换，直接跳出循环
</span></span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>swapped) <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>基本原理就是进行多次迭代，每次都遍历一遍，如果某个位置前一个数字大于后一个，就将其交换；如果某次迭代的遍历过程中没有进行任何交换，就证明已经完成了从小到大的排序，可以结束计算了。</p>
<p>我们也可以使用原始数组来重写一遍：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">bubbleSort</span>(<span style="color:#66d9ef">int</span> arr[], <span style="color:#66d9ef">int</span> len) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> swapped <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> len <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> swapped; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    swapped <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> len <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> i; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (arr[j] <span style="color:#f92672">&gt;</span> arr[j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> temp <span style="color:#f92672">=</span> arr[j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>        arr[j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> arr[j];
</span></span><span style="display:flex;"><span>        arr[j] <span style="color:#f92672">=</span> temp;
</span></span><span style="display:flex;"><span>        swapped <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> arr[<span style="color:#ae81ff">10</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">3</span>};
</span></span><span style="display:flex;"><span>  bubbleSort(arr, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> arr[i] <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="选择排序">选择排序<a href="#%e9%80%89%e6%8b%a9%e6%8e%92%e5%ba%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> selectionSort(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&amp;</span> arr) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> arr.size();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#f92672">++</span>i) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> minIndex <span style="color:#f92672">=</span> i;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; j <span style="color:#f92672">&lt;</span> n; <span style="color:#f92672">++</span>j) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (arr[j] <span style="color:#f92672">&lt;</span> arr[minIndex]) {
</span></span><span style="display:flex;"><span>                minIndex <span style="color:#f92672">=</span> j;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (minIndex <span style="color:#f92672">!=</span> i) {
</span></span><span style="display:flex;"><span>            std<span style="color:#f92672">::</span>swap(arr[i], arr[minIndex]);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>原理是每次遍历后把遍历涉及的元素中最小的元素移到前面，之后的遍历不再关注前面的元素。时间复杂度和冒泡排序一致。（但是冒泡排序更方便设定排序规则，所以我更喜欢冒泡排序。）</p>
<p>同样使用原始数组实现一遍：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">selectionSort</span>(<span style="color:#66d9ef">int</span> arr[], <span style="color:#66d9ef">int</span> len) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> len; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> minIndex <span style="color:#f92672">=</span> i;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> i; j <span style="color:#f92672">&lt;</span> len; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (arr[j] <span style="color:#f92672">&lt;</span> arr[minIndex]) {
</span></span><span style="display:flex;"><span>        minIndex <span style="color:#f92672">=</span> j;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> temp <span style="color:#f92672">=</span> arr[i];
</span></span><span style="display:flex;"><span>    arr[i] <span style="color:#f92672">=</span> arr[minIndex];
</span></span><span style="display:flex;"><span>    arr[minIndex] <span style="color:#f92672">=</span> temp;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> arr[<span style="color:#ae81ff">10</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>  selectionSort(arr, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> arr[i] <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="快速排序">快速排序<a href="#%e5%bf%ab%e9%80%9f%e6%8e%92%e5%ba%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> partition(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&amp;</span> arr, <span style="color:#66d9ef">int</span> low, <span style="color:#66d9ef">int</span> high) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 优化：三数取中选基准
</span></span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> mid <span style="color:#f92672">=</span> low <span style="color:#f92672">+</span> (high <span style="color:#f92672">-</span> low) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (arr[mid] <span style="color:#f92672">&lt;</span> arr[low]) std<span style="color:#f92672">::</span>swap(arr[mid], arr[low]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (arr[high] <span style="color:#f92672">&lt;</span> arr[low]) std<span style="color:#f92672">::</span>swap(arr[high], arr[low]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (arr[high] <span style="color:#f92672">&lt;</span> arr[mid]) std<span style="color:#f92672">::</span>swap(arr[high], arr[mid]);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    T pivot <span style="color:#f92672">=</span> arr[mid];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> low <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> high <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (true) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span> { i<span style="color:#f92672">++</span>; } <span style="color:#66d9ef">while</span> (arr[i] <span style="color:#f92672">&lt;</span> pivot);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span> { j<span style="color:#f92672">--</span>; } <span style="color:#66d9ef">while</span> (arr[j] <span style="color:#f92672">&gt;</span> pivot);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;=</span> j) <span style="color:#66d9ef">return</span> j;
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>swap(arr[i], arr[j]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> quickSort(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&amp;</span> arr, <span style="color:#66d9ef">int</span> low, <span style="color:#66d9ef">int</span> high) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (low <span style="color:#f92672">&lt;</span> high) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> p <span style="color:#f92672">=</span> partition(arr, low, high);
</span></span><span style="display:flex;"><span>        quickSort(arr, low, p);
</span></span><span style="display:flex;"><span>        quickSort(arr, p <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, high);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 辅助调用接口
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> quickSort(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&amp;</span> arr) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>arr.empty()) {
</span></span><span style="display:flex;"><span>        quickSort(arr, <span style="color:#ae81ff">0</span>, arr.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>顾名思义，快速排序算法确实非常快。冒泡排序和选择排序的速度都是$O(n^2)$，而快速排序的时间复杂度则是$O(n\log n)$。我们来尝试理解下它的工作原理。</p>
<p>快速排序的基本思想是：每次从一个分区中选取一个<strong>基准值</strong>，比它大的数字全部移动到右边，比它小的全部移动到左边，以交换过程最后的临界点作为分区界线形成了两个分区，之后再在这两个分区中重复这个过程。这样，每次进行分区就意味着一个数字找到了正确的位置，而分区量呈指数级增长，每次分区计算的用时和总数成正比，故时间复杂度为$O(n\log n)$。</p>
<p>在上面这段代码中，选取基准值的方法是在一个分区的最左、最右和最中间的三个元素中选出中间的那个数字，然后动用两个指针向基准值收缩，实现分区，之后再通过递归完成整体的排序。</p>
<p>原始数组实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">swap</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>a, <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>b) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> temp <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>a;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>a <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>b;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>b <span style="color:#f92672">=</span> temp;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">partition</span>(<span style="color:#66d9ef">int</span> arr[], <span style="color:#66d9ef">int</span> low, <span style="color:#66d9ef">int</span> high) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> mid <span style="color:#f92672">=</span> low <span style="color:#f92672">+</span> (high <span style="color:#f92672">-</span> low) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (arr[mid] <span style="color:#f92672">&lt;</span> arr[low])
</span></span><span style="display:flex;"><span>    swap(arr <span style="color:#f92672">+</span> mid, arr <span style="color:#f92672">+</span> low);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (arr[high] <span style="color:#f92672">&lt;</span> arr[low])
</span></span><span style="display:flex;"><span>    swap(arr <span style="color:#f92672">+</span> high, arr <span style="color:#f92672">+</span> low);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (arr[high] <span style="color:#f92672">&lt;</span> arr[mid])
</span></span><span style="display:flex;"><span>    swap(arr <span style="color:#f92672">+</span> high, arr <span style="color:#f92672">+</span> mid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> pivot <span style="color:#f92672">=</span> arr[mid];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> low <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> high <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (true) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>      i<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">while</span> (arr[i] <span style="color:#f92672">&lt;</span> arr[mid]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>      j<span style="color:#f92672">--</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">while</span> (arr[j] <span style="color:#f92672">&gt;</span> arr[mid]);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (i <span style="color:#f92672">&gt;=</span> j)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> j;
</span></span><span style="display:flex;"><span>    swap(arr <span style="color:#f92672">+</span> i, arr <span style="color:#f92672">+</span> j);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">quickSort</span>(<span style="color:#66d9ef">int</span> arr[], <span style="color:#66d9ef">int</span> low, <span style="color:#66d9ef">int</span> high) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (low <span style="color:#f92672">&lt;</span> high) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> p <span style="color:#f92672">=</span> partition(arr, low, high);
</span></span><span style="display:flex;"><span>    quickSort(arr, low, p);
</span></span><span style="display:flex;"><span>    quickSort(arr, low <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, high);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> arr[<span style="color:#ae81ff">10</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>  quickSort(arr, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">9</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> arr[i] <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="线性查找">线性查找<a href="#%e7%ba%bf%e6%80%a7%e6%9f%a5%e6%89%be" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>从头到尾依次查找最符合条件的元素。就像苏格拉底最大的麦穗的寓言故事。</p>
<p>懒得写了。</p>
<h2 id="二分查找">二分查找<a href="#%e4%ba%8c%e5%88%86%e6%9f%a5%e6%89%be" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>假如你要查找的元素总体是按照从小到大或者从大到小的顺序排列的，那么如果你要找到某个元素的位置就不需要把所有元素都搜一遍。我们只需要每次找到最中间的点，之后如果目标比中值大，则向右寻找，否则想左寻找。这样时间复杂度就大大减少。</p>
<p>以下提供一种基于递归的解法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;algorithm&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstdlib&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ctime&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iomanip&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> arr[<span style="color:#ae81ff">10</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//这一部分是搜索算法。
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">binarySearch</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> arr[], <span style="color:#66d9ef">int</span> low, <span style="color:#66d9ef">int</span> high, <span style="color:#66d9ef">int</span> target) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (low <span style="color:#f92672">&gt;</span> high)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> mid <span style="color:#f92672">=</span> low <span style="color:#f92672">+</span> (high <span style="color:#f92672">-</span> low) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (target <span style="color:#f92672">==</span> arr[mid])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> mid;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (target <span style="color:#f92672">&lt;</span> arr[mid])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> binarySearch(arr, low, mid <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, target);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> binarySearch(arr, mid <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, high, target);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">renewArray</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">sizeof</span>(arr) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>); i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    arr[i] <span style="color:#f92672">=</span> rand() <span style="color:#f92672">%</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>sort(arr, arr <span style="color:#f92672">+</span> <span style="color:#ae81ff">9</span>); <span style="color:#75715e">//注意，这里需要进行排序，原因是二分查找只能适用于已经排序的数组。
</span></span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>srand(time(<span style="color:#66d9ef">nullptr</span>));
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>left;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">20</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    renewArray();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>setw(<span style="color:#ae81ff">8</span>) <span style="color:#f92672">&lt;&lt;</span> arr[j];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Index: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> binartSearch(arr, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">50</span>) <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然而，虽然说着容易，实际实践的时候经常会出现内存越界和死循环的问题。原因是分区的边界情况非常的不好考虑。以下罗列两种公认的最优写法。</p>
<p>第一种被称为“经典精确查找”，做了很多防范问题的措施。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> binarySearch(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&amp;</span> nums, T target) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> left <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> right <span style="color:#f92672">=</span> nums.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// [left, right] 闭区间
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (left <span style="color:#f92672">&lt;=</span> right) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 防止溢出的写法，等同于 (left + right) / 2
</span></span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> mid <span style="color:#f92672">=</span> left <span style="color:#f92672">+</span> (high <span style="color:#f92672">-</span> low) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (nums[mid] <span style="color:#f92672">==</span> target) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> mid; <span style="color:#75715e">// 找到了
</span></span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">if</span> (nums[mid] <span style="color:#f92672">&lt;</span> target) {
</span></span><span style="display:flex;"><span>            left <span style="color:#f92672">=</span> mid <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// 目标在右半部分
</span></span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            right <span style="color:#f92672">=</span> mid <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#75715e">// 目标在左半部分
</span></span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// 未找到
</span></span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>另一种是所谓的“寻找边界写法”，在有目标值的时候返回符合的值中第一个目标的索引值，如果没有则返回第一个大于目标值的位置。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> lowerBound(<span style="color:#66d9ef">const</span> std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;&amp;</span> nums, T target) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> left <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> right <span style="color:#f92672">=</span> nums.size(); <span style="color:#75715e">// [left, right) 左闭右开区间
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (left <span style="color:#f92672">&lt;</span> right) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> mid <span style="color:#f92672">=</span> left <span style="color:#f92672">+</span> (right <span style="color:#f92672">-</span> left) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (nums[mid] <span style="color:#f92672">&lt;</span> target) {
</span></span><span style="display:flex;"><span>            left <span style="color:#f92672">=</span> mid <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 当 nums[mid] &gt;= target 时，收缩右边界
</span></span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 这样会不断向左逼近第一个等于 target 的位置
</span></span></span><span style="display:flex;"><span>            right <span style="color:#f92672">=</span> mid;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> left; <span style="color:#75715e">// 此时 left == right
</span></span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="最大公因数">最大公因数<a href="#%e6%9c%80%e5%a4%a7%e5%85%ac%e5%9b%a0%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">gcd</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> b <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> a : gcd(b, a <span style="color:#f92672">%</span> b);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>原理是$gcd(a,b) = gcd(b,a\%b)$。</p>
]]></content>
		</item>
		
		<item>
			<title>近日神必脑洞合集</title>
			<link>http://localhost:1313/zh-cn/posts/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E%E5%90%88%E9%9B%86/</link>
			<pubDate>Sun, 18 Jan 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E%E5%90%88%E9%9B%86/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h2 id="平板文件管理辅助系统">平板文件管理辅助系统<a href="#%e5%b9%b3%e6%9d%bf%e6%96%87%e4%bb%b6%e7%ae%a1%e7%90%86%e8%be%85%e5%8a%a9%e7%b3%bb%e7%bb%9f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p><img src="/zh-cn/posts/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E%E5%90%88%E9%9B%86/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E-20260118-2.png" alt=""></p>
<p>由于本人没有比较轻量的轻薄本，平时上课用的都是平板。我最大的心愿就是可以在平板上干所有电脑上能干的事情。比如日常的博客发布，每次都要手动把图片和markdown文件打包起来，然后还要打开电脑，把东西放进去再发布，实在太蠢了。既然文章都是在平板上写的，为什么不在平板上发布呢？</p>
<p>此外还有obsidian的文件管理，之前一直是基于俺寻思能行的文件结构组织obsidian的笔记，导致每写一个随笔第二天就消失在文件的海洋里了。</p>
<p>所以为了让整个流程更加懒狗，我使用vibe coding大法做了一个简单的可加装插件来拓展功能的文件管理系统，文件结构大致如下：</p>
<p><img src="/zh-cn/posts/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E%E5%90%88%E9%9B%86/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E-20260118-3.png" alt=""></p>
<p><img src="/zh-cn/posts/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E%E5%90%88%E9%9B%86/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E-20260118-4.png" alt=""></p>
<p>plugins目录下的每个文件夹（比如obsidian）或者单一文件（比如num_add.py）代表了一个插件。这里我暂时只写了4个插件：ob插件，负责管理obsidian文件和打包博客文；blog插件，负责双向同步博客文并发布；num_add，测试用插件；help，用来显示插件描述。</p>
<p><img src="/zh-cn/posts/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E%E5%90%88%E9%9B%86/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E-20260118-6.png" alt=""></p>
<p>obs插件最后实现的效果是，在使用obsidian写笔记的时候，我可以完全不关心笔记如何整理，只要我进入cc后运行<code>obs clean</code>所有的根目录md文件都会被自动收纳进以日期命名的文件夹中。如果我想打包一个博客文，我只需要在这个笔记的标签处写入一个<code>blog</code>标签，在运行<code>obs pack</code>，它就可以自动打包为一个可以直接移动到博客源文件的文章包。以防你不知道，md文件是纯文本文件，如果想加图片必须和md文件打包在同一个文件夹才行。</p>
<p>总而言之，本质上这就是一个python脚本管理器，我可以通过这个程序集中地管理和运行python脚本。想要拓展功能也非常简单，只需要在插件里塞新内容即可。</p>
<h2 id="平板数位板支持">平板数位板支持<a href="#%e5%b9%b3%e6%9d%bf%e6%95%b0%e4%bd%8d%e6%9d%bf%e6%94%af%e6%8c%81" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>数位板通常接在电脑上用来画画，但是为什么不能把数位板接在平板上来记笔记呢？</p>
<p>我知道这听起来可能很蠢，都用平板了为什么不直接用电容笔。对我来说一个不得不关注的现实情况是：我没有电容笔，但是我有数位板。其次是数位板的手感可能比电容笔要好得多，毕竟电容笔是直接在玻璃板上划拉的。</p>
<p>虽然这个理由对我来说足够充分了，但是对于Android设备厂商来说并非如此。在平板上使用数位板在这个世界中是一个小众需求。所以我——没办法，我也没办法让平板和数位板很好的相互支持。所以如果有富哥看到这个文章可以考虑赞助我一个vivo电容笔。</p>
<p>我一开始尝试通过本地运行一个proot distro +termux x11的方式来适配数位板，理论上如果proot distro真的就是一个独立的linux系统，这样做是没问题的，可惜不是。经过一天的折腾最后也没办法让数位板在平板上稳定工作，遂放弃。</p>
<p>可能之后会考虑购入一个电容笔。</p>
<h2 id="minecraft模组">Minecraft模组<a href="#minecraft%e6%a8%a1%e7%bb%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>模组是有在写的，只不过最近很不巧的和考试周撞了。</p>
<p>目前而言写模组的一个痛点在于我还不太能完全领悟java程序员的心智模型，简单来说就是我完全不知道那些模组开发者是怎么知道什么地方应该放什么文件和写什么代码的。模组不是重头开始写一个应用，而是在大多数开发场景中直接使用模组加载器提供的接口。这可能对于软件工程师是一项基本功，然而我还需要一定的时间适应这种写法。</p>
<p>不过，不写java代码其实也可以实现一些模组的制作。在1.18之后mojang开始推数据驱动，如果只是想改个世界生成、改个配方，或者调整战利品生成，在高版本直接写json数据包就可以实现了。所以最近花了一点点时间做了一个简单（其实是简陋）的新维度模组，大概效果如图：</p>
<p><img src="/zh-cn/posts/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E%E5%90%88%E9%9B%86/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E-20260118-1.jpg" alt=""></p>
<p>总之坑已经挖了，之后慢慢填坑吧。我的一个大致构想是学一些基本的模组写法，之后尝试用写模组的方式来开发整合包，自己写模组来整合一些简单的小功能。</p>
<h2 id="termux-x11游戏环境适配">termux x11游戏环境适配<a href="#termux-x11%e6%b8%b8%e6%88%8f%e7%8e%af%e5%a2%83%e9%80%82%e9%85%8d" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p><img src="/zh-cn/posts/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E%E5%90%88%E9%9B%86/%E8%BF%91%E6%97%A5%E7%A5%9E%E5%BF%85%E8%84%91%E6%B4%9E-20260118-7.png" alt=""></p>
<p>在平板上玩移动游戏很常见，在电脑上玩steam游戏也很常见，那我们为什么不能在平板上玩电脑游戏呢？</p>
<p>总之通过proot distro + termux x11，我在平板上上配置了一个ubuntu系统+桌面环境。我希望的效果是能在这个环境下运行steam游戏。然而目前看来这可能会是有点难度的事情。在x86架构的linux电脑上运行游戏不难，在windows系统上运行游戏也不难，但是这是一个arm64架构的·平板的·看起来像linux发行版但是实际不是的·一个环境，想要运行游戏难度就有点大了。</p>
<p>暂时没有成功。</p>
<h2 id="树莓派qq机器人">树莓派qq机器人<a href="#%e6%a0%91%e8%8e%93%e6%b4%beqq%e6%9c%ba%e5%99%a8%e4%ba%ba" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>树莓派已经吃灰了几个月了，但是平时感觉真的很难抽出时间折腾。只能说先把flag立了，至于实现有缘再说。不过早晚要实现的，不然树莓派白买了。</p>
<h2 id="寒假要做点什么">寒假要做点什么？<a href="#%e5%af%92%e5%81%87%e8%a6%81%e5%81%9a%e7%82%b9%e4%bb%80%e4%b9%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>可能把D2L学了，如果有时间可能会把cs61b顺带学了（因为感觉自己实际上写代码还是写的太少了，还是想要多手写一点代码来保持手感）。</p>
]]></content>
		</item>
		
		<item>
			<title>SEU程序设计复习01：基础语法</title>
			<link>http://localhost:1313/zh-cn/posts/seu%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A001%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/</link>
			<pubDate>Sat, 17 Jan 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/seu%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A001%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h1 id="本学期涉及内容">本学期涉及内容：<a href="#%e6%9c%ac%e5%ad%a6%e6%9c%9f%e6%b6%89%e5%8f%8a%e5%86%85%e5%ae%b9" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<ul>
<li>第二章：C++程序入门、输入输出和运算符</li>
<li>第三章：类、对象、字符串</li>
<li>第四章：控制语句、赋值、自增、自减</li>
<li>第五章：控制语句和逻辑运算符</li>
<li>第六章：函数和递归入门</li>
<li>第七章：类模版array和vector、异常捕捉（没学）</li>
<li>第八章：指针</li>
</ul>
<h1 id="第一章省流版">第一章省流版：<a href="#%e7%ac%ac%e4%b8%80%e7%ab%a0%e7%9c%81%e6%b5%81%e7%89%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p><img src="/zh-cn/posts/seu%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A001%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/SEU%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A001-20260117-1.png" alt=""></p>
<p>欢迎进入C++的世界！
C++功能很多。
计算机由各种基本单元组成。（不知道会不会考，但是反正是开卷的也无所谓了）
计算机有各种各样的编程语言。</p>
<p><strong>面向对象</strong></p>
<ul>
<li>小汽车：对象</li>
<li>小汽车会跑：成员函数</li>
<li>小汽车蓝图：类</li>
<li>由蓝图制造小汽车：实例化、重用</li>
<li>踩踏板：成员函数调用</li>
<li>小汽车速度：属性、数据成员</li>
<li>驾驶员无需知道汽车工作原理：封装</li>
<li>由一般性的汽车细化设计得到敞篷车：继承</li>
<li>无论什么车都可以用方向盘控制：多态</li>
</ul>
<h1 id="各种内容总结">各种内容总结<a href="#%e5%90%84%e7%a7%8d%e5%86%85%e5%ae%b9%e6%80%bb%e7%bb%93" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>直接从书上复制内容太无聊了，所以后面的内容可能和书本章节并不对应，主打一个随心所欲。</p>
<h2 id="良好的编程习惯">良好的编程习惯<a href="#%e8%89%af%e5%a5%bd%e7%9a%84%e7%bc%96%e7%a8%8b%e4%b9%a0%e6%83%af" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p><img src="/zh-cn/posts/seu%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A001%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/SEU%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A001-20260117-2.png" alt=""></p>
<h2 id="main函数">main函数<a href="#main%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>每个C++程序都要有，表示程序运行的入口。除非你要做并行计算，不管你的程序文件结构有多复杂，机器永远是像读纸带八音盒那样一条一条读你的程序。所以需要有一个函数作为入口是理所当然的，就像纸带必须要有个一端接入八音盒（我们不考虑某种环形或者莫比乌斯环形的纸带）。</p>
<p>一个简单的不能再简单的程序：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Helloworld!!&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>语句要用英文键盘的分号结尾。</p>
<p>你可以在开头使用<code>using namespace std;</code>来在后续写代码过程中省略<code>std::</code>的书写，但是一般认为这样做是可能带来不好后果的（比如假如你自己定义了某个函数名字恰好和std下的某个函数重合了，程序就会开始打架）。所以如果追求更好的程序质量，最好不要省略<code>std::</code>。</p>
<h2 id="多个语句输出在一行">多个语句输出在一行：<a href="#%e5%a4%9a%e4%b8%aa%e8%af%ad%e5%8f%a5%e8%be%93%e5%87%ba%e5%9c%a8%e4%b8%80%e8%a1%8c" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Welcome to&#34;</span>;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;C++&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>感觉这个地方太简单了，我们稍微略过一些内容。</p>
<p>以下解答一些术语上的误区和一些我个人没那么有把握熟练掌握的东西：</p>
<h2 id="什么是关键字什么是标识符">什么是关键字？什么是标识符？<a href="#%e4%bb%80%e4%b9%88%e6%98%af%e5%85%b3%e9%94%ae%e5%ad%97%e4%bb%80%e4%b9%88%e6%98%af%e6%a0%87%e8%af%86%e7%ac%a6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>关键字就是程序语言自己定义的具有特定语义的单词，比如<code>int</code>表示整型，<code>if</code>表示条件判断，标识符则是程序员自己定义的，比如随便一个变量<code>int thisIsARandomNumble = 1</code>，没有人会把一个变量命名为<code>if</code>或者<code>int</code>（比如某人写<code>int int = 1</code>）。</p>
<h2 id="using的用法">using的用法<a href="#using%e7%9a%84%e7%94%a8%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>一个最简单的用法：引用整个命名空间：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> <span style="color:#66d9ef">namespace</span> std;
</span></span></code></pre></div><p>这样做是合法的，但是可能导致名字冲突，并降低代码可读性。一般不推荐省这一点代码量。</p>
<p>与之相比，只引入某个函数名是更加推荐的写法，可以更加灵活的避免命名冲突的同时加快写代码的速度。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> std<span style="color:#f92672">::</span>cout;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 表示后面的代码中不用写std::cout或者std::endl，直接写cout或者endl即可。
</span></span></span></code></pre></div><p>但是using的用法不止于此。比如如果你要处理一个比较大的数字，你可能需要用到容量比int更大的数据类型，一般的考虑对象就是<code>long long</code>，因为它的大小在各种环境下是固定的64个bit。但是，<code>long long</code>写起来太长了，这时候你就可以写<code>using ll = long long;</code>来给<code>long long</code>起个别名。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iomanip&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> ll <span style="color:#f92672">=</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> n <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  ll temp <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> n; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    temp <span style="color:#f92672">&lt;&lt;=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (temp <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> temp <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>setw(<span style="color:#ae81ff">4</span>) <span style="color:#f92672">&lt;&lt;</span> counter <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    counter<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    temp <span style="color:#f92672">/=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这段代码的功能是计算了2的60次方，随后一直除2直到为0，记录其中的计算次数，证明一开始算出来的确实是2的60次方。输出结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ae81ff">1152921504606846976</span>   <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">576460752303423488</span>   <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">288230376151711744</span>   <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">144115188075855872</span>   <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">72057594037927936</span>   <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">36028797018963968</span>   <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">18014398509481984</span>   <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">9007199254740992</span>   <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4503599627370496</span>   <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2251799813685248</span>   <span style="color:#ae81ff">9</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1125899906842624</span>  <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">562949953421312</span>  <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">281474976710656</span>  <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">140737488355328</span>  <span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">70368744177664</span>  <span style="color:#ae81ff">14</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">35184372088832</span>  <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">17592186044416</span>  <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8796093022208</span>  <span style="color:#ae81ff">17</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4398046511104</span>  <span style="color:#ae81ff">18</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2199023255552</span>  <span style="color:#ae81ff">19</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1099511627776</span>  <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">549755813888</span>  <span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">274877906944</span>  <span style="color:#ae81ff">22</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">137438953472</span>  <span style="color:#ae81ff">23</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">68719476736</span>  <span style="color:#ae81ff">24</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">34359738368</span>  <span style="color:#ae81ff">25</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">17179869184</span>  <span style="color:#ae81ff">26</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8589934592</span>  <span style="color:#ae81ff">27</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4294967296</span>  <span style="color:#ae81ff">28</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2147483648</span>  <span style="color:#ae81ff">29</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1073741824</span>  <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">536870912</span>  <span style="color:#ae81ff">31</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">268435456</span>  <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">134217728</span>  <span style="color:#ae81ff">33</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">67108864</span>  <span style="color:#ae81ff">34</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">33554432</span>  <span style="color:#ae81ff">35</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">16777216</span>  <span style="color:#ae81ff">36</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8388608</span>  <span style="color:#ae81ff">37</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4194304</span>  <span style="color:#ae81ff">38</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2097152</span>  <span style="color:#ae81ff">39</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1048576</span>  <span style="color:#ae81ff">40</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">524288</span>  <span style="color:#ae81ff">41</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">262144</span>  <span style="color:#ae81ff">42</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">131072</span>  <span style="color:#ae81ff">43</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">65536</span>  <span style="color:#ae81ff">44</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">32768</span>  <span style="color:#ae81ff">45</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">16384</span>  <span style="color:#ae81ff">46</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8192</span>  <span style="color:#ae81ff">47</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4096</span>  <span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2048</span>  <span style="color:#ae81ff">49</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1024</span>  <span style="color:#ae81ff">50</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">512</span>  <span style="color:#ae81ff">51</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">256</span>  <span style="color:#ae81ff">52</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">128</span>  <span style="color:#ae81ff">53</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span>  <span style="color:#ae81ff">54</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">32</span>  <span style="color:#ae81ff">55</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">16</span>  <span style="color:#ae81ff">56</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span>  <span style="color:#ae81ff">57</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">4</span>  <span style="color:#ae81ff">58</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">59</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">60</span>
</span></span></code></pre></div><p>但是如果我们开头不写<code>using ll = long long;</code>，而是写<code>using ll = int;</code>，程序就不会有任何输出（或者某些环境下会报错），原因是数据溢出了。</p>
<h2 id="随机数生成">随机数生成<a href="#%e9%9a%8f%e6%9c%ba%e6%95%b0%e7%94%9f%e6%88%90" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>在cpp中有很多种方式可以用来生成随机数。其中，最省事的方法是直接使用<code>&lt;cstdlib&gt;</code>提供的<code>rand()</code>函数。这是一种从C语言时代遗留下来的老古董，应该说正经写cpp代码的时候不应该再使用这个函数了，但是不得不说在做一些小功能的时候这种写法非常方便。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstdlib&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (true) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> rand();
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> i <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> state;
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cin <span style="color:#f92672">&gt;&gt;</span> state;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (state)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>以上例子中，程序会一直生成一个随机数直到你输入1或者某个表示true的文本。某次输出如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ae81ff">1804289383</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">846930886</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1681692777</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1714636915</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1957747793</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">424238335</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>看起来确实挺随机的，但是这样做有一个很大的问题：每次运行程序输出的随机数都一样。原因就在于其实<code>rand()</code>函数实现随机数的方式非常的蠢，蠢到你可以自己手算。<code>rand()</code>函数通常的实现方式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">rand</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>    next <span style="color:#f92672">=</span> next <span style="color:#f92672">*</span> A <span style="color:#f92672">+</span> C;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (next <span style="color:#f92672">/</span> D) <span style="color:#f92672">%</span> M;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其中next是一个静态全局变量。你很容易发现：<code>rand()</code>的实现方式其实就是加减乘除。毫不夸张的说，你可以随便拉一个小学生过来给他一个初始值，让他帮你计算随机数。但是之所以这样做仍然得到推广，就在于它的实现效果比意料中的其实要好。</p>
<p>一个常见的参数如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>A <span style="color:#f92672">=</span> <span style="color:#ae81ff">1103515245</span>
</span></span><span style="display:flex;"><span>C <span style="color:#f92672">=</span> <span style="color:#ae81ff">12345</span>
</span></span><span style="display:flex;"><span>M <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">31</span>
</span></span></code></pre></div><p>假如你随便告诉小学生一个初始值，让他帮你按照前面的算法一步步计算数值，虽然每一步都完全确定，但是对于一个不知道计算算法也不知道初始值的人，就很难看出生成的数值有什么规律。这就是伪随机的本质。</p>
<p>但是，这一切的前提是，你要给小学生一个随机的初始值。假如你每次都给他一个一样的值，他每次也都会计算出一样的答案（除非他算错了，当然这是很可能的事），这样就不随机了。可惜的是，<code>rand()</code>函数并不负责提供这个随机的初始值，它只负责采样，而这个初始值在没有人为设定的情况下每次都是一样的，这就导致每次运行程序生成的随机数都一样。</p>
<p>那么，假如我们想要一开始时提供一个随机的初始值（此处专业术语即“种子”），一个比较容易想到的方案是：用时间作为种子。<code>&lt;time&gt;</code>标准库提供了获取时间和时间计算的方法。其中，<code>time(nullptr)</code>获取的是从公元某某年开始到现在的<strong>秒数</strong>。</p>
<p>我们来做一个简单的实验：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstddef&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ctime&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ios&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>fixed;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (true) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">double</span> t <span style="color:#f92672">=</span> time(<span style="color:#66d9ef">nullptr</span>);
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> t <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> state;
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cin <span style="color:#f92672">&gt;&gt;</span> state;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (state)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这段函数的作用是每次输出一下当前的秒数。因为<code>cin</code>是阻塞的，所以理论上每次输出的数值间隔取决于你输入的频率。</p>
<p>以下是某次输出的结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>1768788441.000000
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>1768788443.000000
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>1768788445.000000
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>1768788449.000000
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>1768788450.000000
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>1768788451.000000
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>1768788454.000000
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>可以看到，<code>time(nullptr)</code>获取的时间本质上是一个整数，只能精确到秒。通过以上的输出，你其实可以推算出我运行这段程序时的绝对时间。</p>
<p>回归正题，我们需要生成一系列随机数，直接使用<code>rand()</code>函数无法实现每次都随机，直接使用<code>time()</code>函数更不是随机。但是假如我们用<code>time()</code>来作为随机数计算的“种子”，整个过程感官上就非常随机了。</p>
<p>实现方法是，在程序开始前使用<code>srand(time(nullptr))</code>来以当前时间作为种子，之后每次使用<code>rand()</code>函数，我们就可以实现随机数的获取了。</p>
<p>我们来做一个简单的掷骰子小游戏：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstdlib&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ctime&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> maxHealth <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">throwADice</span>() { <span style="color:#66d9ef">return</span> rand() <span style="color:#f92672">%</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>srand(time(<span style="color:#66d9ef">nullptr</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> currentHealth <span style="color:#f92672">=</span> maxHealth;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (true) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> answer <span style="color:#f92672">=</span> throwADice();
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;I throw a dice, guess the value of it:&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> assumption;
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cin <span style="color:#f92672">&gt;&gt;</span> assumption;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (assumption <span style="color:#f92672">==</span> answer) {
</span></span><span style="display:flex;"><span>      std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Damn! You get it!&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (abs(assumption <span style="color:#f92672">-</span> answer) <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>      std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Almost figured out.&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>      std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Current Health:&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;&lt;</span> (currentHealth <span style="color:#f92672">&gt;=</span> maxHealth <span style="color:#f92672">?</span> maxHealth : <span style="color:#f92672">++</span>currentHealth)
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;You completely WRONG!!!&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>      std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Current Health:&#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#f92672">--</span>currentHealth <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (currentHealth <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>      std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;You failed.&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>每回合会投一个六面骰子，假如你猜中了它的点数你就赢了，假如猜测的值和真实值只相差1，那么你会恢复一个生命值，否则你减一点生命值。</p>
<p>某次的输出结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>I throw a dice, guess the value of it:3
</span></span><span style="display:flex;"><span>Almost figured out.
</span></span><span style="display:flex;"><span>Current Health:3
</span></span><span style="display:flex;"><span>I throw a dice, guess the value of it:3
</span></span><span style="display:flex;"><span>Almost figured out.
</span></span><span style="display:flex;"><span>Current Health:3
</span></span><span style="display:flex;"><span>I throw a dice, guess the value of it:3
</span></span><span style="display:flex;"><span>You completely WRONG!!!
</span></span><span style="display:flex;"><span>Current Health:2
</span></span><span style="display:flex;"><span>I throw a dice, guess the value of it:3
</span></span><span style="display:flex;"><span>You completely WRONG!!!
</span></span><span style="display:flex;"><span>Current Health:1
</span></span><span style="display:flex;"><span>I throw a dice, guess the value of it:3
</span></span><span style="display:flex;"><span>You completely WRONG!!!
</span></span><span style="display:flex;"><span>Current Health:0
</span></span><span style="display:flex;"><span>You failed.
</span></span></code></pre></div><p>总之，考试会涉及的随机数生成方法大致就是如上了。但是从上面的分析过程中，你会发现这种原始的生成随机数的方法实际上有很多缺点，一方面它的计算算法简单导致随机数周期很短，另一方面在同一程序中你没办法“并发”的生成多个不同的随机数，因为所有随机数共用用一套种子。此外还有种种缺点，此处不再赘述。</p>
<p>如果想要更加现代的实现方式，我们需要使用C++的<code>&lt;random&gt;</code>库。但是我现在有点懒得写了。</p>
<h2 id="template函数模板">template函数模板<a href="#template%e5%87%bd%e6%95%b0%e6%a8%a1%e6%9d%bf" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>这是一个非常强大的功能，可以让你的函数用同一套逻辑处理多种类型的数据。</p>
<p>一个简单的例子：假如你想要实现一个“加法”功能，返回两数之和，你可能会这么写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> a <span style="color:#f92672">+</span> b;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>但是这样写没办法用来计算double类型的数据，所以为了计算double类型的数据，你又写了一个同名的函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b) { <span style="color:#66d9ef">return</span> a <span style="color:#f92672">+</span> b; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">double</span> <span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">double</span> a, <span style="color:#66d9ef">double</span> b) { <span style="color:#66d9ef">return</span> a <span style="color:#f92672">+</span> b; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> x, y;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cin <span style="color:#f92672">&gt;&gt;</span> x <span style="color:#f92672">&gt;&gt;</span> y;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> add(x, y) <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">double</span> m, n;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cin <span style="color:#f92672">&gt;&gt;</span> m <span style="color:#f92672">&gt;&gt;</span> n;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> add(m, n) <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这样，你就可以实现整数和整数相加、浮点数和浮点数相加。</p>
<p>但是“对于聪明的懒程序员”，既然这两个函数除了类型外完全一样，那我们为什么不写在一起呢？所以，我们完全可以这样写一个新的可以处理所有类型的<code>add</code>函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">template</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> thisIsAType<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>thisIsAType add(thisIsAType a, thisIsAType b){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> a <span style="color:#f92672">+</span> b;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>之所以写<code>thisIsAType</code>意在说明这个地方写啥都行。实现的效果和写两个函数完全一致。需要注意的是，虽然后续你可以直接写<code>add</code>来表示两数相加，但是本质上经过了一个隐式的实例化过程。比如你想将两个整数相加，程序会先隐式转换为<code>add&lt;int&gt;</code>，之后再进行计算。也就是说，真正调用的是<code>add&lt;int&gt;</code>，add本身只是一个函数模版而非一个实际可以直接使用的函数。比如，对于两个<code>int</code>类型的变量a,b，你可以写<code>add(a, b)</code>，但是你也可以显式实例化的写作<code>add&lt;int&gt;(a, b)</code>，两者完全一致。</p>
<p>这里的<code>typename</code>表示这里是随便某个类型的代称。但是，这并不代表这里只能写typename，比如你可以这么写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T, <span style="color:#66d9ef">int</span> N<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Array</span> {
</span></span><span style="display:flex;"><span>    T data[N];
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>使用方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>Array<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span>, <span style="color:#ae81ff">10</span><span style="color:#f92672">&gt;</span> arr;
</span></span></code></pre></div><p>这样你就可以创建一个长度为10、类型为int的自定义数据类型<code>Array</code>。<code>template&lt;int N&gt;</code>在这里表示输入数据为一个常量，所以他可以直接塞进数组后缀中。</p>
<p>template的能力远远不止于此。一个更加强大的功能是：它可以把一个函数塞进去。比如，此处我们来实现一个可以自定义排序规则的冒泡排序算法。</p>
<p>首先，我们先来写一个基础的冒泡排序算法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstdlib&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ctime&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iomanip&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;utility&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> bubbleSort(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&amp;</span>targetVector) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> swapped <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> targetVector.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> swapped; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    swapped <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> targetVector.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> i; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (targetVector[j] <span style="color:#f92672">&gt;</span> targetVector[j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]) {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>swap(targetVector[j], targetVector[j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>        swapped <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">throwADice</span>() { <span style="color:#66d9ef">return</span> rand() <span style="color:#f92672">%</span> <span style="color:#ae81ff">6</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>srand(time(<span style="color:#66d9ef">nullptr</span>));
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> test <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    test.push_back(throwADice());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  bubbleSort(test);
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>left;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> it : test) {
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>setw(<span style="color:#ae81ff">4</span>) <span style="color:#f92672">&lt;&lt;</span> it;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这段代码综合了前面讲的随机数生成和后面会涉及的流运算符。总而言之，核心的逻辑就是<code>bubbleSort</code>函数，它会接受一个随便一个类型的vector，然后把里面的元素从小到大排列。这里我们还额外写了一个骰子函数，来生成测试数据。</p>
<p>某次的结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ae81ff">3</span>   <span style="color:#ae81ff">3</span>   <span style="color:#ae81ff">4</span>   <span style="color:#ae81ff">5</span>   <span style="color:#ae81ff">5</span>   <span style="color:#ae81ff">5</span>   <span style="color:#ae81ff">5</span>   <span style="color:#ae81ff">6</span>   <span style="color:#ae81ff">6</span>   <span style="color:#ae81ff">6</span>   
</span></span></code></pre></div><p>但是，我现在希望让它来按照与某个数的差的绝对值来从小到大排列，那么显然这样的代码就没办法正常工作了。我们当然可以重写<code>bubbleSort</code>函数，但是每次定义新的规则我们都要重写一遍的话实在是太麻烦了。</p>
<p>所以我们为什么不把函数直接传进去呢？我们可以定义一个比较函数，用来处理排序规则，返回值为false，则顺序保持不变；返回值为true，则需要交换顺序。</p>
<p>为了显示体现这样做的意义，我们修改骰子，使它变为一个&quot;100面骰&quot;，同时，我们定义这样的一个比较函数，用来辅助排序：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">bool</span> cmp(T a, T b) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (abs(<span style="color:#ae81ff">50</span> <span style="color:#f92672">-</span> a) <span style="color:#f92672">&lt;</span> abs(<span style="color:#ae81ff">50</span> <span style="color:#f92672">-</span> b))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>当与目标(50)的绝对距离前者小于后者时，意味着两者无需调换顺序，否则需要调换顺序。</p>
<p>我们再来对<code>bubbleSort</code>函数进行调整，让它可以接受一个函数作为参数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T, <span style="color:#66d9ef">typename</span> Func<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> bubbleSort(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&amp;</span>targetVector, Func cmpFunc) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> swapped <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> targetVector.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> swapped; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    swapped <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> targetVector.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> i; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (cmpFunc(targetVector[j], targetVector[j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>])) {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>swap(targetVector[j], targetVector[j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>        swapped <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>完整代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstdlib&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ctime&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iomanip&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;utility&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">bool</span> cmp(T a, T b) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (abs(<span style="color:#ae81ff">50</span> <span style="color:#f92672">-</span> a) <span style="color:#f92672">&lt;</span> abs(<span style="color:#ae81ff">50</span> <span style="color:#f92672">-</span> b))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T, <span style="color:#66d9ef">typename</span> Func<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> bubbleSort(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">&amp;</span>targetVector, Func cmpFunc) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> swapped <span style="color:#f92672">=</span> true;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> targetVector.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span> swapped; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    swapped <span style="color:#f92672">=</span> false;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> targetVector.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> i; j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (cmpFunc(targetVector[j], targetVector[j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>])) {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>swap(targetVector[j], targetVector[j <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>        swapped <span style="color:#f92672">=</span> true; <span style="color:#75715e">//直接比较大小改为了调用比较函数。
</span></span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">throwADice</span>() { <span style="color:#66d9ef">return</span> rand() <span style="color:#f92672">%</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>srand(time(<span style="color:#66d9ef">nullptr</span>));
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> test <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    test.push_back(throwADice());
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  bubbleSort(test, cmp<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>) <span style="color:#75715e">//注意这个地方需要显式实例化！
</span></span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>left;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> it : test) {
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>setw(<span style="color:#ae81ff">4</span>) <span style="color:#f92672">&lt;&lt;</span> it;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>某次的运行结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ae81ff">51</span>  <span style="color:#ae81ff">48</span>  <span style="color:#ae81ff">52</span>  <span style="color:#ae81ff">34</span>  <span style="color:#ae81ff">76</span>  <span style="color:#ae81ff">22</span>  <span style="color:#ae81ff">80</span>  <span style="color:#ae81ff">86</span>  <span style="color:#ae81ff">93</span>  <span style="color:#ae81ff">96</span>  
</span></span></code></pre></div><p>随机抽取的10个数按照和50的绝对距离从小到大排列。</p>
<p>通常来说，函数模版需要直接完整的写在头文件里。如果你硬要做原型和实现的分离，编译器会直接让你飞起来。</p>
<h2 id="iomanip库">iomanip库<a href="#iomanip%e5%ba%93" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p><code>&lt;iomanip&gt;</code>库是一个用来控制输入输出格式的头文件，它提供的是一组<strong>I/O操作符</strong>，即插入在输入输出流中的格式指令。</p>
<p>需要注意的是，流式运算符有两类格式控制，一种是修改<strong>流状态</strong>的操作符，而另一种是修改下一次输出的操作符。</p>
<p>简单理解来说，<code>cout</code>是一个“流对象”，但是它的实例化过程是在程序尚未开始运行前就在标准库中完成的。这个流对象有很多的状态来描述它的输出格式，比如输出的数字精度，比如输出的宽度以及向哪一侧对齐。在整个程序的生命周期中，<code>cout</code>只在程序开始之前被实例化，程序结束后被析构。</p>
<h3 id="setw">setw<a href="#setw" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在<code>&lt;iomanip&gt;</code>中，只修改下一次输出的状态符几乎只有一个：<code>setw()</code>。它会控制下一次输出的“宽度”，输出结束后这个宽度会自动复位为0。</p>
<p>我们来举个简单的例子说明此事：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iomanip&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">int</span> test <span style="color:#f92672">=</span> <span style="color:#ae81ff">12345</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">10</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> test <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>setw(i) <span style="color:#f92672">&lt;&lt;</span> test <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>猜猜这段代码会输出什么?</p>
<p>答案揭晓：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ae81ff">1234512345</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1234512345</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1234512345</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1234512345</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1234512345</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1234512345</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12345</span> <span style="color:#ae81ff">12345</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12345</span>  <span style="color:#ae81ff">12345</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12345</span>   <span style="color:#ae81ff">12345</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12345</span>    <span style="color:#ae81ff">12345</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">12345</span>     <span style="color:#ae81ff">12345</span>
</span></span></code></pre></div><p>每一次输出都有一个隐藏的“输出宽度”，当本次输出的文本长度大于宽度时，下一次输出就会直接接在后面；如果文本长度小于宽度，下一次输出就会先补全所要求的宽度，再接上下一次的输出。默认的输出宽度为0，意味着默认情况下哪怕你只输出一个字符，下一次的输出也会直接接在后面。</p>
<h3 id="流状态操作符">流状态操作符<a href="#%e6%b5%81%e7%8a%b6%e6%80%81%e6%93%8d%e4%bd%9c%e7%ac%a6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>因为除了<code>setw</code>的所有流式操作符都直接修改cout的全局状态，所以你完全可以不必每次输出时都设置一遍。比如，你可以这么写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iomanip&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ios&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">double</span> pi <span style="color:#f92672">=</span> <span style="color:#ae81ff">123.456789</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>setprecision(<span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> pi <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>fixed;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> pi <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>setprecision(<span style="color:#ae81ff">6</span>);
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> pi <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>scientific;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> pi <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>输出结果为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>123.5
</span></span><span style="display:flex;"><span>123.4568
</span></span><span style="display:flex;"><span>123.456789
</span></span><span style="display:flex;"><span>1.234568e+02
</span></span></code></pre></div><p>其实说到底，对于像<code>cout</code>这样的流对象，使用<code>&lt;&lt;</code>来写入内容时把所有东西写在一个std::cout&laquo;&hellip;中和每行写一个cout没有任何区别。比如上面的这段代码你也完全可以这么写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iomanip&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ios&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">double</span> pi <span style="color:#f92672">=</span> <span style="color:#ae81ff">123.456789</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>setprecision(<span style="color:#ae81ff">4</span>) <span style="color:#f92672">&lt;&lt;</span> pi <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>fixed <span style="color:#f92672">&lt;&lt;</span> pi <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>setprecision(<span style="color:#ae81ff">6</span>) <span style="color:#f92672">&lt;&lt;</span> pi <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>scientific <span style="color:#f92672">&lt;&lt;</span> pi <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>全部塞在一个<code>cout</code>里，结果完全一致。</p>
<p>以下罗列一些常用的<code>&lt;iomanip&gt;</code>函数：</p>
<ul>
<li><code>setprecision(n)</code>设置输出的有效位数</li>
<li><code>fixed/scientific</code>设置有效位数的模式，fixed表示小数点后若干位为有效位数，scientific表示使用科学技术法表示有效位数。</li>
<li><code>left/right</code>表示对齐的方式。在一个输出宽度内，你的文本可以是左对齐，也可以是右对齐。</li>
<li><code>setfill(ch)</code>设置一个输出宽度内空白部分的填充字符。默认啥也没有。</li>
<li><code>showpoint</code>强制显示小数点</li>
<li><code>dec/oct/hex</code>显示十进制、八进制、十六进制。</li>
</ul>
<p>我们来举个经典例子：九九乘法表。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iomanip&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Vector2D</span> {
</span></span><span style="display:flex;"><span>  T x;
</span></span><span style="display:flex;"><span>  T y;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>string content;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> state;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> tableMap(Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> inputVector) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>{inputVector.y, inputVector.x, inputVector.content,
</span></span><span style="display:flex;"><span>                       inputVector.x <span style="color:#f92672">&gt;=</span> inputVector.y};
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> Func<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> tablePrinter(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> vec01, std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> vec02,
</span></span><span style="display:flex;"><span>                  Func tableFunc) {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>left;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;&gt;</span> table(
</span></span><span style="display:flex;"><span>      vec01.size(), std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span>(vec02.size()));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> vec01.size(); i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> vec02.size(); j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> inputVector <span style="color:#f92672">=</span> {i, j,
</span></span><span style="display:flex;"><span>                                   std<span style="color:#f92672">::</span>to_string(vec01[i]) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;*&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                                       std<span style="color:#f92672">::</span>to_string(vec02[j]) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;=&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                                       std<span style="color:#f92672">::</span>to_string(vec01[i] <span style="color:#f92672">*</span> vec02[j]),
</span></span><span style="display:flex;"><span>                                   true};
</span></span><span style="display:flex;"><span>      Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> outputVec <span style="color:#f92672">=</span> tableFunc(inputVector);
</span></span><span style="display:flex;"><span>      table[outputVec.x][outputVec.y] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          outputVec.state <span style="color:#f92672">?</span> outputVec.content : <span style="color:#e6db74">&#34; &#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> it : table) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> unit : it) {
</span></span><span style="display:flex;"><span>      std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>setw(<span style="color:#ae81ff">10</span>) <span style="color:#f92672">&lt;&lt;</span> unit;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> numbles <span style="color:#f92672">=</span> {<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">9</span>};
</span></span><span style="display:flex;"><span>  tablePrinter(numbles, numbles, tableMap);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>输出结果：</p>
<p><img src="/zh-cn/posts/seu%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A001%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/SEU%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A001%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95-20260119-1.png" alt=""></p>
<p>你可能注意到了，这段代码中<code>tablePrinter</code>函数接受了一个映射函数。这意味着我们可以通过修改映射规则的方式调整打印格式。通过这样的写法，我们可以快速的写出所有方位角度的乘法表，甚至可以整出一些花活。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iomanip&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">Vector2D</span> {
</span></span><span style="display:flex;"><span>  T x;
</span></span><span style="display:flex;"><span>  T y;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>string content;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> state;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> Leftdown(Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> inputVector) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>{inputVector.y, inputVector.x, inputVector.content,
</span></span><span style="display:flex;"><span>                       inputVector.y <span style="color:#f92672">&gt;=</span> inputVector.x};
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> LeftUp(Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> inputVector) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>{<span style="color:#ae81ff">8</span> <span style="color:#f92672">-</span> inputVector.y, inputVector.x, inputVector.content,
</span></span><span style="display:flex;"><span>                       inputVector.y <span style="color:#f92672">&gt;=</span> inputVector.x};
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> RightDown(Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> inputVector) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>{inputVector.y, <span style="color:#ae81ff">8</span> <span style="color:#f92672">-</span> inputVector.x, inputVector.content,
</span></span><span style="display:flex;"><span>                       inputVector.y <span style="color:#f92672">&gt;=</span> inputVector.x};
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> RightUp(Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> inputVector) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span>{<span style="color:#ae81ff">8</span> <span style="color:#f92672">-</span> inputVector.y, <span style="color:#ae81ff">8</span> <span style="color:#f92672">-</span> inputVector.x,
</span></span><span style="display:flex;"><span>                       inputVector.content, inputVector.y <span style="color:#f92672">&gt;=</span> inputVector.x};
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">template</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">typename</span> Func<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> tablePrinter(std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> vec01, std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> vec02,
</span></span><span style="display:flex;"><span>                  Func tableFunc) {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>left <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#39;\n&#39;</span>;
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;&gt;</span> table(
</span></span><span style="display:flex;"><span>      vec01.size(), std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>string<span style="color:#f92672">&gt;</span>(vec02.size(), <span style="color:#e6db74">&#34; &#34;</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> vec01.size(); i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; j <span style="color:#f92672">&lt;</span> vec02.size(); j<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> inputVector <span style="color:#f92672">=</span> {i, j,
</span></span><span style="display:flex;"><span>                                   std<span style="color:#f92672">::</span>to_string(vec01[i]) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;*&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                                       std<span style="color:#f92672">::</span>to_string(vec02[j]) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;=&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                                       std<span style="color:#f92672">::</span>to_string(vec01[i] <span style="color:#f92672">*</span> vec02[j]),
</span></span><span style="display:flex;"><span>                                   true};
</span></span><span style="display:flex;"><span>      Vector2D<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> outputVec <span style="color:#f92672">=</span> tableFunc(inputVector);
</span></span><span style="display:flex;"><span>      table[outputVec.x][outputVec.y] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>          outputVec.state <span style="color:#f92672">?</span> outputVec.content : <span style="color:#e6db74">&#34; &#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> it : table) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">auto</span> unit : it) {
</span></span><span style="display:flex;"><span>      std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>setw(<span style="color:#ae81ff">10</span>) <span style="color:#f92672">&lt;&lt;</span> unit;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]) {
</span></span><span style="display:flex;"><span>  std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> numbles <span style="color:#f92672">=</span> {<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">9</span>};
</span></span><span style="display:flex;"><span>  tablePrinter(numbles, numbles, Leftdown);
</span></span><span style="display:flex;"><span>  tablePrinter(numbles, numbles, LeftUp);
</span></span><span style="display:flex;"><span>  tablePrinter(numbles, numbles, RightDown);
</span></span><span style="display:flex;"><span>  tablePrinter(numbles, numbles, RightUp);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img src="/zh-cn/posts/seu%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A001%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/SEU%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%A4%8D%E4%B9%A001%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95-20260119-2.png" alt=""></p>
]]></content>
		</item>
		
		<item>
			<title>核动力博客发射器测试</title>
			<link>http://localhost:1313/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/</link>
			<pubDate>Sat, 17 Jan 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>测试用。这个博客采用了一套全新的工作流。如果你能在网站上看到这个文章，且一切显示正常，证明新的工作流成功了。成功后我就可以用比以前快一伯倍的速度在我的博客上堆砌日常产出的学术废料。</p>
<p>一些近期工作的截图。（在旧的工作流下添加图片极其痛苦，现在因为采用了一套新的工作流，添加图片易如反掌口牙！！）</p>
<p><img src="/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95-20260117-1.png" alt=""></p>
<p><img src="/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95-20260117-2.png" alt=""></p>
<p><img src="/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95-20260117-3.png" alt=""></p>
<p><img src="/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95-20260117-4.png" alt=""></p>
<p><img src="/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95-20260117-5.png" alt=""></p>
<p><img src="/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95-20260117-6.png" alt=""></p>
]]></content>
		</item>
		
		<item>
			<title>D2L自学日志02：线性回归</title>
			<link>http://localhost:1313/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9702%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/</link>
			<pubDate>Wed, 07 Jan 2026 19:27:51 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9702%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h1 id="线性回归">线性回归<a href="#%e7%ba%bf%e6%80%a7%e5%9b%9e%e5%bd%92" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>线性假设是指目标可以表示为特征的加权和。</p>
<blockquote>
<p>举个例子：我想做一个预测房屋售价的模型。</p>
</blockquote>
<p>房屋售价相关的数量特征有：房屋面积、房龄。那么我们就可以得到这样的式子（虽然不一定有道理）：
</p>
$$
price = w_{area} \cdot area + w_{age} \cdot age + b
$$<p>
其中$w_{area}$和$w_{age}$称为<strong>权重</strong>，代表这个特征对于结果的影响大小，比如在这个例子中，房屋面积和房龄对于售价的影响力可能不同；$b$代表<strong>偏置</strong>，用来拓展模型的表达能力（不加偏置模型只能进行线性变换，加了偏置模型可以实现仿射变换）。</p>
<p>在机器学习领域中，我们处理的对象往往是<strong>高维数据集</strong>，即特证数很可能非常多。我们可以将所有的相关特征全部塞进一个向量中。比如，我们的目标可以用$x_1,x_2,x_3,...$来描述，那么我们可以这样来表示我们的预测值$\hat{y}$：
</p>
$$
\hat{y} = \sum_{i = 1}^{n}{w_ix_i} + b
$$<p>
将所有特征塞进向量$\vec{x}$后，我们可以得到：
</p>
$$
\hat{y} = w^Tx + b
$$<p>
其中$w^T$表示权重向量，每个元素表示对应的特征的权重大小。这样，我们就用点积的形式简洁的表示了模型。</p>
<p>通过这样的模型，我们已经可以实现将一个样本的特征与其预测值实现映射。但是通常情况下，这样做并不足以解决问题，因为我们多数时候不会只有一个样本。我们理想的效果是这样：通过同一套映射规则，将多个样本的特征分别映射到各自的预测值。非常巧的是，对于线性回归模型，我们恰好有一个强大的工具可以实现这一功能：矩阵。</p>
<p>对于一个样本的特征$x_{1},x_{2},x_{3},...$，我们可以把它塞进一个行向量$\vec{x}^T$中，组成一个特征行向量；随后，让这些行向量从上至下排列，我们就得到了一个由特征数值组成的矩阵。</p>
<p>比如，对于样本a，特征行向量为$[x_{a_{1}}, x_{a_{2}}, x_{a_{3}}, ... ,x_{as}]$;对于样本b，我们有特征行向量$[x_{b_{1}},x_{b_{2}},...]$，以此类推，我们可以最后得到每一个样本的特征行向量，随后我们将它拼在一起，得到如下矩阵：
</p>
$$
X = \begin{pmatrix}
x_{a_{1}}&x_{a_{2}}&x_{a_{3}}&{...}&x_{as} \\
x_{b_{1}}&x_{b_{2}}&x_{b_{3}}&{...}&x_{bs} \\
\vdots \\
\end{pmatrix}
$$<p>
这样，我们就将整个数据集的所有样本的所以特征汇总在了一个矩阵中。我们同样将预测值从上至下排列为一个列向量$\hat{y}$，这样我们就得到了：
</p>
$$
\hat{y}= Xw + b
$$<p>
对于给定训练数据特征$\mathbf{X}$和对应的已知标签$\mathbf{y}$，线性回归的目标是找到一组权重向量$\mathbf{w}$和偏置$b$：当给定从$\mathbf{X}$的同分布中取样的新样本特征时，这组权重向量和偏置能够使得新样本预测标签的误差尽可能小。说白了，我们认为$\hat{y}$和$X$之间可能有线性关系，而我们所做的其实是希望让机器通过学习已有的样本数据来自行归纳这种潜在的线性关系。</p>
<p>但是，一个很现实的问题是：以上的所有假设都建立在目标与特征真的存在线性关系这一前提，然而现实世界中我们几乎不可能找到严格线性的数据集（现实数据的浮点数误差，你可以这么理解）。</p>
<p>所以，既然这种误差不可避免，一个很天才的想法是：我们引入一个噪声项来观察误差带来的影响。这就像听歌的时候音质不好，所以你干脆放点噪音让音质的缺陷显得非常合理。</p>
<hr>
<p>总而言之，我们的根本目标是寻找描述$X$和$\hat{y}$之间映射关系最好的一组$w,b$。但是在正式开始寻找之前，我们需要回答两个颇具哲理的问题：</p>
<ol>
<li>什么是<strong>最好</strong>？</li>
<li>如何寻找？</li>
</ol>
<p>他们分别对应于：</p>
<ol>
<li>模型质量的度量方式。</li>
<li>一种能更新模型进而提高模型质量的方式。</li>
</ol>
<hr>
<h2 id="度量质量损失函数">度量质量：损失函数<a href="#%e5%ba%a6%e9%87%8f%e8%b4%a8%e9%87%8f%e6%8d%9f%e5%a4%b1%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>对于第一个问题，我们希望通过我们的模型，最好输入$x$就能直接精确预测到$y$，换言之，什么样的映射能让$\hat{y}$和$y$之间差距最小，这样的映射就是我们所在寻找的。因此，我们可以通过量化模型的误差进而体现模型的质量。而这种量化的方式就是所谓的<strong>损失函数（loss funciton）</strong>。</p>
<p>对于一个通常的误差函数，我们希望它的输出值为非负数，这样他的大小即直接展现损失大小。在回归问题中，一个常用的损失函数是<strong>平方误差函数</strong>。我们记样本$i$的预测值为$\hat{y}^{(i)}$，其对应的真实标签为$y^{(i)}$，那么平方误差就可以定义为如下的式子：
</p>
$$
l^{(i)}(w, b)=\frac{1}{2}(\hat{y}^{(i)}-y^{(i)})^2
$$<p>
这里，之所以有一个$\frac{1}{2}$，只是因为这样做后续求导系数为1，稍微方便一点。</p>
<p>你会注意到这个式子的作用对象是一个标量，即它只反应了一个样本中的损失，但是我们希望能作用于一个数据集的所有样本。于是有一个很简单粗暴的方法：让我们算出每一个样本的损失，然后求平均。
</p>
$$
L(w,b) = \frac{1}{n}\sum_{i = 1}^{n}{l^{(i)}(w,b)}
$$<p>
这样，我们就将我们训练模型时的目的明确为：</p>
<blockquote>
<p>寻找一组参数$w^*,b^*$使得这组参数可以最小化所有训练样本中的总损失。</p>
</blockquote>
<hr>
<h2 id="解析解">解析解<a href="#%e8%a7%a3%e6%9e%90%e8%a7%a3" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>不同于我们后续会涉及到的大多数模型，线性回归的解可以用一个公式简单表达出来，即：在给定了一个数据集的时候，我们可以直接算出来最优的参数$w^*,b^*$，而无需复杂的训练过程。</p>
<p>首先，对于偏置量$b$来说，我们没必要去专门考察它在什么时候最优。我们可以对公式$\hat{y} = Xw + b$做如下调整：我们在X最左侧强行加上一列全为1的向量，然后在$w$中强行插入一个$b$，变为$\beta = [b, w_1,w_2,...]$。这样，我们可以让b的地位和其他权重保持一致。我们将问题简化为：求使得$\hat{y} = X\beta$误差最小的权重向量$\beta$。</p>
<p>对于解答这个问题，我们可以使用线性代数优美的几何本质。$X$是一个已知的矩阵，它可以把一个空间中的所有向量映射到另一个空间（即$X$的列空间）中，假如$y$就在$X$的列空间中，这就意味着我们可以用一个向量通过X变换严丝合缝的映射到$y$，这种情况就对应与数据集中的特征与目标呈现严格的线性关系。但是现实世界中我们找不到如此理想的数据集，这意味着$y$多数时候并不在$X$的列空间中。</p>
<p>此时我们回顾前面的误差函数定义，我们会发现其实我们所计算的误差是$\hat{y}$和$y$对应坐标之间的欧几里得距离（平方和，只是没开根号）。我们可以将问题简化如下：</p>
<blockquote>
<p>已知$\hat{y}$被约束在$X$的列空间中，$y$不一定在$X$的列空间中，什么情况下$\hat{y}$和$y$之间的欧几里得距离会最小？</p>
</blockquote>
<p>如果这还是很抽象，我们来看一个三维空间下的表述：</p>
<blockquote>
<p>已知$\hat{y}$在$X$列向量张成的平面或直线上，而$y$并不一定在这个平面或直线上，什么情况下$\hat{y}$和$y$之间的欧几里得距离最小？</p>
</blockquote>
<p>答案很显然：$\hat{y}$与$y$之间的差向量垂直于$X$的列空间。</p>
<p>我们令$e = y - X\beta$表示误差向量，我们希望$e$可以垂直于$X$的每一个列向量，这就意味着$e$与每个$X$列向量的点积都为0。也就是说：
</p>
$$
X^Te = 0
$$<p>
将$e$的表达式代入，我们就可以直接求得最佳的$\beta$：
</p>
$$
\beta = (X^TX)^{-1}X^Ty
$$<p>
这样我们就一次性求得了线性回归中的最优解$w^*,b^*$。</p>
<p>但是，虽然像线性回归这样的简单问题存在解析解，但是对于更加复杂的问题，我们大概率找不到一个解析解。事实上，很多问题找不到解析解并不是因为难算，而是数学意义上的无解，即我们很可能无法将特征与目标的最佳映射写成一个简单的数学公式。因此，我们没办法通过求解析解来处理深度学习的所有问题。</p>
<hr>
<h2 id="随机梯度下降">随机梯度下降<a href="#%e9%9a%8f%e6%9c%ba%e6%a2%af%e5%ba%a6%e4%b8%8b%e9%99%8d" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>即使我们不知道解析解长成什么样，但是有一点我们是确定的：特征与目标之间是存在映射关系的，即特征和目标的分布之间存在着某种规律。</p>
<p>虽然我还没有更深入地学习机器学习，但是我隐约感觉这有点像人类物理学家对物理规律的总结。比如当我们遇到一些从来没有人解释过的现象时，我们会尝试提出各种各样的猜想，并尝试依据猜想，从相关因素去预测结果。最后，我们只会留下预测最精准的猜想作为我们的科学理论。</p>
<p>但是，人类会改变思考的角度，机器不会。比如在尝试分析天体问题时，过去人们站在地球的视角用本轮和均轮描述天体运动，但是后来发现似乎从太阳的视角分析问题得到的结论会更简单。但是机器学习的原理就类似于无限地调整本轮均轮尺寸来让预测值和实际值靠近。我们只能输入数据来训练机器，让它构建一套精密的本轮均轮模型来进行预测，但是我们没办法直接从机器中提取简洁的规律，因为我们能从机器中得到的也只是那一套本轮均轮模型罢了。</p>
<hr>
<p>对于几乎所有的深度学习模型，有这样一种普适的优化方法：<em><strong>梯度下降</strong></em>。它的本质是让我们在损失函数递减的方向上更新参数（即各种权重）来降低误差。</p>
<p>我们已经构建起了由特征值到预测值的映射，对于给定的数据集，我们已知了特征和对应的真实值，而预测值可以通过我们构建的映射得到，这就意味着在给定数据集中我们实际上构建了由特征值到误差的映射，而我们要做的事情实际就是调整这套映射来让误差尽可能小。</p>
<p>我们可以用一个经典的比喻来理解梯度下降的工作原理：我们将参数视作经纬度，而误差视作一座山的海拔。对于每一个样本，我们都有这样的一座山，但是每一个样本心中的山的形状并不一样。比如，假如我们的模型有两个参数$a,b$，在样本A中可能${(a = 3, b = 2)}$的时候预测的误差最小，但是对于样本B，可能$(a = 4, b =5)$的时候误差才最小。不过，尽管山的形状大概率不同，我们仍然认为不同样本的山的形状存在一定的分布规律。</p>
<p>对于一个数据集，我们很可能有成千上万个样本，每个样本的山都堆叠在相同的经纬度，而我们一次只能存在于一个经纬度。现在我们希望找到这样的一个经纬度能让我们在每一座山上的海拔的平均值最低。</p>
<p><strong>梯度下降</strong>法认为我们可以这样实现目的：首先，我们不再去想象山的全貌，而是只去想象我们所在的经纬度的山的<strong>切面</strong>。山是一个曲面，在我们所在经纬度上与这个曲面相切的平面就是我们要找的切面。</p>
<p>然后，我们想象<strong>分别</strong>在每一个参数对应的方向上移动一个微小的位移（比如1），这样每个样本的误差山的切面上高度都会改变，有的高度会增大，有的高度会减小，我们将所有高度变化求平均值，就得到了<strong>这个参数对于平均误差变化的贡献值。</strong></p>
<p>这个贡献值为正数时，意味着随着参数变大，平均误差值也将会变大；当这个贡献值为负数时，参数变大，平均误差值则会随之变小。贡献值的绝对值越大，平均误差值随参数变化的速度也会越快。这个贡献值在数学上实际就是<strong>误差关于参数的偏导数</strong> 。</p>
<p>我们求得所有参数对误差的贡献值，然后让每个参数的贡献值乘以这个参数对应方向的单位向量，最后做矢量和，我们就得到了让<strong>平均参数上升最快的参数改变方向</strong>，而它的反向则是使平均参数下降最快的参数改变方向。</p>
<hr>
<p>在物理上，当一个标量随着空间位置而发生改变，我们称之为<strong>标量场</strong>。比如，一个中心天体附近的引力势符合一定的空间分布。在经典力学的范畴下，我们可以这样描述一个中心天体附近的引力势分布：
</p>
$$
\phi = -\frac{GM}{\sqrt{ x^2 + y^2 + z^2} }
$$<p>
其中$x,y,z$是在以天体为中心的坐标轴下的三维坐标。对于在这个坐标系下坐标为$(x,y,z)$处质量为$m$的小天体，它的引力势能等于：
</p>
$$
E_p = -\frac{GMm}{\sqrt{ x^2+y^2+z^2 }}
$$<p>
这时候，你会思考：沿着什么方向这个引力势能减小的速度最大呢？如果你有一定物理知识，你会知道等势面与保守力方向垂直，保守力的方向就是势下降最快的方向。回忆起高中物理知识，我们知道引力的表达式（不考虑相对论效应）为：
</p>
$$
\vec{F} = -\frac{GMm}{(x^2+y^2+z^2)^\frac{5}{2}}(x\hat{i} + y \hat{j} + z \hat{k})
$$<p>
如果你注意力惊人，你会发现这个表达式实际上还有另一种写法：
</p>
$$
\vec{F} = -(\hat{i}\frac{\partial E_p}{\partial x}+\hat{j}\frac{\partial E_p}{\partial y}+\hat{k}\frac{\partial E_p}{\partial z})
$$<p>
进一步缩写：
</p>
$$
\vec{F} = -\nabla E_p
$$<p>
而我们知道，误差$L=\sum w^Tx + b=F(w_{1},w_{2},w_{3},...)$，其中$L,w_{1},w_{2},w_{3},...$均为标量；引力势$\phi=F(x_{1},x_{2},x_{3})$，其中$\phi,x_{1},x_{2},x_{3}$均为标量。一个合理的猜想是：如果我们想像引力那样沿最快改变方向修改参数来降低误差，我们只需要沿着：
</p>
$$
-\nabla L
$$<p>
的方向修改参数即可。</p>
<p>事实上，这样做既在数学上是正确的，同时也是工程上已经成熟使用的方法。比如在机器学习中我们可以算出平均误差之后通过反向传播算出平均误差关于各个参数的梯度，继而通过让参数减去梯度向量的特定倍数来更新参数进而降低误差。这就是梯度下降的含义。</p>
<hr>
<p>但是，在机器学习中我们往往需要调整大量的参数并计算数以万计的样本，假如每一次更新参数都必须遍历所有的样本，这样做就必然会导致训练效率极其底下。</p>
<p>假如我们仔细思考，不难发现，其实如果我们只是确定一个大致的方向，我们用不着遍历所有的样本。理论上我们只需要从数据集中随机抽取几个样本，这几个样本同样可以一定程度反应整个数据集的特征。这就是目前工程上使用更广泛的<em><strong>随机梯度下降法</strong></em>。如果我们更新参数时只从全数据集中抽取一个固定的小数量的样本，这就是所谓的<em><strong>小批量随机梯度下降法</strong></em>。</p>
<p>在每次迭代时，我们随机抽取一个固定大小的小批量样本$\mathcal{B}$，然后我们计算这个小批量$\mathcal{B}$的平均损失，并求它对于参数的梯度，进而更新参数。</p>
<p>我们可以用下面这一公式来表示这一过程：
</p>
$$(\mathbf{w},b) \leftarrow (\mathbf{w},b) - \frac{\eta}{|\mathcal{B}|} \sum_{i \in \mathcal{B}} \partial_{(\mathbf{w},b)} l^{(i)}(\mathbf{w},b).$$<hr>
<h1 id="从零实现线性回归">从零实现线性回归<a href="#%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0%e7%ba%bf%e6%80%a7%e5%9b%9e%e5%bd%92" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>包括：</p>
<ul>
<li>数据流水线</li>
<li>模型</li>
<li>损失函数</li>
<li>小批量随机梯度下降优化器</li>
</ul>
<h2 id="step01生成数据集">step01：生成数据集<a href="#step01%e7%94%9f%e6%88%90%e6%95%b0%e6%8d%ae%e9%9b%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>为了训练模型，我们需要准备训练用的数据集。因为我们将要实现的是线性回归模型，理所当然的，我们希望我们的数据在一定误差范围内符合线性关系。所以，我们生成数据集的思路是在一个线性模型的基础上添加随机噪声。</p>
<p>在本例中，我们构建一个这样的线性模型：一个标签，两个特征。其中参数$w = [2,-3.4]^T,b = 4.2$，此外还有一个随机噪声$\epsilon$，服从均值为0，标准差为0.01的正态分布：
</p>
$$
y = xw + b + \epsilon
$$<p>
实现如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">synthetic_data</span>(w, b, num_examples):  <span style="color:#75715e">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;生成y=Xw+b+噪声&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    X <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, (num_examples, len(w)))
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>matmul(X, w) <span style="color:#f92672">+</span> b
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">+=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, y<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> X, y<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>))
</span></span></code></pre></div><p><code>torch.normal()</code>：三个参数依次是平均值、标准差、形状。</p>
<p><code>torch.matmul()</code>：顾名思义，矩阵乘法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>true_w <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>Tensor([<span style="color:#ae81ff">2</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">3.4</span>])
</span></span><span style="display:flex;"><span>true_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4.2</span> 
</span></span><span style="display:flex;"><span>features, labels <span style="color:#f92672">=</span> synthetic_data(true_w, true_b, <span style="color:#ae81ff">1000</span>)
</span></span></code></pre></div><p>按照计划设置数据集参数。如果一切正常，<code>features</code>将会是一个形状为(1000, 2)的tensor，<code>labels</code>将会是一个形状为(1000, 1)的tensor。</p>
<p>我们尝试打印某次生成的数据的前10个：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;features: &#34;</span>, features[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">10</span>], <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">labels: &#34;</span>, labels[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">10</span>])
</span></span></code></pre></div><p>结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>features:  tensor([[ <span style="color:#ae81ff">0.6174</span>,  <span style="color:#ae81ff">0.7957</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.5489</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.3956</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.0109</span>,  <span style="color:#ae81ff">1.5542</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.5645</span>,  <span style="color:#ae81ff">1.4945</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.7462</span>,  <span style="color:#ae81ff">0.4104</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.8710</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.4334</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.2848</span>,  <span style="color:#ae81ff">0.1450</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.0261</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.5976</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.0452</span>,  <span style="color:#ae81ff">0.4699</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.0985</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.5582</span>]]) 
</span></span><span style="display:flex;"><span>labels:  tensor([[ <span style="color:#ae81ff">2.7369</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">8.6462</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.0495</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.2449</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">4.2774</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">7.4146</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">3.1246</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">7.5757</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">4.6824</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">6.2991</span>]])
</span></span></code></pre></div><p>简单计算可以验证这组数据大致符合我们的需求。</p>
<h2 id="step02读取数据集">step02：读取数据集<a href="#step02%e8%af%bb%e5%8f%96%e6%95%b0%e6%8d%ae%e9%9b%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>成功建立数据集之后我们需要读取数据集。在前文中我们介绍了<strong>小批量随机梯度下降</strong>，此处我们尝试来实现这一模型优化策略。我们定义一个<code>data_iter()</code>函数来从数据集中随机采样，返回一个大小为<code>batch_size</code>的小批量，每个小批量包含一组标签和特征。</p>
<p>实现如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">data_iter</span>(batch_size, features, labels):
</span></span><span style="display:flex;"><span>    num_examples <span style="color:#f92672">=</span> len(features)
</span></span><span style="display:flex;"><span>    indices <span style="color:#f92672">=</span> list(range(num_examples))
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 这些样本是随机读取的，没有特定的顺序</span>
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>shuffle(indices)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, num_examples, batch_size):
</span></span><span style="display:flex;"><span>        batch_indices <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(
</span></span><span style="display:flex;"><span>            indices[i: min(i <span style="color:#f92672">+</span> batch_size, num_examples)])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">yield</span> features[batch_indices], labels[batch_indices]
</span></span></code></pre></div><p>此处使用了python独有的生成器语法。简单来说，调用这个函数我们并不直接得到小批量样本，而是得到一个迭代器。比如<code>iter = data_iter(...)</code>后，<code>iter</code>并不是一个小批量样本张量。想要从中提取一组样本，我们需要调用<code>next(iter)</code>，或者使用for循环遍历。这样做的好处是节省内存，做到流式内容读取，适用于处理大数据集。（ps：如果学过CS61A，你会很熟悉这个语法。）</p>
<p>如上的采样实现原理是：先生成一个打乱的索引列表，然后从中每<code>batch_size</code>个索引组成一个batch，并返回对应的特征以及标签。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> data_iter(BATCH_SIZE, features, labels):
</span></span><span style="display:flex;"><span>    print(X, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, y)
</span></span><span style="display:flex;"><span>    counter <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> counter <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span></code></pre></div><p><code>data_iter</code>本质上一次性生成了所有的batch。在如上的检验代码中，我们设定一个batch大小为10，并从生成的batch中读取前4个。在某次读取后结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tensor([[<span style="color:#f92672">-</span><span style="color:#ae81ff">1.1099</span>,  <span style="color:#ae81ff">1.6687</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.3618</span>,  <span style="color:#ae81ff">0.1041</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0529</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.2535</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.2494</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.7070</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.1251</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">2.0001</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.4389</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.8865</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.2365</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.4293</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.3268</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.2949</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.1298</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.2571</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.1921</span>,  <span style="color:#ae81ff">0.2929</span>]]) 
</span></span><span style="display:flex;"><span> tensor([[<span style="color:#f92672">-</span><span style="color:#ae81ff">3.7069</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">4.5750</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">4.9620</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">4.0994</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">15.2621</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">10.0946</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">6.1369</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.5313</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.8041</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">7.5802</span>]])
</span></span><span style="display:flex;"><span>tensor([[<span style="color:#f92672">-</span><span style="color:#ae81ff">1.6883</span>,  <span style="color:#ae81ff">1.4908</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.0874</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.0492</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.4867</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.2907</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.6112</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.7551</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.6087</span>,  <span style="color:#ae81ff">0.1846</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.5941</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.2927</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.2502</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">2.2800</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.9777</span>,  <span style="color:#ae81ff">0.4598</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.2728</span>,  <span style="color:#ae81ff">1.0429</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.2092</span>,  <span style="color:#ae81ff">1.1009</span>]]) 
</span></span><span style="display:flex;"><span> tensor([[<span style="color:#f92672">-</span><span style="color:#ae81ff">4.2361</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">6.5448</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">6.1642</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">3.5481</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.3488</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">9.7791</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">14.4587</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.3148</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.1061</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.8728</span>]])
</span></span><span style="display:flex;"><span>tensor([[<span style="color:#f92672">-</span><span style="color:#ae81ff">0.1582</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.5111</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.0206</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.8523</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.6847</span>,  <span style="color:#ae81ff">0.0036</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.1984</span>,  <span style="color:#ae81ff">0.6702</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5487</span>,  <span style="color:#ae81ff">1.7227</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">3.1342</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0611</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.8778</span>,  <span style="color:#ae81ff">0.0670</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">2.2774</span>,  <span style="color:#ae81ff">1.6131</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.4362</span>,  <span style="color:#ae81ff">0.2129</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.4503</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.7968</span>]]) 
</span></span><span style="display:flex;"><span> tensor([[ <span style="color:#ae81ff">5.6233</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">10.5495</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.8155</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">4.3185</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">2.7354</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">14.0680</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.2155</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">5.8575</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.6139</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">7.8082</span>]])
</span></span><span style="display:flex;"><span>tensor([[<span style="color:#f92672">-</span><span style="color:#ae81ff">0.1396</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.8441</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.4309</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.8643</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.3181</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.7736</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.1347</span>,  <span style="color:#ae81ff">0.1844</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.3201</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.1031</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.1408</span>,  <span style="color:#ae81ff">0.5805</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.2353</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.6993</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.6425</span>,  <span style="color:#ae81ff">1.3151</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.4438</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0837</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">2.6588</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.6255</span>]]) 
</span></span><span style="display:flex;"><span> tensor([[<span style="color:#ae81ff">6.7791</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">7.9966</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">6.1920</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">5.8500</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">5.1947</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">2.5164</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">7.0426</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">1.0002</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">8.7780</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">0.9943</span>]])
</span></span></code></pre></div><p>每两个tensor构成一组feature和label。</p>
<h2 id="step03初始化模型参数">step03：初始化模型参数<a href="#step03%e5%88%9d%e5%a7%8b%e5%8c%96%e6%a8%a1%e5%9e%8b%e5%8f%82%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>随机创建一组初始参数作为初始值。在下面的代码中，我们通过均值为0、标准差为0.01的正态分布采样来初始化权重，并将偏置初始化为0。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>b <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(<span style="color:#ae81ff">1</span>, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p>在初始化参数之后，我们的任务是更新这些参数，直到这些参数足够拟合我们的数据。每次更新都需要计算损失函数关于模型参数的梯度。有了这个梯度，我们就可以向减小损失的方向更新每个参数。</p>
<h2 id="step04定义模型">step04：定义模型<a href="#step04%e5%ae%9a%e4%b9%89%e6%a8%a1%e5%9e%8b" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>我们已经获得了数据集，得到了参数张量，现在我们想要计算得到预测值，所以我们需要按照我们之前规划的参数、特征与目标之间的映射关系建立模型。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">linreg</span>(X, w, b): 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;线性回归模型&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>matmul(X, w) <span style="color:#f92672">+</span> b
</span></span></code></pre></div><p>此处使用了pytorch以及很多其他数据科学库中常见的广播机制，b是一个数字，但是前面的<code>torch.matmul()</code>会得到一个向量。向量+数字，结果是向量中的每个元素都加上数字。</p>
<p>模型的地位是我们希望产出的产品。我们希望通过训练来得到参数最优的模型。因此，训练的过程本质就是不断的让模型进行计算，每次计算后根据结果更新参数，参数达到最优后，这套嵌入了最优参数的模型就可以用作实际用途，你可以输入特征让它预测结果。</p>
<h2 id="step05定义损失函数">step05：定义损失函数<a href="#step05%e5%ae%9a%e4%b9%89%e6%8d%9f%e5%a4%b1%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>按照计划，我们将预测值与真实值之差的平方值的$\frac{1}{2}$作为损失值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">squared_loss</span>(y_hat, y):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;均方损失&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (y_hat <span style="color:#f92672">-</span> y<span style="color:#f92672">.</span>reshape(y_hat<span style="color:#f92672">.</span>shape)) <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
</span></span></code></pre></div><p>得到的是一个损失向量，每个元素代表对应的样本在当前模型计算下的损失值。</p>
<h2 id="step06定义优化算法">step06：定义优化算法<a href="#step06%e5%ae%9a%e4%b9%89%e4%bc%98%e5%8c%96%e7%ae%97%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>尽管线性回归存在解析解，此处我们仍然使用小批量梯度下降法来尝试找到最优解。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sgd</span>(params, lr, batch_size):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;小批量随机梯度下降&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> param <span style="color:#f92672">in</span> params:
</span></span><span style="display:flex;"><span>            param <span style="color:#f92672">-=</span> lr <span style="color:#f92672">*</span> param<span style="color:#f92672">.</span>grad <span style="color:#f92672">/</span> batch_size
</span></span><span style="display:flex;"><span>            param<span style="color:#f92672">.</span>grad<span style="color:#f92672">.</span>zero_()
</span></span></code></pre></div><p><code>with torch.no_grad()</code>明确在此代码块中进行的计算不会被记入torch计算图中。我们优化参数不免要利用一些和参数相关的计算，但是这些计算并不在模型的计算过程内，更新参数的计算过程和误差的产生毫无关联，因此我们需要这样做来与计算图隔离。</p>
<p>你可能会注意到，我们前面定义的损失函数并不是一个平均值，而是单纯的平方和，这就意味着损失大小会随着batch大小改变而改变。因此在更新参数的时候我们需要做一步额外的标准化操作：让<code>param</code>的改变值除以<code>batch_size</code>，这样对于相同的样本，不管<code>batch_size</code>大小如何，我们都可以得到一样的改变量。</p>
<p>最后，每次更新完一个参数，我们将参数的梯度归零，方便进行下一次训练。</p>
<h2 id="step07训练">step07：训练<a href="#step07%e8%ae%ad%e7%bb%83" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>训练的过程中我们不断地会经历正向传播、反向传播、更新参数的循环，周而复始直到完成一个数据集全部数据的训练，我们称这样一个过程为一个<em>迭代周期</em>。我们大致要做这样的逻辑：</p>
<ul>
<li>初始化参数</li>
<li>重复以下训练直到完成所有数据集的训练：
<ul>
<li>计算梯度</li>
<li>更新参数</li>
</ul>
</li>
</ul>
<p>在每个迭代周期中，我们将使用<code>data_iter</code>遍历数据集中的每个样本。在此过程中迭代周期数量以及学习率都是所谓的<em>超参数</em>，它们并不是我们通过训练可以优化的，只能通过实验经验来调整优化。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>lr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.03</span>
</span></span><span style="display:flex;"><span>num_epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>net <span style="color:#f92672">=</span> linreg
</span></span><span style="display:flex;"><span>loss <span style="color:#f92672">=</span> squared_loss
</span></span></code></pre></div><p>规定一下后续会用到的参数和相关函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> data_iter(batch_size, features, labels):
</span></span><span style="display:flex;"><span>        l <span style="color:#f92672">=</span> loss(net(X, w, b), y)  <span style="color:#75715e"># X和y的小批量损失</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 因为l形状是(batch_size,1)，而不是一个标量。l中的所有元素被加到一起，</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 并以此计算关于[w,b]的梯度</span>
</span></span><span style="display:flex;"><span>        l<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>        sgd([w, b], lr, batch_size)  <span style="color:#75715e"># 使用参数的梯度更新参数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        train_l <span style="color:#f92672">=</span> loss(net(features, w, b), labels)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;epoch </span><span style="color:#e6db74">{</span>epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, loss </span><span style="color:#e6db74">{</span>float(train_l<span style="color:#f92672">.</span>mean())<span style="color:#e6db74">:</span><span style="color:#e6db74">f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p>因为数据集是我们自己生成的，我们知道最优参数的标准答案为$w = [2,-3.4]^T,b = 4.2$，所以我们可以据此来衡量模型训练的成效。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;w的估计误差: </span><span style="color:#e6db74">{</span>true_w <span style="color:#f92672">-</span> w<span style="color:#f92672">.</span>reshape(true_w<span style="color:#f92672">.</span>shape)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;b的估计误差: </span><span style="color:#e6db74">{</span>true_b <span style="color:#f92672">-</span> b<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p>完整代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">synthetic_data</span>(w: torch<span style="color:#f92672">.</span>Tensor, b: float, num_examples: int):
</span></span><span style="display:flex;"><span>    X <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, (num_examples, len(w)))
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>matmul(X, w) <span style="color:#f92672">+</span> b
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">+=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, y<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> X, y<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>true_w <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>Tensor([<span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3.4</span>])
</span></span><span style="display:flex;"><span>true_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4.2</span>
</span></span><span style="display:flex;"><span>features, labels <span style="color:#f92672">=</span> synthetic_data(true_w, true_b, <span style="color:#ae81ff">1000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(&#34;features: &#34;, features[0:10], &#34;\nlabels: &#34;, labels[0:10])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">data_iter</span>(batch_size, features, labels):
</span></span><span style="display:flex;"><span>    num_examples <span style="color:#f92672">=</span> len(features)
</span></span><span style="display:flex;"><span>    indices <span style="color:#f92672">=</span> list(range(num_examples))
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>shuffle(indices)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, num_examples, batch_size):
</span></span><span style="display:flex;"><span>        batch_indices <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(indices[i : min(i <span style="color:#f92672">+</span> batch_size, num_examples)])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">yield</span> features[batch_indices], labels[batch_indices]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>w <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>b <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(<span style="color:#ae81ff">1</span>, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">linreg</span>(X, w, b):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;线性回归模型&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>matmul(X, w) <span style="color:#f92672">+</span> b
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">squared_loss</span>(y_hat, y):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;均方损失&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (y_hat <span style="color:#f92672">-</span> y<span style="color:#f92672">.</span>reshape(y_hat<span style="color:#f92672">.</span>shape)) <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sgd</span>(params, lr, batch_size):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;小批量随机梯度下降&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> param <span style="color:#f92672">in</span> params:
</span></span><span style="display:flex;"><span>            param <span style="color:#f92672">-=</span> lr <span style="color:#f92672">*</span> param<span style="color:#f92672">.</span>grad <span style="color:#f92672">/</span> batch_size
</span></span><span style="display:flex;"><span>            param<span style="color:#f92672">.</span>grad<span style="color:#f92672">.</span>zero_()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.03</span>
</span></span><span style="display:flex;"><span>num_epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>net <span style="color:#f92672">=</span> linreg
</span></span><span style="display:flex;"><span>loss <span style="color:#f92672">=</span> squared_loss
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> data_iter(batch_size, features, labels):
</span></span><span style="display:flex;"><span>        l <span style="color:#f92672">=</span> loss(net(X, w, b), y)  <span style="color:#75715e"># X和y的小批量损失</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 因为l形状是(batch_size,1)，而不是一个标量。l中的所有元素被加到一起，</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 并以此计算关于[w,b]的梯度</span>
</span></span><span style="display:flex;"><span>        l<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>        sgd([w, b], lr, batch_size)  <span style="color:#75715e"># 使用参数的梯度更新参数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        train_l <span style="color:#f92672">=</span> loss(net(features, w, b), labels)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;epoch </span><span style="color:#e6db74">{</span>epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, loss </span><span style="color:#e6db74">{</span>float(train_l<span style="color:#f92672">.</span>mean())<span style="color:#e6db74">:</span><span style="color:#e6db74">f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;w的估计误差: </span><span style="color:#e6db74">{</span>true_w <span style="color:#f92672">-</span> w<span style="color:#f92672">.</span>reshape(true_w<span style="color:#f92672">.</span>shape)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;b的估计误差: </span><span style="color:#e6db74">{</span>true_b <span style="color:#f92672">-</span> b<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>某次输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>epoch <span style="color:#ae81ff">1</span>, loss <span style="color:#ae81ff">0.036131</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">2</span>, loss <span style="color:#ae81ff">0.000128</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">3</span>, loss <span style="color:#ae81ff">0.000046</span>
</span></span><span style="display:flex;"><span>w的估计误差: tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0004</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.0010</span>], grad_fn<span style="color:#f92672">=&lt;</span>SubBackward0<span style="color:#f92672">&gt;</span>)
</span></span><span style="display:flex;"><span>b的估计误差: tensor([<span style="color:#ae81ff">0.0002</span>], grad_fn<span style="color:#f92672">=&lt;</span>RsubBackward1<span style="color:#f92672">&gt;</span>)
</span></span></code></pre></div><p>训练了3个迭代周期，最后得到的参数与最优参数之间误差在e-04数量级。</p>
<p>总结来说，使用梯度下降法无法得到最优参数的真实值，我们也并不关心如何恢复真实参数。我们真正希望实现的是高度准确的预测参数。</p>
]]></content>
		</item>
		
		<item>
			<title>Fabric自学日志01：农夫乐事重织版</title>
			<link>http://localhost:1313/zh-cn/posts/fabric%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701%E5%86%9C%E5%A4%AB%E4%B9%90%E4%BA%8B%E9%87%8D%E7%BB%87%E7%89%88/</link>
			<pubDate>Thu, 01 Jan 2026 21:00:42 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/fabric%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701%E5%86%9C%E5%A4%AB%E4%B9%90%E4%BA%8B%E9%87%8D%E7%BB%87%E7%89%88/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>我一直很想做mc模组，但是奈何java开发经验约等于0。今天终于决定开始认真研究fabric模组开发，之后也应该会一直更新fabric学习笔记。</p>
<p>程序员森呸们都说，读代码就是学习写代码最好的方式，于是今天第一弹先来研究一下FarmersDelightRefabricated的文件结构与代码组成。FarmersDelightRefabricated即农夫乐事：重织版，是经典模组农夫乐事的fabric端移植版。</p>
<p>🔗参考链接：</p>
<p><a href="https://github.com/MehVahdJukaar/FarmersDelightRefabricated">FarmersDelightRefabricatedGithub主页</a></p>
<p><a href="https://docs.fabricmc.net/develop/">fabric文档</a></p>
<p><a href="https://www.mcmod.cn/class/14196.html">mcmod页面</a></p>
<hr>
<h2 id="文件结构">文件结构<a href="#%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>📁 .
</span></span><span style="display:flex;"><span>├── 📁 build
</span></span><span style="display:flex;"><span>│   ├── 📁 classes
</span></span><span style="display:flex;"><span>│   ├── 📁 datagen
</span></span><span style="display:flex;"><span>│   ├── 📁 generated
</span></span><span style="display:flex;"><span>│   ├── 📁 loom-cache
</span></span><span style="display:flex;"><span>│   ├── 📁 reports
</span></span><span style="display:flex;"><span>│   ├── 📁 resources
</span></span><span style="display:flex;"><span>│   └── 📁 tmp
</span></span><span style="display:flex;"><span>├── 📄 build.gradle
</span></span><span style="display:flex;"><span>├── 📄 changelog.md
</span></span><span style="display:flex;"><span>├── 📁 gradle
</span></span><span style="display:flex;"><span>│   └── 📁 wrapper
</span></span><span style="display:flex;"><span>├── 📄 gradle.properties
</span></span><span style="display:flex;"><span>├── 📄 gradlew
</span></span><span style="display:flex;"><span>├── 📄 gradlew.bat
</span></span><span style="display:flex;"><span>├── 📄 LICENSE
</span></span><span style="display:flex;"><span>├── 📄 README.md
</span></span><span style="display:flex;"><span>├── 📁 run
</span></span><span style="display:flex;"><span>│   ├── 📁 config
</span></span><span style="display:flex;"><span>│   ├── 📁 data
</span></span><span style="display:flex;"><span>│   ├── 📁 downloads
</span></span><span style="display:flex;"><span>│   ├── 📁 logs
</span></span><span style="display:flex;"><span>│   ├── 📁 mods
</span></span><span style="display:flex;"><span>│   ├── 📄 options.txt
</span></span><span style="display:flex;"><span>│   ├── 📁 resourcepacks
</span></span><span style="display:flex;"><span>│   ├── 📁 resources
</span></span><span style="display:flex;"><span>│   ├── 📁 saves
</span></span><span style="display:flex;"><span>│   └── 📄 usercache.json
</span></span><span style="display:flex;"><span>├── 📄 settings.gradle
</span></span><span style="display:flex;"><span>└── 📁 src
</span></span><span style="display:flex;"><span>    ├── 📁 generated
</span></span><span style="display:flex;"><span>    └── 📁 main
</span></span></code></pre></div><p>如上是进入根目录后<code>lt -L 2</code>得到的，所以并没有展开到底，大多数代码文件都没有被包含在以上展示的内容中。不过我们可以先来就此分析一下一个fabric模组的主体结构。</p>
<h3 id="gradle构建文件">Gradle构建文件<a href="#gradle%e6%9e%84%e5%bb%ba%e6%96%87%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>决定了项目如何编译以及有哪些依赖。</p>
<h4 id="gradle文件buildgradle">Gradle文件：<code>build.gradle</code><a href="#gradle%e6%96%87%e4%bb%b6buildgradle" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>最核心的文件，定义了一个模组的版本、名称、依赖关系、服务端还是客户端等基本信息。</p>
<p><img src="/zh-cn/posts/fabric%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701%E5%86%9C%E5%A4%AB%E4%B9%90%E4%BA%8B%E9%87%8D%E7%BB%87%E7%89%88/build.gradle.png" alt=""></p>
<h4 id="gradle文件gradleproperties">Gradle文件：<code>gradle.properties</code><a href="#gradle%e6%96%87%e4%bb%b6gradleproperties" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>配置文件，存放Minecraft版本、模组基本信息、fabric loader版本、依赖模组的名称和版本。</p>
<p><img src="/zh-cn/posts/fabric%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701%E5%86%9C%E5%A4%AB%E4%B9%90%E4%BA%8B%E9%87%8D%E7%BB%87%E7%89%88/gradle.properties.png" alt=""></p>
<h4 id="gradle文件settingsgradle">Gradle文件：<code>settings.gradle</code><a href="#gradle%e6%96%87%e4%bb%b6settingsgradle" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>定义项目名称。</p>
<p><img src="/zh-cn/posts/fabric%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701%E5%86%9C%E5%A4%AB%E4%B9%90%E4%BA%8B%E9%87%8D%E7%BB%87%E7%89%88/setting.gradle.png" alt=""></p>
<h4 id="gradle文件gradlew--gradlewbat">Gradle文件：<code>gradlew &amp; gradlew.bat</code><a href="#gradle%e6%96%87%e4%bb%b6gradlew--gradlewbat" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>一键编译模组的脚本。运行<code>./gradlew build</code>后即使电脑上没有安装gradle也可以编译。</p>
<h4 id="gradle文件gradlewrapper">Gradle文件：<code>gradle/wrapper</code><a href="#gradle%e6%96%87%e4%bb%b6gradlewrapper" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>存放让上面的脚本可以正常工作的小程序。</p>
<hr>
<h3 id="src源文件">src源文件<a href="#src%e6%ba%90%e6%96%87%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<h4 id="核心目录srcmain">核心目录：<code>src/main</code><a href="#%e6%a0%b8%e5%bf%83%e7%9b%ae%e5%bd%95srcmain" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>模组的主体，包含所有.java代码以及贴图、模型等资源。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>📁 .
</span></span><span style="display:flex;"><span>├── 📁 java
</span></span><span style="display:flex;"><span>│   └── 📁 vectorwing
</span></span><span style="display:flex;"><span>│       └── 📁 farmersdelight
</span></span><span style="display:flex;"><span>│           ├── 📁 client
</span></span><span style="display:flex;"><span>│           ├── 📁 common
</span></span><span style="display:flex;"><span>│           ├── 📁 data
</span></span><span style="display:flex;"><span>│           ├── ☕ FarmersDelight.java
</span></span><span style="display:flex;"><span>│           ├── 📁 integration
</span></span><span style="display:flex;"><span>│           └── 📁 refabricated
</span></span><span style="display:flex;"><span>└── 📁 resources
</span></span><span style="display:flex;"><span>    ├── 📁 assets
</span></span><span style="display:flex;"><span>    │   ├── 📁 emi
</span></span><span style="display:flex;"><span>    │   │   └── 📁 recipe
</span></span><span style="display:flex;"><span>    │   └── 📁 farmersdelight
</span></span><span style="display:flex;"><span>    │       ├── 📁 atlases
</span></span><span style="display:flex;"><span>    │       ├── 📁 blockstates
</span></span><span style="display:flex;"><span>    │       ├── 📁 lang
</span></span><span style="display:flex;"><span>    │       ├── 📁 models
</span></span><span style="display:flex;"><span>    │       ├── 📁 particles
</span></span><span style="display:flex;"><span>    │       ├── 📁 sounds
</span></span><span style="display:flex;"><span>    │       ├── 📄 sounds.json
</span></span><span style="display:flex;"><span>    │       └── 📁 textures
</span></span><span style="display:flex;"><span>    ├── 📁 data
</span></span><span style="display:flex;"><span>    │   └── 📁 farmersdelight
</span></span><span style="display:flex;"><span>    │       ├── 📁 create
</span></span><span style="display:flex;"><span>    │       ├── 📁 damage_type
</span></span><span style="display:flex;"><span>    │       ├── 📁 loot_modifiers
</span></span><span style="display:flex;"><span>    │       ├── 📁 loot_table
</span></span><span style="display:flex;"><span>    │       ├── 📁 neoforge
</span></span><span style="display:flex;"><span>    │       ├── 📁 recipe
</span></span><span style="display:flex;"><span>    │       ├── 📁 scripts
</span></span><span style="display:flex;"><span>    │       ├── 📁 structure
</span></span><span style="display:flex;"><span>    │       ├── 📁 tags
</span></span><span style="display:flex;"><span>    │       ├── 📁 weapon_attributes
</span></span><span style="display:flex;"><span>    │       └── 📁 worldgen
</span></span><span style="display:flex;"><span>    ├── 📄 fabric.mod.json
</span></span><span style="display:flex;"><span>    ├── 📄 farmersdelight.accesswidener
</span></span><span style="display:flex;"><span>    ├── 📄 farmersdelight.mixins.json
</span></span><span style="display:flex;"><span>    └── 🖼️ icon.png
</span></span></code></pre></div><h4 id="java目录srcmainjava">java目录：<code>src/main/java</code><a href="#java%e7%9b%ae%e5%bd%95srcmainjava" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>所有的Java代码所在地。</p>
<h4 id="素材资源目录srcmainresources">素材资源目录：<code>src/main/resources</code><a href="#%e7%b4%a0%e6%9d%90%e8%b5%84%e6%ba%90%e7%9b%ae%e5%bd%95srcmainresources" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>素材所在地。</p>
<ul>
<li><code>src/main/resources/assets</code>存放贴图、模型、语言、声音文件。</li>
<li><code>src/main/resources/data</code>存放合成表、战利品、标签。</li>
<li><code>src/main/resources/fabric.mod.json</code>记录模组id、名称、入口类等。</li>
</ul>
<hr>
<h4 id="生成资源目录srcgenerated">生成资源目录：<code>src/generated</code><a href="#%e7%94%9f%e6%88%90%e8%b5%84%e6%ba%90%e7%9b%ae%e5%bd%95srcgenerated" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>使用代码生成的游戏数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>📁 .
</span></span><span style="display:flex;"><span>└── 📁 resources
</span></span><span style="display:flex;"><span>    └── 📁 data
</span></span><span style="display:flex;"><span>        ├── 📁 c
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 create
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 createaddition
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 farmersdelight
</span></span><span style="display:flex;"><span>        │   ├── 📁 advancement
</span></span><span style="display:flex;"><span>        │   ├── 📁 enchantment
</span></span><span style="display:flex;"><span>        │   ├── 📁 loot_table
</span></span><span style="display:flex;"><span>        │   ├── 📁 recipe
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 minecraft
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 neoforge
</span></span><span style="display:flex;"><span>        │   ├── 📁 data_maps
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 origins
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 sereneseasons
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        └── 📁 tconstruct
</span></span><span style="display:flex;"><span>            └── 📁 tags
</span></span></code></pre></div><p>以上是<code>src/generated</code>目录下的4级文件树，仍然没有展开到底。展开到底后是各种.json文件。</p>
<hr>
<h3 id="run">run<a href="#run" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>当你点击 IDE 里的“运行游戏”时，它会把这里当成一个独立的 Minecraft 根目录。</p>
<h4 id="存档目录runsaves">存档目录：<!-- raw HTML omitted --><code>run/saves</code><!-- raw HTML omitted --><a href="#%e5%ad%98%e6%a1%a3%e7%9b%ae%e5%bd%95runsaves" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>存档。</p>
<h4 id="运行日志目录runlogs">运行日志目录：<!-- raw HTML omitted --><code>run/logs</code><!-- raw HTML omitted --><a href="#%e8%bf%90%e8%a1%8c%e6%97%a5%e5%bf%97%e7%9b%ae%e5%bd%95runlogs" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>崩溃或调试时的日志。</p>
<h4 id="配置目录runconfig">配置目录：<!-- raw HTML omitted --><code>run/config</code><!-- raw HTML omitted --><a href="#%e9%85%8d%e7%bd%ae%e7%9b%ae%e5%bd%95runconfig" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>模组配置文件，可以包含本模组以及独立根目录的其他模组的测试文件。</p>
<h4 id="模组目录runmods">模组目录：<!-- raw HTML omitted --><code>run/mods</code><!-- raw HTML omitted --><a href="#%e6%a8%a1%e7%bb%84%e7%9b%ae%e5%bd%95runmods" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>调试时想要加载的其他模组，比如jei。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>📁 .
</span></span><span style="display:flex;"><span>├── 📁 config
</span></span><span style="display:flex;"><span>│   ├── 📁 fabric
</span></span><span style="display:flex;"><span>│   │   └── 📄 indigo-renderer.properties
</span></span><span style="display:flex;"><span>│   ├── 📄 farmersdelight-client.json
</span></span><span style="display:flex;"><span>│   ├── 📄 farmersdelight-common.json
</span></span><span style="display:flex;"><span>│   └── 📄 modmenu.json
</span></span><span style="display:flex;"><span>├── 📁 data
</span></span><span style="display:flex;"><span>│   └── 📄 fabricDefaultResourcePacks.dat
</span></span><span style="display:flex;"><span>├── 📁 downloads
</span></span><span style="display:flex;"><span>│   └── 📄 log.json
</span></span><span style="display:flex;"><span>├── 📁 logs
</span></span><span style="display:flex;"><span>│   ├──  debug.log
</span></span><span style="display:flex;"><span>│   ├──  latest.log
</span></span><span style="display:flex;"><span>│   └── 📁 telemetry
</span></span><span style="display:flex;"><span>├── 📁 mods
</span></span><span style="display:flex;"><span>├──  options.txt
</span></span><span style="display:flex;"><span>├── 📁 resourcepacks
</span></span><span style="display:flex;"><span>├── 📁 resources
</span></span><span style="display:flex;"><span>├── 📁 saves
</span></span><span style="display:flex;"><span>│   └── 📁 <span style="color:#e6db74">&#39;New World&#39;</span>
</span></span><span style="display:flex;"><span>│       ├── 📁 advancements
</span></span><span style="display:flex;"><span>│       ├── 📁 data
</span></span><span style="display:flex;"><span>│       ├── 📁 datapacks
</span></span><span style="display:flex;"><span>│       ├── 📁 DIM-1
</span></span><span style="display:flex;"><span>│       ├── 📁 DIM1
</span></span><span style="display:flex;"><span>│       ├── 📁 entities
</span></span><span style="display:flex;"><span>│       ├── 🖼️ icon.png
</span></span><span style="display:flex;"><span>│       ├── 📄 level.dat
</span></span><span style="display:flex;"><span>│       ├── 📄 level.dat_old
</span></span><span style="display:flex;"><span>│       ├── 📁 playerdata
</span></span><span style="display:flex;"><span>│       ├── 📁 poi
</span></span><span style="display:flex;"><span>│       ├── 📁 region
</span></span><span style="display:flex;"><span>│       ├── 🔒 session.lock
</span></span><span style="display:flex;"><span>│       └── 📁 stats
</span></span><span style="display:flex;"><span>└── 📄 usercache.json
</span></span></code></pre></div><hr>
<h3 id="编译产物build">编译产物build<a href="#%e7%bc%96%e8%af%91%e4%ba%a7%e7%89%a9build" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>每次编译后gradle自动生成的文件夹，存放编译时的各种临时文件。此文件夹可以随时删除，下次编译的时候会自动生成。</p>
<hr>
<h1 id="如何正确地看待一个fabric模组的文件结构">如何正确地看待一个fabric模组的文件结构？<a href="#%e5%a6%82%e4%bd%95%e6%ad%a3%e7%a1%ae%e5%9c%b0%e7%9c%8b%e5%be%85%e4%b8%80%e4%b8%aafabric%e6%a8%a1%e7%bb%84%e7%9a%84%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>从上面的简要分析中，你会意识到一个问题：即使是一个看起来其貌不扬的模组，它的文件结构也复杂到了相当逆天的水平。对于我们这种人类程序员来说，我们很难做到手动修改每一个地方来实现功能。一个正常的想法是：这样的模组项目真的是人能组织起来的？</p>
<p>答案是还真不是，这就是java带给我的自信。真实情况是：一个fabric模组看起来结构非常复杂，但是对于其中的绝大多数文件，你其实根本无需去改动。</p>
<ul>
<li><strong>Gradle文件</strong>：除非你要修改版本号或者添加依赖，否则基本无需修改。</li>
<li><strong>&quot;.&ldquo;开头的隐藏文件</strong>：无视。</li>
<li><strong>src/main</strong>：实际的工作区，这里的文件才是你创造的。</li>
</ul>
<p>所以，一个模组开发者眼里应该只有两条路：</p>
<blockquote>
<ol>
<li><strong>src/main/java</strong>: 编写<strong>逻辑</strong>的地方（方块怎么运作、按键有什么反应）。</li>
<li><strong>src/main/resources</strong>: 存放<strong>数据</strong>的地方（方块长什么样、叫什么名字、材质贴图）。</li>
</ol>
</blockquote>
<p>如果你想添加一个东西：</p>
<blockquote>
<p>先思考怎么注册。</p>
</blockquote>
<p>如果你想添加json（配方、loot、模型）：</p>
<blockquote>
<p>使用Data generation系统。</p>
</blockquote>
<p>如果你想修改原版机制：</p>
<blockquote>
<p>使用mixin。</p>
</blockquote>
<hr>
<h1 id="举个例子01">举个例子01<a href="#%e4%b8%be%e4%b8%aa%e4%be%8b%e5%ad%9001" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<blockquote>
<p>（站在FarmersDelightRefabricated开发者视角）我想做一个厨锅。</p>
</blockquote>
<h2 id="q1厨锅是一个方块但是对于厨锅物品我有必要自己去写检测右键计算坐标放置方块等方块的基本属性吗">Q1：厨锅是一个方块，但是对于厨锅物品，我有必要自己去写“检测右键、计算坐标、放置方块”等方块的基本属性吗？<a href="#q1%e5%8e%a8%e9%94%85%e6%98%af%e4%b8%80%e4%b8%aa%e6%96%b9%e5%9d%97%e4%bd%86%e6%98%af%e5%af%b9%e4%ba%8e%e5%8e%a8%e9%94%85%e7%89%a9%e5%93%81%e6%88%91%e6%9c%89%e5%bf%85%e8%a6%81%e8%87%aa%e5%b7%b1%e5%8e%bb%e5%86%99%e6%a3%80%e6%b5%8b%e5%8f%b3%e9%94%ae%e8%ae%a1%e7%ae%97%e5%9d%90%e6%a0%87%e6%94%be%e7%bd%ae%e6%96%b9%e5%9d%97%e7%ad%89%e6%96%b9%e5%9d%97%e7%9a%84%e5%9f%ba%e6%9c%ac%e5%b1%9e%e6%80%a7%e5%90%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>答案：不需要。因为Minecraft所有的<strong>背包里的</strong>方块都是<code>BLockItem</code>的实例。你只需要继承自<code>BLockItem</code>就可以自动获得它的一切特征。</p>
<p>所以，我（开发者）先在<code>/src/main/java/xxx/farmersdelight/common/item/</code>目录下新建一个<code>CookingPotItem.java</code>，然后写入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> vectorwing.farmersdelight.common.item;
</span></span></code></pre></div><p>再写入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CookingPotItem</span> <span style="color:#66d9ef">extends</span> BlockItem
</span></span></code></pre></div><p>代表<code>CookingPotItem</code>直接继承自<code>BlockItem</code>。</p>
<h2 id="q2物品可以有一个绿色的条bar来表示耐久我的厨锅没有耐久但是我也想用这个bar来表示里面装了多少饭怎么实现呢">Q2：物品可以有一个绿色的条（bar）来表示耐久。我的厨锅没有耐久，但是我也想用这个bar来表示里面装了多少饭，怎么实现呢？<a href="#q2%e7%89%a9%e5%93%81%e5%8f%af%e4%bb%a5%e6%9c%89%e4%b8%80%e4%b8%aa%e7%bb%bf%e8%89%b2%e7%9a%84%e6%9d%a1bar%e6%9d%a5%e8%a1%a8%e7%a4%ba%e8%80%90%e4%b9%85%e6%88%91%e7%9a%84%e5%8e%a8%e9%94%85%e6%b2%a1%e6%9c%89%e8%80%90%e4%b9%85%e4%bd%86%e6%98%af%e6%88%91%e4%b9%9f%e6%83%b3%e7%94%a8%e8%bf%99%e4%b8%aabar%e6%9d%a5%e8%a1%a8%e7%a4%ba%e9%87%8c%e9%9d%a2%e8%a3%85%e4%ba%86%e5%a4%9a%e5%b0%91%e9%a5%ad%e6%80%8e%e4%b9%88%e5%ae%9e%e7%8e%b0%e5%91%a2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>答案：劫持原版的原版的ui机制，让它直接为自己服务。从本质上来说，是原版的代码提供了接口类，使得程序员可以将自己的特殊实现塞进去。</p>
<p>我（开发者）：我希望我的厨锅条有以下逻辑：</p>
<h3 id="1-只在厨锅内部装了东西的时候才显示">1. 只在厨锅内部装了东西的时候才显示<a href="#1-%e5%8f%aa%e5%9c%a8%e5%8e%a8%e9%94%85%e5%86%85%e9%83%a8%e8%a3%85%e4%ba%86%e4%b8%9c%e8%a5%bf%e7%9a%84%e6%97%b6%e5%80%99%e6%89%8d%e6%98%be%e7%a4%ba" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>所以我写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isBarVisible</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> getServingCount(stack) <span style="color:#f92672">&gt;</span> 0;
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><h3 id="2-bar的长度能反映内部装了多少东西">2. Bar的长度能反映内部装了多少东西<a href="#2-bar%e7%9a%84%e9%95%bf%e5%ba%a6%e8%83%bd%e5%8f%8d%e6%98%a0%e5%86%85%e9%83%a8%e8%a3%85%e4%ba%86%e5%a4%9a%e5%b0%91%e4%b8%9c%e8%a5%bf" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>所以我写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getBarWidth</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Math.<span style="color:#a6e22e">min</span>(1 <span style="color:#f92672">+</span> 12 <span style="color:#f92672">*</span> getServingCount(stack) <span style="color:#f92672">/</span> 64, 13);
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><h2 id="3-不管里面装了多少东西bar都只是蓝色的">3. 不管里面装了多少东西，Bar都只是蓝色的<a href="#3-%e4%b8%8d%e7%ae%a1%e9%87%8c%e9%9d%a2%e8%a3%85%e4%ba%86%e5%a4%9a%e5%b0%91%e4%b8%9c%e8%a5%bfbar%e9%83%bd%e5%8f%aa%e6%98%af%e8%93%9d%e8%89%b2%e7%9a%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>所以我写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getBarColor</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> BAR_COLOR;
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><h2 id="q3我想">Q3：我想<a href="#q3%e6%88%91%e6%83%b3" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>先别急，接下来能做的事情已经不是仅凭写这个java代码就能完成的了。我（开发者）意识到我做的东西是一个方块，而一个方块远远不止是一个物品栏中的物品那么简单。</p>
<p>我（开发者）还需要做这些事情：</p>
<ol>
<li>注册。我只是写了<strong>厨锅作为物品存在时的部分属性</strong>，我需要让这个厨锅<strong>存在</strong>。</li>
<li>处理它的<strong>方块属性</strong>。我需要在<code>/src/main/java/xxx/farmersdelight/common/block/</code>下写点什么。</li>
<li>添加tooltip。我需要在<code>/src/main/java/xxx/farmersdelight/client/</code>下写点什么。</li>
<li>&hellip;</li>
</ol>
<p>所以，我（开发者）写了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B                   ┌─ ☕ CookingPotRecipeBuilder.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B                ┌─ 📁 builder
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             ┌─ 📁 data
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │     ┌─ ☕ CookingPotRecipeBookTab.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  ┌─ 📁 recipebook
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  │  ┌─ ☕ CookingPotRecipeBookComponent.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  │  ├─ ☕ CookingPotTooltip.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  ├─ ☕ CookingPotScreen.java
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">16384</span> B             │  ├─ 📁 gui
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">20480</span> B             ├─ 📁 client
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │        ┌─ ☕ CookingPotEmiRecipeHandler.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │     ┌─ 📁 handler
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │     │  ┌─ ☕ CookingPotEmiRecipe.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │     ├─ 📁 recipe
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">12288</span> B             │  ┌─ 📁 emi
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  │     ┌─ ☕ CookingPotDisplay.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  │  ┌─ 📁 display
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  │  ┌─ ☕ CookingPotCategory.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  ├─ 📁 categories
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">12288</span> B             │  ├─ 📁 rei
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  │  ┌─ ☕ CTCookingPotRecipeBookTab.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  │  ┌─ ☕ CookingPotRecipeHandler.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  ├─ 📁 handlers
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  │  ┌─ ☕ CookingPotRecipeManager.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  ├─ 📁 managers
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">20480</span> B             │  ├─ 📁 crafttweaker
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">45056</span> B             ├─ 📁 integration
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │     ┌─ ☕ CookingPotItem.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  ┌─ 📁 item
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  ┌─ ☕ CookingPotRecipe.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  ├─ 📁 crafting
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">0</span> B             │  │     ┌─ ☕ CookingPotSupport.java
</span></span><span style="display:flex;"><span>       -             │  │  ┌─ 📁 state
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">12288</span> B             │  │  ├─ ☕ CookingPotBlock.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  │     ┌─ ☕ CookingPotItemHandler.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  │  ┌─ 📁 inventory
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">0</span> B             │  │  │  │  ┌─ ☕ CookingPotMealSlot.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  │  │  │  ├─ ☕ CookingPotResultSlot.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  │  │  ├─ ☕ CookingPotMenu.java
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">12288</span> B             │  │  │  ├─ 📁 container
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">24576</span> B             │  │  │  ├─ ☕ CookingPotBlockEntity.java
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">45056</span> B             │  │  ├─ 📁 entity
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">57344</span> B             │  ├─ 📁 block
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">69632</span> B             ├─ 📁 common
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">143360</span> B          ┌─ 📁 farmersdelight
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">143360</span> B       ┌─ 📁 vectorwing
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">143360</span> B    ┌─ 📁 java
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">143360</span> B ┌─ 📁 main
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">143360</span> B 📁 src
</span></span></code></pre></div><p>我们先暂时不尝试完全理解每个文件在干什么，但是一个很明显的特征，所有的这些文件无一例外存放在<code>src/main/java/vectorwing/farmersdelight/</code>中。所以，尽管看起来文件很复杂，你只需要知道一点：每一个java文件的功能就是做好一件事，有的负责处理物品逻辑，有的负责处理方块逻辑，有的负责处理物品槽逻辑，等等。</p>
<p>所谓的文件目录，本质上就是对于java模块按照功能进行分类。这样看来，一个java模组的结构就一目了然了。程序员只需要事先思考好要实现的东西是什么，有哪些功能，如何分类这些功能，一个模组的文件结构就建立起来了。</p>
<p>回到<code>CookingPotItem.java</code>，完整版如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> vectorwing.farmersdelight.common.item;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.core.component.DataComponents;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.nbt.CompoundTag;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.util.Mth;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.world.inventory.tooltip.TooltipComponent;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.world.item.BlockItem;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.world.item.ItemStack;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.world.item.component.CustomData;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.world.level.block.Block;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> vectorwing.farmersdelight.client.gui.CookingPotTooltip;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> vectorwing.farmersdelight.common.block.entity.CookingPotBlockEntity;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Optional;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CookingPotItem</span> <span style="color:#66d9ef">extends</span> BlockItem
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> BAR_COLOR <span style="color:#f92672">=</span> Mth.<span style="color:#a6e22e">color</span>(0.<span style="color:#a6e22e">4F</span>, 0.<span style="color:#a6e22e">4F</span>, 1.<span style="color:#a6e22e">0F</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">CookingPotItem</span>(Block block, Properties properties) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">super</span>(block, properties);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isBarVisible</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> getServingCount(stack) <span style="color:#f92672">&gt;</span> 0;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getBarWidth</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Math.<span style="color:#a6e22e">min</span>(1 <span style="color:#f92672">+</span> 12 <span style="color:#f92672">*</span> getServingCount(stack) <span style="color:#f92672">/</span> 64, 13);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getBarColor</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> BAR_COLOR;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> Optional<span style="color:#f92672">&lt;</span>TooltipComponent<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getTooltipImage</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  ItemStack mealStack <span style="color:#f92672">=</span> CookingPotBlockEntity.<span style="color:#a6e22e">getMealFromItem</span>(stack);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Optional.<span style="color:#a6e22e">of</span>(<span style="color:#66d9ef">new</span> CookingPotTooltip.<span style="color:#a6e22e">CookingPotTooltipComponent</span>(mealStack));
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getServingCount</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  ItemStack mealStack <span style="color:#f92672">=</span> CookingPotBlockEntity.<span style="color:#a6e22e">getMealFromItem</span>(stack);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> mealStack.<span style="color:#a6e22e">getCount</span>();
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="q4为什么不讲import部分">Q4：为什么不讲import部分？<a href="#q4%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e8%ae%b2import%e9%83%a8%e5%88%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>import是ide的事情，程序员很难也没必要自己去写import。</p>
<h2 id="q5后面两个没讲的方法是做什么的">Q5：后面两个没讲的方法是做什么的？<a href="#q5%e5%90%8e%e9%9d%a2%e4%b8%a4%e4%b8%aa%e6%b2%a1%e8%ae%b2%e7%9a%84%e6%96%b9%e6%b3%95%e6%98%af%e5%81%9a%e4%bb%80%e4%b9%88%e7%9a%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>分别是用来处理tooltip信息和内部物品信息。因为会牵扯到其他java模块，所以暂时不讨论。</p>
]]></content>
		</item>
		
		<item>
			<title>D2L自学日志01：preliminaries</title>
			<link>http://localhost:1313/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701preliminaries/</link>
			<pubDate>Tue, 30 Dec 2025 18:14:36 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701preliminaries/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h1 id="机器学习基础知识">机器学习基础知识<a href="#%e6%9c%ba%e5%99%a8%e5%ad%a6%e4%b9%a0%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<ul>
<li>多维数组</li>
<li>pandas（数据处理）</li>
<li>linear-algebra（线性代数）</li>
<li>calculus（微积分）</li>
<li>autograd（自动微分）</li>
<li>probability（概率）</li>
</ul>
<hr>
<h2 id="多维数组基本知识">多维数组基本知识<a href="#%e5%a4%9a%e7%bb%b4%e6%95%b0%e7%bb%84%e5%9f%ba%e6%9c%ac%e7%9f%a5%e8%af%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">12</span>) <span style="color:#75715e"># tensor([0,1,2,3,4,5,6,7,8,9,10,11])</span>
</span></span></code></pre></div><p><code>torch.arange(x,y,z)</code>的语法和python原生的<code>range()</code>语法一致，左闭右开，第三个参数为步长。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>x<span style="color:#f92672">.</span>shape
</span></span></code></pre></div><p>一个张量的形状，返回值为一个一个<code>torch.Size</code>对象。你可以把它看成一个列表，直接通过方括号访问维度索引值可以得到该张量的某个维度的大小。</p>
<p>如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">24</span>)<span style="color:#f92672">.</span>reshape([<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>])
</span></span><span style="display:flex;"><span>print(x<span style="color:#f92672">.</span>shape) <span style="color:#75715e"># torch.Size([2,3,4])</span>
</span></span><span style="display:flex;"><span>print(x<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]) <span style="color:#75715e"># 3</span>
</span></span></code></pre></div><p><code>torch.reshape([x,y,z,...])</code>可以修改一个张量的形状，本质上就是先把这个张量拉成一维，再依次按照对应维度的大小对一维张量进行均分。</p>
<p>比如：一个<code>x = torch.arange(24)</code>，我们对它进行<code>.reshape([2,3,4])</code>操作，你可以看做：一个<code>arange(24)</code>先进行shape[0]处数字均分，变成前十二个和后十二个，然后对两个12长度的子张量再按照shape[1]处数字进行均分，分别变为三个长度4的子张量，最后对每个长度4的子张量再次均分，得到长度为1的子张量。每一次均分都代表进入下一个维度。</p>
<p><code>x.numel()</code>返回x张量的总元素个数。</p>
<p><code>torch.zeros((2,3,4))</code>生成一个形状为<code>torch.Size([2,3,4])</code>的所有元素为0的张量。</p>
<p><code>torch.ones((2,3,4))</code>生成一个形状为<code>torch.Size([2,3,4])</code>的所有元素为1的张量。</p>
<hr>
<h3 id="运算符">运算符<a href="#%e8%bf%90%e7%ae%97%e7%ac%a6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>常见的标准运算符（+，-，*，\，**）都会被升级为按元素计算。</p>
<p><code>torch.exp(x)</code>得到一个形状和x一致，但是对应位置元素为exp(x)的张量。</p>
<p><code>torch.cat((X, Y), dim = 1)</code>将两个张量沿1维度对接起来，前提是两者其他维度形状一致。</p>
<p>如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>X <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">12</span>, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float32)<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>))
</span></span><span style="display:flex;"><span>Y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([[<span style="color:#ae81ff">2.0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">3</span>], [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>], [<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>]])
</span></span><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>cat((X, Y), dim<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>), torch<span style="color:#f92672">.</span>cat((X, Y), dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span></code></pre></div><p>结果：</p>
<pre tabindex="0"><code>(tensor([[ 0.,  1.,  2.,  3.],
         [ 4.,  5.,  6.,  7.],
         [ 8.,  9., 10., 11.],
         [ 2.,  1.,  4.,  3.],
         [ 1.,  2.,  3.,  4.],
         [ 4.,  3.,  2.,  1.]]),
 tensor([[ 0.,  1.,  2.,  3.,  2.,  1.,  4.,  3.],
         [ 4.,  5.,  6.,  7.,  1.,  2.,  3.,  4.],
         [ 8.,  9., 10., 11.,  4.,  3.,  2.,  1.]]))
</code></pre><p><code>X == Y</code>得到一个张量，元素为布尔值，若X和Y对应位置相等，则对应位置的结果为True，否则为False。</p>
<p><code>X.sum()</code>得到一个单元素张量，数值为X所有元素的总和，如果想直接得到这个值，应该写<code>X.sum().item()</code>。</p>
<hr>
<h3 id="广播机制">广播机制<a href="#%e5%b9%bf%e6%92%ad%e6%9c%ba%e5%88%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>当尝试对两个形状并不匹配的张量相互计算时，若不匹配的维度中某个张量的长度为1，torch就会自动在这个维度上通过复制的方式使两个张量强行匹配数据。</p>
<p>如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>a <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">3</span>)<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>b <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>a, b
</span></span></code></pre></div><p>结果为：</p>
<pre tabindex="0"><code>(tensor([[0],
         [1],
         [2]]),
 tensor([[0, 1]]))
</code></pre><p>但是：</p>
<pre tabindex="0"><code>a + b
</code></pre><p>结果为：</p>
<pre tabindex="0"><code>tensor([[0, 1],
        [1, 2],
        [2, 3]])
</code></pre><hr>
<h3 id="切片">切片<a href="#%e5%88%87%e7%89%87" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>X[2, 3:5]</code>表示的就是X张量中0维度坐标2、1维度坐标3，4的元素。如果我们想要给多个元素赋同样的值，我们只需要索引所有元素，然后赋值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">12</span>)<span style="color:#f92672">.</span>reshape([<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>])
</span></span><span style="display:flex;"><span>x[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">2</span>, :] <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>
</span></span></code></pre></div><p>得到的x：</p>
<pre tabindex="0"><code>tensor([[12., 12., 12., 12.],
        [12., 12., 12., 12.],
        [ 8.,  9., 10., 11.]])
</code></pre><hr>
<h3 id="转换为其他对象">转换为其他对象<a href="#%e8%bd%ac%e6%8d%a2%e4%b8%ba%e5%85%b6%e4%bb%96%e5%af%b9%e8%b1%a1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>转换为numpy多维数组：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>numpy()
</span></span></code></pre></div><p>转换为torch.Tensor：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>Tensor(x)
</span></span></code></pre></div><hr>
<h2 id="pandas">pandas<a href="#pandas" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>数据预处理。</p>
<p>写入数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>makedirs(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;..&#39;</span>, <span style="color:#e6db74">&#39;data&#39;</span>), exist_ok<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>data_file <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;..&#39;</span>, <span style="color:#e6db74">&#39;data&#39;</span>, <span style="color:#e6db74">&#39;house_tiny.csv&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(data_file, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;NumRooms,Alley,Price</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)  <span style="color:#75715e"># 列名</span>
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;NA,Pave,127500</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)  <span style="color:#75715e"># 每行表示一个数据样本</span>
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;2,NA,106000</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;4,NA,178100</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;NA,NA,140000</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p>读取数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(data_file)
</span></span><span style="display:flex;"><span>print(data)
</span></span></code></pre></div><hr>
<h3 id="处理缺失值">处理缺失值<a href="#%e5%a4%84%e7%90%86%e7%bc%ba%e5%a4%b1%e5%80%bc" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>将nan值填补为平均值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>inputs, outputs <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>iloc[:, <span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">2</span>], data<span style="color:#f92672">.</span>iloc[:, <span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>inputs <span style="color:#f92672">=</span> inputs<span style="color:#f92672">.</span>fillna(inputs<span style="color:#f92672">.</span>mean())
</span></span><span style="display:flex;"><span>print(inputs)
</span></span></code></pre></div><hr>
<h3 id="pandas部分练习">pandas部分练习<a href="#pandas%e9%83%a8%e5%88%86%e7%bb%83%e4%b9%a0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_row</span>():
</span></span><span style="display:flex;"><span>    row_data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">5</span>):
</span></span><span style="display:flex;"><span>        added_data <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>random()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> added_data <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0.2</span>:
</span></span><span style="display:flex;"><span>            added_data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;NA&#34;</span>
</span></span><span style="display:flex;"><span>        row_data <span style="color:#f92672">+=</span> str(added_data)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">!=</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>            row_data <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;,&#39;</span>
</span></span><span style="display:flex;"><span>    row_data <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> row_data
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>makedirs(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;..&#39;</span>, <span style="color:#e6db74">&#39;Moonhalf_data&#39;</span>), exist_ok <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>mh_file <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;..&#39;</span>, <span style="color:#e6db74">&#39;Moonhalf_data&#39;</span>, <span style="color:#e6db74">&#39;mh_data.csv&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(mh_file, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;NumA,NumB,NumC,NumD,NumE</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)  <span style="color:#75715e"># 列名</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">50</span>):
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span>write(generate_row())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(mh_file)
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>max_na <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>isna()<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>max()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(target_column)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>refined_data <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>loc[:, data<span style="color:#f92672">.</span>isna()<span style="color:#f92672">.</span>sum() <span style="color:#f92672">&lt;</span> max_na]
</span></span><span style="display:flex;"><span>print(refined_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>refined_data <span style="color:#f92672">=</span> refined_data<span style="color:#f92672">.</span>fillna(refined_data<span style="color:#f92672">.</span>mean())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>refined_tensor <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(refined_data<span style="color:#f92672">.</span>to_numpy(dtype <span style="color:#f92672">=</span> float))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(refined_tensor)
</span></span></code></pre></div><p>这段代码的作用是：生成一个50 * 5的随机数数据集，删除缺失值最多的列，并将预处理后的数据集转换为张量格式。</p>
<hr>
<h2 id="线性代数">线性代数<a href="#%e7%ba%bf%e6%80%a7%e4%bb%a3%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p><code>X.T</code>转置。</p>
<p><code>X.clone()</code>一个和X一模一样的张量，但是重新分配内存。</p>
<p><code>A.sum(axis = 1)</code>让A沿着1维坐标轴求和，得到n-1维张量。（想象这个张量沿着1维压扁，重叠的地方就求和）</p>
<p>比如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>test_sum <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">24</span>)<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>print(test_sum)
</span></span><span style="display:flex;"><span>print(test_sum<span style="color:#f92672">.</span>sum(axis <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>print(test_sum<span style="color:#f92672">.</span>sum(axis <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>print(test_sum<span style="color:#f92672">.</span>sum(axis <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>print(test_sum<span style="color:#f92672">.</span>sum(axis <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>]))
</span></span></code></pre></div><p>结果：</p>
<pre tabindex="0"><code>tensor([[[ 0,  1,  2,  3],
         [ 4,  5,  6,  7],
         [ 8,  9, 10, 11]],

        [[12, 13, 14, 15],
         [16, 17, 18, 19],
         [20, 21, 22, 23]]])
tensor([[12, 14, 16, 18],
        [20, 22, 24, 26],
        [28, 30, 32, 34]])
tensor([[12, 15, 18, 21],
        [48, 51, 54, 57]])
tensor([[ 6, 22, 38],
        [54, 70, 86]])
tensor([60, 66, 72, 78])
</code></pre><p><code>A.mean(axis = 1)</code>沿着1维求平均值，规则类似sum。</p>
<p>不降维求和：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sum_A <span style="color:#f92672">=</span> A<span style="color:#f92672">.</span>sum(axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, keepdims<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>sum_A
</span></span></code></pre></div><hr>
<h3 id="点积">点积<a href="#%e7%82%b9%e7%a7%af" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>torch.dot(X, Y)</code>将X和Y对应位置元素相乘求和，得到一个单元素张量。</p>
<p>注意：虽然听起来很废话，但是dot只能适用于1D张量。</p>
<hr>
<h3 id="向量积">向量积<a href="#%e5%90%91%e9%87%8f%e7%a7%af" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>torch.mv(X, Y)</code>对两个向量求叉乘。</p>
<hr>
<h3 id="矩阵乘法">矩阵乘法<a href="#%e7%9f%a9%e9%98%b5%e4%b9%98%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>torch.mm(X, Y)</code>对两个矩阵做矩阵乘法，注意这不是对应位置元素相乘（Hadamard积）。</p>
<hr>
<h3 id="范数">范数<a href="#%e8%8c%83%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>用来衡量一个张量的大小。</p>
<hr>
<h3 id="l2范数">L2范数<a href="#l2%e8%8c%83%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>torch.norm()</code>得到一个向量的长度。对于一个多维张量来说，它的含义是求所有元素平方和再开根号。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>u <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">3.0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">4.0</span>])
</span></span><span style="display:flex;"><span>v <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">3.0</span>,<span style="color:#ae81ff">4.0</span>,<span style="color:#ae81ff">5.0</span>])
</span></span><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>norm(u), torch<span style="color:#f92672">.</span>norm(v)
</span></span></code></pre></div><p>结果：</p>
<pre tabindex="0"><code>(tensor(5.), tensor(7.0711))
</code></pre><hr>
<h3 id="l1范数">L1范数<a href="#l1%e8%8c%83%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>torch.abs(x).sum()</code>得到所有分量绝对值之和。</p>
<hr>
<h2 id="自动求导autograd">自动求导（autograd）<a href="#%e8%87%aa%e5%8a%a8%e6%b1%82%e5%af%bcautograd" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">2.0</span>], requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> x <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>y<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>print(x<span style="color:#f92672">.</span>grad) <span style="color:#75715e"># 此时是 4.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>z <span style="color:#f92672">=</span> x <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>z<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>print(x<span style="color:#f92672">.</span>grad) <span style="color:#75715e"># 此时是 4.0 + 3.0 = 7.0 ！</span>
</span></span></code></pre></div><hr>
<h3 id="为什么xgrad似乎并不符合通常的程序设计原则">为什么x.grad似乎并不符合通常的程序设计原则？<a href="#%e4%b8%ba%e4%bb%80%e4%b9%88xgrad%e4%bc%bc%e4%b9%8e%e5%b9%b6%e4%b8%8d%e7%ac%a6%e5%90%88%e9%80%9a%e5%b8%b8%e7%9a%84%e7%a8%8b%e5%ba%8f%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>x.grad</code>在通常的oop程序设计中应该表示一个对象自身的属性，但是在torch中<code>x.grad</code>会随着使用x的表达式backward()而发生改变，对于一般的程序设计而言，这种设计是比较反直觉的。</p>
<p>对于不同的表达式，torch对于梯度的操作并非覆盖而是累加。从上面的例子中我们可以看到x.grad最后的值为7.0。至于为什么要设计成累加的模式，一方面是数学上的便利，根据微积分的链式法则，如果一个变量x同时影响了多个分支，那么总梯度就是各个分支梯度的和；另一方面这样做更能节省内存，即使你的网络极其复杂，分成好几路输出，PyTorch也不需要为每一路都开辟新的空间存梯度，只需要在x.grad这一相同地址上做加法即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">24</span>)<span style="color:#f92672">.</span>reshape([<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">6</span>])<span style="color:#f92672">.</span>to(torch<span style="color:#f92672">.</span>float32)
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>requires_grad_(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> (x <span style="color:#f92672">*</span> x)<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span>y<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>grad
</span></span></code></pre></div><p>需要注意的是，尽管多维数组对多维数组的求导在数学上是有意义的，pytorch中仅支持从标量开始的反向传播。比如，在如上的例子中，y是一个单元素张量，此时可以对它进行backward()操作，但是如果<code>y = 2 * x</code>，那么再尝试<code>y.backward()</code>就会报错。</p>
<p>原因同样是出于对机器学习实际计算工作的妥协，在工程上直接对多维数组之间进行求导意味着我们会需要计算两个数组元素个数之积次计算，而机器学习中我们处理的数组大小有时可以达到百万数量级。直接求导会导致极大的显存消耗。</p>
<hr>
<p>我们尝试通过一个例子来解释pytorch的优化逻辑：</p>
<p>假设：</p>
<ul>
<li>x = [x1, x2, &hellip;]是一个10000维向量。</li>
<li>y = [y1, y2, &hellip;]也是一个10000维向量，但是它是由x计算出来的。</li>
<li>L = f(y)是一个<strong>标量</strong>。在机器学习的语境下它通常是一个误差函数。</li>
</ul>
<p>你的目标是求$\frac{\partial L}{\partial x}$。</p>
<p>对于通常的数学书求法，我们会需要使用链式法则，计算$\frac{\partial L}{\partial y}$，再计算$\frac{\partial y}{\partial x}$，再将两者相乘。其中后者就是向量对向量求导，即<strong>雅可比矩阵</strong>。当x、y体积巨大时，直接计算这个雅可比矩阵的计算量会直接爆炸。</p>
<p>更重要的是，虽然x和y体积巨大，但是真正进行相互计算的时候，对于它们的每个分量来说，另一个向量中和它相关的分量个数是相当有限的。尤其在机器学习的情景下，假如你计算出了雅可比矩阵，你会发现它相当的稀疏，其中绝大多数的数字都是0。因为大多数的分量之间都没有什么关系。</p>
<p>但是对于一个矩阵计算来说，它必须要存储所有分量和所有分量之间的关系，这意味着即使是两者没有任何关系，矩阵也必须要占用空间来表示这种没有关系的关系。</p>
<p>pytorch的优化思路其实很简单：我们大可以只站在分量的视角看待问题，只去记录那些和自己有关的分量以及过程中的计算方式，而对于那些和自己无关的分量，我们根本不去记录，也自然不会产生关联。</p>
<p>我们来用一个相对简单的例子解释torch的工作原理：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>Tensor([<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>requires_grad_(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y1_mask <span style="color:#f92672">=</span> x <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y1 <span style="color:#f92672">=</span> x[y1_mask]<span style="color:#f92672">.</span>squeeze(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y2 <span style="color:#f92672">=</span> (x <span style="color:#f92672">*</span> x)<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(y1, y2)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>L <span style="color:#f92672">=</span> y1 <span style="color:#f92672">+</span> y2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;L: </span><span style="color:#e6db74">{</span>L<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>L<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(x<span style="color:#f92672">.</span>grad)
</span></span></code></pre></div><p>运行得到的结果是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>L: 33.0
</span></span><span style="display:flex;"><span>tensor<span style="color:#f92672">([</span>4., 6., 9.<span style="color:#f92672">])</span>
</span></span></code></pre></div><p>在这个例子中，y1是x中大于3的元素构成的单元素张量，y2是x对自己的点积组成的单元素张量，L则是y1和y2求和得到的单元素张量。</p>
<p>首先，我们计算y1时，torch同时记录下了“y1是由x通过y1_mask筛选出来的”；计算y2时，torch也同时记录下了“y2是由x对自己按元素求乘积再求和得到的”。最后，计算L时，torch会记录下“L是由y1加上y2得到的”。</p>
<p>当我们对L进行backward时，torch会去查询L的计算方式。此时，我们假设我们需要L增加1，torch会把这个1传递给计算得到L的y1和y2，因为L对y1和y2求偏导得到的是1，所以y1和y2被传递得到1，意味着y1和y2对于L的贡献都是1。</p>
<p>接着，torch会去查询y1和y2的计算方式，y1是由x的第三个元素组成的，所以x的第三个元素对y1的贡献是1，进而对L的贡献也是1；y2由x自乘求和得到，所以x每个元素对y2的贡献是2 * x，在x = [2, 3, 4]时，x中元素对y2的贡献依次为4、6、8，进而对L的贡献也是4，6，8。</p>
<p>最后，我们对x中每个元素对L的各种贡献进行求和，我们得到x中每个元素在当前数值下对于L的贡献依次为4，6，9，即为我们最后得到的<code>tensor([4.,6.,9.,])</code></p>
<p>需要明确的是，贡献这个词的使用实际上可能数学并不准确。我们最后得到的东西实际上是L这个标量对x的梯度，即∇L，其意义可以简单理解为L在随x各个维度改变而改变的速率。</p>
<hr>
<h3 id="非标量变量的反向传播">非标量变量的反向传播<a href="#%e9%9d%9e%e6%a0%87%e9%87%8f%e5%8f%98%e9%87%8f%e7%9a%84%e5%8f%8d%e5%90%91%e4%bc%a0%e6%92%ad" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>从我们上面的推导中可以发现，我们对一个标量结果进行反向传播，最后得到的向量是x中对应元素对结果的贡献值。而理论上假如我们能直接对一个向量进行反向传播，最后得到的应该是一个雅可比矩阵。</p>
<p>然而，我们需要的事实上根本不是这个矩阵，我们需要的是损失向量通过这个矩阵变换得到的结果，进而更新参数。对于我们的实际应用中，这个矩阵本身没有任何应用价值。</p>
<p>用更加精辟的语言来说：</p>
<blockquote>
<p>Pytorch的反向传播根本不需要返回一个矩阵，因为它本身就在模拟雅可比矩阵的线性算子功能。</p>
</blockquote>
<p>然而，在某些情景下我们确实会需要计算非标量变量的反向传播，比如多个batch同时进行训练，但是即使在这种情景，我们最后需要得到的依然是一个向量。实现方式是让批量中每个样本对x求梯度，最后再求和或者求平均，或者加权平均。总而言之，反向传播归根结底是获取一个用来更新参数的向量，获取二维及以上的张量没有什么实际意义。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 对非标量调用backward需要传入一个gradient参数，该参数指定微分函数关于self的梯度。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 本例只想求偏导数的和，所以传递一个1的梯度是合适的</span>
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>grad<span style="color:#f92672">.</span>zero_()
</span></span><span style="display:flex;"><span>print(x<span style="color:#f92672">.</span>grad, x)
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> x <span style="color:#f92672">*</span> x
</span></span><span style="display:flex;"><span>print(y)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 等价于y.backward(torch.ones(len(x)))</span>
</span></span><span style="display:flex;"><span>y<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>grad
</span></span></code></pre></div><p>所谓的gradient参数，实际上是一个和x一样长度的向量，含义是<strong>y的每个分量</strong>对于最终结果的贡献。在这里，如果我们写<code>y.sum()</code>，本质上就是将y的每个元素进行求和，所以y的每个元素对最终结果的贡献为1；如果写<code>torch.ones(len(x))</code>意思就是y的每个参数对于最终结果的贡献都是1，所以两者其实是等价的。</p>
<hr>
<h3 id="分离计算">分离计算<a href="#%e5%88%86%e7%a6%bb%e8%ae%a1%e7%ae%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>有时候我们只想要把一个<code>torch.Tensor</code>当做一个常数来计算，但是得到这个<code>torch.Tensor</code>的过程中经过了一些计算，使得最后反向传播的时候可能影响最后的结果。此时，我们会希望得到这个tensor，但是抹除它所有的计算历史。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>grad<span style="color:#f92672">.</span>zero_()
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> x <span style="color:#f92672">*</span> x
</span></span><span style="display:flex;"><span>u <span style="color:#f92672">=</span> y<span style="color:#f92672">.</span>detach()
</span></span><span style="display:flex;"><span>print(u)
</span></span><span style="display:flex;"><span>z <span style="color:#f92672">=</span> u <span style="color:#f92672">*</span> x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>z<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>grad <span style="color:#f92672">==</span> u
</span></span></code></pre></div><p>在这个例子中，u被赋值为<code>y.detach()</code>，含义是使u的张量内容和y一样，但是失去了所有计算记录。这样，后续的反向传递过程中u处就不会向后传递。</p>
<p>结果是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tensor<span style="color:#f92672">([</span>True, True, True, True<span style="color:#f92672">])</span>
</span></span></code></pre></div><hr>
<h3 id="如何实现二阶导">如何实现二阶导?<a href="#%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e4%ba%8c%e9%98%b6%e5%af%bc" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">2.0</span>], requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 定义函数</span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> x <span style="color:#f92672">**</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 计算一阶导数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 grad 函数，并开启 create_graph=True</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这会把“计算一阶导数”的过程也记录在计算图里</span>
</span></span><span style="display:flex;"><span>grads <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>autograd<span style="color:#f92672">.</span>grad(y, x, create_graph<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;一阶导数在 x=2 时: </span><span style="color:#e6db74">{</span>grads<span style="color:#f92672">.</span>item()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>) <span style="color:#75715e"># 3 * 2^2 = 12.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 对一阶导数再次求导</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这次不需要再创建图了（除非你要算三阶导）</span>
</span></span><span style="display:flex;"><span>grads2 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>autograd<span style="color:#f92672">.</span>grad(grads, x)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;二阶导数在 x=2 时: </span><span style="color:#e6db74">{</span>grads2<span style="color:#f92672">.</span>item()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>) <span style="color:#75715e"># 6 * 2 = 12.0</span>
</span></span></code></pre></div><p>我们没办法通过backward实现二阶导（比如L.backward().backward()），因为反向传播的计算本身并不会被存储在计算图中，但是为了实现二阶导，我们需要一阶导的计算图。因此在上面的例子中我们使用<code>torch.autograd.grad()</code>函数，并添加<code>create_graph=True</code>参数来生成包含一阶导计算图的梯度向量。</p>
<hr>
<h3 id="控制流">控制流<a href="#%e6%8e%a7%e5%88%b6%e6%b5%81" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>a <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>randn(size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>,), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>print(a)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> a<span style="color:#f92672">.</span>norm() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>    b <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    b <span style="color:#f92672">=</span> (a <span style="color:#f92672">*</span> a)<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>b<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(a<span style="color:#f92672">.</span>grad)
</span></span></code></pre></div><p>torch支持控制流梯度计算，这意味着即使不同情况下计算b的方式可能不同，对b进行反向传播仍然可以得到当前计算方式下的对应梯度。</p>
<hr>
<h3 id="绘制函数与导函数图像不直接计算导数">绘制函数与导函数图像（不直接计算导数）<a href="#%e7%bb%98%e5%88%b6%e5%87%bd%e6%95%b0%e4%b8%8e%e5%af%bc%e5%87%bd%e6%95%b0%e5%9b%be%e5%83%8f%e4%b8%8d%e7%9b%b4%e6%8e%a5%e8%ae%a1%e7%ae%97%e5%af%bc%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> matplotlib_inline <span style="color:#f92672">import</span> backend_inline
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> math
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">use_svg_display</span>():  <span style="color:#75715e">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;使用svg格式在Jupyter中显示绘图&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    backend_inline<span style="color:#f92672">.</span>set_matplotlib_formats(<span style="color:#e6db74">&#39;svg&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_figsize</span>(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">3.5</span>, <span style="color:#ae81ff">2.5</span>)):  <span style="color:#75715e">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;设置matplotlib的图表大小&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    use_svg_display()
</span></span><span style="display:flex;"><span>    d2l<span style="color:#f92672">.</span>plt<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;figure.figsize&#39;</span>] <span style="color:#f92672">=</span> figsize
</span></span><span style="display:flex;"><span><span style="color:#75715e">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_axes</span>(axes, xlabel, ylabel, xlim, ylim, xscale, yscale, legend):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;设置matplotlib的轴&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>set_xlabel(xlabel)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>set_ylabel(ylabel)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>set_xscale(xscale)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>set_yscale(yscale)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>set_xlim(xlim)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>set_ylim(ylim)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> legend:
</span></span><span style="display:flex;"><span>        axes<span style="color:#f92672">.</span>legend(legend)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>grid()
</span></span><span style="display:flex;"><span><span style="color:#75715e">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">plot</span>(X, Y<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, xlabel<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, ylabel<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, legend<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, xlim<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>         ylim<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, xscale<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;linear&#39;</span>, yscale<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;linear&#39;</span>,
</span></span><span style="display:flex;"><span>         fmts<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;-&#39;</span>, <span style="color:#e6db74">&#39;m--&#39;</span>, <span style="color:#e6db74">&#39;g-.&#39;</span>, <span style="color:#e6db74">&#39;r:&#39;</span>), figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">3.5</span>, <span style="color:#ae81ff">2.5</span>), axes<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;绘制数据点&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> legend <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        legend <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    set_figsize(figsize)
</span></span><span style="display:flex;"><span>    axes <span style="color:#f92672">=</span> axes <span style="color:#66d9ef">if</span> axes <span style="color:#66d9ef">else</span> d2l<span style="color:#f92672">.</span>plt<span style="color:#f92672">.</span>gca()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 如果X有一个轴，输出True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_one_axis</span>(X):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (hasattr(X, <span style="color:#e6db74">&#34;ndim&#34;</span>) <span style="color:#f92672">and</span> X<span style="color:#f92672">.</span>ndim <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">or</span> isinstance(X, list)
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> hasattr(X[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#34;__len__&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> has_one_axis(X):
</span></span><span style="display:flex;"><span>        X <span style="color:#f92672">=</span> [X]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> Y <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        X, Y <span style="color:#f92672">=</span> [[]] <span style="color:#f92672">*</span> len(X), X
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> has_one_axis(Y):
</span></span><span style="display:flex;"><span>        Y <span style="color:#f92672">=</span> [Y]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(X) <span style="color:#f92672">!=</span> len(Y):
</span></span><span style="display:flex;"><span>        X <span style="color:#f92672">=</span> X <span style="color:#f92672">*</span> len(Y)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>cla()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x, y, fmt <span style="color:#f92672">in</span> zip(X, Y, fmts):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(x):
</span></span><span style="display:flex;"><span>            axes<span style="color:#f92672">.</span>plot(x, y, fmt)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            axes<span style="color:#f92672">.</span>plot(y, fmt)
</span></span><span style="display:flex;"><span>    set_axes(axes, xlabel, ylabel, xlim, ylim, xscale, yscale, legend)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> math<span style="color:#f92672">.</span>pi, <span style="color:#ae81ff">0.05</span><span style="color:#f92672">*</span>math<span style="color:#f92672">.</span>pi)
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>requires_grad_(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">f</span>(x):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> d2l<span style="color:#f92672">.</span>sin(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> f(x)<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plot(x<span style="color:#f92672">.</span>detach(), [f(x)<span style="color:#f92672">.</span>detach(), x<span style="color:#f92672">.</span>grad],<span style="color:#e6db74">&#34;x&#34;</span>, <span style="color:#e6db74">&#34;f(x)&#34;</span>)
</span></span></code></pre></div><p>需要使用d2l库和jupyter lab。</p>
<hr>
<h2 id="概率">概率<a href="#%e6%a6%82%e7%8e%87" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="多项分布multinomial-distribution">多项分布(multinomial distribution)<a href="#%e5%a4%9a%e9%a1%b9%e5%88%86%e5%b8%83multinomial-distribution" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>将概率分配给一些离散选项的分布称为多项分布。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.distributions <span style="color:#f92672">import</span> multinomial
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fair_probs <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>ones([<span style="color:#ae81ff">6</span>]) <span style="color:#f92672">/</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(multinomial<span style="color:#f92672">.</span>Multinomial(<span style="color:#ae81ff">1</span>, fair_probs)<span style="color:#f92672">.</span>sample())
</span></span><span style="display:flex;"><span>print(multinomial<span style="color:#f92672">.</span>Multinomial(<span style="color:#ae81ff">2</span>, fair_probs)<span style="color:#f92672">.</span>sample())
</span></span><span style="display:flex;"><span>print(multinomial<span style="color:#f92672">.</span>Multinomial(<span style="color:#ae81ff">10</span>, fair_probs)<span style="color:#f92672">.</span>sample())
</span></span></code></pre></div><p><code>multinomial.Multinomial()</code>用来生成一个采样器，这个采样器每次采样会根据<code>fair_probs</code>也就是概率向量对应的概率来抽取一个位置索引，第一个参数时一次采样的抽取次数。最后得到的向量中对应位置的数字即这个位置被抽中的次数。</p>
<p>上述代码的某次生成结果为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tensor([<span style="color:#ae81ff">1.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>])
</span></span><span style="display:flex;"><span>tensor([<span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">2.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>])
</span></span><span style="display:flex;"><span>tensor([<span style="color:#ae81ff">1.</span>, <span style="color:#ae81ff">1.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">2.</span>, <span style="color:#ae81ff">1.</span>, <span style="color:#ae81ff">5.</span>])
</span></span></code></pre></div><hr>
<h3 id="联合概率">联合概率<a href="#%e8%81%94%e5%90%88%e6%a6%82%e7%8e%87" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>\(P(A=a,B=b)\)，A和B同时发生的概率。</p>
<h3 id="条件概率">条件概率<a href="#%e6%9d%a1%e4%bb%b6%e6%a6%82%e7%8e%87" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>\(0 \leq \frac{P(A=a, B=b)}{P(A=a)} \leq 1\) ，A发生的前提下A、B同时发生的概率。</p>
<h3 id="贝叶斯定理">贝叶斯定理<a href="#%e8%b4%9d%e5%8f%b6%e6%96%af%e5%ae%9a%e7%90%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
$$P(A \mid B) = \frac{P(B \mid A) P(A)}{P(B)}.$$<h3 id="边际化">边际化<a href="#%e8%be%b9%e9%99%85%e5%8c%96" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
$$P(B) = \sum_{A} P(A, B),$$]]></content>
		</item>
		
		<item>
			<title>工具不图鉴03：虚拟环境&amp;conda</title>
			<link>http://localhost:1313/zh-cn/posts/venvminiconda/</link>
			<pubDate>Tue, 16 Dec 2025 23:23:35 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/venvminiconda/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h2 id="什么是虚拟环境">什么是虚拟环境?<a href="#%e4%bb%80%e4%b9%88%e6%98%af%e8%99%9a%e6%8b%9f%e7%8e%af%e5%a2%83" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>多数语境下，虚拟环境是一个独属于python的术语。python因其对第三方库的高度依赖性以及python自身版本本来就比较混乱，导致经常出现python与各路依赖和第三方库乱成一锅粥的情况。</p>
<p>想要解决这种困境倒也并不困难。我们不妨设想这样的场景：假如你养了一只猫和一条狗，但是猫狗放在一起就会开始打架，你又想同时养这两个动物，该怎么办呢？很简单，你只需要将猫和狗隔开来养即可，比如给它们各自安排一个房间。</p>
<p>这样的一个房间，在python语境下就是一个<strong>虚拟环境</strong>。通常来说，你最好让给每个项目都单独创建一个虚拟环境，这样它们之间就可以互不干扰，可以相互重复，也可以独立删除。就像一个动物园，假如把所有动物关在一起就会开始饥饿游戏，但是把每种动物分开关在各自的园区，彼此之间就可以相安无事。</p>
<hr>
<h3 id="虚拟环境是怎么实现的">虚拟环境是怎么实现的？<a href="#%e8%99%9a%e6%8b%9f%e7%8e%af%e5%a2%83%e6%98%af%e6%80%8e%e4%b9%88%e5%ae%9e%e7%8e%b0%e7%9a%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在计算机世界，程序员为了环境隔离实际上有过相当多的尝试，比如虚拟机可以模拟一个操作系统，docker容器可以把进程装在一个看起来像独立系统的盒子里。</p>
<p>但是一个python虚拟环境所做的事情远比上述尝试轻量的多。一个python虚拟环境只做三件事：</p>
<ol>
<li>使用独立的python可执行文件。隔离不同python版本。</li>
<li>使用独立的第三方目录库，隔离第三方库。</li>
<li>控制导入顺序。</li>
</ol>
<hr>
<h3 id="如何创建一个虚拟环境">如何创建一个虚拟环境？<a href="#%e5%a6%82%e4%bd%95%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aa%e8%99%9a%e6%8b%9f%e7%8e%af%e5%a2%83" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>一个虚拟环境在机器中的表现形式其实就是一个文件夹，里面包含了这个环境的各种信息。通常来说，人们会把这个文件夹建立在项目文件中。</p>
<p>但是，需要注意的是，在一个虚拟环境被激活之后，你无论处在哪个目录下，只要不关闭这个虚拟环境，你都处在这个虚拟环境中。也就是说，虚拟环境与你的目录位置没有任何关系。理论上只要找的到，你把它放在任何一个犄角旮旯里都可以正常工作。</p>
<p>尽管如此，仍然建议你直接把虚拟环境直接建在项目目录中，这样项目和环境可以方便的同步迁移，并且可以确保你的ide可以识别到这个虚拟环境。</p>
<hr>
<h4 id="venv">venv<a href="#venv" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>这是python自带的虚拟环境创建方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python3.10 -m venv .venv
</span></span></code></pre></div><p>这句指令的意义是在当前目录下创建一个.venv文件夹，里面装的就是这个虚拟环境的信息。</p>
<p>针对每个参数，逐一分析一下这句指令：</p>
<hr>
<h5 id="python310">python3.10<a href="#python310" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h5>
<p>指定启动这个虚拟环境的python版本。以防你不知道，一台机器是可以同时存在多个python版本的。比如<code>pkg install python3.10</code>就可以强制要求安装3.10版本的python。</p>
<h5 id="-m">-m<a href="#-m" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h5>
<p>让后面的名字（在我们这里是venv）作为一个python模块来运行。</p>
<h5 id="venv-1">venv<a href="#venv-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h5>
<p>这是一个python标准库中的模块，功能是创建一个虚拟环境。因为它本质上不是一个位于当前目录下的文件，你没办法直接通过运行文件的方式来使用。这也就是为什么前面必须要加<code>-m</code>参数才能使用。</p>
<h5 id="venv-2">.venv<a href="#venv-2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h5>
<p>在当前目录下生成的虚拟环境文件夹名称。这只是一个名称而已，你可以随意把它换成你喜欢的名字。</p>
<p>比如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python3.12 -m venv .asdf1234
</span></span></code></pre></div><p>之所以加<code>.</code>是为了让这个文件夹成为一个隐藏文件夹，这是一个工程惯例。实际上不加<code>.</code>也无所谓。</p>
<hr>
<h3 id="如何使用一个虚拟环境">如何使用一个虚拟环境？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e4%b8%80%e4%b8%aa%e8%99%9a%e6%8b%9f%e7%8e%af%e5%a2%83" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在你创建的虚拟环境文件夹下，你可以看到大致这样的目录结构：</p>
<p><img src="/zh-cn/posts/venvminiconda/venv.jpg" alt=""></p>
<p>你可以很清晰的看到这个文件夹里包含了什么：有虚拟环境自己的python、pip，以及专门存放lib的文件目录。此外，在bin目录下，你还可以找到<code>activate</code>文件，这就是虚拟环境的启动脚本。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>source .venv/bin/activate
</span></span></code></pre></div><p>运行这个指令，虚拟环境就成功激活了。想要关闭虚拟环境，输入以下指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>deactivate
</span></span></code></pre></div><hr>
<p>在虚拟环境中，你拥有一套和外界环境隔离的第三方库目录。你可以随意增删当前虚拟环境中的第三方库，这些操作都不会对外界环境造成影响。作为补充，这里罗列一些pip常用的指令。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip install numpy <span style="color:#75715e"># 下载numpy库</span>
</span></span></code></pre></div><p>注意，这里之所以先写<code>python -m</code>再写pip，是为了确保使用当前虚拟环境下的pip。pip是一个模块，而模块永远属于某个python。使用<code>-m</code>参数可以确保永远不会装错环境。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip install numpy<span style="color:#f92672">==</span>1.26.4 <span style="color:#75715e"># 指定安装版本</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip list <span style="color:#75715e"># 列出当前环境下安装了哪些包</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip uninstall numpy <span style="color:#75715e"># 卸载numpy</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip show numpy <span style="color:#75715e"># 显示某个包的详细信息，包括版本、安装路径、依赖关系。</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip install --upgrade numpy <span style="color:#75715e"># 在已经安装了numpy的基础上对它进行更新</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip freeze &gt; requirements.txt <span style="color:#75715e"># 导出当前环境依赖到requirements.txt文件</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip install -r requirements.txt <span style="color:#75715e"># 从requirements.txt安装</span>
</span></span></code></pre></div><p>如果你想要删除一个虚拟环境，不需要使用什么特殊的指令，直接rm掉你建立的虚拟环境文件夹即可。</p>
<hr>
<h2 id="conda是什么">Conda是什么?<a href="#conda%e6%98%af%e4%bb%80%e4%b9%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>一句话定位conda:</p>
<blockquote>
<p>conda不是更高级的venv，
而是：“<strong>一个跨语言+跨平台+可管理python版本的环境与包管理系统</strong>”</p>
</blockquote>
<p>python官方的pip以及venv只能管理python包，但是在现实中的科学计算以及机器学习等应用场景中，一个完整的环境会涉及很多非python的依赖，并且需要处理各种跨平台问题。这就已经触及到了python原生工具的能力边界。</p>
<p>conda的出现旨在一次性解决这些问题。conda<strong>同时</strong>是一个<strong>环境管理器</strong>（你可以用它建立虚拟环境，并且比venv隔离的更加彻底）、<strong>包管理器</strong>（conda install numpy），兼<strong>python版本管理器</strong>（不管你系统中有没有安装python）。</p>
<hr>
<h3 id="anacondaminiconda是什么">Anaconda/Miniconda是什么？<a href="#anacondaminiconda%e6%98%af%e4%bb%80%e4%b9%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>Anaconda = conda + 一大堆科学计算库</p>
<p>Miniconda = conda + Python</p>
<p>通常认为Anaconda更适合用来快速上手，但是比较冗余。如果想要更轻量可控的环境，更建议使用Miniconda。</p>
<hr>
<h3 id="如何安装conda">如何安装conda?<a href="#%e5%a6%82%e4%bd%95%e5%ae%89%e8%a3%85conda" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>这里以Miniconda为例。</p>
<p><a href="https://www.anaconda.com/docs/getting-started/miniconda/main">Miniconda官网</a></p>
<hr>
<h4 id="方法一去官网下载安装脚本">方法一：去官网下载安装脚本<a href="#%e6%96%b9%e6%b3%95%e4%b8%80%e5%8e%bb%e5%ae%98%e7%bd%91%e4%b8%8b%e8%bd%bd%e5%ae%89%e8%a3%85%e8%84%9a%e6%9c%ac" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>根据你的cpu架构去官网下载对应的.sh脚本，然后在你的终端运行。</p>
<blockquote>
<p>注意：在我写博客文的同时，我发现conda不支持termux。如果你想使用conda，请确保你处在一个真正的电脑上。</p>
</blockquote>
<h4 id="方法二使用curl--wget">方法二：使用curl &amp; wget<a href="#%e6%96%b9%e6%b3%95%e4%ba%8c%e4%bd%bf%e7%94%a8curl--wget" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<hr>
<p>wget方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
</span></span></code></pre></div><p>或者curl方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -O https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
</span></span></code></pre></div><p>下载得到.sh脚本之后，仍然运行该脚本。注意这里给出的指令是x86_64架构且为linux，aarch64需要做出相应修改。</p>
<p><img src="/zh-cn/posts/venvminiconda/conda.jpg" alt=""></p>
<p>大致流程参考上图。</p>
<hr>
<h3 id="如何使用conda">如何使用conda？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8conda" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>此处仍然以miniconda为例。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda create -n asdf1234 python<span style="color:#f92672">=</span>3.10
</span></span></code></pre></div><p>这段指令的意义是：</p>
<blockquote>
<p>创建一个名为“asdf1234”的虚拟环境，其中python版本为3.10。</p>
</blockquote>
<p>其中，<code>-n</code>参数含义为&quot;name&quot;，等价于<code>--name</code>。</p>
<p><strong>需要注意的是</strong>，conda的虚拟环境并不像venv那样直接作为当前项目的一个子目录存在，conda的环境被conda视为自己管理的资源，默认集中存放。这意味着在创建这个环境之后，你不会在你的目录下得到任何新的内容。</p>
<p>这样的设计哲学意义在于当不同的环境中请求同样的包时，conda不用将额外的空间资源浪费在重复下载上，而是可以通过内部构建软链接的方式来实现资源复用。</p>
<p>conda允许你通过<code>--prefix ./env</code>参数来实现类似venv的存储行为。这里不过多展开。</p>
<hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda activate asdf1234 <span style="color:#75715e"># 激活名为asdf1234的虚拟环境</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda deactivate <span style="color:#75715e"># 退出当前环境</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda install numpy <span style="color:#75715e"># 安装包</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda env list <span style="color:#75715e"># 列出所有创建的环境，以及现在所处的环境</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda remove -n asdf1234 --all <span style="color:#75715e"># 删除一个环境</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda env export &gt; environment.yml <span style="color:#75715e"># 导出环境</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda env create -f environment.yml <span style="color:#75715e"># 从配置文件复现环境</span>
</span></span></code></pre></div><p>注意：使用conda下载包的时候，conda有一个专属名词：<strong>channel</strong>。某些时候，使用conda下载某些包的时候会提示你要下载的包不在当前channel中。这时候你需要自行寻找对应的channel，然后通过<code>-c</code>参数指定下载渠道。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda install pytorch<span style="color:#f92672">==</span>1.12.0 -c pytorch
</span></span></code></pre></div><blockquote>
<p>在一个conda虚拟环境中，你可以混用pip安装方式和conda安装方式。但是建议只在conda中找不到你想要的包，或者你要的包是纯python写的时再用pip。</p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>工具不图鉴01：curl&amp;wget</title>
			<link>http://localhost:1313/zh-cn/posts/curlwget/</link>
			<pubDate>Mon, 15 Dec 2025 23:25:53 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/curlwget/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>参考链接：</p>
<p><a href="https://curl.se/">curl官网</a></p>
<p><a href="https://www.gnu.org/software/wget/">wget官网</a></p>
<p>curl和wget是在配置服务器时相当常用的终端工具。</p>
<hr>
<h2 id="什么是curl">什么是curl？<a href="#%e4%bb%80%e4%b9%88%e6%98%afcurl" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>curl，全称为Client URL，是一个通用的网络协议客户端工具。功能涵盖请求网页，下载文件，发送http请求，调试接口等。可以说这个工具就是一把网络世界的瑞士军刀。不过对于大多数普通使用者，最常见的用途是用它来下载文件。</p>
<p>在我们的日常生活中，我们不可避免的要和网络打交道。最常见的方式就是通过浏览器来浏览网页和下载文件。浏览器通过图形化界面替你完成了写请求的步骤。所谓请求，就是一种规范化的和服务器对话的方式。你只需要点点屏幕就可以完成一系列与网络服务器的信息交换。</p>
<p>但是对于没有图形化界面的终端来说，所有的信息都是基于文本来传递的，我们当然也没办法通过图形化的浏览器来获取网络资源。curl的功能就在于此。只不过不同于浏览器图形化界面的直白，你必须明确你递交的请求包含了哪些动作。</p>
<p>理解curl，其实只需要理解一句话：</p>
<blockquote>
<p><strong>curl = 在命令行中手动发送http请求</strong></p>
</blockquote>
<p>一条http请求，本质上就是4个东西：</p>
<ol>
<li>请求方法</li>
<li>请求地址（url）</li>
<li>请求头</li>
<li>请求体</li>
</ol>
<p>curl的最基本形式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl URL
</span></span></code></pre></div><p>相当于说：让我看看这个url里有什么东西。</p>
<p>关于curl语法的细则这里不再过多赘述。</p>
<hr>
<h3 id="如何使用curl">如何使用curl？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8curl" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>光知道curl是发送网络协议的工具这点其实对你的使用过程没有太大帮助。事实上，大多数人都不会从http的原理层面来思考和使用curl。</p>
<p>多数人的真实行为是：</p>
<ul>
<li>从网站/博客中复制一个curl指令。</li>
<li>稍加修改或者根本不修改。</li>
<li>用就完了。</li>
</ul>
<p>比如，如果你想下载ohmyzsh，你只需要把官网上的下载指令复制下来运行即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sh -c <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>这本身是一个原理相对复杂的指令，但是你根本不用关系这些事情。开发者已经替你考虑好了一切。</p>
<p>而稍微复杂一点点的情况是，你想要下载一个文件，但是README.md中没有给出下载指令。</p>
<p>我们举一个最简单的例子：</p>
<hr>
<p>比如，你想把一个github上的文件下载到本地。但是呢，没有任何网页告诉你应该输入什么指令来下载这个文件。你可能会想到另外用一个智能设备通过浏览器下载，然后上传到终端对应的机器。这是一个方法，但是不够直接。事实上，我们只需要一个curl指令就可以把文件下载到本地。</p>
<p>比如，你看上了ohmyzsh的README.md。你很想把它下载到本地。你不需要动用浏览器，也不需要git clone整个仓库，你只需要在终端中输入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -O https://github.com/ohmyzsh/ohmyzsh/blob/master/README.md?plain<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>curl就开始帮你下载文件了。当然前提是你的网络环境支持你访问到这个网站，如果网络条件不佳，你可能必须要配置网络代理才能正常使用。</p>
<p>但是，只要你实际尝试过，你就会发现，你下载得到的根本不是你想要的东西。你下载得到的是一大堆html代码，根本不是一个md文件。为什么呢？根本上原因在于你下载的实际是用来显示这个网页的代码，而非你想要的内容。</p>
<p>不过，对于github而言，即使你不能直接curl来获取文件，github为你提供了一个另外的快捷途径，方便你直接使用curl来下载文件。你只需要将url中的<code>github.com</code>替换为<code>raw.githubusercontent.com</code>即可。</p>
<p>然而，在这个网站中并不存有作者名以及plain之类的参数。所以，你还需要删除<code>/blob</code>以及<code>?plain=1</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -O https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/README.md
</span></span></code></pre></div><p>如果你觉得这个方法太麻烦，对于github来说还有另外一种方法可以使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -L -O <span style="color:#e6db74">&#34;https://github.com/ohmyzsh/ohmyzsh/blob/master/README.md?raw=1&#34;</span>
</span></span></code></pre></div><p>因为我选取的这个README.md网页实际比较特殊，后面自带参数。在这个方法中，你只需要在前面添加<code>-L</code>参数，并为url后方添加<code>raw=1</code>参数即可下载。在本例子中，直接将<code>plain=1</code>替换为<code>raw=1</code>即可。</p>
<hr>
<h3 id="如何下载curl">如何下载curl？<a href="#%e5%a6%82%e4%bd%95%e4%b8%8b%e8%bd%bdcurl" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在绝大多数情况下，你的机器实际上已经配备了curl工具，因为这是一个非常基础的工具。</p>
<p>假如你的机器上没有这个工具，通常来说你也不需要经过官网来下载最新版。直接使用系统级包管理器下载即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo apt install curl <span style="color:#75715e"># 以ubuntu为例</span>
</span></span></code></pre></div><hr>
<h2 id="什么是wget">什么是wget?<a href="#%e4%bb%80%e4%b9%88%e6%98%afwget" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<blockquote>
<p>wget = <strong>World Wide Web + get</strong></p>
</blockquote>
<p>字面意思，从万维网上获取东西，就是wget。</p>
<p>不同于curl丰富的功能，这是一个专注于下载内容的工具。它的设计目的很明确：<strong>稳定、自动化、可恢复的下载文件</strong>。</p>
<hr>
<h3 id="如何使用wget">如何使用wget？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8wget" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>wget的使用方法比curl要简单的多。其中一个最简形式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget url
</span></span></code></pre></div><p>不需要任何参数。比如，我们仍然尝试下载ohmyzsh的README.md：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget https://github.com/ohmyzsh/ohmyzsh/blob/master/README.md?plain<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>当然，这仍然是个错误的指令，通过它你只能下载到网页代码。我写这句指令，意在说明wget的简便易用。真正有用的指令如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/README.md
</span></span></code></pre></div><p>你仍然需要得到文件真正存放的url。同时，wget也允许你想下载得到的文件直接用新文件名存入本地，你只需要加一个<code>-O</code>参数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget -O myreadme.md https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/README.md
</span></span></code></pre></div><hr>
<p>此外，对于一些体积较大的下载，下载过程可能相对漫长。假如下载过程中因为网络问题而意外终断，一般的wget下载进度就会归零。在此情况下，你可以使用<code>-c</code>参数来保存下载进度，这样即使中间下载中断，继续输入指令，文件就会在原有进度基础上继续下载，不会丢失进度。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget -c https://example.com/bigfile.iso <span style="color:#75715e"># 这不是一个真实存在的网站，只是方便演示。</span>
</span></span></code></pre></div><hr>
<h3 id="如何下载wget">如何下载wget？<a href="#%e5%a6%82%e4%bd%95%e4%b8%8b%e8%bd%bdwget" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>与curl情况基本类似，多数时候你的机器上已经自带wget了。在少数极简开发环境下可能出现不自带wget的情况。此时，只需要使用包管理器下载即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo apt install wget <span style="color:#75715e"># 以Ubuntu为例</span>
</span></span></code></pre></div>]]></content>
		</item>
		
		<item>
			<title>工具不图鉴02：zsh&amp;ohmyzsh</title>
			<link>http://localhost:1313/zh-cn/posts/zshohmyzsh/</link>
			<pubDate>Mon, 15 Dec 2025 23:25:53 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/zshohmyzsh/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>参考链接：</p>
<p><a href="https://zh.wikipedia.org/wiki/Z_shell">zsh wiki</a></p>
<p><a href="https://ohmyz.sh/">ohmyzsh</a></p>
<h2 id="什么是zsh">什么是zsh？<a href="#%e4%bb%80%e4%b9%88%e6%98%afzsh" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>zsh是一个功能丰富的Unix shell，即<strong>命令行解释器</strong>。就像安装git时附送的git bash和windows系统下自带的powershell一样，你把指令输进去，按下回车，指令就运行起来了。</p>
<p>相较于其他命令行解释器如bash，zsh具有更强大的功能，如自动补全，历史记录，切换主题等。这一切都可以通过添加插件来完成。</p>
<hr>
<h3 id="如何安装zsh">如何安装zsh？<a href="#%e5%a6%82%e4%bd%95%e5%ae%89%e8%a3%85zsh" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>zsh并不是一个更新非常迅速的软件，这意味着你并不一定需要安装最新版才能确保最大程度的稳定和功能。通常来说，直接使用你的系统级包管理器来安装即可，不会导致兼容性问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo apt install zsh
</span></span></code></pre></div><hr>
<h2 id="什么是ohmyzsh">什么是ohmyzsh？<a href="#%e4%bb%80%e4%b9%88%e6%98%afohmyzsh" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>ohmyzsh是一个开源的社区驱动的zsh配置管理框架。通常来说，直接为zsh添加插件并不方便。但是通过ohmyzsh，你只需要克隆一下插件仓库，再修改一下~/.zshrc即可使用插件。</p>
<p>omz拥有非常丰富的插件生态以及活跃的贡献者社区，可以大大提高终端美观程度以及使用效率。</p>
<hr>
<h4 id="如何安装ohmyzsh">如何安装ohmyzsh？<a href="#%e5%a6%82%e4%bd%95%e5%ae%89%e8%a3%85ohmyzsh" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>不同于zsh以及很多其他的基本工具，ohmyzsh是一个迭代迅速的社区工具。这意味着如果想要使用更新更好的插件，最好通过官方渠道进行安装。</p>
<p>这里罗列从<a href="https://ohmyz.sh/#install">omz官网</a>上摘录的下载指令。你只需要将指令输入终端运行即可。</p>
<p>方法一：通过curl安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sh -c <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>方法二：通过wget安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sh -c <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>wget https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>这两个指令是相对稳定的，它们不会随omz版本迭代而发生改变。</p>
<hr>
<h2 id="ohmyzsh如何配置">ohmyzsh如何配置？<a href="#ohmyzsh%e5%a6%82%e4%bd%95%e9%85%8d%e7%bd%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>将zsh设置为默认shell：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chsh -s /bin/zsh
</span></span></code></pre></div><hr>
<h3 id="常用插件">常用插件<a href="#%e5%b8%b8%e7%94%a8%e6%8f%92%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<h4 id="1-zsh-autosuggestions-自动补全建议">1. zsh-autosuggestions (自动补全建议)<a href="#1-zsh-autosuggestions-%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8%e5%bb%ba%e8%ae%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>根据历史记录给出自动补全建议，按下右键自动补全。</p>
<p><a href="https://github.com/zsh-users/zsh-autosuggestions">github网页</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/zsh-users/zsh-autosuggestions <span style="color:#e6db74">${</span>ZSH_CUSTOM<span style="color:#66d9ef">:-</span>~/.oh-my-zsh/custom<span style="color:#e6db74">}</span>/plugins/zsh-autosuggestions
</span></span></code></pre></div><hr>
<h4 id="2-zsh-syntax-highlighting-语法高亮">2. zsh-syntax-highlighting (语法高亮)<a href="#2-zsh-syntax-highlighting-%e8%af%ad%e6%b3%95%e9%ab%98%e4%ba%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>当你输入命令时，正确的命令显示绿色，错误的显示红色，路径带有下划线。</p>
<p><a href="https://github.com/zsh-users/zsh-syntax-highlighting">github网页</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/zsh-users/zsh-syntax-highlighting.git <span style="color:#e6db74">${</span>ZSH_CUSTOM<span style="color:#66d9ef">:-</span>~/.oh-my-zsh/custom<span style="color:#e6db74">}</span>/plugins/zsh-syntax-highlighting
</span></span></code></pre></div><hr>
<h4 id="3-git内置插件">3. git（内置插件）<a href="#3-git%e5%86%85%e7%bd%ae%e6%8f%92%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>提供git简写别名，并支持tab补全。</p>
<ul>
<li>常用别名：
<ul>
<li>gst -&gt; git status</li>
<li>gco -&gt; git checkout</li>
<li>gcm -&gt; git checkout master (或 main)</li>
<li>gp -&gt; git push</li>
<li>gl -&gt; git pull</li>
</ul>
</li>
</ul>
<hr>
<h4 id="4-z内置插件">4. z（内置插件）<a href="#4-z%e5%86%85%e7%bd%ae%e6%8f%92%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>记录你访问过的目录，之后只需输入 <code>z + 目录名片段</code> 即可直接跳转，无需输入完整路径。</p>
<ul>
<li>用法：<code>z down</code> (可能直接跳转到 <code>~/Downloads</code>)</li>
</ul>
<hr>
<h4 id="5-extract内置插件">5. extract（内置插件）<a href="#5-extract%e5%86%85%e7%bd%ae%e6%8f%92%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>通用解压插件。不需要记住 <code>tar -xvf</code>、<code>unzip</code> 等繁琐参数，统一使用 <code>x</code> 命令解压任何格式的压缩包。</p>
<ul>
<li>用法：<code>x filename.tar.gz</code></li>
</ul>
<hr>
<h3 id="启用插件">启用插件<a href="#%e5%90%af%e7%94%a8%e6%8f%92%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>下载完第三方插件后，必须在 <code>.zshrc</code> 文件中配置才能生效。</p>
<p><strong>1. 编辑配置文件：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nano ~/.zshrc
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 或者使用 vim ~/.zshrc</span>
</span></span></code></pre></div><p><strong>2. 找到 <code>plugins=(...)</code> 这一行，修改为：</strong>
(注意：插件名之间用<strong>空格</strong>分隔，不要用逗号)（想使用哪些插件就写入哪些插件）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>plugins<span style="color:#f92672">=(</span>
</span></span><span style="display:flex;"><span>    git
</span></span><span style="display:flex;"><span>    z
</span></span><span style="display:flex;"><span>    extract
</span></span><span style="display:flex;"><span>    sudo
</span></span><span style="display:flex;"><span>    web-search
</span></span><span style="display:flex;"><span>    docker
</span></span><span style="display:flex;"><span>    zsh-autosuggestions       <span style="color:#75715e"># 第三方</span>
</span></span><span style="display:flex;"><span>    zsh-syntax-highlighting   <span style="color:#75715e"># 第三方，建议放在列表最后</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p><strong>3. 使配置生效：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>source ~/.zshrc
</span></span></code></pre></div><hr>
<h3 id="常见美化方案">常见美化方案<a href="#%e5%b8%b8%e8%a7%81%e7%be%8e%e5%8c%96%e6%96%b9%e6%a1%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><a href="https://github.com/ohmyzsh/ohmyzsh/wiki/Themes">可视化主题百科</a></p>
<p>在<code>~/.zshrc</code>中找到<code>ZSH_THEME</code>配置项，将对应位置的主题改为你下载的主题，之后<code>source ~/.zshrc</code>即可启用。</p>
<hr>
<h4 id="1-powerlevel10k">1. Powerlevel10k<a href="#1-powerlevel10k" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>目前相当流行的主题，配置方便，高度可自定义。</p>
<p><a href="https://github.com/romkatv/powerlevel10k">github网页</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone --depth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> https://github.com/romkatv/powerlevel10k.git <span style="color:#e6db74">${</span>ZSH_CUSTOM<span style="color:#66d9ef">:-</span>$HOME/.oh-my-zsh/custom<span style="color:#e6db74">}</span>/themes/powerlevel10k
</span></span></code></pre></div><p>主题名：<code>powerlevel10k/powerlevel10k</code></p>
<hr>
<h4 id="2-ys">2. ys<a href="#2-ys" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>我个人比较喜欢的主题，非常简洁美观，并且是omz的内置主题。直接将主题名改为ys即可。</p>
<hr>
<h1 id="集成式配置脚本">集成式配置脚本<a href="#%e9%9b%86%e6%88%90%e5%bc%8f%e9%85%8d%e7%bd%ae%e8%84%9a%e6%9c%ac" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>一键配置zsh&amp;omz全套环境。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ============================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  Zsh + OMZ + Plugins + P10k 一键安装脚本 (含 Termux 支持)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ============================================================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义颜色</span>
</span></span><span style="display:flex;"><span>RED<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[0;31m&#39;</span>
</span></span><span style="display:flex;"><span>GREEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[0;32m&#39;</span>
</span></span><span style="display:flex;"><span>YELLOW<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[0;33m&#39;</span>
</span></span><span style="display:flex;"><span>BLUE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[0;34m&#39;</span>
</span></span><span style="display:flex;"><span>NC<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[0m&#39;</span> <span style="color:#75715e"># No Color</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义路径</span>
</span></span><span style="display:flex;"><span>OMZ_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$HOME<span style="color:#e6db74">/.oh-my-zsh&#34;</span>
</span></span><span style="display:flex;"><span>ZSH_CUSTOM<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$OMZ_DIR<span style="color:#e6db74">/custom&#34;</span>
</span></span><span style="display:flex;"><span>ZSHRC<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$HOME<span style="color:#e6db74">/.zshrc&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BLUE<span style="color:#e6db74">}</span><span style="color:#e6db74">&gt;&gt;&gt; 开始执行集成安装脚本...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 环境检测与软件安装</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>install_packages<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在检查系统环境...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    CMD_UPDATE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检测是否为 Termux</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span>$TERMUX_VERSION<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">识别到 Termux 环境。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;pkg install -y&#34;</span>
</span></span><span style="display:flex;"><span>        CMD_UPDATE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;pkg update -y&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Termux 通常不需要 sudo，除非安装了 tsu，但常规包管理直接用 pkg</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检测 MacOS</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$OSTYPE<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;darwin&#34;</span>* <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">识别到 MacOS 环境。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> command -v brew &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;brew install&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RED<span style="color:#e6db74">}</span><span style="color:#e6db74">未找到 Homebrew，请先安装 Homebrew。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检测 Linux 发行版</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> command -v apt-get &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sudo apt-get install -y&#34;</span>
</span></span><span style="display:flex;"><span>        CMD_UPDATE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sudo apt-get update&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> command -v yum &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sudo yum install -y&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> command -v dnf &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sudo dnf install -y&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> command -v pacman &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sudo pacman -S --noconfirm&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RED<span style="color:#e6db74">}</span><span style="color:#e6db74">未找到支持的包管理器 (pkg/apt/yum/dnf/pacman/brew)。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 更新源 (仅 Termux 和 Debian/Ubuntu)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -z <span style="color:#e6db74">&#34;</span>$CMD_UPDATE<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;正在更新软件源...&#34;</span>
</span></span><span style="display:flex;"><span>        $CMD_UPDATE
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 安装 git, zsh, curl, vim (vim用于防止sed有时需要编辑器环境)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Termux 基础包可能不含 vim/nano，建议安装一个编辑器</span>
</span></span><span style="display:flex;"><span>    DEPENDENCIES<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;git zsh curl&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> pkg in $DEPENDENCIES; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ! command -v $pkg &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在安装 </span>$pkg<span style="color:#e6db74"> ...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            $CMD_INSTALL $pkg
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span>$pkg<span style="color:#e6db74"> 已安装。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>install_packages
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 安装 Oh My Zsh</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -d <span style="color:#e6db74">&#34;</span>$OMZ_DIR<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">Oh My Zsh 已安装，跳过下载。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在安装 Oh My Zsh...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 使用官方脚本</span>
</span></span><span style="display:flex;"><span>    sh -c <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;&#34;</span> --unattended
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -d <span style="color:#e6db74">&#34;</span>$OMZ_DIR<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RED<span style="color:#e6db74">}</span><span style="color:#e6db74">Oh My Zsh 安装失败，请检查网络 (Termux可能需要开启VPN)。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 下载插件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>install_plugin<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    local name<span style="color:#f92672">=</span>$1
</span></span><span style="display:flex;"><span>    local repo<span style="color:#f92672">=</span>$2
</span></span><span style="display:flex;"><span>    local target_dir<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$ZSH_CUSTOM<span style="color:#e6db74">/plugins/</span>$name<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -d <span style="color:#e6db74">&#34;</span>$target_dir<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在下载插件: </span>$name<span style="color:#e6db74"> ...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        git clone --depth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> $repo $target_dir
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">插件 </span>$name<span style="color:#e6db74"> 已存在。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>install_plugin <span style="color:#e6db74">&#34;zsh-autosuggestions&#34;</span> <span style="color:#e6db74">&#34;https://github.com/zsh-users/zsh-autosuggestions&#34;</span>
</span></span><span style="display:flex;"><span>install_plugin <span style="color:#e6db74">&#34;zsh-syntax-highlighting&#34;</span> <span style="color:#e6db74">&#34;https://github.com/zsh-users/zsh-syntax-highlighting.git&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. 下载 Powerlevel10k 主题</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>THEME_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$ZSH_CUSTOM<span style="color:#e6db74">/themes/powerlevel10k&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -d <span style="color:#e6db74">&#34;</span>$THEME_DIR<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在下载主题: Powerlevel10k ...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    git clone --depth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> https://github.com/romkatv/powerlevel10k.git $THEME_DIR
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">主题 Powerlevel10k 已存在。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. 配置 .zshrc</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在配置 .zshrc ...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 备份</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -f <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    cp <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ZSHRC<span style="color:#e6db74">}</span><span style="color:#e6db74">.backup.</span><span style="color:#66d9ef">$(</span>date +%Y%m%d%H%M%S<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 覆盖模板</span>
</span></span><span style="display:flex;"><span>cp <span style="color:#e6db74">&#34;</span>$OMZ_DIR<span style="color:#e6db74">/templates/zshrc.zsh-template&#34;</span> <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置 sed 命令 (MacOS 需要 -i &#39;&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$OSTYPE<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;darwin&#34;</span>* <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    SED_CMD<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sed -i &#39;&#39;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    SED_CMD<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sed -i&#34;</span> <span style="color:#75715e"># Linux &amp; Termux</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改主题</span>
</span></span><span style="display:flex;"><span>$SED_CMD <span style="color:#e6db74">&#39;s/^ZSH_THEME=&#34;.*&#34;/ZSH_THEME=&#34;powerlevel10k\/powerlevel10k&#34;/&#39;</span> <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改插件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 注意：Termux 环境下 docker 插件通常无效，但保留也不会报错</span>
</span></span><span style="display:flex;"><span>NEW_PLUGINS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;plugins=(git z extract web-search zsh-autosuggestions zsh-syntax-highlighting)&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果不是 MacOS 且不是 Termux (即普通 Linux 服务器)，加上 sudo 插件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Termux 默认没 sudo，加上会报错；MacOS 也不常用 sudo 插件</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -z <span style="color:#e6db74">&#34;</span>$TERMUX_VERSION<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$OSTYPE<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;darwin&#34;</span>* <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>     NEW_PLUGINS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;plugins=(git z extract sudo web-search docker zsh-autosuggestions zsh-syntax-highlighting)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$SED_CMD <span style="color:#e6db74">&#34;s/^plugins=(git)/</span>$NEW_PLUGINS<span style="color:#e6db74">/&#34;</span> <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 兜底检查</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ! grep -q <span style="color:#e6db74">&#34;zsh-autosuggestions&#34;</span> <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;\n</span>$NEW_PLUGINS<span style="color:#e6db74">&#34;</span> &gt;&gt; <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">.zshrc 配置完成！</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6. 设置默认 Shell</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>CURRENT_SHELL<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>basename <span style="color:#e6db74">&#34;</span>$SHELL<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$CURRENT_SHELL<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;zsh&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在设置 zsh 为默认 Shell...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> command -v chsh &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        chsh -s <span style="color:#66d9ef">$(</span>which zsh<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RED<span style="color:#e6db74">}</span><span style="color:#e6db74">无法自动修改默认 Shell，请手动执行: chsh -s zsh</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">当前 Shell 已经是 Zsh。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 7. 结束</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;\n</span><span style="color:#e6db74">${</span>BLUE<span style="color:#e6db74">}</span><span style="color:#e6db74">==============================================</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">  Termux / Linux / Mac 环境安装完成！</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BLUE<span style="color:#e6db74">}</span><span style="color:#e6db74">==============================================</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;请执行: </span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">exec zsh</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74"> 或重启 Termux 以生效。&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;Powerlevel10k 配置向导将在首次进入 zsh 时启动。&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;\n💡 Termux 提示: 如果图标显示乱码，请长按 Termux 界面 -&gt; More -&gt; Style -&gt; Font&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;   并选择一款 Nerd Font (推荐 MesloLGS NF)。&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;==============================================\n&#34;</span>
</span></span></code></pre></div><p>这个脚本是ai写的。不过这不重要，好用就行。</p>
<p>理论上这段脚本具有一定的健壮性，对于多数的linux发行版、macos，乃至termux，这段脚本按理都可以正常工作，不过我没测试过。</p>
<hr>
<h3 id="如何使用">如何使用?<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<ol>
<li>将这个脚本写入<code>xx.sh</code>中。xx可以是任意名字，比如<code>install_zsh.sh</code>。</li>
<li><code>chmod +x xx.sh</code>，输入这个指令为脚本赋权。</li>
<li>在当前目录下运行这个.sh文件，即输入<code>./xx.sh</code>。脚本就开始工作了。</li>
</ol>
]]></content>
		</item>
		
		<item>
			<title>Triton自学日志 02FusedSoftmax</title>
			<link>http://localhost:1313/zh-cn/posts/triton%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%97-02softmax/</link>
			<pubDate>Wed, 10 Dec 2025 08:33:43 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/triton%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%97-02softmax/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h1 id="融合-softmax-fused-softmax">融合 Softmax （Fused Softmax）<a href="#%e8%9e%8d%e5%90%88-softmax-fused-softmax" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>在本节中，我们将使用 Triton 编写一个融合的 softmax 操作的程序。
在此过程中，你会学习到：</p>
<ul>
<li>内核融合对于带宽受限操作的优势。</li>
<li>Triton 中缩减操作。</li>
</ul>
<h2 id="使用原生-pytorch-对-x-逐行进行-softmax-计算">使用原生 PyTorch 对 X 逐行进行 Softmax 计算<a href="#%e4%bd%bf%e7%94%a8%e5%8e%9f%e7%94%9f-pytorch-%e5%af%b9-x-%e9%80%90%e8%a1%8c%e8%bf%9b%e8%a1%8c-softmax-%e8%ae%a1%e7%ae%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch_npu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton.language <span style="color:#66d9ef">as</span> tl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">naive_softmax</span>(x):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    我们减去最大元素以避免溢出。Softmax 对于这种偏移是不变的。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 读取 MN 个元素；写入 M 个元素</span>
</span></span><span style="display:flex;"><span>    x_max <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>max(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 读取 MN + M 个元素；写入 MN 个元素</span>
</span></span><span style="display:flex;"><span>    z <span style="color:#f92672">=</span> x <span style="color:#f92672">-</span> x_max[:, <span style="color:#66d9ef">None</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 读取 MN 个元素；写入 MN 个元素</span>
</span></span><span style="display:flex;"><span>    numerator <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>exp(z)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 读取 MN 个元素；写入 M 个元素</span>
</span></span><span style="display:flex;"><span>    denominator <span style="color:#f92672">=</span> numerator<span style="color:#f92672">.</span>sum(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 读取 MN + M 个元素；写入 MN 个元素</span>
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> numerator <span style="color:#f92672">/</span> denominator[:, <span style="color:#66d9ef">None</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 总计：读取 5MN + 2M 个元素；写入 3MN + 2M 个元素</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ret
</span></span></code></pre></div><h3 id="什么是softmax">什么是&quot;Softmax&quot;？<a href="#%e4%bb%80%e4%b9%88%e6%98%afsoftmax" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在大模型开发中，softmax是一个非常重要的算法。它的作用是把绝对的分数转化为相对概率。</p>
<p>举个简单的例子，假如某段对话中，大模型对下一个应该吐出的字，心里经过计算得到应该为<code>猫</code>、<code>狗</code>、<code>猪</code>，分数分别为10分，5分，20分。大模型需要在这三个字之间摇骰子选出一个。这时候我们就需要将分数转化为对应的概率。</p>
<p>将分数转化为概率的方法可以有很多种，在这里我们所采用的方式是：以每个元素分数的指数为权重决定最后概率。我们先求得每个元素的e指数，之后对e指数求和，然后计算每个元素e指数与总和的比值，最后得到概率。通过e指数，我们可以拉大差距，让最高分者有更大的可能成为答案，同时保留其他元素出现的可能。x-x_max的作用是防止e指数算出来结果过大导致溢出。根据数学推导，可以得知这里采用x和x-x_max计算得到的概率是相同的。</p>
<hr>
<h3 id="内核融合的目的">内核融合的目的<a href="#%e5%86%85%e6%a0%b8%e8%9e%8d%e5%90%88%e7%9a%84%e7%9b%ae%e7%9a%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>当在 PyTorch 中以原生方式实现时，计算<code>y=naive_softmax(x)</code>需要从 DRAM 中读取 5MN+2M 个元素，并写回 3MN+2M 个元素。显然这是非常低效的；我们更希望使用一个自定义的“融合”内核，它只需读取一次 X，并在芯片上完成所有必要的计算。
这样一来只需读取和写回 2MN 个字节，因此我们可以期望理论上的加速比大约为 4 倍（即 (8MN+4M)/2MN）。</p>
<p><code>torch.jit.script</code>旨在自动执行这种“内核融合”，但它仍然远未达到理想状态。</p>
<h4 id="dram">DRAM<a href="#dram" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>显存。在triton算子开发的语境下，内存有着严密的<strong>层级</strong>关系。不同层级的内存有着不同的功能。其中DRAM即显存的地位类似总仓库，通常有几十个G，但是庞大的存储空间对应的代价是极慢的读写速度。torch原生语句出于通用性考虑，每次读写都以DRAM为对象，但是在一些复杂的操作中就会使得出现过多理论上不必要的读写操作。triton算子提高性能的本质也就是将对DRAM的读写操作压缩到最少。</p>
<p>除了DRAM，triton算子开发中还有一个相当重要的概念就是SRAM，即共享内存。这就是triton语句中默认的读写位置。triton编译器会帮你自动管理这个层级的内存，而这个层级的特点就是虽然空间很小，但是读写速度很快。</p>
<p>在我们的triton算子开发过程中，我们通过<code>tl.load</code>来从DRAM中拉取数据，并通过<code>tl.store</code>来将数据写入DRAM。其余的变量操作本质都是在SRAM和寄存器中操作。</p>
<hr>
<h2 id="计算内核">计算内核<a href="#%e8%ae%a1%e7%ae%97%e5%86%85%e6%a0%b8" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>softmax 内核工作原理如下：每个计算单元（program）以程序数量为跨度加载输入矩阵X的一组行数据，执行归一化处理后，将结果写入输出矩阵Y。
注意：Triton 的一个重要限制是每个块必须具有 2 的幂次数的元素，因此，如果我们要处理任意可能的输入形状，需要在内部「填充」每一行，并适当保护内存操作。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#a6e22e">@triton.jit</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">softmax_kernel</span>(output_ptr, input_ptr, input_row_stride, output_row_stride, n_rows, n_cols, BLOCK_SIZE: tl<span style="color:#f92672">.</span>constexpr):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 程序起始行</span>
</span></span><span style="display:flex;"><span>    row_start <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>program_id(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    row_step <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>num_programs(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> row_idx <span style="color:#f92672">in</span> tl<span style="color:#f92672">.</span>range(row_start, n_rows, row_step):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 步长表示我们需要对指针增加多少以推进 1 行</span>
</span></span><span style="display:flex;"><span>        row_start_ptr <span style="color:#f92672">=</span> input_ptr <span style="color:#f92672">+</span> row_idx <span style="color:#f92672">*</span> input_row_stride
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 块大小是大于 n_cols 的下一个二的幂，因此我们可以适配</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 单个块中的行</span>
</span></span><span style="display:flex;"><span>        col_offsets <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>, BLOCK_SIZE)
</span></span><span style="display:flex;"><span>        input_ptrs <span style="color:#f92672">=</span> row_start_ptr <span style="color:#f92672">+</span> col_offsets
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 将行加载到 SRAM 中，使用掩码，因为 BLOCK_SIZE 可能大于 n_cols</span>
</span></span><span style="display:flex;"><span>        mask <span style="color:#f92672">=</span> col_offsets <span style="color:#f92672">&lt;</span> n_cols
</span></span><span style="display:flex;"><span>        row <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(input_ptrs, mask<span style="color:#f92672">=</span>mask, other<span style="color:#f92672">=-</span>float(<span style="color:#e6db74">&#39;inf&#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 为了数值稳定性而减去最大值</span>
</span></span><span style="display:flex;"><span>        row_minus_max <span style="color:#f92672">=</span> row <span style="color:#f92672">-</span> tl<span style="color:#f92672">.</span>max(row, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 请注意，Triton 中的指数运算速度很快，但是是近似的。</span>
</span></span><span style="display:flex;"><span>        numerator <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>exp(row_minus_max)
</span></span><span style="display:flex;"><span>        denominator <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>sum(numerator, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        softmax_output <span style="color:#f92672">=</span> numerator <span style="color:#f92672">/</span> denominator
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 将输出写回 DRAM</span>
</span></span><span style="display:flex;"><span>        output_row_start_ptr <span style="color:#f92672">=</span> output_ptr <span style="color:#f92672">+</span> row_idx <span style="color:#f92672">*</span> output_row_stride
</span></span><span style="display:flex;"><span>        output_ptrs <span style="color:#f92672">=</span> output_row_start_ptr <span style="color:#f92672">+</span> col_offsets
</span></span><span style="display:flex;"><span>        tl<span style="color:#f92672">.</span>store(output_ptrs, softmax_output, mask<span style="color:#f92672">=</span>mask)
</span></span></code></pre></div><h3 id="这段代码做了什么事情">这段代码做了什么事情？<a href="#%e8%bf%99%e6%ae%b5%e4%bb%a3%e7%a0%81%e5%81%9a%e4%ba%86%e4%bb%80%e4%b9%88%e4%ba%8b%e6%83%85" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>我们在前文中谈到了融合算子提高性能的手段是只读取一次DRAM的数据，中间的计算过程全部放在SRAM中进行。但是对于怎么实现的我们尚不得而知。这段代码就是“教科书级别”的Triton Fused Softmax实现方式。</p>
<p>我们来分块解读这段代码：</p>
<hr>
<h4 id="分配任务">分配任务<a href="#%e5%88%86%e9%85%8d%e4%bb%bb%e5%8a%a1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>row_start <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>program_id(<span style="color:#ae81ff">0</span>)      <span style="color:#75715e"># 我是第几号工人（PID）</span>
</span></span><span style="display:flex;"><span>row_step <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>num_programs(<span style="color:#ae81ff">0</span>)     <span style="color:#75715e"># 总共有多少个工人（Grid Size）</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> row_idx <span style="color:#f92672">in</span> tl<span style="color:#f92672">.</span>range(row_start, n_rows, row_step):
</span></span></code></pre></div><p><code>tl.program_id(0)</code>表示的就是当前核心被分配到的目标程序id，<code>tl.num_programs(0)</code>则是总共的程序数。让行步长设置为程序数，目的就是让遍历所有行的时候不同程序进程不会相互冲突。随后使用for循环遍历所有的从<code>row_start</code>到<code>n_rows</code>之间步长为<code>row_step</code>的行。</p>
<p>比如，假如有1000行数据，但是总共只有n个工人，第i个工人就应该去处理第<code>n * k + i</code>个数据，这样不同工人之间处理的数据才不会相互重叠。</p>
<hr>
<h4 id="获取数据">获取数据<a href="#%e8%8e%b7%e5%8f%96%e6%95%b0%e6%8d%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 算出这一行在内存里的起始地址</span>
</span></span><span style="display:flex;"><span>row_start_ptr <span style="color:#f92672">=</span> input_ptr <span style="color:#f92672">+</span> row_idx <span style="color:#f92672">*</span> input_row_stride
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 制造一个 [0, 1, ..., BLOCK_SIZE-1] 的索引条</span>
</span></span><span style="display:flex;"><span>col_offsets <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>, BLOCK_SIZE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 算出这一行每个元素具体的内存地址</span>
</span></span><span style="display:flex;"><span>input_ptrs <span style="color:#f92672">=</span> row_start_ptr <span style="color:#f92672">+</span> col_offsets
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 制作掩码：只保留真实数据长度以内的部分</span>
</span></span><span style="display:flex;"><span>mask <span style="color:#f92672">=</span> col_offsets <span style="color:#f92672">&lt;</span> n_cols
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 【关键动作】从 HBM 加载到 SRAM</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># other=-inf 是为了防止填充部分的 0 干扰求 Max（如果是 0 可能会变成最大值）</span>
</span></span><span style="display:flex;"><span>row <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(input_ptrs, mask<span style="color:#f92672">=</span>mask, other<span style="color:#f92672">=-</span>float(<span style="color:#e6db74">&#39;inf&#39;</span>))
</span></span></code></pre></div><p>前面三行代码的作用就是直接生成一个可以覆盖整个行的内存地址向量。虽然我们感觉要处理的数据似乎是呈二维排布的，但是在内存中的真实情况是所有信息都是线性排布的。因此，我们可以直接将每一行的起始地址加上偏移量向量得到这一行每个元素的地址组成的向量。</p>
<p>在这行代码中，<code>input_row_stride</code>本质上就代表了你一行元素的个数。</p>
<p>但是这时，有一个很关键的问题就是，BLOCK_SIZE的大小只能是2的整数次幂。为了能让核心一个任务就能处理一行数据，并且过程中不存在内存越界的情况，我们引入“掩码”的概念。将<code>mask</code>赋值为一个布尔向量，对应位置在我们目标范围内的元素为true，反之为false。这样，根据mask再调用tl.load函数我们就可以得到这一整行的数据。</p>
<hr>
<h3 id="计算数据">计算数据<a href="#%e8%ae%a1%e7%ae%97%e6%95%b0%e6%8d%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 1. 找最大值 (只读 SRAM)</span>
</span></span><span style="display:flex;"><span>row_minus_max <span style="color:#f92672">=</span> row <span style="color:#f92672">-</span> tl<span style="color:#f92672">.</span>max(row, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 算指数 (只读 SRAM)</span>
</span></span><span style="display:flex;"><span>numerator <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>exp(row_minus_max)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 求和 (只读 SRAM)</span>
</span></span><span style="display:flex;"><span>denominator <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>sum(numerator, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. 算除法 (只读 SRAM)</span>
</span></span><span style="display:flex;"><span>softmax_output <span style="color:#f92672">=</span> numerator <span style="color:#f92672">/</span> denominator
</span></span></code></pre></div><p>这里大量使用了数据科学库常见的广播机制，最后实现的效果和pytorch中的原生代码效果一致，只不过计算过程发生在SRAM当中。</p>
<hr>
<h3 id="写入数据">写入数据<a href="#%e5%86%99%e5%85%a5%e6%95%b0%e6%8d%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 算出输出的内存地址</span>
</span></span><span style="display:flex;"><span>output_row_start_ptr <span style="color:#f92672">=</span> output_ptr <span style="color:#f92672">+</span> row_idx <span style="color:#f92672">*</span> output_row_stride
</span></span><span style="display:flex;"><span>output_ptrs <span style="color:#f92672">=</span> output_row_start_ptr <span style="color:#f92672">+</span> col_offsets
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 【关键动作】从 SRAM 写回 HBM</span>
</span></span><span style="display:flex;"><span>tl<span style="color:#f92672">.</span>store(output_ptrs, softmax_output, mask<span style="color:#f92672">=</span>mask)
</span></span></code></pre></div><p>直到最后一步再把数据写入DRAM当中。完成整个kernel运算。</p>
<hr>
<h1 id="辅助函数">辅助函数<a href="#%e8%be%85%e5%8a%a9%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>我们可以创建一个辅助函数，该函数能够将核函数及其元参数加入执行队列，以处理任意给定的输入张量。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>target <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>runtime<span style="color:#f92672">.</span>driver<span style="color:#f92672">.</span>active<span style="color:#f92672">.</span>get_current_target()
</span></span><span style="display:flex;"><span>kernels <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">softmax</span>(x, stream):
</span></span><span style="display:flex;"><span>    n_rows, n_cols <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>shape
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 每次循环迭代的块大小是大于或等于`x`列数的最小二的幂</span>
</span></span><span style="display:flex;"><span>    BLOCK_SIZE <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>next_power_of_2(n_cols)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 分配输出空间</span>
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>empty_like(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 预编译内核以获取寄存器使用情况并计算线程占用情况。</span>
</span></span><span style="display:flex;"><span>    kernel, num_programs <span style="color:#f92672">=</span> kernels<span style="color:#f92672">.</span>get(BLOCK_SIZE, (<span style="color:#66d9ef">None</span>, <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> kernel <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        num_programs <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>        kernel <span style="color:#f92672">=</span> softmax_kernel
</span></span><span style="display:flex;"><span>        kernels[BLOCK_SIZE] <span style="color:#f92672">=</span> (kernel, num_programs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    num_programs <span style="color:#f92672">=</span> min(num_programs, n_rows)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    kernel[(num_programs, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)](
</span></span><span style="display:flex;"><span>        y,
</span></span><span style="display:flex;"><span>        x,
</span></span><span style="display:flex;"><span>        x<span style="color:#f92672">.</span>stride(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        y<span style="color:#f92672">.</span>stride(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        n_rows,
</span></span><span style="display:flex;"><span>        n_cols,
</span></span><span style="display:flex;"><span>        BLOCK_SIZE
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y
</span></span></code></pre></div><p>这段代码有几个相对不太容易理解的机制。下面我来一一解答。</p>
<h3 id="q1函数外的targetkernels的作用是什么">Q1：函数外的target、kernels的作用是什么？<a href="#q1%e5%87%bd%e6%95%b0%e5%a4%96%e7%9a%84targetkernels%e7%9a%84%e4%bd%9c%e7%94%a8%e6%98%af%e4%bb%80%e4%b9%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>kernels = {}</code>注意这种写法在python中代表着创建一个字典。它不是什么triton中特有的语法。在本代码中，kernels字典的key为BLOCK_SIZE，即任务块的大小，而值则为一个存储了kernel函数和启动程序数的元组，代表一种启动程序的方式。</p>
<p>每次我们运行带有<code>@triton.jit</code>装饰的函数时，triton都需要依据输入的参数做一系列初始化的工作。多数时候，softmax函数是一个相对常用的函数，假如每次调用这个函数都必须要重新初始化就会导致不必要的性能浪费。所以我们通过memo字典的方式存储记录的方式实现性能优化。</p>
<p><code>target</code>的意义是获取当前设备的硬件信息。在本代码片段中没有被用到。</p>
<hr>
<h3 id="q2kernelget是做什么的">Q2：kernel.get是做什么的？<a href="#q2kernelget%e6%98%af%e5%81%9a%e4%bb%80%e4%b9%88%e7%9a%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>查表。在之前的softmax使用过程中，我们很可能已经处理了相同的BLOCK_SIZE场景。这里因为返回的是元组，所以直接赋值两个变量自动解包。如果存储的kernels中没有所需的记录，后面我们就会为之创建一套解决方案。</p>
<hr>
<h3 id="q3看起来kernel只可能为softmax_kernel这样的话为什么还要多存储一个kernel在memo中呢">Q3：看起来kernel只可能为softmax_kernel，这样的话为什么还要多存储一个kernel在memo中呢？<a href="#q3%e7%9c%8b%e8%b5%b7%e6%9d%a5kernel%e5%8f%aa%e5%8f%af%e8%83%bd%e4%b8%basoftmax_kernel%e8%bf%99%e6%a0%b7%e7%9a%84%e8%af%9d%e4%b8%ba%e4%bb%80%e4%b9%88%e8%bf%98%e8%a6%81%e5%a4%9a%e5%ad%98%e5%82%a8%e4%b8%80%e4%b8%aakernel%e5%9c%a8memo%e4%b8%ad%e5%91%a2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>因为softmax_kernel之间也有区别。区别就在于，假如我们为softmax_kernel添加一个<code>@triton_autotune（）</code>装饰器，我们调用的kernel函数就会依据情况不同而发生变化，而转化为针对对应参数时的最优BLOCK_SIZE配置版kernel。</p>
<p>通过memo字典，我们直接捕捉这些发生变化的kernel函数，使得遇到相同BLOCK_SIZE时我们无需再次把性能用在自动调优上，进一步实现优化。</p>
<hr>
<h3 id="q4kernel是什么写法">Q4：kernel[&hellip;](&hellip;)是什么写法？<a href="#q4kernel%e6%98%af%e4%bb%80%e4%b9%88%e5%86%99%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>这是一个非常神奇的写法。</p>
<p>在kernel[&hellip;]的方括号当中写入的是一个元组，其中包含至多三个元素。写成方括号的形式看起来像是在查字典，但是实际上做的事情也确实类似。<code>launcher = kernel[(100,1,1)]</code>最后会得到一个配置好的启动器对象。kernel对象的__getitem__方法在triton中被覆写了，让你可以通过这种方式得到一个自定义形状的启动模式。在这里，我们得到了一个一维的由100个程序或进程组成的启动方法。如果你想只写入一个参数，记得python中的一元元组要求必须在元素后加一个逗号，即<code>(x,)</code>。</p>
<p>还记得<code>pid = tl.program_id(0)</code>吗？这里之所以需要一个参数0，本质上就是因为程序进程的排布方式是三维的。输入0就意味着返回当前程序的第一维坐标。由于我们使用的启动方式就是一维的，只读取第一维坐标就足够区分不同的程序进程了。</p>
<p>之所以程序启动会是一个立体的三维概念，根本上并不是因为显卡中核心是这么排布的，而是方便人类去适配不同的数据结构。比如如果你要处理图像，你可能针对每一个像素点都要开一个程序，这时使用二维方式启动程序并用横纵坐标来标记程序就可以为写代码带来方便。同时，这也会间接带来性能上的优化。</p>
<p>在01_vector_add中，我们在这个方括号中传入了一个lambda函数。这个lambda函数传入的参数就是kernel函数的参数字典。我们可以通过那种方式来动态决定启动程序数，但是在这里，我们本质上使用了memo记忆化搜索的方式来进一步优化性能，使得相同的情景我们无需再将性能用在动态决定启动程序数上。</p>
<hr>
<h2 id="单元测试">单元测试<a href="#%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>需要在一个具有不规则行和列数的矩阵上测试处理好的内核，此举可以验证Padding机制是否起作用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>device <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>npu<span style="color:#f92672">.</span>current_device()
</span></span><span style="display:flex;"><span>stream <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>npu<span style="color:#f92672">.</span>current_stream(device)<span style="color:#f92672">.</span>npu_stream
</span></span><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>randn(<span style="color:#ae81ff">1823</span>, <span style="color:#ae81ff">781</span>, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu&#39;</span>)
</span></span><span style="display:flex;"><span>y_triton <span style="color:#f92672">=</span> softmax(x, stream)
</span></span><span style="display:flex;"><span>y_torch <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>softmax(x, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> torch<span style="color:#f92672">.</span>allclose(y_triton, y_torch), (y_triton, y_torch)
</span></span><span style="display:flex;"><span>print(y_triton)
</span></span><span style="display:flex;"><span>print(y_torch)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;The maximum difference between torch and triton is &#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>torch<span style="color:#f92672">.</span>max(torch<span style="color:#f92672">.</span>abs(y_triton<span style="color:#f92672">-</span>y_torch))<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p>我们上文中编写的帮助函数实际作用是对目标的二维张量的每一行进行softmax计算。在这个例子中，我们生成了一个由随机数构成的张量x，随后分别使用torch原生方法和triton融合算子来对它进行softmax计算，最后测量两结果之间的最大差异。</p>
<p>理论上来说，我们的triton算子和torch原生算子的数学过程是等价的。之所以会出现微小误差实际上是过程中的计算步骤的底层实现方法导致了一些浮点数精度误差。</p>
<p>Out:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tensor<span style="color:#f92672">([[</span>0.0002, 0.0017, 0.0009,  ..., 0.0009, 0.0013, 0.0073<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0001, 0.0004, 0.0006,  ..., 0.0006, 0.0004, 0.0003<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0007, 0.0002, 0.0006,  ..., 0.0011, 0.0004, 0.0039<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        ...,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0021, 0.0002, 0.0015,  ..., 0.0012, 0.0014, 0.0022<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0003, 0.0002, 0.0007,  ..., 0.0005, 0.0006, 0.0007<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0034, 0.0014, 0.0005,  ..., 0.0007, 0.0016, 0.0028<span style="color:#f92672">]]</span>,
</span></span><span style="display:flex;"><span>       device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu:0&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>tensor<span style="color:#f92672">([[</span>0.0002, 0.0017, 0.0009,  ..., 0.0009, 0.0013, 0.0073<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0001, 0.0004, 0.0006,  ..., 0.0006, 0.0004, 0.0003<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0007, 0.0002, 0.0006,  ..., 0.0011, 0.0004, 0.0039<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        ...,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0021, 0.0002, 0.0015,  ..., 0.0012, 0.0014, 0.0022<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0003, 0.0002, 0.0007,  ..., 0.0005, 0.0006, 0.0007<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0034, 0.0014, 0.0005,  ..., 0.0007, 0.0016, 0.0028<span style="color:#f92672">]]</span>,
</span></span><span style="display:flex;"><span>       device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu:0&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>The maximum difference between torch and triton is 1.4901161193847656e-08
</span></span></code></pre></div><p>&ldquo;The maximum difference between torch and triton is 1.4901161193847656e-08&rdquo; 表示Triton和PyTorch的输出结果非常接近，肉眼不可区分。</p>
<hr>
<h1 id="测试性能">测试性能<a href="#%e6%b5%8b%e8%af%95%e6%80%a7%e8%83%bd" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>为了对比triton融合算子和torch原生方法的性能，我们再次采用benchmark方法来测量不同数据量下两种算法的带宽吞吐量。顺便的，我们还可以看看torch原生的softmax方法的性能如何。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Fused Softmax
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">=============
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch_npu
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton.language <span style="color:#66d9ef">as</span> tl
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> triton.runtime <span style="color:#f92672">import</span> driver
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">naive_softmax</span>(x):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Compute row-wise softmax of X using native pytorch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    We subtract the maximum element in order to avoid overflows. Softmax is invariant to
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    this shift.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># read  MN elements ; write M  elements</span>
</span></span><span style="display:flex;"><span>    x_max <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>max(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># read MN + M elements ; write MN elements</span>
</span></span><span style="display:flex;"><span>    z <span style="color:#f92672">=</span> x <span style="color:#f92672">-</span> x_max[:, <span style="color:#66d9ef">None</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># read  MN elements ; write MN elements</span>
</span></span><span style="display:flex;"><span>    numerator <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>exp(z)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># read  MN elements ; write M  elements</span>
</span></span><span style="display:flex;"><span>    denominator <span style="color:#f92672">=</span> numerator<span style="color:#f92672">.</span>sum(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># read MN + M elements ; write MN elements</span>
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> numerator <span style="color:#f92672">/</span> denominator[:, <span style="color:#66d9ef">None</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># in total: read 5MN + 2M elements ; wrote 3MN + 2M elements</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@triton.jit</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">softmax_kernel</span>(
</span></span><span style="display:flex;"><span>    output_ptr,
</span></span><span style="display:flex;"><span>    input_ptr,
</span></span><span style="display:flex;"><span>    input_row_stride,
</span></span><span style="display:flex;"><span>    output_row_stride,
</span></span><span style="display:flex;"><span>    n_rows,
</span></span><span style="display:flex;"><span>    n_cols,
</span></span><span style="display:flex;"><span>    BLOCK_SIZE: tl<span style="color:#f92672">.</span>constexpr,
</span></span><span style="display:flex;"><span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># starting row of the program</span>
</span></span><span style="display:flex;"><span>    row_start <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>program_id(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    row_step <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>num_programs(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> row_idx <span style="color:#f92672">in</span> tl<span style="color:#f92672">.</span>range(row_start, n_rows, row_step):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># The stride represents how much we need to increase the pointer to advance 1 row</span>
</span></span><span style="display:flex;"><span>        row_start_ptr <span style="color:#f92672">=</span> input_ptr <span style="color:#f92672">+</span> row_idx <span style="color:#f92672">*</span> input_row_stride
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># The block size is the next power of two greater than n_cols, so we can fit each</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># row in a single block</span>
</span></span><span style="display:flex;"><span>        col_offsets <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>, BLOCK_SIZE)
</span></span><span style="display:flex;"><span>        input_ptrs <span style="color:#f92672">=</span> row_start_ptr <span style="color:#f92672">+</span> col_offsets
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Load the row into SRAM, using a mask since BLOCK_SIZE may be &gt; than n_cols</span>
</span></span><span style="display:flex;"><span>        mask <span style="color:#f92672">=</span> col_offsets <span style="color:#f92672">&lt;</span> n_cols
</span></span><span style="display:flex;"><span>        row <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(input_ptrs, mask<span style="color:#f92672">=</span>mask, other<span style="color:#f92672">=-</span>float(<span style="color:#e6db74">&#34;inf&#34;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Subtract maximum for numerical stability</span>
</span></span><span style="display:flex;"><span>        row_minus_max <span style="color:#f92672">=</span> row <span style="color:#f92672">-</span> tl<span style="color:#f92672">.</span>max(row, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        numerator <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>exp(row_minus_max)
</span></span><span style="display:flex;"><span>        denominator <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>sum(numerator, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        softmax_output <span style="color:#f92672">=</span> numerator <span style="color:#f92672">/</span> denominator
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Write back output to DRAM</span>
</span></span><span style="display:flex;"><span>        output_row_start_ptr <span style="color:#f92672">=</span> output_ptr <span style="color:#f92672">+</span> row_idx <span style="color:#f92672">*</span> output_row_stride
</span></span><span style="display:flex;"><span>        output_ptrs <span style="color:#f92672">=</span> output_row_start_ptr <span style="color:#f92672">+</span> col_offsets
</span></span><span style="display:flex;"><span>        tl<span style="color:#f92672">.</span>store(output_ptrs, softmax_output, mask<span style="color:#f92672">=</span>mask)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>target <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>runtime<span style="color:#f92672">.</span>driver<span style="color:#f92672">.</span>active<span style="color:#f92672">.</span>get_current_target()
</span></span><span style="display:flex;"><span>kernels <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">softmax</span>(x, stream):
</span></span><span style="display:flex;"><span>    n_rows, n_cols <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>shape
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># The block size of each loop iteration is the smallest power of two greater than the number of columns in `x`</span>
</span></span><span style="display:flex;"><span>    BLOCK_SIZE <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>next_power_of_2(n_cols)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Allocate output</span>
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>empty_like(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># pre-compile kernel to get register usage and compute thread occupancy.</span>
</span></span><span style="display:flex;"><span>    kernel, num_programs <span style="color:#f92672">=</span> kernels<span style="color:#f92672">.</span>get(BLOCK_SIZE, (<span style="color:#66d9ef">None</span>, <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> kernel <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        num_programs <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>        kernel <span style="color:#f92672">=</span> softmax_kernel
</span></span><span style="display:flex;"><span>        kernels[BLOCK_SIZE] <span style="color:#f92672">=</span> (kernel, num_programs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    num_programs <span style="color:#f92672">=</span> min(num_programs, n_rows)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create a number of persistent programs.</span>
</span></span><span style="display:flex;"><span>    kernel[(num_programs, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)](
</span></span><span style="display:flex;"><span>        y, x, x<span style="color:#f92672">.</span>stride(<span style="color:#ae81ff">0</span>), y<span style="color:#f92672">.</span>stride(<span style="color:#ae81ff">0</span>), n_rows, n_cols, BLOCK_SIZE
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>device <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>npu<span style="color:#f92672">.</span>current_device()
</span></span><span style="display:flex;"><span>stream <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>npu<span style="color:#f92672">.</span>current_stream(device)<span style="color:#f92672">.</span>npu_stream
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@triton.testing.perf_report</span>(
</span></span><span style="display:flex;"><span>    triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>Benchmark(
</span></span><span style="display:flex;"><span>        x_names<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;N&#34;</span>],  <span style="color:#75715e"># 用作图表 X 轴的参数名</span>
</span></span><span style="display:flex;"><span>        x_vals<span style="color:#f92672">=</span>[<span style="color:#ae81ff">128</span> <span style="color:#f92672">*</span> i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">100</span>)],  <span style="color:#75715e"># X 轴的具体数值</span>
</span></span><span style="display:flex;"><span>        line_arg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;provider&#34;</span>,  <span style="color:#75715e"># 用作对比不同曲线的参数名</span>
</span></span><span style="display:flex;"><span>        line_vals<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;triton&#34;</span>, <span style="color:#e6db74">&#34;torch-native&#34;</span>, <span style="color:#e6db74">&#34;torch-naive&#34;</span>],  <span style="color:#75715e"># 只有这三个值</span>
</span></span><span style="display:flex;"><span>        line_names<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;Triton&#34;</span>, <span style="color:#e6db74">&#34;Torch (Native)&#34;</span>, <span style="color:#e6db74">&#34;Torch (Naive)&#34;</span>],  <span style="color:#75715e"># 图例显示的名字</span>
</span></span><span style="display:flex;"><span>        styles<span style="color:#f92672">=</span>[(<span style="color:#e6db74">&#34;blue&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>), (<span style="color:#e6db74">&#34;green&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>), (<span style="color:#e6db74">&#34;red&#34;</span>, <span style="color:#e6db74">&#34;--&#34;</span>)],  <span style="color:#75715e"># 曲线颜色和线型</span>
</span></span><span style="display:flex;"><span>        ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;GB/s&#34;</span>,  <span style="color:#75715e"># Y 轴单位：显存吞吐量 (越高越好)</span>
</span></span><span style="display:flex;"><span>        plot_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;softmax-performance&#34;</span>,
</span></span><span style="display:flex;"><span>        args<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;M&#34;</span>: <span style="color:#ae81ff">4096</span>},  <span style="color:#75715e"># 固定 Batch Size 为 4096</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">benchmark</span>(M, N, provider):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 初始化数据 (FP16 或者是 FP32)</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>randn(M, N, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;npu&#34;</span>, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float32)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 使用 Quantile 计算分位数，避免偶尔的抖动</span>
</span></span><span style="display:flex;"><span>    quantiles <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.2</span>, <span style="color:#ae81ff">0.8</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> provider <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;torch-native&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 这里的 torch.softmax 是 C++ 深度优化的库函数 (cuDNN/CANN)</span>
</span></span><span style="display:flex;"><span>        ms, min_ms, max_ms <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>do_bench(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">lambda</span>: torch<span style="color:#f92672">.</span>softmax(x, axis<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>), quantiles<span style="color:#f92672">=</span>quantiles
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> provider <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;triton&#34;</span>:
</span></span><span style="display:flex;"><span>        ms, min_ms, max_ms <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>do_bench(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">lambda</span>: softmax(x, stream), quantiles<span style="color:#f92672">=</span>quantiles
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> provider <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;torch-naive&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 这是一个反面教材，速度极慢</span>
</span></span><span style="display:flex;"><span>        ms, min_ms, max_ms <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>do_bench(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">lambda</span>: naive_softmax(x), quantiles<span style="color:#f92672">=</span>quantiles
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 计算吞吐量 GB/s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 公式：(读取量 + 写入量) / 时间</span>
</span></span><span style="display:flex;"><span>    gbps <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> ms: <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> x<span style="color:#f92672">.</span>numel() <span style="color:#f92672">*</span> x<span style="color:#f92672">.</span>element_size() <span style="color:#f92672">*</span> <span style="color:#ae81ff">1e-9</span> <span style="color:#f92672">/</span> (ms <span style="color:#f92672">*</span> <span style="color:#ae81ff">1e-3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> gbps(ms), gbps(max_ms), gbps(min_ms)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 运行测试</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检查是否有 GPU/NPU</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> torch<span style="color:#f92672">.</span>npu<span style="color:#f92672">.</span>is_available():
</span></span><span style="display:flex;"><span>        benchmark<span style="color:#f92672">.</span>run(print_data<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, show_plots<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, save_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;未检测到 GPU/NPU，无法运行 Triton 测试。&#34;</span>)
</span></span></code></pre></div><p>运行这段代码，我得到了如下图的性能对比图表：</p>
<p><img src="/zh-cn/posts/triton%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%97-02softmax/%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%942025121001.jpg" alt=""></p>
<p>从图中可以看出,我们的triton融合算子和<code>torch.softmax</code>在数据量较大的情况下性能基本一致，而使用torch原生方法分步计算的<code>torch-naive</code>则性能表现一般。</p>
]]></content>
		</item>
		
		<item>
			<title>Triton自学日志 01VectorAdd</title>
			<link>http://localhost:1313/zh-cn/posts/triton%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%97-01vectoradd/</link>
			<pubDate>Tue, 09 Dec 2025 08:26:42 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/triton%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%97-01vectoradd/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>在经过了大约半个月的环境配置过程，终于成功在华为服务器上搭建起了vllm和triton开发环境，可以正式开始研究triton算子的写法了。但是我对triton算子没有任何概念，索性花了点时间逐行研究triton-ascend的官方文档示例代码。</p>
<p>本文参考链接如下：</p>
<p><a href="https://gitcode.com/Ascend/triton-ascend">Triton Ascend</a></p>
<p><a href="https://gitcode.com/Ascend/triton-ascend/blob/master/docs/sources/getting-started/tutorials/01-vector-add.md">01-vector-add教程</a></p>
<p>文章写完之后突然意识到triton语境下数据缓存的位置实际是显存而非传统意义的内存。文中可能会出现显存内存不分的情况，意会即可。</p>
<hr>
<h1 id="向量相加-vector-addition">向量相加 （Vector Addition）<a href="#%e5%90%91%e9%87%8f%e7%9b%b8%e5%8a%a0-vector-addition" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>在本节中，我们将使用 Triton 编写一个简单的向量相加的程序。
在此过程中，你会学习到：</p>
<ul>
<li>Triton 的基本编程模式。</li>
<li>用于定义 Triton 内核的<code>triton.jit</code>装饰器（decorator）。</li>
</ul>
<p>计算内核:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch_npu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton.language <span style="color:#66d9ef">as</span> tl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@triton.jit</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_kernel</span>(x_ptr,  <span style="color:#75715e"># 指向第一个输入向量的指针。</span>
</span></span><span style="display:flex;"><span>               y_ptr,  <span style="color:#75715e"># 指向第二个输入向量的指针。</span>
</span></span><span style="display:flex;"><span>               output_ptr,  <span style="color:#75715e"># 指向输出向量的指针。</span>
</span></span><span style="display:flex;"><span>               n_elements,  <span style="color:#75715e"># 向量的大小。</span>
</span></span><span style="display:flex;"><span>               BLOCK_SIZE: tl<span style="color:#f92672">.</span>constexpr,  <span style="color:#75715e"># 每个程序应处理的元素数量。</span>
</span></span><span style="display:flex;"><span>               <span style="color:#75715e"># 注意：`constexpr` 将标记变量为常量。</span>
</span></span><span style="display:flex;"><span>               ):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 不同的数据由不同的“process”来处理，因此需要分配：</span>
</span></span><span style="display:flex;"><span>    pid <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>program_id(axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># 使用 1D 启动网格，因此轴为 0。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 该程序将处理相对初始数据偏移的输入。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 例如，如果有一个长度为 256, 块大小为 64 的向量，程序将各自访问 [0:64, 64:128, 128:192, 192:256] 的元素。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 注意 offsets 是指针列表：</span>
</span></span><span style="display:flex;"><span>    block_start <span style="color:#f92672">=</span> pid <span style="color:#f92672">*</span> BLOCK_SIZE
</span></span><span style="display:flex;"><span>    offsets <span style="color:#f92672">=</span> block_start <span style="color:#f92672">+</span> tl<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>, BLOCK_SIZE)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 创建掩码以防止内存操作超出边界访问。</span>
</span></span><span style="display:flex;"><span>    mask <span style="color:#f92672">=</span> offsets <span style="color:#f92672">&lt;</span> n_elements
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 从 DRAM 加载 x 和 y，如果输入不是块大小的整数倍，则屏蔽掉任何多余的元素。</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(x_ptr <span style="color:#f92672">+</span> offsets, mask<span style="color:#f92672">=</span>mask)
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(y_ptr <span style="color:#f92672">+</span> offsets, mask<span style="color:#f92672">=</span>mask)
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">=</span> x <span style="color:#f92672">+</span> y
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 将 x + y 写回 DRAM。</span>
</span></span><span style="display:flex;"><span>    tl<span style="color:#f92672">.</span>store(output_ptr <span style="color:#f92672">+</span> offsets, output, mask<span style="color:#f92672">=</span>mask)
</span></span></code></pre></div><h1 id="如何理解">如何理解？<a href="#%e5%a6%82%e4%bd%95%e7%90%86%e8%a7%a3" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<h2 id="1-什么是计算内核">1. 什么是“计算内核”？<a href="#1-%e4%bb%80%e4%b9%88%e6%98%af%e8%ae%a1%e7%ae%97%e5%86%85%e6%a0%b8" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>通常的python程序运行在cpu上，程序的执行方式是串行（一行一行执行）。</p>
<p>但是在npu/gpu上，计算核心的组成和cpu上完全不同。npu/gpu上的核心功能远比cpu简单，但是核心数量远远大于cpu，适合用来处理大量的简单计算。为了快速计算，我们需要让核心并行计算，即几千个核心同时进行计算。这时的程序逻辑就和cpu上有所区别。</p>
<h3 id="计算内核kernel">计算内核（kernel）<a href="#%e8%ae%a1%e7%ae%97%e5%86%85%e6%a0%b8kernel" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>我们没有办法通过一个巨大的程序控制全局，而是通过发射kernel的方式明确每个npu/gpu小核心的工作内容。kernel就是你送给小核心的指令。发射一次kernel，所有的指定核心就会按照你给出的指令进行同样的计算操作，而他们之间的区别就在于操作的内存地址有所不同。</p>
<hr>
<h2 id="2-tritonjit装饰器在干什么">2. @triton.jit装饰器在干什么?<a href="#2-tritonjit%e8%a3%85%e9%a5%b0%e5%99%a8%e5%9c%a8%e5%b9%b2%e4%bb%80%e4%b9%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>显然，你的python程序没办法直接跑在npu/gpu上。npu/gpu核心功能本身就很简单了，而你的python程序则是跑在cpu上的。所以，你需要方法把python程序代码解读为npu/gpu能懂的语言。</p>
<p>在写<code>def add_kernel()</code>前为它加上<code>@triton.jit</code>装饰器后，在你运行这个python程序时，这段<code>add_kernel</code>函数就会被编译为npu/gpu能懂的二进制机器码，并将这个npu/gpu能直接读懂的指令放在某个地方，等待调用。</p>
<p>当你真正调用<code>add_kernel</code>这个函数时，系统实际上并不会在cpu上执行这个函数的函数体，而是通过驱动程序直接使用刚才编译好的二进制机器码。</p>
<p>说白了，就是把这段python程序变成npu上能高速运行的二进制程序。</p>
<hr>
<h2 id="3-行业黑话">3. 行业黑话<a href="#3-%e8%a1%8c%e4%b8%9a%e9%bb%91%e8%af%9d" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="x_ptry_ptroutput_ptr"><code>x_ptr</code>、<code>y_ptr</code>、<code>output_ptr</code><a href="#x_ptry_ptroutput_ptr" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>向量的起始地址。向量在内存中的存储是连续的，因此我们只需要一个起始地址就可以描述这个向量中所有元素的位置。</p>
<hr>
<h3 id="block_sizetlconstexpr"><code>BLOCK_SIZE:tl.constexpr</code><a href="#block_sizetlconstexpr" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在这里，注释中出现了一个“程序”的概念。此处的“程序”如果代入我们通常对“程序”的理解，在这个上下文中会显得非常违和。所以，我们需要先来明确npu语境下“程序”的概念。</p>
<h3 id="什么是triton语境下的程序">什么是Triton语境下的“程序”?<a href="#%e4%bb%80%e4%b9%88%e6%98%aftriton%e8%af%ad%e5%a2%83%e4%b8%8b%e7%9a%84%e7%a8%8b%e5%ba%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在 Triton 的代码逻辑里：</p>
<blockquote>
<p><strong>一个“程序（instance）” = 你的内核函数被复制并运行的其中一次“副本”。</strong></p>
</blockquote>
<p>举个例子：</p>
<ul>
<li>假如总数据量为1024。</li>
<li>你规定了一个block_size，让一个“副本”每次只能处理128个数据。</li>
<li>所以根据代码，你最后算出来你需要启动8个副本。</li>
<li>你创建了8个副本，核心就会自动来取走你创建的副本，一旦一个副本完成，多余的核心就会立刻投入接下来的副本的工作。</li>
</ul>
<p>用一个形象比喻：</p>
<ul>
<li>考试总共要做1024道题（数据量）。</li>
<li>参加考试的考生有4个（核心数）。</li>
<li>一个卷子只能放128道题（你规定的block_size）。</li>
<li>你打印了8张卷子（程序），每个卷子有128道题。</li>
<li>考生每个人各自拿走了1张卷子，做完一张后自动再取剩下的卷子。</li>
</ul>
<h3 id="为什么要固定block_size">为什么要固定block_size？<a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e5%9b%ba%e5%ae%9ablock_size" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>比如，你可能会认为，直接一张卷子印256道题不就没有中间调度的问题了吗？或者随便多少道题只要最后完成就行。</p>
<p>但是，在triton的语境下，规定好block_size之后，编译器就可以针对这个任务包大小对生成的二进制机器码进行疯狂优化。将block_size定为常量可以大幅提升运算效率。</p>
<hr>
<h3 id="pid--tlprogram_idaxis--0"><code>pid = tl.program_id(axis = 0)</code><a href="#pid--tlprogram_idaxis--0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>别忘了，我们在写的东西是一个<strong>kernel</strong>。我们最后会把这同一个kernel发送给所有的核心，但是这些核心最后需要去处理不同内存地址上的向量，这样才能实现并行计算的目的。</p>
<p>这些核心之间唯一有区别的地方，就在于它们被分配到的<code>program_id</code>不同。因此，通过program_id，你实际上做的事情是告诉核心根据它正在进行的程序id去随机应变。而我们此处的“随机应变”就是让核心根据程序id去操作相应的内存地址。</p>
<hr>
<h3 id="block_start--pid--block_size"><code>block_start = pid * BLOCK_SIZE</code><a href="#block_start--pid--block_size" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>任务块的起始点。在本代码情景下，你要操作的内存是一大片连续内存空间，所以将它分块后你需要让核心先知道自己所处理的那一块数据的一个“锚点”在哪，再根据“锚点”位置通过偏移量明确操作的具体位置。</p>
<hr>
<h3 id="offsets--block_start--tlarange0-block_size"><code>offsets = block_start + tl.arange(0, BLOCK_SIZE)</code><a href="#offsets--block_start--tlarange0-block_size" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>tl.arange(0, BLOCK_SIZE)</code>直接生成一个0到BLOCK_SIZE的序列，加上block_start对序列中的每个数字添加一个起始值，最后得到了一个偏移量向量，代表了这一批任务的具体内存偏移。</p>
<hr>
<h3 id="mask--offsets--n_elements"><code>mask = offsets &lt; n_elements</code><a href="#mask--offsets--n_elements" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>Mask的含义是“掩码”。简单来说，这里offsets是一个向量，而n_elements则是一个数字。根据torch、triton、numpy等数据科学工具常见的神奇的<strong>广播</strong>机制，n_elements被直接复制了若干个而组成了一个和offsets大小一致的向量，最后mask得到的也是一个向量，但是内容是offsets中对应元素与n_elements比较结果的布尔值。</p>
<p>比如，假如<code>offsets = [1,2,3]</code>，<code>n_elements = 3</code>，那么最后<code>mask</code>就得到<code>[True,True,False]</code>。</p>
<p>通过这种方式，我们可以确保核心工作不越界。比如，假如你的向量有1000个数据要处理，但是你设置的BLOCK_SIZE大小却是128，1000除不尽128，那么最后一个块就只会计算掩码中为true的部分，保证不去越界计算向量外的内存。</p>
<hr>
<h3 id="x--tlloadx_ptr--offsets-maskmask"><code>x = tl.load(x_ptr + offsets, mask=mask)</code><a href="#x--tlloadx_ptr--offsets-maskmask" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>x_ptr为第一个向量的起始地址，offsets为偏移量向量。显然，这里也通过广播机制得到了一个向量，而这个向量信息的含义就是核心要读取的信息在内存中的绝对地址。<code>mask = mask</code>通过关键字传值的方式将我们前面计算过的掩码传入load函数的mask参数。最后返回得到的x即为符合mask掩码约束的x_ptr+offsets部分的内存对应的信息组成的新向量。mask为false的部分信息被自动填充为0.0。</p>
<hr>
<h2 id="这段代码做了什么">这段代码做了什么？<a href="#%e8%bf%99%e6%ae%b5%e4%bb%a3%e7%a0%81%e5%81%9a%e4%ba%86%e4%bb%80%e4%b9%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>定义了一个函数，它会在运行时直接转换为二进制机器码。它提供了若干参数，分别允许你去控制输入的两个向量的起始地址，输出向量的地址，向量的大小，以及过程中的BLOCK_SIZE。</p>
<p>调用这个函数，程序就会在你指定的内存地址分别读取向量大小个数的数据，并分别相加，最后存入输出向量的地址。只不过，这些操作是通过npu而非cpu完成的。</p>
<hr>
<h1 id="torch-add">torch add<a href="#torch-add" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>创建一个辅助函数用于：</p>
<ul>
<li>生成 z 张量；</li>
<li>用适当的 grid/block sizes 将上述内核加入队列。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(x: torch<span style="color:#f92672">.</span>Tensor, y: torch<span style="color:#f92672">.</span>Tensor):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 需要预分配输出。</span>
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>empty_like(x)
</span></span><span style="display:flex;"><span>    n_elements <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>numel()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 启动网格表示并行运行的内核实例的数量。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 可以是 Tuple[int]，也可以是 Callable(metaparameters) -&gt; Tuple[int]。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 在本case中，使用 1D 网格，其中大小是块的数量：</span>
</span></span><span style="display:flex;"><span>    grid <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> meta: (triton<span style="color:#f92672">.</span>cdiv(n_elements, meta[<span style="color:#e6db74">&#39;BLOCK_SIZE&#39;</span>]), )
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># NOTE:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  - 每个 torch.tensor 对象都会隐式转换为其第一个元素的指针。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  - `triton.jit` 函数可以通过启动网格索引来获得可调用的 NPU 内核。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  - 不要忘记以keywords的方式传递meta-parameters。</span>
</span></span><span style="display:flex;"><span>    add_kernel[grid](x, y, output, n_elements, BLOCK_SIZE<span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 返回 z 的句柄。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> output
</span></span></code></pre></div><h2 id="这段代码又是干什么的">这段代码又是干什么的？<a href="#%e8%bf%99%e6%ae%b5%e4%bb%a3%e7%a0%81%e5%8f%88%e6%98%af%e5%b9%b2%e4%bb%80%e4%b9%88%e7%9a%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>这是一个<strong>宿主端</strong>的代码。简单来说，torch开发者需要能进行并行计算来实现业务逻辑，但是他们并不想去关心你底层实现的逻辑。因此，作为triton开发者，你需要做的是把这个功能封装为一个极其简单易用同时兼顾安全性的函数，供客户随时调用。</p>
<p>我们来逐行分析这段代码：</p>
<hr>
<h3 id="output--torchempty_likex"><code>output = torch.empty_like(x)</code><a href="#output--torchempty_likex" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>调用torch库，在npu显存上为output挖了一个和x一样大小的坑，让output存入这个坑的地址。</p>
<p>如果你不挖这个坑，你前面写的add_kernel就不知道该把运算结果存到哪个位置，而python函数通常要返回运算值而非算完之后随便扔在某个地方。</p>
<hr>
<h3 id="n_elements--outputnumel"><code>n_elements = output.numel()</code><a href="#n_elements--outputnumel" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>让<code>n_elements</code>存入<code>output</code>的大小。</p>
<hr>
<h3 id="grid--lambda-meta-tritoncdivn_elements-metablock_size-"><code>grid = lambda meta: (triton.cdiv(n_elements, meta['BLOCK_SIZE']), )</code><a href="#grid--lambda-meta-tritoncdivn_elements-metablock_size-" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>这行代码是这个函数中相对复杂的一段。它的作用是<strong>动态决定需要启动的程序数</strong>。</p>
<p><code>grid</code>的类型是一个lambda函数，在后文中，它被通过一种邪门的写法传入了add_kernel中。你可能注意到了，grid并非写入圆括号当中，而是写在方括号中。我们后文中会提及这种写法的意义。总之，这是一种一般python程序中不会涉及到的写法。</p>
<p><code>triton.cdiv</code>是<strong>ceiling division</strong>的缩写，即向上取整。</p>
<p>这个时候，你可能就会有疑问：meta是个什么东西？你先别急，我们先看后面一句代码。</p>
<hr>
<h3 id="add_kernelgridx-y-output-n_elements-block_size1024"><code>add_kernel[grid](x, y, output, n_elements, BLOCK_SIZE=1024)</code><a href="#add_kernelgridx-y-output-n_elements-block_size1024" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>这段代码即调用了我们前文写的add_kernel函数。</p>
<p>在这个lambda函数中，meta的类型是一个字典。在你发射kernel时，它里面装的就是你所传递的<strong>元参数</strong>。在我们写的add函数中，x、y均为Torch中的Tensor数据类型，传参时会隐式转换为内存地址。而output在我们前文中也已经提前挖好坑了。</p>
<p>但这里，我们通过了一些邪门的方法额外传入了一个grid函数。下面我就来解释一下这种写法的含义。</p>
<h4 id="meta"><code>meta</code><a href="#meta" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>triton的开发者预料到了你需要有办法去根据特殊情景决定启动的程序数量，所以他们提供了一种方式让你可以获取客户在使用你封装好的函数时的传参情况。</p>
<p>什么方式呢？在你使用<code>@triton.jit</code>装饰好的函数时，triton会捕捉到你传入的参数，构成一个<strong>字典</strong>。比如，在我们上文写出的add_kernel函数中，这个字典大概长成这样：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>meta <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;x_ptr&#34;</span> : <span style="color:#f92672">&lt;</span>address<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;y_ptr&#34;</span> : <span style="color:#f92672">&lt;</span>address<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;output_ptr&#34;</span> : <span style="color:#f92672">&lt;</span>address<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;n_elements&#34;</span> : <span style="color:#f92672">&lt;</span>numble<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;BLOCK_SIZE&#34;</span> : <span style="color:#f92672">&lt;</span>numble<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>系统在进行运算之前，会先生成这个字典，然后暗中调用一个lambda函数，将这个字典作为参数传入，根据得到的结果进而决定最后启动的程序个数。</p>
<p>你通常没办法直接调用这个字典，不过幸运的是，你可以去决定系统暗中调用的lambda函数的形式，而这个lambda函数传入的参数正是triton生成的参数字典。</p>
<p>因此，我们在前面定义lambda函数grid为<code>lambda meta: (triton.cdiv(n_elements, meta['BLOCK_SIZE']), )</code>，意义就是在add_kernel生效之前读取传入的参数字典，根据参数字典中BLOCK_SIZE的值计算出需要的最少启动程序数，然后系统通过这个返回值最终决定启动的程序数。</p>
<hr>
<h3 id="return-output"><code>return output</code><a href="#return-output" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>返回<code>output</code>这个生成的tensor。</p>
<hr>
<p>使用上述函数计算两个 <code>torch.tensor</code> 对象的 element-wise sum，并测试其正确性：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>size <span style="color:#f92672">=</span> <span style="color:#ae81ff">98432</span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>rand(size, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu&#39;</span>)
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>rand(size, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu&#39;</span>)
</span></span><span style="display:flex;"><span>output_torch <span style="color:#f92672">=</span> x <span style="color:#f92672">+</span> y
</span></span><span style="display:flex;"><span>output_triton <span style="color:#f92672">=</span> add(x, y)
</span></span><span style="display:flex;"><span>print(output_torch)
</span></span><span style="display:flex;"><span>print(output_triton)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;The maximum difference between torch and triton is &#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>torch<span style="color:#f92672">.</span>max(torch<span style="color:#f92672">.</span>abs(output_torch <span style="color:#f92672">-</span> output_triton))<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p>这是一段测试代码。x、y分别是使用torch生成的随机向量。<code>output_torch</code>为直接使用torch内置方法计算得到的向量和，<code>output_triton</code>为使用我们自定义函数计算得到的向量和，最后打印两者的最大残差。</p>
<p>理论上来说，如果程序正确，<code>output_torch</code>和<code>output_triton</code>应该输出完全一致。</p>
<p>Out:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tensor<span style="color:#f92672">([</span>0.8329, 1.0024, 1.3639,  ..., 1.0796, 1.0406, 1.5811<span style="color:#f92672">]</span>, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu:0&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>tensor<span style="color:#f92672">([</span>0.8329, 1.0024, 1.3639,  ..., 1.0796, 1.0406, 1.5811<span style="color:#f92672">]</span>, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu:0&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>The maximum difference between torch and triton is 0.0
</span></span></code></pre></div><p>&ldquo;The maximum difference between torch and triton is 0.0&rdquo; 表示Triton和PyTorch的输出结果一致。</p>
<p>但是，如果你真正去衡量torch方法与triton方法之间的计算速度，你会发现triton方法算出来的速度基本与torch方法持平，甚至更慢一点。原因很简单，torch经过了长期的优化，这种基础算子的计算速度基本已经达到了物理极限，而我们自己写的triton算法在调用npu显存数据上要花费额外的时间。</p>
<p>triton算子真正的优势区间在于写“融合算子”。同样的操作，pytorch的每一步操作都要单独去显存拉取一次数据，操作多起来之后这一步拉取操作就会显著影响运行速度。而通过写triton算子直接操作显存，一次拉取数据之后直接计算得到结果，这样就可以规避中间不必要的额外拉取用时。</p>
<hr>
<h1 id="如何测试运行速度">如何测试运行速度？<a href="#%e5%a6%82%e4%bd%95%e6%b5%8b%e8%af%95%e8%bf%90%e8%a1%8c%e9%80%9f%e5%ba%a6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>因为异步运算的缘故，torch和time模块这样基于CPU的计时方法无法测量NPU中的真正用时。我们需要使用triton提供的专业基本测试工具<code>triton.testing.do_bench</code>来测试计算效率。</p>
<p>在下列实例代码中，我们采用带宽吞吐量为依据衡量torch和triton的运行速度差异。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 强制使用 &#39;Agg&#39; 后端，这个后端专门用于不弹窗直接生成图片文件</span>
</span></span><span style="display:flex;"><span>matplotlib<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#34;Agg&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch_npu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton.language <span style="color:#66d9ef">as</span> tl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@triton.jit</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_kernel</span>(
</span></span><span style="display:flex;"><span>    x_ptr,  <span style="color:#75715e"># 指向第一个输入向量的指针。</span>
</span></span><span style="display:flex;"><span>    y_ptr,  <span style="color:#75715e"># 指向第二个输入向量的指针。</span>
</span></span><span style="display:flex;"><span>    output_ptr,  <span style="color:#75715e"># 指向输出向量的指针。</span>
</span></span><span style="display:flex;"><span>    n_elements,  <span style="color:#75715e"># 向量的大小。</span>
</span></span><span style="display:flex;"><span>    BLOCK_SIZE: tl<span style="color:#f92672">.</span>constexpr,  <span style="color:#75715e"># 每个程序应处理的元素数量。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 注意：`constexpr` 将标记变量为常量。</span>
</span></span><span style="display:flex;"><span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 不同的数据由不同的“process”来处理，因此需要分配：</span>
</span></span><span style="display:flex;"><span>    pid <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>program_id(axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># 使用 1D 启动网格，因此轴为 0。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 该程序将处理相对初始数据偏移的输入。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 例如，如果有一个长度为 256, 块大小为 64 的向量，程序将各自访问 [0:64, 64:128, 128:192, 192:256] 的元素。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 注意 offsets 是指针列表：</span>
</span></span><span style="display:flex;"><span>    block_start <span style="color:#f92672">=</span> pid <span style="color:#f92672">*</span> BLOCK_SIZE
</span></span><span style="display:flex;"><span>    offsets <span style="color:#f92672">=</span> block_start <span style="color:#f92672">+</span> tl<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>, BLOCK_SIZE)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 创建掩码以防止内存操作超出边界访问。</span>
</span></span><span style="display:flex;"><span>    mask <span style="color:#f92672">=</span> offsets <span style="color:#f92672">&lt;</span> n_elements
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 从 DRAM 加载 x 和 y，如果输入不是块大小的整数倍，则屏蔽掉任何多余的元素。</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(x_ptr <span style="color:#f92672">+</span> offsets, mask<span style="color:#f92672">=</span>mask)
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(y_ptr <span style="color:#f92672">+</span> offsets, mask<span style="color:#f92672">=</span>mask)
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">=</span> x <span style="color:#f92672">+</span> y
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 将 x + y 写回 DRAM。</span>
</span></span><span style="display:flex;"><span>    tl<span style="color:#f92672">.</span>store(output_ptr <span style="color:#f92672">+</span> offsets, output, mask<span style="color:#f92672">=</span>mask)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@triton.testing.perf_report</span>(
</span></span><span style="display:flex;"><span>    triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>Benchmark(
</span></span><span style="display:flex;"><span>        x_names<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;size&#34;</span>],  <span style="color:#75715e"># 作为x轴变化的参数</span>
</span></span><span style="display:flex;"><span>        x_vals<span style="color:#f92672">=</span>[<span style="color:#ae81ff">128</span> <span style="color:#f92672">*</span> i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">100</span>)],  <span style="color:#75715e"># 测试从 256 到 12800 的不同大小</span>
</span></span><span style="display:flex;"><span>        line_arg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;provider&#34;</span>,
</span></span><span style="display:flex;"><span>        line_vals<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;triton&#34;</span>, <span style="color:#e6db74">&#34;torch&#34;</span>],  <span style="color:#75715e"># 对比这两家</span>
</span></span><span style="display:flex;"><span>        line_names<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;Triton&#34;</span>, <span style="color:#e6db74">&#34;Torch&#34;</span>],
</span></span><span style="display:flex;"><span>        styles<span style="color:#f92672">=</span>[(<span style="color:#e6db74">&#34;blue&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>), (<span style="color:#e6db74">&#34;green&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>)],
</span></span><span style="display:flex;"><span>        ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;GB/s&#34;</span>,  <span style="color:#75715e"># 用带宽吞吐量作为指标</span>
</span></span><span style="display:flex;"><span>        plot_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;vector-add-performance&#34;</span>,
</span></span><span style="display:flex;"><span>        args<span style="color:#f92672">=</span>{},
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">benchmark</span>(size, provider):
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>rand(size, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;npu&#34;</span>, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float32)
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>rand(size, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;npu&#34;</span>, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float32)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 预热显存分配</span>
</span></span><span style="display:flex;"><span>    quantiles <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.2</span>, <span style="color:#ae81ff">0.8</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> provider <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;torch&#34;</span>:
</span></span><span style="display:flex;"><span>        ms, min_ms, max_ms <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>do_bench(<span style="color:#66d9ef">lambda</span>: x <span style="color:#f92672">+</span> y, quantiles<span style="color:#f92672">=</span>quantiles)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> provider <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;triton&#34;</span>:
</span></span><span style="display:flex;"><span>        output <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>empty_like(x)
</span></span><span style="display:flex;"><span>        grid <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> meta: (triton<span style="color:#f92672">.</span>cdiv(size, meta[<span style="color:#e6db74">&#34;BLOCK_SIZE&#34;</span>]),)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 封装一下 lambda 方便测速</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">call_triton</span>():
</span></span><span style="display:flex;"><span>            add_kernel[grid](x, y, output, size, BLOCK_SIZE<span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ms, min_ms, max_ms <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>do_bench(call_triton, quantiles<span style="color:#f92672">=</span>quantiles)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 返回吞吐量计算 GB/s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gbps</span>(ms):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 读x(4 bytes) + 读y(4 bytes) + 写output(4 bytes) = 12 bytes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">*</span> size <span style="color:#f92672">/</span> ms <span style="color:#f92672">*</span> <span style="color:#ae81ff">1e-6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> gbps(ms), gbps(max_ms), gbps(min_ms)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 运行 benchmark</span>
</span></span><span style="display:flex;"><span>benchmark<span style="color:#f92672">.</span>run(print_data<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, show_plots<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, save_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./bench_result&#34;</span>)
</span></span></code></pre></div><p>在使用这个测试工具之前，你需要先确保安装了<code>matplotlib</code>、<code>pandas</code>、<code>numpy</code>等基本数据科学库。最后你可以得到由matplotlib生成的性能测试图表。</p>
<p>在本代码中，实际进行加法计算的用时非常少，大部分的用时都在信息搬运上，而带宽正描述的是这一行为的速率。通过运行这段代码，我们就成功得到了torch原生写法与我们自己写的triton算子之间的性能差异图表。</p>
<p><img src="/zh-cn/posts/triton%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%97-01vectoradd/%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%942025120901.jpg" alt=""></p>
]]></content>
		</item>
		
		<item>
			<title>NeovimPlugins配置方法</title>
			<link>http://localhost:1313/zh-cn/posts/neovimplugins%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95/</link>
			<pubDate>Sun, 23 Nov 2025 11:11:53 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/neovimplugins%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>我的上一篇博客中，我们探讨了如何配置nvim。但是仅仅是修改了键位和vim行为远远不足以让我们的nvim可以承担代码任务。我们需要插件来拓展nvim的功能。插件是nvim的灵魂，有了插件，你的nvim才能作为一个功能完备的ide来使用。(后记：真正使用时你应该去使用lazyvim，并通过lazyvim的lazyextra功能配置lsp和相关的调试功能。如果你有生活，不要尝试自己配置lsp，尤其是如果你想写java之类的面向大型工程设计的语言。)</p>
<h3 id="插件的分类">插件的分类<a href="#%e6%8f%92%e4%bb%b6%e7%9a%84%e5%88%86%e7%b1%bb" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>nvim的插件大致有以下几类:</p>
<ul>
<li>基础辅助。拓展vim的行为。</li>
<li>git集成</li>
<li>外观主题</li>
<li>代码智能
<ul>
<li>自动补全</li>
<li>语法高亮</li>
<li>语法诊断</li>
<li>调试与运行</li>
<li>代码格式化</li>
</ul>
</li>
<li>模糊搜索</li>
</ul>
<p>至少在kickstart中出现的插件可以大致归类为以上内容。</p>
<h3 id="插件管理器">插件管理器<a href="#%e6%8f%92%e4%bb%b6%e7%ae%a1%e7%90%86%e5%99%a8" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>光有插件是远远不够的，我们需要一个组件来专门管理插件，决定插件何时运行。通常而言，我们选择使用lazy.nvim插件管理器，它最大的特点就是“懒加载”，只在需要的时候加载插件功能，这极大地提高了载入速度。</p>
<p>让我们看到init.lua中关于下载lazy.nvim插件管理器的部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- [[ Install `lazy.nvim` plugin manager ]]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--    See `:help lazy.nvim.txt` or https://github.com/folke/lazy.nvim for more info</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> lazypath <span style="color:#f92672">=</span> vim.fn.stdpath <span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">..</span> <span style="color:#e6db74">&#39;/lazy/lazy.nvim&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> (vim.uv <span style="color:#f92672">or</span> vim.loop).fs_stat(lazypath) <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">local</span> lazyrepo <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://github.com/folke/lazy.nvim.git&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">local</span> out <span style="color:#f92672">=</span> vim.fn.system { <span style="color:#e6db74">&#39;git&#39;</span>, <span style="color:#e6db74">&#39;clone&#39;</span>, <span style="color:#e6db74">&#39;--filter=blob:none&#39;</span>, <span style="color:#e6db74">&#39;--branch=stable&#39;</span>, lazyrepo, lazypath }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> vim.v.shell_error <span style="color:#f92672">~=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    error(<span style="color:#e6db74">&#39;Error cloning lazy.nvim:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">..</span> out)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">---@type vim.Option</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> rtp <span style="color:#f92672">=</span> vim.opt.rtp
</span></span><span style="display:flex;"><span>rtp:prepend(lazypath)
</span></span></code></pre></div><p>这段代码的含义，简单来说就是：</p>
<ul>
<li>创建一个lazypath作为这个插件管理器的老家
<ul>
<li>在linux系统中，通常就是<code>~/.local/share/nvim/lazy/lazy.nvim</code></li>
</ul>
</li>
<li>将lazy.nvim在github上的仓库克隆到lazypath</li>
<li>其余部分的代码基本是出于兼容性而写的（但是并非无用，这段代码的健壮性还是非常强的，能让你在绝大多数情况下都能至少保证lazy.nvim安装成功）</li>
</ul>
<p>这段代码基本唯一有价值的东西就是告诉你lazypath的老家在哪，实在有问题可能会要去检查那里的文件。但是通常而言用不到。而且你大概率也不会自己写这段代码，所以多数情况下忽视即可。</p>
<h3 id="插件">插件<a href="#%e6%8f%92%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>require(<span style="color:#e6db74">&#39;lazy&#39;</span>).setup({
</span></span></code></pre></div><p>从接下来开始就到了重头戏了，nvim的插件管理。</p>
<p>在我们kickstart nvim这个配置模版中，大几百行的代码都塞在了<code>require('lazy').setup({</code>这个巨大括号里。</p>
<p><code>require('lazy').setup()</code>接受的是两个参数，其中第一个参数就是一个巨大的lua table，里面放的是插件的“说明书”，第二个参数则是可选的，用来定制lazy.nvim自身的外观和行为。我们主要关注第一部分，即插件的“说明书”到底怎么写。</p>
<h4 id="插件说明书-plugin-specification">插件说明书 (Plugin Specification)<a href="#%e6%8f%92%e4%bb%b6%e8%af%b4%e6%98%8e%e4%b9%a6-plugin-specification" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>所谓的插件说明书，就是setup()中第一个参数table中的元素。每一个说明书就代表了一个插件。</p>
<p>一个插件说明书的职能大概有：</p>
<ul>
<li>让lazy.nvim去下载需要的插件</li>
<li>传递配置选项给插件</li>
<li>加载触发器来实现自动功能</li>
<li>设置自定义函数来配置插件（比如设置快捷键）</li>
<li>声明依赖项</li>
<li>设置加载条件</li>
<li>设置打开特定文件时加载插件</li>
<li>导入其他文件中的插件配置</li>
</ul>
<p>好吧，光看这些职能是没有用的，我们来以init.lua中提供的插件说明书来详细讲解。</p>
<h4 id="最简形式">最简形式<a href="#%e6%9c%80%e7%ae%80%e5%bd%a2%e5%bc%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;NMAC427/guess-indent.nvim&#39;</span>, <span style="color:#75715e">-- Detect tabstop and shiftwidth automatically</span>
</span></span></code></pre></div><p>没错，一个字符串就足够作为一个插件了。记得后面要加逗号。</p>
<p>这段代码的含义就是，到github上找到<code>NMAC427</code>这个用户的<code>guess-indent.nvim</code>这个仓库并下载下来，什么都不配置，直接用默认配置即可。这是最省事的写法。</p>
<p>但是多数时候，你为了更方便的使用插件，不得不进行一些相应的配置。这个时候，我们就要用到更加复杂的配置方式。</p>
<h4 id="常见形式">常见形式<a href="#%e5%b8%b8%e8%a7%81%e5%bd%a2%e5%bc%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>  <span style="color:#75715e">-- Use `opts = {}` to automatically pass options to a plugin&#39;s `setup()` function, forcing the plugin to be loaded.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">-- Alternatively, use `config = function() ... end` for full control over the configuration.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">-- If you prefer to call `setup` explicitly, use:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--    {</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--        &#39;lewis6991/gitsigns.nvim&#39;,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--        config = function()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--            require(&#39;gitsigns&#39;).setup({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--                -- Your gitsigns configuration here</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--            })</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--        end,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--    }</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">-- Here is a more advanced example where we pass configuration</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">-- options to `gitsigns.nvim`.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">-- See `:help gitsigns` to understand what the configuration keys do</span>
</span></span><span style="display:flex;"><span>  { <span style="color:#75715e">-- Adds git related signs to the gutter, as well as utilities for managing changes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;lewis6991/gitsigns.nvim&#39;</span>,
</span></span><span style="display:flex;"><span>    opts <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      signs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        add <span style="color:#f92672">=</span> { text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;+&#39;</span> },
</span></span><span style="display:flex;"><span>        change <span style="color:#f92672">=</span> { text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;~&#39;</span> },
</span></span><span style="display:flex;"><span>        delete <span style="color:#f92672">=</span> { text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;_&#39;</span> },
</span></span><span style="display:flex;"><span>        topdelete <span style="color:#f92672">=</span> { text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;‾&#39;</span> },
</span></span><span style="display:flex;"><span>        changedelete <span style="color:#f92672">=</span> { text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;~&#39;</span> },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  },
</span></span></code></pre></div><p>这是一个git图标插件，功能是在侧边栏显示当前文本中的改动增减。但是我们想要自定义显示的图标，那么我们就必须进行配置。</p>
<p>配置的方式如上，简单来说就是将插件说明书写成一个table。lua中table是唯一的组合数据结构，功能类似于js的对象，既能当哈希表或字典，又能当列表，还能作为类。如果想要写好lua程序，你将不得不直面这种身兼数职的境况。</p>
<p>在以上这段代码中，配置gitsigns时我们使用了<code>opts</code>这个配置键。这是最简洁的配置键，配置的选项又插件作者提供，插件加载完成后会自动调用你给出的配置。</p>
<p>其他的插件配置键我们暂且不谈，我们不妨先由一个简单而效果显著的插件配置出发，来自己手动完成一个配置：配色方案。</p>
<h3 id="配色方案配置">配色方案配置<a href="#%e9%85%8d%e8%89%b2%e6%96%b9%e6%a1%88%e9%85%8d%e7%bd%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>  { <span style="color:#75715e">-- You can easily change to a different colorscheme.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- Change the name of the colorscheme plugin below, and then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- change the command in the config to whatever the name of that colorscheme is.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- If you want to see what colorschemes are already installed, you can use `:Telescope colorscheme`.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;folke/tokyonight.nvim&#39;</span>,
</span></span><span style="display:flex;"><span>    priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>, <span style="color:#75715e">-- Make sure to load this before all the other start plugins.</span>
</span></span><span style="display:flex;"><span>    config <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">---@diagnostic disable-next-line: missing-fields</span>
</span></span><span style="display:flex;"><span>      require(<span style="color:#e6db74">&#39;tokyonight&#39;</span>).setup {
</span></span><span style="display:flex;"><span>        styles <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          comments <span style="color:#f92672">=</span> { italic <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span> }, <span style="color:#75715e">-- Disable italics in comments</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- Load the colorscheme here.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- Like many other themes, this one has different styles, and you could load</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- any other, such as &#39;tokyonight-storm&#39;, &#39;tokyonight-moon&#39;, or &#39;tokyonight-day&#39;.</span>
</span></span><span style="display:flex;"><span>      vim.cmd.colorscheme <span style="color:#e6db74">&#39;tokyonight-night&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>  },
</span></span></code></pre></div><p>在kickstart配置模版中，默认的配色方案长成这样。它下载的是tokyonight，一个我个人不是很喜欢的配色方案。所以我一定要把它改掉。</p>
<p>我们先来分析一下这段代码的组成：</p>
<ul>
<li><code>'folke/tokyonight.nvim',</code>作者+插件名，一个插件的最简形式。</li>
<li><code>priority = 1000,</code>设置优先级。颜色主题需要较高的优先级，这样才能保证在你看到任何界面元素之前，颜色主题已经加载完毕，使视觉体验更平滑。</li>
<li><code>require('tokyonight').setup</code>调用插件提供的标准配置函数</li>
<li><code>comments = { italic = false }</code>禁用注释斜体，这个功能在某些平台上表现不佳（比如我的termux）</li>
<li><code>vim.cmd.colorscheme 'tokyonight-night'</code>在完成前面的setup步骤后，让nvim真正开始加载这个颜色主题。</li>
</ul>
<p>那么我们现在就来修改这段代码，来改成我更喜欢的onedarkpro主题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;olimorris/onedarkpro.nvim&#39;</span>,
</span></span><span style="display:flex;"><span>    priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>    config <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span>      require(<span style="color:#e6db74">&#39;onedarkpro&#39;</span>).setup {
</span></span><span style="display:flex;"><span>        highlights <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          Comment <span style="color:#f92672">=</span> { italic <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span> },
</span></span><span style="display:flex;"><span>          Directory <span style="color:#f92672">=</span> { bold <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span> },
</span></span><span style="display:flex;"><span>          ErrorMsg <span style="color:#f92672">=</span> { italic <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>, bold <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span> },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      vim.cmd <span style="color:#e6db74">&#39;colorscheme onedark&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>  },
</span></span></code></pre></div><p>ok，当我保存退出再进入后，我就喜提新颜色主题了。</p>
<p>简单来说，这部分内容难点就在于：如果你不去深入了解配置文件的组成结构，你可能根本不知道github上给出的配置代码到底该放在哪。现在我们知道了，只需要把github上给出的配置代码塞进一个table里，再塞到<code>require('lazy').setup({</code>里即可。</p>
<p>颜色方案配置比较简单，因为它不涉及任何按键的设置。接下来我们来为我们的nvim添加一个“浮动终端”，就想一般的图形化界面ide那样在界面的中央弹出一个终端窗口，而非使用nvim原生的类似分屏的终端。</p>
<p>但是在开始之前，我们先进行一些准备工作：我们实际上应该把这些插件说明书分门别类的放在<code>lua/custom/plugins</code>目录下，而不是全部扁平化的放在init.lua中。让我们先把颜色方案的代码移动过去。</p>
<p>首先，我们看到<code>init.lua</code>中插件说明书的最后部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>  <span style="color:#75715e">-- note: the import below can automatically add your own plugins, configuration, etc from `lua/custom/plugins/*.lua`</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--    this is the easiest way to modularize your config.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--  uncomment the following line and add your plugins to `lua/custom/plugins/*.lua` to get going.</span>
</span></span><span style="display:flex;"><span>  { import <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;custom.plugins&#39;</span> },
</span></span></code></pre></div><p>这一部分中，<code>\{ import = 'custom.plugins' },</code>原本是注释起来的，将前面的注释符号删除，这样lazy.nvim就会自动去在custom/plugins目录下寻找插件说明书。</p>
<p>接着，输入以下指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nvim lua/custom/plugins/colorscheme.lua
</span></span></code></pre></div><p>这样我们就创建了一个专门存放配色方案的lua模块。将原本我们写在init.lua中的代码移植过来，并用<code>return{}</code>包裹，得到：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">--colorscheme.lua</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;olimorris/onedarkpro.nvim&#39;</span>,
</span></span><span style="display:flex;"><span>    priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>    config <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span>      require(<span style="color:#e6db74">&#39;onedarkpro&#39;</span>).setup {
</span></span><span style="display:flex;"><span>        highlights <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          Comment <span style="color:#f92672">=</span> { italic <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span> },
</span></span><span style="display:flex;"><span>          Directory <span style="color:#f92672">=</span> { bold <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span> },
</span></span><span style="display:flex;"><span>          ErrorMsg <span style="color:#f92672">=</span> { italic <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>, bold <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span> },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      vim.cmd <span style="color:#e6db74">&#39;colorscheme onedark&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>此时，重新打开nvim，配色方案应该依然工作正常。这就意味着你成功构建了一个插件说明书。</p>
<h4 id="浮动终端">浮动终端<a href="#%e6%b5%ae%e5%8a%a8%e7%bb%88%e7%ab%af" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>浮动终端的常用插件是<code>toggleterm.nvim</code>，简称toggle。</p>
<p>让我们先在plugins下创建一个专属于toggle的lua模块：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nvim lua/custom/plugins/toggleterm.lua
</span></span></code></pre></div><p>然后，让我写入插件的配置代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;akinsho/toggleterm.nvim&#39;</span>,
</span></span><span style="display:flex;"><span>  version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;*&#39;</span>,
</span></span><span style="display:flex;"><span>  config <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span>    require(<span style="color:#e6db74">&#39;toggleterm&#39;</span>).setup {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 设置终端窗口大小</span>
</span></span><span style="display:flex;"><span>      size <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(term)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> term.direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;horizontal&#39;</span> <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elseif</span> term.direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;vertical&#39;</span> <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> vim.o.columns <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 打开终端的快捷键，这里设置为 Ctrl + \</span>
</span></span><span style="display:flex;"><span>      open_mapping <span style="color:#f92672">=</span> <span style="color:#e6db74">[[&lt;c-\&gt;]]</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 隐藏 toggleterm buffer 中的行号</span>
</span></span><span style="display:flex;"><span>      hide_numbers <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 当 Neovim 目录切换时，终端下次打开也会切换到相应目录</span>
</span></span><span style="display:flex;"><span>      autochdir <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 设置终端窗口的背景色，可以根据你的主题进行调整</span>
</span></span><span style="display:flex;"><span>      highlights <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        Normal <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          guibg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;none&#39;</span>, <span style="color:#75715e">-- 这里设置为 &#34;none&#34; 表示使用默认背景</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        NormalFloat <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          link <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Normal&#39;</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 阴影效果，如果设置了上面的 highlights 中的 Normal，建议将此项设为 false</span>
</span></span><span style="display:flex;"><span>      shade_terminals <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 阴影的强度，数值越小越深</span>
</span></span><span style="display:flex;"><span>      shading_factor <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">30</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 启动时进入插入模式</span>
</span></span><span style="display:flex;"><span>      start_in_insert <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 在插入模式下也可以使用 open_mapping 打开终端</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- insert_mappings = true,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 在终端窗口中也可以使用 open_mapping (会覆盖一些终端默认行为)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- terminal_mappings = true,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 保持上次终端的大小</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- persist_size = true,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 终端进程退出时自动关闭窗口</span>
</span></span><span style="display:flex;"><span>      direction <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;float&#39;</span>, <span style="color:#75715e">-- 设置默认打开方式为浮动窗口</span>
</span></span><span style="display:flex;"><span>      close_on_exit <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 使用 Neovim 的默认 shell</span>
</span></span><span style="display:flex;"><span>      shell <span style="color:#f92672">=</span> vim.o.shell,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 自动滚动到底部</span>
</span></span><span style="display:flex;"><span>      auto_scroll <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 浮动窗口的设置</span>
</span></span><span style="display:flex;"><span>      float_opts <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">-- 边框样式</span>
</span></span><span style="display:flex;"><span>        border <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;curved&#39;</span>, <span style="color:#75715e">-- 使用圆角边框</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">-- 窗口透明度</span>
</span></span><span style="display:flex;"><span>        winblend <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- 设置一个函数，用于在 normal 模式下按下 &lt;esc&gt; 时退出终端</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_G</span>.<span style="color:#a6e22e">set_terminal_keymaps</span>()
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">local</span> opts <span style="color:#f92672">=</span> { buffer <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> }
</span></span><span style="display:flex;"><span>      vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;&lt;esc&gt;&#39;</span>, <span style="color:#e6db74">[[&lt;C-\&gt;&lt;C-n&gt;]]</span>, opts)
</span></span><span style="display:flex;"><span>      vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;jk&#39;</span>, <span style="color:#e6db74">[[&lt;C-\&gt;&lt;C-n&gt;]]</span>, opts) <span style="color:#75715e">-- jk 也可以退出</span>
</span></span><span style="display:flex;"><span>      vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-h&gt;&#39;</span>, <span style="color:#e6db74">[[&lt;Cmd&gt;wincmd h&lt;CR&gt;]]</span>, opts)
</span></span><span style="display:flex;"><span>      vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-j&gt;&#39;</span>, <span style="color:#e6db74">[[&lt;Cmd&gt;wincmd j&lt;CR&gt;]]</span>, opts)
</span></span><span style="display:flex;"><span>      vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-k&gt;&#39;</span>, <span style="color:#e6db74">[[&lt;Cmd&gt;wincmd k&lt;CR&gt;]]</span>, opts)
</span></span><span style="display:flex;"><span>      vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-l&gt;&#39;</span>, <span style="color:#e6db74">[[&lt;Cmd&gt;wincmd l&lt;CR&gt;]]</span>, opts)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- 当打开终端时，自动应用上面的快捷键设置</span>
</span></span><span style="display:flex;"><span>    vim.cmd(<span style="color:#e6db74">&#39;autocmd! TermOpen term://* lua set_terminal_keymaps()&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- 定义一个快捷键，方便地打开一个 LazyGit 终端</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> Terminal <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;toggleterm.terminal&#39;</span>).Terminal
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> lazygit <span style="color:#f92672">=</span> Terminal:new({
</span></span><span style="display:flex;"><span>      cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lazygit&#34;</span>,
</span></span><span style="display:flex;"><span>      hidden <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      direction <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;float&#34;</span>,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_LAZYGIT_TOGGLE</span>()
</span></span><span style="display:flex;"><span>      lazygit:toggle()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    vim.keymap.set(<span style="color:#e6db74">&#34;n&#34;</span>, <span style="color:#e6db74">&#34;&lt;leader&gt;gg&#34;</span>, <span style="color:#e6db74">&#34;&lt;cmd&gt;lua _LAZYGIT_TOGGLE()&lt;CR&gt;&#34;</span>, {
</span></span><span style="display:flex;"><span>        noremap <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        silent <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Lazygit&#34;</span>,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在了解了原理之后，和ai交流的难度显著下降了。我得到了一套非常棒的配置，甚至帮我添加了lazygit的界面。效果非常帅。</p>
<p>这时候保存退出，再重进，你就应该可以通过你设置的快捷键来打开toggle终端了。</p>
<hr>
<p>看到这里，你已经可以完全自己上手去解决插件配置问题了。实际上，你基本不需要自己写代码，你只要能读的懂一点代码就行，你只需要把github上插件作者提供的配置样例丢给ai让它生成一个涵盖了大多数功能的配置，再依据自己的需求进行删改即可。</p>
]]></content>
		</item>
		
		<item>
			<title>Neovim配置如何入门</title>
			<link>http://localhost:1313/zh-cn/posts/neovim%E9%85%8D%E7%BD%AE%E5%A6%82%E4%BD%95%E5%85%A5%E9%97%A8/</link>
			<pubDate>Sun, 23 Nov 2025 10:53:11 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/neovim%E9%85%8D%E7%BD%AE%E5%A6%82%E4%BD%95%E5%85%A5%E9%97%A8/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>如题。neovim因为自定义程度过高导致学习曲线极其陡峭，虽然功能很强大但是配置过程极其折磨，尤其是当你对于neovim配置的原理毫无概念的时候。</p>
<p>闲言少叙，我尝试来总结一下如何快速入门并配置一个能用的neovim。（后记：在学习完如何配置nvim之后，你实际应该做的是去用lazyvim。lazyvim的lazyextra功能直接优化掉了nvim最反人类的lsp配置过程，如果你有生活，不要尝试自己配置lsp。但是如果你想在使用lazyvim时可以轻松应对各种插件问题，你最好学一下nvim插件配置的通用原理，即我下文中会讲到的。）</p>
<hr>
<h2 id="nvim配置原理">Nvim配置原理<a href="#nvim%e9%85%8d%e7%bd%ae%e5%8e%9f%e7%90%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>neovim是一个文本编辑器，完全可以运行在终端中，无需给它一个桌面环境。你可以按照自己的需求给它添加对特定编程语言的支持，添加语法高亮、自动补全等功能，或者切换颜色主题。它非常轻量，运行飞速，极其贴近代码的原生环境，并且可以运行在任何一台看起来像电脑的机器上。</p>
<p>但是代价是，这一切都必须通过你自己手动配置来完成。Neovim并不是一个开箱即用的软件，即使你使用一些诸如Nvchad或者Lazyvim这样的预配置版本，很多功能还是必须要你自己手动添加。</p>
<p>通常，一个neovim的配置文件目录如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>~/.config/nvim/
</span></span><span style="display:flex;"><span>├── init.lua
</span></span><span style="display:flex;"><span>└── lua/
</span></span><span style="display:flex;"><span>    ├── config/
</span></span><span style="display:flex;"><span>    │   ├── options.lua
</span></span><span style="display:flex;"><span>    │   ├── keymaps.lua
</span></span><span style="display:flex;"><span>    │   └── autocmds.lua
</span></span><span style="display:flex;"><span>    └── plugins/
</span></span><span style="display:flex;"><span>        ├── init.lua       （可选）
</span></span><span style="display:flex;"><span>        ├── lualine.lua
</span></span><span style="display:flex;"><span>        ├── treesitter.lua
</span></span><span style="display:flex;"><span>        └── ……
</span></span></code></pre></div><p>乍一看，你可能会觉得很复杂。其实不然，因为lua目录下的文件实际都是自己想怎么加就怎么加的，真正限定的结构只有根目录下的init.lua和lua这个文件夹。只不过通常而言我们会在lua文件夹下创建这些文件结构，方便我们管理自己加入的插件以及相应配置。</p>
<p>正如你所见，nvim的配置文件全部都使用的是lua语言。但是不用有太高的心理负担，因为这是一个语法甚至比python还要简单的语言。nvim配置过程就相当于构建一个自己的lua语言程序，你需要自己组织其文件结构来让neovim知道如何使用你的配置。</p>
<p>所以显然，在你开始配置nvim之前，你最好能了解一下lua语言的用法。不过也不用着急，你可以接着看，遇到不懂的点再去深入了解。</p>
<hr>
<h3 id="kickstart">kickstart<a href="#kickstart" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><a href="https://github.com/nvim-lua/kickstart.nvim">kickstart链接</a>
这是并不是一个neovim发行版，它只是一套配置文件。严谨的说，它是nvim官方维护的一个学习版nvim配置框架。它使用了lazy. nvim这一插件管理器（注意：这和lazyvim完全不是一回事），但是和lazyvim是完全不一样的两个东西，后者是一个“开箱即用”的nvim框架（但也不那么开箱即用）。</p>
<p>你仍然需要安装nvim。kickstart只是提供了清晰的配置文件，方便初学者快速了解如何配置nvim。我们接下来也会以kickvim提供的init.lua为例讲解neovim可供配置的内容。</p>
<h4 id="安装neovim">安装neovim<a href="#%e5%ae%89%e8%a3%85neovim" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>显然，如果我们想要使用neovim，我们需要先安装它。你可以安装任意你想要的版本，不过这里我们选择Nvim 0.11.5。kickstart要求nvim版本为最新的稳定版，或者每日夜晚自动编译得到的不经过稳定性测试的Nightly版，我们此处使用的是最新的稳定版。</p>
<p>对于大部分普通电脑，cpu采用x86_64架构，你需要下载nvim-linux-x86_64.tar.gz。这是软件文件的压缩包，你需要把它移动到你想要它存在的文件目录下，然后在该目录下执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tar xzvf nvim-linux-x86_64.tar.gz <span style="color:#75715e">#或者你实际下载的压缩包</span>
</span></span></code></pre></div><p>我这边使用的是termux，平板、手机一般cpu架构是arm64，所以我下载的是nvim-linux-arm64.tar.gz。执行相同命令解压之后得到一个同名文件夹。此时，输入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./nvim-linux-x86_64/bin/nvim <span style="color:#75715e">#注意第一个应当是你实际下载的版本</span>
</span></span></code></pre></div><p>通常来说，这个时候你就会进入一个nvim的默认的黑白界面。这就意味着你neovim安装成功了。</p>
<p>此外，为了使用方便，你最好还要安装一些剪切板工具，如xclip，以及Nerd Font，用来显示更美观的图标。此部分自行参考相应的文档自己选择进行。</p>
<h4 id="kickstart安装">kickstart安装<a href="#kickstart%e5%ae%89%e8%a3%85" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>现在我们来安装kickstart。在kickstart的文档中，开发者提示说可以将这个kickstart仓库复刻一份到你自己的仓库下，这样你可以通过git来管理你的配置。</p>
<p>如果你懒得复刻一份，直接输入这个指令，kickstart就会开始自动安装（后记：这里你最好记住这个文件位置~/.config/nvim，因为你之后折腾配置的时候要经常打开它）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/nvim-lua/kickstart.nvim.git <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>XDG_CONFIG_HOME<span style="color:#66d9ef">:-</span>$HOME/.config<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/nvim
</span></span></code></pre></div><p>如果复刻了一份到自己的仓库，直接从自己的仓库克隆即可。</p>
<p>在下载好后，再次输入<code>nvim</code>，如果一切正常，你就会看见一堆进度条，一堆看不懂的东西安装完后，界面显示出Tokyo night的配色方案，这就意味着你安装成功了。</p>
<h4 id="可能遇到的问题">可能遇到的问题<a href="#%e5%8f%af%e8%83%bd%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>在某些平台上，stylua或者一些其他插件并没有提供预编译版，这意味着Mason（你可以理解为nvim的包管理器，自动安装、管理各种开发工具）无法自动安装这些工具。你需要自行编译安装。其中比较推荐的是使用<strong>世界上最好的包管理器</strong>cargo来进行编译安装。</p>
<p>要使用cargo，你需要先安装rust。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>pkg install rust <span style="color:#75715e">#这里开头需要用你自己实际的包管理器</span>
</span></span></code></pre></div><p>安装完后，输入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cargo install stylua
</span></span></code></pre></div><p>如果没有意外的话，下载成功后二进制文件会位于<code>~/.cargo/bin/stylua</code>（cargo理论上会给出提示）。在<code>~/.bashrc</code>或者<code>~/.zshrc</code>中加入一行<code>export PATH=&quot;$HOME/.cargo/bin:$PATH&quot;</code> 退出后输入<code>source ~/.bashrc</code>或者<code>source ~/.zshrc</code>，之后按理来说stylua就已经可以工作了。</p>
<p>但是这个时候，Mason可能会因为只识别Mason安装的stylua而导致进入nvim后依然报错。你可以:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nvim ~/.config/nvim/init.lua
</span></span></code></pre></div><p>这就是我们一会会讲到的文件，里面罗列了所有你可能会用到的配置文本。在其中大概718行的位置，你可以找到：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>require(<span style="color:#e6db74">&#34;mason-tool-installer&#34;</span>).setup {
</span></span><span style="display:flex;"><span>  ensure_installed <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- 删掉 stylua 或者不要写</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>正如上文中的注释，此处本来应该有stylua相关的内容。将它删掉或者注释掉即可。保存退出，再次进入nvim，此时就不会有stylua报错了。你可以通过<code>:!which stylua</code>来验证nvim可以找到stylua应用。</p>
<p>除stylua外，还有一些包也可能会因为环境缘故无法直接通过mason安装，不再一一列举。</p>
<p>如果你遇到无法解决的问题，你可以暂时先放一放，继续阅读。之后仍然无法解决，则去求助ai或者其他博客。</p>
<hr>
<h3 id="initlua">init.lua<a href="#initlua" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>现在，我们终于可以进入根目录的init.lua了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nvim ~/.config/nvim/init.lua
</span></span></code></pre></div><p>如果一切顺利，你会进入一个1000多行的文件，这就是kickstart的配置模版。接下来我们会逐段分析这个配置模版。</p>
<h3 id="开头部分">开头部分<a href="#%e5%bc%80%e5%a4%b4%e9%83%a8%e5%88%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<pre tabindex="0"><code>=====================================================================
==================== READ THIS BEFORE CONTINUING ====================
=====================================================================
========                                    .-----.          ========
========         .----------------------.   | === |          ========
========         |.-&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;-.|   |-----|          ========
========         ||                    ||   | === |          ========
========         ||   KICKSTART.NVIM   ||   |-----|          ========
========         ||                    ||   | === |          ========
========         ||                    ||   |-----|          ========
========         ||:Tutor              ||   |:::::|          ========
========         |&#39;-..................-&#39;|   |____o|          ========
========         `&#34;&#34;)----------------(&#34;&#34;`   ___________      ========
========        /::::::::::|  |::::::::::\  \ no mouse \     ========
========       /:::========|  |==hjkl==:::\  \ required \    ========
========      &#39;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#39;  &#39;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#39;  &#39;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#39;   ========
========                                                     ========
=====================================================================
=====================================================================

What is Kickstart?

  Kickstart.nvim is *not* a distribution.

  Kickstart.nvim is a starting point for your own configuration.
    The goal is that you can read every line of code, top-to-bottom, understand
    what your configuration is doing, and modify it to suit your needs.

    Once you&#39;ve done that, you can start exploring, configuring and tinkering to
    make Neovim your own! That might mean leaving Kickstart just the way it is for a while
    or immediately breaking it into modular pieces. It&#39;s up to you!

    If you don&#39;t know anything about Lua, I recommend taking some time to read through
    a guide. One possible example which will only take 10-15 minutes:
      - https://learnxinyminutes.com/docs/lua/

    After understanding a bit more about Lua, you can use `:help lua-guide` as a
    reference for how Neovim integrates Lua.
    - :help lua-guide
    - (or HTML version): https://neovim.io/doc/user/lua-guide.html
</code></pre><p>简单总结，就是告诉你这不是一个neovim发行版，只是一个模版框架。其中它给出的一个10-15min学习lua的网站 <a href="https://learnxinyminutes.com/zh-cn/lua/">https://learnxinyminutes.com/zh-cn/lua/</a> 非常有用，可以帮助你快速掌握使用lua的关键知识。lua并不是一个复杂的语言，甚至比python还要简单的多。下面我简单罗列一些我们可能会用到的lua知识。</p>
<h3 id="一些必须的lua基础知识">一些必须的lua基础知识<a href="#%e4%b8%80%e4%ba%9b%e5%bf%85%e9%a1%bb%e7%9a%84lua%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<h4 id="local关键字">local关键字<a href="#local%e5%85%b3%e9%94%ae%e5%ad%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>在lua当中，如果不使用local声明，变量就会被视为全局变量。在声明函数之前加上local被视为是lua编程的良好风格。</p>
<h4 id="require关键字">require关键字<a href="#require%e5%85%b3%e9%94%ae%e5%ad%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>这个关键字非常重要，它的作用是加载和使用模块。简单来说，你的配置文件可能有复杂的结构，但是neovim并不能全自动地去搜索所有的.lua文件。正如很多其他语言只有一个main.xx文件一样，lua通常而言也只有一个主文件，你需要在这个主文件中引用其他文件的内容。</p>
<p>在我个人看来，lua的文件组织方式和python有许多相似之处。两者都将单个的.lua文件或者.py文件看做一个&quot;模块&quot;，不同功能的模块之间除了文件内容之外没有文件后缀名或者文件名的限制。但是python和lua在一些细节的机制上还是有所不同。</p>
<p>python的模块导出机制可以看做是“默认导出”。一个python模块文件（即一个.py文件）所有的顶级变量、函数、类全都是公开的。比如你在<code>utils.py</code>中写了一个名为<code>myfunction()</code>的函数，你想在另一个.py文件中使用这个函数，你只需要先<code>import utils</code>，再写<code>utils.myfunction()</code>即可。可以说，python的每个单独的.py文件都是一个“命名空间”，就像namespace std一样。</p>
<p>但是lua采用了一个与此区别较大的管理方式。简单来说，lua的所有内容都是“私有的”，如果你想让别的.lua文件使用这个.lua文件中的函数等内容，你需要把这些东西“打包发出去”。理解这点对于配置neovim非常关键。</p>
<p>我们下面来看一个简单的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- shopping.lua</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- (上面的 local 函数和变量定义)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 1. 手动创建一个空的“储物柜” (table)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> M <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 2. 手动把要公开的东西放进去</span>
</span></span><span style="display:flex;"><span>M.buy_apple <span style="color:#f92672">=</span> buy_apple <span style="color:#75715e">--这是一个shopping.lua中定义的函数</span>
</span></span><span style="display:flex;"><span>M.PRICE_PER_APPLE <span style="color:#f92672">=</span> PRICE_PER_APPLE <span style="color:#75715e">--这是一个shopping.lua中定义的变量</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 注意：我们故意不把 buy_banana 放进去</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 3. 把这个填充好的储物柜作为模块的出口</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> M
</span></span></code></pre></div><p>当我们想从另一个.lua中调用shopping.lua中的函数或者变量时，我们需要这么写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> shopping <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;shopping&#39;</span>) <span style="color:#75715e">--此处就用到了require</span>
</span></span></code></pre></div><p>这时候，我们就在这个.lua文件中定义了一个变量，名字叫<code>shopping</code>。它的内容是什么呢？很简单，就是shopping.lua中最后“打包”好的M这个table。</p>
<p>此时，如果你想买苹果，你就写<code>shopping.buy_apple()</code>，如果你想知道苹果的单价，那你就写<code>shopping.PRICE_PER_APPLE</code>。但是你没办法买香蕉，因为你在shopping.lua中没有把buy_banana()打包发出去。</p>
<p>读到这里，你基本上已经明白了lua的模块管理机制了，但是还不够（因为接下来的内容同样非常重要）。lua并不能完全自动地搜索根目录下匹配名称的.lua文件，而是遵循着一种“内部搜索顺序”。简单来说，这个内部搜索顺序就是一堆相对路径，lua文件运行时会挨个搜索这些路径去找符合条件的.lua文件（比如我们前文写的shopping.lua)，如果它在按照内部搜索顺序寻找无果，那么，它就会报错。</p>
<p>这点之所以重要，就是因为有的时候你必须要让neovim知道它需要的文件到底在哪，但是这个工作是没办法交给ai的，因为你没办法把整个项目都发给ai，ai凭刻板印象给出的代码在解决这类问题时通常无法正常工作，因为它根本不了解你到底把什么文件放在哪了（甚至你自己也很可能未必知道自己需要的文件在哪）。这个时候再把问题发给ai让它解决，ai就会继续给你一个更错的答案，最后恶性循环。（别问我是怎么知道的）</p>
<p>下面我来详细讲解一下“内置搜索顺序”的机制。</p>
<h4 id="内置搜索顺序">内置搜索顺序<a href="#%e5%86%85%e7%bd%ae%e6%90%9c%e7%b4%a2%e9%a1%ba%e5%ba%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>lua中用于搜索lua模块的路径变量称为“packege.path”，存储在内置的package表中。</p>
<p>它们通常长成这样：</p>
<pre tabindex="0"><code>./?.lua;./?/init.lua;/usr/local/share/lua/5.4/?.lua;/usr/local/share/lua/5.4/?/init.lua;...
</code></pre><p>其中，分号分隔了不同的路径，<code>?</code>代表此处会被自动替换为你<code>require</code>中填写的内容。</p>
<p>例如，假设你执行了 require(&lsquo;socket.core&rsquo;)，Lua 会：</p>
<ol>
<li>将模块名中的 . 替换为目录分隔符（如 / 或 \）。所以 socket.core 变成了 socket/core。</li>
<li>然后用 socket/core 替换掉 package.path 中每个模板的 ?，并依次检查文件是否存在：
<ul>
<li>./socket/core.lua (在当前目录下找)</li>
<li>./socket/core/init.lua (在当前目录下的 socket 目录中找 init.lua)</li>
<li>/usr/local/share/lua/5.4/socket/core.lua (在标准的 Lua 库目录下找)</li>
<li>/usr/local/share/lua/5.4/socket/core/init.lua (在标准的 Lua 库目录的子目录中找)</li>
<li>&hellip;等等，直到找到一个存在的文件为止。</li>
</ul>
</li>
</ol>
<p>一旦找到，lua就会执行这个文件并返回结果（在我们前文的例子中，返回的就是打包好的函数和变量），如果找不到，require就会报错。</p>
<p>那么，当我们需要去寻找一个不在默认搜索路径中的文件该怎么做呢？</p>
<p>下面我们举一个简单的例子:</p>
<hr>
<p>首先，让我们在随便一个测试用的文件夹中创建以下文件结构：</p>
<pre tabindex="0"><code>.
├── libs
│   └── myutils.lua
└── main.lua
</code></pre><p>然后，让我们在<code>myutils.lua</code>中随便写一点测试用的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- libs/myutils.lua</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 创建一个 table 用于导出</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> M <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">M</span>.<span style="color:#a6e22e">greet</span>(name)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello, &#34;</span> <span style="color:#f92672">..</span> name <span style="color:#f92672">..</span> <span style="color:#e6db74">&#34;! Welcome to our module.&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 导出这个 table</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> M
</span></span></code></pre></div><p>然后，我们来在<code>main.lua</code>中写一个<strong>错误</strong>的模块调用代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- main.lua</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Attempting to load the &#39;myutils&#39; module...&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 尝试加载位于 libs 文件夹中的 myutils 模块</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 注意：我们直接写 &#39;myutils&#39; 而不是 &#39;libs.myutils&#39;，因为 &#39;libs&#39; 只是一个普通文件夹，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 并不是 Lua 的包名。我们需要让 Lua 知道要去 &#39;libs&#39; 这个文件夹里找。</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> utils <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;myutils&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 如果加载成功，就使用它的功能</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> message <span style="color:#f92672">=</span> utils.greet(<span style="color:#e6db74">&#34;Alice&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Successfully loaded module!&#34;</span>)
</span></span><span style="display:flex;"><span>print(message)
</span></span></code></pre></div><p>这段代码是ai写的。你可能会对其中的注释感到疑惑，我来尝试解答一下：</p>
<ul>
<li>直接写<code>require('libs.myutils')</code>其实是可以正常工作的，但是这并不利于维护。我们希望让lua自己通过package path去寻找所需要的模块，而代码中应该只考虑需要什么模块。如果我们在require中强行写入物理位置，虽然可以工作，但是一旦我们调整了文件位置，就不得不修改整个程序中所有从libs中调用模块的代码，这样做非常的低效。</li>
<li>在这段代码中，我们构建了一个无法通过package path找到所需模版的main.lua，这完全是反面例子。后文我们会给出修改。</li>
</ul>
<p>保存退出，输入<code>lua main.lua</code>，你就会喜提报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ lua main.lua
</span></span><span style="display:flex;"><span>Attempting to load the <span style="color:#e6db74">&#39;myutils&#39;</span> module...
</span></span><span style="display:flex;"><span>lua: main.lua:8: module <span style="color:#e6db74">&#39;myutils&#39;</span> not found:
</span></span><span style="display:flex;"><span>        no field package.preload<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;myutils&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;/data/data/com.termux/files/usr/share/lua/5.3/myutils.lua&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;/data/data/com.termux/files/usr/share/lua/5.3/myutils/init.lua&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;/data/data/com.termux/files/usr/lib/lua/5.3/myutils.lua&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;/data/data/com.termux/files/usr/lib/lua/5.3/myutils/init.lua&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;./myutils.lua&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;./myutils/init.lua&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;/data/data/com.termux/files/usr/lib/lua/5.3/myutils.so&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;/data/data/com.termux/files/usr/lib/lua/5.3/loadall.so&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;./myutils.so&#39;</span>
</span></span><span style="display:flex;"><span>stack traceback:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>C<span style="color:#f92672">]</span>: in <span style="color:#66d9ef">function</span> <span style="color:#e6db74">&#39;require&#39;</span>
</span></span><span style="display:flex;"><span>        main.lua:8: in main chunk
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>C<span style="color:#f92672">]</span>: in ?
</span></span></code></pre></div><p>这样的报错信息会在你配置nvim过程中时常出现（如果你完全不关心背后的原理）。</p>
<p>从报错信息中，你会看到lua查找了所有的内部搜索路径，但是都找不到你要的<code>myutils.lua</code>这个模块，因为你把它放在了libs下，lua根本不知道还有这个地方。</p>
<p>那么如何解决呢？很简单，我们只需要让<code>main.lua</code>把<code>libs</code>添加到package path中就行。</p>
<p>将<code>main.lua</code>修改为以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- main.lua</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;--- Experiment 2: Modifying package.path in script ---&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 打印修改前的 path，方便对比</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Original package.path:&#34;</span>)
</span></span><span style="display:flex;"><span>print(package.path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 将我们的 libs 目录添加到搜索路径的最前面</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- &#39;./libs/?.lua&#39; 是一个模板，&#39;?&#39; 会被 require 的模块名替换</span>
</span></span><span style="display:flex;"><span>package.path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;./libs/?.lua;&#39;</span> <span style="color:#f92672">..</span> package.path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Modified package.path:&#34;</span>)
</span></span><span style="display:flex;"><span>print(package.path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Attempting to load the &#39;myutils&#39; module...&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> utils <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;myutils&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> message <span style="color:#f92672">=</span> utils.greet(<span style="color:#e6db74">&#34;Bob&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Successfully loaded module!&#34;</span>)
</span></span><span style="display:flex;"><span>print(message)
</span></span></code></pre></div><p>再次退出，输入<code>lua main.lua</code>你就可以得到想要的内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ lua main.lua
</span></span><span style="display:flex;"><span>--- Experiment 2: Modifying package.path in script ---
</span></span><span style="display:flex;"><span>Original package.path:
</span></span><span style="display:flex;"><span>/data/data/com.termux/files/usr/share/lua/5.3/?.lua;/data/data/com.termux/files/usr/share/lua/5.3/?/init.lua;/data/data/com.termux/files/usr/lib/lua/5.3/?.lua;/data/data/com.termux/files/usr/lib/lua/5.3/?/init.lua;./?.lua;./?/init.lua
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Modified package.path:
</span></span><span style="display:flex;"><span>./libs/?.lua;/data/data/com.termux/files/usr/share/lua/5.3/?.lua;/data/data/com.termux/files/usr/share/lua/5.3/?/init.lua;/data/data/com.termux/files/usr/lib/lua/5.3/?.lua;/data/data/com.termux/files/usr/lib/lua/5.3/?/init.lua;./?.lua;./?/init.lua
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Attempting to load the <span style="color:#e6db74">&#39;myutils&#39;</span> module...
</span></span><span style="display:flex;"><span>Successfully loaded module!
</span></span><span style="display:flex;"><span>Hello, Bob! Welcome to our module.
</span></span></code></pre></div><p>注：以上是我在termux中运行的信息，其他平台上显示的path可能会有所区别。</p>
<p>我们打印了修改前后package.path的内容，显然，在<code>Modified package.path</code>中第一个搜索路径就是我们添加的<code>./libs/?.lua</code>，此时我们也确实成功使用了<code>myutils.lua</code>中的函数。</p>
<p>怎么做到的呢？让我们来仔细看一下我们修改的核心内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- 将我们的 libs 目录添加到搜索路径的最前面 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- &#39;./libs/?.lua&#39; 是一个模板，&#39;?&#39; 会被 require 的模块名替换 </span>
</span></span><span style="display:flex;"><span>package.path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;./libs/?.lua;&#39;</span> <span style="color:#f92672">..</span> package.path
</span></span></code></pre></div><p><code>..</code>在lua中表示字符串连接。这段代码的含义非常清晰：在<code>package.path</code>这个字符串前面加上我们需要的搜索路径。就这么简单。<code>package.path</code>本质就是一个字符串，你可以随意的根据需要修改本工程的搜索路径。</p>
<p>除此之外，如果你的所有lua工程都采用基本一致的文件结构，你可以把你需要的自定义的搜索路径写入环境变量中。比如你可以在终端中输入<code>export LUA_PATH=&quot;./libs/?.lua;;&quot;</code>，其中<code>;;</code>意味着保留原本的路径。这时候，即使你不在<code>main.lua</code>开头编辑<code>package.path</code>，lua也会自动找到libs下的myutils.lua，因为所需要的搜索路径已经成为一个环境的一部分了。</p>
<p>但是如果你希望自己的代码可以一次写入、处处运行，那么我建议你还是老老实实的把所需要的搜索路径写在开头，以便在不同环境中都可以使用。</p>
<hr>
<p>讲到这里，我们大概理解了lua的工作原理，现在让我们继续阅读根目录下的init.lua文件。</p>
<h4 id="正式开始分析initlua">正式开始分析init.lua<a href="#%e6%ad%a3%e5%bc%8f%e5%bc%80%e5%a7%8b%e5%88%86%e6%9e%90initlua" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>Kickstart Guide:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  TODO: The very first thing you should <span style="color:#66d9ef">do</span> is to run the command <span style="color:#960050;background-color:#1e0010">`</span>:Tutor<span style="color:#960050;background-color:#1e0010">`</span> <span style="color:#66d9ef">in</span> Neovim.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    If you don<span style="color:#e6db74">&#39;t know what this means, type the following:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &lt;escape key&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - :
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - Tutor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &lt;enter key&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    (If you already know the Neovim basics, you can skip this step.)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Once you&#39;</span>ve completed that, you can continue working through <span style="color:#f92672">**</span>AND READING<span style="color:#f92672">**</span> the rest
</span></span><span style="display:flex;"><span>  of the kickstart init.lua.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Next, run AND READ <span style="color:#960050;background-color:#1e0010">`</span>:help<span style="color:#960050;background-color:#1e0010">`</span>.
</span></span><span style="display:flex;"><span>    This will open up a help window with some basic information
</span></span><span style="display:flex;"><span>    about reading, navigating <span style="color:#f92672">and</span> searching the builtin help documentation.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    This should be the first place you go to look when you<span style="color:#e6db74">&#39;re stuck or confused
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    with something. It&#39;</span>s one of my favorite Neovim features.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MOST IMPORTANTLY, we provide a keymap <span style="color:#e6db74">&#34;&lt;space&gt;sh&#34;</span> to [s]earch the [h]elp documentation,
</span></span><span style="display:flex;"><span>    which is very useful when you<span style="color:#e6db74">&#39;re not exactly sure of what you&#39;</span>re looking <span style="color:#66d9ef">for</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  I have left several <span style="color:#960050;background-color:#1e0010">`</span>:help X<span style="color:#960050;background-color:#1e0010">`</span> comments throughout the init.lua
</span></span><span style="display:flex;"><span>    These are hints about where to find more information about the relevant settings,
</span></span><span style="display:flex;"><span>    plugins <span style="color:#f92672">or</span> Neovim features used <span style="color:#66d9ef">in</span> Kickstart.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   NOTE: Look <span style="color:#66d9ef">for</span> lines like this
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Throughout the file. These are <span style="color:#66d9ef">for</span> you, the reader, to help you understand what is happening.
</span></span><span style="display:flex;"><span>    Feel free to delete them once you know what you<span style="color:#e6db74">&#39;re doing, but they should serve as a guide
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for when you are first encountering a few different constructs in your Neovim config.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">If you experience any errors while trying to install kickstart, run `:checkhealth` for more info.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">I hope you enjoy your Neovim journey,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- TJ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">P.S. You can delete this when you&#39;</span>re done too. It<span style="color:#e6db74">&#39;s your config now! :)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--]]
</span></span></span></code></pre></div><p>总结一下：</p>
<ul>
<li>你可以在普通模式下<code>:Tutor</code>来进入一个neovim的使用教程，告诉你这个软件的基本使用方式。
<ul>
<li>vim的使用方式可以非常花哨，内置的指令多的数不过来。遗憾的是我只会其中最基本的几个指令，但是这通常来讲已经足够了。你不需要为了少按几个上下左右而去背一大堆指令，这样做有用，但是对于一个入门的人来说完全没有必要。</li>
</ul>
</li>
<li>你可以在普通模式下<code>:help</code>来查看帮助。里面罗列了nvim支持的各种功能，以及一些基本的使用方式。这就是一部使用说明书，就和你买的家用电器里附带的说明书是一个性质。</li>
<li>你可以<code>&lt;space&gt;+s+h</code>来进入一个帮助搜索界面。（然而我不会用）</li>
<li>文件剩余的内容都随便你配置。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- Set &lt;space&gt; as the leader key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- See `:help mapleader`</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  NOTE: Must happen before plugins are loaded (otherwise wrong leader will be used)</span>
</span></span><span style="display:flex;"><span>vim.g.mapleader <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39; &#39;</span>
</span></span><span style="display:flex;"><span>vim.g.maplocalleader <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39; &#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Set to true if you have a Nerd Font installed and selected in the terminal</span>
</span></span><span style="display:flex;"><span>vim.g.have_nerd_font <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><ul>
<li><code>vim.g</code>：代表全局变量。这里设置的变量在全局都有效。</li>
<li><code>vim.g.mapleader = ' '</code>：将空格键设置为“前导键”，用来作为一个通用的快捷键前缀。</li>
<li><code>vim.g.maplocalleader = ' '</code>：局部映射，简单来说就是只在某些文件中才会生效的“前导键”，之后<code>&lt;localleader&gt;x</code>就表示只在此情况下才生效的快捷键。</li>
<li><code>vim.g.have_nerd_font = false</code>：声明你的终端环境有没有安装Nerd Font。很多nvim的插件需要nerd font来支持一些复杂的图形界面，如果你没有安装nerd font，通过在这里声明false，那些插件就会只显示一些普通文本来适配你的环境。
<ul>
<li>如果你安装了nerd font，记得把这个变量设置为true。</li>
</ul>
</li>
</ul>
<h5 id="setting-options">setting options<a href="#setting-options" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- [[ Setting options ]]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- See `:help vim.o`</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- NOTE: You can change these options as you wish!</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  For more options, you can see `:help option-list`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Make line numbers default</span>
</span></span><span style="display:flex;"><span>vim.o.number <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- You can also add relative line numbers, to help with jumping.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  Experiment for yourself to see if you like it!</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.o.relativenumber = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Enable mouse mode, can be useful for resizing splits for example!</span>
</span></span><span style="display:flex;"><span>vim.o.mouse <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;a&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Don&#39;t show the mode, since it&#39;s already in the status line</span>
</span></span><span style="display:flex;"><span>vim.o.showmode <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Sync clipboard between OS and Neovim.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  Schedule the setting after `UiEnter` because it can increase startup-time.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  Remove this option if you want your OS clipboard to remain independent.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  See `:help &#39;clipboard&#39;`</span>
</span></span><span style="display:flex;"><span>vim.schedule(<span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span>  vim.o.clipboard <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;unnamedplus&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Enable break indent</span>
</span></span><span style="display:flex;"><span>vim.o.breakindent <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Save undo history</span>
</span></span><span style="display:flex;"><span>vim.o.undofile <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Case-insensitive searching UNLESS \C or one or more capital letters in the search term</span>
</span></span><span style="display:flex;"><span>vim.o.ignorecase <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>vim.o.smartcase <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Keep signcolumn on by default</span>
</span></span><span style="display:flex;"><span>vim.o.signcolumn <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;yes&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Decrease update time</span>
</span></span><span style="display:flex;"><span>vim.o.updatetime <span style="color:#f92672">=</span> <span style="color:#ae81ff">250</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Decrease mapped sequence wait time</span>
</span></span><span style="display:flex;"><span>vim.o.timeoutlen <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Configure how new splits should be opened</span>
</span></span><span style="display:flex;"><span>vim.o.splitright <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>vim.o.splitbelow <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Sets how neovim will display certain whitespace characters in the editor.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  See `:help &#39;list&#39;`</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  and `:help &#39;listchars&#39;`</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  Notice listchars is set using `vim.opt` instead of `vim.o`.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  It is very similar to `vim.o` but offers an interface for conveniently interacting with tables.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--   See `:help lua-options`</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--   and `:help lua-options-guide`</span>
</span></span><span style="display:flex;"><span>vim.o.list <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>vim.opt.listchars <span style="color:#f92672">=</span> { tab <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;» &#39;</span>, trail <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;·&#39;</span>, nbsp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;␣&#39;</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Preview substitutions live, as you type!</span>
</span></span><span style="display:flex;"><span>vim.o.inccommand <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;split&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Show which line your cursor is on</span>
</span></span><span style="display:flex;"><span>vim.o.cursorline <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Minimal number of screen lines to keep above and below the cursor.</span>
</span></span><span style="display:flex;"><span>vim.o.scrolloff <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- if performing an operation that would fail due to unsaved changes in the buffer (like `:q`),</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- instead raise a dialog asking if you wish to save the current file(s)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- See `:help &#39;confirm&#39;`</span>
</span></span><span style="display:flex;"><span>vim.o.confirm <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><ul>
<li><code>vim.o</code>：设置nvim的各种行为选项。</li>
<li><code>vim.o.number = true</code>：显示==行号==。默认显示的是绝对行号</li>
<li><code>vim.o.relativenumber = true</code>：显示==相对行号==。
<ul>
<li>你可能会好奇如果两个都启用会怎么样。答案很简单：你所处的行会显示绝对行号，而其他行会显示相对行号。这样你既能确定自己的绝对位置，又方便跳转位置，这是很多人的选择。</li>
</ul>
</li>
<li><code>vim.o.mouse = 'a'</code>：==鼠标模式==，a表示对所有文件都适用。如果你有鼠标，你没有理由把这个这个关掉。</li>
<li><code>vim.o.showmode = false</code>：不显示nvim内置的==状态提示==。更加现代的状态栏插件可以提供比文本更美观的状态栏，所以除非你有特殊的美术追求，没必要调为true。</li>
<li><code>vim.schedule(function()vim.o.clipboard = 'unnamedplus'end)</code>：<code>vim.schedule</code>表示在ui完全加载完之后再执行，后面的函数表示将nvim的==剪切板与操作系统剪切板同步==。你可以在nvim中<code>y</code>复制文本之后在外部<code>ctrl v</code>粘贴，也可以外部<code>ctrl c</code>复制后在nvim中<code>p</code>粘贴。
<ul>
<li>这是一个非常有必要的设置，尤其是当你需要和ai博弈的时候。</li>
</ul>
</li>
<li><code>vim.o.breakindent = true</code>：==打断缩进==，文本太长自动换行后保持和原文本同样的缩进。</li>
<li><code>vim.o.undofile = true</code>：保存==撤回树==，当你再次打开这个文件时，你仍然可以撤回到之前的状态，即使中间你保存了文件。实现原理是另外建立一个<code>.un~</code>文件，所以理论上你可以撤回到宇宙大爆炸（如果你从那时就开始写代码）</li>
<li><code>vim.o.ignorecase = true</code> <code>vim.o.smartcase = true</code>：==搜索==时忽视大小写，但是如果你输入了至少一个大写时又会自动大小写敏感。</li>
<li><code>vim.o.signcolumn = 'yes'</code>： 保持==侧边栏显示==，Lsp（后面会涉及）和一些其他的插件需要依赖这个侧边栏来显示一些信息，所以保持开启。</li>
<li><code>vim.o.updatetime = 250</code>：==更新时间==，你可以理解为minecraft中的随机刻，很多插件的使用依赖于这个更新时间，如果减少，一些插件的响应速度会加快。</li>
<li><code>vim.o.timeoutlen = 300</code>：==映射序列等待时间==，比如你的一个映射是<code>j+k</code>，当你按下<code>j</code>时，nvim会等待300ms，如果你在这时间内按下<code>k</code>，那么就会执行映射。</li>
<li><code>vim.o.splitright = true</code> <code>vim.o.splitbelow = true</code>：新的水平==分屏==和垂直分屏会分别出现在右边和下边。</li>
<li><code>vim.o.list = true</code>：开启list模式，让nvim可以显示一些特殊的==空白字符==</li>
<li><code>vim.opt.listchars = { tab = '» ', trail = '·', nbsp = '␣' }</code>：将tab显示为》，将尾部的多余空格显示为·，将不可断空格显示为␣。</li>
<li><code>vim.o.inccommand = 'split'</code>：执行替换命令时在一个新的==分屏窗口==中实时显示预览效果。</li>
<li><code>vim.o.cursorline = true</code>：==高亮==光标所在的当前行。</li>
<li><code>vim.o.scrolloff = 10</code>：光标滚动时会==偏移上下边缘10行==，方便阅读。</li>
<li><code>vim.o.confirm = true</code>：在一些可能导致数据丢失的情况下==要求你确认==，比如未保存时就退出。除非你是人形计算机永远可以保证正确，那么建议你保持开启。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- [[ Basic Keymaps ]]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  See `:help vim.keymap.set()`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Clear highlights on search when pressing &lt;Esc&gt; in normal mode</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  See `:help hlsearch`</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;Esc&gt;&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;nohlsearch&lt;CR&gt;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Diagnostic keymaps</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;q&#39;</span>, vim.diagnostic.setloclist, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Open diagnostic [Q]uickfix list&#39;</span> })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Exit terminal mode in the builtin terminal with a shortcut that is a bit easier</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- for people to discover. Otherwise, you normally need to press &lt;C-\&gt;&lt;C-n&gt;, which</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- is not what someone will guess without a bit more experience.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- NOTE: This won&#39;t work in all terminal emulators/tmux/etc. Try your own mapping</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- or just use &lt;C-\&gt;&lt;C-n&gt; to exit terminal mode</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;&lt;Esc&gt;&lt;Esc&gt;&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&gt;&lt;C-n&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Exit terminal mode&#39;</span> })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- TIP: Disable arrow keys in normal mode</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#39;n&#39;, &#39;&lt;left&gt;&#39;, &#39;&lt;cmd&gt;echo &#34;Use h to move!!&#34;&lt;CR&gt;&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#39;n&#39;, &#39;&lt;right&gt;&#39;, &#39;&lt;cmd&gt;echo &#34;Use l to move!!&#34;&lt;CR&gt;&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#39;n&#39;, &#39;&lt;up&gt;&#39;, &#39;&lt;cmd&gt;echo &#34;Use k to move!!&#34;&lt;CR&gt;&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#39;n&#39;, &#39;&lt;down&gt;&#39;, &#39;&lt;cmd&gt;echo &#34;Use j to move!!&#34;&lt;CR&gt;&#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Keybinds to make split navigation easier.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  Use CTRL+&lt;hjkl&gt; to switch between windows</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  See `:help wincmd` for a list of all window commands</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-h&gt;&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-w&gt;&lt;C-h&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Move focus to the left window&#39;</span> })
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-l&gt;&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-w&gt;&lt;C-l&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Move focus to the right window&#39;</span> })
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-j&gt;&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-w&gt;&lt;C-j&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Move focus to the lower window&#39;</span> })
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-k&gt;&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-w&gt;&lt;C-k&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Move focus to the upper window&#39;</span> })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- NOTE: Some terminals have colliding keymaps or are not able to send distinct keycodes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#34;n&#34;, &#34;&lt;C-S-h&gt;&#34;, &#34;&lt;C-w&gt;H&#34;, { desc = &#34;Move window to the left&#34; })</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#34;n&#34;, &#34;&lt;C-S-l&gt;&#34;, &#34;&lt;C-w&gt;L&#34;, { desc = &#34;Move window to the right&#34; })</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#34;n&#34;, &#34;&lt;C-S-j&gt;&#34;, &#34;&lt;C-w&gt;J&#34;, { desc = &#34;Move window to the lower&#34; })</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#34;n&#34;, &#34;&lt;C-S-k&gt;&#34;, &#34;&lt;C-w&gt;K&#34;, { desc = &#34;Move window to the upper&#34; })</span>
</span></span></code></pre></div><ul>
<li><code>vim.keymap.set()</code>：这是 Neovim 推荐的用来设置快捷键的函数。它比老式的 <code>map</code> 命令更清晰、功能更强大。</li>
<li><code>vim.keymap.set('n', '&lt;Esc&gt;', '&lt;cmd&gt;nohlsearch&lt;CR&gt;')</code>：在<strong>普通模式</strong> (Normal Mode)下（n就表示普通模式），当你按下 <code>&lt;Esc&gt;</code> 键时，自动执行 <code>:nohlsearch</code> 命令来清除上一次搜索结果的高亮。
<ul>
<li>这是一个极其舒适的设置。你用 <code>/</code> 搜索完一个词后，所有匹配项都会高亮，有时会很晃眼。这个快捷键让你可以在不经意间（因为 <code>&lt;Esc&gt;</code> 是最常用的键之一）就清除掉这些高亮，让界面恢复清爽。</li>
</ul>
</li>
<li><code>vim.keymap.set('n', '&lt;leader&gt;q', vim.diagnostic.setloclist)</code>：在<strong>普通模式</strong>下，按下你之前设置的 <code>Leader</code> 键（比如空格），再按下 <code>q</code>，就会打开一个<strong>诊断信息的列表 (Quickfix list)</strong>。
<ul>
<li>当你的代码有错误或警告时（由 LSP 提供），这个列表会把所有问题都集中展示出来，方便你逐个跳转和修复。<code>q</code> 很好记，可以联想成 “Quickfix”。</li>
</ul>
</li>
<li><code>vim.keymap.set('t', '&lt;Esc&gt;&lt;Esc&gt;', '&lt;C-\\&gt;&lt;C-n&gt;')</code>：在<strong>终端模式</strong> (Terminal Mode)下，<strong>连按两次 <code>&lt;Esc&gt;</code> 键</strong>，效果等同于按下那个非常难记的 <code>&lt;C-\&gt;&lt;C-n&gt;</code> 组合键，从而<strong>退出终端模式</strong>回到普通模式。
<ul>
<li>Neovim 内置的终端非常好用，但它的默认退出方式简直反人类。这个设置用一个更符合直觉的方式解决了这个问题。不过注释也提醒了，这个映射在某些复杂的终端环境（比如 tmux 嵌套）下可能不生效，那时就只能老老实实按默认的组合键了。</li>
</ul>
</li>
<li><code>-- TIP: Disable arrow keys in normal mode</code> (被注释掉的代码块)：这是一个给新手的<strong>提示性配置</strong>，建议<strong>禁用在普通模式下的方向键</strong>。
<ul>
<li>这么做的目的是为了“强迫”自己习惯使用 <code>h j k l</code> 来移动光标。这是 Vim 的精髓之一，因为你的手不需要离开主键区，移动效率会高得多。一旦你习惯了，就会发现方向键又远又慢。如果你想养成这个好习惯，可以把这段代码的注释去掉。</li>
</ul>
</li>
<li><code>vim.keymap.set('n', '&lt;C-h&gt;', '&lt;C-w&gt;&lt;C-h&gt;')</code> (以及下面 <code>jkl</code> 的三行)：这一组快捷键让你可以在<strong>普通模式</strong>下，使用 <code>Ctrl + h/j/k/l</code> 来<strong>在不同的分屏窗口之间切换焦点</strong>。
<ul>
<li>Neovim 原生的窗口切换命令是 <code>&lt;C-w&gt;</code> 再加上 <code>h/j/k/l</code>，需要按两次。这组设置把两步操作简化成了一步，让窗口导航变得像在单个文件中移动光标一样流畅自然，极大地提升了分屏工作的效率。</li>
</ul>
</li>
<li><code>-- NOTE: Some terminals have colliding keymaps...</code> (被注释掉的代码块)：这是另一组<strong>提示性配置</strong>，它尝试将 <code>Ctrl + Shift + h/j/k/l</code> 映射为<strong>移动整个窗口的位置</strong>，而不是仅仅移动焦点。
<ul>
<li>比如，按下 <code>Ctrl + Shift + h</code> 会把当前所在的窗口整个移动到左边去。这对于整理窗口布局很有用。</li>
<li>但是，注释明确指出，很多终端程序无法正确识别 <code>Ctrl + Shift</code> 和 <code>Ctrl</code> 的区别，导致这个快捷键可能无法生效。所以它被默认注释掉了，需要你自己测试和决定是否启用。</li>
</ul>
</li>
</ul>
<p>原谅我上面这段文字用了ai。ai描述通常会有过多的描述，导致看起来观感不那么清爽。不过没关系，我来总结一下：</p>
<ul>
<li><code>vim.keymap.set('&lt;mode&gt;','&lt;key&gt;','&lt;command&gt;',{desc = &quot;&quot;})</code>是配置键盘映射的基本语句，其中第一个参数表示模式，n,v,i,c,t分别代表普通模式、可视模式、插入模式、命令行模式、终端模式。这表明了该映射的生效场景。</li>
<li>第二个参数表示你按下的按键，特殊按键使用尖括号包裹。大致如下：
<ul>
<li>&lt;CR&gt;: 回车键 (Carriage Return)</li>
<li>&lt;Esc&gt;: Escape 键</li>
<li>&lt;Space&gt;: 空格键</li>
<li>&lt;leader&gt;: 你设置的 Leader 键</li>
<li>&lt;C-h&gt;: Ctrl + h</li>
<li>&lt;S-h&gt;: Shift + h</li>
<li>&lt;A-h&gt;: Alt + h (在 Lua 中也写作 &lt;M-h&gt;)</li>
<li>例：
<ul>
<li><code>&lt;leader&gt;q</code>前导键+q</li>
<li><code>&lt;C-h&gt;</code>Ctrl+h</li>
<li><code>&lt;Esc&gt;&lt;Esc&gt;</code>按两次esc</li>
</ul>
</li>
</ul>
</li>
<li>第三个参数表示指令，你可以用单引号包裹一个指令来直接表示一个指令，也可以仿照第二个参数来模拟按键。</li>
<li>第四个参数是选项，写入desc可以为快捷键写入描述。其他的可选项不在此罗列。</li>
</ul>
<p>现在，我们来写一些简单的快捷键，方便我们编写。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;i&#39;</span>,<span style="color:#e6db74">&#39;jk&#39;</span>,<span style="color:#e6db74">&#39;&lt;Esc&gt;&#39;</span>) <span style="color:#75715e">--用jk来从插入模式快速切换回普通模式，比按esc快的多</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;v&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;vsplit&lt;CR&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;[V]ertical split&#39;</span> }) <span style="color:#75715e">--创建垂直分屏的快速方式</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;v&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;vsplit&lt;CR&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;[V]ertical split&#39;</span> }) <span style="color:#75715e">--创建水平分屏</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;c&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;close&lt;CR&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;[C]lose window&#39;</span> }) <span style="color:#75715e">--关闭分屏</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;bn&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;bnext&lt;CR&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Go to [N]ext [B]uffer&#39;</span> })
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;bp&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;bprevious&lt;CR&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Go to [P]revious [B]uffer&#39;</span> })
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;bd&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;bdelete&lt;CR&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;[D]elete/close buffer&#39;</span> })
</span></span></code></pre></div><p>总之，这部分代码主要就是让你在感觉有的快捷键比较反人类的时候可以随意将它修改为自己喜欢的快捷键。以上部分代码仅供参考。</p>
<hr>
<p>限于篇幅，init.lua内容的介绍暂时到这里。但是我们并没有结束：接下来，让我们来尝试将options和keymap部分的代码移植到其他地方去。所有的配置全部都放在一个init.lua文件中并不利于后期的维护与调整。理论上，根据我们前文所学的知识，我们已经足够可以实现配置文件的分模块管理了。</p>
<p>首先，让我们回到根目录：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cd ~/.config/nvim
</span></span></code></pre></div><p>接着，在<code>~/.config/nvim/lua/custom</code>目录下创建两个新的lua文件来存放我们写好的keymap和option部分代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>touch lua/custom/options.lua
</span></span><span style="display:flex;"><span>touch lua/custom/keymaps.lua
</span></span></code></pre></div><p>然后，将根目录下init.lua中<code>vim.o</code>与<code>vim.keymaps</code>相关的代码分别剪切到这两个文件中。注意，当你使用vim内置的<code>d</code>与<code>p</code>剪切粘贴工具时，因为你要移动的<code>vim.o</code>涉及到了剪切板工具，<code>vim.keymap</code>涉及到了快捷键设置，你可能在此过程中会遇到一点小问题。以防万一，你可以先把代码复制到外部，再挨个复制进对应文件，这样以防代码丢失。</p>
<p>此时，你就可以完全删除init.lua开头到keymaps位置的全部代码（除了全局变量），并补上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>require <span style="color:#e6db74">&#39;custom.options&#39;</span>
</span></span><span style="display:flex;"><span>require <span style="color:#e6db74">&#39;custom.keymaps&#39;</span>
</span></span></code></pre></div><p>不出意外的话，保存退出再重进，你原先写在init.lua中的配置此时再次会发挥作用。你可以通过这种方式让你的配置文件更加易于维护。</p>
<p>大概先这样，我还会就界面个性化、lsp等比较棘手的配置问题再写几篇博客。</p>
]]></content>
		</item>
		
		<item>
			<title>Hellohugo</title>
			<link>http://localhost:1313/zh-cn/posts/hellohugo/</link>
			<pubDate>Wed, 19 Nov 2025 23:20:43 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/hellohugo/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h2 id="hellohugo">Hellohugo<a href="#hellohugo" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>这是新的开始！</p>
<p>期中之后，我决定改用hugo博客框架来重新搭建自己的博客。原先使用hexo的博客因为起初技术力不足导致种种配置困难，最近想把文章投送上去时突然发现oranges主题的代码块意外的很丑。与此同时，老博客是在我的windows主系统中完成搭建的，而我现在代码工作基本完全转向了linux（虽然只是wsl），继续在windows下维护博客又会带来种种不便，所以索性完全弃用原本的博客，在wsl中另起炉灶。</p>
]]></content>
		</item>
		
		<item>
			<title>零基础如何搭建博客</title>
			<link>http://localhost:1313/zh-cn/posts/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/</link>
			<pubDate>Sat, 20 Sep 2025 20:49:03 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h4 id="从旧站移植来的旧文旧站使用的是hexo框架">从旧站移植来的旧文，旧站使用的是hexo框架<a href="#%e4%bb%8e%e6%97%a7%e7%ab%99%e7%a7%bb%e6%a4%8d%e6%9d%a5%e7%9a%84%e6%97%a7%e6%96%87%e6%97%a7%e7%ab%99%e4%bd%bf%e7%94%a8%e7%9a%84%e6%98%afhexo%e6%a1%86%e6%9e%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>大概在本月的14号左右，我突然想起来之前知乎上有人和我说过可以搭建一个博客，写写题解什么的。当然，搭一个博客和写题解之间没有必然关系，但是就那几天我突然开始好奇什么是博客。不查不知道，博客竟然是一类网站的统称。经过了一番折腾总算是把自己的博客网站搭建起来了。</p>
<p>下面，请让我简述我的博客是如何搭建起来的。</p>
<h2 id="1静态框架hexo">1.静态框架hexo<a href="#1%e9%9d%99%e6%80%81%e6%a1%86%e6%9e%b6hexo" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>因为博客实际上是一种过去盛行的网络社交方式，大多数博客都大同小异，所以，搭建博客很多时候是一件相当同质化的事情。这就意味着，我们可以用相似的框架来搭建自己的博客。这就是博客框架。</p>
<p>博客框架替用户几乎铺平了所有技术困难，而用户可以聚焦在业务问题（如写博客）上。博客框架大致可以分为两类，静态框架和动态框架。后者的学习成本更高，但是可以做出更多的交互。而前者虽然不便于做交互，但是用来写写简单的博客文已经足够了。所以对我而言，性价比最高的方案就是使用静态博客框架搭建自己的博客。</p>
<p>在静态博客框架中，我选择了hexo。没什么理由，只是因为主题多并且学习成本低而已。对于其性能方面或许存在的问题，我的评价是我的境界还不足以让我感受到它的问题。</p>
<h2 id="2怎么用hexo">2.怎么用hexo？<a href="#2%e6%80%8e%e4%b9%88%e7%94%a8hexo" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>这是一个很现实的问题。对于大多数电脑使用者而言，用电脑几乎等同于与图形化界面打交道。比如，如果你想创建一个微信公众号，你只需要前往微信公众平台在图形化界面注册即可。但是对于博客框架和大多数拓展包而言，它们并不采用图形化界面的交互方式，而是采用命令行工具来完成各项工作。</p>
<p>这就意味着，想使用hexo搭建框架，最好先学一点命令行工具的用法。</p>
<h4 id="命令行工具">命令行工具<a href="#%e5%91%bd%e4%bb%a4%e8%a1%8c%e5%b7%a5%e5%85%b7" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>原谅我只用过windows系统。在win系统中，有两种命令行工具：cmd和powershell。前者大多用来做基础命令和兼容性，功能有限。此处我们使用powershell。</p>
<p>此外，你还需要安装git。如果你从来没有听说过它，这是一个软件，专门用来管理你的工程代码。鉴于博客本质上就是搭建网站，所以这也是不得不品的一环。安装git之后，你的电脑里还会出现另一个命令行工具：git bash。</p>
<p>所以，git bash和powershell又有什么区别呢？请看chatgpt给出的解释：</p>
<pre tabindex="0"><code>1. 运行环境不同

Git Bash

提供一个类 Linux 的 bash shell 环境（基于 MinGW）。

内置了很多常见的 Unix 工具（如 ls、grep、cat、rm）。

默认命令语法更接近 Linux / macOS。

适合习惯 Linux 命令行的用户。

PowerShell

Windows 原生的 shell，基于 .NET。

Git 本身并不自带 PowerShell，但你装了 Git for Windows 后，git.exe 会注册到系统 PATH，因此 PowerShell 也能直接用 git。

命令语法是 PowerShell 风格（Get-Command、| 管道传对象）。

更适合做 Windows 系统管理 + Git 混合场景。

2. 命令行为上的差异

路径格式

Git Bash：用 Linux 风格路径 /c/Users/...

PowerShell：用 Windows 风格路径 C:\Users\...

Git 内部能自动适配，但有时脚本里路径写法要注意。

脚本兼容性

Git Bash 能直接跑 .sh 脚本（Linux 写的脚本几乎不用改）。

PowerShell 只能跑 .ps1，要想跑 .sh，得额外配置（比如用 WSL）。

输出和管道

Git Bash：输出就是 文本，常用 grep、awk 处理。

PowerShell：输出是 对象，可以 git log | Out-File log.txt，但有些 git 输出并不是对象，还是普通文本，这时就当成字符串处理。

3. 体验上的差异

Git Bash

更像在 Linux 下用 Git，教程和 Stack Overflow 示例几乎可以原样照搬。

有补全、颜色支持等。

PowerShell

跟 Windows 系统融合度高，比如直接结合 Windows 文件系统、服务管理。
</code></pre><p>我们总结一下，大概就是git bash风格上更像linux系统，更能适配各类教程；而powershell和win系统的适配度更高。</p>
<p>所以我怎么用呢？我的评价是默认用powershell，报错出语法错误之后再试试git bash上能不能行。为什么要同时使用这两个命令行工具呢？很简单，因为当你作为初学者使用git时，不免要问问LLM的意见，这个时候LLM就有可能从网络的各个角落给你搜罗来命令，其中很可能相当一部分只能在git bash上使用，但是如果想本地调试博客的话又最好使用powershall。所以，轮着用吧。</p>
<p>对于powershell，只需要知道两个最基本的指令就行了。</p>
<pre tabindex="0"><code>cd &lt;path&gt;
dir
</code></pre><p>第一个指令是改变你命令行最前面的那个地址。之后你需要将地址改到你博客文件的根目录上才能继续使用hexo的相关命令。
第二个命令是罗列该目录下有什么文件，方便你cd。</p>
<p>好的，现在你知道了怎么用命令行工具切换文件目录了，是时候让我们开始在本地安装我们的hexo框架了。</p>
<h4 id="hexo环境安装">hexo环境安装<a href="#hexo%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>hexo框架是使用nodejs写的。就像C++需要编译才能运行，java需要JDK才能运行，nodejs写的程序也一样，在使用之前，我们还需要安装nodejs。</p>
<p>安装网站：<a href="https://nodejs.org/">nodejs</a></p>
<p>此外，在前文中我们提到了git。如果你想更新网站内容，对于hexo框架而言最方便的途径就是使用git。反正git工具对于一个写代码的人而言早晚都要学的，不如就趁现在学一下吧。</p>
<p>安装网站：<a href="https://git-scm.com/downloads">git</a>
(后记：实际上多数时候直接使用包管理器就可以非常轻松地下载。)</p>
<p>最后，毫无疑问，你需要安装hexo。但是这次，你不需要访问任何网站。nodejs内置了npm包管理器。你只需要输入一串指令就可以自动安装hexo。</p>
<pre tabindex="0"><code>npm install -g hexo-cli
</code></pre><p>在powershell中输入。为什么不在git bash中输入呢？因为我没试过。(实际上应该差不多)</p>
<h4 id="创建一个博客项目">创建一个博客项目<a href="#%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aa%e5%8d%9a%e5%ae%a2%e9%a1%b9%e7%9b%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>在环境搭建完毕之后，你需要创建一个博客项目。hexo是一个为你生成博客网站源码的工具，它的产出单元就是博客。所以，创建一个博客。
cd到你觉得合适的地址，输入以下指令：</p>
<pre tabindex="0"><code>hexo init myblog   # 创建一个名为 myblog 的博客目录
cd myblog
npm install         # 安装依赖
</code></pre><p>执行完后，你会得到一个完整的博客项目文件夹，里面包括：</p>
<ul>
<li>source/_posts/：放文章的地方</li>
<li>themes/：博客外观主题</li>
<li>config.yml：全局配置文件</li>
</ul>
<p>好的，现在你就成功了相当一部分了。你已经有了博客的主要文件，你只需要往里面填内容然后部署即可。</p>
<p>那么，如何填内容呢？我们先来了解一下怎么本地测试。</p>
<pre tabindex="0"><code>hexo clean
hexo g
hexo s
</code></pre><p>这三个指令通常是连着输的，大多数时候你根本不用关心三个指令分别是什么意思，你只需要知道：三个指令输完之后，你会得到一个网址<code>http://localhost:4000/</code>，把它输入到浏览器中你就可以本地预览你的博客网站。通常而言，预览的结果就是部署得到的结果。
(后记：实则不然，第二次部署博客费了老劲，预览的结果和部署的结果始终不同，改了好久环境变量。)</p>
<h2 id="如何写博客">如何写博客？<a href="#%e5%a6%82%e4%bd%95%e5%86%99%e5%8d%9a%e5%ae%a2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>在上文中你已经学会了hexo的基本用法。现在是时候填充一些实际内容了。博客框架最大的优点就是支持markdown语法。这是一个程序员写README的经典标记语法，但是对于初学者来说可能会有一点点门槛。</p>
<p>这里不再罗列markdown的语法。不过，如果你想学markdown，我的经验是你可以先从学obsidian开始。我在b站上找到了一个非常适合初学者学习的obsidian教程。用obsidian学markdown最大的好处就是markdown的效果能立竿见影，高度可视化。<a href="https://www.bilibili.com/video/BV1Hj411E7ra/?spm_id_from=333.337.search-card.all.click&amp;vd_source=31ba3d75fa2995f7e1b776de7a637bd4">教程视频</a></p>
<p>如果你想写一篇博客，在powershell中输入：</p>
<pre tabindex="0"><code>hexo new post &lt;post_name&gt;
</code></pre><p>然后，把myblog整个文件夹丢到vscode里。在source/_posts里，你可以找到“文章名.md”的文件，在这里用markdown语言撰写你的博客。</p>
<p>在写完一篇博客之后，记得保存，随后在终端输入上文中的测试指令，你就可以在本地看到你的博客文章了。</p>
<h2 id="如何使用主题">如何使用主题？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e4%b8%bb%e9%a2%98" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>在默认情况下，hexo自带了一个主题，你不需要插入主题也可以搭建自己的博客。但是hexo的优势就在于活跃的中文社区与大量的开源主题。如果你不会导入主题的话绝对是一件遗憾。</p>
<p>使用主题并不是一件难事，但是对于初学者（比如我）而言，因为误操作git导致给自己创造了一系列困难是常有的事。所以，在使用主题之前，我们最好先了解一下git和github的基础知识。</p>
<h4 id="如何使用git">如何使用git？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8git" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>在前文中我们有提到过git。这是一个非常好用的程序管理器，你可以将其类比为码农的游戏存档，但是它的功能比简单的存档更加强大，它可以随时存档，读档，创建分支，合并分支。与其将它比作是一个存档器，不如说是一个功能极强的时间机器。</p>
<p>当然，在此处，你同样只需要了解一些基础知识即可。</p>
<pre tabindex="0"><code>git add .
git add &lt;file_name&gt;
git commit -m &lt;message&gt;
git branch &lt;branch_name&gt;
git checkout &lt;branch_name&gt;
git log
git branch -m &lt;new-name&gt;
</code></pre><p>简单来说，第一个命令是将当前目录下的所有文件添加到缓存区，第二个命令是将指定文件添加到缓存区。
第三个命令是提交缓存区的所有文件，形成一次提交，并且带有一条写入的message。
第四条是在当前提交处创建一个分支。
第五个是读档，回档到某个分支的状态。
第六个是查看git提交记录，你可以看到项目的所有提交记录，包括时间，哈希值，message以及分支。
最后一个是修改当前分支的名称。</p>
<p>忘了写了，还有<code>git init</code>，这是一个非常关键的命令，需要在以上命令写之前写入。一个工程只需要写一次就够了。这会告诉git，这里有一个工程文件需要git插手，即初始化git，之后此目录下才能使用git命令。</p>
<p>看不懂上面是什么意思？没关系。尽管git本身是命令行工具，但是当前网路上不乏许多直观的教程。下面推荐几个</p>
<p><a href="https://learngitbranching.js.org/?locale=zh_CN">Learn Git Branching</a> - 用游戏式的交互直观展示git工作流程。在branch方面更加清晰。
<a href="https://www.youtube.com/watch?v=mJ-qvsxPHpY&amp;t=602s">Git Tutorial For Dummies</a> - 顾名思义，给蠢蛋上的git教程。跟着走一遍就会用git了。
（后记：其实我现在还是不太能完全理解git分支版本控制的原理，大多数时候git add .,git commit,git push就足够满足需求了。）</p>
<p>然而，只用git是不够的，安装主题需要从github上导入，因此，你也必须学习一点github知识。</p>
<h4 id="如何使用github">如何使用github？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8github" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>hub在英文中表示“中心”，github即git中心。尽管是一个高度图形化的网站，github的使用很大程度上依赖于git。
下面我们罗列几个与github相关的git指令。</p>
<pre tabindex="0"><code>git clone &lt;远程仓库地址&gt; &lt;本地相对地址&gt; - 将github上的某仓库克隆到本地
git remote add origin &lt;远程仓库地址&gt; - 给当前项目添加 GitHub 仓库（一般第一次 push 时用）
git push origin main - 将本地 main 分支推送到 GitHub 上
git push -u origin main - 第一次推送时用，之后可直接 git push
</code></pre><p>比如，如果我希望我的博客使用Oranges主题，我就这么做：</p>
<ul>
<li>cd到博客根目录/myblog</li>
<li><code>git clone https://github.com/zchengsite/hexo-theme-oranges themes/Oranges</code>
输入第二行的命令之后，你的themes文件夹中就会出现Oranges文件。这时候你就可以使用该主题了。</li>
</ul>
<p>注意：不同主题各自有自己的配置文件，请参考github上各个主题的readme.md文件了解配置方法。</p>
<p>有的主题会建议你使用submodule方式添加主题。这需要一定的git基础，并且会造成提交部署上流程的复杂化。反正我暂时不会。我的方案是直接clone到本地，之后删除其中的所有.git相关的文件，这样这些导入的文件就不会被视作是一个子仓库，而是你工程文件的一部分。除非你有频繁更新主题的需求，一般而言导入一次就不会再去更新主题了。
（后记：现在仍然不会使用子模块。）</p>
<h2 id="如何部署博客">如何部署博客？<a href="#%e5%a6%82%e4%bd%95%e9%83%a8%e7%bd%b2%e5%8d%9a%e5%ae%a2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>通过上文的流程，你已经可以在本地编辑和预览你的博客网站了。但是这不够，因为你需要让它部署到公网上才能让它被其他人看到。
所以，如何部署呢？我们需要先了解一些基础知识。</p>
<ul>
<li>首先，你的博客需要一个地方存放它的工程文件，即你的myblog文件夹。这个位置不能是你的本地，因为博客网站24小时连轴转，你的电脑可是需要休息的。</li>
<li>此外，你的博客需要一个域名，例如baidu.com。不然别人怎么访问你的博客。</li>
<li>之后，你需要一个平台来代替你的电脑来运行网站。当然如果你会搭自己的服务器那当我没说，不过有这实力也不至于来看我的文章了。</li>
</ul>
<p>感觉很复杂吗？没关系，我们一条一条来。</p>
<p>首先第一条。在哪里可以存放你的工程文件呢？对于一个毫无编程基础的人而言，你可能会想到网盘。很不错了，但是我们有更优化的方案。这就是我们前文中提到的github。
在这里，我们先正式介绍一下github。</p>
<h4 id="什么是github">什么是github？<a href="#%e4%bb%80%e4%b9%88%e6%98%afgithub" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>我知道你可能很想吐槽为什么我先讲怎么用github再介绍github，但是你先别急。</p>
<p>GitHub，是一个基于git的代码托管平台。它就像是一个几乎无限大的网盘，你可以在这里搭建仓库，存放代码，甚至和他人合作完成项目。</p>
<p>怎么做到无限大的？好吧，实际上并不是无限大。github要求单个仓库上线大小为1GB，单个文件上限大小为100MB。但是，对于代码这种纯粹字符组成的文件，一般而言空间占用量很小，加上得益于git的高效储存，对于大部分代码工程而言使用github都是足够使用了。当然，如果你想在这里上传视频等大体积文件，这就有点困难了。</p>
<h4 id="如何在github上存放你的工程文件">如何在github上存放你的工程文件？<a href="#%e5%a6%82%e4%bd%95%e5%9c%a8github%e4%b8%8a%e5%ad%98%e6%94%be%e4%bd%a0%e7%9a%84%e5%b7%a5%e7%a8%8b%e6%96%87%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>非常简单。在我们前文中有讲过如何把本地文件上传到github。现在我再来详细介绍一遍。</p>
<ul>
<li>首先，创建一个仓库。你可以在github中轻松找到创建仓库的按键。输入你想命名的仓库名就大功告成了。</li>
<li>之后，进入你的仓库界面。复制此处的网址。</li>
<li><code>git remote add origin &lt;远程仓库地址&gt;</code>, 将当前项目链接到你刚创建的github仓库。</li>
<li><code>git add .</code> <code>git commit -m &lt;message&gt;</code>,将当前项目提交一次git存档。</li>
<li><code>git push -u origin main</code>,将当前提交上传到github。</li>
</ul>
<p>这时候，去你的github仓库里，你就可以看到你的工程文件成功出现在了那里。成功上传。</p>
<p>注意：之后在相同的工程文件中，你只需要输入<code>git push</code>就可以代替<code>git push -u origin main</code>，更加快捷。</p>
<h4 id="如何获得域名">如何获得域名？<a href="#%e5%a6%82%e4%bd%95%e8%8e%b7%e5%be%97%e5%9f%9f%e5%90%8d" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>这是全过程最简单的一环，拿钱摆事即可。</p>
<p>国内的主要域名商就是阿里云和腾讯云。我个人是在腾讯云上买的域名。</p>
<p>域名的不同价格主要就是后缀决定的。不要被某些域名较低的首年价格吸引了，没必要搞一个太花里胡哨的域名，我个人还是更追求稳定。</p>
<p>在腾讯云上购买域名之后，你会在这里找到相关的工作台。这很重要，之后部署博客的时候会用到。</p>
<h4 id="部署博客">部署博客<a href="#%e9%83%a8%e7%bd%b2%e5%8d%9a%e5%ae%a2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>现在，你已经有了域名和博客网站的内容，是时候让它部署到公网上了。</p>
<p>这时候，我们需要寻求云计算服务平台的帮助，来托管我们的网站代码。在其中，我个人选择的是vercel，在中文社区广受好评的托管平台。</p>
<p>值得注意的是，如果你去问chatgpt或者gemini等外国LLM，你可能会被告知vercel在国内的速度并不好，并推荐使用cloudflare。然而事实截然相反，我身边用过的人都说cf又慢又爱抽风。事实证明，有时候有经验的真人会比大数据更懂你的需求。</p>
<p>至少在vercel中，部署博客几乎是一条龙服务，跟着引导走就行了。这边提几个可能产生误会的地方。</p>
<h6 id="1如何使用自己的域名">1.如何使用自己的域名？<a href="#1%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e8%87%aa%e5%b7%b1%e7%9a%84%e5%9f%9f%e5%90%8d" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h6>
<p>这里需要引入DNS的概念。</p>
<p>DNS：Domain Name System，域名系统，用来实现域名和IP地址的相互映射。简单来说，用户想通过域名来访问网站，但是计算机需要IP地址。DNS就提供了这样的寻址功能。</p>
<p>如果我们想通过域名来访问自己的博客，我们就需要让我们的域名通过DNS记录链接到云计算服务平台的IP地址。</p>
<p>所以，这时候我们需要返回域名商的工作台。在此处为我们的域名添加DNS记录。此处，你需要去获知你所选云计算服务平台的IP地址。</p>
<p>我其实不太明白怎么获知这个IP地址，误打误撞就填对了。所以需要你自己去探索方法。</p>
<h6 id="2如何更新">2.如何更新？<a href="#2%e5%a6%82%e4%bd%95%e6%9b%b4%e6%96%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h6>
<p>如果你想更新博客，你需要重新部署一遍吗？</p>
<p>答案是不用。vercel这样的平台会自动检测github仓库的提交并采用当前分支的最新记录。你只需要git push一下你就可以看到公网上你的博客内容更新了。</p>
<h2 id="尾声">尾声<a href="#%e5%b0%be%e5%a3%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>这是我正式写的第一篇博客。码字码了半天。因为实际上本人也是刚刚开始接触博客，没有很丰富的经验与知识基础，希望多多见谅。</p>
<p>因为现在没有图床，导入图片不太方便，之后希望能尽快解决。（2025-11-23，现在也没有解决）</p>
]]></content>
		</item>
		
	</channel>
</rss>
