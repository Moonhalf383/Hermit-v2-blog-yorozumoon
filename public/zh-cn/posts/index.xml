<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/">
	<channel>
		<title>Posts on Yorozumoon</title>
		<link>http://localhost:1313/zh-cn/posts/</link>
		<description>Recent content in Posts on Yorozumoon</description>
		<generator>Hugo -- 0.154.5</generator>
		<language>zh-cn</language>
		<copyright>copyright by Moonhalf.</copyright>
		<lastBuildDate>Sat, 17 Jan 2026 00:00:00 +0000</lastBuildDate>
		<atom:link href="http://localhost:1313/zh-cn/posts/index.xml" rel="self" type="application/rss+xml" />
		
		
		<item>
			<title>核动力博客发射器测试</title>
			<link>http://localhost:1313/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/</link>
			<pubDate>Sat, 17 Jan 2026 00:00:00 +0000</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>测试用。这个博客采用了一套全新的工作流。如果你能在网站上看到这个文章，且一切显示正常，证明新的工作流成功了。成功后我就可以用比以前快一伯倍的速度在我的博客上堆砌日常产出的学术废料。</p>
<p>一些近期工作的截图。（在旧的工作流下添加图片极其痛苦，现在因为采用了一套新的工作流，添加图片易如反掌口牙！！）</p>
<p><img src="/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95-20260117-1.png" alt=""></p>
<p><img src="/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95-20260117-2.png" alt=""></p>
<p><img src="/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95-20260117-3.png" alt=""></p>
<p><img src="/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95-20260117-4.png" alt=""></p>
<p><img src="/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95-20260117-5.png" alt=""></p>
<p><img src="/zh-cn/posts/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95/%E6%A0%B8%E5%8A%A8%E5%8A%9B%E5%8D%9A%E5%AE%A2%E5%8F%91%E5%B0%84%E5%99%A8%E6%B5%8B%E8%AF%95-20260117-6.png" alt=""></p>
]]></content>
		</item>
		
		<item>
			<title>D2L自学日志02：线性回归</title>
			<link>http://localhost:1313/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9702%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/</link>
			<pubDate>Wed, 07 Jan 2026 19:27:51 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9702%E7%BA%BF%E6%80%A7%E5%9B%9E%E5%BD%92/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h1 id="线性回归">线性回归<a href="#%e7%ba%bf%e6%80%a7%e5%9b%9e%e5%bd%92" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>线性假设是指目标可以表示为特征的加权和。</p>
<blockquote>
<p>举个例子：我想做一个预测房屋售价的模型。</p>
</blockquote>
<p>房屋售价相关的数量特征有：房屋面积、房龄。那么我们就可以得到这样的式子（虽然不一定有道理）：
</p>
$$
price = w_{area} \cdot area + w_{age} \cdot age + b
$$<p>
其中$w_{area}$和$w_{age}$称为<strong>权重</strong>，代表这个特征对于结果的影响大小，比如在这个例子中，房屋面积和房龄对于售价的影响力可能不同；$b$代表<strong>偏置</strong>，用来拓展模型的表达能力（不加偏置模型只能进行线性变换，加了偏置模型可以实现仿射变换）。</p>
<p>在机器学习领域中，我们处理的对象往往是<strong>高维数据集</strong>，即特证数很可能非常多。我们可以将所有的相关特征全部塞进一个向量中。比如，我们的目标可以用$x_1,x_2,x_3,...$来描述，那么我们可以这样来表示我们的预测值$\hat{y}$：
</p>
$$
\hat{y} = \sum_{i = 1}^{n}{w_ix_i} + b
$$<p>
将所有特征塞进向量$\vec{x}$后，我们可以得到：
</p>
$$
\hat{y} = w^Tx + b
$$<p>
其中$w^T$表示权重向量，每个元素表示对应的特征的权重大小。这样，我们就用点积的形式简洁的表示了模型。</p>
<p>通过这样的模型，我们已经可以实现将一个样本的特征与其预测值实现映射。但是通常情况下，这样做并不足以解决问题，因为我们多数时候不会只有一个样本。我们理想的效果是这样：通过同一套映射规则，将多个样本的特征分别映射到各自的预测值。非常巧的是，对于线性回归模型，我们恰好有一个强大的工具可以实现这一功能：矩阵。</p>
<p>对于一个样本的特征$x_{1},x_{2},x_{3},...$，我们可以把它塞进一个行向量$\vec{x}^T$中，组成一个特征行向量；随后，让这些行向量从上至下排列，我们就得到了一个由特征数值组成的矩阵。</p>
<p>比如，对于样本a，特征行向量为$[x_{a_{1}}, x_{a_{2}}, x_{a_{3}}, ... ,x_{as}]$;对于样本b，我们有特征行向量$[x_{b_{1}},x_{b_{2}},...]$，以此类推，我们可以最后得到每一个样本的特征行向量，随后我们将它拼在一起，得到如下矩阵：
</p>
$$
X = \begin{pmatrix}
x_{a_{1}}&x_{a_{2}}&x_{a_{3}}&{...}&x_{as} \\
x_{b_{1}}&x_{b_{2}}&x_{b_{3}}&{...}&x_{bs} \\
\vdots \\
\end{pmatrix}
$$<p>
这样，我们就将整个数据集的所有样本的所以特征汇总在了一个矩阵中。我们同样将预测值从上至下排列为一个列向量$\hat{y}$，这样我们就得到了：
</p>
$$
\hat{y}= Xw + b
$$<p>
对于给定训练数据特征$\mathbf{X}$和对应的已知标签$\mathbf{y}$，线性回归的目标是找到一组权重向量$\mathbf{w}$和偏置$b$：当给定从$\mathbf{X}$的同分布中取样的新样本特征时，这组权重向量和偏置能够使得新样本预测标签的误差尽可能小。说白了，我们认为$\hat{y}$和$X$之间可能有线性关系，而我们所做的其实是希望让机器通过学习已有的样本数据来自行归纳这种潜在的线性关系。</p>
<p>但是，一个很现实的问题是：以上的所有假设都建立在目标与特征真的存在线性关系这一前提，然而现实世界中我们几乎不可能找到严格线性的数据集（现实数据的浮点数误差，你可以这么理解）。</p>
<p>所以，既然这种误差不可避免，一个很天才的想法是：我们引入一个噪声项来观察误差带来的影响。这就像听歌的时候音质不好，所以你干脆放点噪音让音质的缺陷显得非常合理。</p>
<hr>
<p>总而言之，我们的根本目标是寻找描述$X$和$\hat{y}$之间映射关系最好的一组$w,b$。但是在正式开始寻找之前，我们需要回答两个颇具哲理的问题：</p>
<ol>
<li>什么是<strong>最好</strong>？</li>
<li>如何寻找？</li>
</ol>
<p>他们分别对应于：</p>
<ol>
<li>模型质量的度量方式。</li>
<li>一种能更新模型进而提高模型质量的方式。</li>
</ol>
<hr>
<h2 id="度量质量损失函数">度量质量：损失函数<a href="#%e5%ba%a6%e9%87%8f%e8%b4%a8%e9%87%8f%e6%8d%9f%e5%a4%b1%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>对于第一个问题，我们希望通过我们的模型，最好输入$x$就能直接精确预测到$y$，换言之，什么样的映射能让$\hat{y}$和$y$之间差距最小，这样的映射就是我们所在寻找的。因此，我们可以通过量化模型的误差进而体现模型的质量。而这种量化的方式就是所谓的<strong>损失函数（loss funciton）</strong>。</p>
<p>对于一个通常的误差函数，我们希望它的输出值为非负数，这样他的大小即直接展现损失大小。在回归问题中，一个常用的损失函数是<strong>平方误差函数</strong>。我们记样本$i$的预测值为$\hat{y}^{(i)}$，其对应的真实标签为$y^{(i)}$，那么平方误差就可以定义为如下的式子：
</p>
$$
l^{(i)}(w, b)=\frac{1}{2}(\hat{y}^{(i)}-y^{(i)})^2
$$<p>
这里，之所以有一个$\frac{1}{2}$，只是因为这样做后续求导系数为1，稍微方便一点。</p>
<p>你会注意到这个式子的作用对象是一个标量，即它只反应了一个样本中的损失，但是我们希望能作用于一个数据集的所有样本。于是有一个很简单粗暴的方法：让我们算出每一个样本的损失，然后求平均。
</p>
$$
L(w,b) = \frac{1}{n}\sum_{i = 1}^{n}{l^{(i)}(w,b)}
$$<p>
这样，我们就将我们训练模型时的目的明确为：</p>
<blockquote>
<p>寻找一组参数$w^*,b^*$使得这组参数可以最小化所有训练样本中的总损失。</p>
</blockquote>
<hr>
<h2 id="解析解">解析解<a href="#%e8%a7%a3%e6%9e%90%e8%a7%a3" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>不同于我们后续会涉及到的大多数模型，线性回归的解可以用一个公式简单表达出来，即：在给定了一个数据集的时候，我们可以直接算出来最优的参数$w^*,b^*$，而无需复杂的训练过程。</p>
<p>首先，对于偏置量$b$来说，我们没必要去专门考察它在什么时候最优。我们可以对公式$\hat{y} = Xw + b$做如下调整：我们在X最左侧强行加上一列全为1的向量，然后在$w$中强行插入一个$b$，变为$\beta = [b, w_1,w_2,...]$。这样，我们可以让b的地位和其他权重保持一致。我们将问题简化为：求使得$\hat{y} = X\beta$误差最小的权重向量$\beta$。</p>
<p>对于解答这个问题，我们可以使用线性代数优美的几何本质。$X$是一个已知的矩阵，它可以把一个空间中的所有向量映射到另一个空间（即$X$的列空间）中，假如$y$就在$X$的列空间中，这就意味着我们可以用一个向量通过X变换严丝合缝的映射到$y$，这种情况就对应与数据集中的特征与目标呈现严格的线性关系。但是现实世界中我们找不到如此理想的数据集，这意味着$y$多数时候并不在$X$的列空间中。</p>
<p>此时我们回顾前面的误差函数定义，我们会发现其实我们所计算的误差是$\hat{y}$和$y$对应坐标之间的欧几里得距离（平方和，只是没开根号）。我们可以将问题简化如下：</p>
<blockquote>
<p>已知$\hat{y}$被约束在$X$的列空间中，$y$不一定在$X$的列空间中，什么情况下$\hat{y}$和$y$之间的欧几里得距离会最小？</p>
</blockquote>
<p>如果这还是很抽象，我们来看一个三维空间下的表述：</p>
<blockquote>
<p>已知$\hat{y}$在$X$列向量张成的平面或直线上，而$y$并不一定在这个平面或直线上，什么情况下$\hat{y}$和$y$之间的欧几里得距离最小？</p>
</blockquote>
<p>答案很显然：$\hat{y}$与$y$之间的差向量垂直于$X$的列空间。</p>
<p>我们令$e = y - X\beta$表示误差向量，我们希望$e$可以垂直于$X$的每一个列向量，这就意味着$e$与每个$X$列向量的点积都为0。也就是说：
</p>
$$
X^Te = 0
$$<p>
将$e$的表达式代入，我们就可以直接求得最佳的$\beta$：
</p>
$$
\beta = (X^TX)^{-1}X^Ty
$$<p>
这样我们就一次性求得了线性回归中的最优解$w^*,b^*$。</p>
<p>但是，虽然像线性回归这样的简单问题存在解析解，但是对于更加复杂的问题，我们大概率找不到一个解析解。事实上，很多问题找不到解析解并不是因为难算，而是数学意义上的无解，即我们很可能无法将特征与目标的最佳映射写成一个简单的数学公式。因此，我们没办法通过求解析解来处理深度学习的所有问题。</p>
<hr>
<h2 id="随机梯度下降">随机梯度下降<a href="#%e9%9a%8f%e6%9c%ba%e6%a2%af%e5%ba%a6%e4%b8%8b%e9%99%8d" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>即使我们不知道解析解长成什么样，但是有一点我们是确定的：特征与目标之间是存在映射关系的，即特征和目标的分布之间存在着某种规律。</p>
<p>虽然我还没有更深入地学习机器学习，但是我隐约感觉这有点像人类物理学家对物理规律的总结。比如当我们遇到一些从来没有人解释过的现象时，我们会尝试提出各种各样的猜想，并尝试依据猜想，从相关因素去预测结果。最后，我们只会留下预测最精准的猜想作为我们的科学理论。</p>
<p>但是，人类会改变思考的角度，机器不会。比如在尝试分析天体问题时，过去人们站在地球的视角用本轮和均轮描述天体运动，但是后来发现似乎从太阳的视角分析问题得到的结论会更简单。但是机器学习的原理就类似于无限地调整本轮均轮尺寸来让预测值和实际值靠近。我们只能输入数据来训练机器，让它构建一套精密的本轮均轮模型来进行预测，但是我们没办法直接从机器中提取简洁的规律，因为我们能从机器中得到的也只是那一套本轮均轮模型罢了。</p>
<hr>
<p>对于几乎所有的深度学习模型，有这样一种普适的优化方法：<em><strong>梯度下降</strong></em>。它的本质是让我们在损失函数递减的方向上更新参数（即各种权重）来降低误差。</p>
<p>我们已经构建起了由特征值到预测值的映射，对于给定的数据集，我们已知了特征和对应的真实值，而预测值可以通过我们构建的映射得到，这就意味着在给定数据集中我们实际上构建了由特征值到误差的映射，而我们要做的事情实际就是调整这套映射来让误差尽可能小。</p>
<p>我们可以用一个经典的比喻来理解梯度下降的工作原理：我们将参数视作经纬度，而误差视作一座山的海拔。对于每一个样本，我们都有这样的一座山，但是每一个样本心中的山的形状并不一样。比如，假如我们的模型有两个参数$a,b$，在样本A中可能${(a = 3, b = 2)}$的时候预测的误差最小，但是对于样本B，可能$(a = 4, b =5)$的时候误差才最小。不过，尽管山的形状大概率不同，我们仍然认为不同样本的山的形状存在一定的分布规律。</p>
<p>对于一个数据集，我们很可能有成千上万个样本，每个样本的山都堆叠在相同的经纬度，而我们一次只能存在于一个经纬度。现在我们希望找到这样的一个经纬度能让我们在每一座山上的海拔的平均值最低。</p>
<p><strong>梯度下降</strong>法认为我们可以这样实现目的：首先，我们不再去想象山的全貌，而是只去想象我们所在的经纬度的山的<strong>切面</strong>。山是一个曲面，在我们所在经纬度上与这个曲面相切的平面就是我们要找的切面。</p>
<p>然后，我们想象<strong>分别</strong>在每一个参数对应的方向上移动一个微小的位移（比如1），这样每个样本的误差山的切面上高度都会改变，有的高度会增大，有的高度会减小，我们将所有高度变化求平均值，就得到了<strong>这个参数对于平均误差变化的贡献值。</strong></p>
<p>这个贡献值为正数时，意味着随着参数变大，平均误差值也将会变大；当这个贡献值为负数时，参数变大，平均误差值则会随之变小。贡献值的绝对值越大，平均误差值随参数变化的速度也会越快。这个贡献值在数学上实际就是<strong>误差关于参数的偏导数</strong> 。</p>
<p>我们求得所有参数对误差的贡献值，然后让每个参数的贡献值乘以这个参数对应方向的单位向量，最后做矢量和，我们就得到了让<strong>平均参数上升最快的参数改变方向</strong>，而它的反向则是使平均参数下降最快的参数改变方向。</p>
<hr>
<p>在物理上，当一个标量随着空间位置而发生改变，我们称之为<strong>标量场</strong>。比如，一个中心天体附近的引力势符合一定的空间分布。在经典力学的范畴下，我们可以这样描述一个中心天体附近的引力势分布：
</p>
$$
\phi = -\frac{GM}{\sqrt{ x^2 + y^2 + z^2} }
$$<p>
其中$x,y,z$是在以天体为中心的坐标轴下的三维坐标。对于在这个坐标系下坐标为$(x,y,z)$处质量为$m$的小天体，它的引力势能等于：
</p>
$$
E_p = -\frac{GMm}{\sqrt{ x^2+y^2+z^2 }}
$$<p>
这时候，你会思考：沿着什么方向这个引力势能减小的速度最大呢？如果你有一定物理知识，你会知道等势面与保守力方向垂直，保守力的方向就是势下降最快的方向。回忆起高中物理知识，我们知道引力的表达式（不考虑相对论效应）为：
</p>
$$
\vec{F} = -\frac{GMm}{(x^2+y^2+z^2)^\frac{5}{2}}(x\hat{i} + y \hat{j} + z \hat{k})
$$<p>
如果你注意力惊人，你会发现这个表达式实际上还有另一种写法：
</p>
$$
\vec{F} = -(\hat{i}\frac{\partial E_p}{\partial x}+\hat{j}\frac{\partial E_p}{\partial y}+\hat{k}\frac{\partial E_p}{\partial z})
$$<p>
进一步缩写：
</p>
$$
\vec{F} = -\nabla E_p
$$<p>
而我们知道，误差$L=\sum w^Tx + b=F(w_{1},w_{2},w_{3},...)$，其中$L,w_{1},w_{2},w_{3},...$均为标量；引力势$\phi=F(x_{1},x_{2},x_{3})$，其中$\phi,x_{1},x_{2},x_{3}$均为标量。一个合理的猜想是：如果我们想像引力那样沿最快改变方向修改参数来降低误差，我们只需要沿着：
</p>
$$
-\nabla L
$$<p>
的方向修改参数即可。</p>
<p>事实上，这样做既在数学上是正确的，同时也是工程上已经成熟使用的方法。比如在机器学习中我们可以算出平均误差之后通过反向传播算出平均误差关于各个参数的梯度，继而通过让参数减去梯度向量的特定倍数来更新参数进而降低误差。这就是梯度下降的含义。</p>
<hr>
<p>但是，在机器学习中我们往往需要调整大量的参数并计算数以万计的样本，假如每一次更新参数都必须遍历所有的样本，这样做就必然会导致训练效率极其底下。</p>
<p>假如我们仔细思考，不难发现，其实如果我们只是确定一个大致的方向，我们用不着遍历所有的样本。理论上我们只需要从数据集中随机抽取几个样本，这几个样本同样可以一定程度反应整个数据集的特征。这就是目前工程上使用更广泛的<em><strong>随机梯度下降法</strong></em>。如果我们更新参数时只从全数据集中抽取一个固定的小数量的样本，这就是所谓的<em><strong>小批量随机梯度下降法</strong></em>。</p>
<p>在每次迭代时，我们随机抽取一个固定大小的小批量样本$\mathcal{B}$，然后我们计算这个小批量$\mathcal{B}$的平均损失，并求它对于参数的梯度，进而更新参数。</p>
<p>我们可以用下面这一公式来表示这一过程：
</p>
$$(\mathbf{w},b) \leftarrow (\mathbf{w},b) - \frac{\eta}{|\mathcal{B}|} \sum_{i \in \mathcal{B}} \partial_{(\mathbf{w},b)} l^{(i)}(\mathbf{w},b).$$<hr>
<h1 id="从零实现线性回归">从零实现线性回归<a href="#%e4%bb%8e%e9%9b%b6%e5%ae%9e%e7%8e%b0%e7%ba%bf%e6%80%a7%e5%9b%9e%e5%bd%92" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>包括：</p>
<ul>
<li>数据流水线</li>
<li>模型</li>
<li>损失函数</li>
<li>小批量随机梯度下降优化器</li>
</ul>
<h2 id="step01生成数据集">step01：生成数据集<a href="#step01%e7%94%9f%e6%88%90%e6%95%b0%e6%8d%ae%e9%9b%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>为了训练模型，我们需要准备训练用的数据集。因为我们将要实现的是线性回归模型，理所当然的，我们希望我们的数据在一定误差范围内符合线性关系。所以，我们生成数据集的思路是在一个线性模型的基础上添加随机噪声。</p>
<p>在本例中，我们构建一个这样的线性模型：一个标签，两个特征。其中参数$w = [2,-3.4]^T,b = 4.2$，此外还有一个随机噪声$\epsilon$，服从均值为0，标准差为0.01的正态分布：
</p>
$$
y = xw + b + \epsilon
$$<p>
实现如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">synthetic_data</span>(w, b, num_examples):  <span style="color:#75715e">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;生成y=Xw+b+噪声&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    X <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, (num_examples, len(w)))
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>matmul(X, w) <span style="color:#f92672">+</span> b
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">+=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, y<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> X, y<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>))
</span></span></code></pre></div><p><code>torch.normal()</code>：三个参数依次是平均值、标准差、形状。</p>
<p><code>torch.matmul()</code>：顾名思义，矩阵乘法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>true_w <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>Tensor([<span style="color:#ae81ff">2</span>,<span style="color:#f92672">-</span><span style="color:#ae81ff">3.4</span>])
</span></span><span style="display:flex;"><span>true_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4.2</span> 
</span></span><span style="display:flex;"><span>features, labels <span style="color:#f92672">=</span> synthetic_data(true_w, true_b, <span style="color:#ae81ff">1000</span>)
</span></span></code></pre></div><p>按照计划设置数据集参数。如果一切正常，<code>features</code>将会是一个形状为(1000, 2)的tensor，<code>labels</code>将会是一个形状为(1000, 1)的tensor。</p>
<p>我们尝试打印某次生成的数据的前10个：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;features: &#34;</span>, features[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">10</span>], <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">labels: &#34;</span>, labels[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">10</span>])
</span></span></code></pre></div><p>结果：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>features:  tensor([[ <span style="color:#ae81ff">0.6174</span>,  <span style="color:#ae81ff">0.7957</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.5489</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.3956</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.0109</span>,  <span style="color:#ae81ff">1.5542</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.5645</span>,  <span style="color:#ae81ff">1.4945</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.7462</span>,  <span style="color:#ae81ff">0.4104</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.8710</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.4334</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.2848</span>,  <span style="color:#ae81ff">0.1450</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.0261</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.5976</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.0452</span>,  <span style="color:#ae81ff">0.4699</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.0985</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.5582</span>]]) 
</span></span><span style="display:flex;"><span>labels:  tensor([[ <span style="color:#ae81ff">2.7369</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">8.6462</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.0495</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.2449</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">4.2774</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">7.4146</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">3.1246</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">7.5757</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">4.6824</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">6.2991</span>]])
</span></span></code></pre></div><p>简单计算可以验证这组数据大致符合我们的需求。</p>
<h2 id="step02读取数据集">step02：读取数据集<a href="#step02%e8%af%bb%e5%8f%96%e6%95%b0%e6%8d%ae%e9%9b%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>成功建立数据集之后我们需要读取数据集。在前文中我们介绍了<strong>小批量随机梯度下降</strong>，此处我们尝试来实现这一模型优化策略。我们定义一个<code>data_iter()</code>函数来从数据集中随机采样，返回一个大小为<code>batch_size</code>的小批量，每个小批量包含一组标签和特征。</p>
<p>实现如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">data_iter</span>(batch_size, features, labels):
</span></span><span style="display:flex;"><span>    num_examples <span style="color:#f92672">=</span> len(features)
</span></span><span style="display:flex;"><span>    indices <span style="color:#f92672">=</span> list(range(num_examples))
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 这些样本是随机读取的，没有特定的顺序</span>
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>shuffle(indices)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, num_examples, batch_size):
</span></span><span style="display:flex;"><span>        batch_indices <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(
</span></span><span style="display:flex;"><span>            indices[i: min(i <span style="color:#f92672">+</span> batch_size, num_examples)])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">yield</span> features[batch_indices], labels[batch_indices]
</span></span></code></pre></div><p>此处使用了python独有的生成器语法。简单来说，调用这个函数我们并不直接得到小批量样本，而是得到一个迭代器。比如<code>iter = data_iter(...)</code>后，<code>iter</code>并不是一个小批量样本张量。想要从中提取一组样本，我们需要调用<code>next(iter)</code>，或者使用for循环遍历。这样做的好处是节省内存，做到流式内容读取，适用于处理大数据集。（ps：如果学过CS61A，你会很熟悉这个语法。）</p>
<p>如上的采样实现原理是：先生成一个打乱的索引列表，然后从中每<code>batch_size</code>个索引组成一个batch，并返回对应的特征以及标签。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>BATCH_SIZE <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> data_iter(BATCH_SIZE, features, labels):
</span></span><span style="display:flex;"><span>    print(X, <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, y)
</span></span><span style="display:flex;"><span>    counter <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> counter <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>
</span></span></code></pre></div><p><code>data_iter</code>本质上一次性生成了所有的batch。在如上的检验代码中，我们设定一个batch大小为10，并从生成的batch中读取前4个。在某次读取后结果如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tensor([[<span style="color:#f92672">-</span><span style="color:#ae81ff">1.1099</span>,  <span style="color:#ae81ff">1.6687</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.3618</span>,  <span style="color:#ae81ff">0.1041</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0529</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.2535</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.2494</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.7070</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.1251</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">2.0001</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.4389</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.8865</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.2365</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.4293</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.3268</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.2949</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.1298</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.2571</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.1921</span>,  <span style="color:#ae81ff">0.2929</span>]]) 
</span></span><span style="display:flex;"><span> tensor([[<span style="color:#f92672">-</span><span style="color:#ae81ff">3.7069</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">4.5750</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">4.9620</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">4.0994</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">15.2621</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">10.0946</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">6.1369</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.5313</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.8041</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">7.5802</span>]])
</span></span><span style="display:flex;"><span>tensor([[<span style="color:#f92672">-</span><span style="color:#ae81ff">1.6883</span>,  <span style="color:#ae81ff">1.4908</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.0874</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.0492</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.4867</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.2907</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.6112</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.7551</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.6087</span>,  <span style="color:#ae81ff">0.1846</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.5941</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.2927</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.2502</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">2.2800</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.9777</span>,  <span style="color:#ae81ff">0.4598</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.2728</span>,  <span style="color:#ae81ff">1.0429</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.2092</span>,  <span style="color:#ae81ff">1.1009</span>]]) 
</span></span><span style="display:flex;"><span> tensor([[<span style="color:#f92672">-</span><span style="color:#ae81ff">4.2361</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">6.5448</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">6.1642</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">3.5481</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.3488</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">9.7791</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">14.4587</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">1.3148</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.1061</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.8728</span>]])
</span></span><span style="display:flex;"><span>tensor([[<span style="color:#f92672">-</span><span style="color:#ae81ff">0.1582</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.5111</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.0206</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.8523</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.6847</span>,  <span style="color:#ae81ff">0.0036</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.1984</span>,  <span style="color:#ae81ff">0.6702</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5487</span>,  <span style="color:#ae81ff">1.7227</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">3.1342</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0611</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.8778</span>,  <span style="color:#ae81ff">0.0670</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">2.2774</span>,  <span style="color:#ae81ff">1.6131</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.4362</span>,  <span style="color:#ae81ff">0.2129</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.4503</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.7968</span>]]) 
</span></span><span style="display:flex;"><span> tensor([[ <span style="color:#ae81ff">5.6233</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">10.5495</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.8155</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">4.3185</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">2.7354</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">14.0680</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.2155</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">5.8575</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">2.6139</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">7.8082</span>]])
</span></span><span style="display:flex;"><span>tensor([[<span style="color:#f92672">-</span><span style="color:#ae81ff">0.1396</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.8441</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.4309</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.8643</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">0.3181</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.7736</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">1.1347</span>,  <span style="color:#ae81ff">0.1844</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.3201</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.1031</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.1408</span>,  <span style="color:#ae81ff">0.5805</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.2353</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.6993</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.6425</span>,  <span style="color:#ae81ff">1.3151</span>],
</span></span><span style="display:flex;"><span>        [ <span style="color:#ae81ff">0.4438</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.0837</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#f92672">-</span><span style="color:#ae81ff">2.6588</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.6255</span>]]) 
</span></span><span style="display:flex;"><span> tensor([[<span style="color:#ae81ff">6.7791</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">7.9966</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">6.1920</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">5.8500</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">5.1947</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">2.5164</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">7.0426</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">1.0002</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">8.7780</span>],
</span></span><span style="display:flex;"><span>        [<span style="color:#ae81ff">0.9943</span>]])
</span></span></code></pre></div><p>每两个tensor构成一组feature和label。</p>
<h2 id="step03初始化模型参数">step03：初始化模型参数<a href="#step03%e5%88%9d%e5%a7%8b%e5%8c%96%e6%a8%a1%e5%9e%8b%e5%8f%82%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>随机创建一组初始参数作为初始值。在下面的代码中，我们通过均值为0、标准差为0.01的正态分布采样来初始化权重，并将偏置初始化为0。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>w <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>b <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(<span style="color:#ae81ff">1</span>, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span></code></pre></div><p>在初始化参数之后，我们的任务是更新这些参数，直到这些参数足够拟合我们的数据。每次更新都需要计算损失函数关于模型参数的梯度。有了这个梯度，我们就可以向减小损失的方向更新每个参数。</p>
<h2 id="step04定义模型">step04：定义模型<a href="#step04%e5%ae%9a%e4%b9%89%e6%a8%a1%e5%9e%8b" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>我们已经获得了数据集，得到了参数张量，现在我们想要计算得到预测值，所以我们需要按照我们之前规划的参数、特征与目标之间的映射关系建立模型。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">linreg</span>(X, w, b): 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;线性回归模型&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>matmul(X, w) <span style="color:#f92672">+</span> b
</span></span></code></pre></div><p>此处使用了pytorch以及很多其他数据科学库中常见的广播机制，b是一个数字，但是前面的<code>torch.matmul()</code>会得到一个向量。向量+数字，结果是向量中的每个元素都加上数字。</p>
<p>模型的地位是我们希望产出的产品。我们希望通过训练来得到参数最优的模型。因此，训练的过程本质就是不断的让模型进行计算，每次计算后根据结果更新参数，参数达到最优后，这套嵌入了最优参数的模型就可以用作实际用途，你可以输入特征让它预测结果。</p>
<h2 id="step05定义损失函数">step05：定义损失函数<a href="#step05%e5%ae%9a%e4%b9%89%e6%8d%9f%e5%a4%b1%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>按照计划，我们将预测值与真实值之差的平方值的$\frac{1}{2}$作为损失值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">squared_loss</span>(y_hat, y):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;均方损失&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (y_hat <span style="color:#f92672">-</span> y<span style="color:#f92672">.</span>reshape(y_hat<span style="color:#f92672">.</span>shape)) <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
</span></span></code></pre></div><p>得到的是一个损失向量，每个元素代表对应的样本在当前模型计算下的损失值。</p>
<h2 id="step06定义优化算法">step06：定义优化算法<a href="#step06%e5%ae%9a%e4%b9%89%e4%bc%98%e5%8c%96%e7%ae%97%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>尽管线性回归存在解析解，此处我们仍然使用小批量梯度下降法来尝试找到最优解。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sgd</span>(params, lr, batch_size):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;小批量随机梯度下降&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> param <span style="color:#f92672">in</span> params:
</span></span><span style="display:flex;"><span>            param <span style="color:#f92672">-=</span> lr <span style="color:#f92672">*</span> param<span style="color:#f92672">.</span>grad <span style="color:#f92672">/</span> batch_size
</span></span><span style="display:flex;"><span>            param<span style="color:#f92672">.</span>grad<span style="color:#f92672">.</span>zero_()
</span></span></code></pre></div><p><code>with torch.no_grad()</code>明确在此代码块中进行的计算不会被记入torch计算图中。我们优化参数不免要利用一些和参数相关的计算，但是这些计算并不在模型的计算过程内，更新参数的计算过程和误差的产生毫无关联，因此我们需要这样做来与计算图隔离。</p>
<p>你可能会注意到，我们前面定义的损失函数并不是一个平均值，而是单纯的平方和，这就意味着损失大小会随着batch大小改变而改变。因此在更新参数的时候我们需要做一步额外的标准化操作：让<code>param</code>的改变值除以<code>batch_size</code>，这样对于相同的样本，不管<code>batch_size</code>大小如何，我们都可以得到一样的改变量。</p>
<p>最后，每次更新完一个参数，我们将参数的梯度归零，方便进行下一次训练。</p>
<h2 id="step07训练">step07：训练<a href="#step07%e8%ae%ad%e7%bb%83" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>训练的过程中我们不断地会经历正向传播、反向传播、更新参数的循环，周而复始直到完成一个数据集全部数据的训练，我们称这样一个过程为一个<em>迭代周期</em>。我们大致要做这样的逻辑：</p>
<ul>
<li>初始化参数</li>
<li>重复以下训练直到完成所有数据集的训练：
<ul>
<li>计算梯度</li>
<li>更新参数</li>
</ul>
</li>
</ul>
<p>在每个迭代周期中，我们将使用<code>data_iter</code>遍历数据集中的每个样本。在此过程中迭代周期数量以及学习率都是所谓的<em>超参数</em>，它们并不是我们通过训练可以优化的，只能通过实验经验来调整优化。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>lr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.03</span>
</span></span><span style="display:flex;"><span>num_epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>net <span style="color:#f92672">=</span> linreg
</span></span><span style="display:flex;"><span>loss <span style="color:#f92672">=</span> squared_loss
</span></span></code></pre></div><p>规定一下后续会用到的参数和相关函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> data_iter(batch_size, features, labels):
</span></span><span style="display:flex;"><span>        l <span style="color:#f92672">=</span> loss(net(X, w, b), y)  <span style="color:#75715e"># X和y的小批量损失</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 因为l形状是(batch_size,1)，而不是一个标量。l中的所有元素被加到一起，</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 并以此计算关于[w,b]的梯度</span>
</span></span><span style="display:flex;"><span>        l<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>        sgd([w, b], lr, batch_size)  <span style="color:#75715e"># 使用参数的梯度更新参数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        train_l <span style="color:#f92672">=</span> loss(net(features, w, b), labels)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;epoch </span><span style="color:#e6db74">{</span>epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, loss </span><span style="color:#e6db74">{</span>float(train_l<span style="color:#f92672">.</span>mean())<span style="color:#e6db74">:</span><span style="color:#e6db74">f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p>因为数据集是我们自己生成的，我们知道最优参数的标准答案为$w = [2,-3.4]^T,b = 4.2$，所以我们可以据此来衡量模型训练的成效。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;w的估计误差: </span><span style="color:#e6db74">{</span>true_w <span style="color:#f92672">-</span> w<span style="color:#f92672">.</span>reshape(true_w<span style="color:#f92672">.</span>shape)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;b的估计误差: </span><span style="color:#e6db74">{</span>true_b <span style="color:#f92672">-</span> b<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p>完整代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">synthetic_data</span>(w: torch<span style="color:#f92672">.</span>Tensor, b: float, num_examples: int):
</span></span><span style="display:flex;"><span>    X <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, (num_examples, len(w)))
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>matmul(X, w) <span style="color:#f92672">+</span> b
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">+=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, y<span style="color:#f92672">.</span>shape)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> X, y<span style="color:#f92672">.</span>reshape((<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>true_w <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>Tensor([<span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3.4</span>])
</span></span><span style="display:flex;"><span>true_b <span style="color:#f92672">=</span> <span style="color:#ae81ff">4.2</span>
</span></span><span style="display:flex;"><span>features, labels <span style="color:#f92672">=</span> synthetic_data(true_w, true_b, <span style="color:#ae81ff">1000</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(&#34;features: &#34;, features[0:10], &#34;\nlabels: &#34;, labels[0:10])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">data_iter</span>(batch_size, features, labels):
</span></span><span style="display:flex;"><span>    num_examples <span style="color:#f92672">=</span> len(features)
</span></span><span style="display:flex;"><span>    indices <span style="color:#f92672">=</span> list(range(num_examples))
</span></span><span style="display:flex;"><span>    random<span style="color:#f92672">.</span>shuffle(indices)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>, num_examples, batch_size):
</span></span><span style="display:flex;"><span>        batch_indices <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(indices[i : min(i <span style="color:#f92672">+</span> batch_size, num_examples)])
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">yield</span> features[batch_indices], labels[batch_indices]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>w <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>normal(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0.01</span>, size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>b <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(<span style="color:#ae81ff">1</span>, requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">linreg</span>(X, w, b):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;线性回归模型&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>matmul(X, w) <span style="color:#f92672">+</span> b
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">squared_loss</span>(y_hat, y):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;均方损失&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (y_hat <span style="color:#f92672">-</span> y<span style="color:#f92672">.</span>reshape(y_hat<span style="color:#f92672">.</span>shape)) <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sgd</span>(params, lr, batch_size):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;小批量随机梯度下降&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> param <span style="color:#f92672">in</span> params:
</span></span><span style="display:flex;"><span>            param <span style="color:#f92672">-=</span> lr <span style="color:#f92672">*</span> param<span style="color:#f92672">.</span>grad <span style="color:#f92672">/</span> batch_size
</span></span><span style="display:flex;"><span>            param<span style="color:#f92672">.</span>grad<span style="color:#f92672">.</span>zero_()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>lr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.03</span>
</span></span><span style="display:flex;"><span>num_epochs <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>net <span style="color:#f92672">=</span> linreg
</span></span><span style="display:flex;"><span>loss <span style="color:#f92672">=</span> squared_loss
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>batch_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> epoch <span style="color:#f92672">in</span> range(num_epochs):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> X, y <span style="color:#f92672">in</span> data_iter(batch_size, features, labels):
</span></span><span style="display:flex;"><span>        l <span style="color:#f92672">=</span> loss(net(X, w, b), y)  <span style="color:#75715e"># X和y的小批量损失</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 因为l形状是(batch_size,1)，而不是一个标量。l中的所有元素被加到一起，</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 并以此计算关于[w,b]的梯度</span>
</span></span><span style="display:flex;"><span>        l<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>        sgd([w, b], lr, batch_size)  <span style="color:#75715e"># 使用参数的梯度更新参数</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> torch<span style="color:#f92672">.</span>no_grad():
</span></span><span style="display:flex;"><span>        train_l <span style="color:#f92672">=</span> loss(net(features, w, b), labels)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;epoch </span><span style="color:#e6db74">{</span>epoch <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#e6db74">}</span><span style="color:#e6db74">, loss </span><span style="color:#e6db74">{</span>float(train_l<span style="color:#f92672">.</span>mean())<span style="color:#e6db74">:</span><span style="color:#e6db74">f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;w的估计误差: </span><span style="color:#e6db74">{</span>true_w <span style="color:#f92672">-</span> w<span style="color:#f92672">.</span>reshape(true_w<span style="color:#f92672">.</span>shape)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;b的估计误差: </span><span style="color:#e6db74">{</span>true_b <span style="color:#f92672">-</span> b<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span></code></pre></div><p>某次输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>epoch <span style="color:#ae81ff">1</span>, loss <span style="color:#ae81ff">0.036131</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">2</span>, loss <span style="color:#ae81ff">0.000128</span>
</span></span><span style="display:flex;"><span>epoch <span style="color:#ae81ff">3</span>, loss <span style="color:#ae81ff">0.000046</span>
</span></span><span style="display:flex;"><span>w的估计误差: tensor([<span style="color:#f92672">-</span><span style="color:#ae81ff">0.0004</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.0010</span>], grad_fn<span style="color:#f92672">=&lt;</span>SubBackward0<span style="color:#f92672">&gt;</span>)
</span></span><span style="display:flex;"><span>b的估计误差: tensor([<span style="color:#ae81ff">0.0002</span>], grad_fn<span style="color:#f92672">=&lt;</span>RsubBackward1<span style="color:#f92672">&gt;</span>)
</span></span></code></pre></div><p>训练了3个迭代周期，最后得到的参数与最优参数之间误差在e-04数量级。</p>
<p>总结来说，使用梯度下降法无法得到最优参数的真实值，我们也并不关心如何恢复真实参数。我们真正希望实现的是高度准确的预测参数。</p>
]]></content>
		</item>
		
		<item>
			<title>Fabric自学日志01：农夫乐事重织版</title>
			<link>http://localhost:1313/zh-cn/posts/fabric%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701%E5%86%9C%E5%A4%AB%E4%B9%90%E4%BA%8B%E9%87%8D%E7%BB%87%E7%89%88/</link>
			<pubDate>Thu, 01 Jan 2026 21:00:42 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/fabric%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701%E5%86%9C%E5%A4%AB%E4%B9%90%E4%BA%8B%E9%87%8D%E7%BB%87%E7%89%88/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>我一直很想做mc模组，但是奈何java开发经验约等于0。今天终于决定开始认真研究fabric模组开发，之后也应该会一直更新fabric学习笔记。</p>
<p>程序员森呸们都说，读代码就是学习写代码最好的方式，于是今天第一弹先来研究一下FarmersDelightRefabricated的文件结构与代码组成。FarmersDelightRefabricated即农夫乐事：重织版，是经典模组农夫乐事的fabric端移植版。</p>
<p>🔗参考链接：</p>
<p><a href="https://github.com/MehVahdJukaar/FarmersDelightRefabricated">FarmersDelightRefabricatedGithub主页</a></p>
<p><a href="https://docs.fabricmc.net/develop/">fabric文档</a></p>
<p><a href="https://www.mcmod.cn/class/14196.html">mcmod页面</a></p>
<hr>
<h2 id="文件结构">文件结构<a href="#%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>📁 .
</span></span><span style="display:flex;"><span>├── 📁 build
</span></span><span style="display:flex;"><span>│   ├── 📁 classes
</span></span><span style="display:flex;"><span>│   ├── 📁 datagen
</span></span><span style="display:flex;"><span>│   ├── 📁 generated
</span></span><span style="display:flex;"><span>│   ├── 📁 loom-cache
</span></span><span style="display:flex;"><span>│   ├── 📁 reports
</span></span><span style="display:flex;"><span>│   ├── 📁 resources
</span></span><span style="display:flex;"><span>│   └── 📁 tmp
</span></span><span style="display:flex;"><span>├── 📄 build.gradle
</span></span><span style="display:flex;"><span>├── 📄 changelog.md
</span></span><span style="display:flex;"><span>├── 📁 gradle
</span></span><span style="display:flex;"><span>│   └── 📁 wrapper
</span></span><span style="display:flex;"><span>├── 📄 gradle.properties
</span></span><span style="display:flex;"><span>├── 📄 gradlew
</span></span><span style="display:flex;"><span>├── 📄 gradlew.bat
</span></span><span style="display:flex;"><span>├── 📄 LICENSE
</span></span><span style="display:flex;"><span>├── 📄 README.md
</span></span><span style="display:flex;"><span>├── 📁 run
</span></span><span style="display:flex;"><span>│   ├── 📁 config
</span></span><span style="display:flex;"><span>│   ├── 📁 data
</span></span><span style="display:flex;"><span>│   ├── 📁 downloads
</span></span><span style="display:flex;"><span>│   ├── 📁 logs
</span></span><span style="display:flex;"><span>│   ├── 📁 mods
</span></span><span style="display:flex;"><span>│   ├── 📄 options.txt
</span></span><span style="display:flex;"><span>│   ├── 📁 resourcepacks
</span></span><span style="display:flex;"><span>│   ├── 📁 resources
</span></span><span style="display:flex;"><span>│   ├── 📁 saves
</span></span><span style="display:flex;"><span>│   └── 📄 usercache.json
</span></span><span style="display:flex;"><span>├── 📄 settings.gradle
</span></span><span style="display:flex;"><span>└── 📁 src
</span></span><span style="display:flex;"><span>    ├── 📁 generated
</span></span><span style="display:flex;"><span>    └── 📁 main
</span></span></code></pre></div><p>如上是进入根目录后<code>lt -L 2</code>得到的，所以并没有展开到底，大多数代码文件都没有被包含在以上展示的内容中。不过我们可以先来就此分析一下一个fabric模组的主体结构。</p>
<h3 id="gradle构建文件">Gradle构建文件<a href="#gradle%e6%9e%84%e5%bb%ba%e6%96%87%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>决定了项目如何编译以及有哪些依赖。</p>
<h4 id="gradle文件buildgradle">Gradle文件：<code>build.gradle</code><a href="#gradle%e6%96%87%e4%bb%b6buildgradle" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>最核心的文件，定义了一个模组的版本、名称、依赖关系、服务端还是客户端等基本信息。</p>
<p><img src="/zh-cn/posts/fabric%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701%E5%86%9C%E5%A4%AB%E4%B9%90%E4%BA%8B%E9%87%8D%E7%BB%87%E7%89%88/build.gradle.png" alt=""></p>
<h4 id="gradle文件gradleproperties">Gradle文件：<code>gradle.properties</code><a href="#gradle%e6%96%87%e4%bb%b6gradleproperties" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>配置文件，存放Minecraft版本、模组基本信息、fabric loader版本、依赖模组的名称和版本。</p>
<p><img src="/zh-cn/posts/fabric%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701%E5%86%9C%E5%A4%AB%E4%B9%90%E4%BA%8B%E9%87%8D%E7%BB%87%E7%89%88/gradle.properties.png" alt=""></p>
<h4 id="gradle文件settingsgradle">Gradle文件：<code>settings.gradle</code><a href="#gradle%e6%96%87%e4%bb%b6settingsgradle" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>定义项目名称。</p>
<p><img src="/zh-cn/posts/fabric%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701%E5%86%9C%E5%A4%AB%E4%B9%90%E4%BA%8B%E9%87%8D%E7%BB%87%E7%89%88/setting.gradle.png" alt=""></p>
<h4 id="gradle文件gradlew--gradlewbat">Gradle文件：<code>gradlew &amp; gradlew.bat</code><a href="#gradle%e6%96%87%e4%bb%b6gradlew--gradlewbat" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>一键编译模组的脚本。运行<code>./gradlew build</code>后即使电脑上没有安装gradle也可以编译。</p>
<h4 id="gradle文件gradlewrapper">Gradle文件：<code>gradle/wrapper</code><a href="#gradle%e6%96%87%e4%bb%b6gradlewrapper" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>存放让上面的脚本可以正常工作的小程序。</p>
<hr>
<h3 id="src源文件">src源文件<a href="#src%e6%ba%90%e6%96%87%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<h4 id="核心目录srcmain">核心目录：<code>src/main</code><a href="#%e6%a0%b8%e5%bf%83%e7%9b%ae%e5%bd%95srcmain" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>模组的主体，包含所有.java代码以及贴图、模型等资源。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>📁 .
</span></span><span style="display:flex;"><span>├── 📁 java
</span></span><span style="display:flex;"><span>│   └── 📁 vectorwing
</span></span><span style="display:flex;"><span>│       └── 📁 farmersdelight
</span></span><span style="display:flex;"><span>│           ├── 📁 client
</span></span><span style="display:flex;"><span>│           ├── 📁 common
</span></span><span style="display:flex;"><span>│           ├── 📁 data
</span></span><span style="display:flex;"><span>│           ├── ☕ FarmersDelight.java
</span></span><span style="display:flex;"><span>│           ├── 📁 integration
</span></span><span style="display:flex;"><span>│           └── 📁 refabricated
</span></span><span style="display:flex;"><span>└── 📁 resources
</span></span><span style="display:flex;"><span>    ├── 📁 assets
</span></span><span style="display:flex;"><span>    │   ├── 📁 emi
</span></span><span style="display:flex;"><span>    │   │   └── 📁 recipe
</span></span><span style="display:flex;"><span>    │   └── 📁 farmersdelight
</span></span><span style="display:flex;"><span>    │       ├── 📁 atlases
</span></span><span style="display:flex;"><span>    │       ├── 📁 blockstates
</span></span><span style="display:flex;"><span>    │       ├── 📁 lang
</span></span><span style="display:flex;"><span>    │       ├── 📁 models
</span></span><span style="display:flex;"><span>    │       ├── 📁 particles
</span></span><span style="display:flex;"><span>    │       ├── 📁 sounds
</span></span><span style="display:flex;"><span>    │       ├── 📄 sounds.json
</span></span><span style="display:flex;"><span>    │       └── 📁 textures
</span></span><span style="display:flex;"><span>    ├── 📁 data
</span></span><span style="display:flex;"><span>    │   └── 📁 farmersdelight
</span></span><span style="display:flex;"><span>    │       ├── 📁 create
</span></span><span style="display:flex;"><span>    │       ├── 📁 damage_type
</span></span><span style="display:flex;"><span>    │       ├── 📁 loot_modifiers
</span></span><span style="display:flex;"><span>    │       ├── 📁 loot_table
</span></span><span style="display:flex;"><span>    │       ├── 📁 neoforge
</span></span><span style="display:flex;"><span>    │       ├── 📁 recipe
</span></span><span style="display:flex;"><span>    │       ├── 📁 scripts
</span></span><span style="display:flex;"><span>    │       ├── 📁 structure
</span></span><span style="display:flex;"><span>    │       ├── 📁 tags
</span></span><span style="display:flex;"><span>    │       ├── 📁 weapon_attributes
</span></span><span style="display:flex;"><span>    │       └── 📁 worldgen
</span></span><span style="display:flex;"><span>    ├── 📄 fabric.mod.json
</span></span><span style="display:flex;"><span>    ├── 📄 farmersdelight.accesswidener
</span></span><span style="display:flex;"><span>    ├── 📄 farmersdelight.mixins.json
</span></span><span style="display:flex;"><span>    └── 🖼️ icon.png
</span></span></code></pre></div><h4 id="java目录srcmainjava">java目录：<code>src/main/java</code><a href="#java%e7%9b%ae%e5%bd%95srcmainjava" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>所有的Java代码所在地。</p>
<h4 id="素材资源目录srcmainresources">素材资源目录：<code>src/main/resources</code><a href="#%e7%b4%a0%e6%9d%90%e8%b5%84%e6%ba%90%e7%9b%ae%e5%bd%95srcmainresources" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>素材所在地。</p>
<ul>
<li><code>src/main/resources/assets</code>存放贴图、模型、语言、声音文件。</li>
<li><code>src/main/resources/data</code>存放合成表、战利品、标签。</li>
<li><code>src/main/resources/fabric.mod.json</code>记录模组id、名称、入口类等。</li>
</ul>
<hr>
<h4 id="生成资源目录srcgenerated">生成资源目录：<code>src/generated</code><a href="#%e7%94%9f%e6%88%90%e8%b5%84%e6%ba%90%e7%9b%ae%e5%bd%95srcgenerated" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>使用代码生成的游戏数据。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>📁 .
</span></span><span style="display:flex;"><span>└── 📁 resources
</span></span><span style="display:flex;"><span>    └── 📁 data
</span></span><span style="display:flex;"><span>        ├── 📁 c
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 create
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 createaddition
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 farmersdelight
</span></span><span style="display:flex;"><span>        │   ├── 📁 advancement
</span></span><span style="display:flex;"><span>        │   ├── 📁 enchantment
</span></span><span style="display:flex;"><span>        │   ├── 📁 loot_table
</span></span><span style="display:flex;"><span>        │   ├── 📁 recipe
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 minecraft
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 neoforge
</span></span><span style="display:flex;"><span>        │   ├── 📁 data_maps
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 origins
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        ├── 📁 sereneseasons
</span></span><span style="display:flex;"><span>        │   └── 📁 tags
</span></span><span style="display:flex;"><span>        └── 📁 tconstruct
</span></span><span style="display:flex;"><span>            └── 📁 tags
</span></span></code></pre></div><p>以上是<code>src/generated</code>目录下的4级文件树，仍然没有展开到底。展开到底后是各种.json文件。</p>
<hr>
<h3 id="run">run<a href="#run" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>当你点击 IDE 里的“运行游戏”时，它会把这里当成一个独立的 Minecraft 根目录。</p>
<h4 id="存档目录runsaves">存档目录：<!-- raw HTML omitted --><code>run/saves</code><!-- raw HTML omitted --><a href="#%e5%ad%98%e6%a1%a3%e7%9b%ae%e5%bd%95runsaves" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>存档。</p>
<h4 id="运行日志目录runlogs">运行日志目录：<!-- raw HTML omitted --><code>run/logs</code><!-- raw HTML omitted --><a href="#%e8%bf%90%e8%a1%8c%e6%97%a5%e5%bf%97%e7%9b%ae%e5%bd%95runlogs" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>崩溃或调试时的日志。</p>
<h4 id="配置目录runconfig">配置目录：<!-- raw HTML omitted --><code>run/config</code><!-- raw HTML omitted --><a href="#%e9%85%8d%e7%bd%ae%e7%9b%ae%e5%bd%95runconfig" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>模组配置文件，可以包含本模组以及独立根目录的其他模组的测试文件。</p>
<h4 id="模组目录runmods">模组目录：<!-- raw HTML omitted --><code>run/mods</code><!-- raw HTML omitted --><a href="#%e6%a8%a1%e7%bb%84%e7%9b%ae%e5%bd%95runmods" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>调试时想要加载的其他模组，比如jei。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>📁 .
</span></span><span style="display:flex;"><span>├── 📁 config
</span></span><span style="display:flex;"><span>│   ├── 📁 fabric
</span></span><span style="display:flex;"><span>│   │   └── 📄 indigo-renderer.properties
</span></span><span style="display:flex;"><span>│   ├── 📄 farmersdelight-client.json
</span></span><span style="display:flex;"><span>│   ├── 📄 farmersdelight-common.json
</span></span><span style="display:flex;"><span>│   └── 📄 modmenu.json
</span></span><span style="display:flex;"><span>├── 📁 data
</span></span><span style="display:flex;"><span>│   └── 📄 fabricDefaultResourcePacks.dat
</span></span><span style="display:flex;"><span>├── 📁 downloads
</span></span><span style="display:flex;"><span>│   └── 📄 log.json
</span></span><span style="display:flex;"><span>├── 📁 logs
</span></span><span style="display:flex;"><span>│   ├──  debug.log
</span></span><span style="display:flex;"><span>│   ├──  latest.log
</span></span><span style="display:flex;"><span>│   └── 📁 telemetry
</span></span><span style="display:flex;"><span>├── 📁 mods
</span></span><span style="display:flex;"><span>├──  options.txt
</span></span><span style="display:flex;"><span>├── 📁 resourcepacks
</span></span><span style="display:flex;"><span>├── 📁 resources
</span></span><span style="display:flex;"><span>├── 📁 saves
</span></span><span style="display:flex;"><span>│   └── 📁 <span style="color:#e6db74">&#39;New World&#39;</span>
</span></span><span style="display:flex;"><span>│       ├── 📁 advancements
</span></span><span style="display:flex;"><span>│       ├── 📁 data
</span></span><span style="display:flex;"><span>│       ├── 📁 datapacks
</span></span><span style="display:flex;"><span>│       ├── 📁 DIM-1
</span></span><span style="display:flex;"><span>│       ├── 📁 DIM1
</span></span><span style="display:flex;"><span>│       ├── 📁 entities
</span></span><span style="display:flex;"><span>│       ├── 🖼️ icon.png
</span></span><span style="display:flex;"><span>│       ├── 📄 level.dat
</span></span><span style="display:flex;"><span>│       ├── 📄 level.dat_old
</span></span><span style="display:flex;"><span>│       ├── 📁 playerdata
</span></span><span style="display:flex;"><span>│       ├── 📁 poi
</span></span><span style="display:flex;"><span>│       ├── 📁 region
</span></span><span style="display:flex;"><span>│       ├── 🔒 session.lock
</span></span><span style="display:flex;"><span>│       └── 📁 stats
</span></span><span style="display:flex;"><span>└── 📄 usercache.json
</span></span></code></pre></div><hr>
<h3 id="编译产物build">编译产物build<a href="#%e7%bc%96%e8%af%91%e4%ba%a7%e7%89%a9build" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>每次编译后gradle自动生成的文件夹，存放编译时的各种临时文件。此文件夹可以随时删除，下次编译的时候会自动生成。</p>
<hr>
<h1 id="如何正确地看待一个fabric模组的文件结构">如何正确地看待一个fabric模组的文件结构？<a href="#%e5%a6%82%e4%bd%95%e6%ad%a3%e7%a1%ae%e5%9c%b0%e7%9c%8b%e5%be%85%e4%b8%80%e4%b8%aafabric%e6%a8%a1%e7%bb%84%e7%9a%84%e6%96%87%e4%bb%b6%e7%bb%93%e6%9e%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>从上面的简要分析中，你会意识到一个问题：即使是一个看起来其貌不扬的模组，它的文件结构也复杂到了相当逆天的水平。对于我们这种人类程序员来说，我们很难做到手动修改每一个地方来实现功能。一个正常的想法是：这样的模组项目真的是人能组织起来的？</p>
<p>答案是还真不是，这就是java带给我的自信。真实情况是：一个fabric模组看起来结构非常复杂，但是对于其中的绝大多数文件，你其实根本无需去改动。</p>
<ul>
<li><strong>Gradle文件</strong>：除非你要修改版本号或者添加依赖，否则基本无需修改。</li>
<li><strong>&quot;.&ldquo;开头的隐藏文件</strong>：无视。</li>
<li><strong>src/main</strong>：实际的工作区，这里的文件才是你创造的。</li>
</ul>
<p>所以，一个模组开发者眼里应该只有两条路：</p>
<blockquote>
<ol>
<li><strong>src/main/java</strong>: 编写<strong>逻辑</strong>的地方（方块怎么运作、按键有什么反应）。</li>
<li><strong>src/main/resources</strong>: 存放<strong>数据</strong>的地方（方块长什么样、叫什么名字、材质贴图）。</li>
</ol>
</blockquote>
<p>如果你想添加一个东西：</p>
<blockquote>
<p>先思考怎么注册。</p>
</blockquote>
<p>如果你想添加json（配方、loot、模型）：</p>
<blockquote>
<p>使用Data generation系统。</p>
</blockquote>
<p>如果你想修改原版机制：</p>
<blockquote>
<p>使用mixin。</p>
</blockquote>
<hr>
<h1 id="举个例子01">举个例子01<a href="#%e4%b8%be%e4%b8%aa%e4%be%8b%e5%ad%9001" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<blockquote>
<p>（站在FarmersDelightRefabricated开发者视角）我想做一个厨锅。</p>
</blockquote>
<h2 id="q1厨锅是一个方块但是对于厨锅物品我有必要自己去写检测右键计算坐标放置方块等方块的基本属性吗">Q1：厨锅是一个方块，但是对于厨锅物品，我有必要自己去写“检测右键、计算坐标、放置方块”等方块的基本属性吗？<a href="#q1%e5%8e%a8%e9%94%85%e6%98%af%e4%b8%80%e4%b8%aa%e6%96%b9%e5%9d%97%e4%bd%86%e6%98%af%e5%af%b9%e4%ba%8e%e5%8e%a8%e9%94%85%e7%89%a9%e5%93%81%e6%88%91%e6%9c%89%e5%bf%85%e8%a6%81%e8%87%aa%e5%b7%b1%e5%8e%bb%e5%86%99%e6%a3%80%e6%b5%8b%e5%8f%b3%e9%94%ae%e8%ae%a1%e7%ae%97%e5%9d%90%e6%a0%87%e6%94%be%e7%bd%ae%e6%96%b9%e5%9d%97%e7%ad%89%e6%96%b9%e5%9d%97%e7%9a%84%e5%9f%ba%e6%9c%ac%e5%b1%9e%e6%80%a7%e5%90%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>答案：不需要。因为Minecraft所有的<strong>背包里的</strong>方块都是<code>BLockItem</code>的实例。你只需要继承自<code>BLockItem</code>就可以自动获得它的一切特征。</p>
<p>所以，我（开发者）先在<code>/src/main/java/xxx/farmersdelight/common/item/</code>目录下新建一个<code>CookingPotItem.java</code>，然后写入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> vectorwing.farmersdelight.common.item;
</span></span></code></pre></div><p>再写入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CookingPotItem</span> <span style="color:#66d9ef">extends</span> BlockItem
</span></span></code></pre></div><p>代表<code>CookingPotItem</code>直接继承自<code>BlockItem</code>。</p>
<h2 id="q2物品可以有一个绿色的条bar来表示耐久我的厨锅没有耐久但是我也想用这个bar来表示里面装了多少饭怎么实现呢">Q2：物品可以有一个绿色的条（bar）来表示耐久。我的厨锅没有耐久，但是我也想用这个bar来表示里面装了多少饭，怎么实现呢？<a href="#q2%e7%89%a9%e5%93%81%e5%8f%af%e4%bb%a5%e6%9c%89%e4%b8%80%e4%b8%aa%e7%bb%bf%e8%89%b2%e7%9a%84%e6%9d%a1bar%e6%9d%a5%e8%a1%a8%e7%a4%ba%e8%80%90%e4%b9%85%e6%88%91%e7%9a%84%e5%8e%a8%e9%94%85%e6%b2%a1%e6%9c%89%e8%80%90%e4%b9%85%e4%bd%86%e6%98%af%e6%88%91%e4%b9%9f%e6%83%b3%e7%94%a8%e8%bf%99%e4%b8%aabar%e6%9d%a5%e8%a1%a8%e7%a4%ba%e9%87%8c%e9%9d%a2%e8%a3%85%e4%ba%86%e5%a4%9a%e5%b0%91%e9%a5%ad%e6%80%8e%e4%b9%88%e5%ae%9e%e7%8e%b0%e5%91%a2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>答案：劫持原版的原版的ui机制，让它直接为自己服务。从本质上来说，是原版的代码提供了接口类，使得程序员可以将自己的特殊实现塞进去。</p>
<p>我（开发者）：我希望我的厨锅条有以下逻辑：</p>
<h3 id="1-只在厨锅内部装了东西的时候才显示">1. 只在厨锅内部装了东西的时候才显示<a href="#1-%e5%8f%aa%e5%9c%a8%e5%8e%a8%e9%94%85%e5%86%85%e9%83%a8%e8%a3%85%e4%ba%86%e4%b8%9c%e8%a5%bf%e7%9a%84%e6%97%b6%e5%80%99%e6%89%8d%e6%98%be%e7%a4%ba" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>所以我写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isBarVisible</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> getServingCount(stack) <span style="color:#f92672">&gt;</span> 0;
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><h3 id="2-bar的长度能反映内部装了多少东西">2. Bar的长度能反映内部装了多少东西<a href="#2-bar%e7%9a%84%e9%95%bf%e5%ba%a6%e8%83%bd%e5%8f%8d%e6%98%a0%e5%86%85%e9%83%a8%e8%a3%85%e4%ba%86%e5%a4%9a%e5%b0%91%e4%b8%9c%e8%a5%bf" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>所以我写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getBarWidth</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Math.<span style="color:#a6e22e">min</span>(1 <span style="color:#f92672">+</span> 12 <span style="color:#f92672">*</span> getServingCount(stack) <span style="color:#f92672">/</span> 64, 13);
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><h2 id="3-不管里面装了多少东西bar都只是蓝色的">3. 不管里面装了多少东西，Bar都只是蓝色的<a href="#3-%e4%b8%8d%e7%ae%a1%e9%87%8c%e9%9d%a2%e8%a3%85%e4%ba%86%e5%a4%9a%e5%b0%91%e4%b8%9c%e8%a5%bfbar%e9%83%bd%e5%8f%aa%e6%98%af%e8%93%9d%e8%89%b2%e7%9a%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>所以我写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getBarColor</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> BAR_COLOR;
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><h2 id="q3我想">Q3：我想<a href="#q3%e6%88%91%e6%83%b3" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>先别急，接下来能做的事情已经不是仅凭写这个java代码就能完成的了。我（开发者）意识到我做的东西是一个方块，而一个方块远远不止是一个物品栏中的物品那么简单。</p>
<p>我（开发者）还需要做这些事情：</p>
<ol>
<li>注册。我只是写了<strong>厨锅作为物品存在时的部分属性</strong>，我需要让这个厨锅<strong>存在</strong>。</li>
<li>处理它的<strong>方块属性</strong>。我需要在<code>/src/main/java/xxx/farmersdelight/common/block/</code>下写点什么。</li>
<li>添加tooltip。我需要在<code>/src/main/java/xxx/farmersdelight/client/</code>下写点什么。</li>
<li>&hellip;</li>
</ol>
<p>所以，我（开发者）写了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B                   ┌─ ☕ CookingPotRecipeBuilder.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B                ┌─ 📁 builder
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             ┌─ 📁 data
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │     ┌─ ☕ CookingPotRecipeBookTab.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  ┌─ 📁 recipebook
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  │  ┌─ ☕ CookingPotRecipeBookComponent.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  │  ├─ ☕ CookingPotTooltip.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  ├─ ☕ CookingPotScreen.java
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">16384</span> B             │  ├─ 📁 gui
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">20480</span> B             ├─ 📁 client
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │        ┌─ ☕ CookingPotEmiRecipeHandler.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │     ┌─ 📁 handler
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │     │  ┌─ ☕ CookingPotEmiRecipe.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │     ├─ 📁 recipe
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">12288</span> B             │  ┌─ 📁 emi
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  │     ┌─ ☕ CookingPotDisplay.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  │  ┌─ 📁 display
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  │  ┌─ ☕ CookingPotCategory.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  ├─ 📁 categories
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">12288</span> B             │  ├─ 📁 rei
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  │  ┌─ ☕ CTCookingPotRecipeBookTab.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  │  ┌─ ☕ CookingPotRecipeHandler.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  ├─ 📁 handlers
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  │  ┌─ ☕ CookingPotRecipeManager.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  ├─ 📁 managers
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">20480</span> B             │  ├─ 📁 crafttweaker
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">45056</span> B             ├─ 📁 integration
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │     ┌─ ☕ CookingPotItem.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  ┌─ 📁 item
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  ┌─ ☕ CookingPotRecipe.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  ├─ 📁 crafting
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">0</span> B             │  │     ┌─ ☕ CookingPotSupport.java
</span></span><span style="display:flex;"><span>       -             │  │  ┌─ 📁 state
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">12288</span> B             │  │  ├─ ☕ CookingPotBlock.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  │     ┌─ ☕ CookingPotItemHandler.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  │  ┌─ 📁 inventory
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">0</span> B             │  │  │  │  ┌─ ☕ CookingPotMealSlot.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">4096</span> B             │  │  │  │  ├─ ☕ CookingPotResultSlot.java
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">8192</span> B             │  │  │  │  ├─ ☕ CookingPotMenu.java
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">12288</span> B             │  │  │  ├─ 📁 container
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">24576</span> B             │  │  │  ├─ ☕ CookingPotBlockEntity.java
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">45056</span> B             │  │  ├─ 📁 entity
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">57344</span> B             │  ├─ 📁 block
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">69632</span> B             ├─ 📁 common
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">143360</span> B          ┌─ 📁 farmersdelight
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">143360</span> B       ┌─ 📁 vectorwing
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">143360</span> B    ┌─ 📁 java
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">143360</span> B ┌─ 📁 main
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">143360</span> B 📁 src
</span></span></code></pre></div><p>我们先暂时不尝试完全理解每个文件在干什么，但是一个很明显的特征，所有的这些文件无一例外存放在<code>src/main/java/vectorwing/farmersdelight/</code>中。所以，尽管看起来文件很复杂，你只需要知道一点：每一个java文件的功能就是做好一件事，有的负责处理物品逻辑，有的负责处理方块逻辑，有的负责处理物品槽逻辑，等等。</p>
<p>所谓的文件目录，本质上就是对于java模块按照功能进行分类。这样看来，一个java模组的结构就一目了然了。程序员只需要事先思考好要实现的东西是什么，有哪些功能，如何分类这些功能，一个模组的文件结构就建立起来了。</p>
<p>回到<code>CookingPotItem.java</code>，完整版如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> vectorwing.farmersdelight.common.item;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.core.component.DataComponents;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.nbt.CompoundTag;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.util.Mth;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.world.inventory.tooltip.TooltipComponent;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.world.item.BlockItem;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.world.item.ItemStack;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.world.item.component.CustomData;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> net.minecraft.world.level.block.Block;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> vectorwing.farmersdelight.client.gui.CookingPotTooltip;
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> vectorwing.farmersdelight.common.block.entity.CookingPotBlockEntity;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Optional;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CookingPotItem</span> <span style="color:#66d9ef">extends</span> BlockItem
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> BAR_COLOR <span style="color:#f92672">=</span> Mth.<span style="color:#a6e22e">color</span>(0.<span style="color:#a6e22e">4F</span>, 0.<span style="color:#a6e22e">4F</span>, 1.<span style="color:#a6e22e">0F</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">CookingPotItem</span>(Block block, Properties properties) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">super</span>(block, properties);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isBarVisible</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> getServingCount(stack) <span style="color:#f92672">&gt;</span> 0;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getBarWidth</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Math.<span style="color:#a6e22e">min</span>(1 <span style="color:#f92672">+</span> 12 <span style="color:#f92672">*</span> getServingCount(stack) <span style="color:#f92672">/</span> 64, 13);
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getBarColor</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> BAR_COLOR;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span> Optional<span style="color:#f92672">&lt;</span>TooltipComponent<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getTooltipImage</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  ItemStack mealStack <span style="color:#f92672">=</span> CookingPotBlockEntity.<span style="color:#a6e22e">getMealFromItem</span>(stack);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Optional.<span style="color:#a6e22e">of</span>(<span style="color:#66d9ef">new</span> CookingPotTooltip.<span style="color:#a6e22e">CookingPotTooltipComponent</span>(mealStack));
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getServingCount</span>(ItemStack stack) {
</span></span><span style="display:flex;"><span>  ItemStack mealStack <span style="color:#f92672">=</span> CookingPotBlockEntity.<span style="color:#a6e22e">getMealFromItem</span>(stack);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> mealStack.<span style="color:#a6e22e">getCount</span>();
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="q4为什么不讲import部分">Q4：为什么不讲import部分？<a href="#q4%e4%b8%ba%e4%bb%80%e4%b9%88%e4%b8%8d%e8%ae%b2import%e9%83%a8%e5%88%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>import是ide的事情，程序员很难也没必要自己去写import。</p>
<h2 id="q5后面两个没讲的方法是做什么的">Q5：后面两个没讲的方法是做什么的？<a href="#q5%e5%90%8e%e9%9d%a2%e4%b8%a4%e4%b8%aa%e6%b2%a1%e8%ae%b2%e7%9a%84%e6%96%b9%e6%b3%95%e6%98%af%e5%81%9a%e4%bb%80%e4%b9%88%e7%9a%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>分别是用来处理tooltip信息和内部物品信息。因为会牵扯到其他java模块，所以暂时不讨论。</p>
]]></content>
		</item>
		
		<item>
			<title>D2L自学日志01：preliminaries</title>
			<link>http://localhost:1313/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701preliminaries/</link>
			<pubDate>Tue, 30 Dec 2025 18:14:36 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/d2l%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%9701preliminaries/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h1 id="机器学习基础知识">机器学习基础知识<a href="#%e6%9c%ba%e5%99%a8%e5%ad%a6%e4%b9%a0%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<ul>
<li>多维数组</li>
<li>pandas（数据处理）</li>
<li>linear-algebra（线性代数）</li>
<li>calculus（微积分）</li>
<li>autograd（自动微分）</li>
<li>probability（概率）</li>
</ul>
<hr>
<h2 id="多维数组基本知识">多维数组基本知识<a href="#%e5%a4%9a%e7%bb%b4%e6%95%b0%e7%bb%84%e5%9f%ba%e6%9c%ac%e7%9f%a5%e8%af%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">12</span>) <span style="color:#75715e"># tensor([0,1,2,3,4,5,6,7,8,9,10,11])</span>
</span></span></code></pre></div><p><code>torch.arange(x,y,z)</code>的语法和python原生的<code>range()</code>语法一致，左闭右开，第三个参数为步长。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>x<span style="color:#f92672">.</span>shape
</span></span></code></pre></div><p>一个张量的形状，返回值为一个一个<code>torch.Size</code>对象。你可以把它看成一个列表，直接通过方括号访问维度索引值可以得到该张量的某个维度的大小。</p>
<p>如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">24</span>)<span style="color:#f92672">.</span>reshape([<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>])
</span></span><span style="display:flex;"><span>print(x<span style="color:#f92672">.</span>shape) <span style="color:#75715e"># torch.Size([2,3,4])</span>
</span></span><span style="display:flex;"><span>print(x<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>]) <span style="color:#75715e"># 3</span>
</span></span></code></pre></div><p><code>torch.reshape([x,y,z,...])</code>可以修改一个张量的形状，本质上就是先把这个张量拉成一维，再依次按照对应维度的大小对一维张量进行均分。</p>
<p>比如：一个<code>x = torch.arange(24)</code>，我们对它进行<code>.reshape([2,3,4])</code>操作，你可以看做：一个<code>arange(24)</code>先进行shape[0]处数字均分，变成前十二个和后十二个，然后对两个12长度的子张量再按照shape[1]处数字进行均分，分别变为三个长度4的子张量，最后对每个长度4的子张量再次均分，得到长度为1的子张量。每一次均分都代表进入下一个维度。</p>
<p><code>x.numel()</code>返回x张量的总元素个数。</p>
<p><code>torch.zeros((2,3,4))</code>生成一个形状为<code>torch.Size([2,3,4])</code>的所有元素为0的张量。</p>
<p><code>torch.ones((2,3,4))</code>生成一个形状为<code>torch.Size([2,3,4])</code>的所有元素为1的张量。</p>
<hr>
<h3 id="运算符">运算符<a href="#%e8%bf%90%e7%ae%97%e7%ac%a6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>常见的标准运算符（+，-，*，\，**）都会被升级为按元素计算。</p>
<p><code>torch.exp(x)</code>得到一个形状和x一致，但是对应位置元素为exp(x)的张量。</p>
<p><code>torch.cat((X, Y), dim = 1)</code>将两个张量沿1维度对接起来，前提是两者其他维度形状一致。</p>
<p>如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>X <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">12</span>, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float32)<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>))
</span></span><span style="display:flex;"><span>Y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([[<span style="color:#ae81ff">2.0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">3</span>], [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>], [<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>]])
</span></span><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>cat((X, Y), dim<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>), torch<span style="color:#f92672">.</span>cat((X, Y), dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span></code></pre></div><p>结果：</p>
<pre tabindex="0"><code>(tensor([[ 0.,  1.,  2.,  3.],
         [ 4.,  5.,  6.,  7.],
         [ 8.,  9., 10., 11.],
         [ 2.,  1.,  4.,  3.],
         [ 1.,  2.,  3.,  4.],
         [ 4.,  3.,  2.,  1.]]),
 tensor([[ 0.,  1.,  2.,  3.,  2.,  1.,  4.,  3.],
         [ 4.,  5.,  6.,  7.,  1.,  2.,  3.,  4.],
         [ 8.,  9., 10., 11.,  4.,  3.,  2.,  1.]]))
</code></pre><p><code>X == Y</code>得到一个张量，元素为布尔值，若X和Y对应位置相等，则对应位置的结果为True，否则为False。</p>
<p><code>X.sum()</code>得到一个单元素张量，数值为X所有元素的总和，如果想直接得到这个值，应该写<code>X.sum().item()</code>。</p>
<hr>
<h3 id="广播机制">广播机制<a href="#%e5%b9%bf%e6%92%ad%e6%9c%ba%e5%88%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>当尝试对两个形状并不匹配的张量相互计算时，若不匹配的维度中某个张量的长度为1，torch就会自动在这个维度上通过复制的方式使两个张量强行匹配数据。</p>
<p>如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>a <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">3</span>)<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>b <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>reshape((<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>a, b
</span></span></code></pre></div><p>结果为：</p>
<pre tabindex="0"><code>(tensor([[0],
         [1],
         [2]]),
 tensor([[0, 1]]))
</code></pre><p>但是：</p>
<pre tabindex="0"><code>a + b
</code></pre><p>结果为：</p>
<pre tabindex="0"><code>tensor([[0, 1],
        [1, 2],
        [2, 3]])
</code></pre><hr>
<h3 id="切片">切片<a href="#%e5%88%87%e7%89%87" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>X[2, 3:5]</code>表示的就是X张量中0维度坐标2、1维度坐标3，4的元素。如果我们想要给多个元素赋同样的值，我们只需要索引所有元素，然后赋值。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">12</span>)<span style="color:#f92672">.</span>reshape([<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>])
</span></span><span style="display:flex;"><span>x[<span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">2</span>, :] <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>
</span></span></code></pre></div><p>得到的x：</p>
<pre tabindex="0"><code>tensor([[12., 12., 12., 12.],
        [12., 12., 12., 12.],
        [ 8.,  9., 10., 11.]])
</code></pre><hr>
<h3 id="转换为其他对象">转换为其他对象<a href="#%e8%bd%ac%e6%8d%a2%e4%b8%ba%e5%85%b6%e4%bb%96%e5%af%b9%e8%b1%a1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>转换为numpy多维数组：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>x <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>numpy()
</span></span></code></pre></div><p>转换为torch.Tensor：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>Tensor(x)
</span></span></code></pre></div><hr>
<h2 id="pandas">pandas<a href="#pandas" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>数据预处理。</p>
<p>写入数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>makedirs(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;..&#39;</span>, <span style="color:#e6db74">&#39;data&#39;</span>), exist_ok<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>data_file <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;..&#39;</span>, <span style="color:#e6db74">&#39;data&#39;</span>, <span style="color:#e6db74">&#39;house_tiny.csv&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(data_file, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;NumRooms,Alley,Price</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)  <span style="color:#75715e"># 列名</span>
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;NA,Pave,127500</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)  <span style="color:#75715e"># 每行表示一个数据样本</span>
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;2,NA,106000</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;4,NA,178100</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;NA,NA,140000</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p>读取数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(data_file)
</span></span><span style="display:flex;"><span>print(data)
</span></span></code></pre></div><hr>
<h3 id="处理缺失值">处理缺失值<a href="#%e5%a4%84%e7%90%86%e7%bc%ba%e5%a4%b1%e5%80%bc" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>将nan值填补为平均值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>inputs, outputs <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>iloc[:, <span style="color:#ae81ff">0</span>:<span style="color:#ae81ff">2</span>], data<span style="color:#f92672">.</span>iloc[:, <span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>inputs <span style="color:#f92672">=</span> inputs<span style="color:#f92672">.</span>fillna(inputs<span style="color:#f92672">.</span>mean())
</span></span><span style="display:flex;"><span>print(inputs)
</span></span></code></pre></div><hr>
<h3 id="pandas部分练习">pandas部分练习<a href="#pandas%e9%83%a8%e5%88%86%e7%bb%83%e4%b9%a0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> random
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_row</span>():
</span></span><span style="display:flex;"><span>    row_data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">5</span>):
</span></span><span style="display:flex;"><span>        added_data <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>random()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> added_data <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0.2</span>:
</span></span><span style="display:flex;"><span>            added_data <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;NA&#34;</span>
</span></span><span style="display:flex;"><span>        row_data <span style="color:#f92672">+=</span> str(added_data)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">!=</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>            row_data <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;,&#39;</span>
</span></span><span style="display:flex;"><span>    row_data <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> row_data
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>os<span style="color:#f92672">.</span>makedirs(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;..&#39;</span>, <span style="color:#e6db74">&#39;Moonhalf_data&#39;</span>), exist_ok <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>mh_file <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;..&#39;</span>, <span style="color:#e6db74">&#39;Moonhalf_data&#39;</span>, <span style="color:#e6db74">&#39;mh_data.csv&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(mh_file, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> f:
</span></span><span style="display:flex;"><span>    f<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;NumA,NumB,NumC,NumD,NumE</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)  <span style="color:#75715e"># 列名</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">50</span>):
</span></span><span style="display:flex;"><span>        f<span style="color:#f92672">.</span>write(generate_row())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(mh_file)
</span></span><span style="display:flex;"><span>print(data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>max_na <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>isna()<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>max()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(target_column)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>refined_data <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>loc[:, data<span style="color:#f92672">.</span>isna()<span style="color:#f92672">.</span>sum() <span style="color:#f92672">&lt;</span> max_na]
</span></span><span style="display:flex;"><span>print(refined_data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>refined_data <span style="color:#f92672">=</span> refined_data<span style="color:#f92672">.</span>fillna(refined_data<span style="color:#f92672">.</span>mean())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>refined_tensor <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(refined_data<span style="color:#f92672">.</span>to_numpy(dtype <span style="color:#f92672">=</span> float))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(refined_tensor)
</span></span></code></pre></div><p>这段代码的作用是：生成一个50 * 5的随机数数据集，删除缺失值最多的列，并将预处理后的数据集转换为张量格式。</p>
<hr>
<h2 id="线性代数">线性代数<a href="#%e7%ba%bf%e6%80%a7%e4%bb%a3%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p><code>X.T</code>转置。</p>
<p><code>X.clone()</code>一个和X一模一样的张量，但是重新分配内存。</p>
<p><code>A.sum(axis = 1)</code>让A沿着1维坐标轴求和，得到n-1维张量。（想象这个张量沿着1维压扁，重叠的地方就求和）</p>
<p>比如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>test_sum <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">24</span>)<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>print(test_sum)
</span></span><span style="display:flex;"><span>print(test_sum<span style="color:#f92672">.</span>sum(axis <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>print(test_sum<span style="color:#f92672">.</span>sum(axis <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>print(test_sum<span style="color:#f92672">.</span>sum(axis <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>))
</span></span><span style="display:flex;"><span>print(test_sum<span style="color:#f92672">.</span>sum(axis <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>]))
</span></span></code></pre></div><p>结果：</p>
<pre tabindex="0"><code>tensor([[[ 0,  1,  2,  3],
         [ 4,  5,  6,  7],
         [ 8,  9, 10, 11]],

        [[12, 13, 14, 15],
         [16, 17, 18, 19],
         [20, 21, 22, 23]]])
tensor([[12, 14, 16, 18],
        [20, 22, 24, 26],
        [28, 30, 32, 34]])
tensor([[12, 15, 18, 21],
        [48, 51, 54, 57]])
tensor([[ 6, 22, 38],
        [54, 70, 86]])
tensor([60, 66, 72, 78])
</code></pre><p><code>A.mean(axis = 1)</code>沿着1维求平均值，规则类似sum。</p>
<p>不降维求和：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sum_A <span style="color:#f92672">=</span> A<span style="color:#f92672">.</span>sum(axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, keepdims<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>sum_A
</span></span></code></pre></div><hr>
<h3 id="点积">点积<a href="#%e7%82%b9%e7%a7%af" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>torch.dot(X, Y)</code>将X和Y对应位置元素相乘求和，得到一个单元素张量。</p>
<p>注意：虽然听起来很废话，但是dot只能适用于1D张量。</p>
<hr>
<h3 id="向量积">向量积<a href="#%e5%90%91%e9%87%8f%e7%a7%af" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>torch.mv(X, Y)</code>对两个向量求叉乘。</p>
<hr>
<h3 id="矩阵乘法">矩阵乘法<a href="#%e7%9f%a9%e9%98%b5%e4%b9%98%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>torch.mm(X, Y)</code>对两个矩阵做矩阵乘法，注意这不是对应位置元素相乘（Hadamard积）。</p>
<hr>
<h3 id="范数">范数<a href="#%e8%8c%83%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>用来衡量一个张量的大小。</p>
<hr>
<h3 id="l2范数">L2范数<a href="#l2%e8%8c%83%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>torch.norm()</code>得到一个向量的长度。对于一个多维张量来说，它的含义是求所有元素平方和再开根号。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>u <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">3.0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">4.0</span>])
</span></span><span style="display:flex;"><span>v <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">3.0</span>,<span style="color:#ae81ff">4.0</span>,<span style="color:#ae81ff">5.0</span>])
</span></span><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>norm(u), torch<span style="color:#f92672">.</span>norm(v)
</span></span></code></pre></div><p>结果：</p>
<pre tabindex="0"><code>(tensor(5.), tensor(7.0711))
</code></pre><hr>
<h3 id="l1范数">L1范数<a href="#l1%e8%8c%83%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>torch.abs(x).sum()</code>得到所有分量绝对值之和。</p>
<hr>
<h2 id="自动求导autograd">自动求导（autograd）<a href="#%e8%87%aa%e5%8a%a8%e6%b1%82%e5%af%bcautograd" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">2.0</span>], requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> x <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>y<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>print(x<span style="color:#f92672">.</span>grad) <span style="color:#75715e"># 此时是 4.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>z <span style="color:#f92672">=</span> x <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>z<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>print(x<span style="color:#f92672">.</span>grad) <span style="color:#75715e"># 此时是 4.0 + 3.0 = 7.0 ！</span>
</span></span></code></pre></div><hr>
<h3 id="为什么xgrad似乎并不符合通常的程序设计原则">为什么x.grad似乎并不符合通常的程序设计原则？<a href="#%e4%b8%ba%e4%bb%80%e4%b9%88xgrad%e4%bc%bc%e4%b9%8e%e5%b9%b6%e4%b8%8d%e7%ac%a6%e5%90%88%e9%80%9a%e5%b8%b8%e7%9a%84%e7%a8%8b%e5%ba%8f%e8%ae%be%e8%ae%a1%e5%8e%9f%e5%88%99" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>x.grad</code>在通常的oop程序设计中应该表示一个对象自身的属性，但是在torch中<code>x.grad</code>会随着使用x的表达式backward()而发生改变，对于一般的程序设计而言，这种设计是比较反直觉的。</p>
<p>对于不同的表达式，torch对于梯度的操作并非覆盖而是累加。从上面的例子中我们可以看到x.grad最后的值为7.0。至于为什么要设计成累加的模式，一方面是数学上的便利，根据微积分的链式法则，如果一个变量x同时影响了多个分支，那么总梯度就是各个分支梯度的和；另一方面这样做更能节省内存，即使你的网络极其复杂，分成好几路输出，PyTorch也不需要为每一路都开辟新的空间存梯度，只需要在x.grad这一相同地址上做加法即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">24</span>)<span style="color:#f92672">.</span>reshape([<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">6</span>])<span style="color:#f92672">.</span>to(torch<span style="color:#f92672">.</span>float32)
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>requires_grad_(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> (x <span style="color:#f92672">*</span> x)<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span>y<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>grad
</span></span></code></pre></div><p>需要注意的是，尽管多维数组对多维数组的求导在数学上是有意义的，pytorch中仅支持从标量开始的反向传播。比如，在如上的例子中，y是一个单元素张量，此时可以对它进行backward()操作，但是如果<code>y = 2 * x</code>，那么再尝试<code>y.backward()</code>就会报错。</p>
<p>原因同样是出于对机器学习实际计算工作的妥协，在工程上直接对多维数组之间进行求导意味着我们会需要计算两个数组元素个数之积次计算，而机器学习中我们处理的数组大小有时可以达到百万数量级。直接求导会导致极大的显存消耗。</p>
<hr>
<p>我们尝试通过一个例子来解释pytorch的优化逻辑：</p>
<p>假设：</p>
<ul>
<li>x = [x1, x2, &hellip;]是一个10000维向量。</li>
<li>y = [y1, y2, &hellip;]也是一个10000维向量，但是它是由x计算出来的。</li>
<li>L = f(y)是一个<strong>标量</strong>。在机器学习的语境下它通常是一个误差函数。</li>
</ul>
<p>你的目标是求$\frac{\partial L}{\partial x}$。</p>
<p>对于通常的数学书求法，我们会需要使用链式法则，计算$\frac{\partial L}{\partial y}$，再计算$\frac{\partial y}{\partial x}$，再将两者相乘。其中后者就是向量对向量求导，即<strong>雅可比矩阵</strong>。当x、y体积巨大时，直接计算这个雅可比矩阵的计算量会直接爆炸。</p>
<p>更重要的是，虽然x和y体积巨大，但是真正进行相互计算的时候，对于它们的每个分量来说，另一个向量中和它相关的分量个数是相当有限的。尤其在机器学习的情景下，假如你计算出了雅可比矩阵，你会发现它相当的稀疏，其中绝大多数的数字都是0。因为大多数的分量之间都没有什么关系。</p>
<p>但是对于一个矩阵计算来说，它必须要存储所有分量和所有分量之间的关系，这意味着即使是两者没有任何关系，矩阵也必须要占用空间来表示这种没有关系的关系。</p>
<p>pytorch的优化思路其实很简单：我们大可以只站在分量的视角看待问题，只去记录那些和自己有关的分量以及过程中的计算方式，而对于那些和自己无关的分量，我们根本不去记录，也自然不会产生关联。</p>
<p>我们来用一个相对简单的例子解释torch的工作原理：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>Tensor([<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>requires_grad_(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y1_mask <span style="color:#f92672">=</span> x <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y1 <span style="color:#f92672">=</span> x[y1_mask]<span style="color:#f92672">.</span>squeeze(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y2 <span style="color:#f92672">=</span> (x <span style="color:#f92672">*</span> x)<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># print(y1, y2)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>L <span style="color:#f92672">=</span> y1 <span style="color:#f92672">+</span> y2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;L: </span><span style="color:#e6db74">{</span>L<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>L<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(x<span style="color:#f92672">.</span>grad)
</span></span></code></pre></div><p>运行得到的结果是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>L: 33.0
</span></span><span style="display:flex;"><span>tensor<span style="color:#f92672">([</span>4., 6., 9.<span style="color:#f92672">])</span>
</span></span></code></pre></div><p>在这个例子中，y1是x中大于3的元素构成的单元素张量，y2是x对自己的点积组成的单元素张量，L则是y1和y2求和得到的单元素张量。</p>
<p>首先，我们计算y1时，torch同时记录下了“y1是由x通过y1_mask筛选出来的”；计算y2时，torch也同时记录下了“y2是由x对自己按元素求乘积再求和得到的”。最后，计算L时，torch会记录下“L是由y1加上y2得到的”。</p>
<p>当我们对L进行backward时，torch会去查询L的计算方式。此时，我们假设我们需要L增加1，torch会把这个1传递给计算得到L的y1和y2，因为L对y1和y2求偏导得到的是1，所以y1和y2被传递得到1，意味着y1和y2对于L的贡献都是1。</p>
<p>接着，torch会去查询y1和y2的计算方式，y1是由x的第三个元素组成的，所以x的第三个元素对y1的贡献是1，进而对L的贡献也是1；y2由x自乘求和得到，所以x每个元素对y2的贡献是2 * x，在x = [2, 3, 4]时，x中元素对y2的贡献依次为4、6、8，进而对L的贡献也是4，6，8。</p>
<p>最后，我们对x中每个元素对L的各种贡献进行求和，我们得到x中每个元素在当前数值下对于L的贡献依次为4，6，9，即为我们最后得到的<code>tensor([4.,6.,9.,])</code></p>
<p>需要明确的是，贡献这个词的使用实际上可能数学并不准确。我们最后得到的东西实际上是L这个标量对x的梯度，即∇L，其意义可以简单理解为L在随x各个维度改变而改变的速率。</p>
<hr>
<h3 id="非标量变量的反向传播">非标量变量的反向传播<a href="#%e9%9d%9e%e6%a0%87%e9%87%8f%e5%8f%98%e9%87%8f%e7%9a%84%e5%8f%8d%e5%90%91%e4%bc%a0%e6%92%ad" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>从我们上面的推导中可以发现，我们对一个标量结果进行反向传播，最后得到的向量是x中对应元素对结果的贡献值。而理论上假如我们能直接对一个向量进行反向传播，最后得到的应该是一个雅可比矩阵。</p>
<p>然而，我们需要的事实上根本不是这个矩阵，我们需要的是损失向量通过这个矩阵变换得到的结果，进而更新参数。对于我们的实际应用中，这个矩阵本身没有任何应用价值。</p>
<p>用更加精辟的语言来说：</p>
<blockquote>
<p>Pytorch的反向传播根本不需要返回一个矩阵，因为它本身就在模拟雅可比矩阵的线性算子功能。</p>
</blockquote>
<p>然而，在某些情景下我们确实会需要计算非标量变量的反向传播，比如多个batch同时进行训练，但是即使在这种情景，我们最后需要得到的依然是一个向量。实现方式是让批量中每个样本对x求梯度，最后再求和或者求平均，或者加权平均。总而言之，反向传播归根结底是获取一个用来更新参数的向量，获取二维及以上的张量没有什么实际意义。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 对非标量调用backward需要传入一个gradient参数，该参数指定微分函数关于self的梯度。</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 本例只想求偏导数的和，所以传递一个1的梯度是合适的</span>
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>grad<span style="color:#f92672">.</span>zero_()
</span></span><span style="display:flex;"><span>print(x<span style="color:#f92672">.</span>grad, x)
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> x <span style="color:#f92672">*</span> x
</span></span><span style="display:flex;"><span>print(y)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 等价于y.backward(torch.ones(len(x)))</span>
</span></span><span style="display:flex;"><span>y<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>grad
</span></span></code></pre></div><p>所谓的gradient参数，实际上是一个和x一样长度的向量，含义是<strong>y的每个分量</strong>对于最终结果的贡献。在这里，如果我们写<code>y.sum()</code>，本质上就是将y的每个元素进行求和，所以y的每个元素对最终结果的贡献为1；如果写<code>torch.ones(len(x))</code>意思就是y的每个参数对于最终结果的贡献都是1，所以两者其实是等价的。</p>
<hr>
<h3 id="分离计算">分离计算<a href="#%e5%88%86%e7%a6%bb%e8%ae%a1%e7%ae%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>有时候我们只想要把一个<code>torch.Tensor</code>当做一个常数来计算，但是得到这个<code>torch.Tensor</code>的过程中经过了一些计算，使得最后反向传播的时候可能影响最后的结果。此时，我们会希望得到这个tensor，但是抹除它所有的计算历史。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">4</span>)
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>grad<span style="color:#f92672">.</span>zero_()
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> x <span style="color:#f92672">*</span> x
</span></span><span style="display:flex;"><span>u <span style="color:#f92672">=</span> y<span style="color:#f92672">.</span>detach()
</span></span><span style="display:flex;"><span>print(u)
</span></span><span style="display:flex;"><span>z <span style="color:#f92672">=</span> u <span style="color:#f92672">*</span> x
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>z<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>grad <span style="color:#f92672">==</span> u
</span></span></code></pre></div><p>在这个例子中，u被赋值为<code>y.detach()</code>，含义是使u的张量内容和y一样，但是失去了所有计算记录。这样，后续的反向传递过程中u处就不会向后传递。</p>
<p>结果是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tensor<span style="color:#f92672">([</span>True, True, True, True<span style="color:#f92672">])</span>
</span></span></code></pre></div><hr>
<h3 id="如何实现二阶导">如何实现二阶导?<a href="#%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0%e4%ba%8c%e9%98%b6%e5%af%bc" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor([<span style="color:#ae81ff">2.0</span>], requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 定义函数</span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> x <span style="color:#f92672">**</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 计算一阶导数</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用 grad 函数，并开启 create_graph=True</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这会把“计算一阶导数”的过程也记录在计算图里</span>
</span></span><span style="display:flex;"><span>grads <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>autograd<span style="color:#f92672">.</span>grad(y, x, create_graph<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;一阶导数在 x=2 时: </span><span style="color:#e6db74">{</span>grads<span style="color:#f92672">.</span>item()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>) <span style="color:#75715e"># 3 * 2^2 = 12.0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 对一阶导数再次求导</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这次不需要再创建图了（除非你要算三阶导）</span>
</span></span><span style="display:flex;"><span>grads2 <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>autograd<span style="color:#f92672">.</span>grad(grads, x)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;二阶导数在 x=2 时: </span><span style="color:#e6db74">{</span>grads2<span style="color:#f92672">.</span>item()<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>) <span style="color:#75715e"># 6 * 2 = 12.0</span>
</span></span></code></pre></div><p>我们没办法通过backward实现二阶导（比如L.backward().backward()），因为反向传播的计算本身并不会被存储在计算图中，但是为了实现二阶导，我们需要一阶导的计算图。因此在上面的例子中我们使用<code>torch.autograd.grad()</code>函数，并添加<code>create_graph=True</code>参数来生成包含一阶导计算图的梯度向量。</p>
<hr>
<h3 id="控制流">控制流<a href="#%e6%8e%a7%e5%88%b6%e6%b5%81" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>a <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>randn(size<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>,), requires_grad<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>print(a)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> a<span style="color:#f92672">.</span>norm() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3</span>:
</span></span><span style="display:flex;"><span>    b <span style="color:#f92672">=</span> a<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    b <span style="color:#f92672">=</span> (a <span style="color:#f92672">*</span> a)<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>b<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(a<span style="color:#f92672">.</span>grad)
</span></span></code></pre></div><p>torch支持控制流梯度计算，这意味着即使不同情况下计算b的方式可能不同，对b进行反向传播仍然可以得到当前计算方式下的对应梯度。</p>
<hr>
<h3 id="绘制函数与导函数图像不直接计算导数">绘制函数与导函数图像（不直接计算导数）<a href="#%e7%bb%98%e5%88%b6%e5%87%bd%e6%95%b0%e4%b8%8e%e5%af%bc%e5%87%bd%e6%95%b0%e5%9b%be%e5%83%8f%e4%b8%8d%e7%9b%b4%e6%8e%a5%e8%ae%a1%e7%ae%97%e5%af%bc%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> matplotlib_inline <span style="color:#f92672">import</span> backend_inline
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> d2l <span style="color:#f92672">import</span> torch <span style="color:#66d9ef">as</span> d2l
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> math
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">use_svg_display</span>():  <span style="color:#75715e">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;使用svg格式在Jupyter中显示绘图&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    backend_inline<span style="color:#f92672">.</span>set_matplotlib_formats(<span style="color:#e6db74">&#39;svg&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_figsize</span>(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">3.5</span>, <span style="color:#ae81ff">2.5</span>)):  <span style="color:#75715e">#@save</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;设置matplotlib的图表大小&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    use_svg_display()
</span></span><span style="display:flex;"><span>    d2l<span style="color:#f92672">.</span>plt<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;figure.figsize&#39;</span>] <span style="color:#f92672">=</span> figsize
</span></span><span style="display:flex;"><span><span style="color:#75715e">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">set_axes</span>(axes, xlabel, ylabel, xlim, ylim, xscale, yscale, legend):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;设置matplotlib的轴&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>set_xlabel(xlabel)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>set_ylabel(ylabel)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>set_xscale(xscale)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>set_yscale(yscale)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>set_xlim(xlim)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>set_ylim(ylim)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> legend:
</span></span><span style="display:flex;"><span>        axes<span style="color:#f92672">.</span>legend(legend)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>grid()
</span></span><span style="display:flex;"><span><span style="color:#75715e">#@save</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">plot</span>(X, Y<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, xlabel<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, ylabel<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, legend<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, xlim<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,
</span></span><span style="display:flex;"><span>         ylim<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, xscale<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;linear&#39;</span>, yscale<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;linear&#39;</span>,
</span></span><span style="display:flex;"><span>         fmts<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;-&#39;</span>, <span style="color:#e6db74">&#39;m--&#39;</span>, <span style="color:#e6db74">&#39;g-.&#39;</span>, <span style="color:#e6db74">&#39;r:&#39;</span>), figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">3.5</span>, <span style="color:#ae81ff">2.5</span>), axes<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;绘制数据点&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> legend <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        legend <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    set_figsize(figsize)
</span></span><span style="display:flex;"><span>    axes <span style="color:#f92672">=</span> axes <span style="color:#66d9ef">if</span> axes <span style="color:#66d9ef">else</span> d2l<span style="color:#f92672">.</span>plt<span style="color:#f92672">.</span>gca()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 如果X有一个轴，输出True</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">has_one_axis</span>(X):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> (hasattr(X, <span style="color:#e6db74">&#34;ndim&#34;</span>) <span style="color:#f92672">and</span> X<span style="color:#f92672">.</span>ndim <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">or</span> isinstance(X, list)
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">and</span> <span style="color:#f92672">not</span> hasattr(X[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#34;__len__&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> has_one_axis(X):
</span></span><span style="display:flex;"><span>        X <span style="color:#f92672">=</span> [X]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> Y <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        X, Y <span style="color:#f92672">=</span> [[]] <span style="color:#f92672">*</span> len(X), X
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> has_one_axis(Y):
</span></span><span style="display:flex;"><span>        Y <span style="color:#f92672">=</span> [Y]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(X) <span style="color:#f92672">!=</span> len(Y):
</span></span><span style="display:flex;"><span>        X <span style="color:#f92672">=</span> X <span style="color:#f92672">*</span> len(Y)
</span></span><span style="display:flex;"><span>    axes<span style="color:#f92672">.</span>cla()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> x, y, fmt <span style="color:#f92672">in</span> zip(X, Y, fmts):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(x):
</span></span><span style="display:flex;"><span>            axes<span style="color:#f92672">.</span>plot(x, y, fmt)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            axes<span style="color:#f92672">.</span>plot(y, fmt)
</span></span><span style="display:flex;"><span>    set_axes(axes, xlabel, ylabel, xlim, ylim, xscale, yscale, legend)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> d2l<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> math<span style="color:#f92672">.</span>pi, <span style="color:#ae81ff">0.05</span><span style="color:#f92672">*</span>math<span style="color:#f92672">.</span>pi)
</span></span><span style="display:flex;"><span>x<span style="color:#f92672">.</span>requires_grad_(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">f</span>(x):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> d2l<span style="color:#f92672">.</span>sin(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> f(x)<span style="color:#f92672">.</span>sum()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>y<span style="color:#f92672">.</span>backward()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plot(x<span style="color:#f92672">.</span>detach(), [f(x)<span style="color:#f92672">.</span>detach(), x<span style="color:#f92672">.</span>grad],<span style="color:#e6db74">&#34;x&#34;</span>, <span style="color:#e6db74">&#34;f(x)&#34;</span>)
</span></span></code></pre></div><p>需要使用d2l库和jupyter lab。</p>
<hr>
<h2 id="概率">概率<a href="#%e6%a6%82%e7%8e%87" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="多项分布multinomial-distribution">多项分布(multinomial distribution)<a href="#%e5%a4%9a%e9%a1%b9%e5%88%86%e5%b8%83multinomial-distribution" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>将概率分配给一些离散选项的分布称为多项分布。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> torch.distributions <span style="color:#f92672">import</span> multinomial
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fair_probs <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>ones([<span style="color:#ae81ff">6</span>]) <span style="color:#f92672">/</span> <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(multinomial<span style="color:#f92672">.</span>Multinomial(<span style="color:#ae81ff">1</span>, fair_probs)<span style="color:#f92672">.</span>sample())
</span></span><span style="display:flex;"><span>print(multinomial<span style="color:#f92672">.</span>Multinomial(<span style="color:#ae81ff">2</span>, fair_probs)<span style="color:#f92672">.</span>sample())
</span></span><span style="display:flex;"><span>print(multinomial<span style="color:#f92672">.</span>Multinomial(<span style="color:#ae81ff">10</span>, fair_probs)<span style="color:#f92672">.</span>sample())
</span></span></code></pre></div><p><code>multinomial.Multinomial()</code>用来生成一个采样器，这个采样器每次采样会根据<code>fair_probs</code>也就是概率向量对应的概率来抽取一个位置索引，第一个参数时一次采样的抽取次数。最后得到的向量中对应位置的数字即这个位置被抽中的次数。</p>
<p>上述代码的某次生成结果为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>tensor([<span style="color:#ae81ff">1.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>])
</span></span><span style="display:flex;"><span>tensor([<span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">2.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">0.</span>])
</span></span><span style="display:flex;"><span>tensor([<span style="color:#ae81ff">1.</span>, <span style="color:#ae81ff">1.</span>, <span style="color:#ae81ff">0.</span>, <span style="color:#ae81ff">2.</span>, <span style="color:#ae81ff">1.</span>, <span style="color:#ae81ff">5.</span>])
</span></span></code></pre></div><hr>
<h3 id="联合概率">联合概率<a href="#%e8%81%94%e5%90%88%e6%a6%82%e7%8e%87" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>\(P(A=a,B=b)\)，A和B同时发生的概率。</p>
<h3 id="条件概率">条件概率<a href="#%e6%9d%a1%e4%bb%b6%e6%a6%82%e7%8e%87" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>\(0 \leq \frac{P(A=a, B=b)}{P(A=a)} \leq 1\) ，A发生的前提下A、B同时发生的概率。</p>
<h3 id="贝叶斯定理">贝叶斯定理<a href="#%e8%b4%9d%e5%8f%b6%e6%96%af%e5%ae%9a%e7%90%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
$$P(A \mid B) = \frac{P(B \mid A) P(A)}{P(B)}.$$<h3 id="边际化">边际化<a href="#%e8%be%b9%e9%99%85%e5%8c%96" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
$$P(B) = \sum_{A} P(A, B),$$]]></content>
		</item>
		
		<item>
			<title>工具不图鉴03：虚拟环境&amp;conda</title>
			<link>http://localhost:1313/zh-cn/posts/venvminiconda/</link>
			<pubDate>Tue, 16 Dec 2025 23:23:35 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/venvminiconda/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h2 id="什么是虚拟环境">什么是虚拟环境?<a href="#%e4%bb%80%e4%b9%88%e6%98%af%e8%99%9a%e6%8b%9f%e7%8e%af%e5%a2%83" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>多数语境下，虚拟环境是一个独属于python的术语。python因其对第三方库的高度依赖性以及python自身版本本来就比较混乱，导致经常出现python与各路依赖和第三方库乱成一锅粥的情况。</p>
<p>想要解决这种困境倒也并不困难。我们不妨设想这样的场景：假如你养了一只猫和一条狗，但是猫狗放在一起就会开始打架，你又想同时养这两个动物，该怎么办呢？很简单，你只需要将猫和狗隔开来养即可，比如给它们各自安排一个房间。</p>
<p>这样的一个房间，在python语境下就是一个<strong>虚拟环境</strong>。通常来说，你最好让给每个项目都单独创建一个虚拟环境，这样它们之间就可以互不干扰，可以相互重复，也可以独立删除。就像一个动物园，假如把所有动物关在一起就会开始饥饿游戏，但是把每种动物分开关在各自的园区，彼此之间就可以相安无事。</p>
<hr>
<h3 id="虚拟环境是怎么实现的">虚拟环境是怎么实现的？<a href="#%e8%99%9a%e6%8b%9f%e7%8e%af%e5%a2%83%e6%98%af%e6%80%8e%e4%b9%88%e5%ae%9e%e7%8e%b0%e7%9a%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在计算机世界，程序员为了环境隔离实际上有过相当多的尝试，比如虚拟机可以模拟一个操作系统，docker容器可以把进程装在一个看起来像独立系统的盒子里。</p>
<p>但是一个python虚拟环境所做的事情远比上述尝试轻量的多。一个python虚拟环境只做三件事：</p>
<ol>
<li>使用独立的python可执行文件。隔离不同python版本。</li>
<li>使用独立的第三方目录库，隔离第三方库。</li>
<li>控制导入顺序。</li>
</ol>
<hr>
<h3 id="如何创建一个虚拟环境">如何创建一个虚拟环境？<a href="#%e5%a6%82%e4%bd%95%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aa%e8%99%9a%e6%8b%9f%e7%8e%af%e5%a2%83" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>一个虚拟环境在机器中的表现形式其实就是一个文件夹，里面包含了这个环境的各种信息。通常来说，人们会把这个文件夹建立在项目文件中。</p>
<p>但是，需要注意的是，在一个虚拟环境被激活之后，你无论处在哪个目录下，只要不关闭这个虚拟环境，你都处在这个虚拟环境中。也就是说，虚拟环境与你的目录位置没有任何关系。理论上只要找的到，你把它放在任何一个犄角旮旯里都可以正常工作。</p>
<p>尽管如此，仍然建议你直接把虚拟环境直接建在项目目录中，这样项目和环境可以方便的同步迁移，并且可以确保你的ide可以识别到这个虚拟环境。</p>
<hr>
<h4 id="venv">venv<a href="#venv" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>这是python自带的虚拟环境创建方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python3.10 -m venv .venv
</span></span></code></pre></div><p>这句指令的意义是在当前目录下创建一个.venv文件夹，里面装的就是这个虚拟环境的信息。</p>
<p>针对每个参数，逐一分析一下这句指令：</p>
<hr>
<h5 id="python310">python3.10<a href="#python310" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h5>
<p>指定启动这个虚拟环境的python版本。以防你不知道，一台机器是可以同时存在多个python版本的。比如<code>pkg install python3.10</code>就可以强制要求安装3.10版本的python。</p>
<h5 id="-m">-m<a href="#-m" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h5>
<p>让后面的名字（在我们这里是venv）作为一个python模块来运行。</p>
<h5 id="venv-1">venv<a href="#venv-1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h5>
<p>这是一个python标准库中的模块，功能是创建一个虚拟环境。因为它本质上不是一个位于当前目录下的文件，你没办法直接通过运行文件的方式来使用。这也就是为什么前面必须要加<code>-m</code>参数才能使用。</p>
<h5 id="venv-2">.venv<a href="#venv-2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h5>
<p>在当前目录下生成的虚拟环境文件夹名称。这只是一个名称而已，你可以随意把它换成你喜欢的名字。</p>
<p>比如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python3.12 -m venv .asdf1234
</span></span></code></pre></div><p>之所以加<code>.</code>是为了让这个文件夹成为一个隐藏文件夹，这是一个工程惯例。实际上不加<code>.</code>也无所谓。</p>
<hr>
<h3 id="如何使用一个虚拟环境">如何使用一个虚拟环境？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e4%b8%80%e4%b8%aa%e8%99%9a%e6%8b%9f%e7%8e%af%e5%a2%83" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在你创建的虚拟环境文件夹下，你可以看到大致这样的目录结构：</p>
<p><img src="/zh-cn/posts/venvminiconda/venv.jpg" alt=""></p>
<p>你可以很清晰的看到这个文件夹里包含了什么：有虚拟环境自己的python、pip，以及专门存放lib的文件目录。此外，在bin目录下，你还可以找到<code>activate</code>文件，这就是虚拟环境的启动脚本。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>source .venv/bin/activate
</span></span></code></pre></div><p>运行这个指令，虚拟环境就成功激活了。想要关闭虚拟环境，输入以下指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>deactivate
</span></span></code></pre></div><hr>
<p>在虚拟环境中，你拥有一套和外界环境隔离的第三方库目录。你可以随意增删当前虚拟环境中的第三方库，这些操作都不会对外界环境造成影响。作为补充，这里罗列一些pip常用的指令。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip install numpy <span style="color:#75715e"># 下载numpy库</span>
</span></span></code></pre></div><p>注意，这里之所以先写<code>python -m</code>再写pip，是为了确保使用当前虚拟环境下的pip。pip是一个模块，而模块永远属于某个python。使用<code>-m</code>参数可以确保永远不会装错环境。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip install numpy<span style="color:#f92672">==</span>1.26.4 <span style="color:#75715e"># 指定安装版本</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip list <span style="color:#75715e"># 列出当前环境下安装了哪些包</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip uninstall numpy <span style="color:#75715e"># 卸载numpy</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip show numpy <span style="color:#75715e"># 显示某个包的详细信息，包括版本、安装路径、依赖关系。</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip install --upgrade numpy <span style="color:#75715e"># 在已经安装了numpy的基础上对它进行更新</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip freeze &gt; requirements.txt <span style="color:#75715e"># 导出当前环境依赖到requirements.txt文件</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>python -m pip install -r requirements.txt <span style="color:#75715e"># 从requirements.txt安装</span>
</span></span></code></pre></div><p>如果你想要删除一个虚拟环境，不需要使用什么特殊的指令，直接rm掉你建立的虚拟环境文件夹即可。</p>
<hr>
<h2 id="conda是什么">Conda是什么?<a href="#conda%e6%98%af%e4%bb%80%e4%b9%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>一句话定位conda:</p>
<blockquote>
<p>conda不是更高级的venv，
而是：“<strong>一个跨语言+跨平台+可管理python版本的环境与包管理系统</strong>”</p>
</blockquote>
<p>python官方的pip以及venv只能管理python包，但是在现实中的科学计算以及机器学习等应用场景中，一个完整的环境会涉及很多非python的依赖，并且需要处理各种跨平台问题。这就已经触及到了python原生工具的能力边界。</p>
<p>conda的出现旨在一次性解决这些问题。conda<strong>同时</strong>是一个<strong>环境管理器</strong>（你可以用它建立虚拟环境，并且比venv隔离的更加彻底）、<strong>包管理器</strong>（conda install numpy），兼<strong>python版本管理器</strong>（不管你系统中有没有安装python）。</p>
<hr>
<h3 id="anacondaminiconda是什么">Anaconda/Miniconda是什么？<a href="#anacondaminiconda%e6%98%af%e4%bb%80%e4%b9%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>Anaconda = conda + 一大堆科学计算库</p>
<p>Miniconda = conda + Python</p>
<p>通常认为Anaconda更适合用来快速上手，但是比较冗余。如果想要更轻量可控的环境，更建议使用Miniconda。</p>
<hr>
<h3 id="如何安装conda">如何安装conda?<a href="#%e5%a6%82%e4%bd%95%e5%ae%89%e8%a3%85conda" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>这里以Miniconda为例。</p>
<p><a href="https://www.anaconda.com/docs/getting-started/miniconda/main">Miniconda官网</a></p>
<hr>
<h4 id="方法一去官网下载安装脚本">方法一：去官网下载安装脚本<a href="#%e6%96%b9%e6%b3%95%e4%b8%80%e5%8e%bb%e5%ae%98%e7%bd%91%e4%b8%8b%e8%bd%bd%e5%ae%89%e8%a3%85%e8%84%9a%e6%9c%ac" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>根据你的cpu架构去官网下载对应的.sh脚本，然后在你的终端运行。</p>
<blockquote>
<p>注意：在我写博客文的同时，我发现conda不支持termux。如果你想使用conda，请确保你处在一个真正的电脑上。</p>
</blockquote>
<h4 id="方法二使用curl--wget">方法二：使用curl &amp; wget<a href="#%e6%96%b9%e6%b3%95%e4%ba%8c%e4%bd%bf%e7%94%a8curl--wget" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<hr>
<p>wget方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
</span></span></code></pre></div><p>或者curl方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -O https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
</span></span></code></pre></div><p>下载得到.sh脚本之后，仍然运行该脚本。注意这里给出的指令是x86_64架构且为linux，aarch64需要做出相应修改。</p>
<p><img src="/zh-cn/posts/venvminiconda/conda.jpg" alt=""></p>
<p>大致流程参考上图。</p>
<hr>
<h3 id="如何使用conda">如何使用conda？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8conda" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>此处仍然以miniconda为例。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda create -n asdf1234 python<span style="color:#f92672">=</span>3.10
</span></span></code></pre></div><p>这段指令的意义是：</p>
<blockquote>
<p>创建一个名为“asdf1234”的虚拟环境，其中python版本为3.10。</p>
</blockquote>
<p>其中，<code>-n</code>参数含义为&quot;name&quot;，等价于<code>--name</code>。</p>
<p><strong>需要注意的是</strong>，conda的虚拟环境并不像venv那样直接作为当前项目的一个子目录存在，conda的环境被conda视为自己管理的资源，默认集中存放。这意味着在创建这个环境之后，你不会在你的目录下得到任何新的内容。</p>
<p>这样的设计哲学意义在于当不同的环境中请求同样的包时，conda不用将额外的空间资源浪费在重复下载上，而是可以通过内部构建软链接的方式来实现资源复用。</p>
<p>conda允许你通过<code>--prefix ./env</code>参数来实现类似venv的存储行为。这里不过多展开。</p>
<hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda activate asdf1234 <span style="color:#75715e"># 激活名为asdf1234的虚拟环境</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda deactivate <span style="color:#75715e"># 退出当前环境</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda install numpy <span style="color:#75715e"># 安装包</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda env list <span style="color:#75715e"># 列出所有创建的环境，以及现在所处的环境</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda remove -n asdf1234 --all <span style="color:#75715e"># 删除一个环境</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda env export &gt; environment.yml <span style="color:#75715e"># 导出环境</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda env create -f environment.yml <span style="color:#75715e"># 从配置文件复现环境</span>
</span></span></code></pre></div><p>注意：使用conda下载包的时候，conda有一个专属名词：<strong>channel</strong>。某些时候，使用conda下载某些包的时候会提示你要下载的包不在当前channel中。这时候你需要自行寻找对应的channel，然后通过<code>-c</code>参数指定下载渠道。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>conda install pytorch<span style="color:#f92672">==</span>1.12.0 -c pytorch
</span></span></code></pre></div><blockquote>
<p>在一个conda虚拟环境中，你可以混用pip安装方式和conda安装方式。但是建议只在conda中找不到你想要的包，或者你要的包是纯python写的时再用pip。</p>
</blockquote>
]]></content>
		</item>
		
		<item>
			<title>工具不图鉴01：curl&amp;wget</title>
			<link>http://localhost:1313/zh-cn/posts/curlwget/</link>
			<pubDate>Mon, 15 Dec 2025 23:25:53 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/curlwget/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>参考链接：</p>
<p><a href="https://curl.se/">curl官网</a></p>
<p><a href="https://www.gnu.org/software/wget/">wget官网</a></p>
<p>curl和wget是在配置服务器时相当常用的终端工具。</p>
<hr>
<h2 id="什么是curl">什么是curl？<a href="#%e4%bb%80%e4%b9%88%e6%98%afcurl" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>curl，全称为Client URL，是一个通用的网络协议客户端工具。功能涵盖请求网页，下载文件，发送http请求，调试接口等。可以说这个工具就是一把网络世界的瑞士军刀。不过对于大多数普通使用者，最常见的用途是用它来下载文件。</p>
<p>在我们的日常生活中，我们不可避免的要和网络打交道。最常见的方式就是通过浏览器来浏览网页和下载文件。浏览器通过图形化界面替你完成了写请求的步骤。所谓请求，就是一种规范化的和服务器对话的方式。你只需要点点屏幕就可以完成一系列与网络服务器的信息交换。</p>
<p>但是对于没有图形化界面的终端来说，所有的信息都是基于文本来传递的，我们当然也没办法通过图形化的浏览器来获取网络资源。curl的功能就在于此。只不过不同于浏览器图形化界面的直白，你必须明确你递交的请求包含了哪些动作。</p>
<p>理解curl，其实只需要理解一句话：</p>
<blockquote>
<p><strong>curl = 在命令行中手动发送http请求</strong></p>
</blockquote>
<p>一条http请求，本质上就是4个东西：</p>
<ol>
<li>请求方法</li>
<li>请求地址（url）</li>
<li>请求头</li>
<li>请求体</li>
</ol>
<p>curl的最基本形式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl URL
</span></span></code></pre></div><p>相当于说：让我看看这个url里有什么东西。</p>
<p>关于curl语法的细则这里不再过多赘述。</p>
<hr>
<h3 id="如何使用curl">如何使用curl？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8curl" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>光知道curl是发送网络协议的工具这点其实对你的使用过程没有太大帮助。事实上，大多数人都不会从http的原理层面来思考和使用curl。</p>
<p>多数人的真实行为是：</p>
<ul>
<li>从网站/博客中复制一个curl指令。</li>
<li>稍加修改或者根本不修改。</li>
<li>用就完了。</li>
</ul>
<p>比如，如果你想下载ohmyzsh，你只需要把官网上的下载指令复制下来运行即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sh -c <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>这本身是一个原理相对复杂的指令，但是你根本不用关系这些事情。开发者已经替你考虑好了一切。</p>
<p>而稍微复杂一点点的情况是，你想要下载一个文件，但是README.md中没有给出下载指令。</p>
<p>我们举一个最简单的例子：</p>
<hr>
<p>比如，你想把一个github上的文件下载到本地。但是呢，没有任何网页告诉你应该输入什么指令来下载这个文件。你可能会想到另外用一个智能设备通过浏览器下载，然后上传到终端对应的机器。这是一个方法，但是不够直接。事实上，我们只需要一个curl指令就可以把文件下载到本地。</p>
<p>比如，你看上了ohmyzsh的README.md。你很想把它下载到本地。你不需要动用浏览器，也不需要git clone整个仓库，你只需要在终端中输入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -O https://github.com/ohmyzsh/ohmyzsh/blob/master/README.md?plain<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>curl就开始帮你下载文件了。当然前提是你的网络环境支持你访问到这个网站，如果网络条件不佳，你可能必须要配置网络代理才能正常使用。</p>
<p>但是，只要你实际尝试过，你就会发现，你下载得到的根本不是你想要的东西。你下载得到的是一大堆html代码，根本不是一个md文件。为什么呢？根本上原因在于你下载的实际是用来显示这个网页的代码，而非你想要的内容。</p>
<p>不过，对于github而言，即使你不能直接curl来获取文件，github为你提供了一个另外的快捷途径，方便你直接使用curl来下载文件。你只需要将url中的<code>github.com</code>替换为<code>raw.githubusercontent.com</code>即可。</p>
<p>然而，在这个网站中并不存有作者名以及plain之类的参数。所以，你还需要删除<code>/blob</code>以及<code>?plain=1</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -O https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/README.md
</span></span></code></pre></div><p>如果你觉得这个方法太麻烦，对于github来说还有另外一种方法可以使用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -L -O <span style="color:#e6db74">&#34;https://github.com/ohmyzsh/ohmyzsh/blob/master/README.md?raw=1&#34;</span>
</span></span></code></pre></div><p>因为我选取的这个README.md网页实际比较特殊，后面自带参数。在这个方法中，你只需要在前面添加<code>-L</code>参数，并为url后方添加<code>raw=1</code>参数即可下载。在本例子中，直接将<code>plain=1</code>替换为<code>raw=1</code>即可。</p>
<hr>
<h3 id="如何下载curl">如何下载curl？<a href="#%e5%a6%82%e4%bd%95%e4%b8%8b%e8%bd%bdcurl" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在绝大多数情况下，你的机器实际上已经配备了curl工具，因为这是一个非常基础的工具。</p>
<p>假如你的机器上没有这个工具，通常来说你也不需要经过官网来下载最新版。直接使用系统级包管理器下载即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo apt install curl <span style="color:#75715e"># 以ubuntu为例</span>
</span></span></code></pre></div><hr>
<h2 id="什么是wget">什么是wget?<a href="#%e4%bb%80%e4%b9%88%e6%98%afwget" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<blockquote>
<p>wget = <strong>World Wide Web + get</strong></p>
</blockquote>
<p>字面意思，从万维网上获取东西，就是wget。</p>
<p>不同于curl丰富的功能，这是一个专注于下载内容的工具。它的设计目的很明确：<strong>稳定、自动化、可恢复的下载文件</strong>。</p>
<hr>
<h3 id="如何使用wget">如何使用wget？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8wget" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>wget的使用方法比curl要简单的多。其中一个最简形式如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget url
</span></span></code></pre></div><p>不需要任何参数。比如，我们仍然尝试下载ohmyzsh的README.md：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget https://github.com/ohmyzsh/ohmyzsh/blob/master/README.md?plain<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>当然，这仍然是个错误的指令，通过它你只能下载到网页代码。我写这句指令，意在说明wget的简便易用。真正有用的指令如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/README.md
</span></span></code></pre></div><p>你仍然需要得到文件真正存放的url。同时，wget也允许你想下载得到的文件直接用新文件名存入本地，你只需要加一个<code>-O</code>参数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget -O myreadme.md https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/README.md
</span></span></code></pre></div><hr>
<p>此外，对于一些体积较大的下载，下载过程可能相对漫长。假如下载过程中因为网络问题而意外终断，一般的wget下载进度就会归零。在此情况下，你可以使用<code>-c</code>参数来保存下载进度，这样即使中间下载中断，继续输入指令，文件就会在原有进度基础上继续下载，不会丢失进度。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>wget -c https://example.com/bigfile.iso <span style="color:#75715e"># 这不是一个真实存在的网站，只是方便演示。</span>
</span></span></code></pre></div><hr>
<h3 id="如何下载wget">如何下载wget？<a href="#%e5%a6%82%e4%bd%95%e4%b8%8b%e8%bd%bdwget" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>与curl情况基本类似，多数时候你的机器上已经自带wget了。在少数极简开发环境下可能出现不自带wget的情况。此时，只需要使用包管理器下载即可。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo apt install wget <span style="color:#75715e"># 以Ubuntu为例</span>
</span></span></code></pre></div>]]></content>
		</item>
		
		<item>
			<title>工具不图鉴02：zsh&amp;ohmyzsh</title>
			<link>http://localhost:1313/zh-cn/posts/zshohmyzsh/</link>
			<pubDate>Mon, 15 Dec 2025 23:25:53 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/zshohmyzsh/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>参考链接：</p>
<p><a href="https://zh.wikipedia.org/wiki/Z_shell">zsh wiki</a></p>
<p><a href="https://ohmyz.sh/">ohmyzsh</a></p>
<h2 id="什么是zsh">什么是zsh？<a href="#%e4%bb%80%e4%b9%88%e6%98%afzsh" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>zsh是一个功能丰富的Unix shell，即<strong>命令行解释器</strong>。就像安装git时附送的git bash和windows系统下自带的powershell一样，你把指令输进去，按下回车，指令就运行起来了。</p>
<p>相较于其他命令行解释器如bash，zsh具有更强大的功能，如自动补全，历史记录，切换主题等。这一切都可以通过添加插件来完成。</p>
<hr>
<h3 id="如何安装zsh">如何安装zsh？<a href="#%e5%a6%82%e4%bd%95%e5%ae%89%e8%a3%85zsh" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>zsh并不是一个更新非常迅速的软件，这意味着你并不一定需要安装最新版才能确保最大程度的稳定和功能。通常来说，直接使用你的系统级包管理器来安装即可，不会导致兼容性问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo apt install zsh
</span></span></code></pre></div><hr>
<h2 id="什么是ohmyzsh">什么是ohmyzsh？<a href="#%e4%bb%80%e4%b9%88%e6%98%afohmyzsh" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>ohmyzsh是一个开源的社区驱动的zsh配置管理框架。通常来说，直接为zsh添加插件并不方便。但是通过ohmyzsh，你只需要克隆一下插件仓库，再修改一下~/.zshrc即可使用插件。</p>
<p>omz拥有非常丰富的插件生态以及活跃的贡献者社区，可以大大提高终端美观程度以及使用效率。</p>
<hr>
<h4 id="如何安装ohmyzsh">如何安装ohmyzsh？<a href="#%e5%a6%82%e4%bd%95%e5%ae%89%e8%a3%85ohmyzsh" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>不同于zsh以及很多其他的基本工具，ohmyzsh是一个迭代迅速的社区工具。这意味着如果想要使用更新更好的插件，最好通过官方渠道进行安装。</p>
<p>这里罗列从<a href="https://ohmyz.sh/#install">omz官网</a>上摘录的下载指令。你只需要将指令输入终端运行即可。</p>
<p>方法一：通过curl安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sh -c <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>方法二：通过wget安装</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sh -c <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>wget https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><p>这两个指令是相对稳定的，它们不会随omz版本迭代而发生改变。</p>
<hr>
<h2 id="ohmyzsh如何配置">ohmyzsh如何配置？<a href="#ohmyzsh%e5%a6%82%e4%bd%95%e9%85%8d%e7%bd%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>将zsh设置为默认shell：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>chsh -s /bin/zsh
</span></span></code></pre></div><hr>
<h3 id="常用插件">常用插件<a href="#%e5%b8%b8%e7%94%a8%e6%8f%92%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<h4 id="1-zsh-autosuggestions-自动补全建议">1. zsh-autosuggestions (自动补全建议)<a href="#1-zsh-autosuggestions-%e8%87%aa%e5%8a%a8%e8%a1%a5%e5%85%a8%e5%bb%ba%e8%ae%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>根据历史记录给出自动补全建议，按下右键自动补全。</p>
<p><a href="https://github.com/zsh-users/zsh-autosuggestions">github网页</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/zsh-users/zsh-autosuggestions <span style="color:#e6db74">${</span>ZSH_CUSTOM<span style="color:#66d9ef">:-</span>~/.oh-my-zsh/custom<span style="color:#e6db74">}</span>/plugins/zsh-autosuggestions
</span></span></code></pre></div><hr>
<h4 id="2-zsh-syntax-highlighting-语法高亮">2. zsh-syntax-highlighting (语法高亮)<a href="#2-zsh-syntax-highlighting-%e8%af%ad%e6%b3%95%e9%ab%98%e4%ba%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>当你输入命令时，正确的命令显示绿色，错误的显示红色，路径带有下划线。</p>
<p><a href="https://github.com/zsh-users/zsh-syntax-highlighting">github网页</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/zsh-users/zsh-syntax-highlighting.git <span style="color:#e6db74">${</span>ZSH_CUSTOM<span style="color:#66d9ef">:-</span>~/.oh-my-zsh/custom<span style="color:#e6db74">}</span>/plugins/zsh-syntax-highlighting
</span></span></code></pre></div><hr>
<h4 id="3-git内置插件">3. git（内置插件）<a href="#3-git%e5%86%85%e7%bd%ae%e6%8f%92%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>提供git简写别名，并支持tab补全。</p>
<ul>
<li>常用别名：
<ul>
<li>gst -&gt; git status</li>
<li>gco -&gt; git checkout</li>
<li>gcm -&gt; git checkout master (或 main)</li>
<li>gp -&gt; git push</li>
<li>gl -&gt; git pull</li>
</ul>
</li>
</ul>
<hr>
<h4 id="4-z内置插件">4. z（内置插件）<a href="#4-z%e5%86%85%e7%bd%ae%e6%8f%92%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>记录你访问过的目录，之后只需输入 <code>z + 目录名片段</code> 即可直接跳转，无需输入完整路径。</p>
<ul>
<li>用法：<code>z down</code> (可能直接跳转到 <code>~/Downloads</code>)</li>
</ul>
<hr>
<h4 id="5-extract内置插件">5. extract（内置插件）<a href="#5-extract%e5%86%85%e7%bd%ae%e6%8f%92%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>通用解压插件。不需要记住 <code>tar -xvf</code>、<code>unzip</code> 等繁琐参数，统一使用 <code>x</code> 命令解压任何格式的压缩包。</p>
<ul>
<li>用法：<code>x filename.tar.gz</code></li>
</ul>
<hr>
<h3 id="启用插件">启用插件<a href="#%e5%90%af%e7%94%a8%e6%8f%92%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>下载完第三方插件后，必须在 <code>.zshrc</code> 文件中配置才能生效。</p>
<p><strong>1. 编辑配置文件：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nano ~/.zshrc
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 或者使用 vim ~/.zshrc</span>
</span></span></code></pre></div><p><strong>2. 找到 <code>plugins=(...)</code> 这一行，修改为：</strong>
(注意：插件名之间用<strong>空格</strong>分隔，不要用逗号)（想使用哪些插件就写入哪些插件）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>plugins<span style="color:#f92672">=(</span>
</span></span><span style="display:flex;"><span>    git
</span></span><span style="display:flex;"><span>    z
</span></span><span style="display:flex;"><span>    extract
</span></span><span style="display:flex;"><span>    sudo
</span></span><span style="display:flex;"><span>    web-search
</span></span><span style="display:flex;"><span>    docker
</span></span><span style="display:flex;"><span>    zsh-autosuggestions       <span style="color:#75715e"># 第三方</span>
</span></span><span style="display:flex;"><span>    zsh-syntax-highlighting   <span style="color:#75715e"># 第三方，建议放在列表最后</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p><strong>3. 使配置生效：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>source ~/.zshrc
</span></span></code></pre></div><hr>
<h3 id="常见美化方案">常见美化方案<a href="#%e5%b8%b8%e8%a7%81%e7%be%8e%e5%8c%96%e6%96%b9%e6%a1%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><a href="https://github.com/ohmyzsh/ohmyzsh/wiki/Themes">可视化主题百科</a></p>
<p>在<code>~/.zshrc</code>中找到<code>ZSH_THEME</code>配置项，将对应位置的主题改为你下载的主题，之后<code>source ~/.zshrc</code>即可启用。</p>
<hr>
<h4 id="1-powerlevel10k">1. Powerlevel10k<a href="#1-powerlevel10k" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>目前相当流行的主题，配置方便，高度可自定义。</p>
<p><a href="https://github.com/romkatv/powerlevel10k">github网页</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone --depth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> https://github.com/romkatv/powerlevel10k.git <span style="color:#e6db74">${</span>ZSH_CUSTOM<span style="color:#66d9ef">:-</span>$HOME/.oh-my-zsh/custom<span style="color:#e6db74">}</span>/themes/powerlevel10k
</span></span></code></pre></div><p>主题名：<code>powerlevel10k/powerlevel10k</code></p>
<hr>
<h4 id="2-ys">2. ys<a href="#2-ys" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>我个人比较喜欢的主题，非常简洁美观，并且是omz的内置主题。直接将主题名改为ys即可。</p>
<hr>
<h1 id="集成式配置脚本">集成式配置脚本<a href="#%e9%9b%86%e6%88%90%e5%bc%8f%e9%85%8d%e7%bd%ae%e8%84%9a%e6%9c%ac" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>一键配置zsh&amp;omz全套环境。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ============================================================</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  Zsh + OMZ + Plugins + P10k 一键安装脚本 (含 Termux 支持)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ============================================================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义颜色</span>
</span></span><span style="display:flex;"><span>RED<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[0;31m&#39;</span>
</span></span><span style="display:flex;"><span>GREEN<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[0;32m&#39;</span>
</span></span><span style="display:flex;"><span>YELLOW<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[0;33m&#39;</span>
</span></span><span style="display:flex;"><span>BLUE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[0;34m&#39;</span>
</span></span><span style="display:flex;"><span>NC<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;\033[0m&#39;</span> <span style="color:#75715e"># No Color</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 定义路径</span>
</span></span><span style="display:flex;"><span>OMZ_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$HOME<span style="color:#e6db74">/.oh-my-zsh&#34;</span>
</span></span><span style="display:flex;"><span>ZSH_CUSTOM<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$OMZ_DIR<span style="color:#e6db74">/custom&#34;</span>
</span></span><span style="display:flex;"><span>ZSHRC<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$HOME<span style="color:#e6db74">/.zshrc&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BLUE<span style="color:#e6db74">}</span><span style="color:#e6db74">&gt;&gt;&gt; 开始执行集成安装脚本...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 环境检测与软件安装</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>install_packages<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在检查系统环境...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    CMD_UPDATE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检测是否为 Termux</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -n <span style="color:#e6db74">&#34;</span>$TERMUX_VERSION<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">识别到 Termux 环境。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;pkg install -y&#34;</span>
</span></span><span style="display:flex;"><span>        CMD_UPDATE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;pkg update -y&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Termux 通常不需要 sudo，除非安装了 tsu，但常规包管理直接用 pkg</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检测 MacOS</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$OSTYPE<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;darwin&#34;</span>* <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">识别到 MacOS 环境。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> command -v brew &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;brew install&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RED<span style="color:#e6db74">}</span><span style="color:#e6db74">未找到 Homebrew，请先安装 Homebrew。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检测 Linux 发行版</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> command -v apt-get &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sudo apt-get install -y&#34;</span>
</span></span><span style="display:flex;"><span>        CMD_UPDATE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sudo apt-get update&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> command -v yum &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sudo yum install -y&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> command -v dnf &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sudo dnf install -y&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> command -v pacman &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        CMD_INSTALL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sudo pacman -S --noconfirm&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RED<span style="color:#e6db74">}</span><span style="color:#e6db74">未找到支持的包管理器 (pkg/apt/yum/dnf/pacman/brew)。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 更新源 (仅 Termux 和 Debian/Ubuntu)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -z <span style="color:#e6db74">&#34;</span>$CMD_UPDATE<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;正在更新软件源...&#34;</span>
</span></span><span style="display:flex;"><span>        $CMD_UPDATE
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 安装 git, zsh, curl, vim (vim用于防止sed有时需要编辑器环境)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Termux 基础包可能不含 vim/nano，建议安装一个编辑器</span>
</span></span><span style="display:flex;"><span>    DEPENDENCIES<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;git zsh curl&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> pkg in $DEPENDENCIES; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ! command -v $pkg &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在安装 </span>$pkg<span style="color:#e6db74"> ...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            $CMD_INSTALL $pkg
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span>$pkg<span style="color:#e6db74"> 已安装。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>install_packages
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 安装 Oh My Zsh</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -d <span style="color:#e6db74">&#34;</span>$OMZ_DIR<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">Oh My Zsh 已安装，跳过下载。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在安装 Oh My Zsh...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 使用官方脚本</span>
</span></span><span style="display:flex;"><span>    sh -c <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;&#34;</span> --unattended
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -d <span style="color:#e6db74">&#34;</span>$OMZ_DIR<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RED<span style="color:#e6db74">}</span><span style="color:#e6db74">Oh My Zsh 安装失败，请检查网络 (Termux可能需要开启VPN)。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 下载插件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>install_plugin<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    local name<span style="color:#f92672">=</span>$1
</span></span><span style="display:flex;"><span>    local repo<span style="color:#f92672">=</span>$2
</span></span><span style="display:flex;"><span>    local target_dir<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$ZSH_CUSTOM<span style="color:#e6db74">/plugins/</span>$name<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -d <span style="color:#e6db74">&#34;</span>$target_dir<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在下载插件: </span>$name<span style="color:#e6db74"> ...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        git clone --depth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> $repo $target_dir
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">插件 </span>$name<span style="color:#e6db74"> 已存在。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>install_plugin <span style="color:#e6db74">&#34;zsh-autosuggestions&#34;</span> <span style="color:#e6db74">&#34;https://github.com/zsh-users/zsh-autosuggestions&#34;</span>
</span></span><span style="display:flex;"><span>install_plugin <span style="color:#e6db74">&#34;zsh-syntax-highlighting&#34;</span> <span style="color:#e6db74">&#34;https://github.com/zsh-users/zsh-syntax-highlighting.git&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. 下载 Powerlevel10k 主题</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>THEME_DIR<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$ZSH_CUSTOM<span style="color:#e6db74">/themes/powerlevel10k&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> ! -d <span style="color:#e6db74">&#34;</span>$THEME_DIR<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在下载主题: Powerlevel10k ...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    git clone --depth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> https://github.com/romkatv/powerlevel10k.git $THEME_DIR
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">主题 Powerlevel10k 已存在。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5. 配置 .zshrc</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在配置 .zshrc ...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 备份</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> -f <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    cp <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>ZSHRC<span style="color:#e6db74">}</span><span style="color:#e6db74">.backup.</span><span style="color:#66d9ef">$(</span>date +%Y%m%d%H%M%S<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 覆盖模板</span>
</span></span><span style="display:flex;"><span>cp <span style="color:#e6db74">&#34;</span>$OMZ_DIR<span style="color:#e6db74">/templates/zshrc.zsh-template&#34;</span> <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 设置 sed 命令 (MacOS 需要 -i &#39;&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$OSTYPE<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;darwin&#34;</span>* <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    SED_CMD<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sed -i &#39;&#39;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    SED_CMD<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;sed -i&#34;</span> <span style="color:#75715e"># Linux &amp; Termux</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改主题</span>
</span></span><span style="display:flex;"><span>$SED_CMD <span style="color:#e6db74">&#39;s/^ZSH_THEME=&#34;.*&#34;/ZSH_THEME=&#34;powerlevel10k\/powerlevel10k&#34;/&#39;</span> <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改插件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 注意：Termux 环境下 docker 插件通常无效，但保留也不会报错</span>
</span></span><span style="display:flex;"><span>NEW_PLUGINS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;plugins=(git z extract web-search zsh-autosuggestions zsh-syntax-highlighting)&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果不是 MacOS 且不是 Termux (即普通 Linux 服务器)，加上 sudo 插件</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Termux 默认没 sudo，加上会报错；MacOS 也不常用 sudo 插件</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -z <span style="color:#e6db74">&#34;</span>$TERMUX_VERSION<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$OSTYPE<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;darwin&#34;</span>* <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>     NEW_PLUGINS<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;plugins=(git z extract sudo web-search docker zsh-autosuggestions zsh-syntax-highlighting)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$SED_CMD <span style="color:#e6db74">&#34;s/^plugins=(git)/</span>$NEW_PLUGINS<span style="color:#e6db74">/&#34;</span> <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 兜底检查</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ! grep -q <span style="color:#e6db74">&#34;zsh-autosuggestions&#34;</span> <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;\n</span>$NEW_PLUGINS<span style="color:#e6db74">&#34;</span> &gt;&gt; <span style="color:#e6db74">&#34;</span>$ZSHRC<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">.zshrc 配置完成！</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6. 设置默认 Shell</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>CURRENT_SHELL<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>basename <span style="color:#e6db74">&#34;</span>$SHELL<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$CURRENT_SHELL<span style="color:#e6db74">&#34;</span> !<span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;zsh&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">正在设置 zsh 为默认 Shell...</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> command -v chsh &amp;&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        chsh -s <span style="color:#66d9ef">$(</span>which zsh<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>RED<span style="color:#e6db74">}</span><span style="color:#e6db74">无法自动修改默认 Shell，请手动执行: chsh -s zsh</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">当前 Shell 已经是 Zsh。</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 7. 结束</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -----------------------------------------------------------</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;\n</span><span style="color:#e6db74">${</span>BLUE<span style="color:#e6db74">}</span><span style="color:#e6db74">==============================================</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GREEN<span style="color:#e6db74">}</span><span style="color:#e6db74">  Termux / Linux / Mac 环境安装完成！</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>BLUE<span style="color:#e6db74">}</span><span style="color:#e6db74">==============================================</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;请执行: </span><span style="color:#e6db74">${</span>YELLOW<span style="color:#e6db74">}</span><span style="color:#e6db74">exec zsh</span><span style="color:#e6db74">${</span>NC<span style="color:#e6db74">}</span><span style="color:#e6db74"> 或重启 Termux 以生效。&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;Powerlevel10k 配置向导将在首次进入 zsh 时启动。&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;\n💡 Termux 提示: 如果图标显示乱码，请长按 Termux 界面 -&gt; More -&gt; Style -&gt; Font&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;   并选择一款 Nerd Font (推荐 MesloLGS NF)。&#34;</span>
</span></span><span style="display:flex;"><span>echo -e <span style="color:#e6db74">&#34;==============================================\n&#34;</span>
</span></span></code></pre></div><p>这个脚本是ai写的。不过这不重要，好用就行。</p>
<p>理论上这段脚本具有一定的健壮性，对于多数的linux发行版、macos，乃至termux，这段脚本按理都可以正常工作，不过我没测试过。</p>
<hr>
<h3 id="如何使用">如何使用?<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<ol>
<li>将这个脚本写入<code>xx.sh</code>中。xx可以是任意名字，比如<code>install_zsh.sh</code>。</li>
<li><code>chmod +x xx.sh</code>，输入这个指令为脚本赋权。</li>
<li>在当前目录下运行这个.sh文件，即输入<code>./xx.sh</code>。脚本就开始工作了。</li>
</ol>
]]></content>
		</item>
		
		<item>
			<title>Triton自学日志 02FusedSoftmax</title>
			<link>http://localhost:1313/zh-cn/posts/triton%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%97-02softmax/</link>
			<pubDate>Wed, 10 Dec 2025 08:33:43 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/triton%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%97-02softmax/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h1 id="融合-softmax-fused-softmax">融合 Softmax （Fused Softmax）<a href="#%e8%9e%8d%e5%90%88-softmax-fused-softmax" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>在本节中，我们将使用 Triton 编写一个融合的 softmax 操作的程序。
在此过程中，你会学习到：</p>
<ul>
<li>内核融合对于带宽受限操作的优势。</li>
<li>Triton 中缩减操作。</li>
</ul>
<h2 id="使用原生-pytorch-对-x-逐行进行-softmax-计算">使用原生 PyTorch 对 X 逐行进行 Softmax 计算<a href="#%e4%bd%bf%e7%94%a8%e5%8e%9f%e7%94%9f-pytorch-%e5%af%b9-x-%e9%80%90%e8%a1%8c%e8%bf%9b%e8%a1%8c-softmax-%e8%ae%a1%e7%ae%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch_npu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton.language <span style="color:#66d9ef">as</span> tl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">naive_softmax</span>(x):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    我们减去最大元素以避免溢出。Softmax 对于这种偏移是不变的。
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 读取 MN 个元素；写入 M 个元素</span>
</span></span><span style="display:flex;"><span>    x_max <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>max(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 读取 MN + M 个元素；写入 MN 个元素</span>
</span></span><span style="display:flex;"><span>    z <span style="color:#f92672">=</span> x <span style="color:#f92672">-</span> x_max[:, <span style="color:#66d9ef">None</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 读取 MN 个元素；写入 MN 个元素</span>
</span></span><span style="display:flex;"><span>    numerator <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>exp(z)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 读取 MN 个元素；写入 M 个元素</span>
</span></span><span style="display:flex;"><span>    denominator <span style="color:#f92672">=</span> numerator<span style="color:#f92672">.</span>sum(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 读取 MN + M 个元素；写入 MN 个元素</span>
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> numerator <span style="color:#f92672">/</span> denominator[:, <span style="color:#66d9ef">None</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 总计：读取 5MN + 2M 个元素；写入 3MN + 2M 个元素</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ret
</span></span></code></pre></div><h3 id="什么是softmax">什么是&quot;Softmax&quot;？<a href="#%e4%bb%80%e4%b9%88%e6%98%afsoftmax" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在大模型开发中，softmax是一个非常重要的算法。它的作用是把绝对的分数转化为相对概率。</p>
<p>举个简单的例子，假如某段对话中，大模型对下一个应该吐出的字，心里经过计算得到应该为<code>猫</code>、<code>狗</code>、<code>猪</code>，分数分别为10分，5分，20分。大模型需要在这三个字之间摇骰子选出一个。这时候我们就需要将分数转化为对应的概率。</p>
<p>将分数转化为概率的方法可以有很多种，在这里我们所采用的方式是：以每个元素分数的指数为权重决定最后概率。我们先求得每个元素的e指数，之后对e指数求和，然后计算每个元素e指数与总和的比值，最后得到概率。通过e指数，我们可以拉大差距，让最高分者有更大的可能成为答案，同时保留其他元素出现的可能。x-x_max的作用是防止e指数算出来结果过大导致溢出。根据数学推导，可以得知这里采用x和x-x_max计算得到的概率是相同的。</p>
<hr>
<h3 id="内核融合的目的">内核融合的目的<a href="#%e5%86%85%e6%a0%b8%e8%9e%8d%e5%90%88%e7%9a%84%e7%9b%ae%e7%9a%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>当在 PyTorch 中以原生方式实现时，计算<code>y=naive_softmax(x)</code>需要从 DRAM 中读取 5MN+2M 个元素，并写回 3MN+2M 个元素。显然这是非常低效的；我们更希望使用一个自定义的“融合”内核，它只需读取一次 X，并在芯片上完成所有必要的计算。
这样一来只需读取和写回 2MN 个字节，因此我们可以期望理论上的加速比大约为 4 倍（即 (8MN+4M)/2MN）。</p>
<p><code>torch.jit.script</code>旨在自动执行这种“内核融合”，但它仍然远未达到理想状态。</p>
<h4 id="dram">DRAM<a href="#dram" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>显存。在triton算子开发的语境下，内存有着严密的<strong>层级</strong>关系。不同层级的内存有着不同的功能。其中DRAM即显存的地位类似总仓库，通常有几十个G，但是庞大的存储空间对应的代价是极慢的读写速度。torch原生语句出于通用性考虑，每次读写都以DRAM为对象，但是在一些复杂的操作中就会使得出现过多理论上不必要的读写操作。triton算子提高性能的本质也就是将对DRAM的读写操作压缩到最少。</p>
<p>除了DRAM，triton算子开发中还有一个相当重要的概念就是SRAM，即共享内存。这就是triton语句中默认的读写位置。triton编译器会帮你自动管理这个层级的内存，而这个层级的特点就是虽然空间很小，但是读写速度很快。</p>
<p>在我们的triton算子开发过程中，我们通过<code>tl.load</code>来从DRAM中拉取数据，并通过<code>tl.store</code>来将数据写入DRAM。其余的变量操作本质都是在SRAM和寄存器中操作。</p>
<hr>
<h2 id="计算内核">计算内核<a href="#%e8%ae%a1%e7%ae%97%e5%86%85%e6%a0%b8" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>softmax 内核工作原理如下：每个计算单元（program）以程序数量为跨度加载输入矩阵X的一组行数据，执行归一化处理后，将结果写入输出矩阵Y。
注意：Triton 的一个重要限制是每个块必须具有 2 的幂次数的元素，因此，如果我们要处理任意可能的输入形状，需要在内部「填充」每一行，并适当保护内存操作。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#a6e22e">@triton.jit</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">softmax_kernel</span>(output_ptr, input_ptr, input_row_stride, output_row_stride, n_rows, n_cols, BLOCK_SIZE: tl<span style="color:#f92672">.</span>constexpr):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 程序起始行</span>
</span></span><span style="display:flex;"><span>    row_start <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>program_id(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    row_step <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>num_programs(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> row_idx <span style="color:#f92672">in</span> tl<span style="color:#f92672">.</span>range(row_start, n_rows, row_step):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 步长表示我们需要对指针增加多少以推进 1 行</span>
</span></span><span style="display:flex;"><span>        row_start_ptr <span style="color:#f92672">=</span> input_ptr <span style="color:#f92672">+</span> row_idx <span style="color:#f92672">*</span> input_row_stride
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 块大小是大于 n_cols 的下一个二的幂，因此我们可以适配</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 单个块中的行</span>
</span></span><span style="display:flex;"><span>        col_offsets <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>, BLOCK_SIZE)
</span></span><span style="display:flex;"><span>        input_ptrs <span style="color:#f92672">=</span> row_start_ptr <span style="color:#f92672">+</span> col_offsets
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 将行加载到 SRAM 中，使用掩码，因为 BLOCK_SIZE 可能大于 n_cols</span>
</span></span><span style="display:flex;"><span>        mask <span style="color:#f92672">=</span> col_offsets <span style="color:#f92672">&lt;</span> n_cols
</span></span><span style="display:flex;"><span>        row <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(input_ptrs, mask<span style="color:#f92672">=</span>mask, other<span style="color:#f92672">=-</span>float(<span style="color:#e6db74">&#39;inf&#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 为了数值稳定性而减去最大值</span>
</span></span><span style="display:flex;"><span>        row_minus_max <span style="color:#f92672">=</span> row <span style="color:#f92672">-</span> tl<span style="color:#f92672">.</span>max(row, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 请注意，Triton 中的指数运算速度很快，但是是近似的。</span>
</span></span><span style="display:flex;"><span>        numerator <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>exp(row_minus_max)
</span></span><span style="display:flex;"><span>        denominator <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>sum(numerator, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        softmax_output <span style="color:#f92672">=</span> numerator <span style="color:#f92672">/</span> denominator
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 将输出写回 DRAM</span>
</span></span><span style="display:flex;"><span>        output_row_start_ptr <span style="color:#f92672">=</span> output_ptr <span style="color:#f92672">+</span> row_idx <span style="color:#f92672">*</span> output_row_stride
</span></span><span style="display:flex;"><span>        output_ptrs <span style="color:#f92672">=</span> output_row_start_ptr <span style="color:#f92672">+</span> col_offsets
</span></span><span style="display:flex;"><span>        tl<span style="color:#f92672">.</span>store(output_ptrs, softmax_output, mask<span style="color:#f92672">=</span>mask)
</span></span></code></pre></div><h3 id="这段代码做了什么事情">这段代码做了什么事情？<a href="#%e8%bf%99%e6%ae%b5%e4%bb%a3%e7%a0%81%e5%81%9a%e4%ba%86%e4%bb%80%e4%b9%88%e4%ba%8b%e6%83%85" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>我们在前文中谈到了融合算子提高性能的手段是只读取一次DRAM的数据，中间的计算过程全部放在SRAM中进行。但是对于怎么实现的我们尚不得而知。这段代码就是“教科书级别”的Triton Fused Softmax实现方式。</p>
<p>我们来分块解读这段代码：</p>
<hr>
<h4 id="分配任务">分配任务<a href="#%e5%88%86%e9%85%8d%e4%bb%bb%e5%8a%a1" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>row_start <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>program_id(<span style="color:#ae81ff">0</span>)      <span style="color:#75715e"># 我是第几号工人（PID）</span>
</span></span><span style="display:flex;"><span>row_step <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>num_programs(<span style="color:#ae81ff">0</span>)     <span style="color:#75715e"># 总共有多少个工人（Grid Size）</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> row_idx <span style="color:#f92672">in</span> tl<span style="color:#f92672">.</span>range(row_start, n_rows, row_step):
</span></span></code></pre></div><p><code>tl.program_id(0)</code>表示的就是当前核心被分配到的目标程序id，<code>tl.num_programs(0)</code>则是总共的程序数。让行步长设置为程序数，目的就是让遍历所有行的时候不同程序进程不会相互冲突。随后使用for循环遍历所有的从<code>row_start</code>到<code>n_rows</code>之间步长为<code>row_step</code>的行。</p>
<p>比如，假如有1000行数据，但是总共只有n个工人，第i个工人就应该去处理第<code>n * k + i</code>个数据，这样不同工人之间处理的数据才不会相互重叠。</p>
<hr>
<h4 id="获取数据">获取数据<a href="#%e8%8e%b7%e5%8f%96%e6%95%b0%e6%8d%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 算出这一行在内存里的起始地址</span>
</span></span><span style="display:flex;"><span>row_start_ptr <span style="color:#f92672">=</span> input_ptr <span style="color:#f92672">+</span> row_idx <span style="color:#f92672">*</span> input_row_stride
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 制造一个 [0, 1, ..., BLOCK_SIZE-1] 的索引条</span>
</span></span><span style="display:flex;"><span>col_offsets <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>, BLOCK_SIZE)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 算出这一行每个元素具体的内存地址</span>
</span></span><span style="display:flex;"><span>input_ptrs <span style="color:#f92672">=</span> row_start_ptr <span style="color:#f92672">+</span> col_offsets
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 制作掩码：只保留真实数据长度以内的部分</span>
</span></span><span style="display:flex;"><span>mask <span style="color:#f92672">=</span> col_offsets <span style="color:#f92672">&lt;</span> n_cols
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 【关键动作】从 HBM 加载到 SRAM</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># other=-inf 是为了防止填充部分的 0 干扰求 Max（如果是 0 可能会变成最大值）</span>
</span></span><span style="display:flex;"><span>row <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(input_ptrs, mask<span style="color:#f92672">=</span>mask, other<span style="color:#f92672">=-</span>float(<span style="color:#e6db74">&#39;inf&#39;</span>))
</span></span></code></pre></div><p>前面三行代码的作用就是直接生成一个可以覆盖整个行的内存地址向量。虽然我们感觉要处理的数据似乎是呈二维排布的，但是在内存中的真实情况是所有信息都是线性排布的。因此，我们可以直接将每一行的起始地址加上偏移量向量得到这一行每个元素的地址组成的向量。</p>
<p>在这行代码中，<code>input_row_stride</code>本质上就代表了你一行元素的个数。</p>
<p>但是这时，有一个很关键的问题就是，BLOCK_SIZE的大小只能是2的整数次幂。为了能让核心一个任务就能处理一行数据，并且过程中不存在内存越界的情况，我们引入“掩码”的概念。将<code>mask</code>赋值为一个布尔向量，对应位置在我们目标范围内的元素为true，反之为false。这样，根据mask再调用tl.load函数我们就可以得到这一整行的数据。</p>
<hr>
<h3 id="计算数据">计算数据<a href="#%e8%ae%a1%e7%ae%97%e6%95%b0%e6%8d%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 1. 找最大值 (只读 SRAM)</span>
</span></span><span style="display:flex;"><span>row_minus_max <span style="color:#f92672">=</span> row <span style="color:#f92672">-</span> tl<span style="color:#f92672">.</span>max(row, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 算指数 (只读 SRAM)</span>
</span></span><span style="display:flex;"><span>numerator <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>exp(row_minus_max)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 求和 (只读 SRAM)</span>
</span></span><span style="display:flex;"><span>denominator <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>sum(numerator, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. 算除法 (只读 SRAM)</span>
</span></span><span style="display:flex;"><span>softmax_output <span style="color:#f92672">=</span> numerator <span style="color:#f92672">/</span> denominator
</span></span></code></pre></div><p>这里大量使用了数据科学库常见的广播机制，最后实现的效果和pytorch中的原生代码效果一致，只不过计算过程发生在SRAM当中。</p>
<hr>
<h3 id="写入数据">写入数据<a href="#%e5%86%99%e5%85%a5%e6%95%b0%e6%8d%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 算出输出的内存地址</span>
</span></span><span style="display:flex;"><span>output_row_start_ptr <span style="color:#f92672">=</span> output_ptr <span style="color:#f92672">+</span> row_idx <span style="color:#f92672">*</span> output_row_stride
</span></span><span style="display:flex;"><span>output_ptrs <span style="color:#f92672">=</span> output_row_start_ptr <span style="color:#f92672">+</span> col_offsets
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 【关键动作】从 SRAM 写回 HBM</span>
</span></span><span style="display:flex;"><span>tl<span style="color:#f92672">.</span>store(output_ptrs, softmax_output, mask<span style="color:#f92672">=</span>mask)
</span></span></code></pre></div><p>直到最后一步再把数据写入DRAM当中。完成整个kernel运算。</p>
<hr>
<h1 id="辅助函数">辅助函数<a href="#%e8%be%85%e5%8a%a9%e5%87%bd%e6%95%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>我们可以创建一个辅助函数，该函数能够将核函数及其元参数加入执行队列，以处理任意给定的输入张量。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>target <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>runtime<span style="color:#f92672">.</span>driver<span style="color:#f92672">.</span>active<span style="color:#f92672">.</span>get_current_target()
</span></span><span style="display:flex;"><span>kernels <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">softmax</span>(x, stream):
</span></span><span style="display:flex;"><span>    n_rows, n_cols <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>shape
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 每次循环迭代的块大小是大于或等于`x`列数的最小二的幂</span>
</span></span><span style="display:flex;"><span>    BLOCK_SIZE <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>next_power_of_2(n_cols)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 分配输出空间</span>
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>empty_like(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 预编译内核以获取寄存器使用情况并计算线程占用情况。</span>
</span></span><span style="display:flex;"><span>    kernel, num_programs <span style="color:#f92672">=</span> kernels<span style="color:#f92672">.</span>get(BLOCK_SIZE, (<span style="color:#66d9ef">None</span>, <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> kernel <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        num_programs <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>        kernel <span style="color:#f92672">=</span> softmax_kernel
</span></span><span style="display:flex;"><span>        kernels[BLOCK_SIZE] <span style="color:#f92672">=</span> (kernel, num_programs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    num_programs <span style="color:#f92672">=</span> min(num_programs, n_rows)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    kernel[(num_programs, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)](
</span></span><span style="display:flex;"><span>        y,
</span></span><span style="display:flex;"><span>        x,
</span></span><span style="display:flex;"><span>        x<span style="color:#f92672">.</span>stride(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        y<span style="color:#f92672">.</span>stride(<span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>        n_rows,
</span></span><span style="display:flex;"><span>        n_cols,
</span></span><span style="display:flex;"><span>        BLOCK_SIZE
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y
</span></span></code></pre></div><p>这段代码有几个相对不太容易理解的机制。下面我来一一解答。</p>
<h3 id="q1函数外的targetkernels的作用是什么">Q1：函数外的target、kernels的作用是什么？<a href="#q1%e5%87%bd%e6%95%b0%e5%a4%96%e7%9a%84targetkernels%e7%9a%84%e4%bd%9c%e7%94%a8%e6%98%af%e4%bb%80%e4%b9%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>kernels = {}</code>注意这种写法在python中代表着创建一个字典。它不是什么triton中特有的语法。在本代码中，kernels字典的key为BLOCK_SIZE，即任务块的大小，而值则为一个存储了kernel函数和启动程序数的元组，代表一种启动程序的方式。</p>
<p>每次我们运行带有<code>@triton.jit</code>装饰的函数时，triton都需要依据输入的参数做一系列初始化的工作。多数时候，softmax函数是一个相对常用的函数，假如每次调用这个函数都必须要重新初始化就会导致不必要的性能浪费。所以我们通过memo字典的方式存储记录的方式实现性能优化。</p>
<p><code>target</code>的意义是获取当前设备的硬件信息。在本代码片段中没有被用到。</p>
<hr>
<h3 id="q2kernelget是做什么的">Q2：kernel.get是做什么的？<a href="#q2kernelget%e6%98%af%e5%81%9a%e4%bb%80%e4%b9%88%e7%9a%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>查表。在之前的softmax使用过程中，我们很可能已经处理了相同的BLOCK_SIZE场景。这里因为返回的是元组，所以直接赋值两个变量自动解包。如果存储的kernels中没有所需的记录，后面我们就会为之创建一套解决方案。</p>
<hr>
<h3 id="q3看起来kernel只可能为softmax_kernel这样的话为什么还要多存储一个kernel在memo中呢">Q3：看起来kernel只可能为softmax_kernel，这样的话为什么还要多存储一个kernel在memo中呢？<a href="#q3%e7%9c%8b%e8%b5%b7%e6%9d%a5kernel%e5%8f%aa%e5%8f%af%e8%83%bd%e4%b8%basoftmax_kernel%e8%bf%99%e6%a0%b7%e7%9a%84%e8%af%9d%e4%b8%ba%e4%bb%80%e4%b9%88%e8%bf%98%e8%a6%81%e5%a4%9a%e5%ad%98%e5%82%a8%e4%b8%80%e4%b8%aakernel%e5%9c%a8memo%e4%b8%ad%e5%91%a2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>因为softmax_kernel之间也有区别。区别就在于，假如我们为softmax_kernel添加一个<code>@triton_autotune（）</code>装饰器，我们调用的kernel函数就会依据情况不同而发生变化，而转化为针对对应参数时的最优BLOCK_SIZE配置版kernel。</p>
<p>通过memo字典，我们直接捕捉这些发生变化的kernel函数，使得遇到相同BLOCK_SIZE时我们无需再次把性能用在自动调优上，进一步实现优化。</p>
<hr>
<h3 id="q4kernel是什么写法">Q4：kernel[&hellip;](&hellip;)是什么写法？<a href="#q4kernel%e6%98%af%e4%bb%80%e4%b9%88%e5%86%99%e6%b3%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>这是一个非常神奇的写法。</p>
<p>在kernel[&hellip;]的方括号当中写入的是一个元组，其中包含至多三个元素。写成方括号的形式看起来像是在查字典，但是实际上做的事情也确实类似。<code>launcher = kernel[(100,1,1)]</code>最后会得到一个配置好的启动器对象。kernel对象的__getitem__方法在triton中被覆写了，让你可以通过这种方式得到一个自定义形状的启动模式。在这里，我们得到了一个一维的由100个程序或进程组成的启动方法。如果你想只写入一个参数，记得python中的一元元组要求必须在元素后加一个逗号，即<code>(x,)</code>。</p>
<p>还记得<code>pid = tl.program_id(0)</code>吗？这里之所以需要一个参数0，本质上就是因为程序进程的排布方式是三维的。输入0就意味着返回当前程序的第一维坐标。由于我们使用的启动方式就是一维的，只读取第一维坐标就足够区分不同的程序进程了。</p>
<p>之所以程序启动会是一个立体的三维概念，根本上并不是因为显卡中核心是这么排布的，而是方便人类去适配不同的数据结构。比如如果你要处理图像，你可能针对每一个像素点都要开一个程序，这时使用二维方式启动程序并用横纵坐标来标记程序就可以为写代码带来方便。同时，这也会间接带来性能上的优化。</p>
<p>在01_vector_add中，我们在这个方括号中传入了一个lambda函数。这个lambda函数传入的参数就是kernel函数的参数字典。我们可以通过那种方式来动态决定启动程序数，但是在这里，我们本质上使用了memo记忆化搜索的方式来进一步优化性能，使得相同的情景我们无需再将性能用在动态决定启动程序数上。</p>
<hr>
<h2 id="单元测试">单元测试<a href="#%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>需要在一个具有不规则行和列数的矩阵上测试处理好的内核，此举可以验证Padding机制是否起作用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>device <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>npu<span style="color:#f92672">.</span>current_device()
</span></span><span style="display:flex;"><span>stream <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>npu<span style="color:#f92672">.</span>current_stream(device)<span style="color:#f92672">.</span>npu_stream
</span></span><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>randn(<span style="color:#ae81ff">1823</span>, <span style="color:#ae81ff">781</span>, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu&#39;</span>)
</span></span><span style="display:flex;"><span>y_triton <span style="color:#f92672">=</span> softmax(x, stream)
</span></span><span style="display:flex;"><span>y_torch <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>softmax(x, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">assert</span> torch<span style="color:#f92672">.</span>allclose(y_triton, y_torch), (y_triton, y_torch)
</span></span><span style="display:flex;"><span>print(y_triton)
</span></span><span style="display:flex;"><span>print(y_torch)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;The maximum difference between torch and triton is &#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>torch<span style="color:#f92672">.</span>max(torch<span style="color:#f92672">.</span>abs(y_triton<span style="color:#f92672">-</span>y_torch))<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p>我们上文中编写的帮助函数实际作用是对目标的二维张量的每一行进行softmax计算。在这个例子中，我们生成了一个由随机数构成的张量x，随后分别使用torch原生方法和triton融合算子来对它进行softmax计算，最后测量两结果之间的最大差异。</p>
<p>理论上来说，我们的triton算子和torch原生算子的数学过程是等价的。之所以会出现微小误差实际上是过程中的计算步骤的底层实现方法导致了一些浮点数精度误差。</p>
<p>Out:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tensor<span style="color:#f92672">([[</span>0.0002, 0.0017, 0.0009,  ..., 0.0009, 0.0013, 0.0073<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0001, 0.0004, 0.0006,  ..., 0.0006, 0.0004, 0.0003<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0007, 0.0002, 0.0006,  ..., 0.0011, 0.0004, 0.0039<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        ...,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0021, 0.0002, 0.0015,  ..., 0.0012, 0.0014, 0.0022<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0003, 0.0002, 0.0007,  ..., 0.0005, 0.0006, 0.0007<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0034, 0.0014, 0.0005,  ..., 0.0007, 0.0016, 0.0028<span style="color:#f92672">]]</span>,
</span></span><span style="display:flex;"><span>       device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu:0&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>tensor<span style="color:#f92672">([[</span>0.0002, 0.0017, 0.0009,  ..., 0.0009, 0.0013, 0.0073<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0001, 0.0004, 0.0006,  ..., 0.0006, 0.0004, 0.0003<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0007, 0.0002, 0.0006,  ..., 0.0011, 0.0004, 0.0039<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        ...,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0021, 0.0002, 0.0015,  ..., 0.0012, 0.0014, 0.0022<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0003, 0.0002, 0.0007,  ..., 0.0005, 0.0006, 0.0007<span style="color:#f92672">]</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>0.0034, 0.0014, 0.0005,  ..., 0.0007, 0.0016, 0.0028<span style="color:#f92672">]]</span>,
</span></span><span style="display:flex;"><span>       device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu:0&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>The maximum difference between torch and triton is 1.4901161193847656e-08
</span></span></code></pre></div><p>&ldquo;The maximum difference between torch and triton is 1.4901161193847656e-08&rdquo; 表示Triton和PyTorch的输出结果非常接近，肉眼不可区分。</p>
<hr>
<h1 id="测试性能">测试性能<a href="#%e6%b5%8b%e8%af%95%e6%80%a7%e8%83%bd" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>为了对比triton融合算子和torch原生方法的性能，我们再次采用benchmark方法来测量不同数据量下两种算法的带宽吞吐量。顺便的，我们还可以看看torch原生的softmax方法的性能如何。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Fused Softmax
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">=============
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch_npu
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton.language <span style="color:#66d9ef">as</span> tl
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> triton.runtime <span style="color:#f92672">import</span> driver
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">naive_softmax</span>(x):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;Compute row-wise softmax of X using native pytorch
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    We subtract the maximum element in order to avoid overflows. Softmax is invariant to
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    this shift.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># read  MN elements ; write M  elements</span>
</span></span><span style="display:flex;"><span>    x_max <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>max(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># read MN + M elements ; write MN elements</span>
</span></span><span style="display:flex;"><span>    z <span style="color:#f92672">=</span> x <span style="color:#f92672">-</span> x_max[:, <span style="color:#66d9ef">None</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># read  MN elements ; write MN elements</span>
</span></span><span style="display:flex;"><span>    numerator <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>exp(z)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># read  MN elements ; write M  elements</span>
</span></span><span style="display:flex;"><span>    denominator <span style="color:#f92672">=</span> numerator<span style="color:#f92672">.</span>sum(dim<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># read MN + M elements ; write MN elements</span>
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> numerator <span style="color:#f92672">/</span> denominator[:, <span style="color:#66d9ef">None</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># in total: read 5MN + 2M elements ; wrote 3MN + 2M elements</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@triton.jit</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">softmax_kernel</span>(
</span></span><span style="display:flex;"><span>    output_ptr,
</span></span><span style="display:flex;"><span>    input_ptr,
</span></span><span style="display:flex;"><span>    input_row_stride,
</span></span><span style="display:flex;"><span>    output_row_stride,
</span></span><span style="display:flex;"><span>    n_rows,
</span></span><span style="display:flex;"><span>    n_cols,
</span></span><span style="display:flex;"><span>    BLOCK_SIZE: tl<span style="color:#f92672">.</span>constexpr,
</span></span><span style="display:flex;"><span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># starting row of the program</span>
</span></span><span style="display:flex;"><span>    row_start <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>program_id(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    row_step <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>num_programs(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> row_idx <span style="color:#f92672">in</span> tl<span style="color:#f92672">.</span>range(row_start, n_rows, row_step):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># The stride represents how much we need to increase the pointer to advance 1 row</span>
</span></span><span style="display:flex;"><span>        row_start_ptr <span style="color:#f92672">=</span> input_ptr <span style="color:#f92672">+</span> row_idx <span style="color:#f92672">*</span> input_row_stride
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># The block size is the next power of two greater than n_cols, so we can fit each</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># row in a single block</span>
</span></span><span style="display:flex;"><span>        col_offsets <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>, BLOCK_SIZE)
</span></span><span style="display:flex;"><span>        input_ptrs <span style="color:#f92672">=</span> row_start_ptr <span style="color:#f92672">+</span> col_offsets
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Load the row into SRAM, using a mask since BLOCK_SIZE may be &gt; than n_cols</span>
</span></span><span style="display:flex;"><span>        mask <span style="color:#f92672">=</span> col_offsets <span style="color:#f92672">&lt;</span> n_cols
</span></span><span style="display:flex;"><span>        row <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(input_ptrs, mask<span style="color:#f92672">=</span>mask, other<span style="color:#f92672">=-</span>float(<span style="color:#e6db74">&#34;inf&#34;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Subtract maximum for numerical stability</span>
</span></span><span style="display:flex;"><span>        row_minus_max <span style="color:#f92672">=</span> row <span style="color:#f92672">-</span> tl<span style="color:#f92672">.</span>max(row, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        numerator <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>exp(row_minus_max)
</span></span><span style="display:flex;"><span>        denominator <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>sum(numerator, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        softmax_output <span style="color:#f92672">=</span> numerator <span style="color:#f92672">/</span> denominator
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Write back output to DRAM</span>
</span></span><span style="display:flex;"><span>        output_row_start_ptr <span style="color:#f92672">=</span> output_ptr <span style="color:#f92672">+</span> row_idx <span style="color:#f92672">*</span> output_row_stride
</span></span><span style="display:flex;"><span>        output_ptrs <span style="color:#f92672">=</span> output_row_start_ptr <span style="color:#f92672">+</span> col_offsets
</span></span><span style="display:flex;"><span>        tl<span style="color:#f92672">.</span>store(output_ptrs, softmax_output, mask<span style="color:#f92672">=</span>mask)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>target <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>runtime<span style="color:#f92672">.</span>driver<span style="color:#f92672">.</span>active<span style="color:#f92672">.</span>get_current_target()
</span></span><span style="display:flex;"><span>kernels <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">softmax</span>(x, stream):
</span></span><span style="display:flex;"><span>    n_rows, n_cols <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>shape
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># The block size of each loop iteration is the smallest power of two greater than the number of columns in `x`</span>
</span></span><span style="display:flex;"><span>    BLOCK_SIZE <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>next_power_of_2(n_cols)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Allocate output</span>
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>empty_like(x)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># pre-compile kernel to get register usage and compute thread occupancy.</span>
</span></span><span style="display:flex;"><span>    kernel, num_programs <span style="color:#f92672">=</span> kernels<span style="color:#f92672">.</span>get(BLOCK_SIZE, (<span style="color:#66d9ef">None</span>, <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> kernel <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        num_programs <span style="color:#f92672">=</span> <span style="color:#ae81ff">32</span>
</span></span><span style="display:flex;"><span>        kernel <span style="color:#f92672">=</span> softmax_kernel
</span></span><span style="display:flex;"><span>        kernels[BLOCK_SIZE] <span style="color:#f92672">=</span> (kernel, num_programs)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    num_programs <span style="color:#f92672">=</span> min(num_programs, n_rows)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create a number of persistent programs.</span>
</span></span><span style="display:flex;"><span>    kernel[(num_programs, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)](
</span></span><span style="display:flex;"><span>        y, x, x<span style="color:#f92672">.</span>stride(<span style="color:#ae81ff">0</span>), y<span style="color:#f92672">.</span>stride(<span style="color:#ae81ff">0</span>), n_rows, n_cols, BLOCK_SIZE
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>device <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>npu<span style="color:#f92672">.</span>current_device()
</span></span><span style="display:flex;"><span>stream <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>npu<span style="color:#f92672">.</span>current_stream(device)<span style="color:#f92672">.</span>npu_stream
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@triton.testing.perf_report</span>(
</span></span><span style="display:flex;"><span>    triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>Benchmark(
</span></span><span style="display:flex;"><span>        x_names<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;N&#34;</span>],  <span style="color:#75715e"># 用作图表 X 轴的参数名</span>
</span></span><span style="display:flex;"><span>        x_vals<span style="color:#f92672">=</span>[<span style="color:#ae81ff">128</span> <span style="color:#f92672">*</span> i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">100</span>)],  <span style="color:#75715e"># X 轴的具体数值</span>
</span></span><span style="display:flex;"><span>        line_arg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;provider&#34;</span>,  <span style="color:#75715e"># 用作对比不同曲线的参数名</span>
</span></span><span style="display:flex;"><span>        line_vals<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;triton&#34;</span>, <span style="color:#e6db74">&#34;torch-native&#34;</span>, <span style="color:#e6db74">&#34;torch-naive&#34;</span>],  <span style="color:#75715e"># 只有这三个值</span>
</span></span><span style="display:flex;"><span>        line_names<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;Triton&#34;</span>, <span style="color:#e6db74">&#34;Torch (Native)&#34;</span>, <span style="color:#e6db74">&#34;Torch (Naive)&#34;</span>],  <span style="color:#75715e"># 图例显示的名字</span>
</span></span><span style="display:flex;"><span>        styles<span style="color:#f92672">=</span>[(<span style="color:#e6db74">&#34;blue&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>), (<span style="color:#e6db74">&#34;green&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>), (<span style="color:#e6db74">&#34;red&#34;</span>, <span style="color:#e6db74">&#34;--&#34;</span>)],  <span style="color:#75715e"># 曲线颜色和线型</span>
</span></span><span style="display:flex;"><span>        ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;GB/s&#34;</span>,  <span style="color:#75715e"># Y 轴单位：显存吞吐量 (越高越好)</span>
</span></span><span style="display:flex;"><span>        plot_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;softmax-performance&#34;</span>,
</span></span><span style="display:flex;"><span>        args<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;M&#34;</span>: <span style="color:#ae81ff">4096</span>},  <span style="color:#75715e"># 固定 Batch Size 为 4096</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">benchmark</span>(M, N, provider):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 初始化数据 (FP16 或者是 FP32)</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>randn(M, N, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;npu&#34;</span>, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float32)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 使用 Quantile 计算分位数，避免偶尔的抖动</span>
</span></span><span style="display:flex;"><span>    quantiles <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.2</span>, <span style="color:#ae81ff">0.8</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> provider <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;torch-native&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 这里的 torch.softmax 是 C++ 深度优化的库函数 (cuDNN/CANN)</span>
</span></span><span style="display:flex;"><span>        ms, min_ms, max_ms <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>do_bench(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">lambda</span>: torch<span style="color:#f92672">.</span>softmax(x, axis<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>), quantiles<span style="color:#f92672">=</span>quantiles
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> provider <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;triton&#34;</span>:
</span></span><span style="display:flex;"><span>        ms, min_ms, max_ms <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>do_bench(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">lambda</span>: softmax(x, stream), quantiles<span style="color:#f92672">=</span>quantiles
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> provider <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;torch-naive&#34;</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 这是一个反面教材，速度极慢</span>
</span></span><span style="display:flex;"><span>        ms, min_ms, max_ms <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>do_bench(
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">lambda</span>: naive_softmax(x), quantiles<span style="color:#f92672">=</span>quantiles
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 计算吞吐量 GB/s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 公式：(读取量 + 写入量) / 时间</span>
</span></span><span style="display:flex;"><span>    gbps <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> ms: <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> x<span style="color:#f92672">.</span>numel() <span style="color:#f92672">*</span> x<span style="color:#f92672">.</span>element_size() <span style="color:#f92672">*</span> <span style="color:#ae81ff">1e-9</span> <span style="color:#f92672">/</span> (ms <span style="color:#f92672">*</span> <span style="color:#ae81ff">1e-3</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> gbps(ms), gbps(max_ms), gbps(min_ms)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 运行测试</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 检查是否有 GPU/NPU</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> torch<span style="color:#f92672">.</span>npu<span style="color:#f92672">.</span>is_available():
</span></span><span style="display:flex;"><span>        benchmark<span style="color:#f92672">.</span>run(print_data<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, show_plots<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, save_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;.&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;未检测到 GPU/NPU，无法运行 Triton 测试。&#34;</span>)
</span></span></code></pre></div><p>运行这段代码，我得到了如下图的性能对比图表：</p>
<p><img src="/zh-cn/posts/triton%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%97-02softmax/%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%942025121001.jpg" alt=""></p>
<p>从图中可以看出,我们的triton融合算子和<code>torch.softmax</code>在数据量较大的情况下性能基本一致，而使用torch原生方法分步计算的<code>torch-naive</code>则性能表现一般。</p>
]]></content>
		</item>
		
		<item>
			<title>Triton自学日志 01VectorAdd</title>
			<link>http://localhost:1313/zh-cn/posts/triton%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%97-01vectoradd/</link>
			<pubDate>Tue, 09 Dec 2025 08:26:42 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/triton%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%97-01vectoradd/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>在经过了大约半个月的环境配置过程，终于成功在华为服务器上搭建起了vllm和triton开发环境，可以正式开始研究triton算子的写法了。但是我对triton算子没有任何概念，索性花了点时间逐行研究triton-ascend的官方文档示例代码。</p>
<p>本文参考链接如下：</p>
<p><a href="https://gitcode.com/Ascend/triton-ascend">Triton Ascend</a></p>
<p><a href="https://gitcode.com/Ascend/triton-ascend/blob/master/docs/sources/getting-started/tutorials/01-vector-add.md">01-vector-add教程</a></p>
<p>文章写完之后突然意识到triton语境下数据缓存的位置实际是显存而非传统意义的内存。文中可能会出现显存内存不分的情况，意会即可。</p>
<hr>
<h1 id="向量相加-vector-addition">向量相加 （Vector Addition）<a href="#%e5%90%91%e9%87%8f%e7%9b%b8%e5%8a%a0-vector-addition" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>在本节中，我们将使用 Triton 编写一个简单的向量相加的程序。
在此过程中，你会学习到：</p>
<ul>
<li>Triton 的基本编程模式。</li>
<li>用于定义 Triton 内核的<code>triton.jit</code>装饰器（decorator）。</li>
</ul>
<p>计算内核:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch_npu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton.language <span style="color:#66d9ef">as</span> tl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@triton.jit</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_kernel</span>(x_ptr,  <span style="color:#75715e"># 指向第一个输入向量的指针。</span>
</span></span><span style="display:flex;"><span>               y_ptr,  <span style="color:#75715e"># 指向第二个输入向量的指针。</span>
</span></span><span style="display:flex;"><span>               output_ptr,  <span style="color:#75715e"># 指向输出向量的指针。</span>
</span></span><span style="display:flex;"><span>               n_elements,  <span style="color:#75715e"># 向量的大小。</span>
</span></span><span style="display:flex;"><span>               BLOCK_SIZE: tl<span style="color:#f92672">.</span>constexpr,  <span style="color:#75715e"># 每个程序应处理的元素数量。</span>
</span></span><span style="display:flex;"><span>               <span style="color:#75715e"># 注意：`constexpr` 将标记变量为常量。</span>
</span></span><span style="display:flex;"><span>               ):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 不同的数据由不同的“process”来处理，因此需要分配：</span>
</span></span><span style="display:flex;"><span>    pid <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>program_id(axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># 使用 1D 启动网格，因此轴为 0。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 该程序将处理相对初始数据偏移的输入。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 例如，如果有一个长度为 256, 块大小为 64 的向量，程序将各自访问 [0:64, 64:128, 128:192, 192:256] 的元素。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 注意 offsets 是指针列表：</span>
</span></span><span style="display:flex;"><span>    block_start <span style="color:#f92672">=</span> pid <span style="color:#f92672">*</span> BLOCK_SIZE
</span></span><span style="display:flex;"><span>    offsets <span style="color:#f92672">=</span> block_start <span style="color:#f92672">+</span> tl<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>, BLOCK_SIZE)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 创建掩码以防止内存操作超出边界访问。</span>
</span></span><span style="display:flex;"><span>    mask <span style="color:#f92672">=</span> offsets <span style="color:#f92672">&lt;</span> n_elements
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 从 DRAM 加载 x 和 y，如果输入不是块大小的整数倍，则屏蔽掉任何多余的元素。</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(x_ptr <span style="color:#f92672">+</span> offsets, mask<span style="color:#f92672">=</span>mask)
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(y_ptr <span style="color:#f92672">+</span> offsets, mask<span style="color:#f92672">=</span>mask)
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">=</span> x <span style="color:#f92672">+</span> y
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 将 x + y 写回 DRAM。</span>
</span></span><span style="display:flex;"><span>    tl<span style="color:#f92672">.</span>store(output_ptr <span style="color:#f92672">+</span> offsets, output, mask<span style="color:#f92672">=</span>mask)
</span></span></code></pre></div><h1 id="如何理解">如何理解？<a href="#%e5%a6%82%e4%bd%95%e7%90%86%e8%a7%a3" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<h2 id="1-什么是计算内核">1. 什么是“计算内核”？<a href="#1-%e4%bb%80%e4%b9%88%e6%98%af%e8%ae%a1%e7%ae%97%e5%86%85%e6%a0%b8" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>通常的python程序运行在cpu上，程序的执行方式是串行（一行一行执行）。</p>
<p>但是在npu/gpu上，计算核心的组成和cpu上完全不同。npu/gpu上的核心功能远比cpu简单，但是核心数量远远大于cpu，适合用来处理大量的简单计算。为了快速计算，我们需要让核心并行计算，即几千个核心同时进行计算。这时的程序逻辑就和cpu上有所区别。</p>
<h3 id="计算内核kernel">计算内核（kernel）<a href="#%e8%ae%a1%e7%ae%97%e5%86%85%e6%a0%b8kernel" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>我们没有办法通过一个巨大的程序控制全局，而是通过发射kernel的方式明确每个npu/gpu小核心的工作内容。kernel就是你送给小核心的指令。发射一次kernel，所有的指定核心就会按照你给出的指令进行同样的计算操作，而他们之间的区别就在于操作的内存地址有所不同。</p>
<hr>
<h2 id="2-tritonjit装饰器在干什么">2. @triton.jit装饰器在干什么?<a href="#2-tritonjit%e8%a3%85%e9%a5%b0%e5%99%a8%e5%9c%a8%e5%b9%b2%e4%bb%80%e4%b9%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>显然，你的python程序没办法直接跑在npu/gpu上。npu/gpu核心功能本身就很简单了，而你的python程序则是跑在cpu上的。所以，你需要方法把python程序代码解读为npu/gpu能懂的语言。</p>
<p>在写<code>def add_kernel()</code>前为它加上<code>@triton.jit</code>装饰器后，在你运行这个python程序时，这段<code>add_kernel</code>函数就会被编译为npu/gpu能懂的二进制机器码，并将这个npu/gpu能直接读懂的指令放在某个地方，等待调用。</p>
<p>当你真正调用<code>add_kernel</code>这个函数时，系统实际上并不会在cpu上执行这个函数的函数体，而是通过驱动程序直接使用刚才编译好的二进制机器码。</p>
<p>说白了，就是把这段python程序变成npu上能高速运行的二进制程序。</p>
<hr>
<h2 id="3-行业黑话">3. 行业黑话<a href="#3-%e8%a1%8c%e4%b8%9a%e9%bb%91%e8%af%9d" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<h3 id="x_ptry_ptroutput_ptr"><code>x_ptr</code>、<code>y_ptr</code>、<code>output_ptr</code><a href="#x_ptry_ptroutput_ptr" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>向量的起始地址。向量在内存中的存储是连续的，因此我们只需要一个起始地址就可以描述这个向量中所有元素的位置。</p>
<hr>
<h3 id="block_sizetlconstexpr"><code>BLOCK_SIZE:tl.constexpr</code><a href="#block_sizetlconstexpr" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在这里，注释中出现了一个“程序”的概念。此处的“程序”如果代入我们通常对“程序”的理解，在这个上下文中会显得非常违和。所以，我们需要先来明确npu语境下“程序”的概念。</p>
<h3 id="什么是triton语境下的程序">什么是Triton语境下的“程序”?<a href="#%e4%bb%80%e4%b9%88%e6%98%aftriton%e8%af%ad%e5%a2%83%e4%b8%8b%e7%9a%84%e7%a8%8b%e5%ba%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>在 Triton 的代码逻辑里：</p>
<blockquote>
<p><strong>一个“程序（instance）” = 你的内核函数被复制并运行的其中一次“副本”。</strong></p>
</blockquote>
<p>举个例子：</p>
<ul>
<li>假如总数据量为1024。</li>
<li>你规定了一个block_size，让一个“副本”每次只能处理128个数据。</li>
<li>所以根据代码，你最后算出来你需要启动8个副本。</li>
<li>你创建了8个副本，核心就会自动来取走你创建的副本，一旦一个副本完成，多余的核心就会立刻投入接下来的副本的工作。</li>
</ul>
<p>用一个形象比喻：</p>
<ul>
<li>考试总共要做1024道题（数据量）。</li>
<li>参加考试的考生有4个（核心数）。</li>
<li>一个卷子只能放128道题（你规定的block_size）。</li>
<li>你打印了8张卷子（程序），每个卷子有128道题。</li>
<li>考生每个人各自拿走了1张卷子，做完一张后自动再取剩下的卷子。</li>
</ul>
<h3 id="为什么要固定block_size">为什么要固定block_size？<a href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e8%a6%81%e5%9b%ba%e5%ae%9ablock_size" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>比如，你可能会认为，直接一张卷子印256道题不就没有中间调度的问题了吗？或者随便多少道题只要最后完成就行。</p>
<p>但是，在triton的语境下，规定好block_size之后，编译器就可以针对这个任务包大小对生成的二进制机器码进行疯狂优化。将block_size定为常量可以大幅提升运算效率。</p>
<hr>
<h3 id="pid--tlprogram_idaxis--0"><code>pid = tl.program_id(axis = 0)</code><a href="#pid--tlprogram_idaxis--0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>别忘了，我们在写的东西是一个<strong>kernel</strong>。我们最后会把这同一个kernel发送给所有的核心，但是这些核心最后需要去处理不同内存地址上的向量，这样才能实现并行计算的目的。</p>
<p>这些核心之间唯一有区别的地方，就在于它们被分配到的<code>program_id</code>不同。因此，通过program_id，你实际上做的事情是告诉核心根据它正在进行的程序id去随机应变。而我们此处的“随机应变”就是让核心根据程序id去操作相应的内存地址。</p>
<hr>
<h3 id="block_start--pid--block_size"><code>block_start = pid * BLOCK_SIZE</code><a href="#block_start--pid--block_size" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>任务块的起始点。在本代码情景下，你要操作的内存是一大片连续内存空间，所以将它分块后你需要让核心先知道自己所处理的那一块数据的一个“锚点”在哪，再根据“锚点”位置通过偏移量明确操作的具体位置。</p>
<hr>
<h3 id="offsets--block_start--tlarange0-block_size"><code>offsets = block_start + tl.arange(0, BLOCK_SIZE)</code><a href="#offsets--block_start--tlarange0-block_size" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><code>tl.arange(0, BLOCK_SIZE)</code>直接生成一个0到BLOCK_SIZE的序列，加上block_start对序列中的每个数字添加一个起始值，最后得到了一个偏移量向量，代表了这一批任务的具体内存偏移。</p>
<hr>
<h3 id="mask--offsets--n_elements"><code>mask = offsets &lt; n_elements</code><a href="#mask--offsets--n_elements" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>Mask的含义是“掩码”。简单来说，这里offsets是一个向量，而n_elements则是一个数字。根据torch、triton、numpy等数据科学工具常见的神奇的<strong>广播</strong>机制，n_elements被直接复制了若干个而组成了一个和offsets大小一致的向量，最后mask得到的也是一个向量，但是内容是offsets中对应元素与n_elements比较结果的布尔值。</p>
<p>比如，假如<code>offsets = [1,2,3]</code>，<code>n_elements = 3</code>，那么最后<code>mask</code>就得到<code>[True,True,False]</code>。</p>
<p>通过这种方式，我们可以确保核心工作不越界。比如，假如你的向量有1000个数据要处理，但是你设置的BLOCK_SIZE大小却是128，1000除不尽128，那么最后一个块就只会计算掩码中为true的部分，保证不去越界计算向量外的内存。</p>
<hr>
<h3 id="x--tlloadx_ptr--offsets-maskmask"><code>x = tl.load(x_ptr + offsets, mask=mask)</code><a href="#x--tlloadx_ptr--offsets-maskmask" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>x_ptr为第一个向量的起始地址，offsets为偏移量向量。显然，这里也通过广播机制得到了一个向量，而这个向量信息的含义就是核心要读取的信息在内存中的绝对地址。<code>mask = mask</code>通过关键字传值的方式将我们前面计算过的掩码传入load函数的mask参数。最后返回得到的x即为符合mask掩码约束的x_ptr+offsets部分的内存对应的信息组成的新向量。mask为false的部分信息被自动填充为0.0。</p>
<hr>
<h2 id="这段代码做了什么">这段代码做了什么？<a href="#%e8%bf%99%e6%ae%b5%e4%bb%a3%e7%a0%81%e5%81%9a%e4%ba%86%e4%bb%80%e4%b9%88" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>定义了一个函数，它会在运行时直接转换为二进制机器码。它提供了若干参数，分别允许你去控制输入的两个向量的起始地址，输出向量的地址，向量的大小，以及过程中的BLOCK_SIZE。</p>
<p>调用这个函数，程序就会在你指定的内存地址分别读取向量大小个数的数据，并分别相加，最后存入输出向量的地址。只不过，这些操作是通过npu而非cpu完成的。</p>
<hr>
<h1 id="torch-add">torch add<a href="#torch-add" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>创建一个辅助函数用于：</p>
<ul>
<li>生成 z 张量；</li>
<li>用适当的 grid/block sizes 将上述内核加入队列。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(x: torch<span style="color:#f92672">.</span>Tensor, y: torch<span style="color:#f92672">.</span>Tensor):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 需要预分配输出。</span>
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>empty_like(x)
</span></span><span style="display:flex;"><span>    n_elements <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>numel()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 启动网格表示并行运行的内核实例的数量。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 可以是 Tuple[int]，也可以是 Callable(metaparameters) -&gt; Tuple[int]。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 在本case中，使用 1D 网格，其中大小是块的数量：</span>
</span></span><span style="display:flex;"><span>    grid <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> meta: (triton<span style="color:#f92672">.</span>cdiv(n_elements, meta[<span style="color:#e6db74">&#39;BLOCK_SIZE&#39;</span>]), )
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># NOTE:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  - 每个 torch.tensor 对象都会隐式转换为其第一个元素的指针。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  - `triton.jit` 函数可以通过启动网格索引来获得可调用的 NPU 内核。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#  - 不要忘记以keywords的方式传递meta-parameters。</span>
</span></span><span style="display:flex;"><span>    add_kernel[grid](x, y, output, n_elements, BLOCK_SIZE<span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 返回 z 的句柄。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> output
</span></span></code></pre></div><h2 id="这段代码又是干什么的">这段代码又是干什么的？<a href="#%e8%bf%99%e6%ae%b5%e4%bb%a3%e7%a0%81%e5%8f%88%e6%98%af%e5%b9%b2%e4%bb%80%e4%b9%88%e7%9a%84" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>这是一个<strong>宿主端</strong>的代码。简单来说，torch开发者需要能进行并行计算来实现业务逻辑，但是他们并不想去关心你底层实现的逻辑。因此，作为triton开发者，你需要做的是把这个功能封装为一个极其简单易用同时兼顾安全性的函数，供客户随时调用。</p>
<p>我们来逐行分析这段代码：</p>
<hr>
<h3 id="output--torchempty_likex"><code>output = torch.empty_like(x)</code><a href="#output--torchempty_likex" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>调用torch库，在npu显存上为output挖了一个和x一样大小的坑，让output存入这个坑的地址。</p>
<p>如果你不挖这个坑，你前面写的add_kernel就不知道该把运算结果存到哪个位置，而python函数通常要返回运算值而非算完之后随便扔在某个地方。</p>
<hr>
<h3 id="n_elements--outputnumel"><code>n_elements = output.numel()</code><a href="#n_elements--outputnumel" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>让<code>n_elements</code>存入<code>output</code>的大小。</p>
<hr>
<h3 id="grid--lambda-meta-tritoncdivn_elements-metablock_size-"><code>grid = lambda meta: (triton.cdiv(n_elements, meta['BLOCK_SIZE']), )</code><a href="#grid--lambda-meta-tritoncdivn_elements-metablock_size-" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>这行代码是这个函数中相对复杂的一段。它的作用是<strong>动态决定需要启动的程序数</strong>。</p>
<p><code>grid</code>的类型是一个lambda函数，在后文中，它被通过一种邪门的写法传入了add_kernel中。你可能注意到了，grid并非写入圆括号当中，而是写在方括号中。我们后文中会提及这种写法的意义。总之，这是一种一般python程序中不会涉及到的写法。</p>
<p><code>triton.cdiv</code>是<strong>ceiling division</strong>的缩写，即向上取整。</p>
<p>这个时候，你可能就会有疑问：meta是个什么东西？你先别急，我们先看后面一句代码。</p>
<hr>
<h3 id="add_kernelgridx-y-output-n_elements-block_size1024"><code>add_kernel[grid](x, y, output, n_elements, BLOCK_SIZE=1024)</code><a href="#add_kernelgridx-y-output-n_elements-block_size1024" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>这段代码即调用了我们前文写的add_kernel函数。</p>
<p>在这个lambda函数中，meta的类型是一个字典。在你发射kernel时，它里面装的就是你所传递的<strong>元参数</strong>。在我们写的add函数中，x、y均为Torch中的Tensor数据类型，传参时会隐式转换为内存地址。而output在我们前文中也已经提前挖好坑了。</p>
<p>但这里，我们通过了一些邪门的方法额外传入了一个grid函数。下面我就来解释一下这种写法的含义。</p>
<h4 id="meta"><code>meta</code><a href="#meta" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>triton的开发者预料到了你需要有办法去根据特殊情景决定启动的程序数量，所以他们提供了一种方式让你可以获取客户在使用你封装好的函数时的传参情况。</p>
<p>什么方式呢？在你使用<code>@triton.jit</code>装饰好的函数时，triton会捕捉到你传入的参数，构成一个<strong>字典</strong>。比如，在我们上文写出的add_kernel函数中，这个字典大概长成这样：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>meta <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;x_ptr&#34;</span> : <span style="color:#f92672">&lt;</span>address<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;y_ptr&#34;</span> : <span style="color:#f92672">&lt;</span>address<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;output_ptr&#34;</span> : <span style="color:#f92672">&lt;</span>address<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;n_elements&#34;</span> : <span style="color:#f92672">&lt;</span>numble<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#34;BLOCK_SIZE&#34;</span> : <span style="color:#f92672">&lt;</span>numble<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>系统在进行运算之前，会先生成这个字典，然后暗中调用一个lambda函数，将这个字典作为参数传入，根据得到的结果进而决定最后启动的程序个数。</p>
<p>你通常没办法直接调用这个字典，不过幸运的是，你可以去决定系统暗中调用的lambda函数的形式，而这个lambda函数传入的参数正是triton生成的参数字典。</p>
<p>因此，我们在前面定义lambda函数grid为<code>lambda meta: (triton.cdiv(n_elements, meta['BLOCK_SIZE']), )</code>，意义就是在add_kernel生效之前读取传入的参数字典，根据参数字典中BLOCK_SIZE的值计算出需要的最少启动程序数，然后系统通过这个返回值最终决定启动的程序数。</p>
<hr>
<h3 id="return-output"><code>return output</code><a href="#return-output" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>返回<code>output</code>这个生成的tensor。</p>
<hr>
<p>使用上述函数计算两个 <code>torch.tensor</code> 对象的 element-wise sum，并测试其正确性：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Python" data-lang="Python"><span style="display:flex;"><span>torch<span style="color:#f92672">.</span>manual_seed(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>size <span style="color:#f92672">=</span> <span style="color:#ae81ff">98432</span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>rand(size, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu&#39;</span>)
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>rand(size, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu&#39;</span>)
</span></span><span style="display:flex;"><span>output_torch <span style="color:#f92672">=</span> x <span style="color:#f92672">+</span> y
</span></span><span style="display:flex;"><span>output_triton <span style="color:#f92672">=</span> add(x, y)
</span></span><span style="display:flex;"><span>print(output_torch)
</span></span><span style="display:flex;"><span>print(output_triton)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;The maximum difference between torch and triton is &#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>torch<span style="color:#f92672">.</span>max(torch<span style="color:#f92672">.</span>abs(output_torch <span style="color:#f92672">-</span> output_triton))<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span></code></pre></div><p>这是一段测试代码。x、y分别是使用torch生成的随机向量。<code>output_torch</code>为直接使用torch内置方法计算得到的向量和，<code>output_triton</code>为使用我们自定义函数计算得到的向量和，最后打印两者的最大残差。</p>
<p>理论上来说，如果程序正确，<code>output_torch</code>和<code>output_triton</code>应该输出完全一致。</p>
<p>Out:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tensor<span style="color:#f92672">([</span>0.8329, 1.0024, 1.3639,  ..., 1.0796, 1.0406, 1.5811<span style="color:#f92672">]</span>, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu:0&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>tensor<span style="color:#f92672">([</span>0.8329, 1.0024, 1.3639,  ..., 1.0796, 1.0406, 1.5811<span style="color:#f92672">]</span>, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;npu:0&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>The maximum difference between torch and triton is 0.0
</span></span></code></pre></div><p>&ldquo;The maximum difference between torch and triton is 0.0&rdquo; 表示Triton和PyTorch的输出结果一致。</p>
<p>但是，如果你真正去衡量torch方法与triton方法之间的计算速度，你会发现triton方法算出来的速度基本与torch方法持平，甚至更慢一点。原因很简单，torch经过了长期的优化，这种基础算子的计算速度基本已经达到了物理极限，而我们自己写的triton算法在调用npu显存数据上要花费额外的时间。</p>
<p>triton算子真正的优势区间在于写“融合算子”。同样的操作，pytorch的每一步操作都要单独去显存拉取一次数据，操作多起来之后这一步拉取操作就会显著影响运行速度。而通过写triton算子直接操作显存，一次拉取数据之后直接计算得到结果，这样就可以规避中间不必要的额外拉取用时。</p>
<hr>
<h1 id="如何测试运行速度">如何测试运行速度？<a href="#%e5%a6%82%e4%bd%95%e6%b5%8b%e8%af%95%e8%bf%90%e8%a1%8c%e9%80%9f%e5%ba%a6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h1>
<p>因为异步运算的缘故，torch和time模块这样基于CPU的计时方法无法测量NPU中的真正用时。我们需要使用triton提供的专业基本测试工具<code>triton.testing.do_bench</code>来测试计算效率。</p>
<p>在下列实例代码中，我们采用带宽吞吐量为依据衡量torch和triton的运行速度差异。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 强制使用 &#39;Agg&#39; 后端，这个后端专门用于不弹窗直接生成图片文件</span>
</span></span><span style="display:flex;"><span>matplotlib<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#34;Agg&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> torch_npu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> triton.language <span style="color:#66d9ef">as</span> tl
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@triton.jit</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_kernel</span>(
</span></span><span style="display:flex;"><span>    x_ptr,  <span style="color:#75715e"># 指向第一个输入向量的指针。</span>
</span></span><span style="display:flex;"><span>    y_ptr,  <span style="color:#75715e"># 指向第二个输入向量的指针。</span>
</span></span><span style="display:flex;"><span>    output_ptr,  <span style="color:#75715e"># 指向输出向量的指针。</span>
</span></span><span style="display:flex;"><span>    n_elements,  <span style="color:#75715e"># 向量的大小。</span>
</span></span><span style="display:flex;"><span>    BLOCK_SIZE: tl<span style="color:#f92672">.</span>constexpr,  <span style="color:#75715e"># 每个程序应处理的元素数量。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 注意：`constexpr` 将标记变量为常量。</span>
</span></span><span style="display:flex;"><span>):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 不同的数据由不同的“process”来处理，因此需要分配：</span>
</span></span><span style="display:flex;"><span>    pid <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>program_id(axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)  <span style="color:#75715e"># 使用 1D 启动网格，因此轴为 0。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 该程序将处理相对初始数据偏移的输入。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 例如，如果有一个长度为 256, 块大小为 64 的向量，程序将各自访问 [0:64, 64:128, 128:192, 192:256] 的元素。</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 注意 offsets 是指针列表：</span>
</span></span><span style="display:flex;"><span>    block_start <span style="color:#f92672">=</span> pid <span style="color:#f92672">*</span> BLOCK_SIZE
</span></span><span style="display:flex;"><span>    offsets <span style="color:#f92672">=</span> block_start <span style="color:#f92672">+</span> tl<span style="color:#f92672">.</span>arange(<span style="color:#ae81ff">0</span>, BLOCK_SIZE)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 创建掩码以防止内存操作超出边界访问。</span>
</span></span><span style="display:flex;"><span>    mask <span style="color:#f92672">=</span> offsets <span style="color:#f92672">&lt;</span> n_elements
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 从 DRAM 加载 x 和 y，如果输入不是块大小的整数倍，则屏蔽掉任何多余的元素。</span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(x_ptr <span style="color:#f92672">+</span> offsets, mask<span style="color:#f92672">=</span>mask)
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> tl<span style="color:#f92672">.</span>load(y_ptr <span style="color:#f92672">+</span> offsets, mask<span style="color:#f92672">=</span>mask)
</span></span><span style="display:flex;"><span>    output <span style="color:#f92672">=</span> x <span style="color:#f92672">+</span> y
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 将 x + y 写回 DRAM。</span>
</span></span><span style="display:flex;"><span>    tl<span style="color:#f92672">.</span>store(output_ptr <span style="color:#f92672">+</span> offsets, output, mask<span style="color:#f92672">=</span>mask)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@triton.testing.perf_report</span>(
</span></span><span style="display:flex;"><span>    triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>Benchmark(
</span></span><span style="display:flex;"><span>        x_names<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;size&#34;</span>],  <span style="color:#75715e"># 作为x轴变化的参数</span>
</span></span><span style="display:flex;"><span>        x_vals<span style="color:#f92672">=</span>[<span style="color:#ae81ff">128</span> <span style="color:#f92672">*</span> i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">100</span>)],  <span style="color:#75715e"># 测试从 256 到 12800 的不同大小</span>
</span></span><span style="display:flex;"><span>        line_arg<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;provider&#34;</span>,
</span></span><span style="display:flex;"><span>        line_vals<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;triton&#34;</span>, <span style="color:#e6db74">&#34;torch&#34;</span>],  <span style="color:#75715e"># 对比这两家</span>
</span></span><span style="display:flex;"><span>        line_names<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;Triton&#34;</span>, <span style="color:#e6db74">&#34;Torch&#34;</span>],
</span></span><span style="display:flex;"><span>        styles<span style="color:#f92672">=</span>[(<span style="color:#e6db74">&#34;blue&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>), (<span style="color:#e6db74">&#34;green&#34;</span>, <span style="color:#e6db74">&#34;-&#34;</span>)],
</span></span><span style="display:flex;"><span>        ylabel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;GB/s&#34;</span>,  <span style="color:#75715e"># 用带宽吞吐量作为指标</span>
</span></span><span style="display:flex;"><span>        plot_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;vector-add-performance&#34;</span>,
</span></span><span style="display:flex;"><span>        args<span style="color:#f92672">=</span>{},
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">benchmark</span>(size, provider):
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>rand(size, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;npu&#34;</span>, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float32)
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>rand(size, device<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;npu&#34;</span>, dtype<span style="color:#f92672">=</span>torch<span style="color:#f92672">.</span>float32)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 预热显存分配</span>
</span></span><span style="display:flex;"><span>    quantiles <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0.5</span>, <span style="color:#ae81ff">0.2</span>, <span style="color:#ae81ff">0.8</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> provider <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;torch&#34;</span>:
</span></span><span style="display:flex;"><span>        ms, min_ms, max_ms <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>do_bench(<span style="color:#66d9ef">lambda</span>: x <span style="color:#f92672">+</span> y, quantiles<span style="color:#f92672">=</span>quantiles)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> provider <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;triton&#34;</span>:
</span></span><span style="display:flex;"><span>        output <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>empty_like(x)
</span></span><span style="display:flex;"><span>        grid <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> meta: (triton<span style="color:#f92672">.</span>cdiv(size, meta[<span style="color:#e6db74">&#34;BLOCK_SIZE&#34;</span>]),)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 封装一下 lambda 方便测速</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">call_triton</span>():
</span></span><span style="display:flex;"><span>            add_kernel[grid](x, y, output, size, BLOCK_SIZE<span style="color:#f92672">=</span><span style="color:#ae81ff">1024</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ms, min_ms, max_ms <span style="color:#f92672">=</span> triton<span style="color:#f92672">.</span>testing<span style="color:#f92672">.</span>do_bench(call_triton, quantiles<span style="color:#f92672">=</span>quantiles)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 返回吞吐量计算 GB/s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">gbps</span>(ms):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 读x(4 bytes) + 读y(4 bytes) + 写output(4 bytes) = 12 bytes</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">*</span> size <span style="color:#f92672">/</span> ms <span style="color:#f92672">*</span> <span style="color:#ae81ff">1e-6</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> gbps(ms), gbps(max_ms), gbps(min_ms)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 运行 benchmark</span>
</span></span><span style="display:flex;"><span>benchmark<span style="color:#f92672">.</span>run(print_data<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, show_plots<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>, save_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;./bench_result&#34;</span>)
</span></span></code></pre></div><p>在使用这个测试工具之前，你需要先确保安装了<code>matplotlib</code>、<code>pandas</code>、<code>numpy</code>等基本数据科学库。最后你可以得到由matplotlib生成的性能测试图表。</p>
<p>在本代码中，实际进行加法计算的用时非常少，大部分的用时都在信息搬运上，而带宽正描述的是这一行为的速率。通过运行这段代码，我们就成功得到了torch原生写法与我们自己写的triton算子之间的性能差异图表。</p>
<p><img src="/zh-cn/posts/triton%E8%87%AA%E5%AD%A6%E6%97%A5%E5%BF%97-01vectoradd/%E6%80%A7%E8%83%BD%E5%AF%B9%E6%AF%942025120901.jpg" alt=""></p>
]]></content>
		</item>
		
		<item>
			<title>NeovimPlugins配置方法</title>
			<link>http://localhost:1313/zh-cn/posts/neovimplugins%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95/</link>
			<pubDate>Sun, 23 Nov 2025 11:11:53 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/neovimplugins%E9%85%8D%E7%BD%AE%E6%96%B9%E6%B3%95/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>我的上一篇博客中，我们探讨了如何配置nvim。但是仅仅是修改了键位和vim行为远远不足以让我们的nvim可以承担代码任务。我们需要插件来拓展nvim的功能。插件是nvim的灵魂，有了插件，你的nvim才能作为一个功能完备的ide来使用。(后记：真正使用时你应该去使用lazyvim，并通过lazyvim的lazyextra功能配置lsp和相关的调试功能。如果你有生活，不要尝试自己配置lsp，尤其是如果你想写java之类的面向大型工程设计的语言。)</p>
<h3 id="插件的分类">插件的分类<a href="#%e6%8f%92%e4%bb%b6%e7%9a%84%e5%88%86%e7%b1%bb" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>nvim的插件大致有以下几类:</p>
<ul>
<li>基础辅助。拓展vim的行为。</li>
<li>git集成</li>
<li>外观主题</li>
<li>代码智能
<ul>
<li>自动补全</li>
<li>语法高亮</li>
<li>语法诊断</li>
<li>调试与运行</li>
<li>代码格式化</li>
</ul>
</li>
<li>模糊搜索</li>
</ul>
<p>至少在kickstart中出现的插件可以大致归类为以上内容。</p>
<h3 id="插件管理器">插件管理器<a href="#%e6%8f%92%e4%bb%b6%e7%ae%a1%e7%90%86%e5%99%a8" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>光有插件是远远不够的，我们需要一个组件来专门管理插件，决定插件何时运行。通常而言，我们选择使用lazy.nvim插件管理器，它最大的特点就是“懒加载”，只在需要的时候加载插件功能，这极大地提高了载入速度。</p>
<p>让我们看到init.lua中关于下载lazy.nvim插件管理器的部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- [[ Install `lazy.nvim` plugin manager ]]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--    See `:help lazy.nvim.txt` or https://github.com/folke/lazy.nvim for more info</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> lazypath <span style="color:#f92672">=</span> vim.fn.stdpath <span style="color:#e6db74">&#39;data&#39;</span> <span style="color:#f92672">..</span> <span style="color:#e6db74">&#39;/lazy/lazy.nvim&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> (vim.uv <span style="color:#f92672">or</span> vim.loop).fs_stat(lazypath) <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">local</span> lazyrepo <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://github.com/folke/lazy.nvim.git&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">local</span> out <span style="color:#f92672">=</span> vim.fn.system { <span style="color:#e6db74">&#39;git&#39;</span>, <span style="color:#e6db74">&#39;clone&#39;</span>, <span style="color:#e6db74">&#39;--filter=blob:none&#39;</span>, <span style="color:#e6db74">&#39;--branch=stable&#39;</span>, lazyrepo, lazypath }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> vim.v.shell_error <span style="color:#f92672">~=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>    error(<span style="color:#e6db74">&#39;Error cloning lazy.nvim:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">..</span> out)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">---@type vim.Option</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> rtp <span style="color:#f92672">=</span> vim.opt.rtp
</span></span><span style="display:flex;"><span>rtp:prepend(lazypath)
</span></span></code></pre></div><p>这段代码的含义，简单来说就是：</p>
<ul>
<li>创建一个lazypath作为这个插件管理器的老家
<ul>
<li>在linux系统中，通常就是<code>~/.local/share/nvim/lazy/lazy.nvim</code></li>
</ul>
</li>
<li>将lazy.nvim在github上的仓库克隆到lazypath</li>
<li>其余部分的代码基本是出于兼容性而写的（但是并非无用，这段代码的健壮性还是非常强的，能让你在绝大多数情况下都能至少保证lazy.nvim安装成功）</li>
</ul>
<p>这段代码基本唯一有价值的东西就是告诉你lazypath的老家在哪，实在有问题可能会要去检查那里的文件。但是通常而言用不到。而且你大概率也不会自己写这段代码，所以多数情况下忽视即可。</p>
<h3 id="插件">插件<a href="#%e6%8f%92%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>require(<span style="color:#e6db74">&#39;lazy&#39;</span>).setup({
</span></span></code></pre></div><p>从接下来开始就到了重头戏了，nvim的插件管理。</p>
<p>在我们kickstart nvim这个配置模版中，大几百行的代码都塞在了<code>require('lazy').setup({</code>这个巨大括号里。</p>
<p><code>require('lazy').setup()</code>接受的是两个参数，其中第一个参数就是一个巨大的lua table，里面放的是插件的“说明书”，第二个参数则是可选的，用来定制lazy.nvim自身的外观和行为。我们主要关注第一部分，即插件的“说明书”到底怎么写。</p>
<h4 id="插件说明书-plugin-specification">插件说明书 (Plugin Specification)<a href="#%e6%8f%92%e4%bb%b6%e8%af%b4%e6%98%8e%e4%b9%a6-plugin-specification" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>所谓的插件说明书，就是setup()中第一个参数table中的元素。每一个说明书就代表了一个插件。</p>
<p>一个插件说明书的职能大概有：</p>
<ul>
<li>让lazy.nvim去下载需要的插件</li>
<li>传递配置选项给插件</li>
<li>加载触发器来实现自动功能</li>
<li>设置自定义函数来配置插件（比如设置快捷键）</li>
<li>声明依赖项</li>
<li>设置加载条件</li>
<li>设置打开特定文件时加载插件</li>
<li>导入其他文件中的插件配置</li>
</ul>
<p>好吧，光看这些职能是没有用的，我们来以init.lua中提供的插件说明书来详细讲解。</p>
<h4 id="最简形式">最简形式<a href="#%e6%9c%80%e7%ae%80%e5%bd%a2%e5%bc%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;NMAC427/guess-indent.nvim&#39;</span>, <span style="color:#75715e">-- Detect tabstop and shiftwidth automatically</span>
</span></span></code></pre></div><p>没错，一个字符串就足够作为一个插件了。记得后面要加逗号。</p>
<p>这段代码的含义就是，到github上找到<code>NMAC427</code>这个用户的<code>guess-indent.nvim</code>这个仓库并下载下来，什么都不配置，直接用默认配置即可。这是最省事的写法。</p>
<p>但是多数时候，你为了更方便的使用插件，不得不进行一些相应的配置。这个时候，我们就要用到更加复杂的配置方式。</p>
<h4 id="常见形式">常见形式<a href="#%e5%b8%b8%e8%a7%81%e5%bd%a2%e5%bc%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>  <span style="color:#75715e">-- Use `opts = {}` to automatically pass options to a plugin&#39;s `setup()` function, forcing the plugin to be loaded.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">-- Alternatively, use `config = function() ... end` for full control over the configuration.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">-- If you prefer to call `setup` explicitly, use:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--    {</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--        &#39;lewis6991/gitsigns.nvim&#39;,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--        config = function()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--            require(&#39;gitsigns&#39;).setup({</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--                -- Your gitsigns configuration here</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--            })</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--        end,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--    }</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">-- Here is a more advanced example where we pass configuration</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">-- options to `gitsigns.nvim`.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">-- See `:help gitsigns` to understand what the configuration keys do</span>
</span></span><span style="display:flex;"><span>  { <span style="color:#75715e">-- Adds git related signs to the gutter, as well as utilities for managing changes</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;lewis6991/gitsigns.nvim&#39;</span>,
</span></span><span style="display:flex;"><span>    opts <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      signs <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        add <span style="color:#f92672">=</span> { text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;+&#39;</span> },
</span></span><span style="display:flex;"><span>        change <span style="color:#f92672">=</span> { text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;~&#39;</span> },
</span></span><span style="display:flex;"><span>        delete <span style="color:#f92672">=</span> { text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;_&#39;</span> },
</span></span><span style="display:flex;"><span>        topdelete <span style="color:#f92672">=</span> { text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;‾&#39;</span> },
</span></span><span style="display:flex;"><span>        changedelete <span style="color:#f92672">=</span> { text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;~&#39;</span> },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  },
</span></span></code></pre></div><p>这是一个git图标插件，功能是在侧边栏显示当前文本中的改动增减。但是我们想要自定义显示的图标，那么我们就必须进行配置。</p>
<p>配置的方式如上，简单来说就是将插件说明书写成一个table。lua中table是唯一的组合数据结构，功能类似于js的对象，既能当哈希表或字典，又能当列表，还能作为类。如果想要写好lua程序，你将不得不直面这种身兼数职的境况。</p>
<p>在以上这段代码中，配置gitsigns时我们使用了<code>opts</code>这个配置键。这是最简洁的配置键，配置的选项又插件作者提供，插件加载完成后会自动调用你给出的配置。</p>
<p>其他的插件配置键我们暂且不谈，我们不妨先由一个简单而效果显著的插件配置出发，来自己手动完成一个配置：配色方案。</p>
<h3 id="配色方案配置">配色方案配置<a href="#%e9%85%8d%e8%89%b2%e6%96%b9%e6%a1%88%e9%85%8d%e7%bd%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>  { <span style="color:#75715e">-- You can easily change to a different colorscheme.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- Change the name of the colorscheme plugin below, and then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- change the command in the config to whatever the name of that colorscheme is.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- If you want to see what colorschemes are already installed, you can use `:Telescope colorscheme`.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;folke/tokyonight.nvim&#39;</span>,
</span></span><span style="display:flex;"><span>    priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>, <span style="color:#75715e">-- Make sure to load this before all the other start plugins.</span>
</span></span><span style="display:flex;"><span>    config <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">---@diagnostic disable-next-line: missing-fields</span>
</span></span><span style="display:flex;"><span>      require(<span style="color:#e6db74">&#39;tokyonight&#39;</span>).setup {
</span></span><span style="display:flex;"><span>        styles <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          comments <span style="color:#f92672">=</span> { italic <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span> }, <span style="color:#75715e">-- Disable italics in comments</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- Load the colorscheme here.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- Like many other themes, this one has different styles, and you could load</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- any other, such as &#39;tokyonight-storm&#39;, &#39;tokyonight-moon&#39;, or &#39;tokyonight-day&#39;.</span>
</span></span><span style="display:flex;"><span>      vim.cmd.colorscheme <span style="color:#e6db74">&#39;tokyonight-night&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>  },
</span></span></code></pre></div><p>在kickstart配置模版中，默认的配色方案长成这样。它下载的是tokyonight，一个我个人不是很喜欢的配色方案。所以我一定要把它改掉。</p>
<p>我们先来分析一下这段代码的组成：</p>
<ul>
<li><code>'folke/tokyonight.nvim',</code>作者+插件名，一个插件的最简形式。</li>
<li><code>priority = 1000,</code>设置优先级。颜色主题需要较高的优先级，这样才能保证在你看到任何界面元素之前，颜色主题已经加载完毕，使视觉体验更平滑。</li>
<li><code>require('tokyonight').setup</code>调用插件提供的标准配置函数</li>
<li><code>comments = { italic = false }</code>禁用注释斜体，这个功能在某些平台上表现不佳（比如我的termux）</li>
<li><code>vim.cmd.colorscheme 'tokyonight-night'</code>在完成前面的setup步骤后，让nvim真正开始加载这个颜色主题。</li>
</ul>
<p>那么我们现在就来修改这段代码，来改成我更喜欢的onedarkpro主题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;olimorris/onedarkpro.nvim&#39;</span>,
</span></span><span style="display:flex;"><span>    priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>    config <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span>      require(<span style="color:#e6db74">&#39;onedarkpro&#39;</span>).setup {
</span></span><span style="display:flex;"><span>        highlights <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          Comment <span style="color:#f92672">=</span> { italic <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span> },
</span></span><span style="display:flex;"><span>          Directory <span style="color:#f92672">=</span> { bold <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span> },
</span></span><span style="display:flex;"><span>          ErrorMsg <span style="color:#f92672">=</span> { italic <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>, bold <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span> },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      vim.cmd <span style="color:#e6db74">&#39;colorscheme onedark&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>  },
</span></span></code></pre></div><p>ok，当我保存退出再进入后，我就喜提新颜色主题了。</p>
<p>简单来说，这部分内容难点就在于：如果你不去深入了解配置文件的组成结构，你可能根本不知道github上给出的配置代码到底该放在哪。现在我们知道了，只需要把github上给出的配置代码塞进一个table里，再塞到<code>require('lazy').setup({</code>里即可。</p>
<p>颜色方案配置比较简单，因为它不涉及任何按键的设置。接下来我们来为我们的nvim添加一个“浮动终端”，就想一般的图形化界面ide那样在界面的中央弹出一个终端窗口，而非使用nvim原生的类似分屏的终端。</p>
<p>但是在开始之前，我们先进行一些准备工作：我们实际上应该把这些插件说明书分门别类的放在<code>lua/custom/plugins</code>目录下，而不是全部扁平化的放在init.lua中。让我们先把颜色方案的代码移动过去。</p>
<p>首先，我们看到<code>init.lua</code>中插件说明书的最后部分：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>  <span style="color:#75715e">-- note: the import below can automatically add your own plugins, configuration, etc from `lua/custom/plugins/*.lua`</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--    this is the easiest way to modularize your config.</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">--  uncomment the following line and add your plugins to `lua/custom/plugins/*.lua` to get going.</span>
</span></span><span style="display:flex;"><span>  { import <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;custom.plugins&#39;</span> },
</span></span></code></pre></div><p>这一部分中，<code>\{ import = 'custom.plugins' },</code>原本是注释起来的，将前面的注释符号删除，这样lazy.nvim就会自动去在custom/plugins目录下寻找插件说明书。</p>
<p>接着，输入以下指令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nvim lua/custom/plugins/colorscheme.lua
</span></span></code></pre></div><p>这样我们就创建了一个专门存放配色方案的lua模块。将原本我们写在init.lua中的代码移植过来，并用<code>return{}</code>包裹，得到：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">--colorscheme.lua</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;olimorris/onedarkpro.nvim&#39;</span>,
</span></span><span style="display:flex;"><span>    priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>,
</span></span><span style="display:flex;"><span>    config <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span>      require(<span style="color:#e6db74">&#39;onedarkpro&#39;</span>).setup {
</span></span><span style="display:flex;"><span>        highlights <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          Comment <span style="color:#f92672">=</span> { italic <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span> },
</span></span><span style="display:flex;"><span>          Directory <span style="color:#f92672">=</span> { bold <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span> },
</span></span><span style="display:flex;"><span>          ErrorMsg <span style="color:#f92672">=</span> { italic <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>, bold <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span> },
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      vim.cmd <span style="color:#e6db74">&#39;colorscheme onedark&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>此时，重新打开nvim，配色方案应该依然工作正常。这就意味着你成功构建了一个插件说明书。</p>
<h4 id="浮动终端">浮动终端<a href="#%e6%b5%ae%e5%8a%a8%e7%bb%88%e7%ab%af" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>浮动终端的常用插件是<code>toggleterm.nvim</code>，简称toggle。</p>
<p>让我们先在plugins下创建一个专属于toggle的lua模块：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nvim lua/custom/plugins/toggleterm.lua
</span></span></code></pre></div><p>然后，让我写入插件的配置代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;akinsho/toggleterm.nvim&#39;</span>,
</span></span><span style="display:flex;"><span>  version <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;*&#39;</span>,
</span></span><span style="display:flex;"><span>  config <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span>    require(<span style="color:#e6db74">&#39;toggleterm&#39;</span>).setup {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 设置终端窗口大小</span>
</span></span><span style="display:flex;"><span>      size <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>(term)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> term.direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;horizontal&#39;</span> <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elseif</span> term.direction <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;vertical&#39;</span> <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> vim.o.columns <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 打开终端的快捷键，这里设置为 Ctrl + \</span>
</span></span><span style="display:flex;"><span>      open_mapping <span style="color:#f92672">=</span> <span style="color:#e6db74">[[&lt;c-\&gt;]]</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 隐藏 toggleterm buffer 中的行号</span>
</span></span><span style="display:flex;"><span>      hide_numbers <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 当 Neovim 目录切换时，终端下次打开也会切换到相应目录</span>
</span></span><span style="display:flex;"><span>      autochdir <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 设置终端窗口的背景色，可以根据你的主题进行调整</span>
</span></span><span style="display:flex;"><span>      highlights <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        Normal <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          guibg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;none&#39;</span>, <span style="color:#75715e">-- 这里设置为 &#34;none&#34; 表示使用默认背景</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        NormalFloat <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          link <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Normal&#39;</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 阴影效果，如果设置了上面的 highlights 中的 Normal，建议将此项设为 false</span>
</span></span><span style="display:flex;"><span>      shade_terminals <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 阴影的强度，数值越小越深</span>
</span></span><span style="display:flex;"><span>      shading_factor <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">30</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 启动时进入插入模式</span>
</span></span><span style="display:flex;"><span>      start_in_insert <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 在插入模式下也可以使用 open_mapping 打开终端</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- insert_mappings = true,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 在终端窗口中也可以使用 open_mapping (会覆盖一些终端默认行为)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- terminal_mappings = true,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 保持上次终端的大小</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- persist_size = true,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 终端进程退出时自动关闭窗口</span>
</span></span><span style="display:flex;"><span>      direction <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;float&#39;</span>, <span style="color:#75715e">-- 设置默认打开方式为浮动窗口</span>
</span></span><span style="display:flex;"><span>      close_on_exit <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 使用 Neovim 的默认 shell</span>
</span></span><span style="display:flex;"><span>      shell <span style="color:#f92672">=</span> vim.o.shell,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 自动滚动到底部</span>
</span></span><span style="display:flex;"><span>      auto_scroll <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">-- 浮动窗口的设置</span>
</span></span><span style="display:flex;"><span>      float_opts <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">-- 边框样式</span>
</span></span><span style="display:flex;"><span>        border <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;curved&#39;</span>, <span style="color:#75715e">-- 使用圆角边框</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">-- 窗口透明度</span>
</span></span><span style="display:flex;"><span>        winblend <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- 设置一个函数，用于在 normal 模式下按下 &lt;esc&gt; 时退出终端</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_G</span>.<span style="color:#a6e22e">set_terminal_keymaps</span>()
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">local</span> opts <span style="color:#f92672">=</span> { buffer <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> }
</span></span><span style="display:flex;"><span>      vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;&lt;esc&gt;&#39;</span>, <span style="color:#e6db74">[[&lt;C-\&gt;&lt;C-n&gt;]]</span>, opts)
</span></span><span style="display:flex;"><span>      vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;jk&#39;</span>, <span style="color:#e6db74">[[&lt;C-\&gt;&lt;C-n&gt;]]</span>, opts) <span style="color:#75715e">-- jk 也可以退出</span>
</span></span><span style="display:flex;"><span>      vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-h&gt;&#39;</span>, <span style="color:#e6db74">[[&lt;Cmd&gt;wincmd h&lt;CR&gt;]]</span>, opts)
</span></span><span style="display:flex;"><span>      vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-j&gt;&#39;</span>, <span style="color:#e6db74">[[&lt;Cmd&gt;wincmd j&lt;CR&gt;]]</span>, opts)
</span></span><span style="display:flex;"><span>      vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-k&gt;&#39;</span>, <span style="color:#e6db74">[[&lt;Cmd&gt;wincmd k&lt;CR&gt;]]</span>, opts)
</span></span><span style="display:flex;"><span>      vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-l&gt;&#39;</span>, <span style="color:#e6db74">[[&lt;Cmd&gt;wincmd l&lt;CR&gt;]]</span>, opts)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- 当打开终端时，自动应用上面的快捷键设置</span>
</span></span><span style="display:flex;"><span>    vim.cmd(<span style="color:#e6db74">&#39;autocmd! TermOpen term://* lua set_terminal_keymaps()&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- 定义一个快捷键，方便地打开一个 LazyGit 终端</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> Terminal <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;toggleterm.terminal&#39;</span>).Terminal
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">local</span> lazygit <span style="color:#f92672">=</span> Terminal:new({
</span></span><span style="display:flex;"><span>      cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lazygit&#34;</span>,
</span></span><span style="display:flex;"><span>      hidden <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      direction <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;float&#34;</span>,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_LAZYGIT_TOGGLE</span>()
</span></span><span style="display:flex;"><span>      lazygit:toggle()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    vim.keymap.set(<span style="color:#e6db74">&#34;n&#34;</span>, <span style="color:#e6db74">&#34;&lt;leader&gt;gg&#34;</span>, <span style="color:#e6db74">&#34;&lt;cmd&gt;lua _LAZYGIT_TOGGLE()&lt;CR&gt;&#34;</span>, {
</span></span><span style="display:flex;"><span>        noremap <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        silent <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Lazygit&#34;</span>,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>,
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在了解了原理之后，和ai交流的难度显著下降了。我得到了一套非常棒的配置，甚至帮我添加了lazygit的界面。效果非常帅。</p>
<p>这时候保存退出，再重进，你就应该可以通过你设置的快捷键来打开toggle终端了。</p>
<hr>
<p>看到这里，你已经可以完全自己上手去解决插件配置问题了。实际上，你基本不需要自己写代码，你只要能读的懂一点代码就行，你只需要把github上插件作者提供的配置样例丢给ai让它生成一个涵盖了大多数功能的配置，再依据自己的需求进行删改即可。</p>
]]></content>
		</item>
		
		<item>
			<title>Neovim配置如何入门</title>
			<link>http://localhost:1313/zh-cn/posts/neovim%E9%85%8D%E7%BD%AE%E5%A6%82%E4%BD%95%E5%85%A5%E9%97%A8/</link>
			<pubDate>Sun, 23 Nov 2025 10:53:11 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/neovim%E9%85%8D%E7%BD%AE%E5%A6%82%E4%BD%95%E5%85%A5%E9%97%A8/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<p>如题。neovim因为自定义程度过高导致学习曲线极其陡峭，虽然功能很强大但是配置过程极其折磨，尤其是当你对于neovim配置的原理毫无概念的时候。</p>
<p>闲言少叙，我尝试来总结一下如何快速入门并配置一个能用的neovim。（后记：在学习完如何配置nvim之后，你实际应该做的是去用lazyvim。lazyvim的lazyextra功能直接优化掉了nvim最反人类的lsp配置过程，如果你有生活，不要尝试自己配置lsp。但是如果你想在使用lazyvim时可以轻松应对各种插件问题，你最好学一下nvim插件配置的通用原理，即我下文中会讲到的。）</p>
<hr>
<h2 id="nvim配置原理">Nvim配置原理<a href="#nvim%e9%85%8d%e7%bd%ae%e5%8e%9f%e7%90%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>neovim是一个文本编辑器，完全可以运行在终端中，无需给它一个桌面环境。你可以按照自己的需求给它添加对特定编程语言的支持，添加语法高亮、自动补全等功能，或者切换颜色主题。它非常轻量，运行飞速，极其贴近代码的原生环境，并且可以运行在任何一台看起来像电脑的机器上。</p>
<p>但是代价是，这一切都必须通过你自己手动配置来完成。Neovim并不是一个开箱即用的软件，即使你使用一些诸如Nvchad或者Lazyvim这样的预配置版本，很多功能还是必须要你自己手动添加。</p>
<p>通常，一个neovim的配置文件目录如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>~/.config/nvim/
</span></span><span style="display:flex;"><span>├── init.lua
</span></span><span style="display:flex;"><span>└── lua/
</span></span><span style="display:flex;"><span>    ├── config/
</span></span><span style="display:flex;"><span>    │   ├── options.lua
</span></span><span style="display:flex;"><span>    │   ├── keymaps.lua
</span></span><span style="display:flex;"><span>    │   └── autocmds.lua
</span></span><span style="display:flex;"><span>    └── plugins/
</span></span><span style="display:flex;"><span>        ├── init.lua       （可选）
</span></span><span style="display:flex;"><span>        ├── lualine.lua
</span></span><span style="display:flex;"><span>        ├── treesitter.lua
</span></span><span style="display:flex;"><span>        └── ……
</span></span></code></pre></div><p>乍一看，你可能会觉得很复杂。其实不然，因为lua目录下的文件实际都是自己想怎么加就怎么加的，真正限定的结构只有根目录下的init.lua和lua这个文件夹。只不过通常而言我们会在lua文件夹下创建这些文件结构，方便我们管理自己加入的插件以及相应配置。</p>
<p>正如你所见，nvim的配置文件全部都使用的是lua语言。但是不用有太高的心理负担，因为这是一个语法甚至比python还要简单的语言。nvim配置过程就相当于构建一个自己的lua语言程序，你需要自己组织其文件结构来让neovim知道如何使用你的配置。</p>
<p>所以显然，在你开始配置nvim之前，你最好能了解一下lua语言的用法。不过也不用着急，你可以接着看，遇到不懂的点再去深入了解。</p>
<hr>
<h3 id="kickstart">kickstart<a href="#kickstart" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p><a href="https://github.com/nvim-lua/kickstart.nvim">kickstart链接</a>
这是并不是一个neovim发行版，它只是一套配置文件。严谨的说，它是nvim官方维护的一个学习版nvim配置框架。它使用了lazy. nvim这一插件管理器（注意：这和lazyvim完全不是一回事），但是和lazyvim是完全不一样的两个东西，后者是一个“开箱即用”的nvim框架（但也不那么开箱即用）。</p>
<p>你仍然需要安装nvim。kickstart只是提供了清晰的配置文件，方便初学者快速了解如何配置nvim。我们接下来也会以kickvim提供的init.lua为例讲解neovim可供配置的内容。</p>
<h4 id="安装neovim">安装neovim<a href="#%e5%ae%89%e8%a3%85neovim" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>显然，如果我们想要使用neovim，我们需要先安装它。你可以安装任意你想要的版本，不过这里我们选择Nvim 0.11.5。kickstart要求nvim版本为最新的稳定版，或者每日夜晚自动编译得到的不经过稳定性测试的Nightly版，我们此处使用的是最新的稳定版。</p>
<p>对于大部分普通电脑，cpu采用x86_64架构，你需要下载nvim-linux-x86_64.tar.gz。这是软件文件的压缩包，你需要把它移动到你想要它存在的文件目录下，然后在该目录下执行：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tar xzvf nvim-linux-x86_64.tar.gz <span style="color:#75715e">#或者你实际下载的压缩包</span>
</span></span></code></pre></div><p>我这边使用的是termux，平板、手机一般cpu架构是arm64，所以我下载的是nvim-linux-arm64.tar.gz。执行相同命令解压之后得到一个同名文件夹。此时，输入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>./nvim-linux-x86_64/bin/nvim <span style="color:#75715e">#注意第一个应当是你实际下载的版本</span>
</span></span></code></pre></div><p>通常来说，这个时候你就会进入一个nvim的默认的黑白界面。这就意味着你neovim安装成功了。</p>
<p>此外，为了使用方便，你最好还要安装一些剪切板工具，如xclip，以及Nerd Font，用来显示更美观的图标。此部分自行参考相应的文档自己选择进行。</p>
<h4 id="kickstart安装">kickstart安装<a href="#kickstart%e5%ae%89%e8%a3%85" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>现在我们来安装kickstart。在kickstart的文档中，开发者提示说可以将这个kickstart仓库复刻一份到你自己的仓库下，这样你可以通过git来管理你的配置。</p>
<p>如果你懒得复刻一份，直接输入这个指令，kickstart就会开始自动安装（后记：这里你最好记住这个文件位置~/.config/nvim，因为你之后折腾配置的时候要经常打开它）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>git clone https://github.com/nvim-lua/kickstart.nvim.git <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>XDG_CONFIG_HOME<span style="color:#66d9ef">:-</span>$HOME/.config<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>/nvim
</span></span></code></pre></div><p>如果复刻了一份到自己的仓库，直接从自己的仓库克隆即可。</p>
<p>在下载好后，再次输入<code>nvim</code>，如果一切正常，你就会看见一堆进度条，一堆看不懂的东西安装完后，界面显示出Tokyo night的配色方案，这就意味着你安装成功了。</p>
<h4 id="可能遇到的问题">可能遇到的问题<a href="#%e5%8f%af%e8%83%bd%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>在某些平台上，stylua或者一些其他插件并没有提供预编译版，这意味着Mason（你可以理解为nvim的包管理器，自动安装、管理各种开发工具）无法自动安装这些工具。你需要自行编译安装。其中比较推荐的是使用<strong>世界上最好的包管理器</strong>cargo来进行编译安装。</p>
<p>要使用cargo，你需要先安装rust。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>pkg install rust <span style="color:#75715e">#这里开头需要用你自己实际的包管理器</span>
</span></span></code></pre></div><p>安装完后，输入：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cargo install stylua
</span></span></code></pre></div><p>如果没有意外的话，下载成功后二进制文件会位于<code>~/.cargo/bin/stylua</code>（cargo理论上会给出提示）。在<code>~/.bashrc</code>或者<code>~/.zshrc</code>中加入一行<code>export PATH=&quot;$HOME/.cargo/bin:$PATH&quot;</code> 退出后输入<code>source ~/.bashrc</code>或者<code>source ~/.zshrc</code>，之后按理来说stylua就已经可以工作了。</p>
<p>但是这个时候，Mason可能会因为只识别Mason安装的stylua而导致进入nvim后依然报错。你可以:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nvim ~/.config/nvim/init.lua
</span></span></code></pre></div><p>这就是我们一会会讲到的文件，里面罗列了所有你可能会用到的配置文本。在其中大概718行的位置，你可以找到：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>require(<span style="color:#e6db74">&#34;mason-tool-installer&#34;</span>).setup {
</span></span><span style="display:flex;"><span>  ensure_installed <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">-- 删掉 stylua 或者不要写</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>正如上文中的注释，此处本来应该有stylua相关的内容。将它删掉或者注释掉即可。保存退出，再次进入nvim，此时就不会有stylua报错了。你可以通过<code>:!which stylua</code>来验证nvim可以找到stylua应用。</p>
<p>除stylua外，还有一些包也可能会因为环境缘故无法直接通过mason安装，不再一一列举。</p>
<p>如果你遇到无法解决的问题，你可以暂时先放一放，继续阅读。之后仍然无法解决，则去求助ai或者其他博客。</p>
<hr>
<h3 id="initlua">init.lua<a href="#initlua" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<p>现在，我们终于可以进入根目录的init.lua了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nvim ~/.config/nvim/init.lua
</span></span></code></pre></div><p>如果一切顺利，你会进入一个1000多行的文件，这就是kickstart的配置模版。接下来我们会逐段分析这个配置模版。</p>
<h3 id="开头部分">开头部分<a href="#%e5%bc%80%e5%a4%b4%e9%83%a8%e5%88%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<pre tabindex="0"><code>=====================================================================
==================== READ THIS BEFORE CONTINUING ====================
=====================================================================
========                                    .-----.          ========
========         .----------------------.   | === |          ========
========         |.-&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;-.|   |-----|          ========
========         ||                    ||   | === |          ========
========         ||   KICKSTART.NVIM   ||   |-----|          ========
========         ||                    ||   | === |          ========
========         ||                    ||   |-----|          ========
========         ||:Tutor              ||   |:::::|          ========
========         |&#39;-..................-&#39;|   |____o|          ========
========         `&#34;&#34;)----------------(&#34;&#34;`   ___________      ========
========        /::::::::::|  |::::::::::\  \ no mouse \     ========
========       /:::========|  |==hjkl==:::\  \ required \    ========
========      &#39;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#39;  &#39;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#39;  &#39;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#34;&#39;   ========
========                                                     ========
=====================================================================
=====================================================================

What is Kickstart?

  Kickstart.nvim is *not* a distribution.

  Kickstart.nvim is a starting point for your own configuration.
    The goal is that you can read every line of code, top-to-bottom, understand
    what your configuration is doing, and modify it to suit your needs.

    Once you&#39;ve done that, you can start exploring, configuring and tinkering to
    make Neovim your own! That might mean leaving Kickstart just the way it is for a while
    or immediately breaking it into modular pieces. It&#39;s up to you!

    If you don&#39;t know anything about Lua, I recommend taking some time to read through
    a guide. One possible example which will only take 10-15 minutes:
      - https://learnxinyminutes.com/docs/lua/

    After understanding a bit more about Lua, you can use `:help lua-guide` as a
    reference for how Neovim integrates Lua.
    - :help lua-guide
    - (or HTML version): https://neovim.io/doc/user/lua-guide.html
</code></pre><p>简单总结，就是告诉你这不是一个neovim发行版，只是一个模版框架。其中它给出的一个10-15min学习lua的网站 <a href="https://learnxinyminutes.com/zh-cn/lua/">https://learnxinyminutes.com/zh-cn/lua/</a> 非常有用，可以帮助你快速掌握使用lua的关键知识。lua并不是一个复杂的语言，甚至比python还要简单的多。下面我简单罗列一些我们可能会用到的lua知识。</p>
<h3 id="一些必须的lua基础知识">一些必须的lua基础知识<a href="#%e4%b8%80%e4%ba%9b%e5%bf%85%e9%a1%bb%e7%9a%84lua%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h3>
<h4 id="local关键字">local关键字<a href="#local%e5%85%b3%e9%94%ae%e5%ad%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>在lua当中，如果不使用local声明，变量就会被视为全局变量。在声明函数之前加上local被视为是lua编程的良好风格。</p>
<h4 id="require关键字">require关键字<a href="#require%e5%85%b3%e9%94%ae%e5%ad%97" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>这个关键字非常重要，它的作用是加载和使用模块。简单来说，你的配置文件可能有复杂的结构，但是neovim并不能全自动地去搜索所有的.lua文件。正如很多其他语言只有一个main.xx文件一样，lua通常而言也只有一个主文件，你需要在这个主文件中引用其他文件的内容。</p>
<p>在我个人看来，lua的文件组织方式和python有许多相似之处。两者都将单个的.lua文件或者.py文件看做一个&quot;模块&quot;，不同功能的模块之间除了文件内容之外没有文件后缀名或者文件名的限制。但是python和lua在一些细节的机制上还是有所不同。</p>
<p>python的模块导出机制可以看做是“默认导出”。一个python模块文件（即一个.py文件）所有的顶级变量、函数、类全都是公开的。比如你在<code>utils.py</code>中写了一个名为<code>myfunction()</code>的函数，你想在另一个.py文件中使用这个函数，你只需要先<code>import utils</code>，再写<code>utils.myfunction()</code>即可。可以说，python的每个单独的.py文件都是一个“命名空间”，就像namespace std一样。</p>
<p>但是lua采用了一个与此区别较大的管理方式。简单来说，lua的所有内容都是“私有的”，如果你想让别的.lua文件使用这个.lua文件中的函数等内容，你需要把这些东西“打包发出去”。理解这点对于配置neovim非常关键。</p>
<p>我们下面来看一个简单的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- shopping.lua</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- (上面的 local 函数和变量定义)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 1. 手动创建一个空的“储物柜” (table)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> M <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 2. 手动把要公开的东西放进去</span>
</span></span><span style="display:flex;"><span>M.buy_apple <span style="color:#f92672">=</span> buy_apple <span style="color:#75715e">--这是一个shopping.lua中定义的函数</span>
</span></span><span style="display:flex;"><span>M.PRICE_PER_APPLE <span style="color:#f92672">=</span> PRICE_PER_APPLE <span style="color:#75715e">--这是一个shopping.lua中定义的变量</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 注意：我们故意不把 buy_banana 放进去</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 3. 把这个填充好的储物柜作为模块的出口</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> M
</span></span></code></pre></div><p>当我们想从另一个.lua中调用shopping.lua中的函数或者变量时，我们需要这么写：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#66d9ef">local</span> shopping <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;shopping&#39;</span>) <span style="color:#75715e">--此处就用到了require</span>
</span></span></code></pre></div><p>这时候，我们就在这个.lua文件中定义了一个变量，名字叫<code>shopping</code>。它的内容是什么呢？很简单，就是shopping.lua中最后“打包”好的M这个table。</p>
<p>此时，如果你想买苹果，你就写<code>shopping.buy_apple()</code>，如果你想知道苹果的单价，那你就写<code>shopping.PRICE_PER_APPLE</code>。但是你没办法买香蕉，因为你在shopping.lua中没有把buy_banana()打包发出去。</p>
<p>读到这里，你基本上已经明白了lua的模块管理机制了，但是还不够（因为接下来的内容同样非常重要）。lua并不能完全自动地搜索根目录下匹配名称的.lua文件，而是遵循着一种“内部搜索顺序”。简单来说，这个内部搜索顺序就是一堆相对路径，lua文件运行时会挨个搜索这些路径去找符合条件的.lua文件（比如我们前文写的shopping.lua)，如果它在按照内部搜索顺序寻找无果，那么，它就会报错。</p>
<p>这点之所以重要，就是因为有的时候你必须要让neovim知道它需要的文件到底在哪，但是这个工作是没办法交给ai的，因为你没办法把整个项目都发给ai，ai凭刻板印象给出的代码在解决这类问题时通常无法正常工作，因为它根本不了解你到底把什么文件放在哪了（甚至你自己也很可能未必知道自己需要的文件在哪）。这个时候再把问题发给ai让它解决，ai就会继续给你一个更错的答案，最后恶性循环。（别问我是怎么知道的）</p>
<p>下面我来详细讲解一下“内置搜索顺序”的机制。</p>
<h4 id="内置搜索顺序">内置搜索顺序<a href="#%e5%86%85%e7%bd%ae%e6%90%9c%e7%b4%a2%e9%a1%ba%e5%ba%8f" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>lua中用于搜索lua模块的路径变量称为“packege.path”，存储在内置的package表中。</p>
<p>它们通常长成这样：</p>
<pre tabindex="0"><code>./?.lua;./?/init.lua;/usr/local/share/lua/5.4/?.lua;/usr/local/share/lua/5.4/?/init.lua;...
</code></pre><p>其中，分号分隔了不同的路径，<code>?</code>代表此处会被自动替换为你<code>require</code>中填写的内容。</p>
<p>例如，假设你执行了 require(&lsquo;socket.core&rsquo;)，Lua 会：</p>
<ol>
<li>将模块名中的 . 替换为目录分隔符（如 / 或 \）。所以 socket.core 变成了 socket/core。</li>
<li>然后用 socket/core 替换掉 package.path 中每个模板的 ?，并依次检查文件是否存在：
<ul>
<li>./socket/core.lua (在当前目录下找)</li>
<li>./socket/core/init.lua (在当前目录下的 socket 目录中找 init.lua)</li>
<li>/usr/local/share/lua/5.4/socket/core.lua (在标准的 Lua 库目录下找)</li>
<li>/usr/local/share/lua/5.4/socket/core/init.lua (在标准的 Lua 库目录的子目录中找)</li>
<li>&hellip;等等，直到找到一个存在的文件为止。</li>
</ul>
</li>
</ol>
<p>一旦找到，lua就会执行这个文件并返回结果（在我们前文的例子中，返回的就是打包好的函数和变量），如果找不到，require就会报错。</p>
<p>那么，当我们需要去寻找一个不在默认搜索路径中的文件该怎么做呢？</p>
<p>下面我们举一个简单的例子:</p>
<hr>
<p>首先，让我们在随便一个测试用的文件夹中创建以下文件结构：</p>
<pre tabindex="0"><code>.
├── libs
│   └── myutils.lua
└── main.lua
</code></pre><p>然后，让我们在<code>myutils.lua</code>中随便写一点测试用的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- libs/myutils.lua</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 创建一个 table 用于导出</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> M <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">M</span>.<span style="color:#a6e22e">greet</span>(name)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Hello, &#34;</span> <span style="color:#f92672">..</span> name <span style="color:#f92672">..</span> <span style="color:#e6db74">&#34;! Welcome to our module.&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 导出这个 table</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> M
</span></span></code></pre></div><p>然后，我们来在<code>main.lua</code>中写一个<strong>错误</strong>的模块调用代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- main.lua</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Attempting to load the &#39;myutils&#39; module...&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 尝试加载位于 libs 文件夹中的 myutils 模块</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 注意：我们直接写 &#39;myutils&#39; 而不是 &#39;libs.myutils&#39;，因为 &#39;libs&#39; 只是一个普通文件夹，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 并不是 Lua 的包名。我们需要让 Lua 知道要去 &#39;libs&#39; 这个文件夹里找。</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> utils <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;myutils&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 如果加载成功，就使用它的功能</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> message <span style="color:#f92672">=</span> utils.greet(<span style="color:#e6db74">&#34;Alice&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Successfully loaded module!&#34;</span>)
</span></span><span style="display:flex;"><span>print(message)
</span></span></code></pre></div><p>这段代码是ai写的。你可能会对其中的注释感到疑惑，我来尝试解答一下：</p>
<ul>
<li>直接写<code>require('libs.myutils')</code>其实是可以正常工作的，但是这并不利于维护。我们希望让lua自己通过package path去寻找所需要的模块，而代码中应该只考虑需要什么模块。如果我们在require中强行写入物理位置，虽然可以工作，但是一旦我们调整了文件位置，就不得不修改整个程序中所有从libs中调用模块的代码，这样做非常的低效。</li>
<li>在这段代码中，我们构建了一个无法通过package path找到所需模版的main.lua，这完全是反面例子。后文我们会给出修改。</li>
</ul>
<p>保存退出，输入<code>lua main.lua</code>，你就会喜提报错：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ lua main.lua
</span></span><span style="display:flex;"><span>Attempting to load the <span style="color:#e6db74">&#39;myutils&#39;</span> module...
</span></span><span style="display:flex;"><span>lua: main.lua:8: module <span style="color:#e6db74">&#39;myutils&#39;</span> not found:
</span></span><span style="display:flex;"><span>        no field package.preload<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;myutils&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;/data/data/com.termux/files/usr/share/lua/5.3/myutils.lua&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;/data/data/com.termux/files/usr/share/lua/5.3/myutils/init.lua&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;/data/data/com.termux/files/usr/lib/lua/5.3/myutils.lua&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;/data/data/com.termux/files/usr/lib/lua/5.3/myutils/init.lua&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;./myutils.lua&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;./myutils/init.lua&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;/data/data/com.termux/files/usr/lib/lua/5.3/myutils.so&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;/data/data/com.termux/files/usr/lib/lua/5.3/loadall.so&#39;</span>
</span></span><span style="display:flex;"><span>        no file <span style="color:#e6db74">&#39;./myutils.so&#39;</span>
</span></span><span style="display:flex;"><span>stack traceback:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>C<span style="color:#f92672">]</span>: in <span style="color:#66d9ef">function</span> <span style="color:#e6db74">&#39;require&#39;</span>
</span></span><span style="display:flex;"><span>        main.lua:8: in main chunk
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">[</span>C<span style="color:#f92672">]</span>: in ?
</span></span></code></pre></div><p>这样的报错信息会在你配置nvim过程中时常出现（如果你完全不关心背后的原理）。</p>
<p>从报错信息中，你会看到lua查找了所有的内部搜索路径，但是都找不到你要的<code>myutils.lua</code>这个模块，因为你把它放在了libs下，lua根本不知道还有这个地方。</p>
<p>那么如何解决呢？很简单，我们只需要让<code>main.lua</code>把<code>libs</code>添加到package path中就行。</p>
<p>将<code>main.lua</code>修改为以下内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- main.lua</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;--- Experiment 2: Modifying package.path in script ---&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 打印修改前的 path，方便对比</span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Original package.path:&#34;</span>)
</span></span><span style="display:flex;"><span>print(package.path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- 将我们的 libs 目录添加到搜索路径的最前面</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- &#39;./libs/?.lua&#39; 是一个模板，&#39;?&#39; 会被 require 的模块名替换</span>
</span></span><span style="display:flex;"><span>package.path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;./libs/?.lua;&#39;</span> <span style="color:#f92672">..</span> package.path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Modified package.path:&#34;</span>)
</span></span><span style="display:flex;"><span>print(package.path)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Attempting to load the &#39;myutils&#39; module...&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> utils <span style="color:#f92672">=</span> require(<span style="color:#e6db74">&#39;myutils&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">local</span> message <span style="color:#f92672">=</span> utils.greet(<span style="color:#e6db74">&#34;Bob&#34;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Successfully loaded module!&#34;</span>)
</span></span><span style="display:flex;"><span>print(message)
</span></span></code></pre></div><p>再次退出，输入<code>lua main.lua</code>你就可以得到想要的内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ lua main.lua
</span></span><span style="display:flex;"><span>--- Experiment 2: Modifying package.path in script ---
</span></span><span style="display:flex;"><span>Original package.path:
</span></span><span style="display:flex;"><span>/data/data/com.termux/files/usr/share/lua/5.3/?.lua;/data/data/com.termux/files/usr/share/lua/5.3/?/init.lua;/data/data/com.termux/files/usr/lib/lua/5.3/?.lua;/data/data/com.termux/files/usr/lib/lua/5.3/?/init.lua;./?.lua;./?/init.lua
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Modified package.path:
</span></span><span style="display:flex;"><span>./libs/?.lua;/data/data/com.termux/files/usr/share/lua/5.3/?.lua;/data/data/com.termux/files/usr/share/lua/5.3/?/init.lua;/data/data/com.termux/files/usr/lib/lua/5.3/?.lua;/data/data/com.termux/files/usr/lib/lua/5.3/?/init.lua;./?.lua;./?/init.lua
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Attempting to load the <span style="color:#e6db74">&#39;myutils&#39;</span> module...
</span></span><span style="display:flex;"><span>Successfully loaded module!
</span></span><span style="display:flex;"><span>Hello, Bob! Welcome to our module.
</span></span></code></pre></div><p>注：以上是我在termux中运行的信息，其他平台上显示的path可能会有所区别。</p>
<p>我们打印了修改前后package.path的内容，显然，在<code>Modified package.path</code>中第一个搜索路径就是我们添加的<code>./libs/?.lua</code>，此时我们也确实成功使用了<code>myutils.lua</code>中的函数。</p>
<p>怎么做到的呢？让我们来仔细看一下我们修改的核心内容：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- 将我们的 libs 目录添加到搜索路径的最前面 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- &#39;./libs/?.lua&#39; 是一个模板，&#39;?&#39; 会被 require 的模块名替换 </span>
</span></span><span style="display:flex;"><span>package.path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;./libs/?.lua;&#39;</span> <span style="color:#f92672">..</span> package.path
</span></span></code></pre></div><p><code>..</code>在lua中表示字符串连接。这段代码的含义非常清晰：在<code>package.path</code>这个字符串前面加上我们需要的搜索路径。就这么简单。<code>package.path</code>本质就是一个字符串，你可以随意的根据需要修改本工程的搜索路径。</p>
<p>除此之外，如果你的所有lua工程都采用基本一致的文件结构，你可以把你需要的自定义的搜索路径写入环境变量中。比如你可以在终端中输入<code>export LUA_PATH=&quot;./libs/?.lua;;&quot;</code>，其中<code>;;</code>意味着保留原本的路径。这时候，即使你不在<code>main.lua</code>开头编辑<code>package.path</code>，lua也会自动找到libs下的myutils.lua，因为所需要的搜索路径已经成为一个环境的一部分了。</p>
<p>但是如果你希望自己的代码可以一次写入、处处运行，那么我建议你还是老老实实的把所需要的搜索路径写在开头，以便在不同环境中都可以使用。</p>
<hr>
<p>讲到这里，我们大概理解了lua的工作原理，现在让我们继续阅读根目录下的init.lua文件。</p>
<h4 id="正式开始分析initlua">正式开始分析init.lua<a href="#%e6%ad%a3%e5%bc%8f%e5%bc%80%e5%a7%8b%e5%88%86%e6%9e%90initlua" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>Kickstart Guide:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  TODO: The very first thing you should <span style="color:#66d9ef">do</span> is to run the command <span style="color:#960050;background-color:#1e0010">`</span>:Tutor<span style="color:#960050;background-color:#1e0010">`</span> <span style="color:#66d9ef">in</span> Neovim.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    If you don<span style="color:#e6db74">&#39;t know what this means, type the following:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &lt;escape key&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - :
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - Tutor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      - &lt;enter key&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    (If you already know the Neovim basics, you can skip this step.)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  Once you&#39;</span>ve completed that, you can continue working through <span style="color:#f92672">**</span>AND READING<span style="color:#f92672">**</span> the rest
</span></span><span style="display:flex;"><span>  of the kickstart init.lua.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Next, run AND READ <span style="color:#960050;background-color:#1e0010">`</span>:help<span style="color:#960050;background-color:#1e0010">`</span>.
</span></span><span style="display:flex;"><span>    This will open up a help window with some basic information
</span></span><span style="display:flex;"><span>    about reading, navigating <span style="color:#f92672">and</span> searching the builtin help documentation.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    This should be the first place you go to look when you<span style="color:#e6db74">&#39;re stuck or confused
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    with something. It&#39;</span>s one of my favorite Neovim features.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MOST IMPORTANTLY, we provide a keymap <span style="color:#e6db74">&#34;&lt;space&gt;sh&#34;</span> to [s]earch the [h]elp documentation,
</span></span><span style="display:flex;"><span>    which is very useful when you<span style="color:#e6db74">&#39;re not exactly sure of what you&#39;</span>re looking <span style="color:#66d9ef">for</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  I have left several <span style="color:#960050;background-color:#1e0010">`</span>:help X<span style="color:#960050;background-color:#1e0010">`</span> comments throughout the init.lua
</span></span><span style="display:flex;"><span>    These are hints about where to find more information about the relevant settings,
</span></span><span style="display:flex;"><span>    plugins <span style="color:#f92672">or</span> Neovim features used <span style="color:#66d9ef">in</span> Kickstart.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   NOTE: Look <span style="color:#66d9ef">for</span> lines like this
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Throughout the file. These are <span style="color:#66d9ef">for</span> you, the reader, to help you understand what is happening.
</span></span><span style="display:flex;"><span>    Feel free to delete them once you know what you<span style="color:#e6db74">&#39;re doing, but they should serve as a guide
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    for when you are first encountering a few different constructs in your Neovim config.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">If you experience any errors while trying to install kickstart, run `:checkhealth` for more info.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">I hope you enjoy your Neovim journey,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">- TJ
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">P.S. You can delete this when you&#39;</span>re done too. It<span style="color:#e6db74">&#39;s your config now! :)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">--]]
</span></span></span></code></pre></div><p>总结一下：</p>
<ul>
<li>你可以在普通模式下<code>:Tutor</code>来进入一个neovim的使用教程，告诉你这个软件的基本使用方式。
<ul>
<li>vim的使用方式可以非常花哨，内置的指令多的数不过来。遗憾的是我只会其中最基本的几个指令，但是这通常来讲已经足够了。你不需要为了少按几个上下左右而去背一大堆指令，这样做有用，但是对于一个入门的人来说完全没有必要。</li>
</ul>
</li>
<li>你可以在普通模式下<code>:help</code>来查看帮助。里面罗列了nvim支持的各种功能，以及一些基本的使用方式。这就是一部使用说明书，就和你买的家用电器里附带的说明书是一个性质。</li>
<li>你可以<code>&lt;space&gt;+s+h</code>来进入一个帮助搜索界面。（然而我不会用）</li>
<li>文件剩余的内容都随便你配置。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- Set &lt;space&gt; as the leader key</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- See `:help mapleader`</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  NOTE: Must happen before plugins are loaded (otherwise wrong leader will be used)</span>
</span></span><span style="display:flex;"><span>vim.g.mapleader <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39; &#39;</span>
</span></span><span style="display:flex;"><span>vim.g.maplocalleader <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39; &#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Set to true if you have a Nerd Font installed and selected in the terminal</span>
</span></span><span style="display:flex;"><span>vim.g.have_nerd_font <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><ul>
<li><code>vim.g</code>：代表全局变量。这里设置的变量在全局都有效。</li>
<li><code>vim.g.mapleader = ' '</code>：将空格键设置为“前导键”，用来作为一个通用的快捷键前缀。</li>
<li><code>vim.g.maplocalleader = ' '</code>：局部映射，简单来说就是只在某些文件中才会生效的“前导键”，之后<code>&lt;localleader&gt;x</code>就表示只在此情况下才生效的快捷键。</li>
<li><code>vim.g.have_nerd_font = false</code>：声明你的终端环境有没有安装Nerd Font。很多nvim的插件需要nerd font来支持一些复杂的图形界面，如果你没有安装nerd font，通过在这里声明false，那些插件就会只显示一些普通文本来适配你的环境。
<ul>
<li>如果你安装了nerd font，记得把这个变量设置为true。</li>
</ul>
</li>
</ul>
<h5 id="setting-options">setting options<a href="#setting-options" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- [[ Setting options ]]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- See `:help vim.o`</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- NOTE: You can change these options as you wish!</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  For more options, you can see `:help option-list`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Make line numbers default</span>
</span></span><span style="display:flex;"><span>vim.o.number <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- You can also add relative line numbers, to help with jumping.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  Experiment for yourself to see if you like it!</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.o.relativenumber = true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Enable mouse mode, can be useful for resizing splits for example!</span>
</span></span><span style="display:flex;"><span>vim.o.mouse <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;a&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Don&#39;t show the mode, since it&#39;s already in the status line</span>
</span></span><span style="display:flex;"><span>vim.o.showmode <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Sync clipboard between OS and Neovim.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  Schedule the setting after `UiEnter` because it can increase startup-time.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  Remove this option if you want your OS clipboard to remain independent.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  See `:help &#39;clipboard&#39;`</span>
</span></span><span style="display:flex;"><span>vim.schedule(<span style="color:#66d9ef">function</span>()
</span></span><span style="display:flex;"><span>  vim.o.clipboard <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;unnamedplus&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Enable break indent</span>
</span></span><span style="display:flex;"><span>vim.o.breakindent <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Save undo history</span>
</span></span><span style="display:flex;"><span>vim.o.undofile <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Case-insensitive searching UNLESS \C or one or more capital letters in the search term</span>
</span></span><span style="display:flex;"><span>vim.o.ignorecase <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>vim.o.smartcase <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Keep signcolumn on by default</span>
</span></span><span style="display:flex;"><span>vim.o.signcolumn <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;yes&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Decrease update time</span>
</span></span><span style="display:flex;"><span>vim.o.updatetime <span style="color:#f92672">=</span> <span style="color:#ae81ff">250</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Decrease mapped sequence wait time</span>
</span></span><span style="display:flex;"><span>vim.o.timeoutlen <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Configure how new splits should be opened</span>
</span></span><span style="display:flex;"><span>vim.o.splitright <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>vim.o.splitbelow <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Sets how neovim will display certain whitespace characters in the editor.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  See `:help &#39;list&#39;`</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  and `:help &#39;listchars&#39;`</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  Notice listchars is set using `vim.opt` instead of `vim.o`.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  It is very similar to `vim.o` but offers an interface for conveniently interacting with tables.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--   See `:help lua-options`</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--   and `:help lua-options-guide`</span>
</span></span><span style="display:flex;"><span>vim.o.list <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>vim.opt.listchars <span style="color:#f92672">=</span> { tab <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;» &#39;</span>, trail <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;·&#39;</span>, nbsp <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;␣&#39;</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Preview substitutions live, as you type!</span>
</span></span><span style="display:flex;"><span>vim.o.inccommand <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;split&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Show which line your cursor is on</span>
</span></span><span style="display:flex;"><span>vim.o.cursorline <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Minimal number of screen lines to keep above and below the cursor.</span>
</span></span><span style="display:flex;"><span>vim.o.scrolloff <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- if performing an operation that would fail due to unsaved changes in the buffer (like `:q`),</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- instead raise a dialog asking if you wish to save the current file(s)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- See `:help &#39;confirm&#39;`</span>
</span></span><span style="display:flex;"><span>vim.o.confirm <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><ul>
<li><code>vim.o</code>：设置nvim的各种行为选项。</li>
<li><code>vim.o.number = true</code>：显示==行号==。默认显示的是绝对行号</li>
<li><code>vim.o.relativenumber = true</code>：显示==相对行号==。
<ul>
<li>你可能会好奇如果两个都启用会怎么样。答案很简单：你所处的行会显示绝对行号，而其他行会显示相对行号。这样你既能确定自己的绝对位置，又方便跳转位置，这是很多人的选择。</li>
</ul>
</li>
<li><code>vim.o.mouse = 'a'</code>：==鼠标模式==，a表示对所有文件都适用。如果你有鼠标，你没有理由把这个这个关掉。</li>
<li><code>vim.o.showmode = false</code>：不显示nvim内置的==状态提示==。更加现代的状态栏插件可以提供比文本更美观的状态栏，所以除非你有特殊的美术追求，没必要调为true。</li>
<li><code>vim.schedule(function()vim.o.clipboard = 'unnamedplus'end)</code>：<code>vim.schedule</code>表示在ui完全加载完之后再执行，后面的函数表示将nvim的==剪切板与操作系统剪切板同步==。你可以在nvim中<code>y</code>复制文本之后在外部<code>ctrl v</code>粘贴，也可以外部<code>ctrl c</code>复制后在nvim中<code>p</code>粘贴。
<ul>
<li>这是一个非常有必要的设置，尤其是当你需要和ai博弈的时候。</li>
</ul>
</li>
<li><code>vim.o.breakindent = true</code>：==打断缩进==，文本太长自动换行后保持和原文本同样的缩进。</li>
<li><code>vim.o.undofile = true</code>：保存==撤回树==，当你再次打开这个文件时，你仍然可以撤回到之前的状态，即使中间你保存了文件。实现原理是另外建立一个<code>.un~</code>文件，所以理论上你可以撤回到宇宙大爆炸（如果你从那时就开始写代码）</li>
<li><code>vim.o.ignorecase = true</code> <code>vim.o.smartcase = true</code>：==搜索==时忽视大小写，但是如果你输入了至少一个大写时又会自动大小写敏感。</li>
<li><code>vim.o.signcolumn = 'yes'</code>： 保持==侧边栏显示==，Lsp（后面会涉及）和一些其他的插件需要依赖这个侧边栏来显示一些信息，所以保持开启。</li>
<li><code>vim.o.updatetime = 250</code>：==更新时间==，你可以理解为minecraft中的随机刻，很多插件的使用依赖于这个更新时间，如果减少，一些插件的响应速度会加快。</li>
<li><code>vim.o.timeoutlen = 300</code>：==映射序列等待时间==，比如你的一个映射是<code>j+k</code>，当你按下<code>j</code>时，nvim会等待300ms，如果你在这时间内按下<code>k</code>，那么就会执行映射。</li>
<li><code>vim.o.splitright = true</code> <code>vim.o.splitbelow = true</code>：新的水平==分屏==和垂直分屏会分别出现在右边和下边。</li>
<li><code>vim.o.list = true</code>：开启list模式，让nvim可以显示一些特殊的==空白字符==</li>
<li><code>vim.opt.listchars = { tab = '» ', trail = '·', nbsp = '␣' }</code>：将tab显示为》，将尾部的多余空格显示为·，将不可断空格显示为␣。</li>
<li><code>vim.o.inccommand = 'split'</code>：执行替换命令时在一个新的==分屏窗口==中实时显示预览效果。</li>
<li><code>vim.o.cursorline = true</code>：==高亮==光标所在的当前行。</li>
<li><code>vim.o.scrolloff = 10</code>：光标滚动时会==偏移上下边缘10行==，方便阅读。</li>
<li><code>vim.o.confirm = true</code>：在一些可能导致数据丢失的情况下==要求你确认==，比如未保存时就退出。除非你是人形计算机永远可以保证正确，那么建议你保持开启。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span><span style="color:#75715e">-- [[ Basic Keymaps ]]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  See `:help vim.keymap.set()`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Clear highlights on search when pressing &lt;Esc&gt; in normal mode</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  See `:help hlsearch`</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;Esc&gt;&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;nohlsearch&lt;CR&gt;&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Diagnostic keymaps</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;q&#39;</span>, vim.diagnostic.setloclist, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Open diagnostic [Q]uickfix list&#39;</span> })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Exit terminal mode in the builtin terminal with a shortcut that is a bit easier</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- for people to discover. Otherwise, you normally need to press &lt;C-\&gt;&lt;C-n&gt;, which</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- is not what someone will guess without a bit more experience.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- NOTE: This won&#39;t work in all terminal emulators/tmux/etc. Try your own mapping</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- or just use &lt;C-\&gt;&lt;C-n&gt; to exit terminal mode</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;t&#39;</span>, <span style="color:#e6db74">&#39;&lt;Esc&gt;&lt;Esc&gt;&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&gt;&lt;C-n&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Exit terminal mode&#39;</span> })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- TIP: Disable arrow keys in normal mode</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#39;n&#39;, &#39;&lt;left&gt;&#39;, &#39;&lt;cmd&gt;echo &#34;Use h to move!!&#34;&lt;CR&gt;&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#39;n&#39;, &#39;&lt;right&gt;&#39;, &#39;&lt;cmd&gt;echo &#34;Use l to move!!&#34;&lt;CR&gt;&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#39;n&#39;, &#39;&lt;up&gt;&#39;, &#39;&lt;cmd&gt;echo &#34;Use k to move!!&#34;&lt;CR&gt;&#39;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#39;n&#39;, &#39;&lt;down&gt;&#39;, &#39;&lt;cmd&gt;echo &#34;Use j to move!!&#34;&lt;CR&gt;&#39;)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Keybinds to make split navigation easier.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  Use CTRL+&lt;hjkl&gt; to switch between windows</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">--  See `:help wincmd` for a list of all window commands</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-h&gt;&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-w&gt;&lt;C-h&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Move focus to the left window&#39;</span> })
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-l&gt;&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-w&gt;&lt;C-l&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Move focus to the right window&#39;</span> })
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-j&gt;&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-w&gt;&lt;C-j&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Move focus to the lower window&#39;</span> })
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-k&gt;&#39;</span>, <span style="color:#e6db74">&#39;&lt;C-w&gt;&lt;C-k&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Move focus to the upper window&#39;</span> })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- NOTE: Some terminals have colliding keymaps or are not able to send distinct keycodes</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#34;n&#34;, &#34;&lt;C-S-h&gt;&#34;, &#34;&lt;C-w&gt;H&#34;, { desc = &#34;Move window to the left&#34; })</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#34;n&#34;, &#34;&lt;C-S-l&gt;&#34;, &#34;&lt;C-w&gt;L&#34;, { desc = &#34;Move window to the right&#34; })</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#34;n&#34;, &#34;&lt;C-S-j&gt;&#34;, &#34;&lt;C-w&gt;J&#34;, { desc = &#34;Move window to the lower&#34; })</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- vim.keymap.set(&#34;n&#34;, &#34;&lt;C-S-k&gt;&#34;, &#34;&lt;C-w&gt;K&#34;, { desc = &#34;Move window to the upper&#34; })</span>
</span></span></code></pre></div><ul>
<li><code>vim.keymap.set()</code>：这是 Neovim 推荐的用来设置快捷键的函数。它比老式的 <code>map</code> 命令更清晰、功能更强大。</li>
<li><code>vim.keymap.set('n', '&lt;Esc&gt;', '&lt;cmd&gt;nohlsearch&lt;CR&gt;')</code>：在<strong>普通模式</strong> (Normal Mode)下（n就表示普通模式），当你按下 <code>&lt;Esc&gt;</code> 键时，自动执行 <code>:nohlsearch</code> 命令来清除上一次搜索结果的高亮。
<ul>
<li>这是一个极其舒适的设置。你用 <code>/</code> 搜索完一个词后，所有匹配项都会高亮，有时会很晃眼。这个快捷键让你可以在不经意间（因为 <code>&lt;Esc&gt;</code> 是最常用的键之一）就清除掉这些高亮，让界面恢复清爽。</li>
</ul>
</li>
<li><code>vim.keymap.set('n', '&lt;leader&gt;q', vim.diagnostic.setloclist)</code>：在<strong>普通模式</strong>下，按下你之前设置的 <code>Leader</code> 键（比如空格），再按下 <code>q</code>，就会打开一个<strong>诊断信息的列表 (Quickfix list)</strong>。
<ul>
<li>当你的代码有错误或警告时（由 LSP 提供），这个列表会把所有问题都集中展示出来，方便你逐个跳转和修复。<code>q</code> 很好记，可以联想成 “Quickfix”。</li>
</ul>
</li>
<li><code>vim.keymap.set('t', '&lt;Esc&gt;&lt;Esc&gt;', '&lt;C-\\&gt;&lt;C-n&gt;')</code>：在<strong>终端模式</strong> (Terminal Mode)下，<strong>连按两次 <code>&lt;Esc&gt;</code> 键</strong>，效果等同于按下那个非常难记的 <code>&lt;C-\&gt;&lt;C-n&gt;</code> 组合键，从而<strong>退出终端模式</strong>回到普通模式。
<ul>
<li>Neovim 内置的终端非常好用，但它的默认退出方式简直反人类。这个设置用一个更符合直觉的方式解决了这个问题。不过注释也提醒了，这个映射在某些复杂的终端环境（比如 tmux 嵌套）下可能不生效，那时就只能老老实实按默认的组合键了。</li>
</ul>
</li>
<li><code>-- TIP: Disable arrow keys in normal mode</code> (被注释掉的代码块)：这是一个给新手的<strong>提示性配置</strong>，建议<strong>禁用在普通模式下的方向键</strong>。
<ul>
<li>这么做的目的是为了“强迫”自己习惯使用 <code>h j k l</code> 来移动光标。这是 Vim 的精髓之一，因为你的手不需要离开主键区，移动效率会高得多。一旦你习惯了，就会发现方向键又远又慢。如果你想养成这个好习惯，可以把这段代码的注释去掉。</li>
</ul>
</li>
<li><code>vim.keymap.set('n', '&lt;C-h&gt;', '&lt;C-w&gt;&lt;C-h&gt;')</code> (以及下面 <code>jkl</code> 的三行)：这一组快捷键让你可以在<strong>普通模式</strong>下，使用 <code>Ctrl + h/j/k/l</code> 来<strong>在不同的分屏窗口之间切换焦点</strong>。
<ul>
<li>Neovim 原生的窗口切换命令是 <code>&lt;C-w&gt;</code> 再加上 <code>h/j/k/l</code>，需要按两次。这组设置把两步操作简化成了一步，让窗口导航变得像在单个文件中移动光标一样流畅自然，极大地提升了分屏工作的效率。</li>
</ul>
</li>
<li><code>-- NOTE: Some terminals have colliding keymaps...</code> (被注释掉的代码块)：这是另一组<strong>提示性配置</strong>，它尝试将 <code>Ctrl + Shift + h/j/k/l</code> 映射为<strong>移动整个窗口的位置</strong>，而不是仅仅移动焦点。
<ul>
<li>比如，按下 <code>Ctrl + Shift + h</code> 会把当前所在的窗口整个移动到左边去。这对于整理窗口布局很有用。</li>
<li>但是，注释明确指出，很多终端程序无法正确识别 <code>Ctrl + Shift</code> 和 <code>Ctrl</code> 的区别，导致这个快捷键可能无法生效。所以它被默认注释掉了，需要你自己测试和决定是否启用。</li>
</ul>
</li>
</ul>
<p>原谅我上面这段文字用了ai。ai描述通常会有过多的描述，导致看起来观感不那么清爽。不过没关系，我来总结一下：</p>
<ul>
<li><code>vim.keymap.set('&lt;mode&gt;','&lt;key&gt;','&lt;command&gt;',{desc = &quot;&quot;})</code>是配置键盘映射的基本语句，其中第一个参数表示模式，n,v,i,c,t分别代表普通模式、可视模式、插入模式、命令行模式、终端模式。这表明了该映射的生效场景。</li>
<li>第二个参数表示你按下的按键，特殊按键使用尖括号包裹。大致如下：
<ul>
<li>&lt;CR&gt;: 回车键 (Carriage Return)</li>
<li>&lt;Esc&gt;: Escape 键</li>
<li>&lt;Space&gt;: 空格键</li>
<li>&lt;leader&gt;: 你设置的 Leader 键</li>
<li>&lt;C-h&gt;: Ctrl + h</li>
<li>&lt;S-h&gt;: Shift + h</li>
<li>&lt;A-h&gt;: Alt + h (在 Lua 中也写作 &lt;M-h&gt;)</li>
<li>例：
<ul>
<li><code>&lt;leader&gt;q</code>前导键+q</li>
<li><code>&lt;C-h&gt;</code>Ctrl+h</li>
<li><code>&lt;Esc&gt;&lt;Esc&gt;</code>按两次esc</li>
</ul>
</li>
</ul>
</li>
<li>第三个参数表示指令，你可以用单引号包裹一个指令来直接表示一个指令，也可以仿照第二个参数来模拟按键。</li>
<li>第四个参数是选项，写入desc可以为快捷键写入描述。其他的可选项不在此罗列。</li>
</ul>
<p>现在，我们来写一些简单的快捷键，方便我们编写。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;i&#39;</span>,<span style="color:#e6db74">&#39;jk&#39;</span>,<span style="color:#e6db74">&#39;&lt;Esc&gt;&#39;</span>) <span style="color:#75715e">--用jk来从插入模式快速切换回普通模式，比按esc快的多</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;v&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;vsplit&lt;CR&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;[V]ertical split&#39;</span> }) <span style="color:#75715e">--创建垂直分屏的快速方式</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;v&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;vsplit&lt;CR&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;[V]ertical split&#39;</span> }) <span style="color:#75715e">--创建水平分屏</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;c&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;close&lt;CR&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;[C]lose window&#39;</span> }) <span style="color:#75715e">--关闭分屏</span>
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;bn&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;bnext&lt;CR&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Go to [N]ext [B]uffer&#39;</span> })
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;bp&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;bprevious&lt;CR&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Go to [P]revious [B]uffer&#39;</span> })
</span></span><span style="display:flex;"><span>vim.keymap.set(<span style="color:#e6db74">&#39;n&#39;</span>, <span style="color:#e6db74">&#39;&lt;leader&gt;bd&#39;</span>, <span style="color:#e6db74">&#39;&lt;cmd&gt;bdelete&lt;CR&gt;&#39;</span>, { desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;[D]elete/close buffer&#39;</span> })
</span></span></code></pre></div><p>总之，这部分代码主要就是让你在感觉有的快捷键比较反人类的时候可以随意将它修改为自己喜欢的快捷键。以上部分代码仅供参考。</p>
<hr>
<p>限于篇幅，init.lua内容的介绍暂时到这里。但是我们并没有结束：接下来，让我们来尝试将options和keymap部分的代码移植到其他地方去。所有的配置全部都放在一个init.lua文件中并不利于后期的维护与调整。理论上，根据我们前文所学的知识，我们已经足够可以实现配置文件的分模块管理了。</p>
<p>首先，让我们回到根目录：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cd ~/.config/nvim
</span></span></code></pre></div><p>接着，在<code>~/.config/nvim/lua/custom</code>目录下创建两个新的lua文件来存放我们写好的keymap和option部分代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>touch lua/custom/options.lua
</span></span><span style="display:flex;"><span>touch lua/custom/keymaps.lua
</span></span></code></pre></div><p>然后，将根目录下init.lua中<code>vim.o</code>与<code>vim.keymaps</code>相关的代码分别剪切到这两个文件中。注意，当你使用vim内置的<code>d</code>与<code>p</code>剪切粘贴工具时，因为你要移动的<code>vim.o</code>涉及到了剪切板工具，<code>vim.keymap</code>涉及到了快捷键设置，你可能在此过程中会遇到一点小问题。以防万一，你可以先把代码复制到外部，再挨个复制进对应文件，这样以防代码丢失。</p>
<p>此时，你就可以完全删除init.lua开头到keymaps位置的全部代码（除了全局变量），并补上：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lua" data-lang="lua"><span style="display:flex;"><span>require <span style="color:#e6db74">&#39;custom.options&#39;</span>
</span></span><span style="display:flex;"><span>require <span style="color:#e6db74">&#39;custom.keymaps&#39;</span>
</span></span></code></pre></div><p>不出意外的话，保存退出再重进，你原先写在init.lua中的配置此时再次会发挥作用。你可以通过这种方式让你的配置文件更加易于维护。</p>
<p>大概先这样，我还会就界面个性化、lsp等比较棘手的配置问题再写几篇博客。</p>
]]></content>
		</item>
		
		<item>
			<title>Hellohugo</title>
			<link>http://localhost:1313/zh-cn/posts/hellohugo/</link>
			<pubDate>Wed, 19 Nov 2025 23:20:43 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/hellohugo/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h2 id="hellohugo">Hellohugo<a href="#hellohugo" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>这是新的开始！</p>
<p>期中之后，我决定改用hugo博客框架来重新搭建自己的博客。原先使用hexo的博客因为起初技术力不足导致种种配置困难，最近想把文章投送上去时突然发现oranges主题的代码块意外的很丑。与此同时，老博客是在我的windows主系统中完成搭建的，而我现在代码工作基本完全转向了linux（虽然只是wsl），继续在windows下维护博客又会带来种种不便，所以索性完全弃用原本的博客，在wsl中另起炉灶。</p>
]]></content>
		</item>
		
		<item>
			<title>零基础如何搭建博客</title>
			<link>http://localhost:1313/zh-cn/posts/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/</link>
			<pubDate>Sat, 20 Sep 2025 20:49:03 +0800</pubDate><author>Moonhalf</author><guid>http://localhost:1313/zh-cn/posts/%E9%9B%B6%E5%9F%BA%E7%A1%80%E5%A6%82%E4%BD%95%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/</guid>
			<description><![CDATA[&lt;no value&gt;]]></description><content type="text/html" mode="escaped"><![CDATA[<h4 id="从旧站移植来的旧文旧站使用的是hexo框架">从旧站移植来的旧文，旧站使用的是hexo框架<a href="#%e4%bb%8e%e6%97%a7%e7%ab%99%e7%a7%bb%e6%a4%8d%e6%9d%a5%e7%9a%84%e6%97%a7%e6%96%87%e6%97%a7%e7%ab%99%e4%bd%bf%e7%94%a8%e7%9a%84%e6%98%afhexo%e6%a1%86%e6%9e%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>大概在本月的14号左右，我突然想起来之前知乎上有人和我说过可以搭建一个博客，写写题解什么的。当然，搭一个博客和写题解之间没有必然关系，但是就那几天我突然开始好奇什么是博客。不查不知道，博客竟然是一类网站的统称。经过了一番折腾总算是把自己的博客网站搭建起来了。</p>
<p>下面，请让我简述我的博客是如何搭建起来的。</p>
<h2 id="1静态框架hexo">1.静态框架hexo<a href="#1%e9%9d%99%e6%80%81%e6%a1%86%e6%9e%b6hexo" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>因为博客实际上是一种过去盛行的网络社交方式，大多数博客都大同小异，所以，搭建博客很多时候是一件相当同质化的事情。这就意味着，我们可以用相似的框架来搭建自己的博客。这就是博客框架。</p>
<p>博客框架替用户几乎铺平了所有技术困难，而用户可以聚焦在业务问题（如写博客）上。博客框架大致可以分为两类，静态框架和动态框架。后者的学习成本更高，但是可以做出更多的交互。而前者虽然不便于做交互，但是用来写写简单的博客文已经足够了。所以对我而言，性价比最高的方案就是使用静态博客框架搭建自己的博客。</p>
<p>在静态博客框架中，我选择了hexo。没什么理由，只是因为主题多并且学习成本低而已。对于其性能方面或许存在的问题，我的评价是我的境界还不足以让我感受到它的问题。</p>
<h2 id="2怎么用hexo">2.怎么用hexo？<a href="#2%e6%80%8e%e4%b9%88%e7%94%a8hexo" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>这是一个很现实的问题。对于大多数电脑使用者而言，用电脑几乎等同于与图形化界面打交道。比如，如果你想创建一个微信公众号，你只需要前往微信公众平台在图形化界面注册即可。但是对于博客框架和大多数拓展包而言，它们并不采用图形化界面的交互方式，而是采用命令行工具来完成各项工作。</p>
<p>这就意味着，想使用hexo搭建框架，最好先学一点命令行工具的用法。</p>
<h4 id="命令行工具">命令行工具<a href="#%e5%91%bd%e4%bb%a4%e8%a1%8c%e5%b7%a5%e5%85%b7" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>原谅我只用过windows系统。在win系统中，有两种命令行工具：cmd和powershell。前者大多用来做基础命令和兼容性，功能有限。此处我们使用powershell。</p>
<p>此外，你还需要安装git。如果你从来没有听说过它，这是一个软件，专门用来管理你的工程代码。鉴于博客本质上就是搭建网站，所以这也是不得不品的一环。安装git之后，你的电脑里还会出现另一个命令行工具：git bash。</p>
<p>所以，git bash和powershell又有什么区别呢？请看chatgpt给出的解释：</p>
<pre tabindex="0"><code>1. 运行环境不同

Git Bash

提供一个类 Linux 的 bash shell 环境（基于 MinGW）。

内置了很多常见的 Unix 工具（如 ls、grep、cat、rm）。

默认命令语法更接近 Linux / macOS。

适合习惯 Linux 命令行的用户。

PowerShell

Windows 原生的 shell，基于 .NET。

Git 本身并不自带 PowerShell，但你装了 Git for Windows 后，git.exe 会注册到系统 PATH，因此 PowerShell 也能直接用 git。

命令语法是 PowerShell 风格（Get-Command、| 管道传对象）。

更适合做 Windows 系统管理 + Git 混合场景。

2. 命令行为上的差异

路径格式

Git Bash：用 Linux 风格路径 /c/Users/...

PowerShell：用 Windows 风格路径 C:\Users\...

Git 内部能自动适配，但有时脚本里路径写法要注意。

脚本兼容性

Git Bash 能直接跑 .sh 脚本（Linux 写的脚本几乎不用改）。

PowerShell 只能跑 .ps1，要想跑 .sh，得额外配置（比如用 WSL）。

输出和管道

Git Bash：输出就是 文本，常用 grep、awk 处理。

PowerShell：输出是 对象，可以 git log | Out-File log.txt，但有些 git 输出并不是对象，还是普通文本，这时就当成字符串处理。

3. 体验上的差异

Git Bash

更像在 Linux 下用 Git，教程和 Stack Overflow 示例几乎可以原样照搬。

有补全、颜色支持等。

PowerShell

跟 Windows 系统融合度高，比如直接结合 Windows 文件系统、服务管理。
</code></pre><p>我们总结一下，大概就是git bash风格上更像linux系统，更能适配各类教程；而powershell和win系统的适配度更高。</p>
<p>所以我怎么用呢？我的评价是默认用powershell，报错出语法错误之后再试试git bash上能不能行。为什么要同时使用这两个命令行工具呢？很简单，因为当你作为初学者使用git时，不免要问问LLM的意见，这个时候LLM就有可能从网络的各个角落给你搜罗来命令，其中很可能相当一部分只能在git bash上使用，但是如果想本地调试博客的话又最好使用powershall。所以，轮着用吧。</p>
<p>对于powershell，只需要知道两个最基本的指令就行了。</p>
<pre tabindex="0"><code>cd &lt;path&gt;
dir
</code></pre><p>第一个指令是改变你命令行最前面的那个地址。之后你需要将地址改到你博客文件的根目录上才能继续使用hexo的相关命令。
第二个命令是罗列该目录下有什么文件，方便你cd。</p>
<p>好的，现在你知道了怎么用命令行工具切换文件目录了，是时候让我们开始在本地安装我们的hexo框架了。</p>
<h4 id="hexo环境安装">hexo环境安装<a href="#hexo%e7%8e%af%e5%a2%83%e5%ae%89%e8%a3%85" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>hexo框架是使用nodejs写的。就像C++需要编译才能运行，java需要JDK才能运行，nodejs写的程序也一样，在使用之前，我们还需要安装nodejs。</p>
<p>安装网站：<a href="https://nodejs.org/">nodejs</a></p>
<p>此外，在前文中我们提到了git。如果你想更新网站内容，对于hexo框架而言最方便的途径就是使用git。反正git工具对于一个写代码的人而言早晚都要学的，不如就趁现在学一下吧。</p>
<p>安装网站：<a href="https://git-scm.com/downloads">git</a>
(后记：实际上多数时候直接使用包管理器就可以非常轻松地下载。)</p>
<p>最后，毫无疑问，你需要安装hexo。但是这次，你不需要访问任何网站。nodejs内置了npm包管理器。你只需要输入一串指令就可以自动安装hexo。</p>
<pre tabindex="0"><code>npm install -g hexo-cli
</code></pre><p>在powershell中输入。为什么不在git bash中输入呢？因为我没试过。(实际上应该差不多)</p>
<h4 id="创建一个博客项目">创建一个博客项目<a href="#%e5%88%9b%e5%bb%ba%e4%b8%80%e4%b8%aa%e5%8d%9a%e5%ae%a2%e9%a1%b9%e7%9b%ae" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>在环境搭建完毕之后，你需要创建一个博客项目。hexo是一个为你生成博客网站源码的工具，它的产出单元就是博客。所以，创建一个博客。
cd到你觉得合适的地址，输入以下指令：</p>
<pre tabindex="0"><code>hexo init myblog   # 创建一个名为 myblog 的博客目录
cd myblog
npm install         # 安装依赖
</code></pre><p>执行完后，你会得到一个完整的博客项目文件夹，里面包括：</p>
<ul>
<li>source/_posts/：放文章的地方</li>
<li>themes/：博客外观主题</li>
<li>config.yml：全局配置文件</li>
</ul>
<p>好的，现在你就成功了相当一部分了。你已经有了博客的主要文件，你只需要往里面填内容然后部署即可。</p>
<p>那么，如何填内容呢？我们先来了解一下怎么本地测试。</p>
<pre tabindex="0"><code>hexo clean
hexo g
hexo s
</code></pre><p>这三个指令通常是连着输的，大多数时候你根本不用关心三个指令分别是什么意思，你只需要知道：三个指令输完之后，你会得到一个网址<code>http://localhost:4000/</code>，把它输入到浏览器中你就可以本地预览你的博客网站。通常而言，预览的结果就是部署得到的结果。
(后记：实则不然，第二次部署博客费了老劲，预览的结果和部署的结果始终不同，改了好久环境变量。)</p>
<h2 id="如何写博客">如何写博客？<a href="#%e5%a6%82%e4%bd%95%e5%86%99%e5%8d%9a%e5%ae%a2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>在上文中你已经学会了hexo的基本用法。现在是时候填充一些实际内容了。博客框架最大的优点就是支持markdown语法。这是一个程序员写README的经典标记语法，但是对于初学者来说可能会有一点点门槛。</p>
<p>这里不再罗列markdown的语法。不过，如果你想学markdown，我的经验是你可以先从学obsidian开始。我在b站上找到了一个非常适合初学者学习的obsidian教程。用obsidian学markdown最大的好处就是markdown的效果能立竿见影，高度可视化。<a href="https://www.bilibili.com/video/BV1Hj411E7ra/?spm_id_from=333.337.search-card.all.click&amp;vd_source=31ba3d75fa2995f7e1b776de7a637bd4">教程视频</a></p>
<p>如果你想写一篇博客，在powershell中输入：</p>
<pre tabindex="0"><code>hexo new post &lt;post_name&gt;
</code></pre><p>然后，把myblog整个文件夹丢到vscode里。在source/_posts里，你可以找到“文章名.md”的文件，在这里用markdown语言撰写你的博客。</p>
<p>在写完一篇博客之后，记得保存，随后在终端输入上文中的测试指令，你就可以在本地看到你的博客文章了。</p>
<h2 id="如何使用主题">如何使用主题？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e4%b8%bb%e9%a2%98" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>在默认情况下，hexo自带了一个主题，你不需要插入主题也可以搭建自己的博客。但是hexo的优势就在于活跃的中文社区与大量的开源主题。如果你不会导入主题的话绝对是一件遗憾。</p>
<p>使用主题并不是一件难事，但是对于初学者（比如我）而言，因为误操作git导致给自己创造了一系列困难是常有的事。所以，在使用主题之前，我们最好先了解一下git和github的基础知识。</p>
<h4 id="如何使用git">如何使用git？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8git" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>在前文中我们有提到过git。这是一个非常好用的程序管理器，你可以将其类比为码农的游戏存档，但是它的功能比简单的存档更加强大，它可以随时存档，读档，创建分支，合并分支。与其将它比作是一个存档器，不如说是一个功能极强的时间机器。</p>
<p>当然，在此处，你同样只需要了解一些基础知识即可。</p>
<pre tabindex="0"><code>git add .
git add &lt;file_name&gt;
git commit -m &lt;message&gt;
git branch &lt;branch_name&gt;
git checkout &lt;branch_name&gt;
git log
git branch -m &lt;new-name&gt;
</code></pre><p>简单来说，第一个命令是将当前目录下的所有文件添加到缓存区，第二个命令是将指定文件添加到缓存区。
第三个命令是提交缓存区的所有文件，形成一次提交，并且带有一条写入的message。
第四条是在当前提交处创建一个分支。
第五个是读档，回档到某个分支的状态。
第六个是查看git提交记录，你可以看到项目的所有提交记录，包括时间，哈希值，message以及分支。
最后一个是修改当前分支的名称。</p>
<p>忘了写了，还有<code>git init</code>，这是一个非常关键的命令，需要在以上命令写之前写入。一个工程只需要写一次就够了。这会告诉git，这里有一个工程文件需要git插手，即初始化git，之后此目录下才能使用git命令。</p>
<p>看不懂上面是什么意思？没关系。尽管git本身是命令行工具，但是当前网路上不乏许多直观的教程。下面推荐几个</p>
<p><a href="https://learngitbranching.js.org/?locale=zh_CN">Learn Git Branching</a> - 用游戏式的交互直观展示git工作流程。在branch方面更加清晰。
<a href="https://www.youtube.com/watch?v=mJ-qvsxPHpY&amp;t=602s">Git Tutorial For Dummies</a> - 顾名思义，给蠢蛋上的git教程。跟着走一遍就会用git了。
（后记：其实我现在还是不太能完全理解git分支版本控制的原理，大多数时候git add .,git commit,git push就足够满足需求了。）</p>
<p>然而，只用git是不够的，安装主题需要从github上导入，因此，你也必须学习一点github知识。</p>
<h4 id="如何使用github">如何使用github？<a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8github" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>hub在英文中表示“中心”，github即git中心。尽管是一个高度图形化的网站，github的使用很大程度上依赖于git。
下面我们罗列几个与github相关的git指令。</p>
<pre tabindex="0"><code>git clone &lt;远程仓库地址&gt; &lt;本地相对地址&gt; - 将github上的某仓库克隆到本地
git remote add origin &lt;远程仓库地址&gt; - 给当前项目添加 GitHub 仓库（一般第一次 push 时用）
git push origin main - 将本地 main 分支推送到 GitHub 上
git push -u origin main - 第一次推送时用，之后可直接 git push
</code></pre><p>比如，如果我希望我的博客使用Oranges主题，我就这么做：</p>
<ul>
<li>cd到博客根目录/myblog</li>
<li><code>git clone https://github.com/zchengsite/hexo-theme-oranges themes/Oranges</code>
输入第二行的命令之后，你的themes文件夹中就会出现Oranges文件。这时候你就可以使用该主题了。</li>
</ul>
<p>注意：不同主题各自有自己的配置文件，请参考github上各个主题的readme.md文件了解配置方法。</p>
<p>有的主题会建议你使用submodule方式添加主题。这需要一定的git基础，并且会造成提交部署上流程的复杂化。反正我暂时不会。我的方案是直接clone到本地，之后删除其中的所有.git相关的文件，这样这些导入的文件就不会被视作是一个子仓库，而是你工程文件的一部分。除非你有频繁更新主题的需求，一般而言导入一次就不会再去更新主题了。
（后记：现在仍然不会使用子模块。）</p>
<h2 id="如何部署博客">如何部署博客？<a href="#%e5%a6%82%e4%bd%95%e9%83%a8%e7%bd%b2%e5%8d%9a%e5%ae%a2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>通过上文的流程，你已经可以在本地编辑和预览你的博客网站了。但是这不够，因为你需要让它部署到公网上才能让它被其他人看到。
所以，如何部署呢？我们需要先了解一些基础知识。</p>
<ul>
<li>首先，你的博客需要一个地方存放它的工程文件，即你的myblog文件夹。这个位置不能是你的本地，因为博客网站24小时连轴转，你的电脑可是需要休息的。</li>
<li>此外，你的博客需要一个域名，例如baidu.com。不然别人怎么访问你的博客。</li>
<li>之后，你需要一个平台来代替你的电脑来运行网站。当然如果你会搭自己的服务器那当我没说，不过有这实力也不至于来看我的文章了。</li>
</ul>
<p>感觉很复杂吗？没关系，我们一条一条来。</p>
<p>首先第一条。在哪里可以存放你的工程文件呢？对于一个毫无编程基础的人而言，你可能会想到网盘。很不错了，但是我们有更优化的方案。这就是我们前文中提到的github。
在这里，我们先正式介绍一下github。</p>
<h4 id="什么是github">什么是github？<a href="#%e4%bb%80%e4%b9%88%e6%98%afgithub" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>我知道你可能很想吐槽为什么我先讲怎么用github再介绍github，但是你先别急。</p>
<p>GitHub，是一个基于git的代码托管平台。它就像是一个几乎无限大的网盘，你可以在这里搭建仓库，存放代码，甚至和他人合作完成项目。</p>
<p>怎么做到无限大的？好吧，实际上并不是无限大。github要求单个仓库上线大小为1GB，单个文件上限大小为100MB。但是，对于代码这种纯粹字符组成的文件，一般而言空间占用量很小，加上得益于git的高效储存，对于大部分代码工程而言使用github都是足够使用了。当然，如果你想在这里上传视频等大体积文件，这就有点困难了。</p>
<h4 id="如何在github上存放你的工程文件">如何在github上存放你的工程文件？<a href="#%e5%a6%82%e4%bd%95%e5%9c%a8github%e4%b8%8a%e5%ad%98%e6%94%be%e4%bd%a0%e7%9a%84%e5%b7%a5%e7%a8%8b%e6%96%87%e4%bb%b6" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>非常简单。在我们前文中有讲过如何把本地文件上传到github。现在我再来详细介绍一遍。</p>
<ul>
<li>首先，创建一个仓库。你可以在github中轻松找到创建仓库的按键。输入你想命名的仓库名就大功告成了。</li>
<li>之后，进入你的仓库界面。复制此处的网址。</li>
<li><code>git remote add origin &lt;远程仓库地址&gt;</code>, 将当前项目链接到你刚创建的github仓库。</li>
<li><code>git add .</code> <code>git commit -m &lt;message&gt;</code>,将当前项目提交一次git存档。</li>
<li><code>git push -u origin main</code>,将当前提交上传到github。</li>
</ul>
<p>这时候，去你的github仓库里，你就可以看到你的工程文件成功出现在了那里。成功上传。</p>
<p>注意：之后在相同的工程文件中，你只需要输入<code>git push</code>就可以代替<code>git push -u origin main</code>，更加快捷。</p>
<h4 id="如何获得域名">如何获得域名？<a href="#%e5%a6%82%e4%bd%95%e8%8e%b7%e5%be%97%e5%9f%9f%e5%90%8d" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>这是全过程最简单的一环，拿钱摆事即可。</p>
<p>国内的主要域名商就是阿里云和腾讯云。我个人是在腾讯云上买的域名。</p>
<p>域名的不同价格主要就是后缀决定的。不要被某些域名较低的首年价格吸引了，没必要搞一个太花里胡哨的域名，我个人还是更追求稳定。</p>
<p>在腾讯云上购买域名之后，你会在这里找到相关的工作台。这很重要，之后部署博客的时候会用到。</p>
<h4 id="部署博客">部署博客<a href="#%e9%83%a8%e7%bd%b2%e5%8d%9a%e5%ae%a2" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h4>
<p>现在，你已经有了域名和博客网站的内容，是时候让它部署到公网上了。</p>
<p>这时候，我们需要寻求云计算服务平台的帮助，来托管我们的网站代码。在其中，我个人选择的是vercel，在中文社区广受好评的托管平台。</p>
<p>值得注意的是，如果你去问chatgpt或者gemini等外国LLM，你可能会被告知vercel在国内的速度并不好，并推荐使用cloudflare。然而事实截然相反，我身边用过的人都说cf又慢又爱抽风。事实证明，有时候有经验的真人会比大数据更懂你的需求。</p>
<p>至少在vercel中，部署博客几乎是一条龙服务，跟着引导走就行了。这边提几个可能产生误会的地方。</p>
<h6 id="1如何使用自己的域名">1.如何使用自己的域名？<a href="#1%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8%e8%87%aa%e5%b7%b1%e7%9a%84%e5%9f%9f%e5%90%8d" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h6>
<p>这里需要引入DNS的概念。</p>
<p>DNS：Domain Name System，域名系统，用来实现域名和IP地址的相互映射。简单来说，用户想通过域名来访问网站，但是计算机需要IP地址。DNS就提供了这样的寻址功能。</p>
<p>如果我们想通过域名来访问自己的博客，我们就需要让我们的域名通过DNS记录链接到云计算服务平台的IP地址。</p>
<p>所以，这时候我们需要返回域名商的工作台。在此处为我们的域名添加DNS记录。此处，你需要去获知你所选云计算服务平台的IP地址。</p>
<p>我其实不太明白怎么获知这个IP地址，误打误撞就填对了。所以需要你自己去探索方法。</p>
<h6 id="2如何更新">2.如何更新？<a href="#2%e5%a6%82%e4%bd%95%e6%9b%b4%e6%96%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h6>
<p>如果你想更新博客，你需要重新部署一遍吗？</p>
<p>答案是不用。vercel这样的平台会自动检测github仓库的提交并采用当前分支的最新记录。你只需要git push一下你就可以看到公网上你的博客内容更新了。</p>
<h2 id="尾声">尾声<a href="#%e5%b0%be%e5%a3%b0" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path>
      <line x1="8" y1="12" x2="16" y2="12"></line>
   </svg></a></h2>
<p>这是我正式写的第一篇博客。码字码了半天。因为实际上本人也是刚刚开始接触博客，没有很丰富的经验与知识基础，希望多多见谅。</p>
<p>因为现在没有图床，导入图片不太方便，之后希望能尽快解决。（2025-11-23，现在也没有解决）</p>
]]></content>
		</item>
		
	</channel>
</rss>
